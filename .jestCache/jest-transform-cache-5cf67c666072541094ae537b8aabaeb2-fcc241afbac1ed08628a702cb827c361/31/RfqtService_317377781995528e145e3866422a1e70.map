{"file":"/Users/davidwalsh/code-local/0x-rfq-api/src/services/RfqtService.ts","mappings":"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","names":[],"sources":["/Users/davidwalsh/code-local/0x-rfq-api/src/services/RfqtService.ts"],"sourcesContent":["import { AltRfqMakerAssetOfferings, AssetSwapperContractAddresses } from '@0x/asset-swapper/lib/src/types';\r\nimport { OtcOrder } from '@0x/protocol-utils/lib/src/orders';\r\nimport { Signature } from '@0x/protocol-utils/lib/src/signature_utils';\r\nimport {\r\n    getTokenMetadataIfExists,\r\n    nativeTokenSymbol,\r\n    nativeWrappedTokenSymbol,\r\n    TokenMetadata,\r\n} from '@0x/token-metadata';\r\nimport { MarketOperation } from '@0x/types';\r\nimport { BigNumber } from '@0x/utils';\r\nimport { Producer as KafkaProducer } from 'kafkajs';\r\n\r\nimport { Integrator } from '../config';\r\nimport { NULL_ADDRESS, ONE_SECOND_MS } from '../core/constants';\r\nimport { feeToStoredFee } from '../core/fee_utils';\r\nimport {\r\n    Fee,\r\n    FeeModelVersion,\r\n    QuoteServerPriceParams,\r\n    RequireOnlyOne,\r\n    RfqtV2Price,\r\n    RfqtV2Quote,\r\n    StoredFee,\r\n} from '../core/types';\r\nimport { logger } from '../logger';\r\nimport { QuoteRequestor, SignedNativeOrderMM, V4RFQIndicativeQuoteMM } from '../quoteRequestor/QuoteRequestor';\r\nimport { quoteReportUtils } from '../utils/quote_report_utils';\r\nimport { QuoteServerClient } from '../utils/quote_server_client';\r\nimport { getRfqtV2FillableAmounts, validateV2Prices } from '../utils/RfqtQuoteValidator';\r\nimport { RfqBlockchainUtils } from '../utils/rfq_blockchain_utils';\r\nimport { RfqMakerManager } from '../utils/rfq_maker_manager';\r\nimport { getSignerFromHash, padSignature } from '../utils/signature_utils';\r\nimport { TokenMetadataManager } from '../utils/TokenMetadataManager';\r\n\r\nimport { FeeService } from './fee_service';\r\nimport { RfqMakerBalanceCacheService } from './rfq_maker_balance_cache_service';\r\nimport { FirmQuoteContext, QuoteContext } from './types';\r\n\r\nconst getTokenAddressFromSymbol = (symbol: string, chainId: number): string => {\r\n    return (getTokenMetadataIfExists(symbol, chainId) as TokenMetadata).tokenAddress;\r\n};\r\n\r\n/**\r\n * Converts the parameters of an RFQt v2 prices request from 0x API\r\n * into the format needed for `QuoteServerClient` to call the market makers\r\n */\r\nfunction transformRfqtV2PricesParameters(p: QuoteContext, fee: Fee, chainId: number): QuoteServerPriceParams {\r\n    const buyTokenAddress = p.makerToken;\r\n    const sellTokenAddress = p.takerToken;\r\n    // Typescript gymnastics with `baseUnits` to caputure the \"oneof\" nature--\r\n    // By packaging them in their own little object, the type becomes:\r\n    //\r\n    // { buyAmountBaseUnits: BigNumber, sellAmountBaseUnits: undefined } |\r\n    // { buyAmountBaseUnits: undefined, sellAmountBaseUnits: BigNumber }\r\n    //\r\n    // This is different from not packaging them together, where the types would be:\r\n    //\r\n    // buyAmountBaseUnits: BigNumber | undefined\r\n    // sellAmountBaseUnits: BigNumber | undefined\r\n    const baseUnits =\r\n        p.isSelling === false\r\n            ? {\r\n                  buyAmountBaseUnits: p.assetFillAmount,\r\n                  sellAmountBaseUnits: undefined,\r\n              }\r\n            : {\r\n                  // This is a SELL\r\n                  buyAmountBaseUnits: undefined,\r\n                  sellAmountBaseUnits: p.assetFillAmount,\r\n              };\r\n\r\n    const mmRequestParameters = {\r\n        ...baseUnits,\r\n        buyTokenAddress,\r\n        sellTokenAddress,\r\n        chainId,\r\n        feeAmount: fee.amount,\r\n        feeToken: fee.token,\r\n        integratorId: p.integrator.integratorId,\r\n        takerAddress: p.takerAddress,\r\n        txOrigin: p.txOrigin,\r\n        trader: p.trader,\r\n        gasless: p.workflow === 'gasless-rfqt',\r\n        protocolVersion: '4', //hardcode - will break some MMs if missing!\r\n    };\r\n\r\n    // Convert mmRequestParameters values to strings\r\n    const stringParameters = ((\r\n        o: typeof mmRequestParameters,\r\n    ): RequireOnlyOne<\r\n        Record<keyof typeof mmRequestParameters, string>,\r\n        'buyAmountBaseUnits' | 'sellAmountBaseUnits'\r\n    > => {\r\n        return Object.keys(o).reduce((result, key) => {\r\n            const value: { toString: () => string } | undefined = o[key as keyof typeof mmRequestParameters];\r\n            if (value !== undefined && value.toString) {\r\n                const stringValue = value.toString();\r\n                result[key] = stringValue;\r\n            }\r\n            return result;\r\n            // $eslint-fix-me https://github.com/rhinodavid/eslint-fix-me\r\n            // eslint-disable-next-line @typescript-eslint/no-explicit-any\r\n        }, {} as any);\r\n    })(mmRequestParameters);\r\n\r\n    return stringParameters;\r\n}\r\n\r\n/**\r\n * Contains the logic to handle RFQT Trades.\r\n *\r\n * `\"v1\"` functions support `MetaTransaction` trades while\r\n * `\"v2\"` functions (will) support `OtcOrder` trades.\r\n *\r\n * `v1` relies heavily on `QuoteRequestor` which has been copied over\r\n * from `0x/asset-swapper`.\r\n */\r\nexport class RfqtService {\r\n    private readonly _nativeTokenSymbol: string;\r\n    private readonly _nativeTokenAddress: string;\r\n    private readonly _nativeWrappedTokenSymbol: string;\r\n    private readonly _nativeWrappedTokenAddress: string;\r\n    constructor(\r\n        private readonly _chainId: number,\r\n        private readonly _rfqMakerManager: RfqMakerManager,\r\n        // Used for RFQt v1 requests\r\n        private readonly _quoteRequestor: Pick<\r\n            QuoteRequestor,\r\n            'requestRfqtIndicativeQuotesAsync' | 'requestRfqtFirmQuotesAsync' | 'getMakerUriForSignature'\r\n        >,\r\n        // Used for RFQt v2 requests\r\n        private readonly _quoteServerClient: QuoteServerClient,\r\n        private readonly _minExpiryDurationMs: number,\r\n        private readonly _blockchainUtils: RfqBlockchainUtils,\r\n        private readonly _tokenMetadataManager: TokenMetadataManager,\r\n        private readonly _contractAddresses: AssetSwapperContractAddresses,\r\n        private readonly _feeService: FeeService,\r\n        private readonly _feeModelVersion: FeeModelVersion,\r\n        private readonly _rfqMakerBalanceCacheService: RfqMakerBalanceCacheService,\r\n        private readonly _kafkaProducer?: KafkaProducer,\r\n        private readonly _feeEventTopic?: string,\r\n    ) {\r\n        this._nativeTokenSymbol = nativeTokenSymbol(this._chainId);\r\n        this._nativeTokenAddress = getTokenAddressFromSymbol(this._nativeTokenSymbol, this._chainId);\r\n        this._nativeWrappedTokenSymbol = nativeWrappedTokenSymbol(this._chainId);\r\n        this._nativeWrappedTokenAddress = getTokenAddressFromSymbol(this._nativeWrappedTokenSymbol, this._chainId);\r\n    }\r\n\r\n    /**\r\n     * Pass through to `QuoteRequestor::requestRfqtIndicativeQuotesAsync` to fetch\r\n     * indicative quotes from market makers.\r\n     *\r\n     * Note that by this point, 0x API should be sending the null address\r\n     * as the `takerAddress` and the taker's address as the `txOrigin`.\r\n     */\r\n    public async getV1PricesAsync(parameters: {\r\n        altRfqAssetOfferings: AltRfqMakerAssetOfferings;\r\n        assetFillAmount: BigNumber;\r\n        comparisonPrice: BigNumber | undefined;\r\n        makerToken: string;\r\n        marketOperation: MarketOperation;\r\n        takerToken: string; // expect this to be NULL_ADDRESS\r\n        takerAddress: string;\r\n        txOrigin?: string; // expect this to be the taker address\r\n        intentOnFilling: boolean;\r\n        integrator: Integrator;\r\n    }): Promise<V4RFQIndicativeQuoteMM[]> {\r\n        const {\r\n            altRfqAssetOfferings,\r\n            assetFillAmount,\r\n            comparisonPrice,\r\n            integrator,\r\n            intentOnFilling, // tslint:disable-line boolean-naming\r\n            makerToken,\r\n            marketOperation,\r\n            takerAddress,\r\n            takerToken,\r\n            txOrigin,\r\n        } = parameters;\r\n\r\n        return this._quoteRequestor.requestRfqtIndicativeQuotesAsync(\r\n            makerToken,\r\n            takerToken,\r\n            assetFillAmount,\r\n            marketOperation,\r\n            comparisonPrice,\r\n            {\r\n                altRfqAssetOfferings,\r\n                integrator,\r\n                intentOnFilling,\r\n                isIndicative: true,\r\n                isLastLook: false,\r\n                makerEndpointMaxResponseTimeMs: 600,\r\n                takerAddress,\r\n                txOrigin: txOrigin || NULL_ADDRESS,\r\n            },\r\n        );\r\n    }\r\n\r\n    /**\r\n     * Pass through to `QuoteRequestor::requestRfqtFirmQuotesAsync` to fetch\r\n     * firm quotes from market makers.\r\n     *\r\n     * Note that by this point, 0x API should be sending the null address\r\n     * as the `takerAddress` and the taker's address as the `txOrigin`.\r\n     */\r\n    public async getV1QuotesAsync(parameters: {\r\n        altRfqAssetOfferings: AltRfqMakerAssetOfferings;\r\n        assetFillAmount: BigNumber;\r\n        comparisonPrice: BigNumber | undefined;\r\n        integrator: Integrator;\r\n        intentOnFilling: boolean;\r\n        makerToken: string;\r\n        marketOperation: MarketOperation;\r\n        takerAddress: string; // expect this to be the taker address\r\n        takerToken: string;\r\n        txOrigin: string;\r\n    }): Promise<SignedNativeOrderMM[]> {\r\n        const {\r\n            altRfqAssetOfferings,\r\n            assetFillAmount,\r\n            comparisonPrice,\r\n            integrator,\r\n            intentOnFilling, // tslint:disable-line boolean-naming\r\n            makerToken,\r\n            marketOperation,\r\n            takerAddress,\r\n            takerToken,\r\n            txOrigin,\r\n        } = parameters;\r\n\r\n        const quotes = await this._quoteRequestor.requestRfqtFirmQuotesAsync(\r\n            makerToken,\r\n            takerToken,\r\n            assetFillAmount,\r\n            marketOperation,\r\n            comparisonPrice,\r\n            {\r\n                altRfqAssetOfferings,\r\n                integrator,\r\n                intentOnFilling,\r\n                isIndicative: false,\r\n                isLastLook: false,\r\n                makerEndpointMaxResponseTimeMs: 600,\r\n                takerAddress,\r\n                txOrigin,\r\n            },\r\n        );\r\n\r\n        return quotes.map((q) => {\r\n            return {\r\n                ...q,\r\n                makerUri: this._quoteRequestor.getMakerUriForSignature(q.signature),\r\n            };\r\n        });\r\n    }\r\n\r\n    /**\r\n     * Accepts data sent by 0x API and fetches prices from Market Makers\r\n     * configured on the given pair.\r\n     *\r\n     * Note that by this point, 0x API should be sending the null address\r\n     * as the `takerAddress` and the taker's address as the `txOrigin`.\r\n     */\r\n    public async getV2PricesAsync(quoteContext: QuoteContext, now: Date = new Date()): Promise<RfqtV2Price[]> {\r\n        const { feeWithDetails: fee } = await this._feeService.calculateFeeAsync(quoteContext);\r\n        return this._getV2PricesInternalAsync(quoteContext, fee, now);\r\n    }\r\n\r\n    /**\r\n     * Accepts data sent by 0x API and fetches quotes from market makers\r\n     * configured on the given pair.\r\n     *\r\n     * Preparing quotes is a two step process:\r\n     *  1. Requests are made to the market makers' `/price` endpoint using\r\n     *     logic similar to that of `getV2PricesAsync`\r\n     *  2. Valid prices are then sent to the market makers' `/sign`\r\n     *     endpoint to get a signed quote\r\n     */\r\n    public async getV2QuotesAsync(quoteContext: FirmQuoteContext, now: Date = new Date()): Promise<RfqtV2Quote[]> {\r\n        const { feeWithDetails: fee } = await this._feeService.calculateFeeAsync(quoteContext);\r\n        const storedFee: StoredFee = feeToStoredFee(fee);\r\n\r\n        // TODO (rhinodavid): put a meter on this response time\r\n        const prices = await this._getV2PricesInternalAsync(quoteContext, fee, now);\r\n\r\n        // If multiple quotes are aggregated into the final order, they must\r\n        // all have unique nonces. Otherwise they'll be rejected by the smart contract.\r\n        const baseNonce = new BigNumber(Math.floor(now.getTime() / ONE_SECOND_MS));\r\n        const pricesAndOrders = prices.map((price, i) => ({\r\n            order: this._v2priceToOrder(price, quoteContext.txOrigin, baseNonce.plus(i)),\r\n            price,\r\n        }));\r\n\r\n        const pricesAndOrdersAndSignatures = await Promise.all(\r\n            pricesAndOrders.map(async ({ price, order }) => {\r\n                let signature: Signature | undefined;\r\n                try {\r\n                    const orderHash = order.getHash();\r\n                    signature = await this._quoteServerClient.signV2Async(\r\n                        price.makerUri,\r\n                        quoteContext.integrator.integratorId,\r\n                        { order, orderHash, expiry: price.expiry, fee },\r\n                        (u: string) => `${u}/rfqt/v2/sign`,\r\n                        /* requireProceedWithFill */ false,\r\n                    );\r\n\r\n                    if (signature) {\r\n                        // Certain market makers are returning signature components which are missing\r\n                        // leading bytes. Add them if they don't exist.\r\n                        const paddedSignature = padSignature(signature);\r\n                        if (paddedSignature.r !== signature.r || paddedSignature.s !== signature.s) {\r\n                            logger.warn(\r\n                                { orderHash, r: paddedSignature.r, s: paddedSignature.s },\r\n                                'Got market maker signature with missing bytes',\r\n                            );\r\n                            signature = paddedSignature;\r\n                        }\r\n\r\n                        // Verify the signer was the maker\r\n                        const signerAddress = getSignerFromHash(orderHash, signature).toLowerCase();\r\n                        const makerAddress = order.maker.toLowerCase();\r\n                        if (signerAddress !== makerAddress) {\r\n                            const isValidSigner = await this._blockchainUtils.isValidOrderSignerAsync(\r\n                                makerAddress,\r\n                                signerAddress,\r\n                            );\r\n                            if (!isValidSigner) {\r\n                                logger.warn(\r\n                                    { signerAddress, makerAddress, orderHash, makerUri: price.makerUri },\r\n                                    'Invalid maker signature',\r\n                                );\r\n\r\n                                // Quotes with `undefined` signature will be filtered out later\r\n                                signature = undefined;\r\n                            }\r\n                        }\r\n                    }\r\n                } catch (e) {\r\n                    logger.warn(\r\n                        { orderHash: order.getHash(), makerId: price.makerId },\r\n                        'Failed trying to get rfqt signature from market maker',\r\n                    );\r\n                }\r\n                return {\r\n                    price,\r\n                    order,\r\n                    signature: signature ?? null,\r\n                };\r\n            }),\r\n        );\r\n\r\n        // (Maker Balance Cache) Fetch maker balances to calculate fillable amounts\r\n        let quotedMakerBalances: BigNumber[] | undefined;\r\n        const quotedERC20Owners = prices.map((price) => ({\r\n            owner: price.makerAddress,\r\n            token: price.makerToken,\r\n        }));\r\n        try {\r\n            quotedMakerBalances = await this._rfqMakerBalanceCacheService.getERC20OwnerBalancesAsync(\r\n                this._chainId,\r\n                quotedERC20Owners,\r\n            );\r\n        } catch (e) {\r\n            logger.error(\r\n                { chainId: this._chainId, quotedERC20Owners, errorMessage: e.message },\r\n                'Failed to fetch maker balances to calculate fillable amounts',\r\n            );\r\n        }\r\n\r\n        const fillableAmounts = getRfqtV2FillableAmounts(prices, this._chainId, quotedMakerBalances);\r\n\r\n        const quotes = pricesAndOrdersAndSignatures\r\n            .filter((pos) => pos.signature)\r\n            .map(({ price, order, signature }, i) => ({\r\n                ...fillableAmounts[i],\r\n                fillableTakerFeeAmount: new BigNumber(0),\r\n                makerId: price.makerId,\r\n                makerUri: price.makerUri,\r\n                order,\r\n                // $eslint-fix-me https://github.com/rhinodavid/eslint-fix-me\r\n                // eslint-disable-next-line @typescript-eslint/no-non-null-assertion\r\n                signature: signature!, // `null` signatures already filtered out\r\n            }));\r\n\r\n        // Write to Fee Event Report\r\n        if (this._kafkaProducer) {\r\n            try {\r\n                await quoteReportUtils.publishRfqtV2FeeEvent(\r\n                    {\r\n                        requestedBuyAmount: quoteContext.makerAmount ?? null,\r\n                        requestedSellAmount: quoteContext.takerAmount ?? null,\r\n                        requestedTakerAddress: quoteContext.takerAddress,\r\n                        buyTokenAddress: quoteContext.makerToken,\r\n                        sellTokenAddress: quoteContext.takerToken,\r\n                        integratorId: quoteContext.integrator.integratorId,\r\n                        quotes,\r\n                        fee: storedFee,\r\n                    },\r\n                    this._kafkaProducer,\r\n                    this._feeEventTopic,\r\n                );\r\n            } catch (e) {\r\n                logger.error(\r\n                    {\r\n                        chainId: this._chainId,\r\n                        requestedBuyAmount: quoteContext.makerAmount,\r\n                        requestedSellAmount: quoteContext.takerAmount,\r\n                        requestedTakerAddress: quoteContext.takerAddress,\r\n                        buyTokenAddress: quoteContext.makerToken,\r\n                        sellTokenAddress: quoteContext.takerToken,\r\n                        integratorId: quoteContext.integrator.integratorId,\r\n                        errorMessage: e.message,\r\n                    },\r\n                    'Failed to publish RFQt quote to Fee Event Report',\r\n                );\r\n            }\r\n        }\r\n\r\n        return quotes;\r\n    }\r\n\r\n    public get feeModelVersion(): FeeModelVersion {\r\n        return this._feeModelVersion;\r\n    }\r\n\r\n    /**\r\n     * Passthrough to TokenMetadataManager's `getTokenDecimalsAsync` method\r\n     */\r\n    public async getTokenDecimalsAsync(tokenAddress: string): Promise<number> {\r\n        return this._tokenMetadataManager.getTokenDecimalsAsync(tokenAddress);\r\n    }\r\n\r\n    /**\r\n     * Get prices from MMs for given quote context and fee.\r\n     */\r\n    public async _getV2PricesInternalAsync(\r\n        quoteContext: QuoteContext,\r\n        fee: Fee,\r\n        now: Date = new Date(),\r\n    ): Promise<RfqtV2Price[]> {\r\n        const { integrator, makerToken, takerToken } = quoteContext;\r\n        // Fetch the makers active on this pair\r\n        const makers = this._rfqMakerManager.getRfqtV2MakersForPair(makerToken, takerToken).filter((m) => {\r\n            if (m.rfqtUri === null) {\r\n                return false;\r\n            }\r\n            if (integrator.whitelistMakerIds && !integrator.whitelistMakerIds.includes(m.makerId)) {\r\n                return false;\r\n            }\r\n            return true;\r\n        });\r\n\r\n        // Short circuit if no makers are active\r\n        if (!makers.length) {\r\n            return [];\r\n        }\r\n\r\n        // TODO (haozhuo): check to see if MM passes circuit breaker\r\n\r\n        const prices = (\r\n            await this._quoteServerClient.batchGetPriceV2Async(\r\n                // $eslint-fix-me https://github.com/rhinodavid/eslint-fix-me\r\n                // eslint-disable-next-line @typescript-eslint/no-non-null-assertion\r\n                makers.map((m) => /* won't be null because of previous `filter` operation */ m.rfqtUri!),\r\n                integrator,\r\n                transformRfqtV2PricesParameters(quoteContext, fee, this._chainId),\r\n                (url) => `${url}/rfqt/v2/price`,\r\n            )\r\n        ).map((price) => {\r\n            const maker = makers.find((m) => m.rfqtUri === price.makerUri);\r\n            if (!maker) {\r\n                throw new Error(`Could not find maker with URI ${price.makerUri}`);\r\n            }\r\n            return {\r\n                expiry: price.expiry,\r\n                makerAddress: price.maker,\r\n                makerAmount: price.makerAmount,\r\n                makerId: maker.makerId,\r\n                makerToken: price.makerToken,\r\n                makerUri: price.makerUri,\r\n                takerAmount: price.takerAmount,\r\n                takerToken: price.takerToken,\r\n            };\r\n        });\r\n\r\n        // Filter out invalid prices\r\n        const validatedPrices = validateV2Prices(prices, quoteContext, this._minExpiryDurationMs, now);\r\n\r\n        return validatedPrices;\r\n    }\r\n\r\n    /**\r\n     * Converts a price returned from the market maker's `price` endpoint\r\n     * into an v2 order\r\n     */\r\n    private _v2priceToOrder(\r\n        price: RfqtV2Price,\r\n        txOrigin: string,\r\n        nonce: BigNumber,\r\n        nonceBucket: BigNumber = new BigNumber(0),\r\n    ): OtcOrder {\r\n        return new OtcOrder({\r\n            chainId: this._chainId,\r\n            expiryAndNonce: OtcOrder.encodeExpiryAndNonce(price.expiry, nonceBucket, nonce),\r\n            maker: price.makerAddress,\r\n            makerAmount: price.makerAmount,\r\n            makerToken: price.makerToken,\r\n            taker: NULL_ADDRESS,\r\n            takerAmount: price.takerAmount,\r\n            takerToken: price.takerToken,\r\n            txOrigin,\r\n            verifyingContract: this._contractAddresses.exchangeProxy,\r\n        });\r\n    }\r\n}\r\n"],"version":3}