{"file":"/Users/davidwalsh/code-local/0x-rfq-api/src/utils/rfqm_db_utils.ts","mappings":"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","names":[],"sources":["/Users/davidwalsh/code-local/0x-rfq-api/src/utils/rfqm_db_utils.ts"],"sourcesContent":["// tslint:disable:max-file-line-count\r\nimport { OtcOrder } from '@0x/protocol-utils';\r\nimport { BigNumber } from '@0x/utils';\r\nimport { FindOptionsWhere, In } from 'typeorm';\r\nimport { Connection } from 'typeorm/connection/Connection';\r\n\r\nimport { toPairString } from '../core/pair_utils';\r\nimport {\r\n    LastLookRejectionCooldownEntity,\r\n    MetaTransactionJobEntity,\r\n    MetaTransactionSubmissionEntity,\r\n    RfqmV2JobEntity,\r\n    RfqmV2QuoteEntity,\r\n    RfqmV2TransactionSubmissionEntity,\r\n} from '../entities';\r\nimport { MetaTransactionJobConstructorOpts } from '../entities/MetaTransactionJobEntity';\r\nimport { MetaTransactionSubmissionEntityConstructorOpts } from '../entities/MetaTransactionSubmissionEntity';\r\nimport { RfqmV2JobConstructorOpts } from '../entities/RfqmV2JobEntity';\r\nimport { RfqmV2QuoteConstructorOpts } from '../entities/RfqmV2QuoteEntity';\r\nimport { RfqmV2TransactionSubmissionEntityConstructorOpts } from '../entities/RfqmV2TransactionSubmissionEntity';\r\nimport { RfqmWorkerHeartbeatEntity } from '../entities/RfqmWorkerHeartbeatEntity';\r\nimport {\r\n    RfqmJobStatus,\r\n    RfqmOrderTypes,\r\n    RfqmTransactionSubmissionType,\r\n    StoredOtcOrder,\r\n    UnresolvedRfqmJobStatuses,\r\n} from '../entities/types';\r\n\r\n/**\r\n * Map a StoredOtcOrder to an OtcOrder\r\n */\r\nexport function storedOtcOrderToOtcOrder(storedOrder: StoredOtcOrder): OtcOrder {\r\n    return new OtcOrder({\r\n        txOrigin: storedOrder.order.txOrigin,\r\n        maker: storedOrder.order.maker,\r\n        taker: storedOrder.order.taker,\r\n        makerToken: storedOrder.order.makerToken,\r\n        takerToken: storedOrder.order.takerToken,\r\n        makerAmount: new BigNumber(storedOrder.order.makerAmount),\r\n        takerAmount: new BigNumber(storedOrder.order.takerAmount),\r\n        expiryAndNonce: new BigNumber(storedOrder.order.expiryAndNonce),\r\n        verifyingContract: storedOrder.order.verifyingContract,\r\n        chainId: Number(storedOrder.order.chainId),\r\n    });\r\n}\r\n\r\n/**\r\n * Map an OtcOrder to a StoredOtcOrder\r\n */\r\nexport function otcOrderToStoredOtcOrder(order: OtcOrder): StoredOtcOrder {\r\n    return {\r\n        type: RfqmOrderTypes.Otc,\r\n        order: {\r\n            txOrigin: order.txOrigin,\r\n            maker: order.maker,\r\n            taker: order.taker,\r\n            makerToken: order.makerToken,\r\n            takerToken: order.takerToken,\r\n            makerAmount: order.makerAmount.toString(),\r\n            takerAmount: order.takerAmount.toString(),\r\n            expiryAndNonce: order.expiryAndNonce.toString(),\r\n            verifyingContract: order.verifyingContract,\r\n            chainId: String(order.chainId),\r\n        },\r\n    };\r\n}\r\n\r\n/**\r\n * RfqmDbUtils provides tools for interacting with the database\r\n */\r\nexport class RfqmDbUtils {\r\n    constructor(private readonly _connection: Connection) {}\r\n\r\n    /**\r\n     * Fetches all the worker heartbeats for the provided chain ID.\r\n     */\r\n    public async findRfqmWorkerHeartbeatsAsync(chainId: number): Promise<RfqmWorkerHeartbeatEntity[]> {\r\n        return this._connection.getRepository(RfqmWorkerHeartbeatEntity).find({ where: { chainId } });\r\n    }\r\n\r\n    /**\r\n     * Updates an existing RFQM job.\r\n     */\r\n    public async updateRfqmJobAsync<T extends RfqmV2JobEntity | MetaTransactionJobEntity>(job: T): Promise<void> {\r\n        const kind = job.kind;\r\n        switch (kind) {\r\n            case 'rfqm_v2_job':\r\n                await this._connection.getRepository(RfqmV2JobEntity).save(job);\r\n                return;\r\n            case 'meta_transaction_job':\r\n                await this._connection.getRepository(MetaTransactionJobEntity).save(job);\r\n                return;\r\n            default:\r\n                ((_x: never) => {\r\n                    throw new Error('unreachable');\r\n                })(kind);\r\n        }\r\n    }\r\n\r\n    public async upsertRfqmWorkerHeartbeatToDbAsync(\r\n        address: string,\r\n        index: number,\r\n        balance: BigNumber,\r\n        chainId: number,\r\n    ): Promise<RfqmWorkerHeartbeatEntity> {\r\n        if (!Number.isInteger(index)) {\r\n            throw new Error(`Index ${index} is not an integer`);\r\n        }\r\n        const repository = this._connection.getRepository(RfqmWorkerHeartbeatEntity);\r\n\r\n        // Why I did not use `.save`:\r\n        // The `rfqm_worker_heartbeat` table has a trigger to automatically update the timestamp on UPDATE\r\n        // but the `.save` functionality is smart enough to not actually execute the update if none of the\r\n        // data has changed. Since this only happens when a worker balance changes, the timestamp won't\r\n        // update unless `.update` is explicitly called.\r\n        const updatedEntity = await repository.preload({ address, index, balance, chainId });\r\n        if (updatedEntity !== undefined) {\r\n            const findConditions: FindOptionsWhere<RfqmWorkerHeartbeatEntity> = {\r\n                address,\r\n                chainId,\r\n            };\r\n            await this._connection.getRepository(RfqmWorkerHeartbeatEntity).update(findConditions, updatedEntity);\r\n            return updatedEntity;\r\n        }\r\n\r\n        const newEntity = new RfqmWorkerHeartbeatEntity({ address, index, balance, chainId });\r\n        await this._connection.getRepository(RfqmWorkerHeartbeatEntity).insert(newEntity);\r\n        return newEntity;\r\n    }\r\n\r\n    /**\r\n     * Updates transactions in the `rfqm_v2_transaction_submission` or the `meta_transaction_submission` tables as appropriate.\r\n     */\r\n    public async updateRfqmTransactionSubmissionsAsync<\r\n        T extends RfqmV2TransactionSubmissionEntity[] | MetaTransactionSubmissionEntity[],\r\n    >(entities: T): Promise<void> {\r\n        if (entities.length === 0) {\r\n            return;\r\n        }\r\n\r\n        const kind = entities[0].kind;\r\n        switch (kind) {\r\n            case 'rfqm_v2_transaction_submission':\r\n                await this._connection\r\n                    .getRepository(RfqmV2TransactionSubmissionEntity)\r\n                    .save(entities as Partial<RfqmV2TransactionSubmissionEntity>[]);\r\n                return;\r\n            case 'meta_transaction_submission':\r\n                await this._connection\r\n                    .getRepository(MetaTransactionSubmissionEntity)\r\n                    .save(entities as Partial<MetaTransactionSubmissionEntity>[]);\r\n                return;\r\n            default:\r\n                ((_x: never) => {\r\n                    throw new Error('unreachable');\r\n                })(kind);\r\n        }\r\n    }\r\n\r\n    /**\r\n     * [RFQm v2] Queries the rfqm_job table with the given orderHash\r\n     */\r\n    public async findV2JobByOrderHashAsync(orderHash: string): Promise<RfqmV2JobEntity | null> {\r\n        return this._connection.getRepository(RfqmV2JobEntity).findOne({\r\n            where: { orderHash },\r\n        });\r\n    }\r\n\r\n    /**\r\n     * [RFQm v2] Queries the rfqm_quote table with the given orderHash\r\n     */\r\n    public async findV2QuoteByOrderHashAsync(orderHash: string): Promise<RfqmV2QuoteEntity | null> {\r\n        return this._connection.getRepository(RfqmV2QuoteEntity).findOne({\r\n            where: { orderHash },\r\n        });\r\n    }\r\n\r\n    /**\r\n     * [RFQm v2] Queries the `rfqm_v2_jobs` table for all jobs with the specified statuses\r\n     */\r\n    public async findV2JobsWithStatusesAsync(statuses: RfqmJobStatus[]): Promise<RfqmV2JobEntity[]> {\r\n        return this._connection.getRepository(RfqmV2JobEntity).find({\r\n            where: {\r\n                status: In(statuses),\r\n            },\r\n        });\r\n    }\r\n\r\n    /**\r\n     * [RFQm v2] Queries the rfqm_v2_transaction_submission table with the given transactionHash\r\n     */\r\n    public async findV2TransactionSubmissionByTransactionHashAsync(\r\n        transactionHash: string,\r\n    ): Promise<RfqmV2TransactionSubmissionEntity | null> {\r\n        return this._connection.getRepository(RfqmV2TransactionSubmissionEntity).findOne({\r\n            where: { transactionHash },\r\n        });\r\n    }\r\n\r\n    /**\r\n     * [RFQm v2] Queries the last_look_rejection_cooldowns table with primary key\r\n     */\r\n    public async findV2LastLookRejectionCooldownAsync(\r\n        makerId: string,\r\n        chainId: number,\r\n        tokenA: string,\r\n        tokenB: string,\r\n        startTime: Date,\r\n    ): Promise<LastLookRejectionCooldownEntity | null> {\r\n        return this._connection.getRepository(LastLookRejectionCooldownEntity).findOne({\r\n            where: {\r\n                makerId,\r\n                chainId,\r\n                pairKey: toPairString(tokenA, tokenB),\r\n                startTime,\r\n            },\r\n        });\r\n    }\r\n\r\n    /**\r\n     * [RFQm v2] Queries the rfqm_v2_transaction_submission table with the given orderHash\r\n     */\r\n    public async findV2TransactionSubmissionsByOrderHashAsync(\r\n        orderHash: string,\r\n        type: RfqmTransactionSubmissionType = RfqmTransactionSubmissionType.Trade,\r\n    ): Promise<RfqmV2TransactionSubmissionEntity[]> {\r\n        return this._connection.getRepository(RfqmV2TransactionSubmissionEntity).find({\r\n            where: { orderHash, type },\r\n        });\r\n    }\r\n\r\n    /**\r\n     * [RFQm v2] Updates an RfqmV2Job at the given orderHash\r\n     */\r\n    public async updateV2JobAsync(\r\n        orderHash: string,\r\n        isCompleted: boolean,\r\n        rfqmJobOpts: Partial<RfqmV2JobEntity>,\r\n    ): Promise<void> {\r\n        await this._connection.getRepository(RfqmV2JobEntity).save({ ...rfqmJobOpts, isCompleted, orderHash });\r\n    }\r\n\r\n    /**\r\n     * [RFQm v2] writes to the rfqm_v2_transaction_submission table\r\n     */\r\n    public async writeV2RfqmTransactionSubmissionToDbAsync(\r\n        partialV2RfqmTransactionSubmissionEntity: RfqmV2TransactionSubmissionEntityConstructorOpts,\r\n    ): Promise<RfqmV2TransactionSubmissionEntity> {\r\n        const entity = new RfqmV2TransactionSubmissionEntity(partialV2RfqmTransactionSubmissionEntity);\r\n        await this._connection.getRepository(RfqmV2TransactionSubmissionEntity).insert(entity);\r\n\r\n        return entity;\r\n    }\r\n\r\n    /**\r\n     * [RFQm v2] bulk update to the rfqm_v2_transaction_submission table\r\n     */\r\n    public async updateV2TransactionSubmissionsAsync(\r\n        entities: Partial<RfqmV2TransactionSubmissionEntity>[],\r\n    ): Promise<RfqmV2TransactionSubmissionEntity[]> {\r\n        return this._connection.getRepository(RfqmV2TransactionSubmissionEntity).save(entities);\r\n    }\r\n\r\n    /**\r\n     * [RFQm v2] writes to the rfqm_v2_quote table\r\n     */\r\n    public async writeV2QuoteAsync(rfqmV2QuoteOpts: RfqmV2QuoteConstructorOpts): Promise<void> {\r\n        await this._connection.getRepository(RfqmV2QuoteEntity).insert(new RfqmV2QuoteEntity(rfqmV2QuoteOpts));\r\n    }\r\n\r\n    /**\r\n     * [RFQm v2] writes to the rfqm_v2_job table\r\n     */\r\n    public async writeV2JobAsync(rfqmV2JobOpts: RfqmV2JobConstructorOpts): Promise<void> {\r\n        await this._connection.getRepository(RfqmV2JobEntity).insert(new RfqmV2JobEntity(rfqmV2JobOpts));\r\n    }\r\n\r\n    /**\r\n     * [RFQm v2] writes to the rfqm_v2_transaction_submission table. Should not error on duplicate\r\n     * primary key (PK), since the PK is essentially a hash of the contents of the table, minus status\r\n     */\r\n    public async writeV2TransactionSubmissionAsync(\r\n        constructorOpts: RfqmV2TransactionSubmissionEntityConstructorOpts,\r\n    ): Promise<RfqmV2TransactionSubmissionEntity> {\r\n        const entity = new RfqmV2TransactionSubmissionEntity(constructorOpts);\r\n        await this._connection.getRepository(RfqmV2TransactionSubmissionEntity).save(entity);\r\n\r\n        return entity;\r\n    }\r\n\r\n    /**\r\n     * [RFQm v2] writes to the last_look_rejection_cooldowns table\r\n     */\r\n    public async writeV2LastLookRejectionCooldownAsync(\r\n        makerId: string,\r\n        chainId: number,\r\n        tokenA: string,\r\n        tokenB: string,\r\n        startTime: Date,\r\n        endTime: Date,\r\n        orderHash: string,\r\n    ): Promise<void> {\r\n        await this._connection.getRepository(LastLookRejectionCooldownEntity).insert(\r\n            new LastLookRejectionCooldownEntity({\r\n                makerId,\r\n                chainId,\r\n                pairKey: toPairString(tokenA, tokenB),\r\n                startTime,\r\n                endTime,\r\n                orderHash,\r\n            }),\r\n        );\r\n    }\r\n\r\n    /**\r\n     * [RFQm v2] find unresolved jobs from the rfqm_v2_jobs table\r\n     * for a given worker address and chain ID.\r\n     */\r\n    public async findV2UnresolvedJobsAsync(workerAddress: string, chainId: number): Promise<RfqmV2JobEntity[]> {\r\n        return this._connection.getRepository(RfqmV2JobEntity).find({\r\n            where: {\r\n                chainId,\r\n                status: In(UnresolvedRfqmJobStatuses),\r\n                workerAddress,\r\n            },\r\n        });\r\n    }\r\n\r\n    /**\r\n     * [meta transaction] Queries the `meta_transaction_jobs` table with the given id.\r\n     */\r\n    public async findMetaTransactionJobByIdAsync(id: string): Promise<MetaTransactionJobEntity | null> {\r\n        return this._connection.getRepository(MetaTransactionJobEntity).findOne({\r\n            where: { id },\r\n        });\r\n    }\r\n\r\n    /**\r\n     * [meta transaction] Queries the `meta_transaction_jobs` table with the given meta transaction hash.\r\n     */\r\n    public async findMetaTransactionJobByMetaTransactionHashAsync(\r\n        metaTransactionHash: string,\r\n    ): Promise<MetaTransactionJobEntity | null> {\r\n        return this._connection.getRepository(MetaTransactionJobEntity).findOne({\r\n            where: { metaTransactionHash },\r\n        });\r\n    }\r\n\r\n    /**\r\n     * [meta transaction] Queries the `meta_transaction_jobs` table for all jobs with the specified statuss.\r\n     */\r\n    public async findMetaTransactionJobsWithStatusesAsync(\r\n        statuses: RfqmJobStatus[],\r\n    ): Promise<MetaTransactionJobEntity[]> {\r\n        return this._connection.getRepository(MetaTransactionJobEntity).find({\r\n            where: {\r\n                status: In(statuses),\r\n            },\r\n        });\r\n    }\r\n\r\n    /**\r\n     * [meta transaction] Writes to the `meta_transaction_jobs` tabe.\r\n     */\r\n    public async writeMetaTransactionJobAsync(\r\n        metaTransactionJobOpts: MetaTransactionJobConstructorOpts,\r\n    ): Promise<MetaTransactionJobEntity> {\r\n        return this._connection\r\n            .getRepository(MetaTransactionJobEntity)\r\n            .save(new MetaTransactionJobEntity(metaTransactionJobOpts));\r\n    }\r\n\r\n    /**\r\n     * [meta transaction] find unresolved jobs from the `meta_transaction_jobs` table for\r\n     * a given worker address and chain ID.\r\n     */\r\n    public async findUnresolvedMetaTransactionJobsAsync(\r\n        workerAddress: string,\r\n        chainId: number,\r\n    ): Promise<MetaTransactionJobEntity[]> {\r\n        return this._connection.getRepository(MetaTransactionJobEntity).find({\r\n            where: {\r\n                chainId,\r\n                status: In(UnresolvedRfqmJobStatuses),\r\n                workerAddress,\r\n            },\r\n        });\r\n    }\r\n\r\n    /**\r\n     * [meta transaction] Queries the `meta_transaction_submissions` table with the given submission id.\r\n     */\r\n    public async findMetaTransactionSubmissionByIdAsync(id: string): Promise<MetaTransactionSubmissionEntity | null> {\r\n        return this._connection.getRepository(MetaTransactionSubmissionEntity).findOne({\r\n            where: { id },\r\n        });\r\n    }\r\n\r\n    /**\r\n     * [meta transaction] Queries the `meta_transaction_submissions` table with the given transaction hash and type.\r\n     */\r\n    public async findMetaTransactionSubmissionsByTransactionHashAsync(\r\n        transactionHash: string,\r\n        type: RfqmTransactionSubmissionType,\r\n    ): Promise<MetaTransactionSubmissionEntity[]> {\r\n        return this._connection.getRepository(MetaTransactionSubmissionEntity).find({\r\n            where: { transactionHash, type },\r\n        });\r\n    }\r\n\r\n    /**\r\n     * [meta transaction] Queries the `meta_transaction_submissions` table with the given meta transaction job id and type.\r\n     */\r\n    public async findMetaTransactionSubmissionsByJobIdAsync(\r\n        metaTransactionJobId: string,\r\n        type: RfqmTransactionSubmissionType = RfqmTransactionSubmissionType.Trade,\r\n    ): Promise<MetaTransactionSubmissionEntity[]> {\r\n        return this._connection.getRepository(MetaTransactionSubmissionEntity).find({\r\n            where: { metaTransactionJobId, type },\r\n        });\r\n    }\r\n\r\n    /**\r\n     * [meta transaction] writes to the `meta_transaction_submissions` table.\r\n     */\r\n    public async writeMetaTransactionSubmissionAsync(\r\n        constructorOpts: MetaTransactionSubmissionEntityConstructorOpts,\r\n    ): Promise<MetaTransactionSubmissionEntity> {\r\n        return this._connection\r\n            .getRepository(MetaTransactionSubmissionEntity)\r\n            .save(new MetaTransactionSubmissionEntity(constructorOpts));\r\n    }\r\n}\r\n"],"version":3}