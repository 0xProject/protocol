c7e4f9f13f7afd156bc57a6692969e24
"use strict";
Object.defineProperty(exports, "__esModule", { value: true });
const utils_1 = require("@0x/utils");
const constants_1 = require("../../src/core/constants");
const RfqtQuoteValidator_1 = require("../../src/utils/RfqtQuoteValidator");
describe('Rfqt Quote Validator', () => {
    const chainId = 1337;
    const integrator = {
        allowedChainIds: [chainId],
        apiKeys: [],
        integratorId: 'integrator-id',
        label: 'test integrator',
        plp: false,
        rfqm: false,
        rfqt: true,
    };
    const quoteContext = {
        isFirm: false,
        workflow: 'rfqt',
        isUnwrap: false,
        originalMakerToken: '0x1',
        takerTokenDecimals: 18,
        makerTokenDecimals: 18,
        feeModelVersion: 1,
        assetFillAmount: new utils_1.BigNumber(111),
        chainId,
        integrator,
        makerToken: '0x1',
        isSelling: false,
        takerAddress: '0x0',
        takerToken: '0x2',
        txOrigin: '0xtakeraddress',
    };
    const nowTimeS = new utils_1.BigNumber(Date.now()).div(constants_1.ONE_SECOND_MS);
    const validPrices = [
        {
            expiry: nowTimeS.plus(75),
            makerAddress: '0xmaker1',
            makerAmount: new utils_1.BigNumber(111),
            makerId: 'uuid-maker1',
            makerToken: '0x1',
            makerUri: 'maker1.xyz',
            takerAmount: new utils_1.BigNumber(111),
            takerToken: '0x2',
        },
        {
            expiry: nowTimeS.plus(75),
            makerAddress: '0xmaker2',
            makerAmount: new utils_1.BigNumber(111),
            makerId: 'uuid-maker2',
            makerToken: '0x1',
            makerUri: 'maker2.xyz',
            takerAmount: new utils_1.BigNumber(111),
            takerToken: '0x2',
        },
    ];
    const validityWindowMs = constants_1.ONE_MINUTE_MS;
    describe('validateV2Prices', () => {
        it('filters fetched prices for the wrong pair', () => {
            const prices = [
                ...validPrices,
                {
                    expiry: nowTimeS.plus(75),
                    makerAddress: '0xmaker3',
                    makerAmount: new utils_1.BigNumber(111),
                    makerId: 'uuid-maker3',
                    makerToken: '0x1',
                    makerUri: 'maker3.xyz',
                    takerAmount: new utils_1.BigNumber(111),
                    takerToken: '0x3',
                },
            ];
            const validatedPrices = (0, RfqtQuoteValidator_1.validateV2Prices)(prices, quoteContext, validityWindowMs);
            expect(validatedPrices).toEqual(validPrices);
        });
        it('filters fetched prices with tight expiration windows', () => {
            const prices = [
                ...validPrices,
                {
                    expiry: nowTimeS.plus(59),
                    makerAddress: '0xmaker3',
                    makerAmount: new utils_1.BigNumber(111),
                    makerId: 'uuid-maker3',
                    makerToken: '0x1',
                    makerUri: 'maker3.xyz',
                    takerAmount: new utils_1.BigNumber(111),
                    takerToken: '0x2',
                },
            ];
            const validatedPrices = (0, RfqtQuoteValidator_1.validateV2Prices)(prices, quoteContext, validityWindowMs);
            expect(validatedPrices).toEqual(validPrices);
        });
        it('returns an empty array from empty prices', () => {
            const emptyPrices = (0, RfqtQuoteValidator_1.validateV2Prices)([], quoteContext, validityWindowMs);
            expect(emptyPrices).toEqual([]);
        });
    });
    describe('getRfqtV2FillableAmounts', () => {
        it('returns full amounts for fully fillable orders', () => {
            const quotedMakerBalances = [new utils_1.BigNumber(1000), new utils_1.BigNumber(1000)];
            const fillableAmounts = (0, RfqtQuoteValidator_1.getRfqtV2FillableAmounts)(validPrices, chainId, quotedMakerBalances);
            expect(fillableAmounts).toEqual([
                { fillableMakerAmount: new utils_1.BigNumber(111), fillableTakerAmount: new utils_1.BigNumber(111) },
                { fillableMakerAmount: new utils_1.BigNumber(111), fillableTakerAmount: new utils_1.BigNumber(111) },
            ]);
        });
        it('returns full amounts if maker balances are not present', () => {
            const fillableAmounts = (0, RfqtQuoteValidator_1.getRfqtV2FillableAmounts)(validPrices, chainId);
            expect(fillableAmounts).toEqual([
                { fillableMakerAmount: new utils_1.BigNumber(111), fillableTakerAmount: new utils_1.BigNumber(111) },
                { fillableMakerAmount: new utils_1.BigNumber(111), fillableTakerAmount: new utils_1.BigNumber(111) },
            ]);
        });
        it('returns partial amounts if a maker does not have enough balance', () => {
            const quotedMakerBalances = [new utils_1.BigNumber(1000), new utils_1.BigNumber(10)];
            const fillableAmounts = (0, RfqtQuoteValidator_1.getRfqtV2FillableAmounts)(validPrices, chainId, quotedMakerBalances);
            expect(fillableAmounts).toEqual([
                { fillableMakerAmount: new utils_1.BigNumber(111), fillableTakerAmount: new utils_1.BigNumber(111) },
                { fillableMakerAmount: new utils_1.BigNumber(10), fillableTakerAmount: new utils_1.BigNumber(10) },
            ]);
        });
        it('returns zero amounts if a maker has zero balance', () => {
            const quotedMakerBalances = [new utils_1.BigNumber(1000), new utils_1.BigNumber(0)];
            const fillableAmounts = (0, RfqtQuoteValidator_1.getRfqtV2FillableAmounts)(validPrices, chainId, quotedMakerBalances);
            expect(fillableAmounts).toEqual([
                { fillableMakerAmount: new utils_1.BigNumber(111), fillableTakerAmount: new utils_1.BigNumber(111) },
                { fillableMakerAmount: new utils_1.BigNumber(0), fillableTakerAmount: new utils_1.BigNumber(0) },
            ]);
        });
        it('returns zero amounts if supplied maker amount is zero', () => {
            const prices = [
                {
                    expiry: nowTimeS.plus(75),
                    makerAddress: '0xmaker3',
                    makerAmount: new utils_1.BigNumber(0),
                    makerId: 'uuid-maker3',
                    makerToken: '0x1',
                    makerUri: 'maker3.xyz',
                    takerAmount: new utils_1.BigNumber(111),
                    takerToken: '0x2',
                },
            ];
            const quotedMakerBalances = [new utils_1.BigNumber(1000)];
            const fillableAmounts = (0, RfqtQuoteValidator_1.getRfqtV2FillableAmounts)(prices, chainId, quotedMakerBalances);
            expect(fillableAmounts).toEqual([
                { fillableMakerAmount: new utils_1.BigNumber(0), fillableTakerAmount: new utils_1.BigNumber(0) },
            ]);
        });
    });
});
//# sourceMappingURL=data:application/json;charset=utf-8;base64,eyJmaWxlIjoiL1VzZXJzL2Rhdmlkd2Fsc2gvY29kZS1sb2NhbC8weC1yZnEtYXBpL3Rlc3QvdXRpbHMvUmZxdFF1b3RlVmFsaWRhdG9yVGVzdC50cyIsIm1hcHBpbmdzIjoiOztBQUFBLHFDQUFzQztBQUV0Qyx3REFBd0U7QUFJeEUsMkVBQWdHO0FBRWhHLFFBQVEsQ0FBQyxzQkFBc0IsRUFBRSxHQUFHLEVBQUU7SUFDbEMsTUFBTSxPQUFPLEdBQUcsSUFBSSxDQUFDO0lBQ3JCLE1BQU0sVUFBVSxHQUFlO1FBQzNCLGVBQWUsRUFBRSxDQUFDLE9BQU8sQ0FBQztRQUMxQixPQUFPLEVBQUUsRUFBRTtRQUNYLFlBQVksRUFBRSxlQUFlO1FBQzdCLEtBQUssRUFBRSxpQkFBaUI7UUFDeEIsR0FBRyxFQUFFLEtBQUs7UUFDVixJQUFJLEVBQUUsS0FBSztRQUNYLElBQUksRUFBRSxJQUFJO0tBQ2IsQ0FBQztJQUNGLE1BQU0sWUFBWSxHQUFpQjtRQUMvQixNQUFNLEVBQUUsS0FBSztRQUNiLFFBQVEsRUFBRSxNQUFNO1FBQ2hCLFFBQVEsRUFBRSxLQUFLO1FBQ2Ysa0JBQWtCLEVBQUUsS0FBSztRQUN6QixrQkFBa0IsRUFBRSxFQUFFO1FBQ3RCLGtCQUFrQixFQUFFLEVBQUU7UUFDdEIsZUFBZSxFQUFFLENBQUM7UUFDbEIsZUFBZSxFQUFFLElBQUksaUJBQVMsQ0FBQyxHQUFHLENBQUM7UUFDbkMsT0FBTztRQUNQLFVBQVU7UUFDVixVQUFVLEVBQUUsS0FBSztRQUNqQixTQUFTLEVBQUUsS0FBSztRQUNoQixZQUFZLEVBQUUsS0FBSztRQUNuQixVQUFVLEVBQUUsS0FBSztRQUNqQixRQUFRLEVBQUUsZ0JBQWdCO0tBQzdCLENBQUM7SUFDRixNQUFNLFFBQVEsR0FBRyxJQUFJLGlCQUFTLENBQUMsSUFBSSxDQUFDLEdBQUcsRUFBRSxDQUFDLENBQUMsR0FBRyxDQUFDLHlCQUFhLENBQUMsQ0FBQztJQUM5RCxNQUFNLFdBQVcsR0FBa0I7UUFDL0I7WUFDSSxNQUFNLEVBQUUsUUFBUSxDQUFDLElBQUksQ0FB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RUFBRSxHQUFHLEVBQUU7WUFDN0QsTUFBTSxNQUFNLEdBQUc7Z0JBQ1g7b0JBQ0ksTUFBTSxFQUFFLFFBQVEsQ0FBQyxJQUFJLENBQUMsRUFBRSxDQUFDO29CQUN6QixZQUFZLEVBQUUsVUFBVTtvQkFDeEIsV0FBVyxFQUFFLElBQUksaUJBQVMsQ0FBQyxDQUFDLENBQUM7b0JBQzdCLE9BQU8sRUFBRSxhQUFhO29CQUN0QixVQUFVLEVBQUUsS0FBSztvQkFDakIsUUFBUSxFQUFFLFlBQVk7b0JBQ3RCLFdBQVcsRUFBRSxJQUFJLGlCQUFTLENBQUMsR0FBRyxDQUFDO29CQUMvQixVQUFVLEVBQUUsS0FBSztpQkFDcEI7YUFDSixDQUFDO1lBQ0YsTUFBTSxtQkFBbUIsR0FBRyxDQUFDLElBQUksaUJBQVMsQ0FBQyxJQUFJLENBQUMsQ0FBQyxDQUFDO1lBQ2xELE1BQU0sZUFBZSxHQUFHLElBQUEsNkNBQXdCLEVBQUMsTUFBTSxFQUFFLE9BQU8sRUFBRSxtQkFBbUIsQ0FBQyxDQUFDO1lBQ3ZGLE1BQU0sQ0FBQyxlQUFlLENBQUMsQ0FBQyxPQUFPLENBQUM7Z0JBQzVCLEVBQUUsbUJBQW1CLEVBQUUsSUFBSSxpQkFBUyxDQUFDLENBQUMsQ0FBQyxFQUFFLG1CQUFtQixFQUFFLElBQUksaUJBQVMsQ0FBQyxDQUFDLENBQUMsRUFBRTthQUNuRixDQUFDLENBQUM7UUFDUCxDQUFDLENBQUMsQ0FBQztJQUNQLENBQUMsQ0FBQyxDQUFDO0FBQ1AsQ0FBQyxDQUFDLENBQUMiLCJuYW1lcyI6W10sInNvdXJjZXMiOlsiL1VzZXJzL2Rhdmlkd2Fsc2gvY29kZS1sb2NhbC8weC1yZnEtYXBpL3Rlc3QvdXRpbHMvUmZxdFF1b3RlVmFsaWRhdG9yVGVzdC50cyJdLCJzb3VyY2VzQ29udGVudCI6WyJpbXBvcnQgeyBCaWdOdW1iZXIgfSBmcm9tICdAMHgvdXRpbHMnO1xuaW1wb3J0IHsgSW50ZWdyYXRvciB9IGZyb20gJy4uLy4uL3NyYy9jb25maWcnO1xuaW1wb3J0IHsgT05FX01JTlVURV9NUywgT05FX1NFQ09ORF9NUyB9IGZyb20gJy4uLy4uL3NyYy9jb3JlL2NvbnN0YW50cyc7XG5pbXBvcnQgeyBRdW90ZUNvbnRleHQgfSBmcm9tICcuLi8uLi9zcmMvc2VydmljZXMvdHlwZXMnO1xuXG5pbXBvcnQgeyBSZnF0VjJQcmljZSB9IGZyb20gJy4uLy4uL3NyYy9jb3JlL3R5cGVzJztcbmltcG9ydCB7IGdldFJmcXRWMkZpbGxhYmxlQW1vdW50cywgdmFsaWRhdGVWMlByaWNlcyB9IGZyb20gJy4uLy4uL3NyYy91dGlscy9SZnF0UXVvdGVWYWxpZGF0b3InO1xuXG5kZXNjcmliZSgnUmZxdCBRdW90ZSBWYWxpZGF0b3InLCAoKSA9PiB7XG4gICAgY29uc3QgY2hhaW5JZCA9IDEzMzc7XG4gICAgY29uc3QgaW50ZWdyYXRvcjogSW50ZWdyYXRvciA9IHtcbiAgICAgICAgYWxsb3dlZENoYWluSWRzOiBbY2hhaW5JZF0sXG4gICAgICAgIGFwaUtleXM6IFtdLFxuICAgICAgICBpbnRlZ3JhdG9ySWQ6ICdpbnRlZ3JhdG9yLWlkJyxcbiAgICAgICAgbGFiZWw6ICd0ZXN0IGludGVncmF0b3InLFxuICAgICAgICBwbHA6IGZhbHNlLFxuICAgICAgICByZnFtOiBmYWxzZSxcbiAgICAgICAgcmZxdDogdHJ1ZSxcbiAgICB9O1xuICAgIGNvbnN0IHF1b3RlQ29udGV4dDogUXVvdGVDb250ZXh0ID0ge1xuICAgICAgICBpc0Zpcm06IGZhbHNlLFxuICAgICAgICB3b3JrZmxvdzogJ3JmcXQnLFxuICAgICAgICBpc1Vud3JhcDogZmFsc2UsXG4gICAgICAgIG9yaWdpbmFsTWFrZXJUb2tlbjogJzB4MScsXG4gICAgICAgIHRha2VyVG9rZW5EZWNpbWFsczogMTgsXG4gICAgICAgIG1ha2VyVG9rZW5EZWNpbWFsczogMTgsXG4gICAgICAgIGZlZU1vZGVsVmVyc2lvbjogMSxcbiAgICAgICAgYXNzZXRGaWxsQW1vdW50OiBuZXcgQmlnTnVtYmVyKDExMSksXG4gICAgICAgIGNoYWluSWQsXG4gICAgICAgIGludGVncmF0b3IsXG4gICAgICAgIG1ha2VyVG9rZW46ICcweDEnLFxuICAgICAgICBpc1NlbGxpbmc6IGZhbHNlLFxuICAgICAgICB0YWtlckFkZHJlc3M6ICcweDAnLFxuICAgICAgICB0YWtlclRva2VuOiAnMHgyJyxcbiAgICAgICAgdHhPcmlnaW46ICcweHRha2VyYWRkcmVzcycsXG4gICAgfTtcbiAgICBjb25zdCBub3dUaW1lUyA9IG5ldyBCaWdOdW1iZXIoRGF0ZS5ub3coKSkuZGl2KE9ORV9TRUNPTkRfTVMpO1xuICAgIGNvbnN0IHZhbGlkUHJpY2VzOiBSZnF0VjJQcmljZVtdID0gW1xuICAgICAgICB7XG4gICAgICAgICAgICBleHBpcnk6IG5vd1RpbWVTLnBsdXMoNzUpLFxuICAgICAgICAgICAgbWFrZXJBZGRyZXNzOiAnMHhtYWtlcjEnLFxuICAgICAgICAgICAgbWFrZXJBbW91bnQ6IG5ldyBCaWdOdW1iZXIoMTExKSxcbiAgICAgICAgICAgIG1ha2VySWQ6ICd1dWlkLW1ha2VyMScsXG4gICAgICAgICAgICBtYWtlclRva2VuOiAnMHgxJyxcbiAgICAgICAgICAgIG1ha2VyVXJpOiAnbWFrZXIxLnh5eicsXG4gICAgICAgICAgICB0YWtlckFtb3VudDogbmV3IEJpZ051bWJlcigxMTEpLFxuICAgICAgICAgICAgdGFrZXJUb2tlbjogJzB4MicsXG4gICAgICAgIH0sXG4gICAgICAgIHtcbiAgICAgICAgICAgIGV4cGlyeTogbm93VGltZVMucGx1cyg3NSksXG4gICAgICAgICAgICBtYWtlckFkZHJlc3M6ICcweG1ha2VyMicsXG4gICAgICAgICAgICBtYWtlckFtb3VudDogbmV3IEJpZ051bWJlcigxMTEpLFxuICAgICAgICAgICAgbWFrZXJJZDogJ3V1aWQtbWFrZXIyJyxcbiAgICAgICAgICAgIG1ha2VyVG9rZW46ICcweDEnLFxuICAgICAgICAgICAgbWFrZXJVcmk6ICdtYWtlcjIueHl6JyxcbiAgICAgICAgICAgIHRha2VyQW1vdW50OiBuZXcgQmlnTnVtYmVyKDExMSksXG4gICAgICAgICAgICB0YWtlclRva2VuOiAnMHgyJyxcbiAgICAgICAgfSxcbiAgICBdO1xuICAgIGNvbnN0IHZhbGlkaXR5V2luZG93TXMgPSBPTkVfTUlOVVRFX01TO1xuXG4gICAgZGVzY3JpYmUoJ3ZhbGlkYXRlVjJQcmljZXMnLCAoKSA9PiB7XG4gICAgICAgIGl0KCdmaWx0ZXJzIGZldGNoZWQgcHJpY2VzIGZvciB0aGUgd3JvbmcgcGFpcicsICgpID0+IHtcbiAgICAgICAgICAgIGNvbnN0IHByaWNlczogUmZxdFYyUHJpY2VbXSA9IFtcbiAgICAgICAgICAgICAgICAuLi52YWxpZFByaWNlcyxcbiAgICAgICAgICAgICAgICB7XG4gICAgICAgICAgICAgICAgICAgIGV4cGlyeTogbm93VGltZVMucGx1cyg3NSksXG4gICAgICAgICAgICAgICAgICAgIG1ha2VyQWRkcmVzczogJzB4bWFrZXIzJyxcbiAgICAgICAgICAgICAgICAgICAgbWFrZXJBbW91bnQ6IG5ldyBCaWdOdW1iZXIoMTExKSxcbiAgICAgICAgICAgICAgICAgICAgbWFrZXJJZDogJ3V1aWQtbWFrZXIzJyxcbiAgICAgICAgICAgICAgICAgICAgbWFrZXJUb2tlbjogJzB4MScsXG4gICAgICAgICAgICAgICAgICAgIG1ha2VyVXJpOiAnbWFrZXIzLnh5eicsXG4gICAgICAgICAgICAgICAgICAgIHRha2VyQW1vdW50OiBuZXcgQmlnTnVtYmVyKDExMSksXG4gICAgICAgICAgICAgICAgICAgIHRha2VyVG9rZW46ICcweDMnLFxuICAgICAgICAgICAgICAgIH0sXG4gICAgICAgICAgICBdO1xuICAgICAgICAgICAgY29uc3QgdmFsaWRhdGVkUHJpY2VzID0gdmFsaWRhdGVWMlByaWNlcyhwcmljZXMsIHF1b3RlQ29udGV4dCwgdmFsaWRpdHlXaW5kb3dNcyk7XG4gICAgICAgICAgICBleHBlY3QodmFsaWRhdGVkUHJpY2VzKS50b0VxdWFsKHZhbGlkUHJpY2VzKTtcbiAgICAgICAgfSk7XG5cbiAgICAgICAgaXQoJ2ZpbHRlcnMgZmV0Y2hlZCBwcmljZXMgd2l0aCB0aWdodCBleHBpcmF0aW9uIHdpbmRvd3MnLCAoKSA9PiB7XG4gICAgICAgICAgICBjb25zdCBwcmljZXM6IFJmcXRWMlByaWNlW10gPSBbXG4gICAgICAgICAgICAgICAgLi4udmFsaWRQcmljZXMsXG4gICAgICAgICAgICAgICAge1xuICAgICAgICAgICAgICAgICAgICBleHBpcnk6IG5vd1RpbWVTLnBsdXMoNTkpLFxuICAgICAgICAgICAgICAgICAgICBtYWtlckFkZHJlc3M6ICcweG1ha2VyMycsXG4gICAgICAgICAgICAgICAgICAgIG1ha2VyQW1vdW50OiBuZXcgQmlnTnVtYmVyKDExMSksXG4gICAgICAgICAgICAgICAgICAgIG1ha2VySWQ6ICd1dWlkLW1ha2VyMycsXG4gICAgICAgICAgICAgICAgICAgIG1ha2VyVG9rZW46ICcweDEnLFxuICAgICAgICAgICAgICAgICAgICBtYWtlclVyaTogJ21ha2VyMy54eXonLFxuICAgICAgICAgICAgICAgICAgICB0YWtlckFtb3VudDogbmV3IEJpZ051bWJlcigxMTEpLFxuICAgICAgICAgICAgICAgICAgICB0YWtlclRva2VuOiAnMHgyJyxcbiAgICAgICAgICAgICAgICB9LFxuICAgICAgICAgICAgXTtcbiAgICAgICAgICAgIGNvbnN0IHZhbGlkYXRlZFByaWNlcyA9IHZhbGlkYXRlVjJQcmljZXMocHJpY2VzLCBxdW90ZUNvbnRleHQsIHZhbGlkaXR5V2luZG93TXMpO1xuICAgICAgICAgICAgZXhwZWN0KHZhbGlkYXRlZFByaWNlcykudG9FcXVhbCh2YWxpZFByaWNlcyk7XG4gICAgICAgIH0pO1xuXG4gICAgICAgIGl0KCdyZXR1cm5zIGFuIGVtcHR5IGFycmF5IGZyb20gZW1wdHkgcHJpY2VzJywgKCkgPT4ge1xuICAgICAgICAgICAgY29uc3QgZW1wdHlQcmljZXMgPSB2YWxpZGF0ZVYyUHJpY2VzKFtdLCBxdW90ZUNvbnRleHQsIHZhbGlkaXR5V2luZG93TXMpO1xuICAgICAgICAgICAgZXhwZWN0KGVtcHR5UHJpY2VzKS50b0VxdWFsKFtdKTtcbiAgICAgICAgfSk7XG4gICAgfSk7XG5cbiAgICBkZXNjcmliZSgnZ2V0UmZxdFYyRmlsbGFibGVBbW91bnRzJywgKCkgPT4ge1xuICAgICAgICBpdCgncmV0dXJucyBmdWxsIGFtb3VudHMgZm9yIGZ1bGx5IGZpbGxhYmxlIG9yZGVycycsICgpID0+IHtcbiAgICAgICAgICAgIGNvbnN0IHF1b3RlZE1ha2VyQmFsYW5jZXMgPSBbbmV3IEJpZ051bWJlcigxMDAwKSwgbmV3IEJpZ051bWJlcigxMDAwKV07XG4gICAgICAgICAgICBjb25zdCBmaWxsYWJsZUFtb3VudHMgPSBnZXRSZnF0VjJGaWxsYWJsZUFtb3VudHModmFsaWRQcmljZXMsIGNoYWluSWQsIHF1b3RlZE1ha2VyQmFsYW5jZXMpO1xuICAgICAgICAgICAgZXhwZWN0KGZpbGxhYmxlQW1vdW50cykudG9FcXVhbChbXG4gICAgICAgICAgICAgICAgeyBmaWxsYWJsZU1ha2VyQW1vdW50OiBuZXcgQmlnTnVtYmVyKDExMSksIGZpbGxhYmxlVGFrZXJBbW91bnQ6IG5ldyBCaWdOdW1iZXIoMTExKSB9LFxuICAgICAgICAgICAgICAgIHsgZmlsbGFibGVNYWtlckFtb3VudDogbmV3IEJpZ051bWJlcigxMTEpLCBmaWxsYWJsZVRha2VyQW1vdW50OiBuZXcgQmlnTnVtYmVyKDExMSkgfSxcbiAgICAgICAgICAgIF0pO1xuICAgICAgICB9KTtcblxuICAgICAgICBpdCgncmV0dXJucyBmdWxsIGFtb3VudHMgaWYgbWFrZXIgYmFsYW5jZXMgYXJlIG5vdCBwcmVzZW50JywgKCkgPT4ge1xuICAgICAgICAgICAgY29uc3QgZmlsbGFibGVBbW91bnRzID0gZ2V0UmZxdFYyRmlsbGFibGVBbW91bnRzKHZhbGlkUHJpY2VzLCBjaGFpbklkKTtcbiAgICAgICAgICAgIGV4cGVjdChmaWxsYWJsZUFtb3VudHMpLnRvRXF1YWwoW1xuICAgICAgICAgICAgICAgIHsgZmlsbGFibGVNYWtlckFtb3VudDogbmV3IEJpZ051bWJlcigxMTEpLCBmaWxsYWJsZVRha2VyQW1vdW50OiBuZXcgQmlnTnVtYmVyKDExMSkgfSxcbiAgICAgICAgICAgICAgICB7IGZpbGxhYmxlTWFrZXJBbW91bnQ6IG5ldyBCaWdOdW1iZXIoMTExKSwgZmlsbGFibGVUYWtlckFtb3VudDogbmV3IEJpZ051bWJlcigxMTEpIH0sXG4gICAgICAgICAgICBdKTtcbiAgICAgICAgfSk7XG5cbiAgICAgICAgaXQoJ3JldHVybnMgcGFydGlhbCBhbW91bnRzIGlmIGEgbWFrZXIgZG9lcyBub3QgaGF2ZSBlbm91Z2ggYmFsYW5jZScsICgpID0+IHtcbiAgICAgICAgICAgIGNvbnN0IHF1b3RlZE1ha2VyQmFsYW5jZXMgPSBbbmV3IEJpZ051bWJlcigxMDAwKSwgbmV3IEJpZ051bWJlcigxMCldO1xuICAgICAgICAgICAgY29uc3QgZmlsbGFibGVBbW91bnRzID0gZ2V0UmZxdFYyRmlsbGFibGVBbW91bnRzKHZhbGlkUHJpY2VzLCBjaGFpbklkLCBxdW90ZWRNYWtlckJhbGFuY2VzKTtcbiAgICAgICAgICAgIGV4cGVjdChmaWxsYWJsZUFtb3VudHMpLnRvRXF1YWwoW1xuICAgICAgICAgICAgICAgIHsgZmlsbGFibGVNYWtlckFtb3VudDogbmV3IEJpZ051bWJlcigxMTEpLCBmaWxsYWJsZVRha2VyQW1vdW50OiBuZXcgQmlnTnVtYmVyKDExMSkgfSxcbiAgICAgICAgICAgICAgICB7IGZpbGxhYmxlTWFrZXJBbW91bnQ6IG5ldyBCaWdOdW1iZXIoMTApLCBmaWxsYWJsZVRha2VyQW1vdW50OiBuZXcgQmlnTnVtYmVyKDEwKSB9LFxuICAgICAgICAgICAgXSk7XG4gICAgICAgIH0pO1xuXG4gICAgICAgIGl0KCdyZXR1cm5zIHplcm8gYW1vdW50cyBpZiBhIG1ha2VyIGhhcyB6ZXJvIGJhbGFuY2UnLCAoKSA9PiB7XG4gICAgICAgICAgICBjb25zdCBxdW90ZWRNYWtlckJhbGFuY2VzID0gW25ldyBCaWdOdW1iZXIoMTAwMCksIG5ldyBCaWdOdW1iZXIoMCldO1xuICAgICAgICAgICAgY29uc3QgZmlsbGFibGVBbW91bnRzID0gZ2V0UmZxdFYyRmlsbGFibGVBbW91bnRzKHZhbGlkUHJpY2VzLCBjaGFpbklkLCBxdW90ZWRNYWtlckJhbGFuY2VzKTtcbiAgICAgICAgICAgIGV4cGVjdChmaWxsYWJsZUFtb3VudHMpLnRvRXF1YWwoW1xuICAgICAgICAgICAgICAgIHsgZmlsbGFibGVNYWtlckFtb3VudDogbmV3IEJpZ051bWJlcigxMTEpLCBmaWxsYWJsZVRha2VyQW1vdW50OiBuZXcgQmlnTnVtYmVyKDExMSkgfSxcbiAgICAgICAgICAgICAgICB7IGZpbGxhYmxlTWFrZXJBbW91bnQ6IG5ldyBCaWdOdW1iZXIoMCksIGZpbGxhYmxlVGFrZXJBbW91bnQ6IG5ldyBCaWdOdW1iZXIoMCkgfSxcbiAgICAgICAgICAgIF0pO1xuICAgICAgICB9KTtcblxuICAgICAgICBpdCgncmV0dXJucyB6ZXJvIGFtb3VudHMgaWYgc3VwcGxpZWQgbWFrZXIgYW1vdW50IGlzIHplcm8nLCAoKSA9PiB7XG4gICAgICAgICAgICBjb25zdCBwcmljZXMgPSBbXG4gICAgICAgICAgICAgICAge1xuICAgICAgICAgICAgICAgICAgICBleHBpcnk6IG5vd1RpbWVTLnBsdXMoNzUpLFxuICAgICAgICAgICAgICAgICAgICBtYWtlckFkZHJlc3M6ICcweG1ha2VyMycsXG4gICAgICAgICAgICAgICAgICAgIG1ha2VyQW1vdW50OiBuZXcgQmlnTnVtYmVyKDApLFxuICAgICAgICAgICAgICAgICAgICBtYWtlcklkOiAndXVpZC1tYWtlcjMnLFxuICAgICAgICAgICAgICAgICAgICBtYWtlclRva2VuOiAnMHgxJyxcbiAgICAgICAgICAgICAgICAgICAgbWFrZXJVcmk6ICdtYWtlcjMueHl6JyxcbiAgICAgICAgICAgICAgICAgICAgdGFrZXJBbW91bnQ6IG5ldyBCaWdOdW1iZXIoMTExKSxcbiAgICAgICAgICAgICAgICAgICAgdGFrZXJUb2tlbjogJzB4MicsXG4gICAgICAgICAgICAgICAgfSxcbiAgICAgICAgICAgIF07XG4gICAgICAgICAgICBjb25zdCBxdW90ZWRNYWtlckJhbGFuY2VzID0gW25ldyBCaWdOdW1iZXIoMTAwMCldO1xuICAgICAgICAgICAgY29uc3QgZmlsbGFibGVBbW91bnRzID0gZ2V0UmZxdFYyRmlsbGFibGVBbW91bnRzKHByaWNlcywgY2hhaW5JZCwgcXVvdGVkTWFrZXJCYWxhbmNlcyk7XG4gICAgICAgICAgICBleHBlY3QoZmlsbGFibGVBbW91bnRzKS50b0VxdWFsKFtcbiAgICAgICAgICAgICAgICB7IGZpbGxhYmxlTWFrZXJBbW91bnQ6IG5ldyBCaWdOdW1iZXIoMCksIGZpbGxhYmxlVGFrZXJBbW91bnQ6IG5ldyBCaWdOdW1iZXIoMCkgfSxcbiAgICAgICAgICAgIF0pO1xuICAgICAgICB9KTtcbiAgICB9KTtcbn0pO1xuIl0sInZlcnNpb24iOjN9