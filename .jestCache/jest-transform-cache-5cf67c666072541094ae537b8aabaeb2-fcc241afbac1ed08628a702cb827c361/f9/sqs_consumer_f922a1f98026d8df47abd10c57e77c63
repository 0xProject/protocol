53d99c99af36c1db1cf64dd23d8b9a03
"use strict";
Object.defineProperty(exports, "__esModule", { value: true });
exports.SqsConsumer = exports.SqsRetryableError = void 0;
// tslint:disable: max-classes-per-file
const Sentry = require("@sentry/node");
const delay_1 = require("delay");
const config_1 = require("../config");
const constants_1 = require("../core/constants");
const logger_1 = require("../logger");
class SqsRetryableError extends Error {
}
exports.SqsRetryableError = SqsRetryableError;
class SqsConsumer {
    constructor(params) {
        this._workerIndex = params.workerIndex;
        this._workerAddress = params.workerAddress;
        this._sqsClient = params.sqsClient;
        this._beforeHandle = params.beforeHandle;
        this._handleMessage = params.handleMessage;
        this._afterHandle = params.afterHandle;
        this._isConsuming = false;
    }
    get workerIndex() {
        return this._workerIndex;
    }
    get workerAddress() {
        return this._workerAddress;
    }
    stop() {
        this._isConsuming = false;
    }
    async consumeAsync() {
        if (this._isConsuming) {
            return;
        }
        this._isConsuming = true;
        while (this._isConsuming) {
            await this.consumeOnceAsync();
        }
    }
    /**
     * Decorates _consumeOnceInternalAsync with Sentry observability
     */
    async consumeOnceAsync() {
        let transaction;
        if (config_1.SENTRY_DSN) {
            transaction = Sentry.startTransaction({
                name: 'Worker Transaction',
            });
        }
        try {
            await this._consumeOnceInternalAsync();
        }
        catch (e) {
            if (config_1.SENTRY_DSN) {
                Sentry.captureException(e);
            }
            logger_1.logger.error({ id: this._workerAddress, workerIndex: this._workerIndex, errorMessage: e.message }, `Encountered error when consuming from the queue`);
        }
        finally {
            if (config_1.SENTRY_DSN) {
                transaction === null || transaction === void 0 ? void 0 : transaction.finish();
            }
        }
    }
    async _consumeOnceInternalAsync() {
        // Run the before hook
        if (this._beforeHandle) {
            let beforeCheck;
            try {
                beforeCheck = await this._beforeHandle();
            }
            catch (e) {
                logger_1.logger.error({ id: this._workerAddress, workerIndex: this._workerIndex, errorMessage: e.message }, 'Error encountered in the preHandle check');
                throw e;
            }
            if (!beforeCheck) {
                const errorMessage = 'Before validation failed';
                logger_1.logger.warn({ id: this._workerAddress, workerIndex: this._workerIndex }, errorMessage);
                await (0, delay_1.default)(constants_1.ONE_SECOND_MS);
                return;
            }
        }
        // Receive message
        const message = await this._sqsClient.receiveMessageAsync();
        // No message
        if (message === null) {
            return;
        }
        // Handle message
        let error;
        try {
            await this._handleMessage(message);
        }
        catch (err) {
            error = err;
            logger_1.logger.error({ errorMessage: err.message, message, id: this._workerAddress, workerIndex: this._workerIndex }, 'Encountered error while handling message');
            if (err instanceof SqsRetryableError) {
                logger_1.logger.info({ message, id: this._workerAddress, workerIndex: this._workerIndex }, 'Retrying message');
                // Retry message
                // $eslint-fix-me https://github.com/rhinodavid/eslint-fix-me
                // eslint-disable-next-line @typescript-eslint/no-non-null-assertion
                await this._sqsClient.changeMessageVisibilityAsync(message.ReceiptHandle, 0);
                await (0, delay_1.default)(constants_1.ONE_SECOND_MS);
                throw err;
            }
        }
        // Delete message
        // $eslint-fix-me https://github.com/rhinodavid/eslint-fix-me
        // eslint-disable-next-line @typescript-eslint/no-non-null-assertion
        await this._sqsClient.deleteMessageAsync(message.ReceiptHandle);
        // Run the after hook
        if (this._afterHandle) {
            await this._afterHandle(message, error);
        }
        if (error) {
            throw error;
        }
    }
}
exports.SqsConsumer = SqsConsumer;
//# sourceMappingURL=data:application/json;charset=utf-8;base64,eyJmaWxlIjoiL1VzZXJzL2Rhdmlkd2Fsc2gvY29kZS1sb2NhbC8weC1yZnEtYXBpL3NyYy91dGlscy9zcXNfY29uc3VtZXIudHMiLCJtYXBwaW5ncyI6Ijs7O0FBQUEsdUNBQXVDO0FBQ3ZDLHVDQUF1QztBQUd2QyxpQ0FBMEI7QUFFMUIsc0NBQXVDO0FBQ3ZDLGlEQUFrRDtBQUNsRCxzQ0FBbUM7QUFRbkMsTUFBYSxpQkFBa0IsU0FBUSxLQUFLO0NBQUc7QUFBL0MsOENBQStDO0FBQy9DLE1BQWEsV0FBVztJQVdwQixZQUFZLE1BU1g7UUFDRyxJQUFJLENBQUMsWUFBWSxHQUFHLE1BQU0sQ0FBQyxXQUFXLENBQUM7UUFDdkMsSUFBSSxDQUFDLGNBQWMsR0FBRyxNQUFNLENBQUMsYUFBYSxDQUFDO1FBQzNDLElBQUksQ0FBQyxVQUFVLEdBQUcsTUFBTSxDQUFDLFNBQVMsQ0FBQztRQUNuQyxJQUFJLENBQUMsYUFBYSxHQUFHLE1BQU0sQ0FBQyxZQUFZLENBQUM7UUFDekMsSUFBSSxDQUFDLGNBQWMsR0FBRyxNQUFNLENBQUMsYUFBYSxDQUFDO1FBQzNDLElBQUksQ0FBQyxZQUFZLEdBQUcsTUFBTSxDQUFDLFdBQVcsQ0FBQztRQUN2QyxJQUFJLENBQUMsWUFBWSxHQUFHLEtBQUssQ0FBQztJQUM5QixDQUFDO0lBRUQsSUFBVyxXQUFXO1FBQ2xCLE9BQU8sSUFBSSxDQUFDLFlBQVksQ0FBQztJQUM3QixDQUFDO0lBRUQsSUFBVyxhQUFhO1FBQ3BCLE9BQU8sSUFBSSxDQUFDLGNBQWMsQ0FBQztJQUMvQixDQUFDO0lBRU0sSUFBSTtRQUNQLElBQUksQ0FBQyxZQUFZLEdBQUcsS0FBSyxDQUFDO0lBQzlCLENBQUM7SUFFTSxLQUFLLENBQUMsWUFBWTtRQUNyQixJQUFJLElBQUksQ0FBQyxZQUFZLEVBQUU7WUFDbkIsT0FBTztTQUNWO1FBRUQsSUFBSSxDQUFDLFlBQVksR0FBRyxJQUFJLENBQUM7UUFDekIsT0FBTyxJQUFJLENBQUMsWUFBWSxFQUFFO1lBQ3RCLE1BQU0sSUFBSSxDQUFDLGdCQUFnQixF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QUFVLENBQUMsNEJBQTRCLENBQUMsT0FBTyxDQUFDLGFBQWMsRUFBRSxDQUFDLENBQUMsQ0FBQztnQkFDOUUsTUFBTSxJQUFBLGVBQUssRUFBQyx5QkFBYSxDQUFDLENBQUM7Z0JBQzNCLE1BQU0sR0FBRyxDQUFDO2FBQ2I7U0FDSjtRQUVELGlCQUFpQjtRQUNqQiw2REFBNkQ7UUFDN0Qsb0VBQW9FO1FBQ3BFLE1BQU0sSUFBSSxDQUFDLFVBQVUsQ0FBQyxrQkFBa0IsQ0FBQyxPQUFPLENBQUMsYUFBYyxDQUFDLENBQUM7UUFFakUscUJBQXFCO1FBQ3JCLElBQUksSUFBSSxDQUFDLFlBQVksRUFBRTtZQUNuQixNQUFNLElBQUksQ0FBQyxZQUFZLENBQUMsT0FBTyxFQUFFLEtBQUssQ0FBQyxDQUFDO1NBQzNDO1FBRUQsSUFBSSxLQUFLLEVBQUU7WUFDUCxNQUFNLEtBQUssQ0FBQztTQUNmO0lBQ0wsQ0FBQztDQUNKO0FBbkpELGtDQW1KQyIsIm5hbWVzIjpbXSwic291cmNlcyI6WyIvVXNlcnMvZGF2aWR3YWxzaC9jb2RlLWxvY2FsLzB4LXJmcS1hcGkvc3JjL3V0aWxzL3Nxc19jb25zdW1lci50cyJdLCJzb3VyY2VzQ29udGVudCI6WyIvLyB0c2xpbnQ6ZGlzYWJsZTogbWF4LWNsYXNzZXMtcGVyLWZpbGVcclxuaW1wb3J0ICogYXMgU2VudHJ5IGZyb20gJ0BzZW50cnkvbm9kZSc7XHJcbmltcG9ydCB7IFRyYW5zYWN0aW9uIGFzIFNlbnRyeVRyYW5zYWN0aW9uIH0gZnJvbSAnQHNlbnRyeS90eXBlcyc7XHJcbmltcG9ydCB7IFNRUyB9IGZyb20gJ2F3cy1zZGsnO1xyXG5pbXBvcnQgZGVsYXkgZnJvbSAnZGVsYXknO1xyXG5cclxuaW1wb3J0IHsgU0VOVFJZX0RTTiB9IGZyb20gJy4uL2NvbmZpZyc7XHJcbmltcG9ydCB7IE9ORV9TRUNPTkRfTVMgfSBmcm9tICcuLi9jb3JlL2NvbnN0YW50cyc7XHJcbmltcG9ydCB7IGxvZ2dlciB9IGZyb20gJy4uL2xvZ2dlcic7XHJcblxyXG5pbXBvcnQgeyBTcXNDbGllbnQgfSBmcm9tICcuL3Nxc19jbGllbnQnO1xyXG5cclxuLy8gJGVzbGludC1maXgtbWUgaHR0cHM6Ly9naXRodWIuY29tL3JoaW5vZGF2aWQvZXNsaW50LWZpeC1tZVxyXG4vLyBlc2xpbnQtZGlzYWJsZS1uZXh0LWxpbmUgQHR5cGVzY3JpcHQtZXNsaW50L25vLWV4cGxpY2l0LWFueVxyXG5leHBvcnQgdHlwZSBNZXNzYWdlSGFuZGxlciA9IChtZXNzYWdlOiBTUVMuVHlwZXMuTWVzc2FnZSkgPT4gUHJvbWlzZTxhbnk+O1xyXG5cclxuZXhwb3J0IGNsYXNzIFNxc1JldHJ5YWJsZUVycm9yIGV4dGVuZHMgRXJyb3Ige31cclxuZXhwb3J0IGNsYXNzIFNxc0NvbnN1bWVyIHtcclxuICAgIHByaXZhdGUgcmVhZG9ubHkgX3dvcmtlckluZGV4OiBudW1iZXI7XHJcbiAgICBwcml2YXRlIHJlYWRvbmx5IF93b3JrZXJBZGRyZXNzOiBzdHJpbmc7XHJcbiAgICBwcml2YXRlIHJlYWRvbmx5IF9zcXNDbGllbnQ6IFNxc0NsaWVudDtcclxuICAgIHByaXZhdGUgcmVhZG9ubHkgX2JlZm9yZUhhbmRsZT86ICgpID0+IFByb21pc2U8Ym9vbGVhbj47XHJcbiAgICBwcml2YXRlIHJlYWRvbmx5IF9oYW5kbGVNZXNzYWdlOiBNZXNzYWdlSGFuZGxlcjtcclxuICAgIC8vICRlc2xpbnQtZml4LW1lIGh0dHBzOi8vZ2l0aHViLmNvbS9yaGlub2RhdmlkL2VzbGludC1maXgtbWVcclxuICAgIC8vIGVzbGludC1kaXNhYmxlLW5leHQtbGluZSBAdHlwZXNjcmlwdC1lc2xpbnQvbm8tZXhwbGljaXQtYW55XHJcbiAgICBwcml2YXRlIHJlYWRvbmx5IF9hZnRlckhhbmRsZT86IChtZXNzYWdlOiBTUVMuVHlwZXMuTWVzc2FnZSwgZXJyb3I/OiBFcnJvcikgPT4gUHJvbWlzZTxhbnk+O1xyXG4gICAgcHJpdmF0ZSBfaXNDb25zdW1pbmc6IGJvb2xlYW47XHJcblxyXG4gICAgY29uc3RydWN0b3IocGFyYW1zOiB7XHJcbiAgICAgICAgd29ya2VySW5kZXg6IG51bWJlcjtcclxuICAgICAgICB3b3JrZXJBZGRyZXNzOiBzdHJpbmc7XHJcbiAgICAgICAgc3FzQ2xpZW50OiBTcXNDbGllbnQ7XHJcbiAgICAgICAgYmVmb3JlSGFuZGxlPzogKCkgPT4gUHJvbWlzZTxib29sZWFuPjtcclxuICAgICAgICBoYW5kbGVNZXNzYWdlOiBNZXNzYWdlSGFuZGxlcjtcclxuICAgICAgICAvLyAkZXNsaW50LWZpeC1tZSBodHRwczovL2dpdGh1Yi5jb20vcmhpbm9kYXZpZC9lc2xpbnQtZml4LW1lXHJcbiAgICAgICAgLy8gZXNsaW50LWRpc2FibGUtbmV4dC1saW5lIEB0eXBlc2NyaXB0LWVzbGludC9uby1leHBsaWNpdC1hbnlcclxuICAgICAgICBhZnRlckhhbmRsZT86IChtZXNzYWdlOiBTUVMuVHlwZXMuTWVzc2FnZSwgZXJyb3I/OiBFcnJvcikgPT4gUHJvbWlzZTxhbnk+O1xyXG4gICAgfSkge1xyXG4gICAgICAgIHRoaXMuX3dvcmtlckluZGV4ID0gcGFyYW1zLndvcmtlckluZGV4O1xyXG4gICAgICAgIHRoaXMuX3dvcmtlckFkZHJlc3MgPSBwYXJhbXMud29ya2VyQWRkcmVzcztcclxuICAgICAgICB0aGlzLl9zcXNDbGllbnQgPSBwYXJhbXMuc3FzQ2xpZW50O1xyXG4gICAgICAgIHRoaXMuX2JlZm9yZUhhbmRsZSA9IHBhcmFtcy5iZWZvcmVIYW5kbGU7XHJcbiAgICAgICAgdGhpcy5faGFuZGxlTWVzc2FnZSA9IHBhcmFtcy5oYW5kbGVNZXNzYWdlO1xyXG4gICAgICAgIHRoaXMuX2FmdGVySGFuZGxlID0gcGFyYW1zLmFmdGVySGFuZGxlO1xyXG4gICAgICAgIHRoaXMuX2lzQ29uc3VtaW5nID0gZmFsc2U7XHJcbiAgICB9XHJcblxyXG4gICAgcHVibGljIGdldCB3b3JrZXJJbmRleCgpOiBudW1iZXIge1xyXG4gICAgICAgIHJldHVybiB0aGlzLl93b3JrZXJJbmRleDtcclxuICAgIH1cclxuXHJcbiAgICBwdWJsaWMgZ2V0IHdvcmtlckFkZHJlc3MoKTogc3RyaW5nIHtcclxuICAgICAgICByZXR1cm4gdGhpcy5fd29ya2VyQWRkcmVzcztcclxuICAgIH1cclxuXHJcbiAgICBwdWJsaWMgc3RvcCgpOiB2b2lkIHtcclxuICAgICAgICB0aGlzLl9pc0NvbnN1bWluZyA9IGZhbHNlO1xyXG4gICAgfVxyXG5cclxuICAgIHB1YmxpYyBhc3luYyBjb25zdW1lQXN5bmMoKTogUHJvbWlzZTx2b2lkPiB7XHJcbiAgICAgICAgaWYgKHRoaXMuX2lzQ29uc3VtaW5nKSB7XHJcbiAgICAgICAgICAgIHJldHVybjtcclxuICAgICAgICB9XHJcblxyXG4gICAgICAgIHRoaXMuX2lzQ29uc3VtaW5nID0gdHJ1ZTtcclxuICAgICAgICB3aGlsZSAodGhpcy5faXNDb25zdW1pbmcpIHtcclxuICAgICAgICAgICAgYXdhaXQgdGhpcy5jb25zdW1lT25jZUFzeW5jKCk7XHJcbiAgICAgICAgfVxyXG4gICAgfVxyXG5cclxuICAgIC8qKlxyXG4gICAgICogRGVjb3JhdGVzIF9jb25zdW1lT25jZUludGVybmFsQXN5bmMgd2l0aCBTZW50cnkgb2JzZXJ2YWJpbGl0eVxyXG4gICAgICovXHJcbiAgICBwdWJsaWMgYXN5bmMgY29uc3VtZU9uY2VBc3luYygpOiBQcm9taXNlPHZvaWQ+IHtcclxuICAgICAgICBsZXQgdHJhbnNhY3Rpb246IFNlbnRyeVRyYW5zYWN0aW9uIHwgdW5kZWZpbmVkO1xyXG4gICAgICAgIGlmIChTRU5UUllfRFNOKSB7XHJcbiAgICAgICAgICAgIHRyYW5zYWN0aW9uID0gU2VudHJ5LnN0YXJ0VHJhbnNhY3Rpb24oe1xyXG4gICAgICAgICAgICAgICAgbmFtZTogJ1dvcmtlciBUcmFuc2FjdGlvbicsXHJcbiAgICAgICAgICAgIH0pO1xyXG4gICAgICAgIH1cclxuXHJcbiAgICAgICAgdHJ5IHtcclxuICAgICAgICAgICAgYXdhaXQgdGhpcy5fY29uc3VtZU9uY2VJbnRlcm5hbEFzeW5jKCk7XHJcbiAgICAgICAgfSBjYXRjaCAoZSkge1xyXG4gICAgICAgICAgICBpZiAoU0VOVFJZX0RTTikge1xyXG4gICAgICAgICAgICAgICAgU2VudHJ5LmNhcHR1cmVFeGNlcHRpb24oZSk7XHJcbiAgICAgICAgICAgIH1cclxuICAgICAgICAgICAgbG9nZ2VyLmVycm9yKFxyXG4gICAgICAgICAgICAgICAgeyBpZDogdGhpcy5fd29ya2VyQWRkcmVzcywgd29ya2VySW5kZXg6IHRoaXMuX3dvcmtlckluZGV4LCBlcnJvck1lc3NhZ2U6IGUubWVzc2FnZSB9LFxyXG4gICAgICAgICAgICAgICAgYEVuY291bnRlcmVkIGVycm9yIHdoZW4gY29uc3VtaW5nIGZyb20gdGhlIHF1ZXVlYCxcclxuICAgICAgICAgICAgKTtcclxuICAgICAgICB9IGZpbmFsbHkge1xyXG4gICAgICAgICAgICBpZiAoU0VOVFJZX0RTTikge1xyXG4gICAgICAgICAgICAgICAgdHJhbnNhY3Rpb24/LmZpbmlzaCgpO1xyXG4gICAgICAgICAgICB9XHJcbiAgICAgICAgfVxyXG4gICAgfVxyXG5cclxuICAgIHByaXZhdGUgYXN5bmMgX2NvbnN1bWVPbmNlSW50ZXJuYWxBc3luYygpOiBQcm9taXNlPHZvaWQ+IHtcclxuICAgICAgICAvLyBSdW4gdGhlIGJlZm9yZSBob29rXHJcbiAgICAgICAgaWYgKHRoaXMuX2JlZm9yZUhhbmRsZSkge1xyXG4gICAgICAgICAgICBsZXQgYmVmb3JlQ2hlY2s7XHJcbiAgICAgICAgICAgIHRyeSB7XHJcbiAgICAgICAgICAgICAgICBiZWZvcmVDaGVjayA9IGF3YWl0IHRoaXMuX2JlZm9yZUhhbmRsZSgpO1xyXG4gICAgICAgICAgICB9IGNhdGNoIChlKSB7XHJcbiAgICAgICAgICAgICAgICBsb2dnZXIuZXJyb3IoXHJcbiAgICAgICAgICAgICAgICAgICAgeyBpZDogdGhpcy5fd29ya2VyQWRkcmVzcywgd29ya2VySW5kZXg6IHRoaXMuX3dvcmtlckluZGV4LCBlcnJvck1lc3NhZ2U6IGUubWVzc2FnZSB9LFxyXG4gICAgICAgICAgICAgICAgICAgICdFcnJvciBlbmNvdW50ZXJlZCBpbiB0aGUgcHJlSGFuZGxlIGNoZWNrJyxcclxuICAgICAgICAgICAgICAgICk7XHJcbiAgICAgICAgICAgICAgICB0aHJvdyBlO1xyXG4gICAgICAgICAgICB9XHJcblxyXG4gICAgICAgICAgICBpZiAoIWJlZm9yZUNoZWNrKSB7XHJcbiAgICAgICAgICAgICAgICBjb25zdCBlcnJvck1lc3NhZ2UgPSAnQmVmb3JlIHZhbGlkYXRpb24gZmFpbGVkJztcclxuICAgICAgICAgICAgICAgIGxvZ2dlci53YXJuKHsgaWQ6IHRoaXMuX3dvcmtlckFkZHJlc3MsIHdvcmtlckluZGV4OiB0aGlzLl93b3JrZXJJbmRleCB9LCBlcnJvck1lc3NhZ2UpO1xyXG4gICAgICAgICAgICAgICAgYXdhaXQgZGVsYXkoT05FX1NFQ09ORF9NUyk7XHJcbiAgICAgICAgICAgICAgICByZXR1cm47XHJcbiAgICAgICAgICAgIH1cclxuICAgICAgICB9XHJcblxyXG4gICAgICAgIC8vIFJlY2VpdmUgbWVzc2FnZVxyXG4gICAgICAgIGNvbnN0IG1lc3NhZ2UgPSBhd2FpdCB0aGlzLl9zcXNDbGllbnQucmVjZWl2ZU1lc3NhZ2VBc3luYygpO1xyXG5cclxuICAgICAgICAvLyBObyBtZXNzYWdlXHJcbiAgICAgICAgaWYgKG1lc3NhZ2UgPT09IG51bGwpIHtcclxuICAgICAgICAgICAgcmV0dXJuO1xyXG4gICAgICAgIH1cclxuXHJcbiAgICAgICAgLy8gSGFuZGxlIG1lc3NhZ2VcclxuICAgICAgICBsZXQgZXJyb3I6IEVycm9yIHwgdW5kZWZpbmVkO1xyXG4gICAgICAgIHRyeSB7XHJcbiAgICAgICAgICAgIGF3YWl0IHRoaXMuX2hhbmRsZU1lc3NhZ2UobWVzc2FnZSk7XHJcbiAgICAgICAgfSBjYXRjaCAoZXJyKSB7XHJcbiAgICAgICAgICAgIGVycm9yID0gZXJyO1xyXG4gICAgICAgICAgICBsb2dnZXIuZXJyb3IoXHJcbiAgICAgICAgICAgICAgICB7IGVycm9yTWVzc2FnZTogZXJyLm1lc3NhZ2UsIG1lc3NhZ2UsIGlkOiB0aGlzLl93b3JrZXJBZGRyZXNzLCB3b3JrZXJJbmRleDogdGhpcy5fd29ya2VySW5kZXggfSxcclxuICAgICAgICAgICAgICAgICdFbmNvdW50ZXJlZCBlcnJvciB3aGlsZSBoYW5kbGluZyBtZXNzYWdlJyxcclxuICAgICAgICAgICAgKTtcclxuXHJcbiAgICAgICAgICAgIGlmIChlcnIgaW5zdGFuY2VvZiBTcXNSZXRyeWFibGVFcnJvcikge1xyXG4gICAgICAgICAgICAgICAgbG9nZ2VyLmluZm8oeyBtZXNzYWdlLCBpZDogdGhpcy5fd29ya2VyQWRkcmVzcywgd29ya2VySW5kZXg6IHRoaXMuX3dvcmtlckluZGV4IH0sICdSZXRyeWluZyBtZXNzYWdlJyk7XHJcbiAgICAgICAgICAgICAgICAvLyBSZXRyeSBtZXNzYWdlXHJcbiAgICAgICAgICAgICAgICAvLyAkZXNsaW50LWZpeC1tZSBodHRwczovL2dpdGh1Yi5jb20vcmhpbm9kYXZpZC9lc2xpbnQtZml4LW1lXHJcbiAgICAgICAgICAgICAgICAvLyBlc2xpbnQtZGlzYWJsZS1uZXh0LWxpbmUgQHR5cGVzY3JpcHQtZXNsaW50L25vLW5vbi1udWxsLWFzc2VydGlvblxyXG4gICAgICAgICAgICAgICAgYXdhaXQgdGhpcy5fc3FzQ2xpZW50LmNoYW5nZU1lc3NhZ2VWaXNpYmlsaXR5QXN5bmMobWVzc2FnZS5SZWNlaXB0SGFuZGxlISwgMCk7XHJcbiAgICAgICAgICAgICAgICBhd2FpdCBkZWxheShPTkVfU0VDT05EX01TKTtcclxuICAgICAgICAgICAgICAgIHRocm93IGVycjtcclxuICAgICAgICAgICAgfVxyXG4gICAgICAgIH1cclxuXHJcbiAgICAgICAgLy8gRGVsZXRlIG1lc3NhZ2VcclxuICAgICAgICAvLyAkZXNsaW50LWZpeC1tZSBodHRwczovL2dpdGh1Yi5jb20vcmhpbm9kYXZpZC9lc2xpbnQtZml4LW1lXHJcbiAgICAgICAgLy8gZXNsaW50LWRpc2FibGUtbmV4dC1saW5lIEB0eXBlc2NyaXB0LWVzbGludC9uby1ub24tbnVsbC1hc3NlcnRpb25cclxuICAgICAgICBhd2FpdCB0aGlzLl9zcXNDbGllbnQuZGVsZXRlTWVzc2FnZUFzeW5jKG1lc3NhZ2UuUmVjZWlwdEhhbmRsZSEpO1xyXG5cclxuICAgICAgICAvLyBSdW4gdGhlIGFmdGVyIGhvb2tcclxuICAgICAgICBpZiAodGhpcy5fYWZ0ZXJIYW5kbGUpIHtcclxuICAgICAgICAgICAgYXdhaXQgdGhpcy5fYWZ0ZXJIYW5kbGUobWVzc2FnZSwgZXJyb3IpO1xyXG4gICAgICAgIH1cclxuXHJcbiAgICAgICAgaWYgKGVycm9yKSB7XHJcbiAgICAgICAgICAgIHRocm93IGVycm9yO1xyXG4gICAgICAgIH1cclxuICAgIH1cclxufVxyXG4iXSwidmVyc2lvbiI6M30=