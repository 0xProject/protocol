{"file":"/Users/davidwalsh/code-local/0x-rfq-api/src/utils/sqs_consumer.ts","mappings":"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","names":[],"sources":["/Users/davidwalsh/code-local/0x-rfq-api/src/utils/sqs_consumer.ts"],"sourcesContent":["// tslint:disable: max-classes-per-file\r\nimport * as Sentry from '@sentry/node';\r\nimport { Transaction as SentryTransaction } from '@sentry/types';\r\nimport { SQS } from 'aws-sdk';\r\nimport delay from 'delay';\r\n\r\nimport { SENTRY_DSN } from '../config';\r\nimport { ONE_SECOND_MS } from '../core/constants';\r\nimport { logger } from '../logger';\r\n\r\nimport { SqsClient } from './sqs_client';\r\n\r\n// $eslint-fix-me https://github.com/rhinodavid/eslint-fix-me\r\n// eslint-disable-next-line @typescript-eslint/no-explicit-any\r\nexport type MessageHandler = (message: SQS.Types.Message) => Promise<any>;\r\n\r\nexport class SqsRetryableError extends Error {}\r\nexport class SqsConsumer {\r\n    private readonly _workerIndex: number;\r\n    private readonly _workerAddress: string;\r\n    private readonly _sqsClient: SqsClient;\r\n    private readonly _beforeHandle?: () => Promise<boolean>;\r\n    private readonly _handleMessage: MessageHandler;\r\n    // $eslint-fix-me https://github.com/rhinodavid/eslint-fix-me\r\n    // eslint-disable-next-line @typescript-eslint/no-explicit-any\r\n    private readonly _afterHandle?: (message: SQS.Types.Message, error?: Error) => Promise<any>;\r\n    private _isConsuming: boolean;\r\n\r\n    constructor(params: {\r\n        workerIndex: number;\r\n        workerAddress: string;\r\n        sqsClient: SqsClient;\r\n        beforeHandle?: () => Promise<boolean>;\r\n        handleMessage: MessageHandler;\r\n        // $eslint-fix-me https://github.com/rhinodavid/eslint-fix-me\r\n        // eslint-disable-next-line @typescript-eslint/no-explicit-any\r\n        afterHandle?: (message: SQS.Types.Message, error?: Error) => Promise<any>;\r\n    }) {\r\n        this._workerIndex = params.workerIndex;\r\n        this._workerAddress = params.workerAddress;\r\n        this._sqsClient = params.sqsClient;\r\n        this._beforeHandle = params.beforeHandle;\r\n        this._handleMessage = params.handleMessage;\r\n        this._afterHandle = params.afterHandle;\r\n        this._isConsuming = false;\r\n    }\r\n\r\n    public get workerIndex(): number {\r\n        return this._workerIndex;\r\n    }\r\n\r\n    public get workerAddress(): string {\r\n        return this._workerAddress;\r\n    }\r\n\r\n    public stop(): void {\r\n        this._isConsuming = false;\r\n    }\r\n\r\n    public async consumeAsync(): Promise<void> {\r\n        if (this._isConsuming) {\r\n            return;\r\n        }\r\n\r\n        this._isConsuming = true;\r\n        while (this._isConsuming) {\r\n            await this.consumeOnceAsync();\r\n        }\r\n    }\r\n\r\n    /**\r\n     * Decorates _consumeOnceInternalAsync with Sentry observability\r\n     */\r\n    public async consumeOnceAsync(): Promise<void> {\r\n        let transaction: SentryTransaction | undefined;\r\n        if (SENTRY_DSN) {\r\n            transaction = Sentry.startTransaction({\r\n                name: 'Worker Transaction',\r\n            });\r\n        }\r\n\r\n        try {\r\n            await this._consumeOnceInternalAsync();\r\n        } catch (e) {\r\n            if (SENTRY_DSN) {\r\n                Sentry.captureException(e);\r\n            }\r\n            logger.error(\r\n                { id: this._workerAddress, workerIndex: this._workerIndex, errorMessage: e.message },\r\n                `Encountered error when consuming from the queue`,\r\n            );\r\n        } finally {\r\n            if (SENTRY_DSN) {\r\n                transaction?.finish();\r\n            }\r\n        }\r\n    }\r\n\r\n    private async _consumeOnceInternalAsync(): Promise<void> {\r\n        // Run the before hook\r\n        if (this._beforeHandle) {\r\n            let beforeCheck;\r\n            try {\r\n                beforeCheck = await this._beforeHandle();\r\n            } catch (e) {\r\n                logger.error(\r\n                    { id: this._workerAddress, workerIndex: this._workerIndex, errorMessage: e.message },\r\n                    'Error encountered in the preHandle check',\r\n                );\r\n                throw e;\r\n            }\r\n\r\n            if (!beforeCheck) {\r\n                const errorMessage = 'Before validation failed';\r\n                logger.warn({ id: this._workerAddress, workerIndex: this._workerIndex }, errorMessage);\r\n                await delay(ONE_SECOND_MS);\r\n                return;\r\n            }\r\n        }\r\n\r\n        // Receive message\r\n        const message = await this._sqsClient.receiveMessageAsync();\r\n\r\n        // No message\r\n        if (message === null) {\r\n            return;\r\n        }\r\n\r\n        // Handle message\r\n        let error: Error | undefined;\r\n        try {\r\n            await this._handleMessage(message);\r\n        } catch (err) {\r\n            error = err;\r\n            logger.error(\r\n                { errorMessage: err.message, message, id: this._workerAddress, workerIndex: this._workerIndex },\r\n                'Encountered error while handling message',\r\n            );\r\n\r\n            if (err instanceof SqsRetryableError) {\r\n                logger.info({ message, id: this._workerAddress, workerIndex: this._workerIndex }, 'Retrying message');\r\n                // Retry message\r\n                // $eslint-fix-me https://github.com/rhinodavid/eslint-fix-me\r\n                // eslint-disable-next-line @typescript-eslint/no-non-null-assertion\r\n                await this._sqsClient.changeMessageVisibilityAsync(message.ReceiptHandle!, 0);\r\n                await delay(ONE_SECOND_MS);\r\n                throw err;\r\n            }\r\n        }\r\n\r\n        // Delete message\r\n        // $eslint-fix-me https://github.com/rhinodavid/eslint-fix-me\r\n        // eslint-disable-next-line @typescript-eslint/no-non-null-assertion\r\n        await this._sqsClient.deleteMessageAsync(message.ReceiptHandle!);\r\n\r\n        // Run the after hook\r\n        if (this._afterHandle) {\r\n            await this._afterHandle(message, error);\r\n        }\r\n\r\n        if (error) {\r\n            throw error;\r\n        }\r\n    }\r\n}\r\n"],"version":3}