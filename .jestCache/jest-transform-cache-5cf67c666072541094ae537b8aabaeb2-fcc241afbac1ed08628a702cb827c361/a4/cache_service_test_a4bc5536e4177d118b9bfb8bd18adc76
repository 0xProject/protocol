fd7ec81d4a64f1760a04a23070af8b7a
"use strict";
Object.defineProperty(exports, "__esModule", { value: true });
const contract_addresses_1 = require("@0x/contract-addresses");
const utils_1 = require("@0x/utils");
const chai_1 = require("chai");
const ioredis_1 = require("ioredis");
const constants_1 = require("../../src/core/constants");
const cache_client_1 = require("../../src/utils/cache_client");
const deployment_1 = require("../test_utils/deployment");
jest.setTimeout(constants_1.ONE_MINUTE_MS * 2);
let teardownDependencies;
describe('CacheClient', () => {
    let redis;
    let cacheClient;
    const chainId = contract_addresses_1.ChainId.Ganache;
    const makerA = '0x1111111111111111111111111111111111111111';
    const makerB = '0x2222222222222222222222222222222222222222';
    const makerC = '0x3333333333333333333333333333333333333333';
    const tokenA = '0xC02aaA39b223FE8D0A0e5C4F27eAD9083C756Cc2';
    const tokenB = '0x6B175474E89094C44Da98b954EedeAC495271d0F';
    const tokenC = '0xdAC17F958D2ee523a2206206994597C13D831ec7';
    // compareFn is used to determine the order of ERC20Owner elements
    const compareFn = (a, b) => a.owner.localeCompare(b.owner);
    beforeAll(async () => {
        teardownDependencies = await (0, deployment_1.setupDependenciesAsync)(['redis']);
        redis = new ioredis_1.default();
        cacheClient = new cache_client_1.CacheClient(redis);
    });
    afterAll(async () => {
        await cacheClient.closeAsync();
        if (!teardownDependencies()) {
            throw new Error('Failed to tear down dependencies');
        }
    });
    afterEach(async () => {
        await redis.flushdb();
    });
    describe('addERC20OwnerAsync', () => {
        it('adds pending address to observed addresses without error', async () => {
            (0, chai_1.expect)(cacheClient.addERC20OwnerAsync(chainId, { owner: makerA, token: tokenA })).to.eventually.be.equal(void 0);
        });
    });
    describe('getERC20OwnersAsync', () => {
        const addresses = [
            { owner: makerA, token: tokenA },
            { owner: makerB, token: tokenB },
            { owner: makerC, token: tokenC },
        ];
        it('fetches maker token addresses in correct format', async () => {
            addresses.forEach(async (address) => {
                await cacheClient.addERC20OwnerAsync(chainId, address);
            });
            const cachedAddresses = await cacheClient.getERC20OwnersAsync(chainId);
            (0, chai_1.expect)(cachedAddresses.sort(compareFn)).to.deep.eq(addresses.sort(compareFn));
        });
        it('fetches empty arrays if no addresses are found in the set', async () => {
            (0, chai_1.expect)(await cacheClient.getERC20OwnersAsync(chainId)).to.deep.eq([]);
        });
    });
    describe('setERC20OwnerBalancesAsync', () => {
        const addresses = [
            { owner: makerA, token: tokenA },
            { owner: makerB, token: tokenB },
            { owner: makerC, token: tokenC },
        ];
        const balances = [new utils_1.BigNumber(1), new utils_1.BigNumber(2), new utils_1.BigNumber(3)];
        it('sets balances in the cache without error', async () => {
            (0, chai_1.expect)(cacheClient.setERC20OwnerBalancesAsync(chainId, addresses, balances)).to.eventually.be.equal(void 0);
        });
        it('should fail when addresses do not match balances', async () => {
            (0, chai_1.expect)(cacheClient.setERC20OwnerBalancesAsync(chainId, addresses, balances.slice(0, -1))).to.be.rejectedWith('balances');
        });
        it('should not fail when addresses are empty', async () => {
            (0, chai_1.expect)(cacheClient.setERC20OwnerBalancesAsync(chainId, [], [])).to.eventually.be.equal(void 0);
        });
    });
    describe('getERC20OwnerBalancesAsync', () => {
        const addresses = [
            { owner: makerA, token: tokenA },
            { owner: makerB, token: tokenB },
            { owner: makerC, token: tokenC },
        ];
        const balances = [new utils_1.BigNumber(1), new utils_1.BigNumber(2), new utils_1.BigNumber(3)];
        beforeEach(async () => {
            await cacheClient.setERC20OwnerBalancesAsync(chainId, addresses, balances);
        });
        it('fetches correct balances from the cache', async () => {
            (0, chai_1.expect)(await cacheClient.getERC20OwnerBalancesAsync(chainId, addresses)).to.deep.eq([
                new utils_1.BigNumber(1),
                new utils_1.BigNumber(2),
                new utils_1.BigNumber(3),
            ]);
        });
        it('returns null balances if addresses are not in the cache', async () => {
            const badAddresses = [
                { owner: makerA, token: tokenA },
                { owner: makerB, token: tokenB },
                { owner: '0x0000000000000000000000000000000000000000', token: tokenC },
            ];
            (0, chai_1.expect)(await cacheClient.getERC20OwnerBalancesAsync(chainId, badAddresses)).to.deep.eq([
                new utils_1.BigNumber(1),
                new utils_1.BigNumber(2),
                null,
            ]);
        });
        it('returns null balances if addresses from a different chain are supplied', async () => {
            (0, chai_1.expect)(await cacheClient.getERC20OwnerBalancesAsync(contract_addresses_1.ChainId.PolygonMumbai, addresses)).to.deep.eq([
                null,
                null,
                null,
            ]);
        });
        it('returns an empty array if addresses are empty', async () => {
            (0, chai_1.expect)(await cacheClient.getERC20OwnerBalancesAsync(chainId, [])).to.deep.eq([]);
        });
    });
    describe('evictZeroBalancesAsync', () => {
        const addresses = [
            { owner: makerA, token: tokenA },
            { owner: makerB, token: tokenB },
            { owner: makerC, token: tokenC },
        ];
        it('evicts zeroed entries from the cache', async () => {
            addresses.forEach(async (address) => {
                await cacheClient.addERC20OwnerAsync(chainId, address);
            });
            let cachedAddresses = await cacheClient.getERC20OwnersAsync(chainId);
            (0, chai_1.expect)(cachedAddresses.sort(compareFn)).to.deep.eq(addresses.sort(compareFn));
            const balances = [new utils_1.BigNumber(1), new utils_1.BigNumber(2), new utils_1.BigNumber(0)];
            await cacheClient.setERC20OwnerBalancesAsync(chainId, addresses, balances);
            const numEvicted = await cacheClient.evictZeroBalancesAsync(chainId);
            (0, chai_1.expect)(numEvicted).to.eq(1);
            cachedAddresses = await cacheClient.getERC20OwnersAsync(chainId);
            (0, chai_1.expect)(cachedAddresses.sort(compareFn)).to.deep.eq(addresses.slice(0, 2).sort(compareFn));
        });
        it('does not evict any entries if there are no stale balances', async () => {
            addresses.forEach(async (address) => {
                await cacheClient.addERC20OwnerAsync(chainId, address);
            });
            let cachedAddresses = await cacheClient.getERC20OwnersAsync(chainId);
            (0, chai_1.expect)(cachedAddresses.sort(compareFn)).to.deep.eq(addresses.sort(compareFn));
            const balances = [new utils_1.BigNumber(1), new utils_1.BigNumber(2), new utils_1.BigNumber(3)];
            await cacheClient.setERC20OwnerBalancesAsync(chainId, addresses, balances);
            const numEvicted = await cacheClient.evictZeroBalancesAsync(chainId);
            (0, chai_1.expect)(numEvicted).to.eq(0);
            cachedAddresses = await cacheClient.getERC20OwnersAsync(chainId);
            (0, chai_1.expect)(cachedAddresses.sort(compareFn)).to.deep.eq(addresses.sort(compareFn));
        });
        it('does not error if the address set is empty', async () => {
            (0, chai_1.expect)(await cacheClient.getERC20OwnersAsync(chainId)).to.have.length(0);
            const numEvicted = await cacheClient.evictZeroBalancesAsync(chainId);
            (0, chai_1.expect)(numEvicted).to.eq(0);
        });
    });
    describe('coolDownMakerForPair', () => {
        const makerId1 = 'makerId1';
        const takerToken = 'takerToken';
        const makerToken = 'makerToken';
        it('should add new makers to the cooling down set for a pair', async () => {
            const isUpdated = await cacheClient.addMakerToCooldownAsync(makerId1, Date.now(), chainId, takerToken, makerToken);
            (0, chai_1.expect)(isUpdated).to.eq(true);
        });
        it('should update endTime to a time later than existing endTime', async () => {
            const now = Date.now();
            const oneMinuteLater = now + constants_1.ONE_MINUTE_MS;
            await cacheClient.addMakerToCooldownAsync(makerId1, now, chainId, takerToken, makerToken);
            const isUpdated = await cacheClient.addMakerToCooldownAsync(makerId1, oneMinuteLater, chainId, makerToken, takerToken);
            (0, chai_1.expect)(isUpdated).to.eq(true);
        });
        it('should not update endTime to a time earlier than existing endTime', async () => {
            const now = Date.now();
            const oneMinuteEarlier = now - constants_1.ONE_MINUTE_MS;
            await cacheClient.addMakerToCooldownAsync(makerId1, now, chainId, takerToken, makerToken);
            const isUpdated = await cacheClient.addMakerToCooldownAsync(makerId1, oneMinuteEarlier, chainId, takerToken, makerToken);
            (0, chai_1.expect)(isUpdated).to.eq(false);
        });
    });
    describe('getCoolingDownMakersForPair', () => {
        const makerId1 = 'makerId1';
        const makerId2 = 'makerId2';
        const takerToken = 'takerToken';
        const otherTakerToken = 'otherTakerToken';
        const makerToken = 'makerToken';
        it('should get all makers that are cooling down', async () => {
            const now = Date.now();
            const oneMinuteLater = now + constants_1.ONE_MINUTE_MS;
            await cacheClient.addMakerToCooldownAsync(makerId1, oneMinuteLater, chainId, takerToken, makerToken);
            await cacheClient.addMakerToCooldownAsync(makerId2, oneMinuteLater, chainId, takerToken, makerToken);
            const result = await cacheClient.getMakersInCooldownForPairAsync(chainId, takerToken, makerToken, now);
            (0, chai_1.expect)(result).to.deep.eq([makerId1, makerId2]);
        });
        it('should not include makers whose cooling down periods already ended', async () => {
            const now = Date.now();
            const oneMinuteEarlier = now - constants_1.ONE_MINUTE_MS;
            const oneMinuteLater = now + constants_1.ONE_MINUTE_MS;
            await cacheClient.addMakerToCooldownAsync(makerId1, oneMinuteEarlier, chainId, takerToken, makerToken);
            await cacheClient.addMakerToCooldownAsync(makerId2, oneMinuteLater, chainId, takerToken, makerToken);
            const result = await cacheClient.getMakersInCooldownForPairAsync(chainId, takerToken, makerToken, now);
            (0, chai_1.expect)(result).to.deep.eq([makerId2]);
        });
        it('should only include makers that are cooling down for this pair', async () => {
            const now = Date.now();
            const oneMinuteLater = now + constants_1.ONE_MINUTE_MS;
            await cacheClient.addMakerToCooldownAsync(makerId1, oneMinuteLater, chainId, takerToken, makerToken);
            await cacheClient.addMakerToCooldownAsync(makerId2, oneMinuteLater, chainId, otherTakerToken, makerToken);
            const result = await cacheClient.getMakersInCooldownForPairAsync(chainId, takerToken, makerToken, now);
            (0, chai_1.expect)(result).to.deep.eq([makerId1]);
        });
    });
});
//# sourceMappingURL=data:application/json;charset=utf-8;base64,eyJmaWxlIjoiL1VzZXJzL2Rhdmlkd2Fsc2gvY29kZS1sb2NhbC8weC1yZnEtYXBpL3Rlc3QvdXRpbHMvY2FjaGVfc2VydmljZV90ZXN0LnRzIiwibWFwcGluZ3MiOiI7O0FBQUEsK0RBQWlEO0FBQ2pELHFDQUFzQztBQUN0QywrQkFBOEI7QUFDOUIscUNBQTRCO0FBRTVCLHdEQUF5RDtBQUV6RCwrREFBMkQ7QUFDM0QseURBQXNHO0FBRXRHLElBQUksQ0FBQyxVQUFVLENBQUMseUJBQWEsR0FBRyxDQUFDLENBQUMsQ0FBQztBQUNuQyxJQUFJLG9CQUF3RCxDQUFDO0FBRTdELFFBQVEsQ0FBQyxhQUFhLEVBQUUsR0FBRyxFQUFFO0lBQ3pCLElBQUksS0FBWSxDQUFDO0lBQ2pCLElBQUksV0FBd0IsQ0FBQztJQUU3QixNQUFNLE9BQU8sR0FBRyw0QkFBTyxDQUFDLE9BQU8sQ0FBQztJQUVoQyxNQUFNLE1BQU0sR0FBRyw0Q0FBNEMsQ0FBQztJQUM1RCxNQUFNLE1BQU0sR0FBRyw0Q0FBNEMsQ0FBQztJQUM1RCxNQUFNLE1BQU0sR0FBRyw0Q0FBNEMsQ0FBQztJQUU1RCxNQUFNLE1BQU0sR0FBRyw0Q0FBNEMsQ0FBQztJQUM1RCxNQUFNLE1BQU0sR0FBRyw0Q0FBNEMsQ0FBQztJQUM1RCxNQUFNLE1BQU0sR0FBRyw0Q0FBNEMsQ0FBQztJQUU1RCxrRUFBa0U7SUFDbEUsTUFBTSxTQUFTLEdBQUcsQ0FBQyxDQUFhLEVBQUUsQ0FBYSxFQUFFLEVBQUUsQ0FBQyxDQUFDLENBQUMsS0FBSyxDQUFDLGFBQWEsQ0FBQyxDQUFDLENBQUMsS0FBSyxDQUFDLENBQUM7SUFFbkYsU0FBUyxDQUFDLEtBQUssSUFBSSxFQUFFO1FBQ2pCLG9CQUFvQixHQUFHLE1BQU0sSUFBQSxtQ0FBc0IsRUFBQyxDQUFDLE9BQU8sQ0FBQyxDQUFDLENBQUM7UUFDL0QsS0FBSyxHQUFHLElBQUksaUJBQUssRUFBRSxDQUFDO1FBQ3BCLFdBQVcsR0FBRyxJQUFJLDBCQUFXLENBQUMsS0FBSyxDQUFDLENBQUM7SUFDekMsQ0FBQyxDQUFD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LGNBQWMsR0FBRyxHQUFHLEdBQUcseUJBQWEsQ0FBQztZQUMzQyxNQUFNLFdBQVcsQ0FBQyx1QkFBdUIsQ0FBQyxRQUFRLEVBQUUsY0FBYyxFQUFFLE9BQU8sRUFBRSxVQUFVLEVBQUUsVUFBVSxDQUFDLENBQUM7WUFDckcsTUFBTSxXQUFXLENBQUMsdUJBQXVCLENBQUMsUUFBUSxFQUFFLGNBQWMsRUFBRSxPQUFPLEVBQUUsZUFBZSxFQUFFLFVBQVUsQ0FBQyxDQUFDO1lBQzFHLE1BQU0sTUFBTSxHQUFHLE1BQU0sV0FBVyxDQUFDLCtCQUErQixDQUFDLE9BQU8sRUFBRSxVQUFVLEVBQUUsVUFBVSxFQUFFLEdBQUcsQ0FBQyxDQUFDO1lBQ3ZHLElBQUEsYUFBTSxFQUFDLE1BQU0sQ0FBQyxDQUFDLEVBQUUsQ0FBQyxJQUFJLENBQUMsRUFBRSxDQUFDLENBQUMsUUFBUSxDQUFDLENBQUMsQ0FBQztRQUMxQyxDQUFDLENBQUMsQ0FBQztJQUNQLENBQUMsQ0FBQyxDQUFDO0FBQ1AsQ0FBQyxDQUFDLENBQUMiLCJuYW1lcyI6W10sInNvdXJjZXMiOlsiL1VzZXJzL2Rhdmlkd2Fsc2gvY29kZS1sb2NhbC8weC1yZnEtYXBpL3Rlc3QvdXRpbHMvY2FjaGVfc2VydmljZV90ZXN0LnRzIl0sInNvdXJjZXNDb250ZW50IjpbImltcG9ydCB7IENoYWluSWQgfSBmcm9tICdAMHgvY29udHJhY3QtYWRkcmVzc2VzJztcbmltcG9ydCB7IEJpZ051bWJlciB9IGZyb20gJ0AweC91dGlscyc7XG5pbXBvcnQgeyBleHBlY3QgfSBmcm9tICdjaGFpJztcbmltcG9ydCBSZWRpcyBmcm9tICdpb3JlZGlzJztcblxuaW1wb3J0IHsgT05FX01JTlVURV9NUyB9IGZyb20gJy4uLy4uL3NyYy9jb3JlL2NvbnN0YW50cyc7XG5pbXBvcnQgeyBFUkMyME93bmVyIH0gZnJvbSAnLi4vLi4vc3JjL2NvcmUvdHlwZXMnO1xuaW1wb3J0IHsgQ2FjaGVDbGllbnQgfSBmcm9tICcuLi8uLi9zcmMvdXRpbHMvY2FjaGVfY2xpZW50JztcbmltcG9ydCB7IHNldHVwRGVwZW5kZW5jaWVzQXN5bmMsIFRlYXJkb3duRGVwZW5kZW5jaWVzRnVuY3Rpb25IYW5kbGUgfSBmcm9tICcuLi90ZXN0X3V0aWxzL2RlcGxveW1lbnQnO1xuXG5qZXN0LnNldFRpbWVvdXQoT05FX01JTlVURV9NUyAqIDIpO1xubGV0IHRlYXJkb3duRGVwZW5kZW5jaWVzOiBUZWFyZG93bkRlcGVuZGVuY2llc0Z1bmN0aW9uSGFuZGxlO1xuXG5kZXNjcmliZSgnQ2FjaGVDbGllbnQnLCAoKSA9PiB7XG4gICAgbGV0IHJlZGlzOiBSZWRpcztcbiAgICBsZXQgY2FjaGVDbGllbnQ6IENhY2hlQ2xpZW50O1xuXG4gICAgY29uc3QgY2hhaW5JZCA9IENoYWluSWQuR2FuYWNoZTtcblxuICAgIGNvbnN0IG1ha2VyQSA9ICcweDExMTExMTExMTExMTExMTExMTExMTExMTExMTExMTExMTExMTExMTEnO1xuICAgIGNvbnN0IG1ha2VyQiA9ICcweDIyMjIyMjIyMjIyMjIyMjIyMjIyMjIyMjIyMjIyMjIyMjIyMjIyMjInO1xuICAgIGNvbnN0IG1ha2VyQyA9ICcweDMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMnO1xuXG4gICAgY29uc3QgdG9rZW5BID0gJzB4QzAyYWFBMzliMjIzRkU4RDBBMGU1QzRGMjdlQUQ5MDgzQzc1NkNjMic7XG4gICAgY29uc3QgdG9rZW5CID0gJzB4NkIxNzU0NzRFODkwOTRDNDREYTk4Yjk1NEVlZGVBQzQ5NTI3MWQwRic7XG4gICAgY29uc3QgdG9rZW5DID0gJzB4ZEFDMTdGOTU4RDJlZTUyM2EyMjA2MjA2OTk0NTk3QzEzRDgzMWVjNyc7XG5cbiAgICAvLyBjb21wYXJlRm4gaXMgdXNlZCB0byBkZXRlcm1pbmUgdGhlIG9yZGVyIG9mIEVSQzIwT3duZXIgZWxlbWVudHNcbiAgICBjb25zdCBjb21wYXJlRm4gPSAoYTogRVJDMjBPd25lciwgYjogRVJDMjBPd25lcikgPT4gYS5vd25lci5sb2NhbGVDb21wYXJlKGIub3duZXIpO1xuXG4gICAgYmVmb3JlQWxsKGFzeW5jICgpID0+IHtcbiAgICAgICAgdGVhcmRvd25EZXBlbmRlbmNpZXMgPSBhd2FpdCBzZXR1cERlcGVuZGVuY2llc0FzeW5jKFsncmVkaXMnXSk7XG4gICAgICAgIHJlZGlzID0gbmV3IFJlZGlzKCk7XG4gICAgICAgIGNhY2hlQ2xpZW50ID0gbmV3IENhY2hlQ2xpZW50KHJlZGlzKTtcbiAgICB9KTtcblxuICAgIGFmdGVyQWxsKGFzeW5jICgpID0+IHtcbiAgICAgICAgYXdhaXQgY2FjaGVDbGllbnQuY2xvc2VBc3luYygpO1xuICAgICAgICBpZiAoIXRlYXJkb3duRGVwZW5kZW5jaWVzKCkpIHtcbiAgICAgICAgICAgIHRocm93IG5ldyBFcnJvcignRmFpbGVkIHRvIHRlYXIgZG93biBkZXBlbmRlbmNpZXMnKTtcbiAgICAgICAgfVxuICAgIH0pO1xuXG4gICAgYWZ0ZXJFYWNoKGFzeW5jICgpID0+IHtcbiAgICAgICAgYXdhaXQgcmVkaXMuZmx1c2hkYigpO1xuICAgIH0pO1xuXG4gICAgZGVzY3JpYmUoJ2FkZEVSQzIwT3duZXJBc3luYycsICgpID0+IHtcbiAgICAgICAgaXQoJ2FkZHMgcGVuZGluZyBhZGRyZXNzIHRvIG9ic2VydmVkIGFkZHJlc3NlcyB3aXRob3V0IGVycm9yJywgYXN5bmMgKCkgPT4ge1xuICAgICAgICAgICAgZXhwZWN0KGNhY2hlQ2xpZW50LmFkZEVSQzIwT3duZXJBc3luYyhjaGFpbklkLCB7IG93bmVyOiBtYWtlckEsIHRva2VuOiB0b2tlbkEgfSkpLnRvLmV2ZW50dWFsbHkuYmUuZXF1YWwoXG4gICAgICAgICAgICAgICAgdm9pZCAwLFxuICAgICAgICAgICAgKTtcbiAgICAgICAgfSk7XG4gICAgfSk7XG5cbiAgICBkZXNjcmliZSgnZ2V0RVJDMjBPd25lcnNBc3luYycsICgpID0+IHtcbiAgICAgICAgY29uc3QgYWRkcmVzc2VzID0gW1xuICAgICAgICAgICAgeyBvd25lcjogbWFrZXJBLCB0b2tlbjogdG9rZW5BIH0sXG4gICAgICAgICAgICB7IG93bmVyOiBtYWtlckIsIHRva2VuOiB0b2tlbkIgfSxcbiAgICAgICAgICAgIHsgb3duZXI6IG1ha2VyQywgdG9rZW46IHRva2VuQyB9LFxuICAgICAgICBdO1xuXG4gICAgICAgIGl0KCdmZXRjaGVzIG1ha2VyIHRva2VuIGFkZHJlc3NlcyBpbiBjb3JyZWN0IGZvcm1hdCcsIGFzeW5jICgpID0+IHtcbiAgICAgICAgICAgIGFkZHJlc3Nlcy5mb3JFYWNoKGFzeW5jIChhZGRyZXNzKSA9PiB7XG4gICAgICAgICAgICAgICAgYXdhaXQgY2FjaGVDbGllbnQuYWRkRVJDMjBPd25lckFzeW5jKGNoYWluSWQsIGFkZHJlc3MpO1xuICAgICAgICAgICAgfSk7XG4gICAgICAgICAgICBjb25zdCBjYWNoZWRBZGRyZXNzZXMgPSBhd2FpdCBjYWNoZUNsaWVudC5nZXRFUkMyME93bmVyc0FzeW5jKGNoYWluSWQpO1xuICAgICAgICAgICAgZXhwZWN0KGNhY2hlZEFkZHJlc3Nlcy5zb3J0KGNvbXBhcmVGbikpLnRvLmRlZXAuZXEoYWRkcmVzc2VzLnNvcnQoY29tcGFyZUZuKSk7XG4gICAgICAgIH0pO1xuXG4gICAgICAgIGl0KCdmZXRjaGVzIGVtcHR5IGFycmF5cyBpZiBubyBhZGRyZXNzZXMgYXJlIGZvdW5kIGluIHRoZSBzZXQnLCBhc3luYyAoKSA9PiB7XG4gICAgICAgICAgICBleHBlY3QoYXdhaXQgY2FjaGVDbGllbnQuZ2V0RVJDMjBPd25lcnNBc3luYyhjaGFpbklkKSkudG8uZGVlcC5lcShbXSk7XG4gICAgICAgIH0pO1xuICAgIH0pO1xuXG4gICAgZGVzY3JpYmUoJ3NldEVSQzIwT3duZXJCYWxhbmNlc0FzeW5jJywgKCkgPT4ge1xuICAgICAgICBjb25zdCBhZGRyZXNzZXMgPSBbXG4gICAgICAgICAgICB7IG93bmVyOiBtYWtlckEsIHRva2VuOiB0b2tlbkEgfSxcbiAgICAgICAgICAgIHsgb3duZXI6IG1ha2VyQiwgdG9rZW46IHRva2VuQiB9LFxuICAgICAgICAgICAgeyBvd25lcjogbWFrZXJDLCB0b2tlbjogdG9rZW5DIH0sXG4gICAgICAgIF07XG4gICAgICAgIGNvbnN0IGJhbGFuY2VzID0gW25ldyBCaWdOdW1iZXIoMSksIG5ldyBCaWdOdW1iZXIoMiksIG5ldyBCaWdOdW1iZXIoMyldO1xuXG4gICAgICAgIGl0KCdzZXRzIGJhbGFuY2VzIGluIHRoZSBjYWNoZSB3aXRob3V0IGVycm9yJywgYXN5bmMgKCkgPT4ge1xuICAgICAgICAgICAgZXhwZWN0KGNhY2hlQ2xpZW50LnNldEVSQzIwT3duZXJCYWxhbmNlc0FzeW5jKGNoYWluSWQsIGFkZHJlc3NlcywgYmFsYW5jZXMpKS50by5ldmVudHVhbGx5LmJlLmVxdWFsKHZvaWQgMCk7XG4gICAgICAgIH0pO1xuXG4gICAgICAgIGl0KCdzaG91bGQgZmFpbCB3aGVuIGFkZHJlc3NlcyBkbyBub3QgbWF0Y2ggYmFsYW5jZXMnLCBhc3luYyAoKSA9PiB7XG4gICAgICAgICAgICBleHBlY3QoXG4gICAgICAgICAgICAgICAgY2FjaGVDbGllbnQuc2V0RVJDMjBPd25lckJhbGFuY2VzQXN5bmMoY2hhaW5JZCwgYWRkcmVzc2VzLCBiYWxhbmNlcy5zbGljZSgwLCAtMSkpLFxuICAgICAgICAgICAgKS50by5iZS5yZWplY3RlZFdpdGgoJ2JhbGFuY2VzJyk7XG4gICAgICAgIH0pO1xuXG4gICAgICAgIGl0KCdzaG91bGQgbm90IGZhaWwgd2hlbiBhZGRyZXNzZXMgYXJlIGVtcHR5JywgYXN5bmMgKCkgPT4ge1xuICAgICAgICAgICAgZXhwZWN0KGNhY2hlQ2xpZW50LnNldEVSQzIwT3duZXJCYWxhbmNlc0FzeW5jKGNoYWluSWQsIFtdLCBbXSkpLnRvLmV2ZW50dWFsbHkuYmUuZXF1YWwodm9pZCAwKTtcbiAgICAgICAgfSk7XG4gICAgfSk7XG5cbiAgICBkZXNjcmliZSgnZ2V0RVJDMjBPd25lckJhbGFuY2VzQXN5bmMnLCAoKSA9PiB7XG4gICAgICAgIGNvbnN0IGFkZHJlc3NlcyA9IFtcbiAgICAgICAgICAgIHsgb3duZXI6IG1ha2VyQSwgdG9rZW46IHRva2VuQSB9LFxuICAgICAgICAgICAgeyBvd25lcjogbWFrZXJCLCB0b2tlbjogdG9rZW5CIH0sXG4gICAgICAgICAgICB7IG93bmVyOiBtYWtlckMsIHRva2VuOiB0b2tlbkMgfSxcbiAgICAgICAgXTtcbiAgICAgICAgY29uc3QgYmFsYW5jZXMgPSBbbmV3IEJpZ051bWJlcigxKSwgbmV3IEJpZ051bWJlcigyKSwgbmV3IEJpZ051bWJlcigzKV07XG5cbiAgICAgICAgYmVmb3JlRWFjaChhc3luYyAoKSA9PiB7XG4gICAgICAgICAgICBhd2FpdCBjYWNoZUNsaWVudC5zZXRFUkMyME93bmVyQmFsYW5jZXNBc3luYyhjaGFpbklkLCBhZGRyZXNzZXMsIGJhbGFuY2VzKTtcbiAgICAgICAgfSk7XG5cbiAgICAgICAgaXQoJ2ZldGNoZXMgY29ycmVjdCBiYWxhbmNlcyBmcm9tIHRoZSBjYWNoZScsIGFzeW5jICgpID0+IHtcbiAgICAgICAgICAgIGV4cGVjdChhd2FpdCBjYWNoZUNsaWVudC5nZXRFUkMyME93bmVyQmFsYW5jZXNBc3luYyhjaGFpbklkLCBhZGRyZXNzZXMpKS50by5kZWVwLmVxKFtcbiAgICAgICAgICAgICAgICBuZXcgQmlnTnVtYmVyKDEpLFxuICAgICAgICAgICAgICAgIG5ldyBCaWdOdW1iZXIoMiksXG4gICAgICAgICAgICAgICAgbmV3IEJpZ051bWJlcigzKSxcbiAgICAgICAgICAgIF0pO1xuICAgICAgICB9KTtcblxuICAgICAgICBpdCgncmV0dXJucyBudWxsIGJhbGFuY2VzIGlmIGFkZHJlc3NlcyBhcmUgbm90IGluIHRoZSBjYWNoZScsIGFzeW5jICgpID0+IHtcbiAgICAgICAgICAgIGNvbnN0IGJhZEFkZHJlc3NlcyA9IFtcbiAgICAgICAgICAgICAgICB7IG93bmVyOiBtYWtlckEsIHRva2VuOiB0b2tlbkEgfSxcbiAgICAgICAgICAgICAgICB7IG93bmVyOiBtYWtlckIsIHRva2VuOiB0b2tlbkIgfSxcbiAgICAgICAgICAgICAgICB7IG93bmVyOiAnMHgwMDAwMDAwMDAwMDAwMDAwMDAwMDAwMDAwMDAwMDAwMDAwMDAwMDAwJywgdG9rZW46IHRva2VuQyB9LFxuICAgICAgICAgICAgXTtcbiAgICAgICAgICAgIGV4cGVjdChhd2FpdCBjYWNoZUNsaWVudC5nZXRFUkMyME93bmVyQmFsYW5jZXNBc3luYyhjaGFpbklkLCBiYWRBZGRyZXNzZXMpKS50by5kZWVwLmVxKFtcbiAgICAgICAgICAgICAgICBuZXcgQmlnTnVtYmVyKDEpLFxuICAgICAgICAgICAgICAgIG5ldyBCaWdOdW1iZXIoMiksXG4gICAgICAgICAgICAgICAgbnVsbCxcbiAgICAgICAgICAgIF0pO1xuICAgICAgICB9KTtcblxuICAgICAgICBpdCgncmV0dXJucyBudWxsIGJhbGFuY2VzIGlmIGFkZHJlc3NlcyBmcm9tIGEgZGlmZmVyZW50IGNoYWluIGFyZSBzdXBwbGllZCcsIGFzeW5jICgpID0+IHtcbiAgICAgICAgICAgIGV4cGVjdChhd2FpdCBjYWNoZUNsaWVudC5nZXRFUkMyME93bmVyQmFsYW5jZXNBc3luYyhDaGFpbklkLlBvbHlnb25NdW1iYWksIGFkZHJlc3NlcykpLnRvLmRlZXAuZXEoW1xuICAgICAgICAgICAgICAgIG51bGwsXG4gICAgICAgICAgICAgICAgbnVsbCxcbiAgICAgICAgICAgICAgICBudWxsLFxuICAgICAgICAgICAgXSk7XG4gICAgICAgIH0pO1xuXG4gICAgICAgIGl0KCdyZXR1cm5zIGFuIGVtcHR5IGFycmF5IGlmIGFkZHJlc3NlcyBhcmUgZW1wdHknLCBhc3luYyAoKSA9PiB7XG4gICAgICAgICAgICBleHBlY3QoYXdhaXQgY2FjaGVDbGllbnQuZ2V0RVJDMjBPd25lckJhbGFuY2VzQXN5bmMoY2hhaW5JZCwgW10pKS50by5kZWVwLmVxKFtdKTtcbiAgICAgICAgfSk7XG4gICAgfSk7XG5cbiAgICBkZXNjcmliZSgnZXZpY3RaZXJvQmFsYW5jZXNBc3luYycsICgpID0+IHtcbiAgICAgICAgY29uc3QgYWRkcmVzc2VzID0gW1xuICAgICAgICAgICAgeyBvd25lcjogbWFrZXJBLCB0b2tlbjogdG9rZW5BIH0sXG4gICAgICAgICAgICB7IG93bmVyOiBtYWtlckIsIHRva2VuOiB0b2tlbkIgfSxcbiAgICAgICAgICAgIHsgb3duZXI6IG1ha2VyQywgdG9rZW46IHRva2VuQyB9LFxuICAgICAgICBdO1xuXG4gICAgICAgIGl0KCdldmljdHMgemVyb2VkIGVudHJpZXMgZnJvbSB0aGUgY2FjaGUnLCBhc3luYyAoKSA9PiB7XG4gICAgICAgICAgICBhZGRyZXNzZXMuZm9yRWFjaChhc3luYyAoYWRkcmVzcykgPT4ge1xuICAgICAgICAgICAgICAgIGF3YWl0IGNhY2hlQ2xpZW50LmFkZEVSQzIwT3duZXJBc3luYyhjaGFpbklkLCBhZGRyZXNzKTtcbiAgICAgICAgICAgIH0pO1xuICAgICAgICAgICAgbGV0IGNhY2hlZEFkZHJlc3NlcyA9IGF3YWl0IGNhY2hlQ2xpZW50LmdldEVSQzIwT3duZXJzQXN5bmMoY2hhaW5JZCk7XG4gICAgICAgICAgICBleHBlY3QoY2FjaGVkQWRkcmVzc2VzLnNvcnQoY29tcGFyZUZuKSkudG8uZGVlcC5lcShhZGRyZXNzZXMuc29ydChjb21wYXJlRm4pKTtcblxuICAgICAgICAgICAgY29uc3QgYmFsYW5jZXMgPSBbbmV3IEJpZ051bWJlcigxKSwgbmV3IEJpZ051bWJlcigyKSwgbmV3IEJpZ051bWJlcigwKV07XG4gICAgICAgICAgICBhd2FpdCBjYWNoZUNsaWVudC5zZXRFUkMyME93bmVyQmFsYW5jZXNBc3luYyhjaGFpbklkLCBhZGRyZXNzZXMsIGJhbGFuY2VzKTtcblxuICAgICAgICAgICAgY29uc3QgbnVtRXZpY3RlZCA9IGF3YWl0IGNhY2hlQ2xpZW50LmV2aWN0WmVyb0JhbGFuY2VzQXN5bmMoY2hhaW5JZCk7XG4gICAgICAgICAgICBleHBlY3QobnVtRXZpY3RlZCkudG8uZXEoMSk7XG4gICAgICAgICAgICBjYWNoZWRBZGRyZXNzZXMgPSBhd2FpdCBjYWNoZUNsaWVudC5nZXRFUkMyME93bmVyc0FzeW5jKGNoYWluSWQpO1xuICAgICAgICAgICAgZXhwZWN0KGNhY2hlZEFkZHJlc3Nlcy5zb3J0KGNvbXBhcmVGbikpLnRvLmRlZXAuZXEoYWRkcmVzc2VzLnNsaWNlKDAsIDIpLnNvcnQoY29tcGFyZUZuKSk7XG4gICAgICAgIH0pO1xuXG4gICAgICAgIGl0KCdkb2VzIG5vdCBldmljdCBhbnkgZW50cmllcyBpZiB0aGVyZSBhcmUgbm8gc3RhbGUgYmFsYW5jZXMnLCBhc3luYyAoKSA9PiB7XG4gICAgICAgICAgICBhZGRyZXNzZXMuZm9yRWFjaChhc3luYyAoYWRkcmVzcykgPT4ge1xuICAgICAgICAgICAgICAgIGF3YWl0IGNhY2hlQ2xpZW50LmFkZEVSQzIwT3duZXJBc3luYyhjaGFpbklkLCBhZGRyZXNzKTtcbiAgICAgICAgICAgIH0pO1xuICAgICAgICAgICAgbGV0IGNhY2hlZEFkZHJlc3NlcyA9IGF3YWl0IGNhY2hlQ2xpZW50LmdldEVSQzIwT3duZXJzQXN5bmMoY2hhaW5JZCk7XG4gICAgICAgICAgICBleHBlY3QoY2FjaGVkQWRkcmVzc2VzLnNvcnQoY29tcGFyZUZuKSkudG8uZGVlcC5lcShhZGRyZXNzZXMuc29ydChjb21wYXJlRm4pKTtcblxuICAgICAgICAgICAgY29uc3QgYmFsYW5jZXMgPSBbbmV3IEJpZ051bWJlcigxKSwgbmV3IEJpZ051bWJlcigyKSwgbmV3IEJpZ051bWJlcigzKV07XG4gICAgICAgICAgICBhd2FpdCBjYWNoZUNsaWVudC5zZXRFUkMyME93bmVyQmFsYW5jZXNBc3luYyhjaGFpbklkLCBhZGRyZXNzZXMsIGJhbGFuY2VzKTtcblxuICAgICAgICAgICAgY29uc3QgbnVtRXZpY3RlZCA9IGF3YWl0IGNhY2hlQ2xpZW50LmV2aWN0WmVyb0JhbGFuY2VzQXN5bmMoY2hhaW5JZCk7XG4gICAgICAgICAgICBleHBlY3QobnVtRXZpY3RlZCkudG8uZXEoMCk7XG4gICAgICAgICAgICBjYWNoZWRBZGRyZXNzZXMgPSBhd2FpdCBjYWNoZUNsaWVudC5nZXRFUkMyME93bmVyc0FzeW5jKGNoYWluSWQpO1xuICAgICAgICAgICAgZXhwZWN0KGNhY2hlZEFkZHJlc3Nlcy5zb3J0KGNvbXBhcmVGbikpLnRvLmRlZXAuZXEoYWRkcmVzc2VzLnNvcnQoY29tcGFyZUZuKSk7XG4gICAgICAgIH0pO1xuXG4gICAgICAgIGl0KCdkb2VzIG5vdCBlcnJvciBpZiB0aGUgYWRkcmVzcyBzZXQgaXMgZW1wdHknLCBhc3luYyAoKSA9PiB7XG4gICAgICAgICAgICBleHBlY3QoYXdhaXQgY2FjaGVDbGllbnQuZ2V0RVJDMjBPd25lcnNBc3luYyhjaGFpbklkKSkudG8uaGF2ZS5sZW5ndGgoMCk7XG4gICAgICAgICAgICBjb25zdCBudW1FdmljdGVkID0gYXdhaXQgY2FjaGVDbGllbnQuZXZpY3RaZXJvQmFsYW5jZXNBc3luYyhjaGFpbklkKTtcbiAgICAgICAgICAgIGV4cGVjdChudW1FdmljdGVkKS50by5lcSgwKTtcbiAgICAgICAgfSk7XG4gICAgfSk7XG5cbiAgICBkZXNjcmliZSgnY29vbERvd25NYWtlckZvclBhaXInLCAoKSA9PiB7XG4gICAgICAgIGNvbnN0IG1ha2VySWQxID0gJ21ha2VySWQxJztcbiAgICAgICAgY29uc3QgdGFrZXJUb2tlbiA9ICd0YWtlclRva2VuJztcbiAgICAgICAgY29uc3QgbWFrZXJUb2tlbiA9ICdtYWtlclRva2VuJztcblxuICAgICAgICBpdCgnc2hvdWxkIGFkZCBuZXcgbWFrZXJzIHRvIHRoZSBjb29saW5nIGRvd24gc2V0IGZvciBhIHBhaXInLCBhc3luYyAoKSA9PiB7XG4gICAgICAgICAgICBjb25zdCBpc1VwZGF0ZWQgPSBhd2FpdCBjYWNoZUNsaWVudC5hZGRNYWtlclRvQ29vbGRvd25Bc3luYyhcbiAgICAgICAgICAgICAgICBtYWtlcklkMSxcbiAgICAgICAgICAgICAgICBEYXRlLm5vdygpLFxuICAgICAgICAgICAgICAgIGNoYWluSWQsXG4gICAgICAgICAgICAgICAgdGFrZXJUb2tlbixcbiAgICAgICAgICAgICAgICBtYWtlclRva2VuLFxuICAgICAgICAgICAgKTtcbiAgICAgICAgICAgIGV4cGVjdChpc1VwZGF0ZWQpLnRvLmVxKHRydWUpO1xuICAgICAgICB9KTtcblxuICAgICAgICBpdCgnc2hvdWxkIHVwZGF0ZSBlbmRUaW1lIHRvIGEgdGltZSBsYXRlciB0aGFuIGV4aXN0aW5nIGVuZFRpbWUnLCBhc3luYyAoKSA9PiB7XG4gICAgICAgICAgICBjb25zdCBub3cgPSBEYXRlLm5vdygpO1xuICAgICAgICAgICAgY29uc3Qgb25lTWludXRlTGF0ZXIgPSBub3cgKyBPTkVfTUlOVVRFX01TO1xuICAgICAgICAgICAgYXdhaXQgY2FjaGVDbGllbnQuYWRkTWFrZXJUb0Nvb2xkb3duQXN5bmMobWFrZXJJZDEsIG5vdywgY2hhaW5JZCwgdGFrZXJUb2tlbiwgbWFrZXJUb2tlbik7XG4gICAgICAgICAgICBjb25zdCBpc1VwZGF0ZWQgPSBhd2FpdCBjYWNoZUNsaWVudC5hZGRNYWtlclRvQ29vbGRvd25Bc3luYyhcbiAgICAgICAgICAgICAgICBtYWtlcklkMSxcbiAgICAgICAgICAgICAgICBvbmVNaW51dGVMYXRlcixcbiAgICAgICAgICAgICAgICBjaGFpbklkLFxuICAgICAgICAgICAgICAgIG1ha2VyVG9rZW4sXG4gICAgICAgICAgICAgICAgdGFrZXJUb2tlbixcbiAgICAgICAgICAgICk7XG4gICAgICAgICAgICBleHBlY3QoaXNVcGRhdGVkKS50by5lcSh0cnVlKTtcbiAgICAgICAgfSk7XG5cbiAgICAgICAgaXQoJ3Nob3VsZCBub3QgdXBkYXRlIGVuZFRpbWUgdG8gYSB0aW1lIGVhcmxpZXIgdGhhbiBleGlzdGluZyBlbmRUaW1lJywgYXN5bmMgKCkgPT4ge1xuICAgICAgICAgICAgY29uc3Qgbm93ID0gRGF0ZS5ub3coKTtcbiAgICAgICAgICAgIGNvbnN0IG9uZU1pbnV0ZUVhcmxpZXIgPSBub3cgLSBPTkVfTUlOVVRFX01TO1xuICAgICAgICAgICAgYXdhaXQgY2FjaGVDbGllbnQuYWRkTWFrZXJUb0Nvb2xkb3duQXN5bmMobWFrZXJJZDEsIG5vdywgY2hhaW5JZCwgdGFrZXJUb2tlbiwgbWFrZXJUb2tlbik7XG4gICAgICAgICAgICBjb25zdCBpc1VwZGF0ZWQgPSBhd2FpdCBjYWNoZUNsaWVudC5hZGRNYWtlclRvQ29vbGRvd25Bc3luYyhcbiAgICAgICAgICAgICAgICBtYWtlcklkMSxcbiAgICAgICAgICAgICAgICBvbmVNaW51dGVFYXJsaWVyLFxuICAgICAgICAgICAgICAgIGNoYWluSWQsXG4gICAgICAgICAgICAgICAgdGFrZXJUb2tlbixcbiAgICAgICAgICAgICAgICBtYWtlclRva2VuLFxuICAgICAgICAgICAgKTtcbiAgICAgICAgICAgIGV4cGVjdChpc1VwZGF0ZWQpLnRvLmVxKGZhbHNlKTtcbiAgICAgICAgfSk7XG4gICAgfSk7XG5cbiAgICBkZXNjcmliZSgnZ2V0Q29vbGluZ0Rvd25NYWtlcnNGb3JQYWlyJywgKCkgPT4ge1xuICAgICAgICBjb25zdCBtYWtlcklkMSA9ICdtYWtlcklkMSc7XG4gICAgICAgIGNvbnN0IG1ha2VySWQyID0gJ21ha2VySWQyJztcbiAgICAgICAgY29uc3QgdGFrZXJUb2tlbiA9ICd0YWtlclRva2VuJztcbiAgICAgICAgY29uc3Qgb3RoZXJUYWtlclRva2VuID0gJ290aGVyVGFrZXJUb2tlbic7XG4gICAgICAgIGNvbnN0IG1ha2VyVG9rZW4gPSAnbWFrZXJUb2tlbic7XG5cbiAgICAgICAgaXQoJ3Nob3VsZCBnZXQgYWxsIG1ha2VycyB0aGF0IGFyZSBjb29saW5nIGRvd24nLCBhc3luYyAoKSA9PiB7XG4gICAgICAgICAgICBjb25zdCBub3cgPSBEYXRlLm5vdygpO1xuICAgICAgICAgICAgY29uc3Qgb25lTWludXRlTGF0ZXIgPSBub3cgKyBPTkVfTUlOVVRFX01TO1xuICAgICAgICAgICAgYXdhaXQgY2FjaGVDbGllbnQuYWRkTWFrZXJUb0Nvb2xkb3duQXN5bmMobWFrZXJJZDEsIG9uZU1pbnV0ZUxhdGVyLCBjaGFpbklkLCB0YWtlclRva2VuLCBtYWtlclRva2VuKTtcbiAgICAgICAgICAgIGF3YWl0IGNhY2hlQ2xpZW50LmFkZE1ha2VyVG9Db29sZG93bkFzeW5jKG1ha2VySWQyLCBvbmVNaW51dGVMYXRlciwgY2hhaW5JZCwgdGFrZXJUb2tlbiwgbWFrZXJUb2tlbik7XG4gICAgICAgICAgICBjb25zdCByZXN1bHQgPSBhd2FpdCBjYWNoZUNsaWVudC5nZXRNYWtlcnNJbkNvb2xkb3duRm9yUGFpckFzeW5jKGNoYWluSWQsIHRha2VyVG9rZW4sIG1ha2VyVG9rZW4sIG5vdyk7XG4gICAgICAgICAgICBleHBlY3QocmVzdWx0KS50by5kZWVwLmVxKFttYWtlcklkMSwgbWFrZXJJZDJdKTtcbiAgICAgICAgfSk7XG5cbiAgICAgICAgaXQoJ3Nob3VsZCBub3QgaW5jbHVkZSBtYWtlcnMgd2hvc2UgY29vbGluZyBkb3duIHBlcmlvZHMgYWxyZWFkeSBlbmRlZCcsIGFzeW5jICgpID0+IHtcbiAgICAgICAgICAgIGNvbnN0IG5vdyA9IERhdGUubm93KCk7XG4gICAgICAgICAgICBjb25zdCBvbmVNaW51dGVFYXJsaWVyID0gbm93IC0gT05FX01JTlVURV9NUztcbiAgICAgICAgICAgIGNvbnN0IG9uZU1pbnV0ZUxhdGVyID0gbm93ICsgT05FX01JTlVURV9NUztcbiAgICAgICAgICAgIGF3YWl0IGNhY2hlQ2xpZW50LmFkZE1ha2VyVG9Db29sZG93bkFzeW5jKG1ha2VySWQxLCBvbmVNaW51dGVFYXJsaWVyLCBjaGFpbklkLCB0YWtlclRva2VuLCBtYWtlclRva2VuKTtcbiAgICAgICAgICAgIGF3YWl0IGNhY2hlQ2xpZW50LmFkZE1ha2VyVG9Db29sZG93bkFzeW5jKG1ha2VySWQyLCBvbmVNaW51dGVMYXRlciwgY2hhaW5JZCwgdGFrZXJUb2tlbiwgbWFrZXJUb2tlbik7XG4gICAgICAgICAgICBjb25zdCByZXN1bHQgPSBhd2FpdCBjYWNoZUNsaWVudC5nZXRNYWtlcnNJbkNvb2xkb3duRm9yUGFpckFzeW5jKGNoYWluSWQsIHRha2VyVG9rZW4sIG1ha2VyVG9rZW4sIG5vdyk7XG4gICAgICAgICAgICBleHBlY3QocmVzdWx0KS50by5kZWVwLmVxKFttYWtlcklkMl0pO1xuICAgICAgICB9KTtcblxuICAgICAgICBpdCgnc2hvdWxkIG9ubHkgaW5jbHVkZSBtYWtlcnMgdGhhdCBhcmUgY29vbGluZyBkb3duIGZvciB0aGlzIHBhaXInLCBhc3luYyAoKSA9PiB7XG4gICAgICAgICAgICBjb25zdCBub3cgPSBEYXRlLm5vdygpO1xuICAgICAgICAgICAgY29uc3Qgb25lTWludXRlTGF0ZXIgPSBub3cgKyBPTkVfTUlOVVRFX01TO1xuICAgICAgICAgICAgYXdhaXQgY2FjaGVDbGllbnQuYWRkTWFrZXJUb0Nvb2xkb3duQXN5bmMobWFrZXJJZDEsIG9uZU1pbnV0ZUxhdGVyLCBjaGFpbklkLCB0YWtlclRva2VuLCBtYWtlclRva2VuKTtcbiAgICAgICAgICAgIGF3YWl0IGNhY2hlQ2xpZW50LmFkZE1ha2VyVG9Db29sZG93bkFzeW5jKG1ha2VySWQyLCBvbmVNaW51dGVMYXRlciwgY2hhaW5JZCwgb3RoZXJUYWtlclRva2VuLCBtYWtlclRva2VuKTtcbiAgICAgICAgICAgIGNvbnN0IHJlc3VsdCA9IGF3YWl0IGNhY2hlQ2xpZW50LmdldE1ha2Vyc0luQ29vbGRvd25Gb3JQYWlyQXN5bmMoY2hhaW5JZCwgdGFrZXJUb2tlbiwgbWFrZXJUb2tlbiwgbm93KTtcbiAgICAgICAgICAgIGV4cGVjdChyZXN1bHQpLnRvLmRlZXAuZXEoW21ha2VySWQxXSk7XG4gICAgICAgIH0pO1xuICAgIH0pO1xufSk7XG4iXSwidmVyc2lvbiI6M30=