ae32075c7ddf0447a0c2abf95b2e8455
"use strict";
Object.defineProperty(exports, "__esModule", { value: true });
exports.RfqMakerService = void 0;
const contract_addresses_1 = require("@0x/contract-addresses");
const utils_1 = require("@0x/utils");
const lodash_1 = require("lodash");
const entities_1 = require("../entities");
/**
 * RfqMakerService is the coordination layer for HTTP maker services.
 */
class RfqMakerService {
    constructor(_dbUtils, _configManager) {
        this._dbUtils = _dbUtils;
        this._configManager = _configManager;
    }
    /**
     * Validates that the chainId specified by client is a valid (and known) chain ID.
     */
    // $eslint-fix-me https://github.com/rhinodavid/eslint-fix-me
    // eslint-disable-next-line @typescript-eslint/no-explicit-any
    static isValidChainId(chainId) {
        return Object.values(contract_addresses_1.ChainId).includes(Number(chainId));
    }
    /**
     * Validates that the URIs (either rfqtUri or rfqmUri) specified by client is a valid URI or null.
     */
    static validateUriOrThrow(fieldName, uri) {
        if (uri === null) {
            return;
        }
        if (uri === undefined || !uri.startsWith('http')) {
            throw new Error(`Invalid value of ${fieldName}: ${uri}`);
        }
    }
    /**
     * Validates that a payload of market maker pairs is well-formed
     * and contains valid contract addresses.
     *
     * @throws if the payload is invalid
     */
    static validatePairsPayloadOrThrow(pairs) {
        if (!(0, lodash_1.isArray)(pairs)) {
            throw new Error('pairs is not an array.');
        }
        pairs.forEach((pair, i) => {
            if (!(0, lodash_1.isArray)(pair)) {
                throw new Error(`pair ${i} is not an array.`);
            }
            if (pair.length !== 2) {
                throw new Error(`pair ${i} array does not consist of exactly two elements.`);
            }
            if (!utils_1.addressUtils.isAddress(pair[0])) {
                throw new Error(`address of first token for pair ${i} is invalid.`);
            }
            if (!utils_1.addressUtils.isAddress(pair[1])) {
                throw new Error(`address of second token for pair ${i} is invalid.`);
            }
            if (pair[0] === pair[1]) {
                throw new Error(`pair array ${i} has identical assets.`);
            }
        });
    }
    /**
     * Get the config of a maker on a given blockchain from DB.
     * Return a `RfqMaker` which specifies makerId, chainId, update time, the pairs array, rfqtUri and rfqmUir.
     * If not found in DB, return the default entity for the makerId and chainId with empty pairs array, and `null` URIs.
     */
    async getRfqMakerAsync(makerId, chainId) {
        const result = await this._dbUtils.getRfqMakerAsync(makerId, chainId);
        return result !== null && result !== void 0 ? result : new entities_1.RfqMaker({ makerId, chainId, updatedAt: null, pairs: [], rfqtUri: null, rfqmUri: null });
    }
    /**
     * Create or update a record in the `rfq_maker_pairs` DB table for the maker on a given blockchain.
     * Return the `RfqMaker` entity which represents the new record.
     */
    async createOrUpdateRfqMakerAsync(makerId, chainId, pairs, rfqtUri, rfqmUri) {
        return this._dbUtils.createOrUpdateRfqMakerAsync(makerId, chainId, pairs, rfqtUri, rfqmUri);
    }
    /**
     * Update one or more fields of a record in the `rfq_maker_pairs` DB table for the maker on a given blockchain.
     * Return the `RfqMaker` entity which represents the new record.
     */
    async patchRfqMakerAsync(makerId, chainId, pairs, rfqtUri, rfqmUri) {
        const oldRfqMaker = await this.getRfqMakerAsync(makerId, chainId);
        return this.createOrUpdateRfqMakerAsync(makerId, chainId, pairs !== undefined ? pairs : oldRfqMaker.pairs, rfqtUri !== undefined ? rfqtUri : oldRfqMaker.rfqtUri, rfqmUri !== undefined ? rfqmUri : oldRfqMaker.rfqmUri);
    }
    /**
     * Maps the given maker API key to makerId.
     * Returns null is the input key is `undefined` or unknown.
     */
    mapMakerApiKeyToId(apiKey) {
        if (apiKey === undefined) {
            return null;
        }
        return this._configManager.getRfqMakerIdForApiKey(apiKey) || null;
    }
}
exports.RfqMakerService = RfqMakerService;
//# sourceMappingURL=data:application/json;charset=utf-8;base64,eyJmaWxlIjoiL1VzZXJzL2Rhdmlkd2Fsc2gvY29kZS1sb2NhbC8weC1yZnEtYXBpL3NyYy9zZXJ2aWNlcy9yZnFfbWFrZXJfc2VydmljZS50cyIsIm1hcHBpbmdzIjoiOzs7QUFBQSwrREFBaUQ7QUFDakQscUNBQXlDO0FBQ3pDLG1DQUFpQztBQUVqQywwQ0FBdUM7QUFJdkM7O0dBRUc7QUFDSCxNQUFhLGVBQWU7SUFxRHhCLFlBQTZCLFFBQXlCLEVBQW1CLGNBQTZCO1FBQXpFLGFBQVEsR0FBUixRQUFRLENBQWlCO1FBQW1CLG1CQUFjLEdBQWQsY0FBYyxDQUFlO0lBQUcsQ0FBQztJQXBEMUc7O09BRUc7SUFDSCw2REFBNkQ7SUFDN0QsOERBQThEO0lBQ3ZELE1BQU0sQ0FBQyxjQUFjLENBQUMsT0FBWTtRQUNyQyxPQUFPLE1BQU0sQ0FBQyxNQUFNLENBQUMsNEJBQU8sQ0FBQyxDQUFDLFFBQVEsQ0FBQyxNQUFNLENBQUMsT0FBTyxDQUFDLENBQUMsQ0FBQztJQUM1RCxDQUFDO0lBRUQ7O09BRUc7SUFDSSxNQUFNLENBQUMsa0JBQWtCLENBQUMsU0FBaUIsRUFBRSxHQUE4QjtRQUM5RSxJQUFJLEdBQUcsS0FBSyxJQUFJLEVBQUU7WUFDZCxPQUFPO1NBQ1Y7UUFFRCxJQUFJLEdBQUcsS0FBSyxTQUFTLElBQUksQ0FBQyxHQUFHLENBQUMsVUFBVSxDQUFDLE1BQU0sQ0FBQyxFQUFFO1lBQzlDLE1BQU0sSUFBSSxLQUFLLENBQUMsb0JBQW9CLFNBQVMsS0FBSyxHQUFHLEVBQUUsQ0FBQyxDQUFDO1NBQzVEO0lBQ0wsQ0FBQztJQUVEOzs7OztPQUtHO0lBQ0ksTUFBTSxDQUFDLDJCQUEyQixDQUFDLEtBQXlCO1FBQy9ELElBQUksQ0FBQyxJQUFBLGdCQUFPLEVBQUMsS0FBSyxDQUFDLEVBQUU7WUFDakIsTUFBTSxJQUFJLEtBQUssQ0FBQyx3QkFBd0IsQ0FBQyxDQUFDO1NBQzdDO1FBRUQsS0FBSyxDQUFDLE9BQU8sQ0FBQyxDQUFDLElBQUksRUFBRSxDQUFDLEVBQUUsRUFBRTtZQUN0QixJQUFJLENB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bC8weC1yZnEtYXBpL3NyYy9zZXJ2aWNlcy9yZnFfbWFrZXJfc2VydmljZS50cyJdLCJzb3VyY2VzQ29udGVudCI6WyJpbXBvcnQgeyBDaGFpbklkIH0gZnJvbSAnQDB4L2NvbnRyYWN0LWFkZHJlc3Nlcyc7XG5pbXBvcnQgeyBhZGRyZXNzVXRpbHMgfSBmcm9tICdAMHgvdXRpbHMnO1xuaW1wb3J0IHsgaXNBcnJheSB9IGZyb20gJ2xvZGFzaCc7XG5cbmltcG9ydCB7IFJmcU1ha2VyIH0gZnJvbSAnLi4vZW50aXRpZXMnO1xuaW1wb3J0IHsgQ29uZmlnTWFuYWdlciB9IGZyb20gJy4uL3V0aWxzL2NvbmZpZ19tYW5hZ2VyJztcbmltcG9ydCB7IFJmcU1ha2VyRGJVdGlscyB9IGZyb20gJy4uL3V0aWxzL3JmcV9tYWtlcl9kYl91dGlscyc7XG5cbi8qKlxuICogUmZxTWFrZXJTZXJ2aWNlIGlzIHRoZSBjb29yZGluYXRpb24gbGF5ZXIgZm9yIEhUVFAgbWFrZXIgc2VydmljZXMuXG4gKi9cbmV4cG9ydCBjbGFzcyBSZnFNYWtlclNlcnZpY2Uge1xuICAgIC8qKlxuICAgICAqIFZhbGlkYXRlcyB0aGF0IHRoZSBjaGFpbklkIHNwZWNpZmllZCBieSBjbGllbnQgaXMgYSB2YWxpZCAoYW5kIGtub3duKSBjaGFpbiBJRC5cbiAgICAgKi9cbiAgICAvLyAkZXNsaW50LWZpeC1tZSBodHRwczovL2dpdGh1Yi5jb20vcmhpbm9kYXZpZC9lc2xpbnQtZml4LW1lXG4gICAgLy8gZXNsaW50LWRpc2FibGUtbmV4dC1saW5lIEB0eXBlc2NyaXB0LWVzbGludC9uby1leHBsaWNpdC1hbnlcbiAgICBwdWJsaWMgc3RhdGljIGlzVmFsaWRDaGFpbklkKGNoYWluSWQ6IGFueSk6IGNoYWluSWQgaXMgQ2hhaW5JZCB7XG4gICAgICAgIHJldHVybiBPYmplY3QudmFsdWVzKENoYWluSWQpLmluY2x1ZGVzKE51bWJlcihjaGFpbklkKSk7XG4gICAgfVxuXG4gICAgLyoqXG4gICAgICogVmFsaWRhdGVzIHRoYXQgdGhlIFVSSXMgKGVpdGhlciByZnF0VXJpIG9yIHJmcW1VcmkpIHNwZWNpZmllZCBieSBjbGllbnQgaXMgYSB2YWxpZCBVUkkgb3IgbnVsbC5cbiAgICAgKi9cbiAgICBwdWJsaWMgc3RhdGljIHZhbGlkYXRlVXJpT3JUaHJvdyhmaWVsZE5hbWU6IHN0cmluZywgdXJpOiBzdHJpbmcgfCBudWxsIHwgdW5kZWZpbmVkKTogdm9pZCB7XG4gICAgICAgIGlmICh1cmkgPT09IG51bGwpIHtcbiAgICAgICAgICAgIHJldHVybjtcbiAgICAgICAgfVxuXG4gICAgICAgIGlmICh1cmkgPT09IHVuZGVmaW5lZCB8fCAhdXJpLnN0YXJ0c1dpdGgoJ2h0dHAnKSkge1xuICAgICAgICAgICAgdGhyb3cgbmV3IEVycm9yKGBJbnZhbGlkIHZhbHVlIG9mICR7ZmllbGROYW1lfTogJHt1cml9YCk7XG4gICAgICAgIH1cbiAgICB9XG5cbiAgICAvKipcbiAgICAgKiBWYWxpZGF0ZXMgdGhhdCBhIHBheWxvYWQgb2YgbWFya2V0IG1ha2VyIHBhaXJzIGlzIHdlbGwtZm9ybWVkXG4gICAgICogYW5kIGNvbnRhaW5zIHZhbGlkIGNvbnRyYWN0IGFkZHJlc3Nlcy5cbiAgICAgKlxuICAgICAqIEB0aHJvd3MgaWYgdGhlIHBheWxvYWQgaXMgaW52YWxpZFxuICAgICAqL1xuICAgIHB1YmxpYyBzdGF0aWMgdmFsaWRhdGVQYWlyc1BheWxvYWRPclRocm93KHBhaXJzOiBbc3RyaW5nLCBzdHJpbmddW10pOiB2b2lkIHtcbiAgICAgICAgaWYgKCFpc0FycmF5KHBhaXJzKSkge1xuICAgICAgICAgICAgdGhyb3cgbmV3IEVycm9yKCdwYWlycyBpcyBub3QgYW4gYXJyYXkuJyk7XG4gICAgICAgIH1cblxuICAgICAgICBwYWlycy5mb3JFYWNoKChwYWlyLCBpKSA9PiB7XG4gICAgICAgICAgICBpZiAoIWlzQXJyYXkocGFpcikpIHtcbiAgICAgICAgICAgICAgICB0aHJvdyBuZXcgRXJyb3IoYHBhaXIgJHtpfSBpcyBub3QgYW4gYXJyYXkuYCk7XG4gICAgICAgICAgICB9XG4gICAgICAgICAgICBpZiAocGFpci5sZW5ndGggIT09IDIpIHtcbiAgICAgICAgICAgICAgICB0aHJvdyBuZXcgRXJyb3IoYHBhaXIgJHtpfSBhcnJheSBkb2VzIG5vdCBjb25zaXN0IG9mIGV4YWN0bHkgdHdvIGVsZW1lbnRzLmApO1xuICAgICAgICAgICAgfVxuICAgICAgICAgICAgaWYgKCFhZGRyZXNzVXRpbHMuaXNBZGRyZXNzKHBhaXJbMF0pKSB7XG4gICAgICAgICAgICAgICAgdGhyb3cgbmV3IEVycm9yKGBhZGRyZXNzIG9mIGZpcnN0IHRva2VuIGZvciBwYWlyICR7aX0gaXMgaW52YWxpZC5gKTtcbiAgICAgICAgICAgIH1cbiAgICAgICAgICAgIGlmICghYWRkcmVzc1V0aWxzLmlzQWRkcmVzcyhwYWlyWzFdKSkge1xuICAgICAgICAgICAgICAgIHRocm93IG5ldyBFcnJvcihgYWRkcmVzcyBvZiBzZWNvbmQgdG9rZW4gZm9yIHBhaXIgJHtpfSBpcyBpbnZhbGlkLmApO1xuICAgICAgICAgICAgfVxuICAgICAgICAgICAgaWYgKHBhaXJbMF0gPT09IHBhaXJbMV0pIHtcbiAgICAgICAgICAgICAgICB0aHJvdyBuZXcgRXJyb3IoYHBhaXIgYXJyYXkgJHtpfSBoYXMgaWRlbnRpY2FsIGFzc2V0cy5gKTtcbiAgICAgICAgICAgIH1cbiAgICAgICAgfSk7XG4gICAgfVxuXG4gICAgY29uc3RydWN0b3IocHJpdmF0ZSByZWFkb25seSBfZGJVdGlsczogUmZxTWFrZXJEYlV0aWxzLCBwcml2YXRlIHJlYWRvbmx5IF9jb25maWdNYW5hZ2VyOiBDb25maWdNYW5hZ2VyKSB7fVxuXG4gICAgLyoqXG4gICAgICogR2V0IHRoZSBjb25maWcgb2YgYSBtYWtlciBvbiBhIGdpdmVuIGJsb2NrY2hhaW4gZnJvbSBEQi5cbiAgICAgKiBSZXR1cm4gYSBgUmZxTWFrZXJgIHdoaWNoIHNwZWNpZmllcyBtYWtlcklkLCBjaGFpbklkLCB1cGRhdGUgdGltZSwgdGhlIHBhaXJzIGFycmF5LCByZnF0VXJpIGFuZCByZnFtVWlyLlxuICAgICAqIElmIG5vdCBmb3VuZCBpbiBEQiwgcmV0dXJuIHRoZSBkZWZhdWx0IGVudGl0eSBmb3IgdGhlIG1ha2VySWQgYW5kIGNoYWluSWQgd2l0aCBlbXB0eSBwYWlycyBhcnJheSwgYW5kIGBudWxsYCBVUklzLlxuICAgICAqL1xuICAgIHB1YmxpYyBhc3luYyBnZXRSZnFNYWtlckFzeW5jKG1ha2VySWQ6IHN0cmluZywgY2hhaW5JZDogbnVtYmVyKTogUHJvbWlzZTxSZnFNYWtlcj4ge1xuICAgICAgICBjb25zdCByZXN1bHQgPSBhd2FpdCB0aGlzLl9kYlV0aWxzLmdldFJmcU1ha2VyQXN5bmMobWFrZXJJZCwgY2hhaW5JZCk7XG4gICAgICAgIHJldHVybiByZXN1bHQgPz8gbmV3IFJmcU1ha2VyKHsgbWFrZXJJZCwgY2hhaW5JZCwgdXBkYXRlZEF0OiBudWxsLCBwYWlyczogW10sIHJmcXRVcmk6IG51bGwsIHJmcW1Vcmk6IG51bGwgfSk7XG4gICAgfVxuXG4gICAgLyoqXG4gICAgICogQ3JlYXRlIG9yIHVwZGF0ZSBhIHJlY29yZCBpbiB0aGUgYHJmcV9tYWtlcl9wYWlyc2AgREIgdGFibGUgZm9yIHRoZSBtYWtlciBvbiBhIGdpdmVuIGJsb2NrY2hhaW4uXG4gICAgICogUmV0dXJuIHRoZSBgUmZxTWFrZXJgIGVudGl0eSB3aGljaCByZXByZXNlbnRzIHRoZSBuZXcgcmVjb3JkLlxuICAgICAqL1xuICAgIHB1YmxpYyBhc3luYyBjcmVhdGVPclVwZGF0ZVJmcU1ha2VyQXN5bmMoXG4gICAgICAgIG1ha2VySWQ6IHN0cmluZyxcbiAgICAgICAgY2hhaW5JZDogbnVtYmVyLFxuICAgICAgICBwYWlyczogW3N0cmluZywgc3RyaW5nXVtdLFxuICAgICAgICByZnF0VXJpOiBzdHJpbmcgfCBudWxsLFxuICAgICAgICByZnFtVXJpOiBzdHJpbmcgfCBudWxsLFxuICAgICk6IFByb21pc2U8UmZxTWFrZXI+IHtcbiAgICAgICAgcmV0dXJuIHRoaXMuX2RiVXRpbHMuY3JlYXRlT3JVcGRhdGVSZnFNYWtlckFzeW5jKG1ha2VySWQsIGNoYWluSWQsIHBhaXJzLCByZnF0VXJpLCByZnFtVXJpKTtcbiAgICB9XG5cbiAgICAvKipcbiAgICAgKiBVcGRhdGUgb25lIG9yIG1vcmUgZmllbGRzIG9mIGEgcmVjb3JkIGluIHRoZSBgcmZxX21ha2VyX3BhaXJzYCBEQiB0YWJsZSBmb3IgdGhlIG1ha2VyIG9uIGEgZ2l2ZW4gYmxvY2tjaGFpbi5cbiAgICAgKiBSZXR1cm4gdGhlIGBSZnFNYWtlcmAgZW50aXR5IHdoaWNoIHJlcHJlc2VudHMgdGhlIG5ldyByZWNvcmQuXG4gICAgICovXG4gICAgcHVibGljIGFzeW5jIHBhdGNoUmZxTWFrZXJBc3luYyhcbiAgICAgICAgbWFrZXJJZDogc3RyaW5nLFxuICAgICAgICBjaGFpbklkOiBudW1iZXIsXG4gICAgICAgIHBhaXJzOiBbc3RyaW5nLCBzdHJpbmddW10gfCB1bmRlZmluZWQsXG4gICAgICAgIHJmcXRVcmk6IHN0cmluZyB8IG51bGwgfCB1bmRlZmluZWQsXG4gICAgICAgIHJmcW1Vcmk6IHN0cmluZyB8IG51bGwgfCB1bmRlZmluZWQsXG4gICAgKTogUHJvbWlzZTxSZnFNYWtlcj4ge1xuICAgICAgICBjb25zdCBvbGRSZnFNYWtlciA9IGF3YWl0IHRoaXMuZ2V0UmZxTWFrZXJBc3luYyhtYWtlcklkLCBjaGFpbklkKTtcblxuICAgICAgICByZXR1cm4gdGhpcy5jcmVhdGVPclVwZGF0ZVJmcU1ha2VyQXN5bmMoXG4gICAgICAgICAgICBtYWtlcklkLFxuICAgICAgICAgICAgY2hhaW5JZCxcbiAgICAgICAgICAgIHBhaXJzICE9PSB1bmRlZmluZWQgPyBwYWlycyA6IG9sZFJmcU1ha2VyLnBhaXJzLFxuICAgICAgICAgICAgcmZxdFVyaSAhPT0gdW5kZWZpbmVkID8gcmZxdFVyaSA6IG9sZFJmcU1ha2VyLnJmcXRVcmksXG4gICAgICAgICAgICByZnFtVXJpICE9PSB1bmRlZmluZWQgPyByZnFtVXJpIDogb2xkUmZxTWFrZXIucmZxbVVyaSxcbiAgICAgICAgKTtcbiAgICB9XG5cbiAgICAvKipcbiAgICAgKiBNYXBzIHRoZSBnaXZlbiBtYWtlciBBUEkga2V5IHRvIG1ha2VySWQuXG4gICAgICogUmV0dXJucyBudWxsIGlzIHRoZSBpbnB1dCBrZXkgaXMgYHVuZGVmaW5lZGAgb3IgdW5rbm93bi5cbiAgICAgKi9cbiAgICBwdWJsaWMgbWFwTWFrZXJBcGlLZXlUb0lkKGFwaUtleTogc3RyaW5nIHwgdW5kZWZpbmVkKTogc3RyaW5nIHwgbnVsbCB7XG4gICAgICAgIGlmIChhcGlLZXkgPT09IHVuZGVmaW5lZCkge1xuICAgICAgICAgICAgcmV0dXJuIG51bGw7XG4gICAgICAgIH1cblxuICAgICAgICByZXR1cm4gdGhpcy5fY29uZmlnTWFuYWdlci5nZXRSZnFNYWtlcklkRm9yQXBpS2V5KGFwaUtleSkgfHwgbnVsbDtcbiAgICB9XG59XG4iXSwidmVyc2lvbiI6M30=