1654f398ca7a228e5d07e8267243f9e6
"use strict";
Object.defineProperty(exports, "__esModule", { value: true });
exports.getAxiosRequestConfigWithProxy = exports.getAxiosRequestConfig = exports.buildRfqtServicesAsync = void 0;
const contract_addresses_1 = require("@0x/contract-addresses");
const token_metadata_1 = require("@0x/token-metadata");
const axios_1 = require("axios");
const ethers_1 = require("ethers");
const http_1 = require("http");
const https_1 = require("https");
const kafkajs_1 = require("kafkajs");
const config_1 = require("../config");
const constants_1 = require("../core/constants");
const RefreshingQuoteRequestor_1 = require("../quoteRequestor/RefreshingQuoteRequestor");
const fee_service_1 = require("../services/fee_service");
const RfqtService_1 = require("../services/RfqtService");
const rfq_maker_balance_cache_service_1 = require("../services/rfq_maker_balance_cache_service");
const balance_checker_1 = require("./balance_checker");
const cache_client_1 = require("./cache_client");
const config_manager_1 = require("./config_manager");
const GasStationAttendantUtils_1 = require("./GasStationAttendantUtils");
const provider_utils_1 = require("./provider_utils");
const quote_server_client_1 = require("./quote_server_client");
const rfq_blockchain_utils_1 = require("./rfq_blockchain_utils");
const rfq_maker_manager_1 = require("./rfq_maker_manager");
const TokenMetadataManager_1 = require("./TokenMetadataManager");
const TokenPriceOracle_1 = require("./TokenPriceOracle");
const ZeroExApiClient_1 = require("./ZeroExApiClient");
const DEFAULT_AXIOS_TIMEOUT = 600; // ms
/**
 * Creates an RFQT Service for each chain present in `ChainConfigurations`.
 *
 * Intended for use by the top-level runners.
 */
async function buildRfqtServicesAsync(chainConfigurations, rfqMakerDbUtils, redis) {
    const proxiedAxiosInstance = axios_1.default.create(getAxiosRequestConfigWithProxy());
    const axiosInstance = axios_1.default.create(getAxiosRequestConfig());
    const configManager = new config_manager_1.ConfigManager();
    const altRfqOptions = config_1.ALT_RFQ_MM_API_KEY !== undefined && config_1.ALT_RFQ_MM_PROFILE !== undefined
        ? {
            // $eslint-fix-me https://github.com/rhinodavid/eslint-fix-me
            // eslint-disable-next-line @typescript-eslint/no-non-null-assertion
            altRfqApiKey: config_1.ALT_RFQ_MM_API_KEY,
            // $eslint-fix-me https://github.com/rhinodavid/eslint-fix-me
            // eslint-disable-next-line @typescript-eslint/no-non-null-assertion
            altRfqProfile: config_1.ALT_RFQ_MM_PROFILE,
        }
        : undefined;
    const services = await Promise.all(chainConfigurations.map(async (chain) => {
        const { rfqt: rfqtConfiguration, chainId } = chain;
        if (!rfqtConfiguration) {
            throw new Error(`RFQt Service for chain ${chainId} does not exist`);
        }
        const rfqMakerManager = new rfq_maker_manager_1.RfqMakerManager(configManager, rfqMakerDbUtils, chainId);
        await rfqMakerManager.initializeAsync();
        const quoteRequestor = new RefreshingQuoteRequestor_1.RefreshingQuoteRequestor(rfqMakerManager, proxiedAxiosInstance, altRfqOptions);
        const quoteServerClient = new quote_server_client_1.QuoteServerClient(proxiedAxiosInstance);
        const contractAddresses = (0, contract_addresses_1.getContractAddressesForChainOrThrow)(chainId);
        const ethersProvider = new ethers_1.providers.JsonRpcProvider(chain.rpcUrl, chainId);
        const provider = provider_utils_1.providerUtils.createWeb3Provider(chain.rpcUrl);
        const balanceChecker = new balance_checker_1.BalanceChecker(provider);
        const rfqBlockchainUtils = new rfq_blockchain_utils_1.RfqBlockchainUtils(provider, contractAddresses.exchangeProxy, balanceChecker, ethersProvider);
        const tokenMetadataManager = new TokenMetadataManager_1.TokenMetadataManager(chainId, rfqBlockchainUtils);
        const balanceCheckUtils = new rfq_blockchain_utils_1.RfqBalanceCheckUtils(balanceChecker, contractAddresses.exchangeProxy);
        const cacheClient = new cache_client_1.CacheClient(redis);
        const rfqMakerBalanceCacheService = new rfq_maker_balance_cache_service_1.RfqMakerBalanceCacheService(cacheClient, balanceCheckUtils);
        const kafkaProducer = getKafkaProducer();
        const feeTokenMetadata = (0, token_metadata_1.getTokenMetadataIfExists)(contractAddresses.etherToken, chainId);
        if (feeTokenMetadata === undefined) {
            throw new Error(`Fee token ${contractAddresses.etherToken} on chain ${chainId} could not be found!`);
        }
        const gasStationAttendant = (0, GasStationAttendantUtils_1.getGasStationAttendant)(chain, axiosInstance);
        const tokenPriceOracle = new TokenPriceOracle_1.TokenPriceOracle(axiosInstance, config_1.DEFINED_FI_API_KEY, config_1.DEFINED_FI_ENDPOINT);
        const zeroExApiClient = new ZeroExApiClient_1.ZeroExApiClient(axios_1.default.create(), config_1.ZERO_EX_API_KEY, chain);
        const feeService = new fee_service_1.FeeService(chainId, feeTokenMetadata, configManager, gasStationAttendant, tokenPriceOracle, zeroExApiClient, rfqtConfiguration.minExpiryDurationMs || constants_1.DEFAULT_MIN_EXPIRY_DURATION_MS);
        return new RfqtService_1.RfqtService(chainId, rfqMakerManager, quoteRequestor, quoteServerClient, rfqtConfiguration.minExpiryDurationMs || constants_1.DEFAULT_MIN_EXPIRY_DURATION_MS, rfqBlockchainUtils, tokenMetadataManager, contractAddresses, feeService, rfqtConfiguration.feeModelVersion || 0, rfqMakerBalanceCacheService, cacheClient, kafkaProducer, rfqtConfiguration.feeEventTopic);
    }));
    return new Map(services.map((s, i) => [chainConfigurations[i].chainId, s]));
}
exports.buildRfqtServicesAsync = buildRfqtServicesAsync;
/**
 * Creates the default Axios Request Config
 */
function getAxiosRequestConfig(timeout = DEFAULT_AXIOS_TIMEOUT) {
    return {
        httpAgent: new http_1.Agent({ keepAlive: true, timeout: constants_1.KEEP_ALIVE_TTL }),
        httpsAgent: new https_1.Agent({ keepAlive: true, timeout: constants_1.KEEP_ALIVE_TTL }),
        timeout,
    };
}
exports.getAxiosRequestConfig = getAxiosRequestConfig;
/**
 * Creates the Axios Request Config with egress proxy
 */
function getAxiosRequestConfigWithProxy() {
    const axiosRequestConfig = getAxiosRequestConfig();
    if (config_1.RFQ_PROXY_ADDRESS !== undefined && config_1.RFQ_PROXY_PORT !== undefined) {
        axiosRequestConfig.proxy = {
            host: config_1.RFQ_PROXY_ADDRESS,
            port: config_1.RFQ_PROXY_PORT,
        };
    }
    return axiosRequestConfig;
}
exports.getAxiosRequestConfigWithProxy = getAxiosRequestConfigWithProxy;
/**
 * Initialize a kafka producer if KAFKA_BROKERS is set
 */
function getKafkaProducer() {
    let kafkaProducer;
    if (config_1.KAFKA_BROKERS !== undefined) {
        const kafka = new kafkajs_1.Kafka({
            clientId: '0x-api',
            brokers: config_1.KAFKA_BROKERS,
        });
        kafkaProducer = kafka.producer();
        // tslint:disable-next-line: no-floating-promises
        kafkaProducer.connect();
    }
    return kafkaProducer;
}
//# sourceMappingURL=data:application/json;charset=utf-8;base64,eyJmaWxlIjoiL1VzZXJzL2Rhdmlkd2Fsc2gvY29kZS1sb2NhbC8weC1yZnEtYXBpL3NyYy91dGlscy9yZnF0U2VydmljZUJ1aWxkZXIudHMiLCJtYXBwaW5ncyI6Ijs7O0FBQ0EsK0RBQTZFO0FBQzdFLHVEQUE4RDtBQUM5RCxpQ0FBa0Q7QUFDbEQsbUNBQW1DO0FBQ25DLCtCQUEwQztBQUMxQyxpQ0FBNEM7QUFFNUMscUNBQTJEO0FBRTNELHNDQVVtQjtBQUNuQixpREFBbUY7QUFDbkYseUZBQXNGO0FBQ3RGLHlEQUFxRDtBQUNyRCx5REFBc0Q7QUFDdEQsaUdBQTBGO0FBRTFGLHVEQUFtRDtBQUNuRCxpREFBNkM7QUFDN0MscURBQWlEO0FBQ2pELHlFQUFvRTtBQUNwRSxxREFBaUQ7QUFDakQsK0RBQTBEO0FBQzFELGlFQUFrRjtBQUVsRiwyREFBc0Q7QUFDdEQsaUVBQThEO0FBQzlELHlEQUFzRDtBQUN0RCx1REFBb0Q7QUFJcEQsTUFBTSxxQkFBcUIsR0FBRyxHQUFHLENBQUMsQ0FBQyxLQUFLO0FBRXhDOzs7O0dBSUc7QUFDSSxLQUFLLFVBQVUsc0JBQXNCLENBQ3hDLG1CQUF3QyxFQUN4QyxlQUFnQyxFQUNoQyxLQUFZO0lBRVosTUFBTSxvQkFBb0IsR0FBRyxlQUFLLENBQUMsTUFBTSxDQUFDLDhCQUE4QixFQUFFLENBQUMsQ0FBQztJQUM1RSxNQUFNLGFBQWEsR0FBRyxlQUFLLENBQUMsTUFBTSxDQUFDLHFCQUFxQixFQUFFLENBQUMsQ0FBQztJQUM1RCxNQUFNLGFBQWEsR0FBRyxJQUFJLDhCQUFhLEVBQUUsQ0FBQztJQUMxQyxNQUFNLGFBQWEsR0FDZiwyQkFBa0IsS0FBSyxTQUFTLElBQUksMkJBQWtCLEtBQUssU0FBUztRQUNoRSxDQUFDLENBQUM7WUFDSSw2REFBNkQ7WUFDN0Qsb0VBQW9FO1lBQ3BFLFlBQVksRUFBRSwyQkFBbUI7WUFDakMsNkRBQTZEO1lBQzdELG9FQUFvRTtZQUNwRSxhQUFhLEVBQUUsMkJBQW1CO1NBQ3JDO1FBQ0gsQ0FBQyxDQUFDLFNBQVMsQ0FBQztJQUNw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QUFnQjtJQUNyQixJQUFJLGFBQXdDLENBQUM7SUFDN0MsSUFBSSxzQkFBYSxLQUFLLFNBQVMsRUFBRTtRQUM3QixNQUFNLEtBQUssR0FBRyxJQUFJLGVBQUssQ0FBQztZQUNwQixRQUFRLEVBQUUsUUFBUTtZQUNsQixPQUFPLEVBQUUsc0JBQWE7U0FDekIsQ0FBQyxDQUFDO1FBRUgsYUFBYSxHQUFHLEtBQUssQ0FBQyxRQUFRLEVBQUUsQ0FBQztRQUNqQyxpREFBaUQ7UUFDakQsYUFBYSxDQUFDLE9BQU8sRUFBRSxDQUFDO0tBQzNCO0lBQ0QsT0FBTyxhQUFhLENBQUM7QUFDekIsQ0FBQyIsIm5hbWVzIjpbXSwic291cmNlcyI6WyIvVXNlcnMvZGF2aWR3YWxzaC9jb2RlLWxvY2FsLzB4LXJmcS1hcGkvc3JjL3V0aWxzL3JmcXRTZXJ2aWNlQnVpbGRlci50cyJdLCJzb3VyY2VzQ29udGVudCI6WyJpbXBvcnQgeyBTdXBwb3J0ZWRQcm92aWRlciB9IGZyb20gJ0AweC9hc3NldC1zd2FwcGVyJztcbmltcG9ydCB7IGdldENvbnRyYWN0QWRkcmVzc2VzRm9yQ2hhaW5PclRocm93IH0gZnJvbSAnQDB4L2NvbnRyYWN0LWFkZHJlc3Nlcyc7XG5pbXBvcnQgeyBnZXRUb2tlbk1ldGFkYXRhSWZFeGlzdHMgfSBmcm9tICdAMHgvdG9rZW4tbWV0YWRhdGEnO1xuaW1wb3J0IEF4aW9zLCB7IEF4aW9zUmVxdWVzdENvbmZpZyB9IGZyb20gJ2F4aW9zJztcbmltcG9ydCB7IHByb3ZpZGVycyB9IGZyb20gJ2V0aGVycyc7XG5pbXBvcnQgeyBBZ2VudCBhcyBIdHRwQWdlbnQgfSBmcm9tICdodHRwJztcbmltcG9ydCB7IEFnZW50IGFzIEh0dHBzQWdlbnQgfSBmcm9tICdodHRwcyc7XG5pbXBvcnQgUmVkaXMgZnJvbSAnaW9yZWRpcyc7XG5pbXBvcnQgeyBLYWZrYSwgUHJvZHVjZXIgYXMgS2Fma2FQcm9kdWNlciB9IGZyb20gJ2thZmthanMnO1xuXG5pbXBvcnQge1xuICAgIEFMVF9SRlFfTU1fQVBJX0tFWSxcbiAgICBBTFRfUkZRX01NX1BST0ZJTEUsXG4gICAgQ2hhaW5Db25maWd1cmF0aW9ucyxcbiAgICBERUZJTkVEX0ZJX0FQSV9LRVksXG4gICAgREVGSU5FRF9GSV9FTkRQT0lOVCxcbiAgICBLQUZLQV9CUk9LRVJTLFxuICAgIFJGUV9QUk9YWV9BRERSRVNTLFxuICAgIFJGUV9QUk9YWV9QT1JULFxuICAgIFpFUk9fRVhfQVBJX0tFWSxcbn0gZnJvbSAnLi4vY29uZmlnJztcbmltcG9ydCB7IERFRkFVTFRfTUlOX0VYUElSWV9EVVJBVElPTl9NUywgS0VFUF9BTElWRV9UVEwgfSBmcm9tICcuLi9jb3JlL2NvbnN0YW50cyc7XG5pbXBvcnQgeyBSZWZyZXNoaW5nUXVvdGVSZXF1ZXN0b3IgfSBmcm9tICcuLi9xdW90ZVJlcXVlc3Rvci9SZWZyZXNoaW5nUXVvdGVSZXF1ZXN0b3InO1xuaW1wb3J0IHsgRmVlU2VydmljZSB9IGZyb20gJy4uL3NlcnZpY2VzL2ZlZV9zZXJ2aWNlJztcbmltcG9ydCB7IFJmcXRTZXJ2aWNlIH0gZnJvbSAnLi4vc2VydmljZXMvUmZxdFNlcnZpY2UnO1xuaW1wb3J0IHsgUmZxTWFrZXJCYWxhbmNlQ2FjaGVTZXJ2aWNlIH0gZnJvbSAnLi4vc2VydmljZXMvcmZxX21ha2VyX2JhbGFuY2VfY2FjaGVfc2VydmljZSc7XG5cbmltcG9ydCB7IEJhbGFuY2VDaGVja2VyIH0gZnJvbSAnLi9iYWxhbmNlX2NoZWNrZXInO1xuaW1wb3J0IHsgQ2FjaGVDbGllbnQgfSBmcm9tICcuL2NhY2hlX2NsaWVudCc7XG5pbXBvcnQgeyBDb25maWdNYW5hZ2VyIH0gZnJvbSAnLi9jb25maWdfbWFuYWdlcic7XG5pbXBvcnQgeyBnZXRHYXNTdGF0aW9uQXR0ZW5kYW50IH0gZnJvbSAnLi9HYXNTdGF0aW9uQXR0ZW5kYW50VXRpbHMnO1xuaW1wb3J0IHsgcHJvdmlkZXJVdGlscyB9IGZyb20gJy4vcHJvdmlkZXJfdXRpbHMnO1xuaW1wb3J0IHsgUXVvdGVTZXJ2ZXJDbGllbnQgfSBmcm9tICcuL3F1b3RlX3NlcnZlcl9jbGllbnQnO1xuaW1wb3J0IHsgUmZxQmFsYW5jZUNoZWNrVXRpbHMsIFJmcUJsb2NrY2hhaW5VdGlscyB9IGZyb20gJy4vcmZxX2Jsb2NrY2hhaW5fdXRpbHMnO1xuaW1wb3J0IHsgUmZxTWFrZXJEYlV0aWxzIH0gZnJvbSAnLi9yZnFfbWFrZXJfZGJfdXRpbHMnO1xuaW1wb3J0IHsgUmZxTWFrZXJNYW5hZ2VyIH0gZnJvbSAnLi9yZnFfbWFrZXJfbWFuYWdlcic7XG5pbXBvcnQgeyBUb2tlbk1ldGFkYXRhTWFuYWdlciB9IGZyb20gJy4vVG9rZW5NZXRhZGF0YU1hbmFnZXInO1xuaW1wb3J0IHsgVG9rZW5QcmljZU9yYWNsZSB9IGZyb20gJy4vVG9rZW5QcmljZU9yYWNsZSc7XG5pbXBvcnQgeyBaZXJvRXhBcGlDbGllbnQgfSBmcm9tICcuL1plcm9FeEFwaUNsaWVudCc7XG5cbmV4cG9ydCB0eXBlIFJmcXRTZXJ2aWNlcyA9IE1hcDxudW1iZXIsIFJmcXRTZXJ2aWNlPjtcblxuY29uc3QgREVGQVVMVF9BWElPU19USU1FT1VUID0gNjAwOyAvLyBtc1xuXG4vKipcbiAqIENyZWF0ZXMgYW4gUkZRVCBTZXJ2aWNlIGZvciBlYWNoIGNoYWluIHByZXNlbnQgaW4gYENoYWluQ29uZmlndXJhdGlvbnNgLlxuICpcbiAqIEludGVuZGVkIGZvciB1c2UgYnkgdGhlIHRvcC1sZXZlbCBydW5uZXJzLlxuICovXG5leHBvcnQgYXN5bmMgZnVuY3Rpb24gYnVpbGRSZnF0U2VydmljZXNBc3luYyhcbiAgICBjaGFpbkNvbmZpZ3VyYXRpb25zOiBDaGFpbkNvbmZpZ3VyYXRpb25zLFxuICAgIHJmcU1ha2VyRGJVdGlsczogUmZxTWFrZXJEYlV0aWxzLFxuICAgIHJlZGlzOiBSZWRpcyxcbik6IFByb21pc2U8UmZxdFNlcnZpY2VzPiB7XG4gICAgY29uc3QgcHJveGllZEF4aW9zSW5zdGFuY2UgPSBBeGlvcy5jcmVhdGUoZ2V0QXhpb3NSZXF1ZXN0Q29uZmlnV2l0aFByb3h5KCkpO1xuICAgIGNvbnN0IGF4aW9zSW5zdGFuY2UgPSBBeGlvcy5jcmVhdGUoZ2V0QXhpb3NSZXF1ZXN0Q29uZmlnKCkpO1xuICAgIGNvbnN0IGNvbmZpZ01hbmFnZXIgPSBuZXcgQ29uZmlnTWFuYWdlcigpO1xuICAgIGNvbnN0IGFsdFJmcU9wdGlvbnMgPVxuICAgICAgICBBTFRfUkZRX01NX0FQSV9LRVkgIT09IHVuZGVmaW5lZCAmJiBBTFRfUkZRX01NX1BST0ZJTEUgIT09IHVuZGVmaW5lZFxuICAgICAgICAgICAgPyB7XG4gICAgICAgICAgICAgICAgICAvLyAkZXNsaW50LWZpeC1tZSBodHRwczovL2dpdGh1Yi5jb20vcmhpbm9kYXZpZC9lc2xpbnQtZml4LW1lXG4gICAgICAgICAgICAgICAgICAvLyBlc2xpbnQtZGlzYWJsZS1uZXh0LWxpbmUgQHR5cGVzY3JpcHQtZXNsaW50L25vLW5vbi1udWxsLWFzc2VydGlvblxuICAgICAgICAgICAgICAgICAgYWx0UmZxQXBpS2V5OiBBTFRfUkZRX01NX0FQSV9LRVkhLFxuICAgICAgICAgICAgICAgICAgLy8gJGVzbGludC1maXgtbWUgaHR0cHM6Ly9naXRodWIuY29tL3JoaW5vZGF2aWQvZXNsaW50LWZpeC1tZVxuICAgICAgICAgICAgICAgICAgLy8gZXNsaW50LWRpc2FibGUtbmV4dC1saW5lIEB0eXBlc2NyaXB0LWVzbGludC9uby1ub24tbnVsbC1hc3NlcnRpb25cbiAgICAgICAgICAgICAgICAgIGFsdFJmcVByb2ZpbGU6IEFMVF9SRlFfTU1fUFJPRklMRSEsXG4gICAgICAgICAgICAgIH1cbiAgICAgICAgICAgIDogdW5kZWZpbmVkO1xuICAgIGNvbnN0IHNlcnZpY2VzID0gYXdhaXQgUHJvbWlzZS5hbGwoXG4gICAgICAgIGNoYWluQ29uZmlndXJhdGlvbnMubWFwKGFzeW5jIChjaGFpbikgPT4ge1xuICAgICAgICAgICAgY29uc3QgeyByZnF0OiByZnF0Q29uZmlndXJhdGlvbiwgY2hhaW5JZCB9ID0gY2hhaW47XG4gICAgICAgICAgICBpZiAoIXJmcXRDb25maWd1cmF0aW9uKSB7XG4gICAgICAgICAgICAgICAgdGhyb3cgbmV3IEVycm9yKGBSRlF0IFNlcnZpY2UgZm9yIGNoYWluICR7Y2hhaW5JZH0gZG9lcyBub3QgZXhpc3RgKTtcbiAgICAgICAgICAgIH1cblxuICAgICAgICAgICAgY29uc3QgcmZxTWFrZXJNYW5hZ2VyID0gbmV3IFJmcU1ha2VyTWFuYWdlcihjb25maWdNYW5hZ2VyLCByZnFNYWtlckRiVXRpbHMsIGNoYWluSWQpO1xuICAgICAgICAgICAgYXdhaXQgcmZxTWFrZXJNYW5hZ2VyLmluaXRpYWxpemVBc3luYygpO1xuICAgICAgICAgICAgY29uc3QgcXVvdGVSZXF1ZXN0b3IgPSBuZXcgUmVmcmVzaGluZ1F1b3RlUmVxdWVzdG9yKHJmcU1ha2VyTWFuYWdlciwgcHJveGllZEF4aW9zSW5zdGFuY2UsIGFsdFJmcU9wdGlvbnMpO1xuICAgICAgICAgICAgY29uc3QgcXVvdGVTZXJ2ZXJDbGllbnQgPSBuZXcgUXVvdGVTZXJ2ZXJDbGllbnQocHJveGllZEF4aW9zSW5zdGFuY2UpO1xuICAgICAgICAgICAgY29uc3QgY29udHJhY3RBZGRyZXNzZXMgPSBnZXRDb250cmFjdEFkZHJlc3Nlc0ZvckNoYWluT3JUaHJvdyhjaGFpbklkKTtcbiAgICAgICAgICAgIGNvbnN0IGV0aGVyc1Byb3ZpZGVyID0gbmV3IHByb3ZpZGVycy5Kc29uUnBjUHJvdmlkZXIoY2hhaW4ucnBjVXJsLCBjaGFpbklkKTtcbiAgICAgICAgICAgIGNvbnN0IHByb3ZpZGVyOiBTdXBwb3J0ZWRQcm92aWRlciA9IHByb3ZpZGVyVXRpbHMuY3JlYXRlV2ViM1Byb3ZpZGVyKGNoYWluLnJwY1VybCk7XG5cbiAgICAgICAgICAgIGNvbnN0IGJhbGFuY2VDaGVja2VyID0gbmV3IEJhbGFuY2VDaGVja2VyKHByb3ZpZGVyKTtcbiAgICAgICAgICAgIGNvbnN0IHJmcUJsb2NrY2hhaW5VdGlscyA9IG5ldyBSZnFCbG9ja2NoYWluVXRpbHMoXG4gICAgICAgICAgICAgICAgcHJvdmlkZXIsXG4gICAgICAgICAgICAgICAgY29udHJhY3RBZGRyZXNzZXMuZXhjaGFuZ2VQcm94eSxcbiAgICAgICAgICAgICAgICBiYWxhbmNlQ2hlY2tlcixcbiAgICAgICAgICAgICAgICBldGhlcnNQcm92aWRlcixcbiAgICAgICAgICAgICk7XG4gICAgICAgICAgICBjb25zdCB0b2tlbk1ldGFkYXRhTWFuYWdlciA9IG5ldyBUb2tlbk1ldGFkYXRhTWFuYWdlcihjaGFpbklkLCByZnFCbG9ja2NoYWluVXRpbHMpO1xuXG4gICAgICAgICAgICBjb25zdCBiYWxhbmNlQ2hlY2tVdGlscyA9IG5ldyBSZnFCYWxhbmNlQ2hlY2tVdGlscyhiYWxhbmNlQ2hlY2tlciwgY29udHJhY3RBZGRyZXNzZXMuZXhjaGFuZ2VQcm94eSk7XG4gICAgICAgICAgICBjb25zdCBjYWNoZUNsaWVudCA9IG5ldyBDYWNoZUNsaWVudChyZWRpcyk7XG4gICAgICAgICAgICBjb25zdCByZnFNYWtlckJhbGFuY2VDYWNoZVNlcnZpY2UgPSBuZXcgUmZxTWFrZXJCYWxhbmNlQ2FjaGVTZXJ2aWNlKGNhY2hlQ2xpZW50LCBiYWxhbmNlQ2hlY2tVdGlscyk7XG5cbiAgICAgICAgICAgIGNvbnN0IGthZmthUHJvZHVjZXIgPSBnZXRLYWZrYVByb2R1Y2VyKCk7XG5cbiAgICAgICAgICAgIGNvbnN0IGZlZVRva2VuTWV0YWRhdGEgPSBnZXRUb2tlbk1ldGFkYXRhSWZFeGlzdHMoY29udHJhY3RBZGRyZXNzZXMuZXRoZXJUb2tlbiwgY2hhaW5JZCk7XG4gICAgICAgICAgICBpZiAoZmVlVG9rZW5NZXRhZGF0YSA9PT0gdW5kZWZpbmVkKSB7XG4gICAgICAgICAgICAgICAgdGhyb3cgbmV3IEVycm9yKGBGZWUgdG9rZW4gJHtjb250cmFjdEFkZHJlc3Nlcy5ldGhlclRva2VufSBvbiBjaGFpbiAke2NoYWluSWR9IGNvdWxkIG5vdCBiZSBmb3VuZCFgKTtcbiAgICAgICAgICAgIH1cblxuICAgICAgICAgICAgY29uc3QgZ2FzU3RhdGlvbkF0dGVuZGFudCA9IGdldEdhc1N0YXRpb25BdHRlbmRhbnQoY2hhaW4sIGF4aW9zSW5zdGFuY2UpO1xuICAgICAgICAgICAgY29uc3QgdG9rZW5QcmljZU9yYWNsZSA9IG5ldyBUb2tlblByaWNlT3JhY2xlKGF4aW9zSW5zdGFuY2UsIERFRklORURfRklfQVBJX0tFWSwgREVGSU5FRF9GSV9FTkRQT0lOVCk7XG4gICAgICAgICAgICBjb25zdCB6ZXJvRXhBcGlDbGllbnQgPSBuZXcgWmVyb0V4QXBpQ2xpZW50KEF4aW9zLmNyZWF0ZSgpLCBaRVJPX0VYX0FQSV9LRVksIGNoYWluKTtcbiAgICAgICAgICAgIGNvbnN0IGZlZVNlcnZpY2UgPSBuZXcgRmVlU2VydmljZShcbiAgICAgICAgICAgICAgICBjaGFpbklkLFxuICAgICAgICAgICAgICAgIGZlZVRva2VuTWV0YWRhdGEsXG4gICAgICAgICAgICAgICAgY29uZmlnTWFuYWdlcixcbiAgICAgICAgICAgICAgICBnYXNTdGF0aW9uQXR0ZW5kYW50LFxuICAgICAgICAgICAgICAgIHRva2VuUHJpY2VPcmFjbGUsXG4gICAgICAgICAgICAgICAgemVyb0V4QXBpQ2xpZW50LFxuICAgICAgICAgICAgICAgIHJmcXRDb25maWd1cmF0aW9uLm1pbkV4cGlyeUR1cmF0aW9uTXMgfHwgREVGQVVMVF9NSU5fRVhQSVJZX0RVUkFUSU9OX01TLFxuICAgICAgICAgICAgKTtcblxuICAgICAgICAgICAgcmV0dXJuIG5ldyBSZnF0U2VydmljZShcbiAgICAgICAgICAgICAgICBjaGFpbklkLFxuICAgICAgICAgICAgICAgIHJmcU1ha2VyTWFuYWdlcixcbiAgICAgICAgICAgICAgICBxdW90ZVJlcXVlc3RvcixcbiAgICAgICAgICAgICAgICBxdW90ZVNlcnZlckNsaWVudCxcbiAgICAgICAgICAgICAgICByZnF0Q29uZmlndXJhdGlvbi5taW5FeHBpcnlEdXJhdGlvbk1zIHx8IERFRkFVTFRfTUlOX0VYUElSWV9EVVJBVElPTl9NUyxcbiAgICAgICAgICAgICAgICByZnFCbG9ja2NoYWluVXRpbHMsXG4gICAgICAgICAgICAgICAgdG9rZW5NZXRhZGF0YU1hbmFnZXIsXG4gICAgICAgICAgICAgICAgY29udHJhY3RBZGRyZXNzZXMsXG4gICAgICAgICAgICAgICAgZmVlU2VydmljZSxcbiAgICAgICAgICAgICAgICByZnF0Q29uZmlndXJhdGlvbi5mZWVNb2RlbFZlcnNpb24gfHwgMCxcbiAgICAgICAgICAgICAgICByZnFNYWtlckJhbGFuY2VDYWNoZVNlcnZpY2UsXG4gICAgICAgICAgICAgICAgY2FjaGVDbGllbnQsXG4gICAgICAgICAgICAgICAga2Fma2FQcm9kdWNlcixcbiAgICAgICAgICAgICAgICByZnF0Q29uZmlndXJhdGlvbi5mZWVFdmVudFRvcGljLFxuICAgICAgICAgICAgKTtcbiAgICAgICAgfSksXG4gICAgKTtcbiAgICByZXR1cm4gbmV3IE1hcChzZXJ2aWNlcy5tYXAoKHMsIGkpID0+IFtjaGFpbkNvbmZpZ3VyYXRpb25zW2ldLmNoYWluSWQsIHNdKSk7XG59XG5cbi8qKlxuICogQ3JlYXRlcyB0aGUgZGVmYXVsdCBBeGlvcyBSZXF1ZXN0IENvbmZpZ1xuICovXG5leHBvcnQgZnVuY3Rpb24gZ2V0QXhpb3NSZXF1ZXN0Q29uZmlnKHRpbWVvdXQ6IG51bWJlciA9IERFRkFVTFRfQVhJT1NfVElNRU9VVCk6IEF4aW9zUmVxdWVzdENvbmZpZyB7XG4gICAgcmV0dXJuIHtcbiAgICAgICAgaHR0cEFnZW50OiBuZXcgSHR0cEFnZW50KHsga2VlcEFsaXZlOiB0cnVlLCB0aW1lb3V0OiBLRUVQX0FMSVZFX1RUTCB9KSxcbiAgICAgICAgaHR0cHNBZ2VudDogbmV3IEh0dHBzQWdlbnQoeyBrZWVwQWxpdmU6IHRydWUsIHRpbWVvdXQ6IEtFRVBfQUxJVkVfVFRMIH0pLFxuICAgICAgICB0aW1lb3V0LFxuICAgIH07XG59XG5cbi8qKlxuICogQ3JlYXRlcyB0aGUgQXhpb3MgUmVxdWVzdCBDb25maWcgd2l0aCBlZ3Jlc3MgcHJveHlcbiAqL1xuZXhwb3J0IGZ1bmN0aW9uIGdldEF4aW9zUmVxdWVzdENvbmZpZ1dpdGhQcm94eSgpOiBBeGlvc1JlcXVlc3RDb25maWcge1xuICAgIGNvbnN0IGF4aW9zUmVxdWVzdENvbmZpZzogQXhpb3NSZXF1ZXN0Q29uZmlnID0gZ2V0QXhpb3NSZXF1ZXN0Q29uZmlnKCk7XG4gICAgaWYgKFJGUV9QUk9YWV9BRERSRVNTICE9PSB1bmRlZmluZWQgJiYgUkZRX1BST1hZX1BPUlQgIT09IHVuZGVmaW5lZCkge1xuICAgICAgICBheGlvc1JlcXVlc3RDb25maWcucHJveHkgPSB7XG4gICAgICAgICAgICBob3N0OiBSRlFfUFJPWFlfQUREUkVTUyxcbiAgICAgICAgICAgIHBvcnQ6IFJGUV9QUk9YWV9QT1JULFxuICAgICAgICB9O1xuICAgIH1cblxuICAgIHJldHVybiBheGlvc1JlcXVlc3RDb25maWc7XG59XG5cbi8qKlxuICogSW5pdGlhbGl6ZSBhIGthZmthIHByb2R1Y2VyIGlmIEtBRktBX0JST0tFUlMgaXMgc2V0XG4gKi9cbmZ1bmN0aW9uIGdldEthZmthUHJvZHVjZXIoKTogS2Fma2FQcm9kdWNlciB8IHVuZGVmaW5lZCB7XG4gICAgbGV0IGthZmthUHJvZHVjZXI6IEthZmthUHJvZHVjZXIgfCB1bmRlZmluZWQ7XG4gICAgaWYgKEtBRktBX0JST0tFUlMgIT09IHVuZGVmaW5lZCkge1xuICAgICAgICBjb25zdCBrYWZrYSA9IG5ldyBLYWZrYSh7XG4gICAgICAgICAgICBjbGllbnRJZDogJzB4LWFwaScsXG4gICAgICAgICAgICBicm9rZXJzOiBLQUZLQV9CUk9LRVJTLFxuICAgICAgICB9KTtcblxuICAgICAgICBrYWZrYVByb2R1Y2VyID0ga2Fma2EucHJvZHVjZXIoKTtcbiAgICAgICAgLy8gdHNsaW50OmRpc2FibGUtbmV4dC1saW5lOiBuby1mbG9hdGluZy1wcm9taXNlc1xuICAgICAgICBrYWZrYVByb2R1Y2VyLmNvbm5lY3QoKTtcbiAgICB9XG4gICAgcmV0dXJuIGthZmthUHJvZHVjZXI7XG59XG4iXSwidmVyc2lvbiI6M30=