b7d452cf7822d574a8fcbb70b40b27b5
"use strict";
Object.defineProperty(exports, "__esModule", { value: true });
const utils_1 = require("@0x/utils");
const chai_1 = require("chai");
const ts_mockito_1 = require("ts-mockito");
const RfqmV2TransactionSubmissionEntity_1 = require("../../src/entities/RfqmV2TransactionSubmissionEntity");
const types_1 = require("../../src/entities/types");
const GasOracle_1 = require("../../src/utils/GasOracle");
const GasStationAttendantEthereum_1 = require("../../src/utils/GasStationAttendantEthereum");
const rfqm_gas_estimate_utils_1 = require("../../src/utils/rfqm_gas_estimate_utils");
const rfq_blockchain_utils_1 = require("../../src/utils/rfq_blockchain_utils");
const SubmissionContext_1 = require("../../src/utils/SubmissionContext");
let gasOracleMock;
describe('GasStationAttendantEthereum', () => {
    beforeAll(() => {
        gasOracleMock = (0, ts_mockito_1.mock)(GasOracle_1.GasOracle);
    });
    describe('getWorkerBalanceForTradeAsync', () => {
        it('gets the balance to trade', async () => {
            (0, ts_mockito_1.when)(gasOracleMock.getBaseFeePerGasWeiAsync()).thenResolve(new utils_1.BigNumber(1000));
            (0, ts_mockito_1.when)(gasOracleMock.getMaxPriorityFeePerGasWeiAsync('instant')).thenResolve(new utils_1.BigNumber(666));
            const attendant = new GasStationAttendantEthereum_1.GasStationAttendantEthereum((0, ts_mockito_1.instance)(gasOracleMock));
            const workerGasToTrade = await attendant.getWorkerBalanceForTradeAsync();
            // Base fee is 1000. With 6 10% increases = 1000 * (1.1)^ 6 = 1771.561
            // Instant tip is 666
            // Gas estimate matches the one used in the algorithm
            const gasEstimate = (0, rfqm_gas_estimate_utils_1.calculateGasEstimate)('0x7fc66500c84a76ad7e9c93437bfc5ac33e2ddae9', '0xa0b86991c6218b36c1d19d4a2e9eb0ce3606eb48', 'otc', true);
            (0, chai_1.expect)(workerGasToTrade.toPrecision(2).toString()).to.equal(
            // tslint:disable-next-line: custom-no-magic-numbers
            new utils_1.BigNumber(1771.561).plus(666).times(gasEstimate).toPrecision(2).toString());
        });
    });
    describe('getExpectedTransactionGasRateAsync', () => {
        it('estimates the transaction gas rate', async () => {
            (0, ts_mockito_1.when)(gasOracleMock.getBaseFeePerGasWeiAsync()).thenResolve(new utils_1.BigNumber(1000));
            const attendant = new GasStationAttendantEthereum_1.GasStationAttendantEthereum((0, ts_mockito_1.instance)(gasOracleMock));
            const gasRate = await attendant.getExpectedTransactionGasRateAsync();
            // Base fee is 1000
            // Tip estimate is
            const tipEstimate = new utils_1.BigNumber(2750000000);
            (0, chai_1.expect)(gasRate.toString()).to.equal(
            // tslint:disable-next-line: custom-no-magic-numbers
            new utils_1.BigNumber(1000).plus(tipEstimate).toString());
        });
    });
    describe('getNextBidAsync', () => {
        it('gets an initial bid when there are no existing transactions', async () => {
            var _a, _b;
            (0, ts_mockito_1.when)(gasOracleMock.getBaseFeePerGasWeiAsync()).thenResolve(new utils_1.BigNumber(1000));
            const attendant = new GasStationAttendantEthereum_1.GasStationAttendantEthereum((0, ts_mockito_1.instance)(gasOracleMock));
            const gasRate = await attendant.getNextBidAsync(null);
            const initialMaxPriorityFeePerGasWei = new utils_1.BigNumber(2000000000);
            const initialMaxFeePerGasWei = new utils_1.BigNumber(/* base fee */ 1000)
                .times(2)
                .plus(initialMaxPriorityFeePerGasWei);
            (0, chai_1.expect)((_a = gasRate === null || gasRate === void 0 ? void 0 : gasRate.maxPriorityFeePerGas) === null || _a === void 0 ? void 0 : _a.toString()).to.equal(initialMaxPriorityFeePerGasWei.toString());
            (0, chai_1.expect)((_b = gasRate === null || gasRate === void 0 ? void 0 : gasRate.maxFeePerGas) === null || _b === void 0 ? void 0 : _b.toString()).to.equal(initialMaxFeePerGasWei.toString());
        });
        it('calculates a resubmit bid when the base fee rises', async () => {
            var _a, _b;
            (0, ts_mockito_1.when)(gasOracleMock.getBaseFeePerGasWeiAsync()).thenResolve(new utils_1.BigNumber(1000));
            (0, ts_mockito_1.when)(gasOracleMock.getMaxPriorityFeePerGasWeiAsync('instant')).thenResolve(new utils_1.BigNumber(666));
            const transaction1 = new RfqmV2TransactionSubmissionEntity_1.RfqmV2TransactionSubmissionEntity({
                transactionHash: '0x1',
                from: '0xfrom',
                to: '0xto',
                orderHash: '0xOrderhash',
                nonce: 0,
                maxFeePerGas: new utils_1.BigNumber(3),
                maxPriorityFeePerGas: new utils_1.BigNumber(2),
                type: types_1.RfqmTransactionSubmissionType.Trade,
            });
            const submissionContext = new SubmissionContext_1.SubmissionContext((0, ts_mockito_1.instance)((0, ts_mockito_1.mock)(rfq_blockchain_utils_1.RfqBlockchainUtils)), [transaction1]);
            const attendant = new GasStationAttendantEthereum_1.GasStationAttendantEthereum((0, ts_mockito_1.instance)(gasOracleMock));
            const gasRate = await attendant.getNextBidAsync(submissionContext);
            // Previous submission gas prices were 2 tip, 3 max
            // new tip = 2 * 1.5 = 3
            // Base fee is now 1000
            // total = 2 x base fee + tip
            // total = 2 * 1000 + 3
            (0, chai_1.expect)((_a = gasRate === null || gasRate === void 0 ? void 0 : gasRate.maxPriorityFeePerGas) === null || _a === void 0 ? void 0 : _a.toString()).to.equal(new utils_1.BigNumber(3).toString());
            (0, chai_1.expect)((_b = gasRate === null || gasRate === void 0 ? void 0 : gasRate.maxFeePerGas) === null || _b === void 0 ? void 0 : _b.toString()).to.equal(new utils_1.BigNumber(2003).toString());
        });
        it('calculates a resubmit bid with the minimum max fee per gas increase', async () => {
            var _a, _b;
            (0, ts_mockito_1.when)(gasOracleMock.getBaseFeePerGasWeiAsync()).thenResolve(new utils_1.BigNumber(0));
            (0, ts_mockito_1.when)(gasOracleMock.getMaxPriorityFeePerGasWeiAsync('instant')).thenResolve(new utils_1.BigNumber(666));
            const transaction1 = new RfqmV2TransactionSubmissionEntity_1.RfqmV2TransactionSubmissionEntity({
                transactionHash: '0x1',
                from: '0xfrom',
                to: '0xto',
                orderHash: '0xOrderhash',
                nonce: 0,
                maxFeePerGas: new utils_1.BigNumber(2002),
                maxPriorityFeePerGas: new utils_1.BigNumber(2),
                type: types_1.RfqmTransactionSubmissionType.Trade,
            });
            const submissionContext = new SubmissionContext_1.SubmissionContext((0, ts_mockito_1.instance)((0, ts_mockito_1.mock)(rfq_blockchain_utils_1.RfqBlockchainUtils)), [transaction1]);
            const attendant = new GasStationAttendantEthereum_1.GasStationAttendantEthereum((0, ts_mockito_1.instance)(gasOracleMock));
            const gasRate = await attendant.getNextBidAsync(submissionContext);
            // Previous submission gas prices were 2 tip, 3 max
            // new tip = 2 * 1.5 = 3
            // Base fee is now 0, so max fee must go up by 10% so the node
            // accepts the transacion
            // old max fee per gas * 110% = 2002 * 1.1 = 2202.2
            (0, chai_1.expect)((_a = gasRate === null || gasRate === void 0 ? void 0 : gasRate.maxPriorityFeePerGas) === null || _a === void 0 ? void 0 : _a.toString()).to.equal(new utils_1.BigNumber(3).toString());
            (0, chai_1.expect)((_b = gasRate === null || gasRate === void 0 ? void 0 : gasRate.maxFeePerGas) === null || _b === void 0 ? void 0 : _b.toString()).to.equal(new utils_1.BigNumber(2202.2).integerValue(utils_1.BigNumber.ROUND_CEIL).toString());
        });
    });
});
//# sourceMappingURL=data:application/json;charset=utf-8;base64,eyJmaWxlIjoiL1VzZXJzL2Rhdmlkd2Fsc2gvY29kZS1sb2NhbC8weC1yZnEtYXBpL3Rlc3QvdXRpbHMvR2FzU3RhdGlvbkF0dGVuZGFudEV0aGVyZXVtVGVzdC50cyIsIm1hcHBpbmdzIjoiOztBQUFBLHFDQUFzQztBQUN0QywrQkFBOEI7QUFDOUIsMkNBQWtEO0FBRWxELDRHQUF5RztBQUN6RyxvREFBeUU7QUFDekUseURBQXNEO0FBQ3RELDZGQUEwRjtBQUMxRixxRkFBK0U7QUFDL0UsK0VBQTBFO0FBQzFFLHlFQUFzRTtBQUV0RSxJQUFJLGFBQXdCLENBQUM7QUFFN0IsUUFBUSxDQUFDLDZCQUE2QixFQUFFLEdBQUcsRUFBRTtJQUN6QyxTQUFTLENBQUMsR0FBRyxFQUFFO1FBQ1gsYUFBYSxHQUFHLElBQUEsaUJBQUksRUFBQyxxQkFBUyxDQUFDLENBQUM7SUFDcEMsQ0FBQyxDQUFDLENBQUM7SUFFSCxRQUFRLENBQUMsK0JBQStCLEVBQUUsR0FBRyxFQUFFO1FBQzNDLEVBQUUsQ0FBQywyQkFBMkIsRUFBRSxLQUFLLElBQUksRUFBRTtZQUN2QyxJQUFBLGlCQUFJLEVBQUMsYUFBYSxDQUFDLHdCQUF3QixFQUFFLENBQUMsQ0FBQyxXQUFXLENBQUMsSUFBSSxpQkFBUyxDQUFDLElBQUksQ0FBQyxDQUFDLENBQUM7WUFDaEYsSUFBQSxpQkFBSSxFQUFDLGFBQWEsQ0FBQywrQkFBK0IsQ0FBQyxTQUFTLENBQUMsQ0FBQyxDQUFDLFdBQVcsQ0FBQyxJQUFJLGlCQUFTLENBQUMsR0FBRyxDQUFDLENBQUMsQ0FBQztZQUUvRixNQUFNLFNBQVMsR0FBRyxJQUFJLHlEQUEyQixDQUFDLElBQUEscUJBQVEsRUFBQyxhQUFhLENBQUMsQ0FBQyxDQUFDO1lBRTNFLE1BQU0sZ0JBQWdCLEdBQUcsTUFBTSxTQUFTLENBQUMsNkJBQTZCLEVBQUUsQ0FBQztZQUV6RSxzRUFBc0U7WUFDdEUscUJBQXFCO1lBQ3JCLHFEQUFxRDtZQUNyRCxNQUFNLFdBQVcsR0FBRyxJQUFBLDhDQUFvQixFQUNwQyw0Q0FBNEMsRUFD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QUMsYUFBYSxDQUFDLENBQUMsQ0FBQztZQUMzRSxNQUFNLE9BQU8sR0FBRyxNQUFNLFNBQVMsQ0FBQyxlQUFlLENBQUMsaUJBQWlCLENBQUMsQ0FBQztZQUVuRSxtREFBbUQ7WUFDbkQsd0JBQXdCO1lBRXhCLDhEQUE4RDtZQUM5RCx5QkFBeUI7WUFDekIsbURBQW1EO1lBQ25ELElBQUEsYUFBTSxFQUFDLE1BQUEsT0FBTyxhQUFQLE9BQU8sdUJBQVAsT0FBTyxDQUFFLG9CQUFvQiwwQ0FBRSxRQUFRLEVBQUUsQ0FBQyxDQUFDLEVBQUUsQ0FBQyxLQUFLLENBQUMsSUFBSSxpQkFBUyxDQUFDLENBQUMsQ0FBQyxDQUFDLFFBQVEsRUFBRSxDQUFDLENBQUM7WUFDeEYsSUFBQSxhQUFNLEVBQUMsTUFBQSxPQUFPLGFBQVAsT0FBTyx1QkFBUCxPQUFPLENBQUUsWUFBWSwwQ0FBRSxRQUFRLEVBQUUsQ0FBQyxDQUFDLEVBQUUsQ0FBQyxLQUFLLENBQzlDLElBQUksaUJBQVMsQ0FBQyxNQUFNLENBQUMsQ0FBQyxZQUFZLENBQUMsaUJBQVMsQ0FBQyxVQUFVLENBQUMsQ0FBQyxRQUFRLEVBQUUsQ0FDdEUsQ0FBQztRQUNOLENBQUMsQ0FBQyxDQUFDO0lBQ1AsQ0FBQyxDQUFDLENBQUM7QUFDUCxDQUFDLENBQUMsQ0FBQyIsIm5hbWVzIjpbXSwic291cmNlcyI6WyIvVXNlcnMvZGF2aWR3YWxzaC9jb2RlLWxvY2FsLzB4LXJmcS1hcGkvdGVzdC91dGlscy9HYXNTdGF0aW9uQXR0ZW5kYW50RXRoZXJldW1UZXN0LnRzIl0sInNvdXJjZXNDb250ZW50IjpbImltcG9ydCB7IEJpZ051bWJlciB9IGZyb20gJ0AweC91dGlscyc7XG5pbXBvcnQgeyBleHBlY3QgfSBmcm9tICdjaGFpJztcbmltcG9ydCB7IGluc3RhbmNlLCBtb2NrLCB3aGVuIH0gZnJvbSAndHMtbW9ja2l0byc7XG5cbmltcG9ydCB7IFJmcW1WMlRyYW5zYWN0aW9uU3VibWlzc2lvbkVudGl0eSB9IGZyb20gJy4uLy4uL3NyYy9lbnRpdGllcy9SZnFtVjJUcmFuc2FjdGlvblN1Ym1pc3Npb25FbnRpdHknO1xuaW1wb3J0IHsgUmZxbVRyYW5zYWN0aW9uU3VibWlzc2lvblR5cGUgfSBmcm9tICcuLi8uLi9zcmMvZW50aXRpZXMvdHlwZXMnO1xuaW1wb3J0IHsgR2FzT3JhY2xlIH0gZnJvbSAnLi4vLi4vc3JjL3V0aWxzL0dhc09yYWNsZSc7XG5pbXBvcnQgeyBHYXNTdGF0aW9uQXR0ZW5kYW50RXRoZXJldW0gfSBmcm9tICcuLi8uLi9zcmMvdXRpbHMvR2FzU3RhdGlvbkF0dGVuZGFudEV0aGVyZXVtJztcbmltcG9ydCB7IGNhbGN1bGF0ZUdhc0VzdGltYXRlIH0gZnJvbSAnLi4vLi4vc3JjL3V0aWxzL3JmcW1fZ2FzX2VzdGltYXRlX3V0aWxzJztcbmltcG9ydCB7IFJmcUJsb2NrY2hhaW5VdGlscyB9IGZyb20gJy4uLy4uL3NyYy91dGlscy9yZnFfYmxvY2tjaGFpbl91dGlscyc7XG5pbXBvcnQgeyBTdWJtaXNzaW9uQ29udGV4dCB9IGZyb20gJy4uLy4uL3NyYy91dGlscy9TdWJtaXNzaW9uQ29udGV4dCc7XG5cbmxldCBnYXNPcmFjbGVNb2NrOiBHYXNPcmFjbGU7XG5cbmRlc2NyaWJlKCdHYXNTdGF0aW9uQXR0ZW5kYW50RXRoZXJldW0nLCAoKSA9PiB7XG4gICAgYmVmb3JlQWxsKCgpID0+IHtcbiAgICAgICAgZ2FzT3JhY2xlTW9jayA9IG1vY2soR2FzT3JhY2xlKTtcbiAgICB9KTtcblxuICAgIGRlc2NyaWJlKCdnZXRXb3JrZXJCYWxhbmNlRm9yVHJhZGVBc3luYycsICgpID0+IHtcbiAgICAgICAgaXQoJ2dldHMgdGhlIGJhbGFuY2UgdG8gdHJhZGUnLCBhc3luYyAoKSA9PiB7XG4gICAgICAgICAgICB3aGVuKGdhc09yYWNsZU1vY2suZ2V0QmFzZUZlZVBlckdhc1dlaUFzeW5jKCkpLnRoZW5SZXNvbHZlKG5ldyBCaWdOdW1iZXIoMTAwMCkpO1xuICAgICAgICAgICAgd2hlbihnYXNPcmFjbGVNb2NrLmdldE1heFByaW9yaXR5RmVlUGVyR2FzV2VpQXN5bmMoJ2luc3RhbnQnKSkudGhlblJlc29sdmUobmV3IEJpZ051bWJlcig2NjYpKTtcblxuICAgICAgICAgICAgY29uc3QgYXR0ZW5kYW50ID0gbmV3IEdhc1N0YXRpb25BdHRlbmRhbnRFdGhlcmV1bShpbnN0YW5jZShnYXNPcmFjbGVNb2NrKSk7XG5cbiAgICAgICAgICAgIGNvbnN0IHdvcmtlckdhc1RvVHJhZGUgPSBhd2FpdCBhdHRlbmRhbnQuZ2V0V29ya2VyQmFsYW5jZUZvclRyYWRlQXN5bmMoKTtcblxuICAgICAgICAgICAgLy8gQmFzZSBmZWUgaXMgMTAwMC4gV2l0aCA2IDEwJSBpbmNyZWFzZXMgPSAxMDAwICogKDEuMSleIDYgPSAxNzcxLjU2MVxuICAgICAgICAgICAgLy8gSW5zdGFudCB0aXAgaXMgNjY2XG4gICAgICAgICAgICAvLyBHYXMgZXN0aW1hdGUgbWF0Y2hlcyB0aGUgb25lIHVzZWQgaW4gdGhlIGFsZ29yaXRobVxuICAgICAgICAgICAgY29uc3QgZ2FzRXN0aW1hdGUgPSBjYWxjdWxhdGVHYXNFc3RpbWF0ZShcbiAgICAgICAgICAgICAgICAnMHg3ZmM2NjUwMGM4NGE3NmFkN2U5YzkzNDM3YmZjNWFjMzNlMmRkYWU5JyxcbiAgICAgICAgICAgICAgICAnMHhhMGI4Njk5MWM2MjE4YjM2YzFkMTlkNGEyZTllYjBjZTM2MDZlYjQ4JyxcbiAgICAgICAgICAgICAgICAnb3RjJyxcbiAgICAgICAgICAgICAgICB0cnVlLFxuICAgICAgICAgICAgKTtcblxuICAgICAgICAgICAgZXhwZWN0KHdvcmtlckdhc1RvVHJhZGUudG9QcmVjaXNpb24oMikudG9TdHJpbmcoKSkudG8uZXF1YWwoXG4gICAgICAgICAgICAgICAgLy8gdHNsaW50OmRpc2FibGUtbmV4dC1saW5lOiBjdXN0b20tbm8tbWFnaWMtbnVtYmVyc1xuICAgICAgICAgICAgICAgIG5ldyBCaWdOdW1iZXIoMTc3MS41NjEpLnBsdXMoNjY2KS50aW1lcyhnYXNFc3RpbWF0ZSkudG9QcmVjaXNpb24oMikudG9TdHJpbmcoKSxcbiAgICAgICAgICAgICk7XG4gICAgICAgIH0pO1xuICAgIH0pO1xuXG4gICAgZGVzY3JpYmUoJ2dldEV4cGVjdGVkVHJhbnNhY3Rpb25HYXNSYXRlQXN5bmMnLCAoKSA9PiB7XG4gICAgICAgIGl0KCdlc3RpbWF0ZXMgdGhlIHRyYW5zYWN0aW9uIGdhcyByYXRlJywgYXN5bmMgKCkgPT4ge1xuICAgICAgICAgICAgd2hlbihnYXNPcmFjbGVNb2NrLmdldEJhc2VGZWVQZXJHYXNXZWlBc3luYygpKS50aGVuUmVzb2x2ZShuZXcgQmlnTnVtYmVyKDEwMDApKTtcblxuICAgICAgICAgICAgY29uc3QgYXR0ZW5kYW50ID0gbmV3IEdhc1N0YXRpb25BdHRlbmRhbnRFdGhlcmV1bShpbnN0YW5jZShnYXNPcmFjbGVNb2NrKSk7XG5cbiAgICAgICAgICAgIGNvbnN0IGdhc1JhdGUgPSBhd2FpdCBhdHRlbmRhbnQuZ2V0RXhwZWN0ZWRUcmFuc2FjdGlvbkdhc1JhdGVBc3luYygpO1xuXG4gICAgICAgICAgICAvLyBCYXNlIGZlZSBpcyAxMDAwXG4gICAgICAgICAgICAvLyBUaXAgZXN0aW1hdGUgaXNcbiAgICAgICAgICAgIGNvbnN0IHRpcEVzdGltYXRlID0gbmV3IEJpZ051bWJlcigyNzUwMDAwMDAwKTtcblxuICAgICAgICAgICAgZXhwZWN0KGdhc1JhdGUudG9TdHJpbmcoKSkudG8uZXF1YWwoXG4gICAgICAgICAgICAgICAgLy8gdHNsaW50OmRpc2FibGUtbmV4dC1saW5lOiBjdXN0b20tbm8tbWFnaWMtbnVtYmVyc1xuICAgICAgICAgICAgICAgIG5ldyBCaWdOdW1iZXIoMTAwMCkucGx1cyh0aXBFc3RpbWF0ZSkudG9TdHJpbmcoKSxcbiAgICAgICAgICAgICk7XG4gICAgICAgIH0pO1xuICAgIH0pO1xuICAgIGRlc2NyaWJlKCdnZXROZXh0QmlkQXN5bmMnLCAoKSA9PiB7XG4gICAgICAgIGl0KCdnZXRzIGFuIGluaXRpYWwgYmlkIHdoZW4gdGhlcmUgYXJlIG5vIGV4aXN0aW5nIHRyYW5zYWN0aW9ucycsIGFzeW5jICgpID0+IHtcbiAgICAgICAgICAgIHdoZW4oZ2FzT3JhY2xlTW9jay5nZXRCYXNlRmVlUGVyR2FzV2VpQXN5bmMoKSkudGhlblJlc29sdmUobmV3IEJpZ051bWJlcigxMDAwKSk7XG5cbiAgICAgICAgICAgIGNvbnN0IGF0dGVuZGFudCA9IG5ldyBHYXNTdGF0aW9uQXR0ZW5kYW50RXRoZXJldW0oaW5zdGFuY2UoZ2FzT3JhY2xlTW9jaykpO1xuICAgICAgICAgICAgY29uc3QgZ2FzUmF0ZSA9IGF3YWl0IGF0dGVuZGFudC5nZXROZXh0QmlkQXN5bmMobnVsbCk7XG5cbiAgICAgICAgICAgIGNvbnN0IGluaXRpYWxNYXhQcmlvcml0eUZlZVBlckdhc1dlaSA9IG5ldyBCaWdOdW1iZXIoMjAwMDAwMDAwMCk7XG4gICAgICAgICAgICBjb25zdCBpbml0aWFsTWF4RmVlUGVyR2FzV2VpID0gbmV3IEJpZ051bWJlcigvKiBiYXNlIGZlZSAqLyAxMDAwKVxuICAgICAgICAgICAgICAgIC50aW1lcygyKVxuICAgICAgICAgICAgICAgIC5wbHVzKGluaXRpYWxNYXhQcmlvcml0eUZlZVBlckdhc1dlaSk7XG5cbiAgICAgICAgICAgIGV4cGVjdChnYXNSYXRlPy5tYXhQcmlvcml0eUZlZVBlckdhcz8udG9TdHJpbmcoKSkudG8uZXF1YWwoaW5pdGlhbE1heFByaW9yaXR5RmVlUGVyR2FzV2VpLnRvU3RyaW5nKCkpO1xuICAgICAgICAgICAgZXhwZWN0KGdhc1JhdGU/Lm1heEZlZVBlckdhcz8udG9TdHJpbmcoKSkudG8uZXF1YWwoaW5pdGlhbE1heEZlZVBlckdhc1dlaS50b1N0cmluZygpKTtcbiAgICAgICAgfSk7XG5cbiAgICAgICAgaXQoJ2NhbGN1bGF0ZXMgYSByZXN1Ym1pdCBiaWQgd2hlbiB0aGUgYmFzZSBmZWUgcmlzZXMnLCBhc3luYyAoKSA9PiB7XG4gICAgICAgICAgICB3aGVuKGdhc09yYWNsZU1vY2suZ2V0QmFzZUZlZVBlckdhc1dlaUFzeW5jKCkpLnRoZW5SZXNvbHZlKG5ldyBCaWdOdW1iZXIoMTAwMCkpO1xuICAgICAgICAgICAgd2hlbihnYXNPcmFjbGVNb2NrLmdldE1heFByaW9yaXR5RmVlUGVyR2FzV2VpQXN5bmMoJ2luc3RhbnQnKSkudGhlblJlc29sdmUobmV3IEJpZ051bWJlcig2NjYpKTtcbiAgICAgICAgICAgIGNvbnN0IHRyYW5zYWN0aW9uMSA9IG5ldyBSZnFtVjJUcmFuc2FjdGlvblN1Ym1pc3Npb25FbnRpdHkoe1xuICAgICAgICAgICAgICAgIHRyYW5zYWN0aW9uSGFzaDogJzB4MScsXG4gICAgICAgICAgICAgICAgZnJvbTogJzB4ZnJvbScsXG4gICAgICAgICAgICAgICAgdG86ICcweHRvJyxcbiAgICAgICAgICAgICAgICBvcmRlckhhc2g6ICcweE9yZGVyaGFzaCcsXG4gICAgICAgICAgICAgICAgbm9uY2U6IDAsXG4gICAgICAgICAgICAgICAgbWF4RmVlUGVyR2FzOiBuZXcgQmlnTnVtYmVyKDMpLFxuICAgICAgICAgICAgICAgIG1heFByaW9yaXR5RmVlUGVyR2FzOiBuZXcgQmlnTnVtYmVyKDIpLFxuICAgICAgICAgICAgICAgIHR5cGU6IFJmcW1UcmFuc2FjdGlvblN1Ym1pc3Npb25UeXBlLlRyYWRlLFxuICAgICAgICAgICAgfSk7XG5cbiAgICAgICAgICAgIGNvbnN0IHN1Ym1pc3Npb25Db250ZXh0ID0gbmV3IFN1Ym1pc3Npb25Db250ZXh0KGluc3RhbmNlKG1vY2soUmZxQmxvY2tjaGFpblV0aWxzKSksIFt0cmFuc2FjdGlvbjFdKTtcbiAgICAgICAgICAgIGNvbnN0IGF0dGVuZGFudCA9IG5ldyBHYXNTdGF0aW9uQXR0ZW5kYW50RXRoZXJldW0oaW5zdGFuY2UoZ2FzT3JhY2xlTW9jaykpO1xuICAgICAgICAgICAgY29uc3QgZ2FzUmF0ZSA9IGF3YWl0IGF0dGVuZGFudC5nZXROZXh0QmlkQXN5bmMoc3VibWlzc2lvbkNvbnRleHQpO1xuXG4gICAgICAgICAgICAvLyBQcmV2aW91cyBzdWJtaXNzaW9uIGdhcyBwcmljZXMgd2VyZSAyIHRpcCwgMyBtYXhcbiAgICAgICAgICAgIC8vIG5ldyB0aXAgPSAyICogMS41ID0gM1xuICAgICAgICAgICAgLy8gQmFzZSBmZWUgaXMgbm93IDEwMDBcbiAgICAgICAgICAgIC8vIHRvdGFsID0gMiB4IGJhc2UgZmVlICsgdGlwXG4gICAgICAgICAgICAvLyB0b3RhbCA9IDIgKiAxMDAwICsgM1xuICAgICAgICAgICAgZXhwZWN0KGdhc1JhdGU/Lm1heFByaW9yaXR5RmVlUGVyR2FzPy50b1N0cmluZygpKS50by5lcXVhbChuZXcgQmlnTnVtYmVyKDMpLnRvU3RyaW5nKCkpO1xuICAgICAgICAgICAgZXhwZWN0KGdhc1JhdGU/Lm1heEZlZVBlckdhcz8udG9TdHJpbmcoKSkudG8uZXF1YWwobmV3IEJpZ051bWJlcigyMDAzKS50b1N0cmluZygpKTtcbiAgICAgICAgfSk7XG5cbiAgICAgICAgaXQoJ2NhbGN1bGF0ZXMgYSByZXN1Ym1pdCBiaWQgd2l0aCB0aGUgbWluaW11bSBtYXggZmVlIHBlciBnYXMgaW5jcmVhc2UnLCBhc3luYyAoKSA9PiB7XG4gICAgICAgICAgICB3aGVuKGdhc09yYWNsZU1vY2suZ2V0QmFzZUZlZVBlckdhc1dlaUFzeW5jKCkpLnRoZW5SZXNvbHZlKG5ldyBCaWdOdW1iZXIoMCkpO1xuICAgICAgICAgICAgd2hlbihnYXNPcmFjbGVNb2NrLmdldE1heFByaW9yaXR5RmVlUGVyR2FzV2VpQXN5bmMoJ2luc3RhbnQnKSkudGhlblJlc29sdmUobmV3IEJpZ051bWJlcig2NjYpKTtcbiAgICAgICAgICAgIGNvbnN0IHRyYW5zYWN0aW9uMSA9IG5ldyBSZnFtVjJUcmFuc2FjdGlvblN1Ym1pc3Npb25FbnRpdHkoe1xuICAgICAgICAgICAgICAgIHRyYW5zYWN0aW9uSGFzaDogJzB4MScsXG4gICAgICAgICAgICAgICAgZnJvbTogJzB4ZnJvbScsXG4gICAgICAgICAgICAgICAgdG86ICcweHRvJyxcbiAgICAgICAgICAgICAgICBvcmRlckhhc2g6ICcweE9yZGVyaGFzaCcsXG4gICAgICAgICAgICAgICAgbm9uY2U6IDAsXG4gICAgICAgICAgICAgICAgbWF4RmVlUGVyR2FzOiBuZXcgQmlnTnVtYmVyKDIwMDIpLFxuICAgICAgICAgICAgICAgIG1heFByaW9yaXR5RmVlUGVyR2FzOiBuZXcgQmlnTnVtYmVyKDIpLFxuICAgICAgICAgICAgICAgIHR5cGU6IFJmcW1UcmFuc2FjdGlvblN1Ym1pc3Npb25UeXBlLlRyYWRlLFxuICAgICAgICAgICAgfSk7XG5cbiAgICAgICAgICAgIGNvbnN0IHN1Ym1pc3Npb25Db250ZXh0ID0gbmV3IFN1Ym1pc3Npb25Db250ZXh0KGluc3RhbmNlKG1vY2soUmZxQmxvY2tjaGFpblV0aWxzKSksIFt0cmFuc2FjdGlvbjFdKTtcbiAgICAgICAgICAgIGNvbnN0IGF0dGVuZGFudCA9IG5ldyBHYXNTdGF0aW9uQXR0ZW5kYW50RXRoZXJldW0oaW5zdGFuY2UoZ2FzT3JhY2xlTW9jaykpO1xuICAgICAgICAgICAgY29uc3QgZ2FzUmF0ZSA9IGF3YWl0IGF0dGVuZGFudC5nZXROZXh0QmlkQXN5bmMoc3VibWlzc2lvbkNvbnRleHQpO1xuXG4gICAgICAgICAgICAvLyBQcmV2aW91cyBzdWJtaXNzaW9uIGdhcyBwcmljZXMgd2VyZSAyIHRpcCwgMyBtYXhcbiAgICAgICAgICAgIC8vIG5ldyB0aXAgPSAyICogMS41ID0gM1xuXG4gICAgICAgICAgICAvLyBCYXNlIGZlZSBpcyBub3cgMCwgc28gbWF4IGZlZSBtdXN0IGdvIHVwIGJ5IDEwJSBzbyB0aGUgbm9kZVxuICAgICAgICAgICAgLy8gYWNjZXB0cyB0aGUgdHJhbnNhY2lvblxuICAgICAgICAgICAgLy8gb2xkIG1heCBmZWUgcGVyIGdhcyAqIDExMCUgPSAyMDAyICogMS4xID0gMjIwMi4yXG4gICAgICAgICAgICBleHBlY3QoZ2FzUmF0ZT8ubWF4UHJpb3JpdHlGZWVQZXJHYXM/LnRvU3RyaW5nKCkpLnRvLmVxdWFsKG5ldyBCaWdOdW1iZXIoMykudG9TdHJpbmcoKSk7XG4gICAgICAgICAgICBleHBlY3QoZ2FzUmF0ZT8ubWF4RmVlUGVyR2FzPy50b1N0cmluZygpKS50by5lcXVhbChcbiAgICAgICAgICAgICAgICBuZXcgQmlnTnVtYmVyKDIyMDIuMikuaW50ZWdlclZhbHVlKEJpZ051bWJlci5ST1VORF9DRUlMKS50b1N0cmluZygpLFxuICAgICAgICAgICAgKTtcbiAgICAgICAgfSk7XG4gICAgfSk7XG59KTtcbiJdLCJ2ZXJzaW9uIjozfQ==