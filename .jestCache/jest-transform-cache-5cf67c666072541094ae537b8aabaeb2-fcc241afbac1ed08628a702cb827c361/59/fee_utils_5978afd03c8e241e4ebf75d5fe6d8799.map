{"file":"/Users/davidwalsh/code-local/0x-rfq-api/src/core/fee_utils.ts","mappings":"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","names":[],"sources":["/Users/davidwalsh/code-local/0x-rfq-api/src/core/fee_utils.ts"],"sourcesContent":["import { BigNumber } from '@0x/utils';\r\n\r\nimport { Fee, FeeWithDetails, StoredFee } from './types';\r\n\r\nconst tokenPriceUsdToString = (tokenPriceUsd: BigNumber | null): string | undefined => {\r\n    if (tokenPriceUsd === null) {\r\n        return undefined;\r\n    }\r\n    return tokenPriceUsd.toString();\r\n};\r\n\r\nconst isInstanceOfFeeWithDetails = (fee: Fee): fee is FeeWithDetails => {\r\n    return 'details' in fee;\r\n};\r\n\r\nconst isInstanceOfFeeWithBreakdown = (fee: Fee): fee is FeeWithDetails => {\r\n    return 'breakdown' in fee && 'conversionRates' in fee;\r\n};\r\n\r\nexport const feeToStoredFee = (fee: Fee): StoredFee => {\r\n    let details;\r\n    if (isInstanceOfFeeWithDetails(fee)) {\r\n        switch (fee.details.kind) {\r\n            case 'default':\r\n                details = {\r\n                    kind: fee.details.kind,\r\n                    feeModelVersion: fee.details.feeModelVersion,\r\n                    gasFeeAmount: fee.details.gasFeeAmount.toString(),\r\n                    gasPrice: fee.details.gasPrice.toString(),\r\n                    tradeSizeBps: fee.details.tradeSizeBps,\r\n                    zeroExFeeAmount: fee.details.zeroExFeeAmount.toString(),\r\n                    // $eslint-fix-me https://github.com/rhinodavid/eslint-fix-me\r\n                    // eslint-disable-next-line @typescript-eslint/no-non-null-assertion\r\n                    feeTokenBaseUnitPriceUsd: tokenPriceUsdToString(fee.details.feeTokenBaseUnitPriceUsd!),\r\n                    takerTokenBaseUnitPriceUsd: tokenPriceUsdToString(fee.details.takerTokenBaseUnitPriceUsd),\r\n                    makerTokenBaseUnitPriceUsd: tokenPriceUsdToString(fee.details.makerTokenBaseUnitPriceUsd),\r\n                };\r\n                break;\r\n            case 'margin':\r\n                details = {\r\n                    kind: fee.details.kind,\r\n                    feeModelVersion: fee.details.feeModelVersion,\r\n                    gasFeeAmount: fee.details.gasFeeAmount.toString(),\r\n                    gasPrice: fee.details.gasPrice.toString(),\r\n                    margin: fee.details.margin.toString(),\r\n                    marginRakeRatio: fee.details.marginRakeRatio,\r\n                    zeroExFeeAmount: fee.details.zeroExFeeAmount.toString(),\r\n                    // $eslint-fix-me https://github.com/rhinodavid/eslint-fix-me\r\n                    // eslint-disable-next-line @typescript-eslint/no-non-null-assertion\r\n                    feeTokenBaseUnitPriceUsd: tokenPriceUsdToString(fee.details.feeTokenBaseUnitPriceUsd!),\r\n                    takerTokenBaseUnitPriceUsd: tokenPriceUsdToString(fee.details.takerTokenBaseUnitPriceUsd),\r\n                    makerTokenBaseUnitPriceUsd: tokenPriceUsdToString(fee.details.makerTokenBaseUnitPriceUsd),\r\n                };\r\n                break;\r\n            case 'gasOnly':\r\n            default:\r\n                details = {\r\n                    kind: fee.details.kind,\r\n                    feeModelVersion: fee.details.feeModelVersion,\r\n                    gasFeeAmount: fee.details.gasFeeAmount.toString(),\r\n                    gasPrice: fee.details.gasPrice.toString(),\r\n                };\r\n        }\r\n    }\r\n\r\n    let breakdown, conversionRates;\r\n    if (isInstanceOfFeeWithBreakdown(fee)) {\r\n        if (fee.breakdown) {\r\n            let gas, zeroEx;\r\n            if (fee.breakdown.gas) {\r\n                gas = {\r\n                    amount: fee.breakdown.gas.amount.toString(),\r\n                    details: {\r\n                        gasPrice: fee.breakdown.gas.details.gasPrice.toString(),\r\n                        estimatedGas: fee.breakdown.gas.details.estimatedGas.toString(),\r\n                    },\r\n                };\r\n            }\r\n            if (fee.breakdown.zeroEx) {\r\n                let details;\r\n                switch (fee.breakdown.zeroEx.details.kind) {\r\n                    case 'volume':\r\n                        details = {\r\n                            kind: fee.breakdown.zeroEx.details.kind,\r\n                            tradeSizeBps: fee.breakdown.zeroEx.details.tradeSizeBps,\r\n                        };\r\n                        break;\r\n                    case 'price_improvement':\r\n                        details = {\r\n                            kind: fee.breakdown.zeroEx.details.kind,\r\n                            priceImprovement: fee.breakdown.zeroEx.details.priceImprovement.toString(),\r\n                            rakeRatio: fee.breakdown.zeroEx.details.rakeRatio,\r\n                        };\r\n                        break;\r\n                    default:\r\n                        throw new Error(`Invalide zeroEx fee details: ${JSON.stringify(fee.breakdown.zeroEx.details)}`);\r\n                }\r\n                zeroEx = {\r\n                    amount: fee.breakdown.zeroEx.amount.toString(),\r\n                    details,\r\n                };\r\n            }\r\n            breakdown = {\r\n                gas,\r\n                zeroEx,\r\n            };\r\n        }\r\n        if (fee.conversionRates) {\r\n            conversionRates = {\r\n                nativeTokenBaseUnitPriceUsd: tokenPriceUsdToString(fee.conversionRates.nativeTokenBaseUnitPriceUsd),\r\n                feeTokenBaseUnitPriceUsd: tokenPriceUsdToString(fee.conversionRates.feeTokenBaseUnitPriceUsd),\r\n                takerTokenBaseUnitPriceUsd: tokenPriceUsdToString(fee.conversionRates.takerTokenBaseUnitPriceUsd),\r\n                makerTokenBaseUnitPriceUsd: tokenPriceUsdToString(fee.conversionRates.makerTokenBaseUnitPriceUsd),\r\n            };\r\n        }\r\n    }\r\n\r\n    return {\r\n        token: fee.token,\r\n        amount: fee.amount.toString(),\r\n        type: fee.type,\r\n        details,\r\n        breakdown,\r\n        conversionRates,\r\n    };\r\n};\r\n\r\nexport const storedFeeToFee = (fee: StoredFee): Fee => {\r\n    return {\r\n        token: fee.token,\r\n        amount: new BigNumber(fee.amount),\r\n        type: fee.type,\r\n    };\r\n};\r\n"],"version":3}