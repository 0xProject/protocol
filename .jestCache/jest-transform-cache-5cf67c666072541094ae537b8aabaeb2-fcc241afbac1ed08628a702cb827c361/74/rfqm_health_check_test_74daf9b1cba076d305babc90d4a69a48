97ab7ed0853017d5ecda755f28103d5a
"use strict";
Object.defineProperty(exports, "__esModule", { value: true });
// tslint:disable custom-no-magic-numbers
const utils_1 = require("@0x/utils");
const chai_1 = require("chai");
const sqs_producer_1 = require("sqs-producer");
const ts_mockito_1 = require("ts-mockito");
const constants_1 = require("../../src/core/constants");
const entities_1 = require("../../src/entities");
const rfqm_health_check_1 = require("../../src/utils/rfqm_health_check");
let producerMock;
const MS_IN_MINUTE = 60000;
const fullBalance = new utils_1.BigNumber(1).shiftedBy(constants_1.ETH_DECIMALS);
describe('RFQm Health Check', () => {
    describe('checkSqsQueueAsync', () => {
        beforeEach(() => {
            producerMock = (0, ts_mockito_1.mock)(sqs_producer_1.Producer);
        });
        describe('queue size check', () => {
            it('creates no issues if there are 10 or less jobs in the queue', async () => {
                (0, ts_mockito_1.when)(producerMock.queueSize()).thenResolve(1);
                const issues = await (0, rfqm_health_check_1.checkSqsQueueAsync)((0, ts_mockito_1.instance)(producerMock));
                (0, chai_1.expect)(issues).to.have.length(0);
            });
            it('creates a DEGRADED issue if there are more than 5 messages in the queue', async () => {
                (0, ts_mockito_1.when)(producerMock.queueSize()).thenResolve(11);
                const issues = await (0, rfqm_health_check_1.checkSqsQueueAsync)((0, ts_mockito_1.instance)(producerMock));
                (0, chai_1.expect)(issues).to.have.length(1);
                (0, chai_1.expect)(issues[0].status).to.equal(rfqm_health_check_1.HealthCheckStatus.Degraded);
            });
            it('creates a FAILED issue if there are more than 20 messages in the queue', async () => {
                (0, ts_mockito_1.when)(producerMock.queueSize()).thenResolve(21);
                const issues = await (0, rfqm_health_check_1.checkSqsQueueAsync)((0, ts_mockito_1.instance)(producerMock));
                (0, chai_1.expect)(issues).to.have.length(1);
                (0, chai_1.expect)(issues[0].status).to.equal(rfqm_health_check_1.HealthCheckStatus.Failed);
            });
        });
    });
    describe('checkWorkerHeartbeatsAsync', () => {
        it('creates a failed issue when no heartbeats are found', async () => {
            const issues = await (0, rfqm_health_check_1.checkWorkerHeartbeatsAsync)([]);
            (0, chai_1.expect)(issues).to.have.length(1);
            (0, chai_1.expect)(issues[0].status).to.equal(rfqm_health_check_1.HealthCheckStatus.Failed);
        });
        describe('Heartbeat age', () => {
            it('creates a failed issue with no recent heartbeats', async () => {
                const now = new Date();
                const nowTime = now.getTime();
                const heartbeat = new entities_1.RfqmWorkerHeartbeatEntity({
                    address: '0x00',
                    balance: fullBalance,
                    index: 0,
                    timestamp: new Date(nowTime - MS_IN_MINUTE * 6),
                    chainId: 1337,
                });
                const issues = await (0, rfqm_health_check_1.checkWorkerHeartbeatsAsync)([heartbeat], now);
                const failedIssues = issues.filter(({ status }) => status === rfqm_health_check_1.HealthCheckStatus.Failed);
                (0, chai_1.expect)(failedIssues).to.have.length(1);
            });
            it('creates degraded issues for stale heartbeats', async () => {
                const now = new Date();
                const nowTime = now.getTime();
                const heartbeat1 = new entities_1.RfqmWorkerHeartbeatEntity({
                    address: '0x00',
                    balance: fullBalance,
                    index: 0,
                    timestamp: now,
                    chainId: 1337,
                });
                const heartbeat2 = new entities_1.RfqmWorkerHeartbeatEntity({
                    address: '0x01',
                    balance: fullBalance,
                    index: 1,
                    timestamp: new Date(nowTime - MS_IN_MINUTE * 8),
                    chainId: 1337,
                });
                const issues = await (0, rfqm_health_check_1.checkWorkerHeartbeatsAsync)([heartbeat1, heartbeat2], now);
                const failedIssues = issues.filter(({ status }) => status === rfqm_health_check_1.HealthCheckStatus.Failed);
                (0, chai_1.expect)(failedIssues).to.have.length(0);
                const degradedIssues = issues.filter(({ status }) => status === rfqm_health_check_1.HealthCheckStatus.Degraded);
                (0, chai_1.expect)(degradedIssues).to.have.length(1);
                (0, chai_1.expect)(degradedIssues[0].description).to.contain('0x01');
            });
        });
        describe('Worker balance', () => {
            it('creates a failed issue when no worker has a balance above the failed threshold', async () => {
                const now = new Date();
                const heartbeat = new entities_1.RfqmWorkerHeartbeatEntity({
                    address: '0x00',
                    balance: new utils_1.BigNumber(0.01),
                    index: 0,
                    timestamp: now,
                    chainId: 1337,
                });
                const issues = await (0, rfqm_health_check_1.checkWorkerHeartbeatsAsync)([heartbeat], now);
                const failedIssues = issues.filter(({ status }) => status === rfqm_health_check_1.HealthCheckStatus.Failed);
                (0, chai_1.expect)(failedIssues).to.have.length(1);
            });
            it('creates degraded issues for low worker balances', async () => {
                const now = new Date();
                const heartbeat1 = new entities_1.RfqmWorkerHeartbeatEntity({
                    address: '0x00',
                    balance: new utils_1.BigNumber(0.01),
                    index: 0,
                    timestamp: now,
                    chainId: 1337,
                });
                const heartbeat2 = new entities_1.RfqmWorkerHeartbeatEntity({
                    address: '0x01',
                    balance: fullBalance,
                    index: 1,
                    timestamp: now,
                    chainId: 1337,
                });
                const issues = await (0, rfqm_health_check_1.checkWorkerHeartbeatsAsync)([heartbeat1, heartbeat2], now);
                const failedIssues = issues.filter(({ status }) => status === rfqm_health_check_1.HealthCheckStatus.Failed);
                (0, chai_1.expect)(failedIssues).to.have.length(0);
                const degradedIssues = issues.filter(({ status }) => status === rfqm_health_check_1.HealthCheckStatus.Degraded);
                (0, chai_1.expect)(degradedIssues).to.have.length(1);
                (0, chai_1.expect)(degradedIssues[0].description).to.contain('Less than two workers have a balance above the degraded threshold');
            });
        });
    });
    describe('getHttpIssues', () => {
        it('goes into maintainence mode', async () => {
            const issues = (0, rfqm_health_check_1.getHttpIssues)(/* isMaintainenceMode */ true);
            (0, chai_1.expect)(issues[0].status).to.equal(rfqm_health_check_1.HealthCheckStatus.Maintenance);
        });
    });
});
//# sourceMappingURL=data:application/json;charset=utf-8;base64,eyJmaWxlIjoiL1VzZXJzL2Rhdmlkd2Fsc2gvY29kZS1sb2NhbC8weC1yZnEtYXBpL3Rlc3QvdXRpbHMvcmZxbV9oZWFsdGhfY2hlY2tfdGVzdC50cyIsIm1hcHBpbmdzIjoiOztBQUFBLHlDQUF5QztBQUN6QyxxQ0FBc0M7QUFDdEMsK0JBQThCO0FBQzlCLCtDQUF3QztBQUN4QywyQ0FBa0Q7QUFFbEQsd0RBQXdEO0FBQ3hELGlEQUErRDtBQUMvRCx5RUFLMkM7QUFFM0MsSUFBSSxZQUFzQixDQUFDO0FBRTNCLE1BQU0sWUFBWSxHQUFHLEtBQUssQ0FBQztBQUMzQixNQUFNLFdBQVcsR0FBRyxJQUFJLGlCQUFTLENBQUMsQ0FBQyxDQUFDLENBQUMsU0FBUyxDQUFDLHdCQUFZLENBQUMsQ0FBQztBQUU3RCxRQUFRLENBQUMsbUJBQW1CLEVBQUUsR0FBRyxFQUFFO0lBQy9CLFFBQVEsQ0FBQyxvQkFBb0IsRUFBRSxHQUFHLEVBQUU7UUFDaEMsVUFBVSxDQUFDLEdBQUcsRUFBRTtZQUNaLFlBQVksR0FBRyxJQUFBLGlCQUFJLEVBQUMsdUJBQVEsQ0FBQyxDQUFDO1FBQ2xDLENBQUMsQ0FBQyxDQUFDO1FBRUgsUUFBUSxDQUFDLGtCQUFrQixFQUFFLEdBQUcsRUFBRTtZQUM5QixFQUFFLENBQUMsNkRBQTZELEVBQUUsS0FBSyxJQUFJLEVBQUU7Z0JBQ3pFLElBQUEsaUJBQUksRUFBQyxZQUFZLENBQUMsU0FBUyxFQUFFLENBQUMsQ0FBQyxXQUFXLENBQUMsQ0FBQyxDQUFDLENBQUM7Z0JBRTlDLE1BQU0sTUFBTSxHQUFHLE1BQU0sSUFBQSxzQ0FBa0IsRUFBQyxJQUFBLHFCQUFRLEVBQUMsWUFBWSxDQUFDLENBQUMsQ0FBQztnQkFFaEUsSUFBQSxhQUFNLEVBQUMsTUFBTSxDQUFDLENBQUMsRUFBRSxDQUFDLElBQUksQ0FBQyxNQUFNLENBQUMsQ0FBQyxDQUFDLENBQUM7WUFDckMsQ0FBQyxDQUFDLENBQUM7WUFFSCxFQUFFLENBQUMseUVBQXlFLEVBQUUsS0FBSyxJQUFJLEVBQUU7Z0JBQ3JGLElBQUEs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VyxDQUFDLENBQUMsRUFBRSxDQUFDLE9BQU8sQ0FDNUMsbUVBQW1FLENBQ3RFLENBQUM7WUFDTixDQUFDLENBQUMsQ0FBQztRQUNQLENBQUMsQ0FBQyxDQUFDO0lBQ1AsQ0FBQyxDQUFDLENBQUM7SUFFSCxRQUFRLENBQUMsZUFBZSxFQUFFLEdBQUcsRUFBRTtRQUMzQixFQUFFLENBQUMsNkJBQTZCLEVBQUUsS0FBSyxJQUFJLEVBQUU7WUFDekMsTUFBTSxNQUFNLEdBQUcsSUFBQSxpQ0FBYSxFQUFDLHdCQUF3QixDQUFDLElBQUksQ0FBQyxDQUFDO1lBRTVELElBQUEsYUFBTSxFQUFDLE1BQU0sQ0FBQyxDQUFDLENBQUMsQ0FBQyxNQUFNLENBQUMsQ0FBQyxFQUFFLENBQUMsS0FBSyxDQUFDLHFDQUFpQixDQUFDLFdBQVcsQ0FBQyxDQUFDO1FBQ3JFLENBQUMsQ0FBQyxDQUFDO0lBQ1AsQ0FBQyxDQUFDLENBQUM7QUFDUCxDQUFDLENBQUMsQ0FBQyIsIm5hbWVzIjpbXSwic291cmNlcyI6WyIvVXNlcnMvZGF2aWR3YWxzaC9jb2RlLWxvY2FsLzB4LXJmcS1hcGkvdGVzdC91dGlscy9yZnFtX2hlYWx0aF9jaGVja190ZXN0LnRzIl0sInNvdXJjZXNDb250ZW50IjpbIi8vIHRzbGludDpkaXNhYmxlIGN1c3RvbS1uby1tYWdpYy1udW1iZXJzXG5pbXBvcnQgeyBCaWdOdW1iZXIgfSBmcm9tICdAMHgvdXRpbHMnO1xuaW1wb3J0IHsgZXhwZWN0IH0gZnJvbSAnY2hhaSc7XG5pbXBvcnQgeyBQcm9kdWNlciB9IGZyb20gJ3Nxcy1wcm9kdWNlcic7XG5pbXBvcnQgeyBpbnN0YW5jZSwgbW9jaywgd2hlbiB9IGZyb20gJ3RzLW1vY2tpdG8nO1xuXG5pbXBvcnQgeyBFVEhfREVDSU1BTFMgfSBmcm9tICcuLi8uLi9zcmMvY29yZS9jb25zdGFudHMnO1xuaW1wb3J0IHsgUmZxbVdvcmtlckhlYXJ0YmVhdEVudGl0eSB9IGZyb20gJy4uLy4uL3NyYy9lbnRpdGllcyc7XG5pbXBvcnQge1xuICAgIGNoZWNrU3FzUXVldWVBc3luYyxcbiAgICBjaGVja1dvcmtlckhlYXJ0YmVhdHNBc3luYyxcbiAgICBnZXRIdHRwSXNzdWVzLFxuICAgIEhlYWx0aENoZWNrU3RhdHVzLFxufSBmcm9tICcuLi8uLi9zcmMvdXRpbHMvcmZxbV9oZWFsdGhfY2hlY2snO1xuXG5sZXQgcHJvZHVjZXJNb2NrOiBQcm9kdWNlcjtcblxuY29uc3QgTVNfSU5fTUlOVVRFID0gNjAwMDA7XG5jb25zdCBmdWxsQmFsYW5jZSA9IG5ldyBCaWdOdW1iZXIoMSkuc2hpZnRlZEJ5KEVUSF9ERUNJTUFMUyk7XG5cbmRlc2NyaWJlKCdSRlFtIEhlYWx0aCBDaGVjaycsICgpID0+IHtcbiAgICBkZXNjcmliZSgnY2hlY2tTcXNRdWV1ZUFzeW5jJywgKCkgPT4ge1xuICAgICAgICBiZWZvcmVFYWNoKCgpID0+IHtcbiAgICAgICAgICAgIHByb2R1Y2VyTW9jayA9IG1vY2soUHJvZHVjZXIpO1xuICAgICAgICB9KTtcblxuICAgICAgICBkZXNjcmliZSgncXVldWUgc2l6ZSBjaGVjaycsICgpID0+IHtcbiAgICAgICAgICAgIGl0KCdjcmVhdGVzIG5vIGlzc3VlcyBpZiB0aGVyZSBhcmUgMTAgb3IgbGVzcyBqb2JzIGluIHRoZSBxdWV1ZScsIGFzeW5jICgpID0+IHtcbiAgICAgICAgICAgICAgICB3aGVuKHByb2R1Y2VyTW9jay5xdWV1ZVNpemUoKSkudGhlblJlc29sdmUoMSk7XG5cbiAgICAgICAgICAgICAgICBjb25zdCBpc3N1ZXMgPSBhd2FpdCBjaGVja1Nxc1F1ZXVlQXN5bmMoaW5zdGFuY2UocHJvZHVjZXJNb2NrKSk7XG5cbiAgICAgICAgICAgICAgICBleHBlY3QoaXNzdWVzKS50by5oYXZlLmxlbmd0aCgwKTtcbiAgICAgICAgICAgIH0pO1xuXG4gICAgICAgICAgICBpdCgnY3JlYXRlcyBhIERFR1JBREVEIGlzc3VlIGlmIHRoZXJlIGFyZSBtb3JlIHRoYW4gNSBtZXNzYWdlcyBpbiB0aGUgcXVldWUnLCBhc3luYyAoKSA9PiB7XG4gICAgICAgICAgICAgICAgd2hlbihwcm9kdWNlck1vY2sucXVldWVTaXplKCkpLnRoZW5SZXNvbHZlKDExKTtcblxuICAgICAgICAgICAgICAgIGNvbnN0IGlzc3VlcyA9IGF3YWl0IGNoZWNrU3FzUXVldWVBc3luYyhpbnN0YW5jZShwcm9kdWNlck1vY2spKTtcblxuICAgICAgICAgICAgICAgIGV4cGVjdChpc3N1ZXMpLnRvLmhhdmUubGVuZ3RoKDEpO1xuICAgICAgICAgICAgICAgIGV4cGVjdChpc3N1ZXNbMF0uc3RhdHVzKS50by5lcXVhbChIZWFsdGhDaGVja1N0YXR1cy5EZWdyYWRlZCk7XG4gICAgICAgICAgICB9KTtcblxuICAgICAgICAgICAgaXQoJ2NyZWF0ZXMgYSBGQUlMRUQgaXNzdWUgaWYgdGhlcmUgYXJlIG1vcmUgdGhhbiAyMCBtZXNzYWdlcyBpbiB0aGUgcXVldWUnLCBhc3luYyAoKSA9PiB7XG4gICAgICAgICAgICAgICAgd2hlbihwcm9kdWNlck1vY2sucXVldWVTaXplKCkpLnRoZW5SZXNvbHZlKDIxKTtcblxuICAgICAgICAgICAgICAgIGNvbnN0IGlzc3VlcyA9IGF3YWl0IGNoZWNrU3FzUXVldWVBc3luYyhpbnN0YW5jZShwcm9kdWNlck1vY2spKTtcblxuICAgICAgICAgICAgICAgIGV4cGVjdChpc3N1ZXMpLnRvLmhhdmUubGVuZ3RoKDEpO1xuICAgICAgICAgICAgICAgIGV4cGVjdChpc3N1ZXNbMF0uc3RhdHVzKS50by5lcXVhbChIZWFsdGhDaGVja1N0YXR1cy5GYWlsZWQpO1xuICAgICAgICAgICAgfSk7XG4gICAgICAgIH0pO1xuICAgIH0pO1xuXG4gICAgZGVzY3JpYmUoJ2NoZWNrV29ya2VySGVhcnRiZWF0c0FzeW5jJywgKCkgPT4ge1xuICAgICAgICBpdCgnY3JlYXRlcyBhIGZhaWxlZCBpc3N1ZSB3aGVuIG5vIGhlYXJ0YmVhdHMgYXJlIGZvdW5kJywgYXN5bmMgKCkgPT4ge1xuICAgICAgICAgICAgY29uc3QgaXNzdWVzID0gYXdhaXQgY2hlY2tXb3JrZXJIZWFydGJlYXRzQXN5bmMoW10pO1xuXG4gICAgICAgICAgICBleHBlY3QoaXNzdWVzKS50by5oYXZlLmxlbmd0aCgxKTtcbiAgICAgICAgICAgIGV4cGVjdChpc3N1ZXNbMF0uc3RhdHVzKS50by5lcXVhbChIZWFsdGhDaGVja1N0YXR1cy5GYWlsZWQpO1xuICAgICAgICB9KTtcblxuICAgICAgICBkZXNjcmliZSgnSGVhcnRiZWF0IGFnZScsICgpID0+IHtcbiAgICAgICAgICAgIGl0KCdjcmVhdGVzIGEgZmFpbGVkIGlzc3VlIHdpdGggbm8gcmVjZW50IGhlYXJ0YmVhdHMnLCBhc3luYyAoKSA9PiB7XG4gICAgICAgICAgICAgICAgY29uc3Qgbm93ID0gbmV3IERhdGUoKTtcbiAgICAgICAgICAgICAgICBjb25zdCBub3dUaW1lID0gbm93LmdldFRpbWUoKTtcbiAgICAgICAgICAgICAgICBjb25zdCBoZWFydGJlYXQgPSBuZXcgUmZxbVdvcmtlckhlYXJ0YmVhdEVudGl0eSh7XG4gICAgICAgICAgICAgICAgICAgIGFkZHJlc3M6ICcweDAwJyxcbiAgICAgICAgICAgICAgICAgICAgYmFsYW5jZTogZnVsbEJhbGFuY2UsXG4gICAgICAgICAgICAgICAgICAgIGluZGV4OiAwLFxuICAgICAgICAgICAgICAgICAgICB0aW1lc3RhbXA6IG5ldyBEYXRlKG5vd1RpbWUgLSBNU19JTl9NSU5VVEUgKiA2KSxcbiAgICAgICAgICAgICAgICAgICAgY2hhaW5JZDogMTMzNyxcbiAgICAgICAgICAgICAgICB9KTtcblxuICAgICAgICAgICAgICAgIGNvbnN0IGlzc3VlcyA9IGF3YWl0IGNoZWNrV29ya2VySGVhcnRiZWF0c0FzeW5jKFtoZWFydGJlYXRdLCBub3cpO1xuICAgICAgICAgICAgICAgIGNvbnN0IGZhaWxlZElzc3VlcyA9IGlzc3Vlcy5maWx0ZXIoKHsgc3RhdHVzIH0pID0+IHN0YXR1cyA9PT0gSGVhbHRoQ2hlY2tTdGF0dXMuRmFpbGVkKTtcblxuICAgICAgICAgICAgICAgIGV4cGVjdChmYWlsZWRJc3N1ZXMpLnRvLmhhdmUubGVuZ3RoKDEpO1xuICAgICAgICAgICAgfSk7XG5cbiAgICAgICAgICAgIGl0KCdjcmVhdGVzIGRlZ3JhZGVkIGlzc3VlcyBmb3Igc3RhbGUgaGVhcnRiZWF0cycsIGFzeW5jICgpID0+IHtcbiAgICAgICAgICAgICAgICBjb25zdCBub3cgPSBuZXcgRGF0ZSgpO1xuICAgICAgICAgICAgICAgIGNvbnN0IG5vd1RpbWUgPSBub3cuZ2V0VGltZSgpO1xuICAgICAgICAgICAgICAgIGNvbnN0IGhlYXJ0YmVhdDEgPSBuZXcgUmZxbVdvcmtlckhlYXJ0YmVhdEVudGl0eSh7XG4gICAgICAgICAgICAgICAgICAgIGFkZHJlc3M6ICcweDAwJyxcbiAgICAgICAgICAgICAgICAgICAgYmFsYW5jZTogZnVsbEJhbGFuY2UsXG4gICAgICAgICAgICAgICAgICAgIGluZGV4OiAwLFxuICAgICAgICAgICAgICAgICAgICB0aW1lc3RhbXA6IG5vdyxcbiAgICAgICAgICAgICAgICAgICAgY2hhaW5JZDogMTMzNyxcbiAgICAgICAgICAgICAgICB9KTtcbiAgICAgICAgICAgICAgICBjb25zdCBoZWFydGJlYXQyID0gbmV3IFJmcW1Xb3JrZXJIZWFydGJlYXRFbnRpdHkoe1xuICAgICAgICAgICAgICAgICAgICBhZGRyZXNzOiAnMHgwMScsXG4gICAgICAgICAgICAgICAgICAgIGJhbGFuY2U6IGZ1bGxCYWxhbmNlLFxuICAgICAgICAgICAgICAgICAgICBpbmRleDogMSxcbiAgICAgICAgICAgICAgICAgICAgdGltZXN0YW1wOiBuZXcgRGF0ZShub3dUaW1lIC0gTVNfSU5fTUlOVVRFICogOCksXG4gICAgICAgICAgICAgICAgICAgIGNoYWluSWQ6IDEzMzcsXG4gICAgICAgICAgICAgICAgfSk7XG5cbiAgICAgICAgICAgICAgICBjb25zdCBpc3N1ZXMgPSBhd2FpdCBjaGVja1dvcmtlckhlYXJ0YmVhdHNBc3luYyhbaGVhcnRiZWF0MSwgaGVhcnRiZWF0Ml0sIG5vdyk7XG4gICAgICAgICAgICAgICAgY29uc3QgZmFpbGVkSXNzdWVzID0gaXNzdWVzLmZpbHRlcigoeyBzdGF0dXMgfSkgPT4gc3RhdHVzID09PSBIZWFsdGhDaGVja1N0YXR1cy5GYWlsZWQpO1xuICAgICAgICAgICAgICAgIGV4cGVjdChmYWlsZWRJc3N1ZXMpLnRvLmhhdmUubGVuZ3RoKDApO1xuICAgICAgICAgICAgICAgIGNvbnN0IGRlZ3JhZGVkSXNzdWVzID0gaXNzdWVzLmZpbHRlcigoeyBzdGF0dXMgfSkgPT4gc3RhdHVzID09PSBIZWFsdGhDaGVja1N0YXR1cy5EZWdyYWRlZCk7XG4gICAgICAgICAgICAgICAgZXhwZWN0KGRlZ3JhZGVkSXNzdWVzKS50by5oYXZlLmxlbmd0aCgxKTtcbiAgICAgICAgICAgICAgICBleHBlY3QoZGVncmFkZWRJc3N1ZXNbMF0uZGVzY3JpcHRpb24pLnRvLmNvbnRhaW4oJzB4MDEnKTtcbiAgICAgICAgICAgIH0pO1xuICAgICAgICB9KTtcblxuICAgICAgICBkZXNjcmliZSgnV29ya2VyIGJhbGFuY2UnLCAoKSA9PiB7XG4gICAgICAgICAgICBpdCgnY3JlYXRlcyBhIGZhaWxlZCBpc3N1ZSB3aGVuIG5vIHdvcmtlciBoYXMgYSBiYWxhbmNlIGFib3ZlIHRoZSBmYWlsZWQgdGhyZXNob2xkJywgYXN5bmMgKCkgPT4ge1xuICAgICAgICAgICAgICAgIGNvbnN0IG5vdyA9IG5ldyBEYXRlKCk7XG4gICAgICAgICAgICAgICAgY29uc3QgaGVhcnRiZWF0ID0gbmV3IFJmcW1Xb3JrZXJIZWFydGJlYXRFbnRpdHkoe1xuICAgICAgICAgICAgICAgICAgICBhZGRyZXNzOiAnMHgwMCcsXG4gICAgICAgICAgICAgICAgICAgIGJhbGFuY2U6IG5ldyBCaWdOdW1iZXIoMC4wMSksXG4gICAgICAgICAgICAgICAgICAgIGluZGV4OiAwLFxuICAgICAgICAgICAgICAgICAgICB0aW1lc3RhbXA6IG5vdyxcbiAgICAgICAgICAgICAgICAgICAgY2hhaW5JZDogMTMzNyxcbiAgICAgICAgICAgICAgICB9KTtcblxuICAgICAgICAgICAgICAgIGNvbnN0IGlzc3VlcyA9IGF3YWl0IGNoZWNrV29ya2VySGVhcnRiZWF0c0FzeW5jKFtoZWFydGJlYXRdLCBub3cpO1xuICAgICAgICAgICAgICAgIGNvbnN0IGZhaWxlZElzc3VlcyA9IGlzc3Vlcy5maWx0ZXIoKHsgc3RhdHVzIH0pID0+IHN0YXR1cyA9PT0gSGVhbHRoQ2hlY2tTdGF0dXMuRmFpbGVkKTtcblxuICAgICAgICAgICAgICAgIGV4cGVjdChmYWlsZWRJc3N1ZXMpLnRvLmhhdmUubGVuZ3RoKDEpO1xuICAgICAgICAgICAgfSk7XG5cbiAgICAgICAgICAgIGl0KCdjcmVhdGVzIGRlZ3JhZGVkIGlzc3VlcyBmb3IgbG93IHdvcmtlciBiYWxhbmNlcycsIGFzeW5jICgpID0+IHtcbiAgICAgICAgICAgICAgICBjb25zdCBub3cgPSBuZXcgRGF0ZSgpO1xuICAgICAgICAgICAgICAgIGNvbnN0IGhlYXJ0YmVhdDEgPSBuZXcgUmZxbVdvcmtlckhlYXJ0YmVhdEVudGl0eSh7XG4gICAgICAgICAgICAgICAgICAgIGFkZHJlc3M6ICcweDAwJyxcbiAgICAgICAgICAgICAgICAgICAgYmFsYW5jZTogbmV3IEJpZ051bWJlcigwLjAxKSxcbiAgICAgICAgICAgICAgICAgICAgaW5kZXg6IDAsXG4gICAgICAgICAgICAgICAgICAgIHRpbWVzdGFtcDogbm93LFxuICAgICAgICAgICAgICAgICAgICBjaGFpbklkOiAxMzM3LFxuICAgICAgICAgICAgICAgIH0pO1xuICAgICAgICAgICAgICAgIGNvbnN0IGhlYXJ0YmVhdDIgPSBuZXcgUmZxbVdvcmtlckhlYXJ0YmVhdEVudGl0eSh7XG4gICAgICAgICAgICAgICAgICAgIGFkZHJlc3M6ICcweDAxJyxcbiAgICAgICAgICAgICAgICAgICAgYmFsYW5jZTogZnVsbEJhbGFuY2UsXG4gICAgICAgICAgICAgICAgICAgIGluZGV4OiAxLFxuICAgICAgICAgICAgICAgICAgICB0aW1lc3RhbXA6IG5vdyxcbiAgICAgICAgICAgICAgICAgICAgY2hhaW5JZDogMTMzNyxcbiAgICAgICAgICAgICAgICB9KTtcblxuICAgICAgICAgICAgICAgIGNvbnN0IGlzc3VlcyA9IGF3YWl0IGNoZWNrV29ya2VySGVhcnRiZWF0c0FzeW5jKFtoZWFydGJlYXQxLCBoZWFydGJlYXQyXSwgbm93KTtcbiAgICAgICAgICAgICAgICBjb25zdCBmYWlsZWRJc3N1ZXMgPSBpc3N1ZXMuZmlsdGVyKCh7IHN0YXR1cyB9KSA9PiBzdGF0dXMgPT09IEhlYWx0aENoZWNrU3RhdHVzLkZhaWxlZCk7XG4gICAgICAgICAgICAgICAgZXhwZWN0KGZhaWxlZElzc3VlcykudG8uaGF2ZS5sZW5ndGgoMCk7XG5cbiAgICAgICAgICAgICAgICBjb25zdCBkZWdyYWRlZElzc3VlcyA9IGlzc3Vlcy5maWx0ZXIoKHsgc3RhdHVzIH0pID0+IHN0YXR1cyA9PT0gSGVhbHRoQ2hlY2tTdGF0dXMuRGVncmFkZWQpO1xuXG4gICAgICAgICAgICAgICAgZXhwZWN0KGRlZ3JhZGVkSXNzdWVzKS50by5oYXZlLmxlbmd0aCgxKTtcbiAgICAgICAgICAgICAgICBleHBlY3QoZGVncmFkZWRJc3N1ZXNbMF0uZGVzY3JpcHRpb24pLnRvLmNvbnRhaW4oXG4gICAgICAgICAgICAgICAgICAgICdMZXNzIHRoYW4gdHdvIHdvcmtlcnMgaGF2ZSBhIGJhbGFuY2UgYWJvdmUgdGhlIGRlZ3JhZGVkIHRocmVzaG9sZCcsXG4gICAgICAgICAgICAgICAgKTtcbiAgICAgICAgICAgIH0pO1xuICAgICAgICB9KTtcbiAgICB9KTtcblxuICAgIGRlc2NyaWJlKCdnZXRIdHRwSXNzdWVzJywgKCkgPT4ge1xuICAgICAgICBpdCgnZ29lcyBpbnRvIG1haW50YWluZW5jZSBtb2RlJywgYXN5bmMgKCkgPT4ge1xuICAgICAgICAgICAgY29uc3QgaXNzdWVzID0gZ2V0SHR0cElzc3VlcygvKiBpc01haW50YWluZW5jZU1vZGUgKi8gdHJ1ZSk7XG5cbiAgICAgICAgICAgIGV4cGVjdChpc3N1ZXNbMF0uc3RhdHVzKS50by5lcXVhbChIZWFsdGhDaGVja1N0YXR1cy5NYWludGVuYW5jZSk7XG4gICAgICAgIH0pO1xuICAgIH0pO1xufSk7XG4iXSwidmVyc2lvbiI6M30=