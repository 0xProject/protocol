5f96505bdb6e46f9a7debbb3bcfc80e6
"use strict";
Object.defineProperty(exports, "__esModule", { value: true });
exports.RfqMakerHandlers = void 0;
const HttpStatus = require("http-status-codes");
const prom_client_1 = require("prom-client");
const constants_1 = require("../core/constants");
const logger_1 = require("../logger");
const rfq_maker_service_1 = require("../services/rfq_maker_service");
const RFQ_MAKER_INVALID_KEY = new prom_client_1.Counter({
    name: 'rfq_maker_invalid_key',
    help: 'A request to maker endpoints failed because of invalid api key.',
});
const RFQ_MAKER_UPDATE_CLIENT_ERROR = new prom_client_1.Counter({
    name: 'rfq_maker_update_client_error',
    help: 'A request to update maker configs failed because of client side error.',
    labelNames: ['makerId'],
});
const RFQ_MAKER_UPDATE_SEVER_ERROR = new prom_client_1.Counter({
    name: 'rfq_maker_update_sever_error',
    help: 'A request to update maker configs failed because of sever side error.',
    labelNames: ['makerId'],
});
const RFQ_MAKER_UPDATE_SUCCEED = new prom_client_1.Counter({
    name: 'rfq_maker_update_succeed',
    help: 'A request to update maker configs succeeded.',
    labelNames: ['makerId'],
});
const RFQ_MAKER_GET_CLIENT_ERROR = new prom_client_1.Counter({
    name: 'rfq_maker_get_client_error',
    help: 'A request to GET maker failed because of client side error.',
    labelNames: ['makerId'],
});
const RFQ_MAKER_GET_SEVER_ERROR = new prom_client_1.Counter({
    name: 'rfq_maker_get_sever_error',
    help: 'A request to GET maker endpoint failed because of sever side error.',
    labelNames: ['makerId'],
});
const RFQ_MAKER_GET_SUCCEED = new prom_client_1.Counter({
    name: 'rfq_maker_get_succeed',
    help: 'A request to GET maker succeeded.',
    labelNames: ['makerId'],
});
const convertToLowerCase = (pairs) => {
    return pairs.map((pair) => {
        return [pair[0].toLowerCase(), pair[1].toLowerCase()];
    });
};
/**
 * Validates the request body of a PUT request.
 */
const validatePutPayloadOrThrow = (body) => {
    rfq_maker_service_1.RfqMakerService.validatePairsPayloadOrThrow(body.pairs);
    rfq_maker_service_1.RfqMakerService.validateUriOrThrow('rfqtUri', body.rfqtUri);
    rfq_maker_service_1.RfqMakerService.validateUriOrThrow('rfqmUri', body.rfqmUri);
};
/**
 * Validates the request body of a PATCH request.
 */
const validatePatchPayloadOrThrow = (body) => {
    if (body.pairs !== undefined) {
        rfq_maker_service_1.RfqMakerService.validatePairsPayloadOrThrow(body.pairs);
    }
    if (body.rfqtUri !== undefined) {
        rfq_maker_service_1.RfqMakerService.validateUriOrThrow('rfqtUri', body.rfqtUri);
    }
    if (body.rfqmUri !== undefined) {
        rfq_maker_service_1.RfqMakerService.validateUriOrThrow('rfqmUri', body.rfqmUri);
    }
    if (body.pairs === undefined && body.rfqtUri === undefined && body.rfqmUri === undefined) {
        throw new Error('No valid field is specified.');
    }
};
class RfqMakerHandlers {
    constructor(_rfqMakerService) {
        this._rfqMakerService = _rfqMakerService;
    }
    /**
     * Handler for PUT operation of the `/maker/v1/chain-id/:chainId` endpoint.
     */
    async putRfqMakerAsync(req, res) {
        const requestId = req.id;
        const makerApiKey = req.headers[constants_1.RFQ_MAKER_API_KEY_HEADER];
        const makerId = this._rfqMakerService.mapMakerApiKeyToId(makerApiKey);
        if (makerId === null) {
            const message = `Invalid api key.`;
            logger_1.logger.info({ requestId, apiKey: makerApiKey }, message);
            RFQ_MAKER_INVALID_KEY.inc();
            res.status(HttpStatus.UNAUTHORIZED).send({ error: message });
            return;
        }
        if (!rfq_maker_service_1.RfqMakerService.isValidChainId(req.params.chainId)) {
            const message = `Invalid chainId.`;
            logger_1.logger.info({ requestId, makerId, chainId: req.params.chainId }, message);
            RFQ_MAKER_UPDATE_CLIENT_ERROR.labels(makerId).inc();
            res.status(HttpStatus.BAD_REQUEST).send({ error: message });
            return;
        }
        const chainId = Number(req.params.chainId);
        try {
            validatePutPayloadOrThrow(req.body);
        }
        catch ({ message }) {
            logger_1.logger.info({ requestId, makerId, chainId }, message);
            RFQ_MAKER_UPDATE_CLIENT_ERROR.labels(makerId).inc();
            res.status(HttpStatus.BAD_REQUEST).send({ error: message });
            return;
        }
        try {
            const pairs = req.body.pairs;
            const rfqtUri = req.body.rfqtUri;
            const rfqmUri = req.body.rfqmUri;
            const rfqMaker = await this._rfqMakerService.createOrUpdateRfqMakerAsync(makerId, chainId, convertToLowerCase(pairs), rfqtUri, rfqmUri);
            res.status(HttpStatus.CREATED).send(rfqMaker);
            const rfqmMakerUri = rfqMaker.rfqmUri;
            logger_1.logger.info({ requestId, makerId, chainId, rfqmMakerUri }, 'Successfully created or updated RfqMaker entity.');
            RFQ_MAKER_UPDATE_SUCCEED.labels(makerId).inc();
        }
        catch (error) {
            const message = `Failed to create or update RfqMaker entity.`;
            logger_1.logger.error({ requestId, makerId, chainId, errorMessage: error.message }, message);
            RFQ_MAKER_UPDATE_SEVER_ERROR.labels(makerId).inc();
            res.status(HttpStatus.INTERNAL_SERVER_ERROR).send({ message });
        }
    }
    /**
     * Handler for PATCH operation of the `/maker/v1/chain-id/:chainId` endpoint.
     */
    async patchRfqMakerAsync(req, res) {
        const requestId = req.id;
        const makerApiKey = req.headers[constants_1.RFQ_MAKER_API_KEY_HEADER];
        const makerId = this._rfqMakerService.mapMakerApiKeyToId(makerApiKey);
        if (makerId === null) {
            const message = `Invalid api key.`;
            logger_1.logger.info({ requestId, apiKey: makerApiKey }, message);
            RFQ_MAKER_INVALID_KEY.inc();
            res.status(HttpStatus.UNAUTHORIZED).send({ error: message });
            return;
        }
        if (!rfq_maker_service_1.RfqMakerService.isValidChainId(req.params.chainId)) {
            const message = `Invalid chainId.`;
            logger_1.logger.info({ requestId, makerId, chainId: req.params.chainId }, message);
            RFQ_MAKER_UPDATE_CLIENT_ERROR.labels(makerId).inc();
            res.status(HttpStatus.BAD_REQUEST).send({ error: message });
            return;
        }
        const chainId = Number(req.params.chainId);
        try {
            validatePatchPayloadOrThrow(req.body);
        }
        catch ({ message }) {
            logger_1.logger.info({ requestId, makerId, chainId }, message);
            RFQ_MAKER_UPDATE_CLIENT_ERROR.labels(makerId).inc();
            res.status(HttpStatus.BAD_REQUEST).send({ error: message });
            return;
        }
        try {
            const pairs = req.body.pairs;
            const rfqtUri = req.body.rfqtUri;
            const rfqmUri = req.body.rfqmUri;
            const rfqMaker = await this._rfqMakerService.patchRfqMakerAsync(makerId, chainId, pairs !== undefined ? convertToLowerCase(pairs) : undefined, rfqtUri, rfqmUri);
            res.status(HttpStatus.OK).send(rfqMaker);
            const rfqmMakerUri = rfqMaker.rfqmUri;
            logger_1.logger.info({ requestId, makerId, chainId, rfqmMakerUri }, 'Successfully patched RfqMaker entity.');
            RFQ_MAKER_UPDATE_SUCCEED.labels(makerId).inc();
        }
        catch (error) {
            const message = `Failed to patch RfqMaker entity.`;
            logger_1.logger.error({ requestId, makerId, chainId, errorMessage: error.message }, message);
            RFQ_MAKER_UPDATE_SEVER_ERROR.labels(makerId).inc();
            res.status(HttpStatus.INTERNAL_SERVER_ERROR).send({ message });
        }
    }
    /**
     * Handler for GET operation of the `/maker/v1/chain-id/:chainId` endpoint.
     */
    async getRfqMakerAsync(req, res) {
        const requestId = req.id;
        const makerApiKey = req.headers[constants_1.RFQ_MAKER_API_KEY_HEADER];
        const makerId = this._rfqMakerService.mapMakerApiKeyToId(makerApiKey);
        if (makerId === null) {
            const message = `Invalid api key.`;
            logger_1.logger.info({ requestId, apiKey: makerApiKey }, message);
            RFQ_MAKER_INVALID_KEY.inc();
            res.status(HttpStatus.UNAUTHORIZED).send({ error: message });
            return;
        }
        if (!rfq_maker_service_1.RfqMakerService.isValidChainId(req.params.chainId)) {
            const message = `Invalid chainId.`;
            logger_1.logger.info({ requestId, makerId, chainId: req.params.chainId }, message);
            RFQ_MAKER_GET_CLIENT_ERROR.labels(makerId).inc();
            res.status(HttpStatus.BAD_REQUEST).send({ error: message });
            return;
        }
        const chainId = Number(req.params.chainId);
        try {
            const rfqMaker = await this._rfqMakerService.getRfqMakerAsync(makerId, chainId);
            res.status(HttpStatus.OK).send(rfqMaker);
            logger_1.logger.info({ requestId, makerId, chainId }, 'Successfully got RfqMaker entity.');
            RFQ_MAKER_GET_SUCCEED.labels(makerId).inc();
        }
        catch (error) {
            const message = `Failed to get RfqMaker entity.`;
            logger_1.logger.error({ requestId, makerId, chainId, errorMessage: error.message }, message);
            RFQ_MAKER_GET_SEVER_ERROR.labels(makerId).inc();
            res.status(HttpStatus.INTERNAL_SERVER_ERROR).send({ message });
        }
    }
}
exports.RfqMakerHandlers = RfqMakerHandlers;
//# sourceMappingURL=data:application/json;charset=utf-8;base64,eyJmaWxlIjoiL1VzZXJzL2Rhdmlkd2Fsc2gvY29kZS1sb2NhbC8weC1yZnEtYXBpL3NyYy9oYW5kbGVycy9yZnFfbWFrZXJfaGFuZGxlcnMudHMiLCJtYXBwaW5ncyI6Ijs7O0FBQ0EsZ0RBQWdEO0FBQ2hELDZDQUFzQztBQUV0QyxpREFBNkQ7QUFFN0Qsc0NBQW1DO0FBQ25DLHFFQUFnRTtBQUVoRSxNQUFNLHFCQUFxQixHQUFHLElBQUkscUJBQU8sQ0FBQztJQUN0QyxJQUFJLEVBQUUsdUJBQXVCO0lBQzdCLElBQUksRUFBRSxpRUFBaUU7Q0FDMUUsQ0FBQyxDQUFDO0FBQ0gsTUFBTSw2QkFBNkIsR0FBRyxJQUFJLHFCQUFPLENBQUM7SUFDOUMsSUFBSSxFQUFFLCtCQUErQjtJQUNyQyxJQUFJLEVBQUUsd0VBQXdFO0lBQzlFLFVBQVUsRUFBRSxDQUFDLFNBQVMsQ0FBQztDQUMxQixDQUFDLENBQUM7QUFDSCxNQUFNLDRCQUE0QixHQUFHLElBQUkscUJBQU8sQ0FBQztJQUM3QyxJQUFJLEVBQUUsOEJBQThCO0lBQ3BDLElBQUksRUFBRSx1RUFBdUU7SUFDN0UsVUFBVSxFQUFFLENBQUMsU0FBUyxDQUFDO0NBQzFCLENBQUMsQ0FBQztBQUNILE1BQU0sd0JBQXdCLEdBQUcsSUFBSSxxQkFBTyxDQUFDO0lBQ3pDLElBQUksRUFBRSwwQkFBMEI7SUFDaEMsSUFBSSxFQUFFLDhDQUE4QztJQUNwRCxVQUFVLEVBQUUsQ0FBQyxTQUFTLENBQUM7Q0FDMUIsQ0FBQyxDQUFDO0FBQ0gsTUFBTSwwQkFBMEIsR0FBRyxJQUFJLHFCQUFPLENBQUM7SUFDM0MsSUFBSSxFQUFFLDRCQUE0QjtJQUNsQyxJQUFJLEVBQUUsNkRBQTZEO0lBQ25FLFVBQVUsRUFBRSxDQUFDLFNBQVMsQ0FBQztDQUMxQixDQUFDLENBQUM7QUFDSCxNQUFNLHlCQUF5QixHQUFHLElBQUkscUJBQU8sQ0FBQztJQUMxQyxJQUFJLEVBQUUsMkJBQTJCO0lBQ2pDLElBQUksRUFBRSxxRUFBcUU7SUFDM0UsVUFBVSxFQUFFLENBQUMsU0FBUyxD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QUM7WUFDaEQsR0FBRyxDQUFDLE1BQU0sQ0FBQyxVQUFVLENBQUMscUJBQXFCLENBQUMsQ0FBQyxJQUFJLENBQUMsRUFBRSxPQUFPLEVBQUUsQ0FBQyxDQUFDO1NBQ2xFO0lBQ0wsQ0FBQztDQUNKO0FBOUpELDRDQThKQyIsIm5hbWVzIjpbXSwic291cmNlcyI6WyIvVXNlcnMvZGF2aWR3YWxzaC9jb2RlLWxvY2FsLzB4LXJmcS1hcGkvc3JjL2hhbmRsZXJzL3JmcV9tYWtlcl9oYW5kbGVycy50cyJdLCJzb3VyY2VzQ29udGVudCI6WyJpbXBvcnQgKiBhcyBleHByZXNzIGZyb20gJ2V4cHJlc3MnO1xuaW1wb3J0ICogYXMgSHR0cFN0YXR1cyBmcm9tICdodHRwLXN0YXR1cy1jb2Rlcyc7XG5pbXBvcnQgeyBDb3VudGVyIH0gZnJvbSAncHJvbS1jbGllbnQnO1xuXG5pbXBvcnQgeyBSRlFfTUFLRVJfQVBJX0tFWV9IRUFERVIgfSBmcm9tICcuLi9jb3JlL2NvbnN0YW50cyc7XG5pbXBvcnQgeyBSZnFNYWtlciB9IGZyb20gJy4uL2VudGl0aWVzJztcbmltcG9ydCB7IGxvZ2dlciB9IGZyb20gJy4uL2xvZ2dlcic7XG5pbXBvcnQgeyBSZnFNYWtlclNlcnZpY2UgfSBmcm9tICcuLi9zZXJ2aWNlcy9yZnFfbWFrZXJfc2VydmljZSc7XG5cbmNvbnN0IFJGUV9NQUtFUl9JTlZBTElEX0tFWSA9IG5ldyBDb3VudGVyKHtcbiAgICBuYW1lOiAncmZxX21ha2VyX2ludmFsaWRfa2V5JyxcbiAgICBoZWxwOiAnQSByZXF1ZXN0IHRvIG1ha2VyIGVuZHBvaW50cyBmYWlsZWQgYmVjYXVzZSBvZiBpbnZhbGlkIGFwaSBrZXkuJyxcbn0pO1xuY29uc3QgUkZRX01BS0VSX1VQREFURV9DTElFTlRfRVJST1IgPSBuZXcgQ291bnRlcih7XG4gICAgbmFtZTogJ3JmcV9tYWtlcl91cGRhdGVfY2xpZW50X2Vycm9yJyxcbiAgICBoZWxwOiAnQSByZXF1ZXN0IHRvIHVwZGF0ZSBtYWtlciBjb25maWdzIGZhaWxlZCBiZWNhdXNlIG9mIGNsaWVudCBzaWRlIGVycm9yLicsXG4gICAgbGFiZWxOYW1lczogWydtYWtlcklkJ10sXG59KTtcbmNvbnN0IFJGUV9NQUtFUl9VUERBVEVfU0VWRVJfRVJST1IgPSBuZXcgQ291bnRlcih7XG4gICAgbmFtZTogJ3JmcV9tYWtlcl91cGRhdGVfc2V2ZXJfZXJyb3InLFxuICAgIGhlbHA6ICdBIHJlcXVlc3QgdG8gdXBkYXRlIG1ha2VyIGNvbmZpZ3MgZmFpbGVkIGJlY2F1c2Ugb2Ygc2V2ZXIgc2lkZSBlcnJvci4nLFxuICAgIGxhYmVsTmFtZXM6IFsnbWFrZXJJZCddLFxufSk7XG5jb25zdCBSRlFfTUFLRVJfVVBEQVRFX1NVQ0NFRUQgPSBuZXcgQ291bnRlcih7XG4gICAgbmFtZTogJ3JmcV9tYWtlcl91cGRhdGVfc3VjY2VlZCcsXG4gICAgaGVscDogJ0EgcmVxdWVzdCB0byB1cGRhdGUgbWFrZXIgY29uZmlncyBzdWNjZWVkZWQuJyxcbiAgICBsYWJlbE5hbWVzOiBbJ21ha2VySWQnXSxcbn0pO1xuY29uc3QgUkZRX01BS0VSX0dFVF9DTElFTlRfRVJST1IgPSBuZXcgQ291bnRlcih7XG4gICAgbmFtZTogJ3JmcV9tYWtlcl9nZXRfY2xpZW50X2Vycm9yJyxcbiAgICBoZWxwOiAnQSByZXF1ZXN0IHRvIEdFVCBtYWtlciBmYWlsZWQgYmVjYXVzZSBvZiBjbGllbnQgc2lkZSBlcnJvci4nLFxuICAgIGxhYmVsTmFtZXM6IFsnbWFrZXJJZCddLFxufSk7XG5jb25zdCBSRlFfTUFLRVJfR0VUX1NFVkVSX0VSUk9SID0gbmV3IENvdW50ZXIoe1xuICAgIG5hbWU6ICdyZnFfbWFrZXJfZ2V0X3NldmVyX2Vycm9yJyxcbiAgICBoZWxwOiAnQSByZXF1ZXN0IHRvIEdFVCBtYWtlciBlbmRwb2ludCBmYWlsZWQgYmVjYXVzZSBvZiBzZXZlciBzaWRlIGVycm9yLicsXG4gICAgbGFiZWxOYW1lczogWydtYWtlcklkJ10sXG59KTtcbmNvbnN0IFJGUV9NQUtFUl9HRVRfU1VDQ0VFRCA9IG5ldyBDb3VudGVyKHtcbiAgICBuYW1lOiAncmZxX21ha2VyX2dldF9zdWNjZWVkJyxcbiAgICBoZWxwOiAnQSByZXF1ZXN0IHRvIEdFVCBtYWtlciBzdWNjZWVkZWQuJyxcbiAgICBsYWJlbE5hbWVzOiBbJ21ha2VySWQnXSxcbn0pO1xuXG5jb25zdCBjb252ZXJ0VG9Mb3dlckNhc2UgPSAocGFpcnM6IFtzdHJpbmcsIHN0cmluZ11bXSk6IFtzdHJpbmcsIHN0cmluZ11bXSA9PiB7XG4gICAgcmV0dXJuIHBhaXJzLm1hcCgocGFpcikgPT4ge1xuICAgICAgICByZXR1cm4gW3BhaXJbMF0udG9Mb3dlckNhc2UoKSwgcGFpclsxXS50b0xvd2VyQ2FzZSgpXTtcbiAgICB9KTtcbn07XG5cbi8qKlxuICogVmFsaWRhdGVzIHRoZSByZXF1ZXN0IGJvZHkgb2YgYSBQVVQgcmVxdWVzdC5cbiAqL1xuY29uc3QgdmFsaWRhdGVQdXRQYXlsb2FkT3JUaHJvdyA9IChib2R5OiB7IHBhaXJzOiBbXTsgcmZxdFVyaTogc3RyaW5nOyByZnFtVXJpOiBzdHJpbmcgfSkgPT4ge1xuICAgIFJmcU1ha2VyU2VydmljZS52YWxpZGF0ZVBhaXJzUGF5bG9hZE9yVGhyb3coYm9keS5wYWlycyk7XG4gICAgUmZxTWFrZXJTZXJ2aWNlLnZhbGlkYXRlVXJpT3JUaHJvdygncmZxdFVyaScsIGJvZHkucmZxdFVyaSk7XG4gICAgUmZxTWFrZXJTZXJ2aWNlLnZhbGlkYXRlVXJpT3JUaHJvdygncmZxbVVyaScsIGJvZHkucmZxbVVyaSk7XG59O1xuXG4vKipcbiAqIFZhbGlkYXRlcyB0aGUgcmVxdWVzdCBib2R5IG9mIGEgUEFUQ0ggcmVxdWVzdC5cbiAqL1xuY29uc3QgdmFsaWRhdGVQYXRjaFBheWxvYWRPclRocm93ID0gKGJvZHk6IHsgcGFpcnM/OiBbXTsgcmZxdFVyaT86IHN0cmluZzsgcmZxbVVyaT86IHN0cmluZyB9KSA9PiB7XG4gICAgaWYgKGJvZHkucGFpcnMgIT09IHVuZGVmaW5lZCkge1xuICAgICAgICBSZnFNYWtlclNlcnZpY2UudmFsaWRhdGVQYWlyc1BheWxvYWRPclRocm93KGJvZHkucGFpcnMpO1xuICAgIH1cblxuICAgIGlmIChib2R5LnJmcXRVcmkgIT09IHVuZGVmaW5lZCkge1xuICAgICAgICBSZnFNYWtlclNlcnZpY2UudmFsaWRhdGVVcmlPclRocm93KCdyZnF0VXJpJywgYm9keS5yZnF0VXJpKTtcbiAgICB9XG5cbiAgICBpZiAoYm9keS5yZnFtVXJpICE9PSB1bmRlZmluZWQpIHtcbiAgICAgICAgUmZxTWFrZXJTZXJ2aWNlLnZhbGlkYXRlVXJpT3JUaHJvdygncmZxbVVyaScsIGJvZHkucmZxbVVyaSk7XG4gICAgfVxuXG4gICAgaWYgKGJvZHkucGFpcnMgPT09IHVuZGVmaW5lZCAmJiBib2R5LnJmcXRVcmkgPT09IHVuZGVmaW5lZCAmJiBib2R5LnJmcW1VcmkgPT09IHVuZGVmaW5lZCkge1xuICAgICAgICB0aHJvdyBuZXcgRXJyb3IoJ05vIHZhbGlkIGZpZWxkIGlzIHNwZWNpZmllZC4nKTtcbiAgICB9XG59O1xuXG5leHBvcnQgY2xhc3MgUmZxTWFrZXJIYW5kbGVycyB7XG4gICAgY29uc3RydWN0b3IocHJpdmF0ZSByZWFkb25seSBfcmZxTWFrZXJTZXJ2aWNlOiBSZnFNYWtlclNlcnZpY2UpIHt9XG5cbiAgICAvKipcbiAgICAgKiBIYW5kbGVyIGZvciBQVVQgb3BlcmF0aW9uIG9mIHRoZSBgL21ha2VyL3YxL2NoYWluLWlkLzpjaGFpbklkYCBlbmRwb2ludC5cbiAgICAgKi9cbiAgICBwdWJsaWMgYXN5bmMgcHV0UmZxTWFrZXJBc3luYyhyZXE6IGV4cHJlc3MuUmVxdWVzdCwgcmVzOiBleHByZXNzLlJlc3BvbnNlKTogUHJvbWlzZTx2b2lkPiB7XG4gICAgICAgIGNvbnN0IHJlcXVlc3RJZCA9IHJlcS5pZDtcbiAgICAgICAgY29uc3QgbWFrZXJBcGlLZXkgPSByZXEuaGVhZGVyc1tSRlFfTUFLRVJfQVBJX0tFWV9IRUFERVJdIGFzIHN0cmluZztcbiAgICAgICAgY29uc3QgbWFrZXJJZCA9IHRoaXMuX3JmcU1ha2VyU2VydmljZS5tYXBNYWtlckFwaUtleVRvSWQobWFrZXJBcGlLZXkpO1xuXG4gICAgICAgIGlmIChtYWtlcklkID09PSBudWxsKSB7XG4gICAgICAgICAgICBjb25zdCBtZXNzYWdlID0gYEludmFsaWQgYXBpIGtleS5gO1xuICAgICAgICAgICAgbG9nZ2VyLmluZm8oeyByZXF1ZXN0SWQsIGFwaUtleTogbWFrZXJBcGlLZXkgfSwgbWVzc2FnZSk7XG4gICAgICAgICAgICBSRlFfTUFLRVJfSU5WQUxJRF9LRVkuaW5jKCk7XG4gICAgICAgICAgICByZXMuc3RhdHVzKEh0dHBTdGF0dXMuVU5BVVRIT1JJWkVEKS5zZW5kKHsgZXJyb3I6IG1lc3NhZ2UgfSk7XG4gICAgICAgICAgICByZXR1cm47XG4gICAgICAgIH1cblxuICAgICAgICBpZiAoIVJmcU1ha2VyU2VydmljZS5pc1ZhbGlkQ2hhaW5JZChyZXEucGFyYW1zLmNoYWluSWQpKSB7XG4gICAgICAgICAgICBjb25zdCBtZXNzYWdlID0gYEludmFsaWQgY2hhaW5JZC5gO1xuICAgICAgICAgICAgbG9nZ2VyLmluZm8oeyByZXF1ZXN0SWQsIG1ha2VySWQsIGNoYWluSWQ6IHJlcS5wYXJhbXMuY2hhaW5JZCB9LCBtZXNzYWdlKTtcbiAgICAgICAgICAgIFJGUV9NQUtFUl9VUERBVEVfQ0xJRU5UX0VSUk9SLmxhYmVscyhtYWtlcklkKS5pbmMoKTtcbiAgICAgICAgICAgIHJlcy5zdGF0dXMoSHR0cFN0YXR1cy5CQURfUkVRVUVTVCkuc2VuZCh7IGVycm9yOiBtZXNzYWdlIH0pO1xuICAgICAgICAgICAgcmV0dXJuO1xuICAgICAgICB9XG5cbiAgICAgICAgY29uc3QgY2hhaW5JZCA9IE51bWJlcihyZXEucGFyYW1zLmNoYWluSWQpO1xuICAgICAgICB0cnkge1xuICAgICAgICAgICAgdmFsaWRhdGVQdXRQYXlsb2FkT3JUaHJvdyhyZXEuYm9keSk7XG4gICAgICAgIH0gY2F0Y2ggKHsgbWVzc2FnZSB9KSB7XG4gICAgICAgICAgICBsb2dnZXIuaW5mbyh7IHJlcXVlc3RJZCwgbWFrZXJJZCwgY2hhaW5JZCB9LCBtZXNzYWdlKTtcbiAgICAgICAgICAgIFJGUV9NQUtFUl9VUERBVEVfQ0xJRU5UX0VSUk9SLmxhYmVscyhtYWtlcklkKS5pbmMoKTtcbiAgICAgICAgICAgIHJlcy5zdGF0dXMoSHR0cFN0YXR1cy5CQURfUkVRVUVTVCkuc2VuZCh7IGVycm9yOiBtZXNzYWdlIH0pO1xuICAgICAgICAgICAgcmV0dXJuO1xuICAgICAgICB9XG5cbiAgICAgICAgdHJ5IHtcbiAgICAgICAgICAgIGNvbnN0IHBhaXJzID0gcmVxLmJvZHkucGFpcnM7XG4gICAgICAgICAgICBjb25zdCByZnF0VXJpID0gcmVxLmJvZHkucmZxdFVyaTtcbiAgICAgICAgICAgIGNvbnN0IHJmcW1VcmkgPSByZXEuYm9keS5yZnFtVXJpO1xuICAgICAgICAgICAgY29uc3QgcmZxTWFrZXI6IFJmcU1ha2VyID0gYXdhaXQgdGhpcy5fcmZxTWFrZXJTZXJ2aWNlLmNyZWF0ZU9yVXBkYXRlUmZxTWFrZXJBc3luYyhcbiAgICAgICAgICAgICAgICBtYWtlcklkLFxuICAgICAgICAgICAgICAgIGNoYWluSWQsXG4gICAgICAgICAgICAgICAgY29udmVydFRvTG93ZXJDYXNlKHBhaXJzKSxcbiAgICAgICAgICAgICAgICByZnF0VXJpLFxuICAgICAgICAgICAgICAgIHJmcW1VcmksXG4gICAgICAgICAgICApO1xuICAgICAgICAgICAgcmVzLnN0YXR1cyhIdHRwU3RhdHVzLkNSRUFURUQpLnNlbmQocmZxTWFrZXIpO1xuICAgICAgICAgICAgY29uc3QgcmZxbU1ha2VyVXJpID0gcmZxTWFrZXIucmZxbVVyaTtcbiAgICAgICAgICAgIGxvZ2dlci5pbmZvKFxuICAgICAgICAgICAgICAgIHsgcmVxdWVzdElkLCBtYWtlcklkLCBjaGFpbklkLCByZnFtTWFrZXJVcmkgfSxcbiAgICAgICAgICAgICAgICAnU3VjY2Vzc2Z1bGx5IGNyZWF0ZWQgb3IgdXBkYXRlZCBSZnFNYWtlciBlbnRpdHkuJyxcbiAgICAgICAgICAgICk7XG4gICAgICAgICAgICBSRlFfTUFLRVJfVVBEQVRFX1NVQ0NFRUQubGFiZWxzKG1ha2VySWQpLmluYygpO1xuICAgICAgICB9IGNhdGNoIChlcnJvcikge1xuICAgICAgICAgICAgY29uc3QgbWVzc2FnZSA9IGBGYWlsZWQgdG8gY3JlYXRlIG9yIHVwZGF0ZSBSZnFNYWtlciBlbnRpdHkuYDtcbiAgICAgICAgICAgIGxvZ2dlci5lcnJvcih7IHJlcXVlc3RJZCwgbWFrZXJJZCwgY2hhaW5JZCwgZXJyb3JNZXNzYWdlOiBlcnJvci5tZXNzYWdlIH0sIG1lc3NhZ2UpO1xuICAgICAgICAgICAgUkZRX01BS0VSX1VQREFURV9TRVZFUl9FUlJPUi5sYWJlbHMobWFrZXJJZCkuaW5jKCk7XG4gICAgICAgICAgICByZXMuc3RhdHVzKEh0dHBTdGF0dXMuSU5URVJOQUxfU0VSVkVSX0VSUk9SKS5zZW5kKHsgbWVzc2FnZSB9KTtcbiAgICAgICAgfVxuICAgIH1cblxuICAgIC8qKlxuICAgICAqIEhhbmRsZXIgZm9yIFBBVENIIG9wZXJhdGlvbiBvZiB0aGUgYC9tYWtlci92MS9jaGFpbi1pZC86Y2hhaW5JZGAgZW5kcG9pbnQuXG4gICAgICovXG4gICAgcHVibGljIGFzeW5jIHBhdGNoUmZxTWFrZXJBc3luYyhyZXE6IGV4cHJlc3MuUmVxdWVzdCwgcmVzOiBleHByZXNzLlJlc3BvbnNlKTogUHJvbWlzZTx2b2lkPiB7XG4gICAgICAgIGNvbnN0IHJlcXVlc3RJZCA9IHJlcS5pZDtcbiAgICAgICAgY29uc3QgbWFrZXJBcGlLZXkgPSByZXEuaGVhZGVyc1tSRlFfTUFLRVJfQVBJX0tFWV9IRUFERVJdIGFzIHN0cmluZztcbiAgICAgICAgY29uc3QgbWFrZXJJZCA9IHRoaXMuX3JmcU1ha2VyU2VydmljZS5tYXBNYWtlckFwaUtleVRvSWQobWFrZXJBcGlLZXkpO1xuXG4gICAgICAgIGlmIChtYWtlcklkID09PSBudWxsKSB7XG4gICAgICAgICAgICBjb25zdCBtZXNzYWdlID0gYEludmFsaWQgYXBpIGtleS5gO1xuICAgICAgICAgICAgbG9nZ2VyLmluZm8oeyByZXF1ZXN0SWQsIGFwaUtleTogbWFrZXJBcGlLZXkgfSwgbWVzc2FnZSk7XG4gICAgICAgICAgICBSRlFfTUFLRVJfSU5WQUxJRF9LRVkuaW5jKCk7XG4gICAgICAgICAgICByZXMuc3RhdHVzKEh0dHBTdGF0dXMuVU5BVVRIT1JJWkVEKS5zZW5kKHsgZXJyb3I6IG1lc3NhZ2UgfSk7XG4gICAgICAgICAgICByZXR1cm47XG4gICAgICAgIH1cblxuICAgICAgICBpZiAoIVJmcU1ha2VyU2VydmljZS5pc1ZhbGlkQ2hhaW5JZChyZXEucGFyYW1zLmNoYWluSWQpKSB7XG4gICAgICAgICAgICBjb25zdCBtZXNzYWdlID0gYEludmFsaWQgY2hhaW5JZC5gO1xuICAgICAgICAgICAgbG9nZ2VyLmluZm8oeyByZXF1ZXN0SWQsIG1ha2VySWQsIGNoYWluSWQ6IHJlcS5wYXJhbXMuY2hhaW5JZCB9LCBtZXNzYWdlKTtcbiAgICAgICAgICAgIFJGUV9NQUtFUl9VUERBVEVfQ0xJRU5UX0VSUk9SLmxhYmVscyhtYWtlcklkKS5pbmMoKTtcbiAgICAgICAgICAgIHJlcy5zdGF0dXMoSHR0cFN0YXR1cy5CQURfUkVRVUVTVCkuc2VuZCh7IGVycm9yOiBtZXNzYWdlIH0pO1xuICAgICAgICAgICAgcmV0dXJuO1xuICAgICAgICB9XG5cbiAgICAgICAgY29uc3QgY2hhaW5JZCA9IE51bWJlcihyZXEucGFyYW1zLmNoYWluSWQpO1xuICAgICAgICB0cnkge1xuICAgICAgICAgICAgdmFsaWRhdGVQYXRjaFBheWxvYWRPclRocm93KHJlcS5ib2R5KTtcbiAgICAgICAgfSBjYXRjaCAoeyBtZXNzYWdlIH0pIHtcbiAgICAgICAgICAgIGxvZ2dlci5pbmZvKHsgcmVxdWVzdElkLCBtYWtlcklkLCBjaGFpbklkIH0sIG1lc3NhZ2UpO1xuICAgICAgICAgICAgUkZRX01BS0VSX1VQREFURV9DTElFTlRfRVJST1IubGFiZWxzKG1ha2VySWQpLmluYygpO1xuICAgICAgICAgICAgcmVzLnN0YXR1cyhIdHRwU3RhdHVzLkJBRF9SRVFVRVNUKS5zZW5kKHsgZXJyb3I6IG1lc3NhZ2UgfSk7XG4gICAgICAgICAgICByZXR1cm47XG4gICAgICAgIH1cblxuICAgICAgICB0cnkge1xuICAgICAgICAgICAgY29uc3QgcGFpcnMgPSByZXEuYm9keS5wYWlycztcbiAgICAgICAgICAgIGNvbnN0IHJmcXRVcmkgPSByZXEuYm9keS5yZnF0VXJpO1xuICAgICAgICAgICAgY29uc3QgcmZxbVVyaSA9IHJlcS5ib2R5LnJmcW1Vcmk7XG4gICAgICAgICAgICBjb25zdCByZnFNYWtlcjogUmZxTWFrZXIgPSBhd2FpdCB0aGlzLl9yZnFNYWtlclNlcnZpY2UucGF0Y2hSZnFNYWtlckFzeW5jKFxuICAgICAgICAgICAgICAgIG1ha2VySWQsXG4gICAgICAgICAgICAgICAgY2hhaW5JZCxcbiAgICAgICAgICAgICAgICBwYWlycyAhPT0gdW5kZWZpbmVkID8gY29udmVydFRvTG93ZXJDYXNlKHBhaXJzKSA6IHVuZGVmaW5lZCxcbiAgICAgICAgICAgICAgICByZnF0VXJpLFxuICAgICAgICAgICAgICAgIHJmcW1VcmksXG4gICAgICAgICAgICApO1xuICAgICAgICAgICAgcmVzLnN0YXR1cyhIdHRwU3RhdHVzLk9LKS5zZW5kKHJmcU1ha2VyKTtcbiAgICAgICAgICAgIGNvbnN0IHJmcW1NYWtlclVyaSA9IHJmcU1ha2VyLnJmcW1Vcmk7XG4gICAgICAgICAgICBsb2dnZXIuaW5mbyh7IHJlcXVlc3RJZCwgbWFrZXJJZCwgY2hhaW5JZCwgcmZxbU1ha2VyVXJpIH0sICdTdWNjZXNzZnVsbHkgcGF0Y2hlZCBSZnFNYWtlciBlbnRpdHkuJyk7XG4gICAgICAgICAgICBSRlFfTUFLRVJfVVBEQVRFX1NVQ0NFRUQubGFiZWxzKG1ha2VySWQpLmluYygpO1xuICAgICAgICB9IGNhdGNoIChlcnJvcikge1xuICAgICAgICAgICAgY29uc3QgbWVzc2FnZSA9IGBGYWlsZWQgdG8gcGF0Y2ggUmZxTWFrZXIgZW50aXR5LmA7XG4gICAgICAgICAgICBsb2dnZXIuZXJyb3IoeyByZXF1ZXN0SWQsIG1ha2VySWQsIGNoYWluSWQsIGVycm9yTWVzc2FnZTogZXJyb3IubWVzc2FnZSB9LCBtZXNzYWdlKTtcbiAgICAgICAgICAgIFJGUV9NQUtFUl9VUERBVEVfU0VWRVJfRVJST1IubGFiZWxzKG1ha2VySWQpLmluYygpO1xuICAgICAgICAgICAgcmVzLnN0YXR1cyhIdHRwU3RhdHVzLklOVEVSTkFMX1NFUlZFUl9FUlJPUikuc2VuZCh7IG1lc3NhZ2UgfSk7XG4gICAgICAgIH1cbiAgICB9XG5cbiAgICAvKipcbiAgICAgKiBIYW5kbGVyIGZvciBHRVQgb3BlcmF0aW9uIG9mIHRoZSBgL21ha2VyL3YxL2NoYWluLWlkLzpjaGFpbklkYCBlbmRwb2ludC5cbiAgICAgKi9cbiAgICBwdWJsaWMgYXN5bmMgZ2V0UmZxTWFrZXJBc3luYyhyZXE6IGV4cHJlc3MuUmVxdWVzdCwgcmVzOiBleHByZXNzLlJlc3BvbnNlKTogUHJvbWlzZTx2b2lkPiB7XG4gICAgICAgIGNvbnN0IHJlcXVlc3RJZCA9IHJlcS5pZDtcbiAgICAgICAgY29uc3QgbWFrZXJBcGlLZXkgPSByZXEuaGVhZGVyc1tSRlFfTUFLRVJfQVBJX0tFWV9IRUFERVJdIGFzIHN0cmluZztcbiAgICAgICAgY29uc3QgbWFrZXJJZCA9IHRoaXMuX3JmcU1ha2VyU2VydmljZS5tYXBNYWtlckFwaUtleVRvSWQobWFrZXJBcGlLZXkpO1xuXG4gICAgICAgIGlmIChtYWtlcklkID09PSBudWxsKSB7XG4gICAgICAgICAgICBjb25zdCBtZXNzYWdlID0gYEludmFsaWQgYXBpIGtleS5gO1xuICAgICAgICAgICAgbG9nZ2VyLmluZm8oeyByZXF1ZXN0SWQsIGFwaUtleTogbWFrZXJBcGlLZXkgfSwgbWVzc2FnZSk7XG4gICAgICAgICAgICBSRlFfTUFLRVJfSU5WQUxJRF9LRVkuaW5jKCk7XG4gICAgICAgICAgICByZXMuc3RhdHVzKEh0dHBTdGF0dXMuVU5BVVRIT1JJWkVEKS5zZW5kKHsgZXJyb3I6IG1lc3NhZ2UgfSk7XG4gICAgICAgICAgICByZXR1cm47XG4gICAgICAgIH1cblxuICAgICAgICBpZiAoIVJmcU1ha2VyU2VydmljZS5pc1ZhbGlkQ2hhaW5JZChyZXEucGFyYW1zLmNoYWluSWQpKSB7XG4gICAgICAgICAgICBjb25zdCBtZXNzYWdlID0gYEludmFsaWQgY2hhaW5JZC5gO1xuICAgICAgICAgICAgbG9nZ2VyLmluZm8oeyByZXF1ZXN0SWQsIG1ha2VySWQsIGNoYWluSWQ6IHJlcS5wYXJhbXMuY2hhaW5JZCB9LCBtZXNzYWdlKTtcbiAgICAgICAgICAgIFJGUV9NQUtFUl9HRVRfQ0xJRU5UX0VSUk9SLmxhYmVscyhtYWtlcklkKS5pbmMoKTtcbiAgICAgICAgICAgIHJlcy5zdGF0dXMoSHR0cFN0YXR1cy5CQURfUkVRVUVTVCkuc2VuZCh7IGVycm9yOiBtZXNzYWdlIH0pO1xuICAgICAgICAgICAgcmV0dXJuO1xuICAgICAgICB9XG5cbiAgICAgICAgY29uc3QgY2hhaW5JZCA9IE51bWJlcihyZXEucGFyYW1zLmNoYWluSWQpO1xuXG4gICAgICAgIHRyeSB7XG4gICAgICAgICAgICBjb25zdCByZnFNYWtlcjogUmZxTWFrZXIgPSBhd2FpdCB0aGlzLl9yZnFNYWtlclNlcnZpY2UuZ2V0UmZxTWFrZXJBc3luYyhtYWtlcklkLCBjaGFpbklkKTtcbiAgICAgICAgICAgIHJlcy5zdGF0dXMoSHR0cFN0YXR1cy5PSykuc2VuZChyZnFNYWtlcik7XG4gICAgICAgICAgICBsb2dnZXIuaW5mbyh7IHJlcXVlc3RJZCwgbWFrZXJJZCwgY2hhaW5JZCB9LCAnU3VjY2Vzc2Z1bGx5IGdvdCBSZnFNYWtlciBlbnRpdHkuJyk7XG4gICAgICAgICAgICBSRlFfTUFLRVJfR0VUX1NVQ0NFRUQubGFiZWxzKG1ha2VySWQpLmluYygpO1xuICAgICAgICB9IGNhdGNoIChlcnJvcikge1xuICAgICAgICAgICAgY29uc3QgbWVzc2FnZSA9IGBGYWlsZWQgdG8gZ2V0IFJmcU1ha2VyIGVudGl0eS5gO1xuICAgICAgICAgICAgbG9nZ2VyLmVycm9yKHsgcmVxdWVzdElkLCBtYWtlcklkLCBjaGFpbklkLCBlcnJvck1lc3NhZ2U6IGVycm9yLm1lc3NhZ2UgfSwgbWVzc2FnZSk7XG4gICAgICAgICAgICBSRlFfTUFLRVJfR0VUX1NFVkVSX0VSUk9SLmxhYmVscyhtYWtlcklkKS5pbmMoKTtcbiAgICAgICAgICAgIHJlcy5zdGF0dXMoSHR0cFN0YXR1cy5JTlRFUk5BTF9TRVJWRVJfRVJST1IpLnNlbmQoeyBtZXNzYWdlIH0pO1xuICAgICAgICB9XG4gICAgfVxufVxuIl0sInZlcnNpb24iOjN9