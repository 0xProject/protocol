f52eece625e2c534d540c0e438d887e7
"use strict";
Object.defineProperty(exports, "__esModule", { value: true });
exports.returnQuoteFromAltMMAsync = void 0;
const dev_utils_1 = require("@0x/dev-utils");
const utils_1 = require("@0x/utils");
const logger_1 = require("../logger");
const altMmTypes_1 = require("./altMmTypes");
const SUCCESS_CODE = 201;
// https://github.com/0xProject/protocol/blob/fe935f787cbe8c9116ff702195f3161e86c1aea4/packages/asset-swapper/src/constants.ts#L31
const ALT_MM_IMPUTED_INDICATIVE_EXPIRY_SECONDS = 180;
function getAltMarketInfo(offerings, buyTokenAddress, sellTokenAddress) {
    for (const offering of offerings) {
        if ((buyTokenAddress.toLowerCase() === offering.baseAsset.toLowerCase() &&
            sellTokenAddress.toLowerCase() === offering.quoteAsset.toLowerCase()) ||
            (sellTokenAddress.toLowerCase() === offering.baseAsset.toLowerCase() &&
                buyTokenAddress.toLowerCase() === offering.quoteAsset.toLowerCase())) {
            return offering;
        }
    }
    return undefined;
}
function parseFirmQuoteResponseFromAltMM(altFirmQuoteReponse) {
    return {
        signedOrder: altFirmQuoteReponse.data['0xv4order'],
    };
}
function parseIndicativeQuoteResponseFromAltMM(altIndicativeQuoteResponse, altPair, makerToken, takerToken) {
    let makerAmount;
    let takerAmount;
    let quoteAmount;
    let baseAmount;
    if (!altIndicativeQuoteResponse.price) {
        throw new Error('Price not returned by alt MM');
    }
    if (altIndicativeQuoteResponse.amount) {
        // if amount is specified, amount is the base token amount
        baseAmount = dev_utils_1.Web3Wrapper.toBaseUnitAmount(new utils_1.BigNumber(altIndicativeQuoteResponse.amount), altPair.baseAssetDecimals);
        // if amount is specified, use the price (quote/base) to get the quote amount
        quoteAmount = dev_utils_1.Web3Wrapper.toBaseUnitAmount(new utils_1.BigNumber(altIndicativeQuoteResponse.amount)
            .times(new utils_1.BigNumber(altIndicativeQuoteResponse.price))
            .decimalPlaces(altPair.quoteAssetDecimals, utils_1.BigNumber.ROUND_DOWN), altPair.quoteAssetDecimals);
    }
    else if (altIndicativeQuoteResponse.value) {
        // if value is specified, value is the quote token amount
        quoteAmount = dev_utils_1.Web3Wrapper.toBaseUnitAmount(new utils_1.BigNumber(altIndicativeQuoteResponse.value), altPair.quoteAssetDecimals);
        // if value is specified, use the price (quote/base) to get the base amount
        baseAmount = dev_utils_1.Web3Wrapper.toBaseUnitAmount(new utils_1.BigNumber(altIndicativeQuoteResponse.value)
            .dividedBy(new utils_1.BigNumber(altIndicativeQuoteResponse.price))
            .decimalPlaces(altPair.baseAssetDecimals, utils_1.BigNumber.ROUND_DOWN), altPair.baseAssetDecimals);
    }
    else {
        throw new Error('neither amount or value were specified');
    }
    if (makerToken.toLowerCase() === altPair.baseAsset.toLowerCase()) {
        makerAmount = baseAmount;
        takerAmount = quoteAmount;
    }
    else if (makerToken.toLowerCase() === altPair.quoteAsset.toLowerCase()) {
        makerAmount = quoteAmount;
        takerAmount = baseAmount;
    }
    else {
        throw new Error(`Base, quote tokens don't align with maker, taker tokens`);
    }
    return {
        makerToken,
        makerAmount,
        takerToken,
        takerAmount,
        // HACK: alt implementation does not return an expiration with indicative quotes
        // return now + { IMPUTED EXPIRY SECONDS } to have it included after order checks
        expiry: 
        // tslint:disable-next-line:custom-no-magic-numbers
        new utils_1.BigNumber(Date.now() / 1000)
            .integerValue(utils_1.BigNumber.ROUND_DOWN)
            .plus(ALT_MM_IMPUTED_INDICATIVE_EXPIRY_SECONDS),
    };
}
/**
 * Turn a standard quote request into an alt quote request
 * and return the appropriate standard quote response
 */
async function returnQuoteFromAltMMAsync(url, apiKey, profile, integratorKey, quoteModel, makerToken, takerToken, maxResponseTimeMs, altRfqAssetOfferings, takerRequestQueryParams, axiosInstance, cancelToken) {
    const altPair = getAltMarketInfo(altRfqAssetOfferings[url], takerRequestQueryParams.buyTokenAddress, takerRequestQueryParams.sellTokenAddress);
    if (!altPair) {
        throw new Error(`Alt pair not found`);
    }
    const side = altPair.baseAsset === takerRequestQueryParams.buyTokenAddress ? altMmTypes_1.AltQuoteSide.Sell : altMmTypes_1.AltQuoteSide.Buy;
    // comparison price needs to be quote/base
    // in the standard implementation, it's maker/taker
    let altComparisonPrice;
    if (altPair.quoteAsset === makerToken) {
        altComparisonPrice = takerRequestQueryParams.comparisonPrice
            ? takerRequestQueryParams.comparisonPrice
            : undefined;
    }
    else {
        altComparisonPrice = takerRequestQueryParams.comparisonPrice
            ? new utils_1.BigNumber(takerRequestQueryParams.comparisonPrice).pow(-1).toString()
            : undefined;
    }
    let data;
    // $eslint-fix-me https://github.com/rhinodavid/eslint-fix-me
    // eslint-disable-next-line prefer-const
    data = {
        market: `${altPair.id}`,
        model: quoteModel,
        profile,
        side,
        meta: {
            // $eslint-fix-me https://github.com/rhinodavid/eslint-fix-me
            // eslint-disable-next-line @typescript-eslint/no-non-null-assertion
            txOrigin: takerRequestQueryParams.txOrigin,
            taker: takerRequestQueryParams.takerAddress,
            client: integratorKey,
        },
    };
    // specify a comparison price if it exists
    if (altComparisonPrice) {
        data.meta.existingOrder = {
            price: altComparisonPrice,
        };
    }
    // need to specify amount or value
    // amount is units of the base asset
    // value is units of the quote asset
    let requestSize;
    if (takerRequestQueryParams.buyAmountBaseUnits) {
        requestSize = dev_utils_1.Web3Wrapper.toUnitAmount(new utils_1.BigNumber(takerRequestQueryParams.buyAmountBaseUnits), takerRequestQueryParams.buyTokenAddress === altPair.baseAsset
            ? altPair.baseAssetDecimals
            : altPair.quoteAssetDecimals).toString();
        if (takerRequestQueryParams.buyTokenAddress === altPair.baseAsset) {
            data.amount = requestSize;
            // add to 'existing order' if there is a comparison price
            if (data.meta.existingOrder) {
                data.meta.existingOrder.amount = requestSize;
            }
        }
        else {
            data.value = requestSize;
            // add to 'existing order' if there is a comparison price
            if (data.meta.existingOrder) {
                data.meta.existingOrder.value = requestSize;
            }
        }
    }
    else if (takerRequestQueryParams.sellAmountBaseUnits) {
        requestSize = dev_utils_1.Web3Wrapper.toUnitAmount(new utils_1.BigNumber(takerRequestQueryParams.sellAmountBaseUnits), takerRequestQueryParams.sellTokenAddress === altPair.baseAsset
            ? altPair.baseAssetDecimals
            : altPair.quoteAssetDecimals).toString();
        if (takerRequestQueryParams.sellTokenAddress === altPair.baseAsset) {
            data.amount = requestSize;
            if (data.meta.existingOrder) {
                data.meta.existingOrder.amount = requestSize;
            }
        }
        else {
            data.value = requestSize;
            if (data.meta.existingOrder) {
                data.meta.existingOrder.value = requestSize;
            }
        }
    }
    const response = await axiosInstance
        .post(`${url}/quotes`, data, {
        headers: { Authorization: `Bearer ${apiKey}` },
        timeout: maxResponseTimeMs,
        cancelToken,
    })
        .catch((err) => {
        if (err.response) {
            // request was made and market maker responded
            logger_1.logger.warn({ data: err.response.data, status: err.response.status, headers: err.response.headers }, `Alt RFQ MM request failed`);
        }
        else if (err.request) {
            logger_1.logger.warn({}, 'Alt RFQ MM no response received');
        }
        else {
            logger_1.logger.warn({ err: err.message }, 'Failed to construct Alt RFQ MM request');
        }
        throw new Error(`Alt RFQ MM request failed`);
    });
    // empty response will get filtered out in validation
    const emptyResponse = {};
    // tslint:disable-next-line:custom-no-magic-numbers
    if (response.status !== SUCCESS_CODE) {
        const rejectedRequestInfo = {
            status: response.status,
            message: response.data,
        };
        logger_1.logger.warn(rejectedRequestInfo, `Alt RFQ MM did not return a status of ${SUCCESS_CODE}`);
        return {
            data: emptyResponse,
            status: response.status,
        };
    }
    // successful handling but no quote is indicated by status = 'rejected'
    if (response.data.status === 'rejected') {
        logger_1.logger.warn(response.data.id, `Alt RFQ MM handled the request successfully but did not return a quote (status = 'rejected')`);
        return {
            data: emptyResponse,
            // hack: set the http status to 204 no content so we can more
            // easily track when no quote is returned
            status: 204,
        };
    }
    const parsedResponse = quoteModel === 'firm'
        ? parseFirmQuoteResponseFromAltMM(response.data)
        : parseIndicativeQuoteResponseFromAltMM(response.data, altPair, makerToken, takerToken);
    return {
        // hack to appease type checking
        data: parsedResponse,
        status: response.status,
    };
}
exports.returnQuoteFromAltMMAsync = returnQuoteFromAltMMAsync;
//# sourceMappingURL=data:application/json;charset=utf-8;base64,eyJmaWxlIjoiL1VzZXJzL2Rhdmlkd2Fsc2gvY29kZS1sb2NhbC8weC1yZnEtYXBpL3NyYy9xdW90ZVJlcXVlc3Rvci9hbHRNbUltcGxlbWVudGFpb25VdGlscy50cyIsIm1hcHBpbmdzIjoiOzs7QUFBQSw2Q0FBNEM7QUFDNUMscUNBQXNDO0FBR3RDLHNDQUFtQztBQUVuQyw2Q0FRc0I7QUFFdEIsTUFBTSxZQUFZLEdBQUcsR0FBRyxDQUFDO0FBRXpCLGtJQUFrSTtBQUNsSSxNQUFNLHdDQUF3QyxHQUFHLEdBQUcsQ0FBQztBQUVyRCxTQUFTLGdCQUFnQixDQUNyQixTQUF3QixFQUN4QixlQUF1QixFQUN2QixnQkFBd0I7SUFFeEIsS0FBSyxNQUFNLFFBQVEsSUFBSSxTQUFTLEVBQUU7UUFDOUIsSUFDSSxDQUFDLGVBQWUsQ0FBQyxXQUFXLEVBQUUsS0FBSyxRQUFRLENBQUMsU0FBUyxDQUFDLFdBQVcsRUFBRTtZQUMvRCxnQkFBZ0IsQ0FBQyxXQUFXLEVBQUUsS0FBSyxRQUFRLENBQUMsVUFBVSxDQUFDLFdBQVcsRUFBRSxDQUFDO1lBQ3pFLENBQUMsZ0JBQWdCLENBQUMsV0FBVyxFQUFFLEtBQUssUUFBUSxDQUFDLFNBQVMsQ0FBQyxXQUFXLEVBQUU7Z0JBQ2hFLGVBQWUsQ0FBQyxXQUFXLEVBQUUsS0FBSyxRQUFRLENBQUMsVUFBVSxDQUFDLFdBQVcsRUFBRSxDQUFDLEVBQzFFO1lBQ0UsT0FBTyxRQUFRLENBQUM7U0FDbkI7S0FDSjtJQUNELE9BQU8sU0FBUyxDQUFDO0FBQ3JCLENBQUM7QUFFRCxTQUFTLCtCQUErQixDQUFDLG1CQUF5QztJQUM5RSxPQUFPO1FBQ0gsV0FBVyxFQUFFLG1CQUFtQixDQUFDLElBQUksQ0FBQyxXQUFXLENBQUM7S0FDckQsQ0FBQztBQUNOLENBQUM7QUFFRCxTQUFTLHFDQUFxQyxDQUMxQywwQkFBc0QsRUFDdEQsT0FBb0IsRUFDcEIsVUFBa0IsRUFDbEIsVUFBa0I7SUFFbEIsSUFBSSxXQUFzQixDQUFDO0lBQzNCLElBQUksV0FBc0IsQ0FBQztJQUMzQixJQUFJ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QUFDLHFDQUFxQyxDQUFDLFFBQVEsQ0FBQyxJQUFJLEVBQUUsT0FBTyxFQUFFLFVBQVUsRUFBRSxVQUFVLENBQUMsQ0FBQztJQUVoRyxPQUFPO1FBQ0gsZ0NBQWdDO1FBQ2hDLElBQUksRUFBRSxjQUFzQztRQUM1QyxNQUFNLEVBQUUsUUFBUSxDQUFDLE1BQU07S0FDMUIsQ0FBQztBQUNOLENBQUM7QUF0S0QsOERBc0tDIiwibmFtZXMiOltdLCJzb3VyY2VzIjpbIi9Vc2Vycy9kYXZpZHdhbHNoL2NvZGUtbG9jYWwvMHgtcmZxLWFwaS9zcmMvcXVvdGVSZXF1ZXN0b3IvYWx0TW1JbXBsZW1lbnRhaW9uVXRpbHMudHMiXSwic291cmNlc0NvbnRlbnQiOlsiaW1wb3J0IHsgV2ViM1dyYXBwZXIgfSBmcm9tICdAMHgvZGV2LXV0aWxzJztcbmltcG9ydCB7IEJpZ051bWJlciB9IGZyb20gJ0AweC91dGlscyc7XG5pbXBvcnQgeyBBeGlvc0luc3RhbmNlLCBDYW5jZWxUb2tlbiB9IGZyb20gJ2F4aW9zJztcblxuaW1wb3J0IHsgbG9nZ2VyIH0gZnJvbSAnLi4vbG9nZ2VyJztcbmltcG9ydCB7IFRha2VyUmVxdWVzdFF1ZXJ5UGFyYW1zVW5uZXN0ZWQsIFY0UkZRRmlybVF1b3RlLCBWNFJGUUluZGljYXRpdmVRdW90ZSB9IGZyb20gJy4uL3F1b3RlLXNlcnZlci90eXBlcyc7XG5pbXBvcnQge1xuICAgIEFsdEZpcm1RdW90ZVJlc3BvbnNlLFxuICAgIEFsdEluZGljYXRpdmVRdW90ZVJlc3BvbnNlLFxuICAgIEFsdE9mZmVyaW5nLFxuICAgIEFsdFF1b3RlTW9kZWwsXG4gICAgQWx0UXVvdGVSZXF1ZXN0RGF0YSxcbiAgICBBbHRRdW90ZVNpZGUsXG4gICAgQWx0UmZxTWFrZXJBc3NldE9mZmVyaW5ncyxcbn0gZnJvbSAnLi9hbHRNbVR5cGVzJztcblxuY29uc3QgU1VDQ0VTU19DT0RFID0gMjAxO1xuXG4vLyBodHRwczovL2dpdGh1Yi5jb20vMHhQcm9qZWN0L3Byb3RvY29sL2Jsb2IvZmU5MzVmNzg3Y2JlOGM5MTE2ZmY3MDIxOTVmMzE2MWU4NmMxYWVhNC9wYWNrYWdlcy9hc3NldC1zd2FwcGVyL3NyYy9jb25zdGFudHMudHMjTDMxXG5jb25zdCBBTFRfTU1fSU1QVVRFRF9JTkRJQ0FUSVZFX0VYUElSWV9TRUNPTkRTID0gMTgwO1xuXG5mdW5jdGlvbiBnZXRBbHRNYXJrZXRJbmZvKFxuICAgIG9mZmVyaW5nczogQWx0T2ZmZXJpbmdbXSxcbiAgICBidXlUb2tlbkFkZHJlc3M6IHN0cmluZyxcbiAgICBzZWxsVG9rZW5BZGRyZXNzOiBzdHJpbmcsXG4pOiBBbHRPZmZlcmluZyB8IHVuZGVmaW5lZCB7XG4gICAgZm9yIChjb25zdCBvZmZlcmluZyBvZiBvZmZlcmluZ3MpIHtcbiAgICAgICAgaWYgKFxuICAgICAgICAgICAgKGJ1eVRva2VuQWRkcmVzcy50b0xvd2VyQ2FzZSgpID09PSBvZmZlcmluZy5iYXNlQXNzZXQudG9Mb3dlckNhc2UoKSAmJlxuICAgICAgICAgICAgICAgIHNlbGxUb2tlbkFkZHJlc3MudG9Mb3dlckNhc2UoKSA9PT0gb2ZmZXJpbmcucXVvdGVBc3NldC50b0xvd2VyQ2FzZSgpKSB8fFxuICAgICAgICAgICAgKHNlbGxUb2tlbkFkZHJlc3MudG9Mb3dlckNhc2UoKSA9PT0gb2ZmZXJpbmcuYmFzZUFzc2V0LnRvTG93ZXJDYXNlKCkgJiZcbiAgICAgICAgICAgICAgICBidXlUb2tlbkFkZHJlc3MudG9Mb3dlckNhc2UoKSA9PT0gb2ZmZXJpbmcucXVvdGVBc3NldC50b0xvd2VyQ2FzZSgpKVxuICAgICAgICApIHtcbiAgICAgICAgICAgIHJldHVybiBvZmZlcmluZztcbiAgICAgICAgfVxuICAgIH1cbiAgICByZXR1cm4gdW5kZWZpbmVkO1xufVxuXG5mdW5jdGlvbiBwYXJzZUZpcm1RdW90ZVJlc3BvbnNlRnJvbUFsdE1NKGFsdEZpcm1RdW90ZVJlcG9uc2U6IEFsdEZpcm1RdW90ZVJlc3BvbnNlKTogVjRSRlFGaXJtUXVvdGUge1xuICAgIHJldHVybiB7XG4gICAgICAgIHNpZ25lZE9yZGVyOiBhbHRGaXJtUXVvdGVSZXBvbnNlLmRhdGFbJzB4djRvcmRlciddLFxuICAgIH07XG59XG5cbmZ1bmN0aW9uIHBhcnNlSW5kaWNhdGl2ZVF1b3RlUmVzcG9uc2VGcm9tQWx0TU0oXG4gICAgYWx0SW5kaWNhdGl2ZVF1b3RlUmVzcG9uc2U6IEFsdEluZGljYXRpdmVRdW90ZVJlc3BvbnNlLFxuICAgIGFsdFBhaXI6IEFsdE9mZmVyaW5nLFxuICAgIG1ha2VyVG9rZW46IHN0cmluZyxcbiAgICB0YWtlclRva2VuOiBzdHJpbmcsXG4pOiBWNFJGUUluZGljYXRpdmVRdW90ZSB7XG4gICAgbGV0IG1ha2VyQW1vdW50OiBCaWdOdW1iZXI7XG4gICAgbGV0IHRha2VyQW1vdW50OiBCaWdOdW1iZXI7XG4gICAgbGV0IHF1b3RlQW1vdW50OiBCaWdOdW1iZXI7XG4gICAgbGV0IGJhc2VBbW91bnQ6IEJpZ051bWJlcjtcblxuICAgIGlmICghYWx0SW5kaWNhdGl2ZVF1b3RlUmVzcG9uc2UucHJpY2UpIHtcbiAgICAgICAgdGhyb3cgbmV3IEVycm9yKCdQcmljZSBub3QgcmV0dXJuZWQgYnkgYWx0IE1NJyk7XG4gICAgfVxuICAgIGlmIChhbHRJbmRpY2F0aXZlUXVvdGVSZXNwb25zZS5hbW91bnQpIHtcbiAgICAgICAgLy8gaWYgYW1vdW50IGlzIHNwZWNpZmllZCwgYW1vdW50IGlzIHRoZSBiYXNlIHRva2VuIGFtb3VudFxuICAgICAgICBiYXNlQW1vdW50ID0gV2ViM1dyYXBwZXIudG9CYXNlVW5pdEFtb3VudChcbiAgICAgICAgICAgIG5ldyBCaWdOdW1iZXIoYWx0SW5kaWNhdGl2ZVF1b3RlUmVzcG9uc2UuYW1vdW50KSxcbiAgICAgICAgICAgIGFsdFBhaXIuYmFzZUFzc2V0RGVjaW1hbHMsXG4gICAgICAgICk7XG4gICAgICAgIC8vIGlmIGFtb3VudCBpcyBzcGVjaWZpZWQsIHVzZSB0aGUgcHJpY2UgKHF1b3RlL2Jhc2UpIHRvIGdldCB0aGUgcXVvdGUgYW1vdW50XG4gICAgICAgIHF1b3RlQW1vdW50ID0gV2ViM1dyYXBwZXIudG9CYXNlVW5pdEFtb3VudChcbiAgICAgICAgICAgIG5ldyBCaWdOdW1iZXIoYWx0SW5kaWNhdGl2ZVF1b3RlUmVzcG9uc2UuYW1vdW50KVxuICAgICAgICAgICAgICAgIC50aW1lcyhuZXcgQmlnTnVtYmVyKGFsdEluZGljYXRpdmVRdW90ZVJlc3BvbnNlLnByaWNlKSlcbiAgICAgICAgICAgICAgICAuZGVjaW1hbFBsYWNlcyhhbHRQYWlyLnF1b3RlQXNzZXREZWNpbWFscywgQmlnTnVtYmVyLlJPVU5EX0RPV04pLFxuICAgICAgICAgICAgYWx0UGFpci5xdW90ZUFzc2V0RGVjaW1hbHMsXG4gICAgICAgICk7XG4gICAgfSBlbHNlIGlmIChhbHRJbmRpY2F0aXZlUXVvdGVSZXNwb25zZS52YWx1ZSkge1xuICAgICAgICAvLyBpZiB2YWx1ZSBpcyBzcGVjaWZpZWQsIHZhbHVlIGlzIHRoZSBxdW90ZSB0b2tlbiBhbW91bnRcbiAgICAgICAgcXVvdGVBbW91bnQgPSBXZWIzV3JhcHBlci50b0Jhc2VVbml0QW1vdW50KFxuICAgICAgICAgICAgbmV3IEJpZ051bWJlcihhbHRJbmRpY2F0aXZlUXVvdGVSZXNwb25zZS52YWx1ZSksXG4gICAgICAgICAgICBhbHRQYWlyLnF1b3RlQXNzZXREZWNpbWFscyxcbiAgICAgICAgKTtcbiAgICAgICAgLy8gaWYgdmFsdWUgaXMgc3BlY2lmaWVkLCB1c2UgdGhlIHByaWNlIChxdW90ZS9iYXNlKSB0byBnZXQgdGhlIGJhc2UgYW1vdW50XG4gICAgICAgIGJhc2VBbW91bnQgPSBXZWIzV3JhcHBlci50b0Jhc2VVbml0QW1vdW50KFxuICAgICAgICAgICAgbmV3IEJpZ051bWJlcihhbHRJbmRpY2F0aXZlUXVvdGVSZXNwb25zZS52YWx1ZSlcbiAgICAgICAgICAgICAgICAuZGl2aWRlZEJ5KG5ldyBCaWdOdW1iZXIoYWx0SW5kaWNhdGl2ZVF1b3RlUmVzcG9uc2UucHJpY2UpKVxuICAgICAgICAgICAgICAgIC5kZWNpbWFsUGxhY2VzKGFsdFBhaXIuYmFzZUFzc2V0RGVjaW1hbHMsIEJpZ051bWJlci5ST1VORF9ET1dOKSxcbiAgICAgICAgICAgIGFsdFBhaXIuYmFzZUFzc2V0RGVjaW1hbHMsXG4gICAgICAgICk7XG4gICAgfSBlbHNlIHtcbiAgICAgICAgdGhyb3cgbmV3IEVycm9yKCduZWl0aGVyIGFtb3VudCBvciB2YWx1ZSB3ZXJlIHNwZWNpZmllZCcpO1xuICAgIH1cbiAgICBpZiAobWFrZXJUb2tlbi50b0xvd2VyQ2FzZSgpID09PSBhbHRQYWlyLmJhc2VBc3NldC50b0xvd2VyQ2FzZSgpKSB7XG4gICAgICAgIG1ha2VyQW1vdW50ID0gYmFzZUFtb3VudDtcbiAgICAgICAgdGFrZXJBbW91bnQgPSBxdW90ZUFtb3VudDtcbiAgICB9IGVsc2UgaWYgKG1ha2VyVG9rZW4udG9Mb3dlckNhc2UoKSA9PT0gYWx0UGFpci5xdW90ZUFzc2V0LnRvTG93ZXJDYXNlKCkpIHtcbiAgICAgICAgbWFrZXJBbW91bnQgPSBxdW90ZUFtb3VudDtcbiAgICAgICAgdGFrZXJBbW91bnQgPSBiYXNlQW1vdW50O1xuICAgIH0gZWxzZSB7XG4gICAgICAgIHRocm93IG5ldyBFcnJvcihgQmFzZSwgcXVvdGUgdG9rZW5zIGRvbid0IGFsaWduIHdpdGggbWFrZXIsIHRha2VyIHRva2Vuc2ApO1xuICAgIH1cblxuICAgIHJldHVybiB7XG4gICAgICAgIG1ha2VyVG9rZW4sXG4gICAgICAgIG1ha2VyQW1vdW50LFxuICAgICAgICB0YWtlclRva2VuLFxuICAgICAgICB0YWtlckFtb3VudCxcbiAgICAgICAgLy8gSEFDSzogYWx0IGltcGxlbWVudGF0aW9uIGRvZXMgbm90IHJldHVybiBhbiBleHBpcmF0aW9uIHdpdGggaW5kaWNhdGl2ZSBxdW90ZXNcbiAgICAgICAgLy8gcmV0dXJuIG5vdyArIHsgSU1QVVRFRCBFWFBJUlkgU0VDT05EUyB9IHRvIGhhdmUgaXQgaW5jbHVkZWQgYWZ0ZXIgb3JkZXIgY2hlY2tzXG4gICAgICAgIGV4cGlyeTpcbiAgICAgICAgICAgIC8vIHRzbGludDpkaXNhYmxlLW5leHQtbGluZTpjdXN0b20tbm8tbWFnaWMtbnVtYmVyc1xuICAgICAgICAgICAgbmV3IEJpZ051bWJlcihEYXRlLm5vdygpIC8gMTAwMClcbiAgICAgICAgICAgICAgICAuaW50ZWdlclZhbHVlKEJpZ051bWJlci5ST1VORF9ET1dOKVxuICAgICAgICAgICAgICAgIC5wbHVzKEFMVF9NTV9JTVBVVEVEX0lORElDQVRJVkVfRVhQSVJZX1NFQ09ORFMpLFxuICAgIH07XG59XG5cbi8qKlxuICogVHVybiBhIHN0YW5kYXJkIHF1b3RlIHJlcXVlc3QgaW50byBhbiBhbHQgcXVvdGUgcmVxdWVzdFxuICogYW5kIHJldHVybiB0aGUgYXBwcm9wcmlhdGUgc3RhbmRhcmQgcXVvdGUgcmVzcG9uc2VcbiAqL1xuZXhwb3J0IGFzeW5jIGZ1bmN0aW9uIHJldHVyblF1b3RlRnJvbUFsdE1NQXN5bmM8UmVzcG9uc2VUPihcbiAgICB1cmw6IHN0cmluZyxcbiAgICBhcGlLZXk6IHN0cmluZyxcbiAgICBwcm9maWxlOiBzdHJpbmcsXG4gICAgaW50ZWdyYXRvcktleTogc3RyaW5nLFxuICAgIHF1b3RlTW9kZWw6IEFsdFF1b3RlTW9kZWwsXG4gICAgbWFrZXJUb2tlbjogc3RyaW5nLFxuICAgIHRha2VyVG9rZW46IHN0cmluZyxcbiAgICBtYXhSZXNwb25zZVRpbWVNczogbnVtYmVyLFxuICAgIGFsdFJmcUFzc2V0T2ZmZXJpbmdzOiBBbHRSZnFNYWtlckFzc2V0T2ZmZXJpbmdzLFxuICAgIHRha2VyUmVxdWVzdFF1ZXJ5UGFyYW1zOiBUYWtlclJlcXVlc3RRdWVyeVBhcmFtc1VubmVzdGVkLFxuICAgIGF4aW9zSW5zdGFuY2U6IEF4aW9zSW5zdGFuY2UsXG4gICAgY2FuY2VsVG9rZW46IENhbmNlbFRva2VuLFxuKTogUHJvbWlzZTx7IGRhdGE6IFJlc3BvbnNlVDsgc3RhdHVzOiBudW1iZXIgfT4ge1xuICAgIGNvbnN0IGFsdFBhaXIgPSBnZXRBbHRNYXJrZXRJbmZvKFxuICAgICAgICBhbHRSZnFBc3NldE9mZmVyaW5nc1t1cmxdLFxuICAgICAgICB0YWtlclJlcXVlc3RRdWVyeVBhcmFtcy5idXlUb2tlbkFkZHJlc3MsXG4gICAgICAgIHRha2VyUmVxdWVzdFF1ZXJ5UGFyYW1zLnNlbGxUb2tlbkFkZHJlc3MsXG4gICAgKTtcblxuICAgIGlmICghYWx0UGFpcikge1xuICAgICAgICB0aHJvdyBuZXcgRXJyb3IoYEFsdCBwYWlyIG5vdCBmb3VuZGApO1xuICAgIH1cbiAgICBjb25zdCBzaWRlID0gYWx0UGFpci5iYXNlQXNzZXQgPT09IHRha2VyUmVxdWVzdFF1ZXJ5UGFyYW1zLmJ1eVRva2VuQWRkcmVzcyA/IEFsdFF1b3RlU2lkZS5TZWxsIDogQWx0UXVvdGVTaWRlLkJ1eTtcblxuICAgIC8vIGNvbXBhcmlzb24gcHJpY2UgbmVlZHMgdG8gYmUgcXVvdGUvYmFzZVxuICAgIC8vIGluIHRoZSBzdGFuZGFyZCBpbXBsZW1lbnRhdGlvbiwgaXQncyBtYWtlci90YWtlclxuICAgIGxldCBhbHRDb21wYXJpc29uUHJpY2U6IHN0cmluZyB8IHVuZGVmaW5lZDtcbiAgICBpZiAoYWx0UGFpci5xdW90ZUFzc2V0ID09PSBtYWtlclRva2VuKSB7XG4gICAgICAgIGFsdENvbXBhcmlzb25QcmljZSA9IHRha2VyUmVxdWVzdFF1ZXJ5UGFyYW1zLmNvbXBhcmlzb25QcmljZVxuICAgICAgICAgICAgPyB0YWtlclJlcXVlc3RRdWVyeVBhcmFtcy5jb21wYXJpc29uUHJpY2VcbiAgICAgICAgICAgIDogdW5kZWZpbmVkO1xuICAgIH0gZWxzZSB7XG4gICAgICAgIGFsdENvbXBhcmlzb25QcmljZSA9IHRha2VyUmVxdWVzdFF1ZXJ5UGFyYW1zLmNvbXBhcmlzb25QcmljZVxuICAgICAgICAgICAgPyBuZXcgQmlnTnVtYmVyKHRha2VyUmVxdWVzdFF1ZXJ5UGFyYW1zLmNvbXBhcmlzb25QcmljZSkucG93KC0xKS50b1N0cmluZygpXG4gICAgICAgICAgICA6IHVuZGVmaW5lZDtcbiAgICB9XG5cbiAgICBsZXQgZGF0YTogQWx0UXVvdGVSZXF1ZXN0RGF0YTtcbiAgICAvLyAkZXNsaW50LWZpeC1tZSBodHRwczovL2dpdGh1Yi5jb20vcmhpbm9kYXZpZC9lc2xpbnQtZml4LW1lXG4gICAgLy8gZXNsaW50LWRpc2FibGUtbmV4dC1saW5lIHByZWZlci1jb25zdFxuICAgIGRhdGEgPSB7XG4gICAgICAgIG1hcmtldDogYCR7YWx0UGFpci5pZH1gLFxuICAgICAgICBtb2RlbDogcXVvdGVNb2RlbCxcbiAgICAgICAgcHJvZmlsZSxcbiAgICAgICAgc2lkZSxcbiAgICAgICAgbWV0YToge1xuICAgICAgICAgICAgLy8gJGVzbGludC1maXgtbWUgaHR0cHM6Ly9naXRodWIuY29tL3JoaW5vZGF2aWQvZXNsaW50LWZpeC1tZVxuICAgICAgICAgICAgLy8gZXNsaW50LWRpc2FibGUtbmV4dC1saW5lIEB0eXBlc2NyaXB0LWVzbGludC9uby1ub24tbnVsbC1hc3NlcnRpb25cbiAgICAgICAgICAgIHR4T3JpZ2luOiB0YWtlclJlcXVlc3RRdWVyeVBhcmFtcy50eE9yaWdpbiEsXG4gICAgICAgICAgICB0YWtlcjogdGFrZXJSZXF1ZXN0UXVlcnlQYXJhbXMudGFrZXJBZGRyZXNzLFxuICAgICAgICAgICAgY2xpZW50OiBpbnRlZ3JhdG9yS2V5LFxuICAgICAgICB9LFxuICAgIH07XG5cbiAgICAvLyBzcGVjaWZ5IGEgY29tcGFyaXNvbiBwcmljZSBpZiBpdCBleGlzdHNcbiAgICBpZiAoYWx0Q29tcGFyaXNvblByaWNlKSB7XG4gICAgICAgIGRhdGEubWV0YS5leGlzdGluZ09yZGVyID0ge1xuICAgICAgICAgICAgcHJpY2U6IGFsdENvbXBhcmlzb25QcmljZSxcbiAgICAgICAgfTtcbiAgICB9XG5cbiAgICAvLyBuZWVkIHRvIHNwZWNpZnkgYW1vdW50IG9yIHZhbHVlXG4gICAgLy8gYW1vdW50IGlzIHVuaXRzIG9mIHRoZSBiYXNlIGFzc2V0XG4gICAgLy8gdmFsdWUgaXMgdW5pdHMgb2YgdGhlIHF1b3RlIGFzc2V0XG4gICAgbGV0IHJlcXVlc3RTaXplOiBzdHJpbmc7XG4gICAgaWYgKHRha2VyUmVxdWVzdFF1ZXJ5UGFyYW1zLmJ1eUFtb3VudEJhc2VVbml0cykge1xuICAgICAgICByZXF1ZXN0U2l6ZSA9IFdlYjNXcmFwcGVyLnRvVW5pdEFtb3VudChcbiAgICAgICAgICAgIG5ldyBCaWdOdW1iZXIodGFrZXJSZXF1ZXN0UXVlcnlQYXJhbXMuYnV5QW1vdW50QmFzZVVuaXRzKSxcbiAgICAgICAgICAgIHRha2VyUmVxdWVzdFF1ZXJ5UGFyYW1zLmJ1eVRva2VuQWRkcmVzcyA9PT0gYWx0UGFpci5iYXNlQXNzZXRcbiAgICAgICAgICAgICAgICA/IGFsdFBhaXIuYmFzZUFzc2V0RGVjaW1hbHNcbiAgICAgICAgICAgICAgICA6IGFsdFBhaXIucXVvdGVBc3NldERlY2ltYWxzLFxuICAgICAgICApLnRvU3RyaW5nKCk7XG4gICAgICAgIGlmICh0YWtlclJlcXVlc3RRdWVyeVBhcmFtcy5idXlUb2tlbkFkZHJlc3MgPT09IGFsdFBhaXIuYmFzZUFzc2V0KSB7XG4gICAgICAgICAgICBkYXRhLmFtb3VudCA9IHJlcXVlc3RTaXplO1xuICAgICAgICAgICAgLy8gYWRkIHRvICdleGlzdGluZyBvcmRlcicgaWYgdGhlcmUgaXMgYSBjb21wYXJpc29uIHByaWNlXG4gICAgICAgICAgICBpZiAoZGF0YS5tZXRhLmV4aXN0aW5nT3JkZXIpIHtcbiAgICAgICAgICAgICAgICBkYXRhLm1ldGEuZXhpc3RpbmdPcmRlci5hbW91bnQgPSByZXF1ZXN0U2l6ZTtcbiAgICAgICAgICAgIH1cbiAgICAgICAgfSBlbHNlIHtcbiAgICAgICAgICAgIGRhdGEudmFsdWUgPSByZXF1ZXN0U2l6ZTtcbiAgICAgICAgICAgIC8vIGFkZCB0byAnZXhpc3Rpbmcgb3JkZXInIGlmIHRoZXJlIGlzIGEgY29tcGFyaXNvbiBwcmljZVxuICAgICAgICAgICAgaWYgKGRhdGEubWV0YS5leGlzdGluZ09yZGVyKSB7XG4gICAgICAgICAgICAgICAgZGF0YS5tZXRhLmV4aXN0aW5nT3JkZXIudmFsdWUgPSByZXF1ZXN0U2l6ZTtcbiAgICAgICAgICAgIH1cbiAgICAgICAgfVxuICAgIH0gZWxzZSBpZiAodGFrZXJSZXF1ZXN0UXVlcnlQYXJhbXMuc2VsbEFtb3VudEJhc2VVbml0cykge1xuICAgICAgICByZXF1ZXN0U2l6ZSA9IFdlYjNXcmFwcGVyLnRvVW5pdEFtb3VudChcbiAgICAgICAgICAgIG5ldyBCaWdOdW1iZXIodGFrZXJSZXF1ZXN0UXVlcnlQYXJhbXMuc2VsbEFtb3VudEJhc2VVbml0cyksXG4gICAgICAgICAgICB0YWtlclJlcXVlc3RRdWVyeVBhcmFtcy5zZWxsVG9rZW5BZGRyZXNzID09PSBhbHRQYWlyLmJhc2VBc3NldFxuICAgICAgICAgICAgICAgID8gYWx0UGFpci5iYXNlQXNzZXREZWNpbWFsc1xuICAgICAgICAgICAgICAgIDogYWx0UGFpci5xdW90ZUFzc2V0RGVjaW1hbHMsXG4gICAgICAgICkudG9TdHJpbmcoKTtcbiAgICAgICAgaWYgKHRha2VyUmVxdWVzdFF1ZXJ5UGFyYW1zLnNlbGxUb2tlbkFkZHJlc3MgPT09IGFsdFBhaXIuYmFzZUFzc2V0KSB7XG4gICAgICAgICAgICBkYXRhLmFtb3VudCA9IHJlcXVlc3RTaXplO1xuICAgICAgICAgICAgaWYgKGRhdGEubWV0YS5leGlzdGluZ09yZGVyKSB7XG4gICAgICAgICAgICAgICAgZGF0YS5tZXRhLmV4aXN0aW5nT3JkZXIuYW1vdW50ID0gcmVxdWVzdFNpemU7XG4gICAgICAgICAgICB9XG4gICAgICAgIH0gZWxzZSB7XG4gICAgICAgICAgICBkYXRhLnZhbHVlID0gcmVxdWVzdFNpemU7XG4gICAgICAgICAgICBpZiAoZGF0YS5tZXRhLmV4aXN0aW5nT3JkZXIpIHtcbiAgICAgICAgICAgICAgICBkYXRhLm1ldGEuZXhpc3RpbmdPcmRlci52YWx1ZSA9IHJlcXVlc3RTaXplO1xuICAgICAgICAgICAgfVxuICAgICAgICB9XG4gICAgfVxuXG4gICAgY29uc3QgcmVzcG9uc2UgPSBhd2FpdCBheGlvc0luc3RhbmNlXG4gICAgICAgIC5wb3N0KGAke3VybH0vcXVvdGVzYCwgZGF0YSwge1xuICAgICAgICAgICAgaGVhZGVyczogeyBBdXRob3JpemF0aW9uOiBgQmVhcmVyICR7YXBpS2V5fWAgfSxcbiAgICAgICAgICAgIHRpbWVvdXQ6IG1heFJlc3BvbnNlVGltZU1zLFxuICAgICAgICAgICAgY2FuY2VsVG9rZW4sXG4gICAgICAgIH0pXG4gICAgICAgIC5jYXRjaCgoZXJyKSA9PiB7XG4gICAgICAgICAgICBpZiAoZXJyLnJlc3BvbnNlKSB7XG4gICAgICAgICAgICAgICAgLy8gcmVxdWVzdCB3YXMgbWFkZSBhbmQgbWFya2V0IG1ha2VyIHJlc3BvbmRlZFxuICAgICAgICAgICAgICAgIGxvZ2dlci53YXJuKFxuICAgICAgICAgICAgICAgICAgICB7IGRhdGE6IGVyci5yZXNwb25zZS5kYXRhLCBzdGF0dXM6IGVyci5yZXNwb25zZS5zdGF0dXMsIGhlYWRlcnM6IGVyci5yZXNwb25zZS5oZWFkZXJzIH0sXG4gICAgICAgICAgICAgICAgICAgIGBBbHQgUkZRIE1NIHJlcXVlc3QgZmFpbGVkYCxcbiAgICAgICAgICAgICAgICApO1xuICAgICAgICAgICAgfSBlbHNlIGlmIChlcnIucmVxdWVzdCkge1xuICAgICAgICAgICAgICAgIGxvZ2dlci53YXJuKHt9LCAnQWx0IFJGUSBNTSBubyByZXNwb25zZSByZWNlaXZlZCcpO1xuICAgICAgICAgICAgfSBlbHNlIHtcbiAgICAgICAgICAgICAgICBsb2dnZXIud2Fybih7IGVycjogZXJyLm1lc3NhZ2UgfSwgJ0ZhaWxlZCB0byBjb25zdHJ1Y3QgQWx0IFJGUSBNTSByZXF1ZXN0Jyk7XG4gICAgICAgICAgICB9XG4gICAgICAgICAgICB0aHJvdyBuZXcgRXJyb3IoYEFsdCBSRlEgTU0gcmVxdWVzdCBmYWlsZWRgKTtcbiAgICAgICAgfSk7XG5cbiAgICAvLyBlbXB0eSByZXNwb25zZSB3aWxsIGdldCBmaWx0ZXJlZCBvdXQgaW4gdmFsaWRhdGlvblxuICAgIGNvbnN0IGVtcHR5UmVzcG9uc2UgPSB7fTtcblxuICAgIC8vIHRzbGludDpkaXNhYmxlLW5leHQtbGluZTpjdXN0b20tbm8tbWFnaWMtbnVtYmVyc1xuICAgIGlmIChyZXNwb25zZS5zdGF0dXMgIT09IFNVQ0NFU1NfQ09ERSkge1xuICAgICAgICBjb25zdCByZWplY3RlZFJlcXVlc3RJbmZvID0ge1xuICAgICAgICAgICAgc3RhdHVzOiByZXNwb25zZS5zdGF0dXMsXG4gICAgICAgICAgICBtZXNzYWdlOiByZXNwb25zZS5kYXRhLFxuICAgICAgICB9O1xuICAgICAgICBsb2dnZXIud2FybihyZWplY3RlZFJlcXVlc3RJbmZvLCBgQWx0IFJGUSBNTSBkaWQgbm90IHJldHVybiBhIHN0YXR1cyBvZiAke1NVQ0NFU1NfQ09ERX1gKTtcbiAgICAgICAgcmV0dXJuIHtcbiAgICAgICAgICAgIGRhdGE6IGVtcHR5UmVzcG9uc2UgYXMgdW5rbm93biBhcyBSZXNwb25zZVQsXG4gICAgICAgICAgICBzdGF0dXM6IHJlc3BvbnNlLnN0YXR1cyxcbiAgICAgICAgfTtcbiAgICB9XG4gICAgLy8gc3VjY2Vzc2Z1bCBoYW5kbGluZyBidXQgbm8gcXVvdGUgaXMgaW5kaWNhdGVkIGJ5IHN0YXR1cyA9ICdyZWplY3RlZCdcbiAgICBpZiAocmVzcG9uc2UuZGF0YS5zdGF0dXMgPT09ICdyZWplY3RlZCcpIHtcbiAgICAgICAgbG9nZ2VyLndhcm4oXG4gICAgICAgICAgICByZXNwb25zZS5kYXRhLmlkLFxuICAgICAgICAgICAgYEFsdCBSRlEgTU0gaGFuZGxlZCB0aGUgcmVxdWVzdCBzdWNjZXNzZnVsbHkgYnV0IGRpZCBub3QgcmV0dXJuIGEgcXVvdGUgKHN0YXR1cyA9ICdyZWplY3RlZCcpYCxcbiAgICAgICAgKTtcbiAgICAgICAgcmV0dXJuIHtcbiAgICAgICAgICAgIGRhdGE6IGVtcHR5UmVzcG9uc2UgYXMgdW5rbm93biBhcyBSZXNwb25zZVQsXG4gICAgICAgICAgICAvLyBoYWNrOiBzZXQgdGhlIGh0dHAgc3RhdHVzIHRvIDIwNCBubyBjb250ZW50IHNvIHdlIGNhbiBtb3JlXG4gICAgICAgICAgICAvLyBlYXNpbHkgdHJhY2sgd2hlbiBubyBxdW90ZSBpcyByZXR1cm5lZFxuICAgICAgICAgICAgc3RhdHVzOiAyMDQsXG4gICAgICAgIH07XG4gICAgfVxuXG4gICAgY29uc3QgcGFyc2VkUmVzcG9uc2UgPVxuICAgICAgICBxdW90ZU1vZGVsID09PSAnZmlybSdcbiAgICAgICAgICAgID8gcGFyc2VGaXJtUXVvdGVSZXNwb25zZUZyb21BbHRNTShyZXNwb25zZS5kYXRhKVxuICAgICAgICAgICAgOiBwYXJzZUluZGljYXRpdmVRdW90ZVJlc3BvbnNlRnJvbUFsdE1NKHJlc3BvbnNlLmRhdGEsIGFsdFBhaXIsIG1ha2VyVG9rZW4sIHRha2VyVG9rZW4pO1xuXG4gICAgcmV0dXJuIHtcbiAgICAgICAgLy8gaGFjayB0byBhcHBlYXNlIHR5cGUgY2hlY2tpbmdcbiAgICAgICAgZGF0YTogcGFyc2VkUmVzcG9uc2UgYXMgdW5rbm93biBhcyBSZXNwb25zZVQsXG4gICAgICAgIHN0YXR1czogcmVzcG9uc2Uuc3RhdHVzLFxuICAgIH07XG59XG4iXSwidmVyc2lvbiI6M30=