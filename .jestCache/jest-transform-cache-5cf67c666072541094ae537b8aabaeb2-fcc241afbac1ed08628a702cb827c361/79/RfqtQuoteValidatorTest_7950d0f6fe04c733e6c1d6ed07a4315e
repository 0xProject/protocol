f47325ab0e24c533047d9cdaae15562a
"use strict";
Object.defineProperty(exports, "__esModule", { value: true });
const utils_1 = require("@0x/utils");
const constants_1 = require("../../src/core/constants");
const RfqtQuoteValidator_1 = require("../../src/utils/RfqtQuoteValidator");
describe('Rfqt Quote Validator', () => {
    const chainId = 1337;
    const integrator = {
        allowedChainIds: [chainId],
        apiKeys: [],
        integratorId: 'integrator-id',
        label: 'test integrator',
        plp: false,
        rfqm: false,
        rfqt: true,
    };
    const quoteContext = {
        isFirm: false,
        workflow: 'rfqt',
        isUnwrap: false,
        originalMakerToken: '0x1',
        takerTokenDecimals: 18,
        makerTokenDecimals: 18,
        feeModelVersion: 1,
        assetFillAmount: new utils_1.BigNumber(111),
        chainId,
        integrator,
        makerToken: '0x1',
        isSelling: false,
        takerAddress: '0x0',
        takerToken: '0x2',
        txOrigin: '0xtakeraddress',
    };
    const nowTimeS = new utils_1.BigNumber(Date.now()).div(constants_1.ONE_SECOND_MS);
    const validPrices = [
        {
            expiry: nowTimeS.plus(75),
            makerAddress: '0xmaker1',
            makerAmount: new utils_1.BigNumber(111),
            makerId: 'uuid-maker1',
            makerToken: '0x1',
            makerUri: 'maker1.xyz',
            takerAmount: new utils_1.BigNumber(111),
            takerToken: '0x2',
        },
        {
            expiry: nowTimeS.plus(75),
            makerAddress: '0xmaker2',
            makerAmount: new utils_1.BigNumber(111),
            makerId: 'uuid-maker2',
            makerToken: '0x1',
            makerUri: 'maker2.xyz',
            takerAmount: new utils_1.BigNumber(111),
            takerToken: '0x2',
        },
    ];
    const validityWindowMs = constants_1.ONE_MINUTE_MS;
    describe('validateV2Prices', () => {
        it('filters fetched prices for the wrong pair', () => {
            const prices = [
                ...validPrices,
                {
                    expiry: nowTimeS.plus(75),
                    makerAddress: '0xmaker3',
                    makerAmount: new utils_1.BigNumber(111),
                    makerId: 'uuid-maker3',
                    makerToken: '0x1',
                    makerUri: 'maker3.xyz',
                    takerAmount: new utils_1.BigNumber(111),
                    takerToken: '0x3',
                },
            ];
            const validatedPrices = (0, RfqtQuoteValidator_1.validateV2Prices)(prices, quoteContext, validityWindowMs);
            expect(validatedPrices).toEqual(validPrices);
        });
        it('filters fetched prices with tight expiration windows', () => {
            const prices = [
                ...validPrices,
                {
                    expiry: nowTimeS.plus(59),
                    makerAddress: '0xmaker3',
                    makerAmount: new utils_1.BigNumber(111),
                    makerId: 'uuid-maker3',
                    makerToken: '0x1',
                    makerUri: 'maker3.xyz',
                    takerAmount: new utils_1.BigNumber(111),
                    takerToken: '0x2',
                },
            ];
            const validatedPrices = (0, RfqtQuoteValidator_1.validateV2Prices)(prices, quoteContext, validityWindowMs);
            expect(validatedPrices).toEqual(validPrices);
        });
        it('returns an empty array from empty prices', () => {
            const emptyPrices = (0, RfqtQuoteValidator_1.validateV2Prices)([], quoteContext, validityWindowMs);
            expect(emptyPrices).toEqual([]);
        });
    });
    describe('getRfqtV2FillableAmounts', () => {
        it('returns full amounts for fully fillable orders', () => {
            const quotedMakerBalances = [new utils_1.BigNumber(1000), new utils_1.BigNumber(1000)];
            const fillableAmounts = (0, RfqtQuoteValidator_1.getRfqtV2FillableAmounts)(validPrices, chainId, quotedMakerBalances);
            expect(fillableAmounts).toEqual([
                { fillableMakerAmount: new utils_1.BigNumber(111), fillableTakerAmount: new utils_1.BigNumber(111) },
                { fillableMakerAmount: new utils_1.BigNumber(111), fillableTakerAmount: new utils_1.BigNumber(111) },
            ]);
        });
        it('returns full amounts if maker balances are not present', () => {
            const fillableAmounts = (0, RfqtQuoteValidator_1.getRfqtV2FillableAmounts)(validPrices, chainId);
            expect(fillableAmounts).toEqual([
                { fillableMakerAmount: new utils_1.BigNumber(111), fillableTakerAmount: new utils_1.BigNumber(111) },
                { fillableMakerAmount: new utils_1.BigNumber(111), fillableTakerAmount: new utils_1.BigNumber(111) },
            ]);
        });
        it('returns partial amounts if a maker does not have enough balance', () => {
            const quotedMakerBalances = [new utils_1.BigNumber(1000), new utils_1.BigNumber(10)];
            const fillableAmounts = (0, RfqtQuoteValidator_1.getRfqtV2FillableAmounts)(validPrices, chainId, quotedMakerBalances);
            expect(fillableAmounts).toEqual([
                { fillableMakerAmount: new utils_1.BigNumber(111), fillableTakerAmount: new utils_1.BigNumber(111) },
                { fillableMakerAmount: new utils_1.BigNumber(10), fillableTakerAmount: new utils_1.BigNumber(10) },
            ]);
        });
        it('returns zero amounts if a maker has zero balance', () => {
            const quotedMakerBalances = [new utils_1.BigNumber(1000), new utils_1.BigNumber(0)];
            const fillableAmounts = (0, RfqtQuoteValidator_1.getRfqtV2FillableAmounts)(validPrices, chainId, quotedMakerBalances);
            expect(fillableAmounts).toEqual([
                { fillableMakerAmount: new utils_1.BigNumber(111), fillableTakerAmount: new utils_1.BigNumber(111) },
                { fillableMakerAmount: new utils_1.BigNumber(0), fillableTakerAmount: new utils_1.BigNumber(0) },
            ]);
        });
        it('returns zero amounts if supplied maker amount is zero', () => {
            const prices = [
                {
                    expiry: nowTimeS.plus(75),
                    makerAddress: '0xmaker3',
                    makerAmount: new utils_1.BigNumber(0),
                    makerId: 'uuid-maker3',
                    makerToken: '0x1',
                    makerUri: 'maker3.xyz',
                    takerAmount: new utils_1.BigNumber(111),
                    takerToken: '0x2',
                },
            ];
            const quotedMakerBalances = [new utils_1.BigNumber(1000)];
            const fillableAmounts = (0, RfqtQuoteValidator_1.getRfqtV2FillableAmounts)(prices, chainId, quotedMakerBalances);
            expect(fillableAmounts).toEqual([
                { fillableMakerAmount: new utils_1.BigNumber(0), fillableTakerAmount: new utils_1.BigNumber(0) },
            ]);
        });
    });
});
//# sourceMappingURL=data:application/json;charset=utf-8;base64,eyJmaWxlIjoiL1VzZXJzL2Rhdmlkd2Fsc2gvY29kZS1sb2NhbC8weC1yZnEtYXBpL3Rlc3QvdXRpbHMvUmZxdFF1b3RlVmFsaWRhdG9yVGVzdC50cyIsIm1hcHBpbmdzIjoiOztBQUFBLHFDQUFzQztBQUV0Qyx3REFBd0U7QUFJeEUsMkVBQWdHO0FBRWhHLFFBQVEsQ0FBQyxzQkFBc0IsRUFBRSxHQUFHLEVBQUU7SUFDbEMsTUFBTSxPQUFPLEdBQUcsSUFBSSxDQUFDO0lBQ3JCLE1BQU0sVUFBVSxHQUFlO1FBQzNCLGVBQWUsRUFBRSxDQUFDLE9BQU8sQ0FBQztRQUMxQixPQUFPLEVBQUUsRUFBRTtRQUNYLFlBQVksRUFBRSxlQUFlO1FBQzdCLEtBQUssRUFBRSxpQkFBaUI7UUFDeEIsR0FBRyxFQUFFLEtBQUs7UUFDVixJQUFJLEVBQUUsS0FBSztRQUNYLElBQUksRUFBRSxJQUFJO0tBQ2IsQ0FBQztJQUNGLE1BQU0sWUFBWSxHQUFpQjtRQUMvQixNQUFNLEVBQUUsS0FBSztRQUNiLFFBQVEsRUFBRSxNQUFNO1FBQ2hCLFFBQVEsRUFBRSxLQUFLO1FBQ2Ysa0JBQWtCLEVBQUUsS0FBSztRQUN6QixrQkFBa0IsRUFBRSxFQUFFO1FBQ3RCLGtCQUFrQixFQUFFLEVBQUU7UUFDdEIsZUFBZSxFQUFFLENBQUM7UUFDbEIsZUFBZSxFQUFFLElBQUksaUJBQVMsQ0FBQyxHQUFHLENBQUM7UUFDbkMsT0FBTztRQUNQLFVBQVU7UUFDVixVQUFVLEVBQUUsS0FBSztRQUNqQixTQUFTLEVBQUUsS0FBSztRQUNoQixZQUFZLEVBQUUsS0FBSztRQUNuQixVQUFVLEVBQUUsS0FBSztRQUNqQixRQUFRLEVBQUUsZ0JBQWdCO0tBQzdCLENBQUM7SUFDRixNQUFNLFFBQVEsR0FBRyxJQUFJLGlCQUFTLENBQUMsSUFBSSxDQUFDLEdBQUcsRUFBRSxDQUFDLENBQUMsR0FBRyxDQUFDLHlCQUFhLENBQUMsQ0FBQztJQUM5RCxNQUFNLFdBQVcsR0FBa0I7UUFDL0I7WUFDSSxNQUFNLEVBQUUsUUFBUSxDQUFDLElBQUksQ0FB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RUFBRSxHQUFHLEVBQUU7WUFDN0QsTUFBTSxNQUFNLEdBQUc7Z0JBQ1g7b0JBQ0ksTUFBTSxFQUFFLFFBQVEsQ0FBQyxJQUFJLENBQUMsRUFBRSxDQUFDO29CQUN6QixZQUFZLEVBQUUsVUFBVTtvQkFDeEIsV0FBVyxFQUFFLElBQUksaUJBQVMsQ0FBQyxDQUFDLENBQUM7b0JBQzdCLE9BQU8sRUFBRSxhQUFhO29CQUN0QixVQUFVLEVBQUUsS0FBSztvQkFDakIsUUFBUSxFQUFFLFlBQVk7b0JBQ3RCLFdBQVcsRUFBRSxJQUFJLGlCQUFTLENBQUMsR0FBRyxDQUFDO29CQUMvQixVQUFVLEVBQUUsS0FBSztpQkFDcEI7YUFDSixDQUFDO1lBQ0YsTUFBTSxtQkFBbUIsR0FBRyxDQUFDLElBQUksaUJBQVMsQ0FBQyxJQUFJLENBQUMsQ0FBQyxDQUFDO1lBQ2xELE1BQU0sZUFBZSxHQUFHLElBQUEsNkNBQXdCLEVBQUMsTUFBTSxFQUFFLE9BQU8sRUFBRSxtQkFBbUIsQ0FBQyxDQUFDO1lBQ3ZGLE1BQU0sQ0FBQyxlQUFlLENBQUMsQ0FBQyxPQUFPLENBQUM7Z0JBQzVCLEVBQUUsbUJBQW1CLEVBQUUsSUFBSSxpQkFBUyxDQUFDLENBQUMsQ0FBQyxFQUFFLG1CQUFtQixFQUFFLElBQUksaUJBQVMsQ0FBQyxDQUFDLENBQUMsRUFBRTthQUNuRixDQUFDLENBQUM7UUFDUCxDQUFDLENBQUMsQ0FBQztJQUNQLENBQUMsQ0FBQyxDQUFDO0FBQ1AsQ0FBQyxDQUFDLENBQUMiLCJuYW1lcyI6W10sInNvdXJjZXMiOlsiL1VzZXJzL2Rhdmlkd2Fsc2gvY29kZS1sb2NhbC8weC1yZnEtYXBpL3Rlc3QvdXRpbHMvUmZxdFF1b3RlVmFsaWRhdG9yVGVzdC50cyJdLCJzb3VyY2VzQ29udGVudCI6WyJpbXBvcnQgeyBCaWdOdW1iZXIgfSBmcm9tICdAMHgvdXRpbHMnO1xyXG5pbXBvcnQgeyBJbnRlZ3JhdG9yIH0gZnJvbSAnLi4vLi4vc3JjL2NvbmZpZyc7XHJcbmltcG9ydCB7IE9ORV9NSU5VVEVfTVMsIE9ORV9TRUNPTkRfTVMgfSBmcm9tICcuLi8uLi9zcmMvY29yZS9jb25zdGFudHMnO1xyXG5pbXBvcnQgeyBRdW90ZUNvbnRleHQgfSBmcm9tICcuLi8uLi9zcmMvc2VydmljZXMvdHlwZXMnO1xyXG5cclxuaW1wb3J0IHsgUmZxdFYyUHJpY2UgfSBmcm9tICcuLi8uLi9zcmMvY29yZS90eXBlcyc7XHJcbmltcG9ydCB7IGdldFJmcXRWMkZpbGxhYmxlQW1vdW50cywgdmFsaWRhdGVWMlByaWNlcyB9IGZyb20gJy4uLy4uL3NyYy91dGlscy9SZnF0UXVvdGVWYWxpZGF0b3InO1xyXG5cclxuZGVzY3JpYmUoJ1JmcXQgUXVvdGUgVmFsaWRhdG9yJywgKCkgPT4ge1xyXG4gICAgY29uc3QgY2hhaW5JZCA9IDEzMzc7XHJcbiAgICBjb25zdCBpbnRlZ3JhdG9yOiBJbnRlZ3JhdG9yID0ge1xyXG4gICAgICAgIGFsbG93ZWRDaGFpbklkczogW2NoYWluSWRdLFxyXG4gICAgICAgIGFwaUtleXM6IFtdLFxyXG4gICAgICAgIGludGVncmF0b3JJZDogJ2ludGVncmF0b3ItaWQnLFxyXG4gICAgICAgIGxhYmVsOiAndGVzdCBpbnRlZ3JhdG9yJyxcclxuICAgICAgICBwbHA6IGZhbHNlLFxyXG4gICAgICAgIHJmcW06IGZhbHNlLFxyXG4gICAgICAgIHJmcXQ6IHRydWUsXHJcbiAgICB9O1xyXG4gICAgY29uc3QgcXVvdGVDb250ZXh0OiBRdW90ZUNvbnRleHQgPSB7XHJcbiAgICAgICAgaXNGaXJtOiBmYWxzZSxcclxuICAgICAgICB3b3JrZmxvdzogJ3JmcXQnLFxyXG4gICAgICAgIGlzVW53cmFwOiBmYWxzZSxcclxuICAgICAgICBvcmlnaW5hbE1ha2VyVG9rZW46ICcweDEnLFxyXG4gICAgICAgIHRha2VyVG9rZW5EZWNpbWFsczogMTgsXHJcbiAgICAgICAgbWFrZXJUb2tlbkRlY2ltYWxzOiAxOCxcclxuICAgICAgICBmZWVNb2RlbFZlcnNpb246IDEsXHJcbiAgICAgICAgYXNzZXRGaWxsQW1vdW50OiBuZXcgQmlnTnVtYmVyKDExMSksXHJcbiAgICAgICAgY2hhaW5JZCxcclxuICAgICAgICBpbnRlZ3JhdG9yLFxyXG4gICAgICAgIG1ha2VyVG9rZW46ICcweDEnLFxyXG4gICAgICAgIGlzU2VsbGluZzogZmFsc2UsXHJcbiAgICAgICAgdGFrZXJBZGRyZXNzOiAnMHgwJyxcclxuICAgICAgICB0YWtlclRva2VuOiAnMHgyJyxcclxuICAgICAgICB0eE9yaWdpbjogJzB4dGFrZXJhZGRyZXNzJyxcclxuICAgIH07XHJcbiAgICBjb25zdCBub3dUaW1lUyA9IG5ldyBCaWdOdW1iZXIoRGF0ZS5ub3coKSkuZGl2KE9ORV9TRUNPTkRfTVMpO1xyXG4gICAgY29uc3QgdmFsaWRQcmljZXM6IFJmcXRWMlByaWNlW10gPSBbXHJcbiAgICAgICAge1xyXG4gICAgICAgICAgICBleHBpcnk6IG5vd1RpbWVTLnBsdXMoNzUpLFxyXG4gICAgICAgICAgICBtYWtlckFkZHJlc3M6ICcweG1ha2VyMScsXHJcbiAgICAgICAgICAgIG1ha2VyQW1vdW50OiBuZXcgQmlnTnVtYmVyKDExMSksXHJcbiAgICAgICAgICAgIG1ha2VySWQ6ICd1dWlkLW1ha2VyMScsXHJcbiAgICAgICAgICAgIG1ha2VyVG9rZW46ICcweDEnLFxyXG4gICAgICAgICAgICBtYWtlclVyaTogJ21ha2VyMS54eXonLFxyXG4gICAgICAgICAgICB0YWtlckFtb3VudDogbmV3IEJpZ051bWJlcigxMTEpLFxyXG4gICAgICAgICAgICB0YWtlclRva2VuOiAnMHgyJyxcclxuICAgICAgICB9LFxyXG4gICAgICAgIHtcclxuICAgICAgICAgICAgZXhwaXJ5OiBub3dUaW1lUy5wbHVzKDc1KSxcclxuICAgICAgICAgICAgbWFrZXJBZGRyZXNzOiAnMHhtYWtlcjInLFxyXG4gICAgICAgICAgICBtYWtlckFtb3VudDogbmV3IEJpZ051bWJlcigxMTEpLFxyXG4gICAgICAgICAgICBtYWtlcklkOiAndXVpZC1tYWtlcjInLFxyXG4gICAgICAgICAgICBtYWtlclRva2VuOiAnMHgxJyxcclxuICAgICAgICAgICAgbWFrZXJVcmk6ICdtYWtlcjIueHl6JyxcclxuICAgICAgICAgICAgdGFrZXJBbW91bnQ6IG5ldyBCaWdOdW1iZXIoMTExKSxcclxuICAgICAgICAgICAgdGFrZXJUb2tlbjogJzB4MicsXHJcbiAgICAgICAgfSxcclxuICAgIF07XHJcbiAgICBjb25zdCB2YWxpZGl0eVdpbmRvd01zID0gT05FX01JTlVURV9NUztcclxuXHJcbiAgICBkZXNjcmliZSgndmFsaWRhdGVWMlByaWNlcycsICgpID0+IHtcclxuICAgICAgICBpdCgnZmlsdGVycyBmZXRjaGVkIHByaWNlcyBmb3IgdGhlIHdyb25nIHBhaXInLCAoKSA9PiB7XHJcbiAgICAgICAgICAgIGNvbnN0IHByaWNlczogUmZxdFYyUHJpY2VbXSA9IFtcclxuICAgICAgICAgICAgICAgIC4uLnZhbGlkUHJpY2VzLFxyXG4gICAgICAgICAgICAgICAge1xyXG4gICAgICAgICAgICAgICAgICAgIGV4cGlyeTogbm93VGltZVMucGx1cyg3NSksXHJcbiAgICAgICAgICAgICAgICAgICAgbWFrZXJBZGRyZXNzOiAnMHhtYWtlcjMnLFxyXG4gICAgICAgICAgICAgICAgICAgIG1ha2VyQW1vdW50OiBuZXcgQmlnTnVtYmVyKDExMSksXHJcbiAgICAgICAgICAgICAgICAgICAgbWFrZXJJZDogJ3V1aWQtbWFrZXIzJyxcclxuICAgICAgICAgICAgICAgICAgICBtYWtlclRva2VuOiAnMHgxJyxcclxuICAgICAgICAgICAgICAgICAgICBtYWtlclVyaTogJ21ha2VyMy54eXonLFxyXG4gICAgICAgICAgICAgICAgICAgIHRha2VyQW1vdW50OiBuZXcgQmlnTnVtYmVyKDExMSksXHJcbiAgICAgICAgICAgICAgICAgICAgdGFrZXJUb2tlbjogJzB4MycsXHJcbiAgICAgICAgICAgICAgICB9LFxyXG4gICAgICAgICAgICBdO1xyXG4gICAgICAgICAgICBjb25zdCB2YWxpZGF0ZWRQcmljZXMgPSB2YWxpZGF0ZVYyUHJpY2VzKHByaWNlcywgcXVvdGVDb250ZXh0LCB2YWxpZGl0eVdpbmRvd01zKTtcclxuICAgICAgICAgICAgZXhwZWN0KHZhbGlkYXRlZFByaWNlcykudG9FcXVhbCh2YWxpZFByaWNlcyk7XHJcbiAgICAgICAgfSk7XHJcblxyXG4gICAgICAgIGl0KCdmaWx0ZXJzIGZldGNoZWQgcHJpY2VzIHdpdGggdGlnaHQgZXhwaXJhdGlvbiB3aW5kb3dzJywgKCkgPT4ge1xyXG4gICAgICAgICAgICBjb25zdCBwcmljZXM6IFJmcXRWMlByaWNlW10gPSBbXHJcbiAgICAgICAgICAgICAgICAuLi52YWxpZFByaWNlcyxcclxuICAgICAgICAgICAgICAgIHtcclxuICAgICAgICAgICAgICAgICAgICBleHBpcnk6IG5vd1RpbWVTLnBsdXMoNTkpLFxyXG4gICAgICAgICAgICAgICAgICAgIG1ha2VyQWRkcmVzczogJzB4bWFrZXIzJyxcclxuICAgICAgICAgICAgICAgICAgICBtYWtlckFtb3VudDogbmV3IEJpZ051bWJlcigxMTEpLFxyXG4gICAgICAgICAgICAgICAgICAgIG1ha2VySWQ6ICd1dWlkLW1ha2VyMycsXHJcbiAgICAgICAgICAgICAgICAgICAgbWFrZXJUb2tlbjogJzB4MScsXHJcbiAgICAgICAgICAgICAgICAgICAgbWFrZXJVcmk6ICdtYWtlcjMueHl6JyxcclxuICAgICAgICAgICAgICAgICAgICB0YWtlckFtb3VudDogbmV3IEJpZ051bWJlcigxMTEpLFxyXG4gICAgICAgICAgICAgICAgICAgIHRha2VyVG9rZW46ICcweDInLFxyXG4gICAgICAgICAgICAgICAgfSxcclxuICAgICAgICAgICAgXTtcclxuICAgICAgICAgICAgY29uc3QgdmFsaWRhdGVkUHJpY2VzID0gdmFsaWRhdGVWMlByaWNlcyhwcmljZXMsIHF1b3RlQ29udGV4dCwgdmFsaWRpdHlXaW5kb3dNcyk7XHJcbiAgICAgICAgICAgIGV4cGVjdCh2YWxpZGF0ZWRQcmljZXMpLnRvRXF1YWwodmFsaWRQcmljZXMpO1xyXG4gICAgICAgIH0pO1xyXG5cclxuICAgICAgICBpdCgncmV0dXJucyBhbiBlbXB0eSBhcnJheSBmcm9tIGVtcHR5IHByaWNlcycsICgpID0+IHtcclxuICAgICAgICAgICAgY29uc3QgZW1wdHlQcmljZXMgPSB2YWxpZGF0ZVYyUHJpY2VzKFtdLCBxdW90ZUNvbnRleHQsIHZhbGlkaXR5V2luZG93TXMpO1xyXG4gICAgICAgICAgICBleHBlY3QoZW1wdHlQcmljZXMpLnRvRXF1YWwoW10pO1xyXG4gICAgICAgIH0pO1xyXG4gICAgfSk7XHJcblxyXG4gICAgZGVzY3JpYmUoJ2dldFJmcXRWMkZpbGxhYmxlQW1vdW50cycsICgpID0+IHtcclxuICAgICAgICBpdCgncmV0dXJucyBmdWxsIGFtb3VudHMgZm9yIGZ1bGx5IGZpbGxhYmxlIG9yZGVycycsICgpID0+IHtcclxuICAgICAgICAgICAgY29uc3QgcXVvdGVkTWFrZXJCYWxhbmNlcyA9IFtuZXcgQmlnTnVtYmVyKDEwMDApLCBuZXcgQmlnTnVtYmVyKDEwMDApXTtcclxuICAgICAgICAgICAgY29uc3QgZmlsbGFibGVBbW91bnRzID0gZ2V0UmZxdFYyRmlsbGFibGVBbW91bnRzKHZhbGlkUHJpY2VzLCBjaGFpbklkLCBxdW90ZWRNYWtlckJhbGFuY2VzKTtcclxuICAgICAgICAgICAgZXhwZWN0KGZpbGxhYmxlQW1vdW50cykudG9FcXVhbChbXHJcbiAgICAgICAgICAgICAgICB7IGZpbGxhYmxlTWFrZXJBbW91bnQ6IG5ldyBCaWdOdW1iZXIoMTExKSwgZmlsbGFibGVUYWtlckFtb3VudDogbmV3IEJpZ051bWJlcigxMTEpIH0sXHJcbiAgICAgICAgICAgICAgICB7IGZpbGxhYmxlTWFrZXJBbW91bnQ6IG5ldyBCaWdOdW1iZXIoMTExKSwgZmlsbGFibGVUYWtlckFtb3VudDogbmV3IEJpZ051bWJlcigxMTEpIH0sXHJcbiAgICAgICAgICAgIF0pO1xyXG4gICAgICAgIH0pO1xyXG5cclxuICAgICAgICBpdCgncmV0dXJucyBmdWxsIGFtb3VudHMgaWYgbWFrZXIgYmFsYW5jZXMgYXJlIG5vdCBwcmVzZW50JywgKCkgPT4ge1xyXG4gICAgICAgICAgICBjb25zdCBmaWxsYWJsZUFtb3VudHMgPSBnZXRSZnF0VjJGaWxsYWJsZUFtb3VudHModmFsaWRQcmljZXMsIGNoYWluSWQpO1xyXG4gICAgICAgICAgICBleHBlY3QoZmlsbGFibGVBbW91bnRzKS50b0VxdWFsKFtcclxuICAgICAgICAgICAgICAgIHsgZmlsbGFibGVNYWtlckFtb3VudDogbmV3IEJpZ051bWJlcigxMTEpLCBmaWxsYWJsZVRha2VyQW1vdW50OiBuZXcgQmlnTnVtYmVyKDExMSkgfSxcclxuICAgICAgICAgICAgICAgIHsgZmlsbGFibGVNYWtlckFtb3VudDogbmV3IEJpZ051bWJlcigxMTEpLCBmaWxsYWJsZVRha2VyQW1vdW50OiBuZXcgQmlnTnVtYmVyKDExMSkgfSxcclxuICAgICAgICAgICAgXSk7XHJcbiAgICAgICAgfSk7XHJcblxyXG4gICAgICAgIGl0KCdyZXR1cm5zIHBhcnRpYWwgYW1vdW50cyBpZiBhIG1ha2VyIGRvZXMgbm90IGhhdmUgZW5vdWdoIGJhbGFuY2UnLCAoKSA9PiB7XHJcbiAgICAgICAgICAgIGNvbnN0IHF1b3RlZE1ha2VyQmFsYW5jZXMgPSBbbmV3IEJpZ051bWJlcigxMDAwKSwgbmV3IEJpZ051bWJlcigxMCldO1xyXG4gICAgICAgICAgICBjb25zdCBmaWxsYWJsZUFtb3VudHMgPSBnZXRSZnF0VjJGaWxsYWJsZUFtb3VudHModmFsaWRQcmljZXMsIGNoYWluSWQsIHF1b3RlZE1ha2VyQmFsYW5jZXMpO1xyXG4gICAgICAgICAgICBleHBlY3QoZmlsbGFibGVBbW91bnRzKS50b0VxdWFsKFtcclxuICAgICAgICAgICAgICAgIHsgZmlsbGFibGVNYWtlckFtb3VudDogbmV3IEJpZ051bWJlcigxMTEpLCBmaWxsYWJsZVRha2VyQW1vdW50OiBuZXcgQmlnTnVtYmVyKDExMSkgfSxcclxuICAgICAgICAgICAgICAgIHsgZmlsbGFibGVNYWtlckFtb3VudDogbmV3IEJpZ051bWJlcigxMCksIGZpbGxhYmxlVGFrZXJBbW91bnQ6IG5ldyBCaWdOdW1iZXIoMTApIH0sXHJcbiAgICAgICAgICAgIF0pO1xyXG4gICAgICAgIH0pO1xyXG5cclxuICAgICAgICBpdCgncmV0dXJucyB6ZXJvIGFtb3VudHMgaWYgYSBtYWtlciBoYXMgemVybyBiYWxhbmNlJywgKCkgPT4ge1xyXG4gICAgICAgICAgICBjb25zdCBxdW90ZWRNYWtlckJhbGFuY2VzID0gW25ldyBCaWdOdW1iZXIoMTAwMCksIG5ldyBCaWdOdW1iZXIoMCldO1xyXG4gICAgICAgICAgICBjb25zdCBmaWxsYWJsZUFtb3VudHMgPSBnZXRSZnF0VjJGaWxsYWJsZUFtb3VudHModmFsaWRQcmljZXMsIGNoYWluSWQsIHF1b3RlZE1ha2VyQmFsYW5jZXMpO1xyXG4gICAgICAgICAgICBleHBlY3QoZmlsbGFibGVBbW91bnRzKS50b0VxdWFsKFtcclxuICAgICAgICAgICAgICAgIHsgZmlsbGFibGVNYWtlckFtb3VudDogbmV3IEJpZ051bWJlcigxMTEpLCBmaWxsYWJsZVRha2VyQW1vdW50OiBuZXcgQmlnTnVtYmVyKDExMSkgfSxcclxuICAgICAgICAgICAgICAgIHsgZmlsbGFibGVNYWtlckFtb3VudDogbmV3IEJpZ051bWJlcigwKSwgZmlsbGFibGVUYWtlckFtb3VudDogbmV3IEJpZ051bWJlcigwKSB9LFxyXG4gICAgICAgICAgICBdKTtcclxuICAgICAgICB9KTtcclxuXHJcbiAgICAgICAgaXQoJ3JldHVybnMgemVybyBhbW91bnRzIGlmIHN1cHBsaWVkIG1ha2VyIGFtb3VudCBpcyB6ZXJvJywgKCkgPT4ge1xyXG4gICAgICAgICAgICBjb25zdCBwcmljZXMgPSBbXHJcbiAgICAgICAgICAgICAgICB7XHJcbiAgICAgICAgICAgICAgICAgICAgZXhwaXJ5OiBub3dUaW1lUy5wbHVzKDc1KSxcclxuICAgICAgICAgICAgICAgICAgICBtYWtlckFkZHJlc3M6ICcweG1ha2VyMycsXHJcbiAgICAgICAgICAgICAgICAgICAgbWFrZXJBbW91bnQ6IG5ldyBCaWdOdW1iZXIoMCksXHJcbiAgICAgICAgICAgICAgICAgICAgbWFrZXJJZDogJ3V1aWQtbWFrZXIzJyxcclxuICAgICAgICAgICAgICAgICAgICBtYWtlclRva2VuOiAnMHgxJyxcclxuICAgICAgICAgICAgICAgICAgICBtYWtlclVyaTogJ21ha2VyMy54eXonLFxyXG4gICAgICAgICAgICAgICAgICAgIHRha2VyQW1vdW50OiBuZXcgQmlnTnVtYmVyKDExMSksXHJcbiAgICAgICAgICAgICAgICAgICAgdGFrZXJUb2tlbjogJzB4MicsXHJcbiAgICAgICAgICAgICAgICB9LFxyXG4gICAgICAgICAgICBdO1xyXG4gICAgICAgICAgICBjb25zdCBxdW90ZWRNYWtlckJhbGFuY2VzID0gW25ldyBCaWdOdW1iZXIoMTAwMCldO1xyXG4gICAgICAgICAgICBjb25zdCBmaWxsYWJsZUFtb3VudHMgPSBnZXRSZnF0VjJGaWxsYWJsZUFtb3VudHMocHJpY2VzLCBjaGFpbklkLCBxdW90ZWRNYWtlckJhbGFuY2VzKTtcclxuICAgICAgICAgICAgZXhwZWN0KGZpbGxhYmxlQW1vdW50cykudG9FcXVhbChbXHJcbiAgICAgICAgICAgICAgICB7IGZpbGxhYmxlTWFrZXJBbW91bnQ6IG5ldyBCaWdOdW1iZXIoMCksIGZpbGxhYmxlVGFrZXJBbW91bnQ6IG5ldyBCaWdOdW1iZXIoMCkgfSxcclxuICAgICAgICAgICAgXSk7XHJcbiAgICAgICAgfSk7XHJcbiAgICB9KTtcclxufSk7XHJcbiJdLCJ2ZXJzaW9uIjozfQ==