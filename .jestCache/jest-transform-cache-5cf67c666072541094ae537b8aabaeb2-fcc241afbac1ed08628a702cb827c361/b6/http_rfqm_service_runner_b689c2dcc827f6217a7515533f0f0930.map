{"file":"/Users/davidwalsh/code-local/0x-rfq-api/src/runners/http_rfqm_service_runner.ts","mappings":"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","names":[],"sources":["/Users/davidwalsh/code-local/0x-rfq-api/src/runners/http_rfqm_service_runner.ts"],"sourcesContent":["/**\r\n * This module can be used to run the RFQM HTTP service standalone\r\n */\r\nimport { createDefaultServer, HttpServiceConfig } from '@0x/api-utils';\r\nimport * as Sentry from '@sentry/node';\r\nimport * as Tracing from '@sentry/tracing';\r\nimport Axios from 'axios';\r\nimport * as express from 'express';\r\nimport * as promBundle from 'express-prom-bundle';\r\n// tslint:disable-next-line:no-implicit-dependencies\r\nimport * as core from 'express-serve-static-core';\r\nimport { Server } from 'http';\r\nimport * as HttpStatus from 'http-status-codes';\r\nimport Redis from 'ioredis';\r\nimport { DataSource } from 'typeorm';\r\n\r\nimport {\r\n    CHAIN_CONFIGURATIONS,\r\n    defaultHttpServiceConfig,\r\n    DEFINED_FI_API_KEY,\r\n    DEFINED_FI_ENDPOINT,\r\n    REDIS_URI,\r\n    SENTRY_DSN,\r\n    SENTRY_ENVIRONMENT,\r\n    SENTRY_TRACES_SAMPLE_RATE,\r\n    TOKEN_PRICE_ORACLE_TIMEOUT,\r\n} from '../config';\r\nimport { ADMIN_PATH, RFQM_PATH, RFQT_V1_PATH, RFQT_V2_PATH, RFQ_MAKER_PATH } from '../core/constants';\r\nimport { getDbDataSourceAsync } from '../getDbDataSourceAsync';\r\nimport { rootHandler } from '../handlers/root_handler';\r\nimport { logger } from '../logger';\r\nimport { addressNormalizer } from '../middleware/address_normalizer';\r\nimport { errorHandler } from '../middleware/error_handling';\r\nimport { createRfqmRouter } from '../routers/rfqm_router';\r\nimport { createRfqtV1Router, createRfqtV2Router } from '../routers/RfqtRouter';\r\nimport { createRfqAdminRouter } from '../routers/rfq_admin_router';\r\nimport { createRfqMakerRouter } from '../routers/rfq_maker_router';\r\nimport { RfqAdminService } from '../services/rfq_admin_service';\r\nimport { RfqMakerService } from '../services/rfq_maker_service';\r\nimport { ConfigManager } from '../utils/config_manager';\r\nimport { RfqmDbUtils } from '../utils/rfqm_db_utils';\r\nimport { buildRfqmServicesAsync, getAxiosRequestConfig, RfqmServices } from '../utils/rfqm_service_builder';\r\nimport { buildRfqtServicesAsync, RfqtServices } from '../utils/rfqtServiceBuilder';\r\nimport { RfqMakerDbUtils } from '../utils/rfq_maker_db_utils';\r\nimport { closeRedisConnectionsAsync } from '../utils/runner_utils';\r\nimport { TokenPriceOracle } from '../utils/TokenPriceOracle';\r\n\r\nconst redisInstances: Redis[] = [];\r\n\r\nprocess.on('uncaughtException', (err) => {\r\n    logger.error(err);\r\n    process.exit(1);\r\n});\r\n\r\nprocess.on('unhandledRejection', (err) => {\r\n    if (err) {\r\n        logger.error(err as Error);\r\n    }\r\n});\r\n\r\nprocess.on('SIGTERM', async () => {\r\n    logger.info('Received SIGTERM. Start to shutdown RFQ services');\r\n    await closeRedisConnectionsAsync(redisInstances);\r\n    process.exit(0);\r\n});\r\n\r\n// Used for shutting down locally\r\nprocess.on('SIGINT', async () => {\r\n    logger.info('Received SIGINT. Start to shutdown RFQ services');\r\n    await closeRedisConnectionsAsync(redisInstances);\r\n    process.exit(0);\r\n});\r\n\r\nif (require.main === module) {\r\n    (async () => {\r\n        // Build dependencies\r\n        const config: HttpServiceConfig = {\r\n            ...defaultHttpServiceConfig,\r\n        };\r\n        const connection = await getDbDataSourceAsync();\r\n        const rfqmDbUtils = new RfqmDbUtils(connection);\r\n        const rfqMakerDbUtils = new RfqMakerDbUtils(connection);\r\n        const configManager = new ConfigManager();\r\n        const axiosInstance = Axios.create(getAxiosRequestConfig(TOKEN_PRICE_ORACLE_TIMEOUT));\r\n        const tokenPriceOracle = new TokenPriceOracle(axiosInstance, DEFINED_FI_API_KEY, DEFINED_FI_ENDPOINT);\r\n\r\n        if (!REDIS_URI) {\r\n            throw new Error('No redis URI provided to RFQ Service');\r\n        }\r\n        const redis = new Redis(REDIS_URI);\r\n        redisInstances.push(redis);\r\n\r\n        const rfqmServices = await buildRfqmServicesAsync(\r\n            /* asWorker = */ false,\r\n            rfqmDbUtils,\r\n            rfqMakerDbUtils,\r\n            CHAIN_CONFIGURATIONS,\r\n            tokenPriceOracle,\r\n            configManager,\r\n            redis,\r\n        );\r\n\r\n        const rfqtServices = await buildRfqtServicesAsync(CHAIN_CONFIGURATIONS, rfqMakerDbUtils, redis);\r\n\r\n        const rfqAdminService = buildRfqAdminService(rfqmDbUtils);\r\n        const rfqMakerService = buildRfqMakerService(rfqMakerDbUtils, configManager);\r\n        await runHttpRfqmServiceAsync(\r\n            rfqmServices,\r\n            rfqtServices,\r\n            rfqAdminService,\r\n            rfqMakerService,\r\n            configManager,\r\n            config,\r\n            connection,\r\n        );\r\n    })().catch((error) => logger.error(error.stack));\r\n}\r\n\r\n/**\r\n * Builds an instance of RfqAdminService\r\n */\r\nexport function buildRfqAdminService(dbUtils: RfqmDbUtils): RfqAdminService {\r\n    return new RfqAdminService(dbUtils);\r\n}\r\n\r\n/**\r\n * Builds an instance of RfqMakerService\r\n */\r\nexport function buildRfqMakerService(dbUtils: RfqMakerDbUtils, configManager: ConfigManager): RfqMakerService {\r\n    return new RfqMakerService(dbUtils, configManager);\r\n}\r\n\r\n/**\r\n * Runs the Rfqm Service in isolation\r\n */\r\nexport async function runHttpRfqmServiceAsync(\r\n    rfqmServices: RfqmServices,\r\n    rfqtServices: RfqtServices,\r\n    rfqAdminService: RfqAdminService,\r\n    rfqMakerService: RfqMakerService,\r\n    configManager: ConfigManager,\r\n    config: HttpServiceConfig,\r\n    connection: DataSource,\r\n    // $eslint-fix-me https://github.com/rhinodavid/eslint-fix-me\r\n    // eslint-disable-next-line @typescript-eslint/no-inferrable-types\r\n    useMetricsMiddleware: boolean = true,\r\n    _app?: core.Express,\r\n): Promise<{ app: express.Application; server: Server }> {\r\n    const app = _app || express();\r\n\r\n    if (SENTRY_DSN) {\r\n        Sentry.init({\r\n            dsn: SENTRY_DSN,\r\n            integrations: [\r\n                // enable HTTP calls tracing\r\n                new Sentry.Integrations.Http({ tracing: true }),\r\n                // enable Express.js middleware tracing\r\n                new Tracing.Integrations.Express({ app }),\r\n            ],\r\n            environment: SENTRY_ENVIRONMENT,\r\n\r\n            // Set tracesSampleRate to 1.0 to capture 100%\r\n            // of transactions for performance monitoring.\r\n            // We recommend adjusting this value in production\r\n            tracesSampleRate: SENTRY_TRACES_SAMPLE_RATE,\r\n        });\r\n\r\n        // RequestHandler creates a separate execution context using domains, so that every\r\n        // transaction/span/breadcrumb is attached to its own Hub instance\r\n        app.use(Sentry.Handlers.requestHandler());\r\n        // TracingHandler creates a trace for every incoming request\r\n        app.use(Sentry.Handlers.tracingHandler());\r\n    }\r\n\r\n    if (useMetricsMiddleware) {\r\n        /**\r\n         * express-prom-bundle will create a histogram metric called \"http_request_duration_seconds\"\r\n         * The official prometheus docs describe how to use this exact histogram metric: https://prometheus.io/docs/practices/histograms/\r\n         * We use the following labels: statusCode, path\r\n         */\r\n        const metricsMiddleware = promBundle({\r\n            autoregister: false,\r\n            includeStatusCode: true,\r\n            includePath: true,\r\n            customLabels: { chainId: undefined },\r\n            normalizePath: [\r\n                ['/status/.*', '/status/#orderHash'], // converts all /status/0xdeadbeef... => /status/#orderHash\r\n                ['/api-docs.*', '/api-docs'], // converts all /api-docs/favicon... => /api-docs\r\n            ],\r\n            transformLabels: (labels, req, _res) => {\r\n                Object.assign(labels, { chainId: req.header('0x-chain-id') || 1 });\r\n            },\r\n            // buckets used for the http_request_duration_seconds histogram. All numbers (in seconds) represents boundaries of buckets.\r\n            // tslint:disable-next-line: custom-no-magic-numbers\r\n            buckets: [0.01, 0.04, 0.1, 0.3, 0.6, 1, 1.5, 2, 2.5, 3, 4, 6, 9],\r\n        });\r\n        app.use(metricsMiddleware);\r\n    }\r\n    app.use(addressNormalizer);\r\n    app.get('/', rootHandler);\r\n    const server = createDefaultServer(config, app, logger, async () => {\r\n        await connection.close();\r\n    });\r\n\r\n    app.use(RFQM_PATH, createRfqmRouter(rfqmServices, configManager));\r\n    app.use(RFQT_V1_PATH, createRfqtV1Router(rfqtServices, configManager));\r\n    app.use(RFQT_V2_PATH, createRfqtV2Router(rfqtServices, configManager));\r\n    app.use(RFQ_MAKER_PATH, createRfqMakerRouter(rfqMakerService));\r\n    app.use(ADMIN_PATH, createRfqAdminRouter(rfqAdminService, configManager));\r\n\r\n    if (SENTRY_DSN) {\r\n        // The error handler must be before any other error middleware and after all controllers\r\n        app.use(\r\n            Sentry.Handlers.errorHandler({\r\n                // $eslint-fix-me https://github.com/rhinodavid/eslint-fix-me\r\n                // eslint-disable-next-line @typescript-eslint/no-explicit-any\r\n                shouldHandleError(error: any): boolean {\r\n                    if (error.status === undefined || error.status >= HttpStatus.BAD_REQUEST) {\r\n                        return true;\r\n                    }\r\n                    return false;\r\n                },\r\n            }),\r\n        );\r\n    }\r\n\r\n    app.use(errorHandler);\r\n\r\n    server.listen(config.httpPort);\r\n    return { app, server };\r\n}\r\n"],"version":3}