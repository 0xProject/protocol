ff94c1bb8885bd1ac9fa41dcbcf80d58
"use strict";
Object.defineProperty(exports, "__esModule", { value: true });
exports.runHttpRfqmServiceAsync = exports.buildRfqMakerService = exports.buildRfqAdminService = void 0;
/**
 * This module can be used to run the RFQM HTTP service standalone
 */
const api_utils_1 = require("@0x/api-utils");
const Sentry = require("@sentry/node");
const Tracing = require("@sentry/tracing");
const axios_1 = require("axios");
const express = require("express");
const promBundle = require("express-prom-bundle");
const HttpStatus = require("http-status-codes");
const ioredis_1 = require("ioredis");
const config_1 = require("../config");
const constants_1 = require("../core/constants");
const getDbDataSourceAsync_1 = require("../getDbDataSourceAsync");
const root_handler_1 = require("../handlers/root_handler");
const logger_1 = require("../logger");
const address_normalizer_1 = require("../middleware/address_normalizer");
const error_handling_1 = require("../middleware/error_handling");
const rfqm_router_1 = require("../routers/rfqm_router");
const RfqtRouter_1 = require("../routers/RfqtRouter");
const rfq_admin_router_1 = require("../routers/rfq_admin_router");
const rfq_maker_router_1 = require("../routers/rfq_maker_router");
const rfq_admin_service_1 = require("../services/rfq_admin_service");
const rfq_maker_service_1 = require("../services/rfq_maker_service");
const config_manager_1 = require("../utils/config_manager");
const rfqm_db_utils_1 = require("../utils/rfqm_db_utils");
const rfqm_service_builder_1 = require("../utils/rfqm_service_builder");
const rfqtServiceBuilder_1 = require("../utils/rfqtServiceBuilder");
const rfq_maker_db_utils_1 = require("../utils/rfq_maker_db_utils");
const runner_utils_1 = require("../utils/runner_utils");
const TokenPriceOracle_1 = require("../utils/TokenPriceOracle");
const redisInstances = [];
process.on('uncaughtException', (err) => {
    logger_1.logger.error(err);
    process.exit(1);
});
process.on('unhandledRejection', (err) => {
    if (err) {
        logger_1.logger.error(err);
    }
});
process.on('SIGTERM', async () => {
    logger_1.logger.info('Received SIGTERM. Start to shutdown RFQ services');
    await (0, runner_utils_1.closeRedisConnectionsAsync)(redisInstances);
    process.exit(0);
});
// Used for shutting down locally
process.on('SIGINT', async () => {
    logger_1.logger.info('Received SIGINT. Start to shutdown RFQ services');
    await (0, runner_utils_1.closeRedisConnectionsAsync)(redisInstances);
    process.exit(0);
});
if (require.main === module) {
    (async () => {
        // Build dependencies
        const config = {
            ...config_1.defaultHttpServiceConfig,
        };
        const connection = await (0, getDbDataSourceAsync_1.getDbDataSourceAsync)();
        const rfqmDbUtils = new rfqm_db_utils_1.RfqmDbUtils(connection);
        const rfqMakerDbUtils = new rfq_maker_db_utils_1.RfqMakerDbUtils(connection);
        const configManager = new config_manager_1.ConfigManager();
        const axiosInstance = axios_1.default.create((0, rfqm_service_builder_1.getAxiosRequestConfig)(config_1.TOKEN_PRICE_ORACLE_TIMEOUT));
        const tokenPriceOracle = new TokenPriceOracle_1.TokenPriceOracle(axiosInstance, config_1.DEFINED_FI_API_KEY, config_1.DEFINED_FI_ENDPOINT);
        if (!config_1.REDIS_URI) {
            throw new Error('No redis URI provided to RFQ Service');
        }
        const redis = new ioredis_1.default(config_1.REDIS_URI);
        redisInstances.push(redis);
        const rfqmServices = await (0, rfqm_service_builder_1.buildRfqmServicesAsync)(
        /* asWorker = */ false, rfqmDbUtils, rfqMakerDbUtils, config_1.CHAIN_CONFIGURATIONS, tokenPriceOracle, configManager, redis);
        const rfqtServices = await (0, rfqtServiceBuilder_1.buildRfqtServicesAsync)(config_1.CHAIN_CONFIGURATIONS, rfqMakerDbUtils, redis);
        const rfqAdminService = buildRfqAdminService(rfqmDbUtils);
        const rfqMakerService = buildRfqMakerService(rfqMakerDbUtils, configManager);
        await runHttpRfqmServiceAsync(rfqmServices, rfqtServices, rfqAdminService, rfqMakerService, configManager, config, connection);
    })().catch((error) => logger_1.logger.error(error.stack));
}
/**
 * Builds an instance of RfqAdminService
 */
function buildRfqAdminService(dbUtils) {
    return new rfq_admin_service_1.RfqAdminService(dbUtils);
}
exports.buildRfqAdminService = buildRfqAdminService;
/**
 * Builds an instance of RfqMakerService
 */
function buildRfqMakerService(dbUtils, configManager) {
    return new rfq_maker_service_1.RfqMakerService(dbUtils, configManager);
}
exports.buildRfqMakerService = buildRfqMakerService;
/**
 * Runs the Rfqm Service in isolation
 */
async function runHttpRfqmServiceAsync(rfqmServices, rfqtServices, rfqAdminService, rfqMakerService, configManager, config, connection, 
// $eslint-fix-me https://github.com/rhinodavid/eslint-fix-me
// eslint-disable-next-line @typescript-eslint/no-inferrable-types
useMetricsMiddleware = true, _app) {
    const app = _app || express();
    if (config_1.SENTRY_DSN) {
        Sentry.init({
            dsn: config_1.SENTRY_DSN,
            integrations: [
                // enable HTTP calls tracing
                new Sentry.Integrations.Http({ tracing: true }),
                // enable Express.js middleware tracing
                new Tracing.Integrations.Express({ app }),
            ],
            environment: config_1.SENTRY_ENVIRONMENT,
            // Set tracesSampleRate to 1.0 to capture 100%
            // of transactions for performance monitoring.
            // We recommend adjusting this value in production
            tracesSampleRate: config_1.SENTRY_TRACES_SAMPLE_RATE,
        });
        // RequestHandler creates a separate execution context using domains, so that every
        // transaction/span/breadcrumb is attached to its own Hub instance
        app.use(Sentry.Handlers.requestHandler());
        // TracingHandler creates a trace for every incoming request
        app.use(Sentry.Handlers.tracingHandler());
    }
    if (useMetricsMiddleware) {
        /**
         * express-prom-bundle will create a histogram metric called "http_request_duration_seconds"
         * The official prometheus docs describe how to use this exact histogram metric: https://prometheus.io/docs/practices/histograms/
         * We use the following labels: statusCode, path
         */
        const metricsMiddleware = promBundle({
            autoregister: false,
            includeStatusCode: true,
            includePath: true,
            customLabels: { chainId: undefined },
            normalizePath: [
                ['/status/.*', '/status/#orderHash'],
                ['/api-docs.*', '/api-docs'], // converts all /api-docs/favicon... => /api-docs
            ],
            transformLabels: (labels, req, _res) => {
                Object.assign(labels, { chainId: req.header('0x-chain-id') || 1 });
            },
            // buckets used for the http_request_duration_seconds histogram. All numbers (in seconds) represents boundaries of buckets.
            // tslint:disable-next-line: custom-no-magic-numbers
            buckets: [0.01, 0.04, 0.1, 0.3, 0.6, 1, 1.5, 2, 2.5, 3, 4, 6, 9],
        });
        app.use(metricsMiddleware);
    }
    app.use(address_normalizer_1.addressNormalizer);
    app.get('/', root_handler_1.rootHandler);
    const server = (0, api_utils_1.createDefaultServer)(config, app, logger_1.logger, async () => {
        await connection.close();
    });
    app.use(constants_1.RFQM_PATH, (0, rfqm_router_1.createRfqmRouter)(rfqmServices, configManager));
    app.use(constants_1.RFQT_V1_PATH, (0, RfqtRouter_1.createRfqtV1Router)(rfqtServices, configManager));
    app.use(constants_1.RFQT_V2_PATH, (0, RfqtRouter_1.createRfqtV2Router)(rfqtServices, configManager));
    app.use(constants_1.RFQ_MAKER_PATH, (0, rfq_maker_router_1.createRfqMakerRouter)(rfqMakerService));
    app.use(constants_1.ADMIN_PATH, (0, rfq_admin_router_1.createRfqAdminRouter)(rfqAdminService, configManager));
    if (config_1.SENTRY_DSN) {
        // The error handler must be before any other error middleware and after all controllers
        app.use(Sentry.Handlers.errorHandler({
            // $eslint-fix-me https://github.com/rhinodavid/eslint-fix-me
            // eslint-disable-next-line @typescript-eslint/no-explicit-any
            shouldHandleError(error) {
                if (error.status === undefined || error.status >= HttpStatus.BAD_REQUEST) {
                    return true;
                }
                return false;
            },
        }));
    }
    app.use(error_handling_1.errorHandler);
    server.listen(config.httpPort);
    return { app, server };
}
exports.runHttpRfqmServiceAsync = runHttpRfqmServiceAsync;
//# sourceMappingURL=data:application/json;charset=utf-8;base64,eyJmaWxlIjoiL1VzZXJzL2Rhdmlkd2Fsc2gvY29kZS1sb2NhbC8weC1yZnEtYXBpL3NyYy9ydW5uZXJzL2h0dHBfcmZxbV9zZXJ2aWNlX3J1bm5lci50cyIsIm1hcHBpbmdzIjoiOzs7QUFBQTs7R0FFRztBQUNILDZDQUF1RTtBQUN2RSx1Q0FBdUM7QUFDdkMsMkNBQTJDO0FBQzNDLGlDQUEwQjtBQUMxQixtQ0FBbUM7QUFDbkMsa0RBQWtEO0FBSWxELGdEQUFnRDtBQUNoRCxxQ0FBNEI7QUFHNUIsc0NBVW1CO0FBQ25CLGlEQUFzRztBQUN0RyxrRUFBK0Q7QUFDL0QsMkRBQXVEO0FBQ3ZELHNDQUFtQztBQUNuQyx5RUFBcUU7QUFDckUsaUVBQTREO0FBQzVELHdEQUEwRDtBQUMxRCxzREFBK0U7QUFDL0Usa0VBQW1FO0FBQ25FLGtFQUFtRTtBQUNuRSxxRUFBZ0U7QUFDaEUscUVBQWdFO0FBQ2hFLDREQUF3RDtBQUN4RCwwREFBcUQ7QUFDckQsd0VBQTRHO0FBQzVHLG9FQUFtRjtBQUNuRixvRUFBOEQ7QUFDOUQsd0RBQW1FO0FBQ25FLGdFQUE2RDtBQUU3RCxNQUFNLGNBQWMsR0FBWSxFQUFFLENBQUM7QUFFbkMsT0FBTyxDQUFDLEVBQUUsQ0FBQyxtQkFBbUIsRUFBRSxDQUFDLEdBQUcsRUFBRSxFQUFFO0lBQ3BDLGVBQU0sQ0FBQyxLQUFLLENBQUMsR0FBRyxDQUFDLENBQUM7SUFDbEIsT0FBTyxDQUFDLElBQUksQ0FBQyxDQUFDLENBQUMsQ0FBQztBQUNwQixDQUFDLENBQUMsQ0FBQztBQUVILE9BQU8sQ0FBQyxFQUFFLENBQUMsb0JBQW9CLEVBQUUsQ0FBQyxHQUFHLEVBQUUsRUFBRTtJQUNyQyxJQUFJLEdBQUcsRUFBRTtRQUNMLGVBQU0sQ0FBQyxLQUFLLENBQUMsR0FBWSxDQUFDLENBQUM7S0FDOUI7QUFDTCxDQUFDLENBQUMsQ0FBQztBQUVILE9BQU8sQ0FBQyxFQUFFLENBQUMsU0FBUyxFQUFFLEtBQUssSUFBSSxFQUFFO0lBQzdCLGVBQU0sQ0FBQyxJQUFJLENBQUMsa0RBQWtELENB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d0JBQVksRUFBRSxJQUFBLCtCQUFrQixFQUFDLFlBQVksRUFBRSxhQUFhLENBQUMsQ0FBQyxDQUFDO0lBQ3ZFLEdBQUcsQ0FBQyxHQUFHLENBQUMsMEJBQWMsRUFBRSxJQUFBLHVDQUFvQixFQUFDLGVBQWUsQ0FBQyxDQUFDLENBQUM7SUFDL0QsR0FBRyxDQUFDLEdBQUcsQ0FBQyxzQkFBVSxFQUFFLElBQUEsdUNBQW9CLEVBQUMsZUFBZSxFQUFFLGFBQWEsQ0FBQyxDQUFDLENBQUM7SUFFMUUsSUFBSSxtQkFBVSxFQUFFO1FBQ1osd0ZBQXdGO1FBQ3hGLEdBQUcsQ0FBQyxHQUFHLENBQ0gsTUFBTSxDQUFDLFFBQVEsQ0FBQyxZQUFZLENBQUM7WUFDekIsNkRBQTZEO1lBQzdELDhEQUE4RDtZQUM5RCxpQkFBaUIsQ0FBQyxLQUFVO2dCQUN4QixJQUFJLEtBQUssQ0FBQyxNQUFNLEtBQUssU0FBUyxJQUFJLEtBQUssQ0FBQyxNQUFNLElBQUksVUFBVSxDQUFDLFdBQVcsRUFBRTtvQkFDdEUsT0FBTyxJQUFJLENBQUM7aUJBQ2Y7Z0JBQ0QsT0FBTyxLQUFLLENBQUM7WUFDakIsQ0FBQztTQUNKLENBQUMsQ0FDTCxDQUFDO0tBQ0w7SUFFRCxHQUFHLENBQUMsR0FBRyxDQUFDLDZCQUFZLENBQUMsQ0FBQztJQUV0QixNQUFNLENBQUMsTUFBTSxDQUFDLE1BQU0sQ0FBQyxRQUFRLENBQUMsQ0FBQztJQUMvQixPQUFPLEVBQUUsR0FBRyxFQUFFLE1BQU0sRUFBRSxDQUFDO0FBQzNCLENBQUM7QUEvRkQsMERBK0ZDIiwibmFtZXMiOltdLCJzb3VyY2VzIjpbIi9Vc2Vycy9kYXZpZHdhbHNoL2NvZGUtbG9jYWwvMHgtcmZxLWFwaS9zcmMvcnVubmVycy9odHRwX3JmcW1fc2VydmljZV9ydW5uZXIudHMiXSwic291cmNlc0NvbnRlbnQiOlsiLyoqXHJcbiAqIFRoaXMgbW9kdWxlIGNhbiBiZSB1c2VkIHRvIHJ1biB0aGUgUkZRTSBIVFRQIHNlcnZpY2Ugc3RhbmRhbG9uZVxyXG4gKi9cclxuaW1wb3J0IHsgY3JlYXRlRGVmYXVsdFNlcnZlciwgSHR0cFNlcnZpY2VDb25maWcgfSBmcm9tICdAMHgvYXBpLXV0aWxzJztcclxuaW1wb3J0ICogYXMgU2VudHJ5IGZyb20gJ0BzZW50cnkvbm9kZSc7XHJcbmltcG9ydCAqIGFzIFRyYWNpbmcgZnJvbSAnQHNlbnRyeS90cmFjaW5nJztcclxuaW1wb3J0IEF4aW9zIGZyb20gJ2F4aW9zJztcclxuaW1wb3J0ICogYXMgZXhwcmVzcyBmcm9tICdleHByZXNzJztcclxuaW1wb3J0ICogYXMgcHJvbUJ1bmRsZSBmcm9tICdleHByZXNzLXByb20tYnVuZGxlJztcclxuLy8gdHNsaW50OmRpc2FibGUtbmV4dC1saW5lOm5vLWltcGxpY2l0LWRlcGVuZGVuY2llc1xyXG5pbXBvcnQgKiBhcyBjb3JlIGZyb20gJ2V4cHJlc3Mtc2VydmUtc3RhdGljLWNvcmUnO1xyXG5pbXBvcnQgeyBTZXJ2ZXIgfSBmcm9tICdodHRwJztcclxuaW1wb3J0ICogYXMgSHR0cFN0YXR1cyBmcm9tICdodHRwLXN0YXR1cy1jb2Rlcyc7XHJcbmltcG9ydCBSZWRpcyBmcm9tICdpb3JlZGlzJztcclxuaW1wb3J0IHsgRGF0YVNvdXJjZSB9IGZyb20gJ3R5cGVvcm0nO1xyXG5cclxuaW1wb3J0IHtcclxuICAgIENIQUlOX0NPTkZJR1VSQVRJT05TLFxyXG4gICAgZGVmYXVsdEh0dHBTZXJ2aWNlQ29uZmlnLFxyXG4gICAgREVGSU5FRF9GSV9BUElfS0VZLFxyXG4gICAgREVGSU5FRF9GSV9FTkRQT0lOVCxcclxuICAgIFJFRElTX1VSSSxcclxuICAgIFNFTlRSWV9EU04sXHJcbiAgICBTRU5UUllfRU5WSVJPTk1FTlQsXHJcbiAgICBTRU5UUllfVFJBQ0VTX1NBTVBMRV9SQVRFLFxyXG4gICAgVE9LRU5fUFJJQ0VfT1JBQ0xFX1RJTUVPVVQsXHJcbn0gZnJvbSAnLi4vY29uZmlnJztcclxuaW1wb3J0IHsgQURNSU5fUEFUSCwgUkZRTV9QQVRILCBSRlFUX1YxX1BBVEgsIFJGUVRfVjJfUEFUSCwgUkZRX01BS0VSX1BBVEggfSBmcm9tICcuLi9jb3JlL2NvbnN0YW50cyc7XHJcbmltcG9ydCB7IGdldERiRGF0YVNvdXJjZUFzeW5jIH0gZnJvbSAnLi4vZ2V0RGJEYXRhU291cmNlQXN5bmMnO1xyXG5pbXBvcnQgeyByb290SGFuZGxlciB9IGZyb20gJy4uL2hhbmRsZXJzL3Jvb3RfaGFuZGxlcic7XHJcbmltcG9ydCB7IGxvZ2dlciB9IGZyb20gJy4uL2xvZ2dlcic7XHJcbmltcG9ydCB7IGFkZHJlc3NOb3JtYWxpemVyIH0gZnJvbSAnLi4vbWlkZGxld2FyZS9hZGRyZXNzX25vcm1hbGl6ZXInO1xyXG5pbXBvcnQgeyBlcnJvckhhbmRsZXIgfSBmcm9tICcuLi9taWRkbGV3YXJlL2Vycm9yX2hhbmRsaW5nJztcclxuaW1wb3J0IHsgY3JlYXRlUmZxbVJvdXRlciB9IGZyb20gJy4uL3JvdXRlcnMvcmZxbV9yb3V0ZXInO1xyXG5pbXBvcnQgeyBjcmVhdGVSZnF0VjFSb3V0ZXIsIGNyZWF0ZVJmcXRWMlJvdXRlciB9IGZyb20gJy4uL3JvdXRlcnMvUmZxdFJvdXRlcic7XHJcbmltcG9ydCB7IGNyZWF0ZVJmcUFkbWluUm91dGVyIH0gZnJvbSAnLi4vcm91dGVycy9yZnFfYWRtaW5fcm91dGVyJztcclxuaW1wb3J0IHsgY3JlYXRlUmZxTWFrZXJSb3V0ZXIgfSBmcm9tICcuLi9yb3V0ZXJzL3JmcV9tYWtlcl9yb3V0ZXInO1xyXG5pbXBvcnQgeyBSZnFBZG1pblNlcnZpY2UgfSBmcm9tICcuLi9zZXJ2aWNlcy9yZnFfYWRtaW5fc2VydmljZSc7XHJcbmltcG9ydCB7IFJmcU1ha2VyU2VydmljZSB9IGZyb20gJy4uL3NlcnZpY2VzL3JmcV9tYWtlcl9zZXJ2aWNlJztcclxuaW1wb3J0IHsgQ29uZmlnTWFuYWdlciB9IGZyb20gJy4uL3V0aWxzL2NvbmZpZ19tYW5hZ2VyJztcclxuaW1wb3J0IHsgUmZxbURiVXRpbHMgfSBmcm9tICcuLi91dGlscy9yZnFtX2RiX3V0aWxzJztcclxuaW1wb3J0IHsgYnVpbGRSZnFtU2VydmljZXNBc3luYywgZ2V0QXhpb3NSZXF1ZXN0Q29uZmlnLCBSZnFtU2VydmljZXMgfSBmcm9tICcuLi91dGlscy9yZnFtX3NlcnZpY2VfYnVpbGRlcic7XHJcbmltcG9ydCB7IGJ1aWxkUmZxdFNlcnZpY2VzQXN5bmMsIFJmcXRTZXJ2aWNlcyB9IGZyb20gJy4uL3V0aWxzL3JmcXRTZXJ2aWNlQnVpbGRlcic7XHJcbmltcG9ydCB7IFJmcU1ha2VyRGJVdGlscyB9IGZyb20gJy4uL3V0aWxzL3JmcV9tYWtlcl9kYl91dGlscyc7XHJcbmltcG9ydCB7IGNsb3NlUmVkaXNDb25uZWN0aW9uc0FzeW5jIH0gZnJvbSAnLi4vdXRpbHMvcnVubmVyX3V0aWxzJztcclxuaW1wb3J0IHsgVG9rZW5QcmljZU9yYWNsZSB9IGZyb20gJy4uL3V0aWxzL1Rva2VuUHJpY2VPcmFjbGUnO1xyXG5cclxuY29uc3QgcmVkaXNJbnN0YW5jZXM6IFJlZGlzW10gPSBbXTtcclxuXHJcbnByb2Nlc3Mub24oJ3VuY2F1Z2h0RXhjZXB0aW9uJywgKGVycikgPT4ge1xyXG4gICAgbG9nZ2VyLmVycm9yKGVycik7XHJcbiAgICBwcm9jZXNzLmV4aXQoMSk7XHJcbn0pO1xyXG5cclxucHJvY2Vzcy5vbigndW5oYW5kbGVkUmVqZWN0aW9uJywgKGVycikgPT4ge1xyXG4gICAgaWYgKGVycikge1xyXG4gICAgICAgIGxvZ2dlci5lcnJvcihlcnIgYXMgRXJyb3IpO1xyXG4gICAgfVxyXG59KTtcclxuXHJcbnByb2Nlc3Mub24oJ1NJR1RFUk0nLCBhc3luYyAoKSA9PiB7XHJcbiAgICBsb2dnZXIuaW5mbygnUmVjZWl2ZWQgU0lHVEVSTS4gU3RhcnQgdG8gc2h1dGRvd24gUkZRIHNlcnZpY2VzJyk7XHJcbiAgICBhd2FpdCBjbG9zZVJlZGlzQ29ubmVjdGlvbnNBc3luYyhyZWRpc0luc3RhbmNlcyk7XHJcbiAgICBwcm9jZXNzLmV4aXQoMCk7XHJcbn0pO1xyXG5cclxuLy8gVXNlZCBmb3Igc2h1dHRpbmcgZG93biBsb2NhbGx5XHJcbnByb2Nlc3Mub24oJ1NJR0lOVCcsIGFzeW5jICgpID0+IHtcclxuICAgIGxvZ2dlci5pbmZvKCdSZWNlaXZlZCBTSUdJTlQuIFN0YXJ0IHRvIHNodXRkb3duIFJGUSBzZXJ2aWNlcycpO1xyXG4gICAgYXdhaXQgY2xvc2VSZWRpc0Nvbm5lY3Rpb25zQXN5bmMocmVkaXNJbnN0YW5jZXMpO1xyXG4gICAgcHJvY2Vzcy5leGl0KDApO1xyXG59KTtcclxuXHJcbmlmIChyZXF1aXJlLm1haW4gPT09IG1vZHVsZSkge1xyXG4gICAgKGFzeW5jICgpID0+IHtcclxuICAgICAgICAvLyBCdWlsZCBkZXBlbmRlbmNpZXNcclxuICAgICAgICBjb25zdCBjb25maWc6IEh0dHBTZXJ2aWNlQ29uZmlnID0ge1xyXG4gICAgICAgICAgICAuLi5kZWZhdWx0SHR0cFNlcnZpY2VDb25maWcsXHJcbiAgICAgICAgfTtcclxuICAgICAgICBjb25zdCBjb25uZWN0aW9uID0gYXdhaXQgZ2V0RGJEYXRhU291cmNlQXN5bmMoKTtcclxuICAgICAgICBjb25zdCByZnFtRGJVdGlscyA9IG5ldyBSZnFtRGJVdGlscyhjb25uZWN0aW9uKTtcclxuICAgICAgICBjb25zdCByZnFNYWtlckRiVXRpbHMgPSBuZXcgUmZxTWFrZXJEYlV0aWxzKGNvbm5lY3Rpb24pO1xyXG4gICAgICAgIGNvbnN0IGNvbmZpZ01hbmFnZXIgPSBuZXcgQ29uZmlnTWFuYWdlcigpO1xyXG4gICAgICAgIGNvbnN0IGF4aW9zSW5zdGFuY2UgPSBBeGlvcy5jcmVhdGUoZ2V0QXhpb3NSZXF1ZXN0Q29uZmlnKFRPS0VOX1BSSUNFX09SQUNMRV9USU1FT1VUKSk7XHJcbiAgICAgICAgY29uc3QgdG9rZW5QcmljZU9yYWNsZSA9IG5ldyBUb2tlblByaWNlT3JhY2xlKGF4aW9zSW5zdGFuY2UsIERFRklORURfRklfQVBJX0tFWSwgREVGSU5FRF9GSV9FTkRQT0lOVCk7XHJcblxyXG4gICAgICAgIGlmICghUkVESVNfVVJJKSB7XHJcbiAgICAgICAgICAgIHRocm93IG5ldyBFcnJvcignTm8gcmVkaXMgVVJJIHByb3ZpZGVkIHRvIFJGUSBTZXJ2aWNlJyk7XHJcbiAgICAgICAgfVxyXG4gICAgICAgIGNvbnN0IHJlZGlzID0gbmV3IFJlZGlzKFJFRElTX1VSSSk7XHJcbiAgICAgICAgcmVkaXNJbnN0YW5jZXMucHVzaChyZWRpcyk7XHJcblxyXG4gICAgICAgIGNvbnN0IHJmcW1TZXJ2aWNlcyA9IGF3YWl0IGJ1aWxkUmZxbVNlcnZpY2VzQXN5bmMoXHJcbiAgICAgICAgICAgIC8qIGFzV29ya2VyID0gKi8gZmFsc2UsXHJcbiAgICAgICAgICAgIHJmcW1EYlV0aWxzLFxyXG4gICAgICAgICAgICByZnFNYWtlckRiVXRpbHMsXHJcbiAgICAgICAgICAgIENIQUlOX0NPTkZJR1VSQVRJT05TLFxyXG4gICAgICAgICAgICB0b2tlblByaWNlT3JhY2xlLFxyXG4gICAgICAgICAgICBjb25maWdNYW5hZ2VyLFxyXG4gICAgICAgICAgICByZWRpcyxcclxuICAgICAgICApO1xyXG5cclxuICAgICAgICBjb25zdCByZnF0U2VydmljZXMgPSBhd2FpdCBidWlsZFJmcXRTZXJ2aWNlc0FzeW5jKENIQUlOX0NPTkZJR1VSQVRJT05TLCByZnFNYWtlckRiVXRpbHMsIHJlZGlzKTtcclxuXHJcbiAgICAgICAgY29uc3QgcmZxQWRtaW5TZXJ2aWNlID0gYnVpbGRSZnFBZG1pblNlcnZpY2UocmZxbURiVXRpbHMpO1xyXG4gICAgICAgIGNvbnN0IHJmcU1ha2VyU2VydmljZSA9IGJ1aWxkUmZxTWFrZXJTZXJ2aWNlKHJmcU1ha2VyRGJVdGlscywgY29uZmlnTWFuYWdlcik7XHJcbiAgICAgICAgYXdhaXQgcnVuSHR0cFJmcW1TZXJ2aWNlQXN5bmMoXHJcbiAgICAgICAgICAgIHJmcW1TZXJ2aWNlcyxcclxuICAgICAgICAgICAgcmZxdFNlcnZpY2VzLFxyXG4gICAgICAgICAgICByZnFBZG1pblNlcnZpY2UsXHJcbiAgICAgICAgICAgIHJmcU1ha2VyU2VydmljZSxcclxuICAgICAgICAgICAgY29uZmlnTWFuYWdlcixcclxuICAgICAgICAgICAgY29uZmlnLFxyXG4gICAgICAgICAgICBjb25uZWN0aW9uLFxyXG4gICAgICAgICk7XHJcbiAgICB9KSgpLmNhdGNoKChlcnJvcikgPT4gbG9nZ2VyLmVycm9yKGVycm9yLnN0YWNrKSk7XHJcbn1cclxuXHJcbi8qKlxyXG4gKiBCdWlsZHMgYW4gaW5zdGFuY2Ugb2YgUmZxQWRtaW5TZXJ2aWNlXHJcbiAqL1xyXG5leHBvcnQgZnVuY3Rpb24gYnVpbGRSZnFBZG1pblNlcnZpY2UoZGJVdGlsczogUmZxbURiVXRpbHMpOiBSZnFBZG1pblNlcnZpY2Uge1xyXG4gICAgcmV0dXJuIG5ldyBSZnFBZG1pblNlcnZpY2UoZGJVdGlscyk7XHJcbn1cclxuXHJcbi8qKlxyXG4gKiBCdWlsZHMgYW4gaW5zdGFuY2Ugb2YgUmZxTWFrZXJTZXJ2aWNlXHJcbiAqL1xyXG5leHBvcnQgZnVuY3Rpb24gYnVpbGRSZnFNYWtlclNlcnZpY2UoZGJVdGlsczogUmZxTWFrZXJEYlV0aWxzLCBjb25maWdNYW5hZ2VyOiBDb25maWdNYW5hZ2VyKTogUmZxTWFrZXJTZXJ2aWNlIHtcclxuICAgIHJldHVybiBuZXcgUmZxTWFrZXJTZXJ2aWNlKGRiVXRpbHMsIGNvbmZpZ01hbmFnZXIpO1xyXG59XHJcblxyXG4vKipcclxuICogUnVucyB0aGUgUmZxbSBTZXJ2aWNlIGluIGlzb2xhdGlvblxyXG4gKi9cclxuZXhwb3J0IGFzeW5jIGZ1bmN0aW9uIHJ1bkh0dHBSZnFtU2VydmljZUFzeW5jKFxyXG4gICAgcmZxbVNlcnZpY2VzOiBSZnFtU2VydmljZXMsXHJcbiAgICByZnF0U2VydmljZXM6IFJmcXRTZXJ2aWNlcyxcclxuICAgIHJmcUFkbWluU2VydmljZTogUmZxQWRtaW5TZXJ2aWNlLFxyXG4gICAgcmZxTWFrZXJTZXJ2aWNlOiBSZnFNYWtlclNlcnZpY2UsXHJcbiAgICBjb25maWdNYW5hZ2VyOiBDb25maWdNYW5hZ2VyLFxyXG4gICAgY29uZmlnOiBIdHRwU2VydmljZUNvbmZpZyxcclxuICAgIGNvbm5lY3Rpb246IERhdGFTb3VyY2UsXHJcbiAgICAvLyAkZXNsaW50LWZpeC1tZSBodHRwczovL2dpdGh1Yi5jb20vcmhpbm9kYXZpZC9lc2xpbnQtZml4LW1lXHJcbiAgICAvLyBlc2xpbnQtZGlzYWJsZS1uZXh0LWxpbmUgQHR5cGVzY3JpcHQtZXNsaW50L25vLWluZmVycmFibGUtdHlwZXNcclxuICAgIHVzZU1ldHJpY3NNaWRkbGV3YXJlOiBib29sZWFuID0gdHJ1ZSxcclxuICAgIF9hcHA/OiBjb3JlLkV4cHJlc3MsXHJcbik6IFByb21pc2U8eyBhcHA6IGV4cHJlc3MuQXBwbGljYXRpb247IHNlcnZlcjogU2VydmVyIH0+IHtcclxuICAgIGNvbnN0IGFwcCA9IF9hcHAgfHwgZXhwcmVzcygpO1xyXG5cclxuICAgIGlmIChTRU5UUllfRFNOKSB7XHJcbiAgICAgICAgU2VudHJ5LmluaXQoe1xyXG4gICAgICAgICAgICBkc246IFNFTlRSWV9EU04sXHJcbiAgICAgICAgICAgIGludGVncmF0aW9uczogW1xyXG4gICAgICAgICAgICAgICAgLy8gZW5hYmxlIEhUVFAgY2FsbHMgdHJhY2luZ1xyXG4gICAgICAgICAgICAgICAgbmV3IFNlbnRyeS5JbnRlZ3JhdGlvbnMuSHR0cCh7IHRyYWNpbmc6IHRydWUgfSksXHJcbiAgICAgICAgICAgICAgICAvLyBlbmFibGUgRXhwcmVzcy5qcyBtaWRkbGV3YXJlIHRyYWNpbmdcclxuICAgICAgICAgICAgICAgIG5ldyBUcmFjaW5nLkludGVncmF0aW9ucy5FeHByZXNzKHsgYXBwIH0pLFxyXG4gICAgICAgICAgICBdLFxyXG4gICAgICAgICAgICBlbnZpcm9ubWVudDogU0VOVFJZX0VOVklST05NRU5ULFxyXG5cclxuICAgICAgICAgICAgLy8gU2V0IHRyYWNlc1NhbXBsZVJhdGUgdG8gMS4wIHRvIGNhcHR1cmUgMTAwJVxyXG4gICAgICAgICAgICAvLyBvZiB0cmFuc2FjdGlvbnMgZm9yIHBlcmZvcm1hbmNlIG1vbml0b3JpbmcuXHJcbiAgICAgICAgICAgIC8vIFdlIHJlY29tbWVuZCBhZGp1c3RpbmcgdGhpcyB2YWx1ZSBpbiBwcm9kdWN0aW9uXHJcbiAgICAgICAgICAgIHRyYWNlc1NhbXBsZVJhdGU6IFNFTlRSWV9UUkFDRVNfU0FNUExFX1JBVEUsXHJcbiAgICAgICAgfSk7XHJcblxyXG4gICAgICAgIC8vIFJlcXVlc3RIYW5kbGVyIGNyZWF0ZXMgYSBzZXBhcmF0ZSBleGVjdXRpb24gY29udGV4dCB1c2luZyBkb21haW5zLCBzbyB0aGF0IGV2ZXJ5XHJcbiAgICAgICAgLy8gdHJhbnNhY3Rpb24vc3Bhbi9icmVhZGNydW1iIGlzIGF0dGFjaGVkIHRvIGl0cyBvd24gSHViIGluc3RhbmNlXHJcbiAgICAgICAgYXBwLnVzZShTZW50cnkuSGFuZGxlcnMucmVxdWVzdEhhbmRsZXIoKSk7XHJcbiAgICAgICAgLy8gVHJhY2luZ0hhbmRsZXIgY3JlYXRlcyBhIHRyYWNlIGZvciBldmVyeSBpbmNvbWluZyByZXF1ZXN0XHJcbiAgICAgICAgYXBwLnVzZShTZW50cnkuSGFuZGxlcnMudHJhY2luZ0hhbmRsZXIoKSk7XHJcbiAgICB9XHJcblxyXG4gICAgaWYgKHVzZU1ldHJpY3NNaWRkbGV3YXJlKSB7XHJcbiAgICAgICAgLyoqXHJcbiAgICAgICAgICogZXhwcmVzcy1wcm9tLWJ1bmRsZSB3aWxsIGNyZWF0ZSBhIGhpc3RvZ3JhbSBtZXRyaWMgY2FsbGVkIFwiaHR0cF9yZXF1ZXN0X2R1cmF0aW9uX3NlY29uZHNcIlxyXG4gICAgICAgICAqIFRoZSBvZmZpY2lhbCBwcm9tZXRoZXVzIGRvY3MgZGVzY3JpYmUgaG93IHRvIHVzZSB0aGlzIGV4YWN0IGhpc3RvZ3JhbSBtZXRyaWM6IGh0dHBzOi8vcHJvbWV0aGV1cy5pby9kb2NzL3ByYWN0aWNlcy9oaXN0b2dyYW1zL1xyXG4gICAgICAgICAqIFdlIHVzZSB0aGUgZm9sbG93aW5nIGxhYmVsczogc3RhdHVzQ29kZSwgcGF0aFxyXG4gICAgICAgICAqL1xyXG4gICAgICAgIGNvbnN0IG1ldHJpY3NNaWRkbGV3YXJlID0gcHJvbUJ1bmRsZSh7XHJcbiAgICAgICAgICAgIGF1dG9yZWdpc3RlcjogZmFsc2UsXHJcbiAgICAgICAgICAgIGluY2x1ZGVTdGF0dXNDb2RlOiB0cnVlLFxyXG4gICAgICAgICAgICBpbmNsdWRlUGF0aDogdHJ1ZSxcclxuICAgICAgICAgICAgY3VzdG9tTGFiZWxzOiB7IGNoYWluSWQ6IHVuZGVmaW5lZCB9LFxyXG4gICAgICAgICAgICBub3JtYWxpemVQYXRoOiBbXHJcbiAgICAgICAgICAgICAgICBbJy9zdGF0dXMvLionLCAnL3N0YXR1cy8jb3JkZXJIYXNoJ10sIC8vIGNvbnZlcnRzIGFsbCAvc3RhdHVzLzB4ZGVhZGJlZWYuLi4gPT4gL3N0YXR1cy8jb3JkZXJIYXNoXHJcbiAgICAgICAgICAgICAgICBbJy9hcGktZG9jcy4qJywgJy9hcGktZG9jcyddLCAvLyBjb252ZXJ0cyBhbGwgL2FwaS1kb2NzL2Zhdmljb24uLi4gPT4gL2FwaS1kb2NzXHJcbiAgICAgICAgICAgIF0sXHJcbiAgICAgICAgICAgIHRyYW5zZm9ybUxhYmVsczogKGxhYmVscywgcmVxLCBfcmVzKSA9PiB7XHJcbiAgICAgICAgICAgICAgICBPYmplY3QuYXNzaWduKGxhYmVscywgeyBjaGFpbklkOiByZXEuaGVhZGVyKCcweC1jaGFpbi1pZCcpIHx8IDEgfSk7XHJcbiAgICAgICAgICAgIH0sXHJcbiAgICAgICAgICAgIC8vIGJ1Y2tldHMgdXNlZCBmb3IgdGhlIGh0dHBfcmVxdWVzdF9kdXJhdGlvbl9zZWNvbmRzIGhpc3RvZ3JhbS4gQWxsIG51bWJlcnMgKGluIHNlY29uZHMpIHJlcHJlc2VudHMgYm91bmRhcmllcyBvZiBidWNrZXRzLlxyXG4gICAgICAgICAgICAvLyB0c2xpbnQ6ZGlzYWJsZS1uZXh0LWxpbmU6IGN1c3RvbS1uby1tYWdpYy1udW1iZXJzXHJcbiAgICAgICAgICAgIGJ1Y2tldHM6IFswLjAxLCAwLjA0LCAwLjEsIDAuMywgMC42LCAxLCAxLjUsIDIsIDIuNSwgMywgNCwgNiwgOV0sXHJcbiAgICAgICAgfSk7XHJcbiAgICAgICAgYXBwLnVzZShtZXRyaWNzTWlkZGxld2FyZSk7XHJcbiAgICB9XHJcbiAgICBhcHAudXNlKGFkZHJlc3NOb3JtYWxpemVyKTtcclxuICAgIGFwcC5nZXQoJy8nLCByb290SGFuZGxlcik7XHJcbiAgICBjb25zdCBzZXJ2ZXIgPSBjcmVhdGVEZWZhdWx0U2VydmVyKGNvbmZpZywgYXBwLCBsb2dnZXIsIGFzeW5jICgpID0+IHtcclxuICAgICAgICBhd2FpdCBjb25uZWN0aW9uLmNsb3NlKCk7XHJcbiAgICB9KTtcclxuXHJcbiAgICBhcHAudXNlKFJGUU1fUEFUSCwgY3JlYXRlUmZxbVJvdXRlcihyZnFtU2VydmljZXMsIGNvbmZpZ01hbmFnZXIpKTtcclxuICAgIGFwcC51c2UoUkZRVF9WMV9QQVRILCBjcmVhdGVSZnF0VjFSb3V0ZXIocmZxdFNlcnZpY2VzLCBjb25maWdNYW5hZ2VyKSk7XHJcbiAgICBhcHAudXNlKFJGUVRfVjJfUEFUSCwgY3JlYXRlUmZxdFYyUm91dGVyKHJmcXRTZXJ2aWNlcywgY29uZmlnTWFuYWdlcikpO1xyXG4gICAgYXBwLnVzZShSRlFfTUFLRVJfUEFUSCwgY3JlYXRlUmZxTWFrZXJSb3V0ZXIocmZxTWFrZXJTZXJ2aWNlKSk7XHJcbiAgICBhcHAudXNlKEFETUlOX1BBVEgsIGNyZWF0ZVJmcUFkbWluUm91dGVyKHJmcUFkbWluU2VydmljZSwgY29uZmlnTWFuYWdlcikpO1xyXG5cclxuICAgIGlmIChTRU5UUllfRFNOKSB7XHJcbiAgICAgICAgLy8gVGhlIGVycm9yIGhhbmRsZXIgbXVzdCBiZSBiZWZvcmUgYW55IG90aGVyIGVycm9yIG1pZGRsZXdhcmUgYW5kIGFmdGVyIGFsbCBjb250cm9sbGVyc1xyXG4gICAgICAgIGFwcC51c2UoXHJcbiAgICAgICAgICAgIFNlbnRyeS5IYW5kbGVycy5lcnJvckhhbmRsZXIoe1xyXG4gICAgICAgICAgICAgICAgLy8gJGVzbGludC1maXgtbWUgaHR0cHM6Ly9naXRodWIuY29tL3JoaW5vZGF2aWQvZXNsaW50LWZpeC1tZVxyXG4gICAgICAgICAgICAgICAgLy8gZXNsaW50LWRpc2FibGUtbmV4dC1saW5lIEB0eXBlc2NyaXB0LWVzbGludC9uby1leHBsaWNpdC1hbnlcclxuICAgICAgICAgICAgICAgIHNob3VsZEhhbmRsZUVycm9yKGVycm9yOiBhbnkpOiBib29sZWFuIHtcclxuICAgICAgICAgICAgICAgICAgICBpZiAoZXJyb3Iuc3RhdHVzID09PSB1bmRlZmluZWQgfHwgZXJyb3Iuc3RhdHVzID49IEh0dHBTdGF0dXMuQkFEX1JFUVVFU1QpIHtcclxuICAgICAgICAgICAgICAgICAgICAgICAgcmV0dXJuIHRydWU7XHJcbiAgICAgICAgICAgICAgICAgICAgfVxyXG4gICAgICAgICAgICAgICAgICAgIHJldHVybiBmYWxzZTtcclxuICAgICAgICAgICAgICAgIH0sXHJcbiAgICAgICAgICAgIH0pLFxyXG4gICAgICAgICk7XHJcbiAgICB9XHJcblxyXG4gICAgYXBwLnVzZShlcnJvckhhbmRsZXIpO1xyXG5cclxuICAgIHNlcnZlci5saXN0ZW4oY29uZmlnLmh0dHBQb3J0KTtcclxuICAgIHJldHVybiB7IGFwcCwgc2VydmVyIH07XHJcbn1cclxuIl0sInZlcnNpb24iOjN9