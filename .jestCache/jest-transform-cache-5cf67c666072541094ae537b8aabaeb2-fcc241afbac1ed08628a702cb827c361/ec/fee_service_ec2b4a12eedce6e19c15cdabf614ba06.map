{"file":"/Users/davidwalsh/code-local/0x-rfq-api/src/services/fee_service.ts","mappings":"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","names":[],"sources":["/Users/davidwalsh/code-local/0x-rfq-api/src/services/fee_service.ts"],"sourcesContent":["// tslint:disable:max-file-line-count\r\nimport { TokenMetadata } from '@0x/token-metadata';\r\nimport { BigNumber } from '@0x/utils';\r\n\r\nimport { BPS_TO_RATIO, ZERO } from '../core/constants';\r\nimport {\r\n    ConversionRates,\r\n    DefaultFeeDetailsDeprecated,\r\n    Fee,\r\n    FeeBreakdown,\r\n    FeeWithDetails,\r\n    GasOnlyFeeDetailsDeprecated,\r\n    IndicativeQuote,\r\n    MarginBasedFeeDetailsDeprecated,\r\n} from '../core/types';\r\nimport { ConfigManager } from '../utils/config_manager';\r\nimport { GasStationAttendant } from '../utils/GasStationAttendant';\r\nimport { getBestQuote } from '../utils/quote_comparison_utils';\r\nimport { calculateGasEstimate } from '../utils/rfqm_gas_estimate_utils';\r\nimport { TokenPriceOracle } from '../utils/TokenPriceOracle';\r\nimport { AmmQuote, ZeroExApiClient } from '../utils/ZeroExApiClient';\r\n\r\nimport { QuoteContext } from './types';\r\n\r\n/**\r\n * Interface for the response of CalculateFeeAsync() method. Including `feeWithDetails` object, and two optional fields for fee model v2:\r\n * `quotesWithGasFee` are the original quotes returned by MM when queried with gas fee, and `ammQuoteUniqueId` is the unique\r\n * id (`decodedUniqueId`) of quote report generated by /swap API as it get called by RFQm fee servie.\r\n */\r\ninterface CalculateFeeResponse {\r\n    feeWithDetails: FeeWithDetails;\r\n    quotesWithGasFee?: IndicativeQuote[];\r\n    ammQuoteUniqueId?: string;\r\n}\r\n\r\n/**\r\n * Pure function to calculate the amount of `default` fee, based on trade size and flat rate in `tradeSizeBps`. Trade size is denominated\r\n * in `tradeToken` (either `makerToken` or `takerToken`), which is selected by the caller.\r\n *\r\n * @param tradeTokenAmount amount of trade token (in base unit) in the trade.\r\n * @param feeRateBps flat fee rate represented by number of base points.\r\n * @param tradeTokenBaseUnitPriceUsd USD price of 1 base unit of trade token.\r\n * @returns `default` fee amount in fee token base unit.\r\n */\r\nexport const calculateDefaultFeeAmount = (\r\n    tradeTokenAmount: BigNumber,\r\n    feeRateBps: number,\r\n    tradeTokenBaseUnitPriceUsd: BigNumber | null,\r\n    feeTokenBaseUnitPriceUsd: BigNumber | null,\r\n): BigNumber => {\r\n    if (feeRateBps > 0 && tradeTokenBaseUnitPriceUsd !== null && feeTokenBaseUnitPriceUsd !== null) {\r\n        return tradeTokenAmount\r\n            .times(feeRateBps * BPS_TO_RATIO)\r\n            .times(tradeTokenBaseUnitPriceUsd)\r\n            .div(feeTokenBaseUnitPriceUsd)\r\n            .integerValue();\r\n    }\r\n\r\n    return ZERO;\r\n};\r\n\r\n/**\r\n * Pure function to calculate the price improvement based on given MM quote and AMM quote.\r\n *\r\n * @param makerQuoteWithGasFee maker quote with gas fee taken into account.\r\n * @param ammQuote Amm quote from 0x-api, with only AMM liquidity sources considered.\r\n * @param isSelling whether taker is selling. If true taker specifies `takerAmount` which should be fixed across quotes,\r\n * and `quoteToken` is `makerToken`. Otherwise taker specifies `makerAmount` and `quoteToken` is `takerToken`.\r\n * @param quoteTokenBaseUnitPriceUsd USD price of 1 base unit of quote token.\r\n * @param feeTokenBaseUnitPriceUsd USD price of 1 base unit of fee token.\r\n * @returns price improvement of MM quote comparing with AMM quote, in base unit of fee token.\r\n */\r\nexport const calculatePriceImprovementAmount = (\r\n    makerQuoteWithGasFee: IndicativeQuote,\r\n    ammQuote: AmmQuote,\r\n    isSelling: boolean,\r\n    quoteTokenBaseUnitPriceUsd: BigNumber,\r\n    feeTokenBaseUnitPriceUsd: BigNumber,\r\n): BigNumber => {\r\n    if (isSelling) {\r\n        const makerTokenBaseUnitPriceUsd = quoteTokenBaseUnitPriceUsd;\r\n        const rfqPrice = makerQuoteWithGasFee.makerAmount\r\n            .times(makerTokenBaseUnitPriceUsd)\r\n            .div(feeTokenBaseUnitPriceUsd);\r\n        const ammPrice = ammQuote.makerAmount\r\n            .times(new BigNumber(1).plus(ammQuote.expectedSlippage))\r\n            .times(makerTokenBaseUnitPriceUsd)\r\n            .div(feeTokenBaseUnitPriceUsd)\r\n            .minus(ammQuote.estimatedGasFeeWei);\r\n        if (rfqPrice.gt(ammPrice)) {\r\n            return rfqPrice.minus(ammPrice).integerValue();\r\n        }\r\n    } else {\r\n        const takerTokenBaseUnitPriceUsd = quoteTokenBaseUnitPriceUsd;\r\n        const rfqPrice = makerQuoteWithGasFee.takerAmount\r\n            .times(takerTokenBaseUnitPriceUsd)\r\n            .div(feeTokenBaseUnitPriceUsd);\r\n        const ammPrice = ammQuote.takerAmount\r\n            .times(new BigNumber(1).minus(ammQuote.expectedSlippage))\r\n            .times(takerTokenBaseUnitPriceUsd)\r\n            .div(feeTokenBaseUnitPriceUsd)\r\n            .plus(ammQuote.estimatedGasFeeWei);\r\n        if (ammPrice.gt(rfqPrice)) {\r\n            return ammPrice.minus(rfqPrice).integerValue();\r\n        }\r\n    }\r\n    return ZERO;\r\n};\r\n\r\n/**\r\n * Pure function to revise a maker's quote with fees. This allows us to approximate what the maker's actual quote will be when we\r\n * ask them to include fees. Useful for reducing load to MM servers.\r\n *\r\n * @param quote the raw quote from a maker. For RFQm the raw quote already include gas fee.\r\n * @param fees fees to incorporate into the quote. For RFQm this will be the amount other than gas fee.\r\n * @param isSelling whether taker is selling. If true taker specifies `takerAmount` which should be fixed across quotes,\r\n * and `quoteToken` is `makerToken`. Otherwise taker specifies `makerAmount` and `quoteToken` is `takerToken`.\r\n * @param quoteTokenBaseUnitPriceUsd USD price of 1 base unit of quote token.\r\n * @param feeTokenBaseUnitPriceUsd USD price of 1 base unit of fee token.\r\n * @returns revised quote with fees taken into account.\r\n */\r\nexport const reviseQuoteWithFees = (\r\n    quote: IndicativeQuote,\r\n    fees: BigNumber,\r\n    isSelling: boolean,\r\n    quoteTokenBaseUnitPriceUsd: BigNumber,\r\n    feeTokenBaseUnitPriceUsd: BigNumber,\r\n): IndicativeQuote => {\r\n    let { makerAmount, takerAmount } = quote;\r\n    if (isSelling) {\r\n        const makerTokenBaseUnitPriceUsd = quoteTokenBaseUnitPriceUsd;\r\n        makerAmount = makerAmount\r\n            .minus(fees.times(feeTokenBaseUnitPriceUsd).div(makerTokenBaseUnitPriceUsd))\r\n            .integerValue();\r\n    } else {\r\n        const takerTokenBaseUnitPriceUsd = quoteTokenBaseUnitPriceUsd;\r\n        takerAmount = takerAmount\r\n            .plus(fees.times(feeTokenBaseUnitPriceUsd).div(takerTokenBaseUnitPriceUsd))\r\n            .integerValue();\r\n    }\r\n\r\n    return { ...quote, makerAmount, takerAmount };\r\n};\r\n\r\n/**\r\n * FeeService is used by RfqmService to calculate RFQm Fees of all versions (0, 1 and 2).\r\n */\r\nexport class FeeService {\r\n    constructor(\r\n        private readonly _chainId: number,\r\n        private readonly _feeTokenMetadata: TokenMetadata,\r\n        private readonly _configManager: ConfigManager,\r\n        private readonly _gasStationAttendant: GasStationAttendant,\r\n        private readonly _tokenPriceOracle: TokenPriceOracle,\r\n        private readonly _zeroExApiClient: ZeroExApiClient,\r\n        private readonly _minExpiryDurationMs: number,\r\n    ) {}\r\n\r\n    /**\r\n     * Retrieve estimated gas price from the gas station.\r\n     *\r\n     * @returns estimated gas price\r\n     */\r\n    public async getGasPriceEstimationAsync(): Promise<BigNumber> {\r\n        const gasPriceEstimate = await this._gasStationAttendant.getExpectedTransactionGasRateAsync();\r\n        return gasPriceEstimate;\r\n    }\r\n\r\n    /**\r\n     * Calculate Fee for given quote context.\r\n     *\r\n     * @returns estimated fee with details\r\n     */\r\n    public async calculateFeeAsync(\r\n        quoteContext: QuoteContext,\r\n        fetchMmQuotesAsync?: (quoteContext: QuoteContext, fee: Fee) => Promise<IndicativeQuote[]>,\r\n    ): Promise<CalculateFeeResponse> {\r\n        const { feeModelVersion } = quoteContext;\r\n\r\n        switch (feeModelVersion) {\r\n            case 2:\r\n                return this._calculateFeeV2Async(quoteContext, fetchMmQuotesAsync);\r\n            case 1:\r\n                return {\r\n                    feeWithDetails: await this._calculateFeeV1Async(quoteContext),\r\n                };\r\n            case 0:\r\n            default:\r\n                return {\r\n                    feeWithDetails: await this._calculateGasFeeAsync({ ...quoteContext, feeModelVersion: 0 }),\r\n                };\r\n        }\r\n    }\r\n    /**\r\n     * Revise original maker quotes with fees. This allows us to approximate what the maker's actual quote will be when we ask them\r\n     * to include fees. Useful for reducing load to MM servers.\r\n     * @param quotes the raw quotes from the makers. For RFQm the raw quote already include gas fee.\r\n     * @param fees fees to incorporate into the quote - amount in base unit of fee token. For RFQm this will be the amount other than\r\n     * gas fee.\r\n     * @param quoteContext context of quote request.\r\n     * @returns revised quotes.\r\n     */\r\n    public async reviseQuotesAsync(\r\n        quotes: IndicativeQuote[],\r\n        fees: BigNumber,\r\n        quoteContext: QuoteContext,\r\n    ): Promise<IndicativeQuote[]> {\r\n        if (fees.eq(ZERO)) {\r\n            return quotes;\r\n        }\r\n\r\n        const { isSelling, makerToken, takerToken, makerTokenDecimals, takerTokenDecimals } = quoteContext;\r\n\r\n        // `quoteToken` is one of `makerToken` and `takerToken` whose amount is specified by makers in the quotes.\r\n        const quoteToken = isSelling ? makerToken : takerToken;\r\n        const quoteTokenDecimal = isSelling ? makerTokenDecimals : takerTokenDecimals;\r\n\r\n        const { feeTokenBaseUnitPriceUsd, tradeTokenBaseUnitPriceUsd: quoteTokenBaseUnitPriceUsd } =\r\n            await this._fetchTokenPricesAsync(quoteToken, quoteTokenDecimal);\r\n\r\n        if (feeTokenBaseUnitPriceUsd === null || quoteTokenBaseUnitPriceUsd === null) {\r\n            return quotes;\r\n        }\r\n\r\n        return quotes.map((quote) =>\r\n            // $eslint-fix-me https://github.com/rhinodavid/eslint-fix-me\r\n            // eslint-disable-next-line @typescript-eslint/no-non-null-assertion\r\n            reviseQuoteWithFees(quote, fees, isSelling, quoteTokenBaseUnitPriceUsd!, feeTokenBaseUnitPriceUsd!),\r\n        );\r\n    }\r\n\r\n    /**\r\n     * Calculate gas fee for all fee model versions, based on gas price query and gas estimation.\r\n     *\r\n     * @returns estimated gas fee with `gasOnly` details\r\n     */\r\n    private async _calculateGasFeeAsync(\r\n        quoteContext: QuoteContext,\r\n    ): Promise<FeeWithDetails & { details: GasOnlyFeeDetailsDeprecated }> {\r\n        const { workflow, takerToken, makerToken, isUnwrap, feeModelVersion } = quoteContext;\r\n\r\n        if (workflow === 'rfqt') {\r\n            const gasPrice = new BigNumber(0);\r\n            const gasFeeAmount = new BigNumber(0);\r\n            return {\r\n                amount: gasFeeAmount,\r\n                token: this._feeTokenMetadata.tokenAddress,\r\n                type: 'fixed',\r\n                details: {\r\n                    kind: 'gasOnly',\r\n                    feeModelVersion,\r\n                    gasFeeAmount,\r\n                    gasPrice,\r\n                },\r\n                breakdown: {},\r\n                conversionRates: {\r\n                    nativeTokenBaseUnitPriceUsd: null,\r\n                    feeTokenBaseUnitPriceUsd: null,\r\n                    takerTokenBaseUnitPriceUsd: null,\r\n                    makerTokenBaseUnitPriceUsd: null,\r\n                },\r\n            };\r\n        }\r\n\r\n        const gasPrice: BigNumber = await this.getGasPriceEstimationAsync();\r\n        const gasEstimate = calculateGasEstimate(makerToken, takerToken, 'otc', isUnwrap);\r\n        const gasFeeAmount = gasPrice.times(gasEstimate);\r\n\r\n        return {\r\n            amount: gasFeeAmount,\r\n            token: this._feeTokenMetadata.tokenAddress,\r\n            type: 'fixed',\r\n            details: {\r\n                kind: 'gasOnly',\r\n                feeModelVersion,\r\n                gasFeeAmount,\r\n                gasPrice,\r\n            },\r\n            breakdown: {\r\n                gas: {\r\n                    amount: gasFeeAmount,\r\n                    details: {\r\n                        gasPrice,\r\n                        estimatedGas: new BigNumber(gasEstimate),\r\n                    },\r\n                },\r\n            },\r\n            conversionRates: {\r\n                nativeTokenBaseUnitPriceUsd: null,\r\n                feeTokenBaseUnitPriceUsd: null,\r\n                takerTokenBaseUnitPriceUsd: null,\r\n                makerTokenBaseUnitPriceUsd: null,\r\n            },\r\n        };\r\n    }\r\n\r\n    /**\r\n     * Calculate fee with fee model v1, including gas fee and and zeroExFee. If token prices query\r\n     * is successful, zeroExFee will be based on trade size and `tradeSizeBps`. If not, `gasOnly` fee\r\n     * will be returned.\r\n     *\r\n     * @returns fee with `default` | `gasOnly` details\r\n     */\r\n    private async _calculateFeeV1Async(\r\n        quoteContext: QuoteContext,\r\n    ): Promise<FeeWithDetails & { details: DefaultFeeDetailsDeprecated | GasOnlyFeeDetailsDeprecated }> {\r\n        const {\r\n            workflow,\r\n            takerToken,\r\n            makerToken,\r\n            takerAmount,\r\n            makerAmount,\r\n            takerTokenDecimals,\r\n            makerTokenDecimals,\r\n            isSelling,\r\n            feeModelVersion,\r\n        } = quoteContext;\r\n\r\n        const { tradeSizeBps } = this._configManager.getFeeModelConfiguration(this._chainId, makerToken, takerToken);\r\n\r\n        // Select trade token so that `tradeTokenAmount` is known from quote request\r\n        const tradeToken = isSelling ? takerToken : makerToken;\r\n        const tradeTokenDecimals = isSelling ? takerTokenDecimals : makerTokenDecimals;\r\n        const tradeTokenAmount = isSelling ? takerAmount : makerAmount;\r\n\r\n        const [gasFee, { feeTokenBaseUnitPriceUsd, tradeTokenBaseUnitPriceUsd }] = await Promise.all([\r\n            this._calculateGasFeeAsync(quoteContext),\r\n            tradeSizeBps > 0\r\n                ? this._fetchTokenPricesAsync(tradeToken, tradeTokenDecimals)\r\n                : { tradeTokenBaseUnitPriceUsd: null, feeTokenBaseUnitPriceUsd: null },\r\n        ]);\r\n\r\n        const wasUnableToFetchTokenPrices: boolean =\r\n            tradeSizeBps > 0 && (feeTokenBaseUnitPriceUsd === null || tradeTokenBaseUnitPriceUsd === null);\r\n\r\n        if (wasUnableToFetchTokenPrices) {\r\n            return gasFee;\r\n        }\r\n\r\n        const zeroExFeeAmount =\r\n            tradeSizeBps > 0\r\n                ? calculateDefaultFeeAmount(\r\n                      // $eslint-fix-me https://github.com/rhinodavid/eslint-fix-me\r\n                      // eslint-disable-next-line @typescript-eslint/no-non-null-assertion\r\n                      tradeTokenAmount!,\r\n                      tradeSizeBps,\r\n                      tradeTokenBaseUnitPriceUsd,\r\n                      feeTokenBaseUnitPriceUsd,\r\n                  )\r\n                : ZERO;\r\n        return {\r\n            type: 'fixed',\r\n            token: this._feeTokenMetadata.tokenAddress,\r\n            amount: gasFee.amount.plus(zeroExFeeAmount),\r\n            details: {\r\n                kind: 'default',\r\n                feeModelVersion,\r\n                gasFeeAmount: gasFee.amount,\r\n                gasPrice: gasFee.details.gasPrice,\r\n                zeroExFeeAmount,\r\n                tradeSizeBps,\r\n                feeTokenBaseUnitPriceUsd,\r\n                takerTokenBaseUnitPriceUsd: isSelling ? tradeTokenBaseUnitPriceUsd : null,\r\n                makerTokenBaseUnitPriceUsd: isSelling ? null : tradeTokenBaseUnitPriceUsd,\r\n            },\r\n            breakdown: {\r\n                // RFQ will not charge gas fee for RFQt as taker will pay it\r\n                gas: workflow === 'rfqt' ? undefined : gasFee.breakdown.gas,\r\n                zeroEx: {\r\n                    amount: zeroExFeeAmount,\r\n                    details: {\r\n                        kind: 'volume',\r\n                        tradeSizeBps,\r\n                    },\r\n                },\r\n            },\r\n            conversionRates: {\r\n                nativeTokenBaseUnitPriceUsd: feeTokenBaseUnitPriceUsd,\r\n                feeTokenBaseUnitPriceUsd,\r\n                takerTokenBaseUnitPriceUsd: isSelling ? tradeTokenBaseUnitPriceUsd : null,\r\n                makerTokenBaseUnitPriceUsd: isSelling ? null : tradeTokenBaseUnitPriceUsd,\r\n            },\r\n        };\r\n    }\r\n\r\n    /**\r\n     * Calculate fee with fee model v2, including gas fee and zeroExFee. If price improvement detection\r\n     * is successful, zeroExFee will be based on price improvement. If not:\r\n     *     * Fall back to `default` fee if maker query and token prices query are both successful.\r\n     *     * Fall back to `gasOnly` fee if either maker query and token prices query failed.\r\n     *\r\n     * @returns fee with `margin` (price improvement) | `default` | `gasOnly` details (legacy fee breakdown)\r\n     * and a breakdown including gas fee and zeroEx fee details.\r\n     */\r\n    private async _calculateFeeV2Async(\r\n        quoteContext: QuoteContext,\r\n        fetchMmQuotesAsync?: (quoteContext: QuoteContext, fee: Fee) => Promise<IndicativeQuote[]>,\r\n    ): Promise<CalculateFeeResponse> {\r\n        const {\r\n            workflow,\r\n            takerToken,\r\n            makerToken,\r\n            takerTokenDecimals,\r\n            makerTokenDecimals,\r\n            isSelling,\r\n            assetFillAmount,\r\n            feeModelVersion,\r\n        } = quoteContext;\r\n\r\n        if (workflow === 'rfqt') {\r\n            throw new Error(`Not implemented: price improvement based fee model for RFQt has not been implemented!`);\r\n        }\r\n\r\n        const { marginRakeRatio: rakeRatio, tradeSizeBps } = this._configManager.getFeeModelConfiguration(\r\n            this._chainId,\r\n            makerToken,\r\n            takerToken,\r\n        );\r\n\r\n        // `quoteToken` is one of `makerToken` and `takerToken` whose amount is specified by makers in the quotes.\r\n        const quoteToken = isSelling ? makerToken : takerToken;\r\n        const quoteTokenDecimal = isSelling ? makerTokenDecimals : takerTokenDecimals;\r\n\r\n        /**\r\n         * Send all queries in parallel. Bypass AMM query and token price query if rakeRatio > 0.\r\n         */\r\n        const [\r\n            { gasFee, quotes: quotesWithGasFee },\r\n            ammQuote,\r\n            { feeTokenBaseUnitPriceUsd, tradeTokenBaseUnitPriceUsd: quoteTokenBaseUnitPriceUsd },\r\n        ] = await Promise.all([\r\n            this._fetchGasFeeAndIndicativeQuotesAsync(quoteContext, fetchMmQuotesAsync),\r\n            rakeRatio > 0 ? this._zeroExApiClient.fetchAmmQuoteAsync(quoteContext) : null,\r\n            rakeRatio > 0\r\n                ? this._fetchTokenPricesAsync(quoteToken, quoteTokenDecimal)\r\n                : { feeTokenBaseUnitPriceUsd: null, tradeTokenBaseUnitPriceUsd: null },\r\n        ]);\r\n\r\n        const ammQuoteUniqueId = ammQuote?.decodedUniqueId;\r\n\r\n        // Get the best quote\r\n        const bestMakerQuoteWithGasFee = getBestQuote(\r\n            quotesWithGasFee,\r\n            isSelling,\r\n            takerToken,\r\n            makerToken,\r\n            assetFillAmount,\r\n            this._minExpiryDurationMs,\r\n        );\r\n\r\n        const wasUnableToFetchMakerQuote: boolean = bestMakerQuoteWithGasFee === null;\r\n        const wasUnableToFetchTokenPrices: boolean =\r\n            rakeRatio > 0 && (feeTokenBaseUnitPriceUsd === null || quoteTokenBaseUnitPriceUsd === null);\r\n        const wasUnableToFetchAmmQuote: boolean = rakeRatio > 0 && ammQuote === null;\r\n\r\n        let zeroExFeeAmount: BigNumber;\r\n        let feeWithDetails: FeeWithDetails;\r\n\r\n        if (wasUnableToFetchMakerQuote || wasUnableToFetchTokenPrices) {\r\n            /**\r\n             * If maker query or token prices query failed: fallback to `gasOnly` fee.\r\n             */\r\n            zeroExFeeAmount = ZERO;\r\n            feeWithDetails = gasFee;\r\n        } else if (wasUnableToFetchAmmQuote) {\r\n            /**\r\n             * If maker query and token price query are successful, but AMM query failed,\r\n             * fall back to `default` fee calculated with `tradeSizeBps`.\r\n             */\r\n            const quoteTokenAmount = isSelling\r\n                ? // $eslint-fix-me https://github.com/rhinodavid/eslint-fix-me\r\n                  // eslint-disable-next-line @typescript-eslint/no-non-null-assertion\r\n                  bestMakerQuoteWithGasFee!.makerAmount\r\n                : // $eslint-fix-me https://github.com/rhinodavid/eslint-fix-me\r\n                  // eslint-disable-next-line @typescript-eslint/no-non-null-assertion\r\n                  bestMakerQuoteWithGasFee!.takerAmount;\r\n            zeroExFeeAmount = calculateDefaultFeeAmount(\r\n                quoteTokenAmount,\r\n                tradeSizeBps,\r\n                quoteTokenBaseUnitPriceUsd,\r\n                feeTokenBaseUnitPriceUsd,\r\n            );\r\n\r\n            const details: DefaultFeeDetailsDeprecated = {\r\n                kind: 'default',\r\n                feeModelVersion,\r\n                gasFeeAmount: gasFee.amount,\r\n                gasPrice: gasFee.details.gasPrice,\r\n                zeroExFeeAmount,\r\n                tradeSizeBps,\r\n                feeTokenBaseUnitPriceUsd,\r\n                takerTokenBaseUnitPriceUsd: isSelling ? null : quoteTokenBaseUnitPriceUsd,\r\n                makerTokenBaseUnitPriceUsd: isSelling ? quoteTokenBaseUnitPriceUsd : null,\r\n            };\r\n\r\n            const breakdown: FeeBreakdown = {\r\n                gas: gasFee.breakdown.gas,\r\n                zeroEx: {\r\n                    amount: zeroExFeeAmount,\r\n                    details: {\r\n                        kind: 'volume',\r\n                        tradeSizeBps,\r\n                    },\r\n                },\r\n            };\r\n\r\n            const conversionRates: ConversionRates = {\r\n                nativeTokenBaseUnitPriceUsd: feeTokenBaseUnitPriceUsd,\r\n                feeTokenBaseUnitPriceUsd,\r\n                takerTokenBaseUnitPriceUsd: isSelling ? null : quoteTokenBaseUnitPriceUsd,\r\n                makerTokenBaseUnitPriceUsd: isSelling ? quoteTokenBaseUnitPriceUsd : null,\r\n            };\r\n\r\n            feeWithDetails = {\r\n                type: 'fixed',\r\n                token: this._feeTokenMetadata.tokenAddress,\r\n                amount: gasFee.amount.plus(zeroExFeeAmount),\r\n                details,\r\n                breakdown,\r\n                conversionRates,\r\n            };\r\n        } else {\r\n            /**\r\n             * If all queries are successful: return `priceImprovement` based fee, calculated from `priceImprovement` and `rakeRatio`.\r\n             */\r\n            const priceImprovement =\r\n                rakeRatio > 0\r\n                    ? calculatePriceImprovementAmount(\r\n                          // $eslint-fix-me https://github.com/rhinodavid/eslint-fix-me\r\n                          // eslint-disable-next-line @typescript-eslint/no-non-null-assertion\r\n                          bestMakerQuoteWithGasFee!,\r\n                          // $eslint-fix-me https://github.com/rhinodavid/eslint-fix-me\r\n                          // eslint-disable-next-line @typescript-eslint/no-non-null-assertion\r\n                          ammQuote!,\r\n                          isSelling,\r\n                          // $eslint-fix-me https://github.com/rhinodavid/eslint-fix-me\r\n                          // eslint-disable-next-line @typescript-eslint/no-non-null-assertion\r\n                          quoteTokenBaseUnitPriceUsd!,\r\n                          // $eslint-fix-me https://github.com/rhinodavid/eslint-fix-me\r\n                          // eslint-disable-next-line @typescript-eslint/no-non-null-assertion\r\n                          feeTokenBaseUnitPriceUsd!,\r\n                      )\r\n                    : ZERO;\r\n            zeroExFeeAmount = priceImprovement.times(rakeRatio).integerValue();\r\n\r\n            const details: MarginBasedFeeDetailsDeprecated = {\r\n                kind: 'margin',\r\n                feeModelVersion,\r\n                gasFeeAmount: gasFee.amount,\r\n                gasPrice: gasFee.details.gasPrice,\r\n                zeroExFeeAmount,\r\n                margin: priceImprovement, // legacy field name `margin`\r\n                marginRakeRatio: rakeRatio, // legacy field name `marginRakeRatio`\r\n                feeTokenBaseUnitPriceUsd,\r\n                takerTokenBaseUnitPriceUsd: isSelling ? null : quoteTokenBaseUnitPriceUsd,\r\n                makerTokenBaseUnitPriceUsd: isSelling ? quoteTokenBaseUnitPriceUsd : null,\r\n            };\r\n\r\n            const breakdown: FeeBreakdown = {\r\n                gas: gasFee.breakdown.gas,\r\n                zeroEx: {\r\n                    amount: zeroExFeeAmount,\r\n                    details: {\r\n                        kind: 'price_improvement',\r\n                        priceImprovement,\r\n                        rakeRatio,\r\n                    },\r\n                },\r\n            };\r\n\r\n            const conversionRates: ConversionRates = {\r\n                nativeTokenBaseUnitPriceUsd: feeTokenBaseUnitPriceUsd,\r\n                feeTokenBaseUnitPriceUsd,\r\n                takerTokenBaseUnitPriceUsd: isSelling ? null : quoteTokenBaseUnitPriceUsd,\r\n                makerTokenBaseUnitPriceUsd: isSelling ? quoteTokenBaseUnitPriceUsd : null,\r\n            };\r\n\r\n            feeWithDetails = {\r\n                type: 'fixed',\r\n                token: this._feeTokenMetadata.tokenAddress,\r\n                amount: zeroExFeeAmount.plus(gasFee.amount),\r\n                details,\r\n                breakdown,\r\n                conversionRates,\r\n            };\r\n        }\r\n\r\n        return {\r\n            feeWithDetails,\r\n            quotesWithGasFee,\r\n            ammQuoteUniqueId,\r\n        };\r\n    }\r\n\r\n    /**\r\n     * Internal method to fetch prices of tradingToken (either makerToken or takerToken) and feeToken.\r\n     */\r\n    private async _fetchTokenPricesAsync(\r\n        tradeToken: string,\r\n        tradeTokenDecimals: number,\r\n    ): Promise<{\r\n        tradeTokenBaseUnitPriceUsd: BigNumber | null;\r\n        feeTokenBaseUnitPriceUsd: BigNumber | null;\r\n    }> {\r\n        const [tradeTokenBaseUnitPriceUsd, feeTokenBaseUnitPriceUsd] =\r\n            await this._tokenPriceOracle.batchFetchTokenPriceAsync([\r\n                {\r\n                    chainId: this._chainId,\r\n                    tokenAddress: tradeToken,\r\n                    tokenDecimals: tradeTokenDecimals,\r\n                },\r\n                {\r\n                    chainId: this._chainId,\r\n                    tokenAddress: this._feeTokenMetadata.tokenAddress,\r\n                    tokenDecimals: this._feeTokenMetadata.decimals,\r\n                },\r\n            ]);\r\n\r\n        return {\r\n            tradeTokenBaseUnitPriceUsd,\r\n            feeTokenBaseUnitPriceUsd,\r\n        };\r\n    }\r\n\r\n    private async _fetchGasFeeAndIndicativeQuotesAsync(\r\n        quoteContext: QuoteContext,\r\n        fetchMmQuotesAsync?: (quoteContext: QuoteContext, fee: Fee) => Promise<IndicativeQuote[]>,\r\n    ): Promise<{\r\n        gasFee: FeeWithDetails;\r\n        quotes: IndicativeQuote[];\r\n    }> {\r\n        const gasFee = await this._calculateGasFeeAsync(quoteContext);\r\n        const quotes = fetchMmQuotesAsync === undefined ? [] : await fetchMmQuotesAsync(quoteContext, gasFee);\r\n\r\n        return {\r\n            gasFee,\r\n            quotes,\r\n        };\r\n    }\r\n}\r\n"],"version":3}