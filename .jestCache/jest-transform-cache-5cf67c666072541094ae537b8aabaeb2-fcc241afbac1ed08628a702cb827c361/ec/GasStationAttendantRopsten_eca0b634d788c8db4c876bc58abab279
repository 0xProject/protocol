b0597c4c069c0efb8284c9258ab97187
"use strict";
Object.defineProperty(exports, "__esModule", { value: true });
exports.GasStationAttendantRopsten = void 0;
const utils_1 = require("@0x/utils");
const constants_1 = require("../core/constants");
// Increase multiplier for tip/base fee with each resubmission cycle
const TEN_PERCENT_INCREASE = 1.1;
// No new trades will be submitted with a tip above 192 GWEI.
const MAXIMUM_TIP_WEI = new utils_1.BigNumber(192).shiftedBy(constants_1.GWEI_DECIMALS);
/**
 * An implementation of `GasStationAttendant` designed for Ropsten.
 *
 * This should only be used for testing (I mean, it's on a test net)
 * and does not meet the standards of code we have for production.
 *
 * Currently, the 0x Gas Oracle does not provide pricing for Ropsten
 * in EIP-1559 format. Therefore, we'll use the "pre-GasStationAttendant"
 * strategy where the fast gas + padding is used for billing
 * and we use 1.5 GWEI tip, increasing by 2x every trade.
 *
 * Other values are best guesses.
 */
class GasStationAttendantRopsten {
    constructor(protocolFeeUtils) {
        this._protocolFeeUtils = protocolFeeUtils;
    }
    /**
     * Assumes ~100 GWEI for a trade
     */
    // tslint:disable-next-line: prefer-function-over-method
    async getSafeBalanceForTradeAsync() {
        const estimatedTradeRateGwei = 100;
        const gasEstimate = constants_1.RFQM_TX_OTC_ORDER_GAS_ESTIMATE;
        return new utils_1.BigNumber(estimatedTradeRateGwei).shiftedBy(constants_1.GWEI_DECIMALS).times(gasEstimate);
    }
    /**
     * Na√Øve 2x the fast gas price for a trade
     */
    async getWorkerBalanceForTradeAsync() {
        const gasPriceEstimateWei = await this._protocolFeeUtils.getGasPriceEstimationOrThrowAsync();
        const gasEstimate = constants_1.RFQM_TX_OTC_ORDER_GAS_ESTIMATE;
        return gasPriceEstimateWei.times(2).times(gasEstimate);
    }
    /**
     * Use the 'fast' gas plus a padding
     */
    async getExpectedTransactionGasRateAsync() {
        // use that instead of the legacy fast gas price.
        const gasPriceEstimateWei = await this._protocolFeeUtils.getGasPriceEstimationOrThrowAsync();
        const padding = 1.5;
        return gasPriceEstimateWei.times(padding).integerValue(utils_1.BigNumber.ROUND_CEIL);
    }
    /**
     * Double tip and increase maxFeePerGas by 10% to make nodes happy
     */
    async getNextBidAsync(submissionContext) {
        const gasPriceEstimateWei = await this._protocolFeeUtils.getGasPriceEstimationOrThrowAsync();
        const initialTip = new utils_1.BigNumber(1.5).shiftedBy(constants_1.GWEI_DECIMALS);
        if (!submissionContext) {
            const initialMaxPriorityFeePerGasWei = initialTip;
            const initialBaseFee = gasPriceEstimateWei.times(2);
            return {
                maxPriorityFeePerGas: initialMaxPriorityFeePerGasWei,
                maxFeePerGas: initialBaseFee.plus(initialMaxPriorityFeePerGasWei),
            };
        }
        const { maxFeePerGas: oldMaxFeePerGas, maxPriorityFeePerGas: oldMaxPriorityFeePerGas } = submissionContext.maxGasFees;
        const newMaxPriorityFeePerGas = utils_1.BigNumber.max(oldMaxPriorityFeePerGas.times(2), gasPriceEstimateWei);
        if (newMaxPriorityFeePerGas.isGreaterThan(MAXIMUM_TIP_WEI)) {
            return null;
        }
        const newMaxFeePerGas = oldMaxFeePerGas.multipliedBy(TEN_PERCENT_INCREASE);
        return {
            maxPriorityFeePerGas: newMaxPriorityFeePerGas.integerValue(utils_1.BigNumber.ROUND_CEIL),
            maxFeePerGas: newMaxFeePerGas.integerValue(utils_1.BigNumber.ROUND_CEIL),
        };
    }
}
exports.GasStationAttendantRopsten = GasStationAttendantRopsten;
//# sourceMappingURL=data:application/json;charset=utf-8;base64,eyJmaWxlIjoiL1VzZXJzL2Rhdmlkd2Fsc2gvY29kZS1sb2NhbC8weC1yZnEtYXBpL3NyYy91dGlscy9HYXNTdGF0aW9uQXR0ZW5kYW50Um9wc3Rlbi50cyIsIm1hcHBpbmdzIjoiOzs7QUFDQSxxQ0FBc0M7QUFFdEMsaURBQWtGO0FBTWxGLG9FQUFvRTtBQUNwRSxNQUFNLG9CQUFvQixHQUFHLEdBQUcsQ0FBQztBQUVqQyw2REFBNkQ7QUFDN0QsTUFBTSxlQUFlLEdBQUcsSUFBSSxpQkFBUyxDQUFDLEdBQUcsQ0FBQyxDQUFDLFNBQVMsQ0FBQyx5QkFBYSxDQUFDLENBQUM7QUFFcEU7Ozs7Ozs7Ozs7OztHQVlHO0FBQ0gsTUFBYSwwQkFBMEI7SUFHbkMsWUFBWSxnQkFBa0M7UUFDMUMsSUFBSSxDQUFDLGlCQUFpQixHQUFHLGdCQUFnQixDQUFDO0lBQzlDLENBQUM7SUFFRDs7T0FFRztJQUNILHdEQUF3RDtJQUNqRCxLQUFLLENBQUMsMkJBQTJCO1FBQ3BDLE1BQU0sc0JBQXNCLEdBQUcsR0FBRyxDQUFDO1FBQ25DLE1BQU0sV0FBVyxHQUFHLDBDQUE4QixDQUFDO1FBQ25ELE9BQU8sSUFBSSxpQkFBUyxDQUFDLHNCQUFzQixDQUFDLENBQUMsU0FBUyxDQUFDLHlCQUFhLENBQUMsQ0FBQyxLQUFLLENBQUMsV0FBVyxDQUFDLENBQUM7SUFDN0YsQ0FBQztJQUVEOztPQUVHO0lBQ0ksS0FBSyxDQUFDLDZCQUE2QjtRQUN0QyxNQUFNLG1CQUFtQixHQUFHLE1BQU0sSUFBSSxDQUFDLGlCQUFpQixDQUFDLGlDQUFpQyxFQUFFLENBQUM7UUFDN0YsTUFBTSxXQUFXLEdBQUcsMENBQThCLENBQUM7UUFFbkQsT0FBTyxtQkFBbUIsQ0FBQyxLQUFLLENBQUMsQ0FBQyxDQUFDLENBQUMsS0FBSyxDQUFDLFdBQVcsQ0FBQyxDQUFDO0lBQzNELENBQUM7SUFFRDs7T0FFRztJQUNJLEtBQUssQ0FBQyxrQ0FBa0M7UUFDM0MsaURBQWlEO1FBQ2pELE1BQU0sbUJBQW1CLEdBQUcsTUFBTSxJQUFJLENBQUMsaUJBQWlCLENBQUMsaUNBQWlDLEVBQUUsQ0FBQztRQUM3RixNQUFNLE9BQU8sR0FBRyxHQUFHLENBQUM7UUFDcEIsT0FBTyxtQkFBbUIsQ0FBQyxLQUFLLENBQUMsT0FBTyxDQUFDLENBQUMsWUFBWSxDQUFDLGlCQUFTLENBQUMsVUFBVSxDQUFDLENBQUM7SUFDakYsQ0FBQztJQUVEOztPQUVHO0lBQ0ksS0FBSyxDQUFDLGVBQWUsQ0FDeEIsaUJBRVE7UUFFUixNQUFNLG1CQUFtQixHQUFHLE1BQU0sSUFBSSxDQUFDLGlCQUFpQixDQUFDLGlDQUFpQyxFQUFFLENBQUM7UUFDN0YsTUFBTSxVQUFVLEdBQUcsSUFBSSxpQkFBUyxDQUFDLEdBQUcsQ0FBQyxDQUFDLFNBQVMsQ0FBQyx5QkFBYSxDQUFDLENBQUM7UUFDL0QsSUFBSSxDQUFDLGlCQUFpQixFQUFFO1lBQ3BCLE1BQU0sOEJBQThCLEdBQUcsVUFBVSxDQUFDO1lBQ2xELE1BQU0sY0FBYyxHQUFHLG1CQUFtQixDQUFDLEtBQUssQ0FBQyxDQUFDLENBQUMsQ0FBQztZQUNwRCxPQUFPO2dCQUNILG9CQUFvQixFQUFFLDhCQUE4QjtnQkFDcEQsWUFBWSxFQUFFLGNBQWMsQ0FBQyxJQUFJLENBQUMsOEJBQThCLENBQUM7YUFDcEUsQ0FBQztTQUNMO1FBRUQsTUFBTSxFQUFFLFlBQVksRUFBRSxlQUFlLEVBQUUsb0JBQW9CLEVBQUUsdUJBQXVCLEVBQUUsR0FDbEYsaUJBQWlCLENBQUMsVUFBVSxDQUFDO1FBRWpDLE1BQU0sdUJBQXVCLEdBQUcsaUJBQVMsQ0FBQyxHQUFHLENBQUMsdUJBQXVCLENBQUMsS0FBSyxDQUFDLENBQUMsQ0FBQyxFQUFFLG1CQUFtQixDQUFDLENBQUM7UUFFckcsSUFBSSx1QkFBdUIsQ0FBQyxhQUFhLENBQUMsZUFBZSxDQUFDLEVBQUU7WUFDeEQsT0FBTyxJQUFJLENBQUM7U0FDZjtRQUVELE1BQU0sZUFBZSxHQUFHLGVBQWUsQ0FBQyxZQUFZLENBQUMsb0JBQW9CLENBQUMsQ0FBQztRQUUzRSxPQUFPO1lBQ0gsb0JBQW9CLEVBQUUsdUJBQXVCLENBQUMsWUFBWSxDQUFDLGlCQUFTLENBQUMsVUFBVSxDQUFDO1lBQ2hGLFlBQVksRUFBRSxlQUFlLENBQUMsWUFBWSxDQUFDLGlCQUFTLENBQUMsVUFBVSxDQUFDO1NBQ25FLENBQUM7SUFDTixDQUFDO0NBQ0o7QUF4RUQsZ0VBd0VDIiwibmFtZXMiOltdLCJzb3VyY2VzIjpbIi9Vc2Vycy9kYXZpZHdhbHNoL2NvZGUtbG9jYWwvMHgtcmZxLWFwaS9zcmMvdXRpbHMvR2FzU3RhdGlvbkF0dGVuZGFudFJvcHN0ZW4udHMiXSwic291cmNlc0NvbnRlbnQiOlsiaW1wb3J0IHsgUHJvdG9jb2xGZWVVdGlscyB9IGZyb20gJ0AweC9hc3NldC1zd2FwcGVyJztcclxuaW1wb3J0IHsgQmlnTnVtYmVyIH0gZnJvbSAnQDB4L3V0aWxzJztcclxuXHJcbmltcG9ydCB7IEdXRUlfREVDSU1BTFMsIFJGUU1fVFhfT1RDX09SREVSX0dBU19FU1RJTUFURSB9IGZyb20gJy4uL2NvcmUvY29uc3RhbnRzJztcclxuaW1wb3J0IHsgTWV0YVRyYW5zYWN0aW9uU3VibWlzc2lvbkVudGl0eSwgUmZxbVYyVHJhbnNhY3Rpb25TdWJtaXNzaW9uRW50aXR5IH0gZnJvbSAnLi4vZW50aXRpZXMnO1xyXG5cclxuaW1wb3J0IHsgR2FzU3RhdGlvbkF0dGVuZGFudCwgV2VpLCBXZWlQZXJHYXMgfSBmcm9tICcuL0dhc1N0YXRpb25BdHRlbmRhbnQnO1xyXG5pbXBvcnQgeyBTdWJtaXNzaW9uQ29udGV4dCB9IGZyb20gJy4vU3VibWlzc2lvbkNvbnRleHQnO1xyXG5cclxuLy8gSW5jcmVhc2UgbXVsdGlwbGllciBmb3IgdGlwL2Jhc2UgZmVlIHdpdGggZWFjaCByZXN1Ym1pc3Npb24gY3ljbGVcclxuY29uc3QgVEVOX1BFUkNFTlRfSU5DUkVBU0UgPSAxLjE7XHJcblxyXG4vLyBObyBuZXcgdHJhZGVzIHdpbGwgYmUgc3VibWl0dGVkIHdpdGggYSB0aXAgYWJvdmUgMTkyIEdXRUkuXHJcbmNvbnN0IE1BWElNVU1fVElQX1dFSSA9IG5ldyBCaWdOdW1iZXIoMTkyKS5zaGlmdGVkQnkoR1dFSV9ERUNJTUFMUyk7XHJcblxyXG4vKipcclxuICogQW4gaW1wbGVtZW50YXRpb24gb2YgYEdhc1N0YXRpb25BdHRlbmRhbnRgIGRlc2lnbmVkIGZvciBSb3BzdGVuLlxyXG4gKlxyXG4gKiBUaGlzIHNob3VsZCBvbmx5IGJlIHVzZWQgZm9yIHRlc3RpbmcgKEkgbWVhbiwgaXQncyBvbiBhIHRlc3QgbmV0KVxyXG4gKiBhbmQgZG9lcyBub3QgbWVldCB0aGUgc3RhbmRhcmRzIG9mIGNvZGUgd2UgaGF2ZSBmb3IgcHJvZHVjdGlvbi5cclxuICpcclxuICogQ3VycmVudGx5LCB0aGUgMHggR2FzIE9yYWNsZSBkb2VzIG5vdCBwcm92aWRlIHByaWNpbmcgZm9yIFJvcHN0ZW5cclxuICogaW4gRUlQLTE1NTkgZm9ybWF0LiBUaGVyZWZvcmUsIHdlJ2xsIHVzZSB0aGUgXCJwcmUtR2FzU3RhdGlvbkF0dGVuZGFudFwiXHJcbiAqIHN0cmF0ZWd5IHdoZXJlIHRoZSBmYXN0IGdhcyArIHBhZGRpbmcgaXMgdXNlZCBmb3IgYmlsbGluZ1xyXG4gKiBhbmQgd2UgdXNlIDEuNSBHV0VJIHRpcCwgaW5jcmVhc2luZyBieSAyeCBldmVyeSB0cmFkZS5cclxuICpcclxuICogT3RoZXIgdmFsdWVzIGFyZSBiZXN0IGd1ZXNzZXMuXHJcbiAqL1xyXG5leHBvcnQgY2xhc3MgR2FzU3RhdGlvbkF0dGVuZGFudFJvcHN0ZW4gaW1wbGVtZW50cyBHYXNTdGF0aW9uQXR0ZW5kYW50IHtcclxuICAgIHByaXZhdGUgcmVhZG9ubHkgX3Byb3RvY29sRmVlVXRpbHM6IFByb3RvY29sRmVlVXRpbHM7XHJcblxyXG4gICAgY29uc3RydWN0b3IocHJvdG9jb2xGZWVVdGlsczogUHJvdG9jb2xGZWVVdGlscykge1xyXG4gICAgICAgIHRoaXMuX3Byb3RvY29sRmVlVXRpbHMgPSBwcm90b2NvbEZlZVV0aWxzO1xyXG4gICAgfVxyXG5cclxuICAgIC8qKlxyXG4gICAgICogQXNzdW1lcyB+MTAwIEdXRUkgZm9yIGEgdHJhZGVcclxuICAgICAqL1xyXG4gICAgLy8gdHNsaW50OmRpc2FibGUtbmV4dC1saW5lOiBwcmVmZXItZnVuY3Rpb24tb3Zlci1tZXRob2RcclxuICAgIHB1YmxpYyBhc3luYyBnZXRTYWZlQmFsYW5jZUZvclRyYWRlQXN5bmMoKTogUHJvbWlzZTxXZWk+IHtcclxuICAgICAgICBjb25zdCBlc3RpbWF0ZWRUcmFkZVJhdGVHd2VpID0gMTAwO1xyXG4gICAgICAgIGNvbnN0IGdhc0VzdGltYXRlID0gUkZRTV9UWF9PVENfT1JERVJfR0FTX0VTVElNQVRFO1xyXG4gICAgICAgIHJldHVybiBuZXcgQmlnTnVtYmVyKGVzdGltYXRlZFRyYWRlUmF0ZUd3ZWkpLnNoaWZ0ZWRCeShHV0VJX0RFQ0lNQUxTKS50aW1lcyhnYXNFc3RpbWF0ZSk7XHJcbiAgICB9XHJcblxyXG4gICAgLyoqXHJcbiAgICAgKiBOYcOvdmUgMnggdGhlIGZhc3QgZ2FzIHByaWNlIGZvciBhIHRyYWRlXHJcbiAgICAgKi9cclxuICAgIHB1YmxpYyBhc3luYyBnZXRXb3JrZXJCYWxhbmNlRm9yVHJhZGVBc3luYygpOiBQcm9taXNlPFdlaVBlckdhcz4ge1xyXG4gICAgICAgIGNvbnN0IGdhc1ByaWNlRXN0aW1hdGVXZWkgPSBhd2FpdCB0aGlzLl9wcm90b2NvbEZlZVV0aWxzLmdldEdhc1ByaWNlRXN0aW1hdGlvbk9yVGhyb3dBc3luYygpO1xyXG4gICAgICAgIGNvbnN0IGdhc0VzdGltYXRlID0gUkZRTV9UWF9PVENfT1JERVJfR0FTX0VTVElNQVRFO1xyXG5cclxuICAgICAgICByZXR1cm4gZ2FzUHJpY2VFc3RpbWF0ZVdlaS50aW1lcygyKS50aW1lcyhnYXNFc3RpbWF0ZSk7XHJcbiAgICB9XHJcblxyXG4gICAgLyoqXHJcbiAgICAgKiBVc2UgdGhlICdmYXN0JyBnYXMgcGx1cyBhIHBhZGRpbmdcclxuICAgICAqL1xyXG4gICAgcHVibGljIGFzeW5jIGdldEV4cGVjdGVkVHJhbnNhY3Rpb25HYXNSYXRlQXN5bmMoKTogUHJvbWlzZTxXZWlQZXJHYXM+IHtcclxuICAgICAgICAvLyB1c2UgdGhhdCBpbnN0ZWFkIG9mIHRoZSBsZWdhY3kgZmFzdCBnYXMgcHJpY2UuXHJcbiAgICAgICAgY29uc3QgZ2FzUHJpY2VFc3RpbWF0ZVdlaSA9IGF3YWl0IHRoaXMuX3Byb3RvY29sRmVlVXRpbHMuZ2V0R2FzUHJpY2VFc3RpbWF0aW9uT3JUaHJvd0FzeW5jKCk7XHJcbiAgICAgICAgY29uc3QgcGFkZGluZyA9IDEuNTtcclxuICAgICAgICByZXR1cm4gZ2FzUHJpY2VFc3RpbWF0ZVdlaS50aW1lcyhwYWRkaW5nKS5pbnRlZ2VyVmFsdWUoQmlnTnVtYmVyLlJPVU5EX0NFSUwpO1xyXG4gICAgfVxyXG5cclxuICAgIC8qKlxyXG4gICAgICogRG91YmxlIHRpcCBhbmQgaW5jcmVhc2UgbWF4RmVlUGVyR2FzIGJ5IDEwJSB0byBtYWtlIG5vZGVzIGhhcHB5XHJcbiAgICAgKi9cclxuICAgIHB1YmxpYyBhc3luYyBnZXROZXh0QmlkQXN5bmMoXHJcbiAgICAgICAgc3VibWlzc2lvbkNvbnRleHQ6IFN1Ym1pc3Npb25Db250ZXh0PFxyXG4gICAgICAgICAgICBSZnFtVjJUcmFuc2FjdGlvblN1Ym1pc3Npb25FbnRpdHlbXSB8IE1ldGFUcmFuc2FjdGlvblN1Ym1pc3Npb25FbnRpdHlbXVxyXG4gICAgICAgID4gfCBudWxsLFxyXG4gICAgKTogUHJvbWlzZTx7IG1heEZlZVBlckdhczogQmlnTnVtYmVyOyBtYXhQcmlvcml0eUZlZVBlckdhczogQmlnTnVtYmVyIH0gfCBudWxsPiB7XHJcbiAgICAgICAgY29uc3QgZ2FzUHJpY2VFc3RpbWF0ZVdlaSA9IGF3YWl0IHRoaXMuX3Byb3RvY29sRmVlVXRpbHMuZ2V0R2FzUHJpY2VFc3RpbWF0aW9uT3JUaHJvd0FzeW5jKCk7XHJcbiAgICAgICAgY29uc3QgaW5pdGlhbFRpcCA9IG5ldyBCaWdOdW1iZXIoMS41KS5zaGlmdGVkQnkoR1dFSV9ERUNJTUFMUyk7XHJcbiAgICAgICAgaWYgKCFzdWJtaXNzaW9uQ29udGV4dCkge1xyXG4gICAgICAgICAgICBjb25zdCBpbml0aWFsTWF4UHJpb3JpdHlGZWVQZXJHYXNXZWkgPSBpbml0aWFsVGlwO1xyXG4gICAgICAgICAgICBjb25zdCBpbml0aWFsQmFzZUZlZSA9IGdhc1ByaWNlRXN0aW1hdGVXZWkudGltZXMoMik7XHJcbiAgICAgICAgICAgIHJldHVybiB7XHJcbiAgICAgICAgICAgICAgICBtYXhQcmlvcml0eUZlZVBlckdhczogaW5pdGlhbE1heFByaW9yaXR5RmVlUGVyR2FzV2VpLFxyXG4gICAgICAgICAgICAgICAgbWF4RmVlUGVyR2FzOiBpbml0aWFsQmFzZUZlZS5wbHVzKGluaXRpYWxNYXhQcmlvcml0eUZlZVBlckdhc1dlaSksXHJcbiAgICAgICAgICAgIH07XHJcbiAgICAgICAgfVxyXG5cclxuICAgICAgICBjb25zdCB7IG1heEZlZVBlckdhczogb2xkTWF4RmVlUGVyR2FzLCBtYXhQcmlvcml0eUZlZVBlckdhczogb2xkTWF4UHJpb3JpdHlGZWVQZXJHYXMgfSA9XHJcbiAgICAgICAgICAgIHN1Ym1pc3Npb25Db250ZXh0Lm1heEdhc0ZlZXM7XHJcblxyXG4gICAgICAgIGNvbnN0IG5ld01heFByaW9yaXR5RmVlUGVyR2FzID0gQmlnTnVtYmVyLm1heChvbGRNYXhQcmlvcml0eUZlZVBlckdhcy50aW1lcygyKSwgZ2FzUHJpY2VFc3RpbWF0ZVdlaSk7XHJcblxyXG4gICAgICAgIGlmIChuZXdNYXhQcmlvcml0eUZlZVBlckdhcy5pc0dyZWF0ZXJUaGFuKE1BWElNVU1fVElQX1dFSSkpIHtcclxuICAgICAgICAgICAgcmV0dXJuIG51bGw7XHJcbiAgICAgICAgfVxyXG5cclxuICAgICAgICBjb25zdCBuZXdNYXhGZWVQZXJHYXMgPSBvbGRNYXhGZWVQZXJHYXMubXVsdGlwbGllZEJ5KFRFTl9QRVJDRU5UX0lOQ1JFQVNFKTtcclxuXHJcbiAgICAgICAgcmV0dXJuIHtcclxuICAgICAgICAgICAgbWF4UHJpb3JpdHlGZWVQZXJHYXM6IG5ld01heFByaW9yaXR5RmVlUGVyR2FzLmludGVnZXJWYWx1ZShCaWdOdW1iZXIuUk9VTkRfQ0VJTCksXHJcbiAgICAgICAgICAgIG1heEZlZVBlckdhczogbmV3TWF4RmVlUGVyR2FzLmludGVnZXJWYWx1ZShCaWdOdW1iZXIuUk9VTkRfQ0VJTCksXHJcbiAgICAgICAgfTtcclxuICAgIH1cclxufVxyXG4iXSwidmVyc2lvbiI6M30=