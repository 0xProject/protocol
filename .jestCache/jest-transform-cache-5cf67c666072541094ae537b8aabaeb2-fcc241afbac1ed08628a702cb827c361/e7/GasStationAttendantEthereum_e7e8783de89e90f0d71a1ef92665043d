eea32377d667a976e0cab11069e76507
"use strict";
Object.defineProperty(exports, "__esModule", { value: true });
exports.GasStationAttendantEthereum = void 0;
const utils_1 = require("@0x/utils");
const constants_1 = require("../core/constants");
const rfqm_gas_estimate_utils_1 = require("./rfqm_gas_estimate_utils");
const INITIAL_MAX_PRIORITY_FEE_PER_GAS_GWEI = 2;
const MAX_PRIORITY_FEE_PER_GAS_CAP = new utils_1.BigNumber(128e9); // The maximum tip we're willing to pay
// Retrying an EIP 1559 transaction: https://docs.alchemy.com/alchemy/guides/eip-1559/retry-eip-1559-tx
const MAX_PRIORITY_FEE_PER_GAS_MULTIPLIER = 1.5; // Increase multiplier for tip with each resubmission cycle
/**
 * An implementation of `GasStationAttendant` designed for Ethereum Mainnet.
 */
class GasStationAttendantEthereum {
    constructor(gasOracle) {
        this._gasOracle = gasOracle;
    }
    /**
     * The Safe Balance For Trade is based on historical data as outlined here:
     * https://0xproject.quip.com/qZdFAHLpT7JI/RFQm-healthz-System-Health-Endpoint#temp:C:cXH5851e0f15e8c4828bffc1339d
     */
    // tslint:disable-next-line: prefer-function-over-method
    async getSafeBalanceForTradeAsync() {
        return new utils_1.BigNumber(82500000000000000);
    }
    /**
     * Uses an estimate of the current base fee with 6
     * 10% increases plus the "instant" maxPriorityFeePerGas
     * as reported by the oracle.
     *
     * Gas amount is estimated for an unwrap of the AAVE-USDC pair.
     */
    async getWorkerBalanceForTradeAsync() {
        const baseFee = await this._gasOracle.getBaseFeePerGasWeiAsync();
        const instantTip = await this._gasOracle.getMaxPriorityFeePerGasWeiAsync('instant');
        // Pad the baseFee for 6 10% increases
        const baseFeePad = Math.pow(1.1, 6); // tslint:disable-line: custom-no-magic-numbers
        const paddedBaseFee = baseFee.times(baseFeePad);
        const gasRate = paddedBaseFee.plus(instantTip);
        // Use a gas estimate of a pretty high-cost pair
        const gasEstimate = (0, rfqm_gas_estimate_utils_1.calculateGasEstimate)('0x7fc66500c84a76ad7e9c93437bfc5ac33e2ddae9', // AAVE
        '0xa0b86991c6218b36c1d19d4a2e9eb0ce3606eb48', // USDC
        'otc', true);
        return gasRate.times(gasEstimate);
    }
    /**
     * Calculated by looking at historical data and seeing we average 1.5 transactions
     * per job. This means we expect to pay 2.75 GWEI priority fee plus the base fee.
     */
    async getExpectedTransactionGasRateAsync() {
        const baseFee = await this._gasOracle.getBaseFeePerGasWeiAsync();
        // Currently we submit a 2 GWEI tip then multiply it by 1.5 per submission
        // Trades take ~1.5 submissions on average, so that's 2.75 GWEI
        const avgMaxPriorityFeePerGasRate = 2750000000;
        return baseFee.plus(avgMaxPriorityFeePerGasRate).integerValue(utils_1.BigNumber.ROUND_CEIL);
    }
    /**
     * The submission strategy starts with a maxPriorityFee of 2 GWEI and adds
     * 2 x the base fee to get the initial maxFeePerGas.
     */
    async getNextBidAsync(submissionContext) {
        const baseFee = await this._gasOracle.getBaseFeePerGasWeiAsync();
        if (!submissionContext) {
            // Our first bid is 2x the base fee + 2 GWEI tip
            const initialMaxPriorityFeePerGas = new utils_1.BigNumber(INITIAL_MAX_PRIORITY_FEE_PER_GAS_GWEI).times(Math.pow(10, constants_1.GWEI_DECIMALS));
            return {
                maxPriorityFeePerGas: initialMaxPriorityFeePerGas,
                maxFeePerGas: baseFee.times(2).plus(initialMaxPriorityFeePerGas),
            };
        }
        const { maxFeePerGas: oldMaxFeePerGas, maxPriorityFeePerGas: oldMaxPriorityFeePerGas } = submissionContext.maxGasFees;
        const newMaxPriorityFeePerGas = oldMaxPriorityFeePerGas.times(MAX_PRIORITY_FEE_PER_GAS_MULTIPLIER);
        if (newMaxPriorityFeePerGas.isGreaterThanOrEqualTo(MAX_PRIORITY_FEE_PER_GAS_CAP)) {
            // We've reached our max; don't put in any new transactions
            return null;
        }
        // The RPC nodes still need at least a 0.1 increase in both values to accept the new transaction.
        // For the new max fee per gas, we'll take the maximum of a 0.1 increase from the last value
        // or the value from an increase in the base fee.
        const newMaxFeePerGas = utils_1.BigNumber.max(oldMaxFeePerGas.multipliedBy(1.1), // tslint:disable-line: custom-no-magic-numbers
        baseFee.multipliedBy(2).plus(newMaxPriorityFeePerGas));
        return {
            maxPriorityFeePerGas: newMaxPriorityFeePerGas.integerValue(utils_1.BigNumber.ROUND_CEIL),
            maxFeePerGas: newMaxFeePerGas.integerValue(utils_1.BigNumber.ROUND_CEIL),
        };
    }
}
exports.GasStationAttendantEthereum = GasStationAttendantEthereum;
//# sourceMappingURL=data:application/json;charset=utf-8;base64,eyJmaWxlIjoiL1VzZXJzL2Rhdmlkd2Fsc2gvY29kZS1sb2NhbC8weC1yZnEtYXBpL3NyYy91dGlscy9HYXNTdGF0aW9uQXR0ZW5kYW50RXRoZXJldW0udHMiLCJtYXBwaW5ncyI6Ijs7O0FBQUEscUNBQXNDO0FBRXRDLGlEQUFrRDtBQUtsRCx1RUFBaUU7QUFHakUsTUFBTSxxQ0FBcUMsR0FBRyxDQUFDLENBQUM7QUFDaEQsTUFBTSw0QkFBNEIsR0FBRyxJQUFJLGlCQUFTLENBQUMsS0FBSyxDQUFDLENBQUMsQ0FBQyx1Q0FBdUM7QUFDbEcsdUdBQXVHO0FBQ3ZHLE1BQU0sbUNBQW1DLEdBQUcsR0FBRyxDQUFDLENBQUMsMkRBQTJEO0FBRTVHOztHQUVHO0FBQ0gsTUFBYSwyQkFBMkI7SUFHcEMsWUFBWSxTQUFvQjtRQUM1QixJQUFJLENBQUMsVUFBVSxHQUFHLFNBQVMsQ0FBQztJQUNoQyxDQUFDO0lBRUQ7OztPQUdHO0lBQ0gsd0RBQXdEO0lBQ2pELEtBQUssQ0FBQywyQkFBMkI7UUFDcEMsT0FBTyxJQUFJLGlCQUFTLENBQUMsaUJBQWlCLENBQUMsQ0FBQztJQUM1QyxDQUFDO0lBRUQ7Ozs7OztPQU1HO0lBQ0ksS0FBSyxDQUFDLDZCQUE2QjtRQUN0QyxNQUFNLE9BQU8sR0FBRyxNQUFNLElBQUksQ0FBQyxVQUFVLENBQUMsd0JBQXdCLEVBQUUsQ0FBQztRQUNqRSxNQUFNLFVBQVUsR0FBRyxNQUFNLElBQUksQ0FBQyxVQUFVLENBQUMsK0JBQStCLENBQUMsU0FBUyxDQUFDLENBQUM7UUFFcEYsc0NBQXNDO1FBQ3RDLE1BQU0sVUFBVSxHQUFHLElBQUksQ0FBQyxHQUFHLENBQUMsR0FBRyxFQUFFLENBQUMsQ0FBQyxDQUFDLENBQUMsK0NBQStDO1FBQ3BGLE1BQU0sYUFBYSxHQUFHLE9BQU8sQ0FBQyxLQUFLLENBQUMsVUFBVSxDQUFDLENBQUM7UUFDaEQsTUFBTSxPQUFPLEdBQUcsYUFBYSxDQUFDLElBQUksQ0FBQyxVQUFVLENBQUMsQ0FBQztRQUUvQyxnREFBZ0Q7UUFDaEQsTUFBTSxXQUFXLEdBQUcsSUFBQSw4Q0FBb0IsRUFDcEMsNENBQTRDLEVBQUUsT0FBTztRQUNyRCw0Q0FBNEMsRUFBRSxPQUFPO1FBQ3JELEtBQUssRUFDTCxJQUFJLENBQ1AsQ0FBQztRQUVGLE9BQU8sT0FBTyxDQUFDLEtBQUssQ0FBQyxXQUFXLENBQUMsQ0FBQztJQUN0QyxDQUFDO0lBRUQ7OztPQUdHO0lBQ0ksS0FBSyxDQUFDLGtDQUFrQztRQUMzQyxNQUFNLE9BQU8sR0FBRyxNQUFNLElBQUksQ0FBQyxVQUFVLENBQUMsd0JBQXdCLEVBQUUsQ0FBQztRQUNqRSwwRUFBMEU7UUFDMUUsK0RBQStEO1FBQy9ELE1BQU0sMkJBQTJCLEdBQUcsVUFBVSxDQUFDO1FBQy9DLE9BQU8sT0FBTyxDQUFDLElBQUksQ0FBQywyQkFBMkIsQ0FBQyxDQUFDLFlBQVksQ0FBQyxpQkFBUyxDQUFDLFVBQVUsQ0FBQyxDQUFDO0lBQ3hGLENBQUM7SUFFRDs7O09BR0c7SUFDSSxLQUFLLENBQUMsZUFBZSxDQUN4QixpQkFFUTtRQUVSLE1BQU0sT0FBTyxHQUFHLE1BQU0sSUFBSSxDQUFDLFVBQVUsQ0FBQyx3QkFBd0IsRUFBRSxDQUFDO1FBQ2pFLElBQUksQ0FBQyxpQkFBaUIsRUFBRTtZQUNwQixnREFBZ0Q7WUFDaEQsTUFBTSwyQkFBMkIsR0FBRyxJQUFJLGlCQUFTLENBQUMscUNBQXFDLENBQUMsQ0FBQyxLQUFLLENBQzFGLElBQUksQ0FBQyxHQUFHLENBQUMsRUFBRSxFQUFFLHlCQUFhLENBQUMsQ0FDOUIsQ0FBQztZQUNGLE9BQU87Z0JBQ0gsb0JBQW9CLEVBQUUsMkJBQTJCO2dCQUNqRCxZQUFZLEVBQUUsT0FBTyxDQUFDLEtBQUssQ0FBQyxDQUFDLENBQUMsQ0FBQyxJQUFJLENBQUMsMkJBQTJCLENBQUM7YUFDbkUsQ0FBQztTQUNMO1FBQ0QsTUFBTSxFQUFFLFlBQVksRUFBRSxlQUFlLEVBQUUsb0JBQW9CLEVBQUUsdUJBQXVCLEVBQUUsR0FDbEYsaUJBQWlCLENBQUMsVUFBVSxDQUFDO1FBQ2pDLE1BQU0sdUJBQXVCLEdBQUcsdUJBQXVCLENBQUMsS0FBSyxDQUFDLG1DQUFtQyxDQUFDLENBQUM7UUFDbkcsSUFBSSx1QkFBdUIsQ0FBQyxzQkFBc0IsQ0FBQyw0QkFBNEIsQ0FBQyxFQUFFO1lBQzlFLDJEQUEyRDtZQUMzRCxPQUFPLElBQUksQ0FBQztTQUNmO1FBQ0QsaUdBQWlHO1FBQ2pHLDRGQUE0RjtRQUM1RixpREFBaUQ7UUFDakQsTUFBTSxlQUFlLEdBQUcsaUJBQVMsQ0FBQyxHQUFHLENBQ2pDLGVBQWUsQ0FBQyxZQUFZLENBQUMsR0FBRyxDQUFDLEVBQUUsK0NBQStDO1FBQ2xGLE9BQU8sQ0FBQyxZQUFZLENBQUMsQ0FBQyxDQUFDLENBQUMsSUFBSSxDQUFDLHVCQUF1QixDQUFDLENBQ3hELENBQUM7UUFDRixPQUFPO1lBQ0gsb0JBQW9CLEVBQUUsdUJBQXVCLENBQUMsWUFBWSxDQUFDLGlCQUFTLENBQUMsVUFBVSxDQUFDO1lBQ2hGLFlBQVksRUFBRSxlQUFlLENBQUMsWUFBWSxDQUFDLGlCQUFTLENBQUMsVUFBVSxDQUFDO1NBQ25FLENBQUM7SUFDTixDQUFDO0NBQ0o7QUE5RkQsa0VBOEZDIiwibmFtZXMiOltdLCJzb3VyY2VzIjpbIi9Vc2Vycy9kYXZpZHdhbHNoL2NvZGUtbG9jYWwvMHgtcmZxLWFwaS9zcmMvdXRpbHMvR2FzU3RhdGlvbkF0dGVuZGFudEV0aGVyZXVtLnRzIl0sInNvdXJjZXNDb250ZW50IjpbImltcG9ydCB7IEJpZ051bWJlciB9IGZyb20gJ0AweC91dGlscyc7XHJcblxyXG5pbXBvcnQgeyBHV0VJX0RFQ0lNQUxTIH0gZnJvbSAnLi4vY29yZS9jb25zdGFudHMnO1xyXG5pbXBvcnQgeyBNZXRhVHJhbnNhY3Rpb25TdWJtaXNzaW9uRW50aXR5LCBSZnFtVjJUcmFuc2FjdGlvblN1Ym1pc3Npb25FbnRpdHkgfSBmcm9tICcuLi9lbnRpdGllcyc7XHJcblxyXG5pbXBvcnQgeyBHYXNPcmFjbGUgfSBmcm9tICcuL0dhc09yYWNsZSc7XHJcbmltcG9ydCB7IEdhc1N0YXRpb25BdHRlbmRhbnQsIFdlaSwgV2VpUGVyR2FzIH0gZnJvbSAnLi9HYXNTdGF0aW9uQXR0ZW5kYW50JztcclxuaW1wb3J0IHsgY2FsY3VsYXRlR2FzRXN0aW1hdGUgfSBmcm9tICcuL3JmcW1fZ2FzX2VzdGltYXRlX3V0aWxzJztcclxuaW1wb3J0IHsgU3VibWlzc2lvbkNvbnRleHQgfSBmcm9tICcuL1N1Ym1pc3Npb25Db250ZXh0JztcclxuXHJcbmNvbnN0IElOSVRJQUxfTUFYX1BSSU9SSVRZX0ZFRV9QRVJfR0FTX0dXRUkgPSAyO1xyXG5jb25zdCBNQVhfUFJJT1JJVFlfRkVFX1BFUl9HQVNfQ0FQID0gbmV3IEJpZ051bWJlcigxMjhlOSk7IC8vIFRoZSBtYXhpbXVtIHRpcCB3ZSdyZSB3aWxsaW5nIHRvIHBheVxyXG4vLyBSZXRyeWluZyBhbiBFSVAgMTU1OSB0cmFuc2FjdGlvbjogaHR0cHM6Ly9kb2NzLmFsY2hlbXkuY29tL2FsY2hlbXkvZ3VpZGVzL2VpcC0xNTU5L3JldHJ5LWVpcC0xNTU5LXR4XHJcbmNvbnN0IE1BWF9QUklPUklUWV9GRUVfUEVSX0dBU19NVUxUSVBMSUVSID0gMS41OyAvLyBJbmNyZWFzZSBtdWx0aXBsaWVyIGZvciB0aXAgd2l0aCBlYWNoIHJlc3VibWlzc2lvbiBjeWNsZVxyXG5cclxuLyoqXHJcbiAqIEFuIGltcGxlbWVudGF0aW9uIG9mIGBHYXNTdGF0aW9uQXR0ZW5kYW50YCBkZXNpZ25lZCBmb3IgRXRoZXJldW0gTWFpbm5ldC5cclxuICovXHJcbmV4cG9ydCBjbGFzcyBHYXNTdGF0aW9uQXR0ZW5kYW50RXRoZXJldW0gaW1wbGVtZW50cyBHYXNTdGF0aW9uQXR0ZW5kYW50IHtcclxuICAgIHByaXZhdGUgcmVhZG9ubHkgX2dhc09yYWNsZTogR2FzT3JhY2xlO1xyXG5cclxuICAgIGNvbnN0cnVjdG9yKGdhc09yYWNsZTogR2FzT3JhY2xlKSB7XHJcbiAgICAgICAgdGhpcy5fZ2FzT3JhY2xlID0gZ2FzT3JhY2xlO1xyXG4gICAgfVxyXG5cclxuICAgIC8qKlxyXG4gICAgICogVGhlIFNhZmUgQmFsYW5jZSBGb3IgVHJhZGUgaXMgYmFzZWQgb24gaGlzdG9yaWNhbCBkYXRhIGFzIG91dGxpbmVkIGhlcmU6XHJcbiAgICAgKiBodHRwczovLzB4cHJvamVjdC5xdWlwLmNvbS9xWmRGQUhMcFQ3SkkvUkZRbS1oZWFsdGh6LVN5c3RlbS1IZWFsdGgtRW5kcG9pbnQjdGVtcDpDOmNYSDU4NTFlMGYxNWU4YzQ4MjhiZmZjMTMzOWRcclxuICAgICAqL1xyXG4gICAgLy8gdHNsaW50OmRpc2FibGUtbmV4dC1saW5lOiBwcmVmZXItZnVuY3Rpb24tb3Zlci1tZXRob2RcclxuICAgIHB1YmxpYyBhc3luYyBnZXRTYWZlQmFsYW5jZUZvclRyYWRlQXN5bmMoKTogUHJvbWlzZTxXZWk+IHtcclxuICAgICAgICByZXR1cm4gbmV3IEJpZ051bWJlcig4MjUwMDAwMDAwMDAwMDAwMCk7XHJcbiAgICB9XHJcblxyXG4gICAgLyoqXHJcbiAgICAgKiBVc2VzIGFuIGVzdGltYXRlIG9mIHRoZSBjdXJyZW50IGJhc2UgZmVlIHdpdGggNlxyXG4gICAgICogMTAlIGluY3JlYXNlcyBwbHVzIHRoZSBcImluc3RhbnRcIiBtYXhQcmlvcml0eUZlZVBlckdhc1xyXG4gICAgICogYXMgcmVwb3J0ZWQgYnkgdGhlIG9yYWNsZS5cclxuICAgICAqXHJcbiAgICAgKiBHYXMgYW1vdW50IGlzIGVzdGltYXRlZCBmb3IgYW4gdW53cmFwIG9mIHRoZSBBQVZFLVVTREMgcGFpci5cclxuICAgICAqL1xyXG4gICAgcHVibGljIGFzeW5jIGdldFdvcmtlckJhbGFuY2VGb3JUcmFkZUFzeW5jKCk6IFByb21pc2U8V2VpUGVyR2FzPiB7XHJcbiAgICAgICAgY29uc3QgYmFzZUZlZSA9IGF3YWl0IHRoaXMuX2dhc09yYWNsZS5nZXRCYXNlRmVlUGVyR2FzV2VpQXN5bmMoKTtcclxuICAgICAgICBjb25zdCBpbnN0YW50VGlwID0gYXdhaXQgdGhpcy5fZ2FzT3JhY2xlLmdldE1heFByaW9yaXR5RmVlUGVyR2FzV2VpQXN5bmMoJ2luc3RhbnQnKTtcclxuXHJcbiAgICAgICAgLy8gUGFkIHRoZSBiYXNlRmVlIGZvciA2IDEwJSBpbmNyZWFzZXNcclxuICAgICAgICBjb25zdCBiYXNlRmVlUGFkID0gTWF0aC5wb3coMS4xLCA2KTsgLy8gdHNsaW50OmRpc2FibGUtbGluZTogY3VzdG9tLW5vLW1hZ2ljLW51bWJlcnNcclxuICAgICAgICBjb25zdCBwYWRkZWRCYXNlRmVlID0gYmFzZUZlZS50aW1lcyhiYXNlRmVlUGFkKTtcclxuICAgICAgICBjb25zdCBnYXNSYXRlID0gcGFkZGVkQmFzZUZlZS5wbHVzKGluc3RhbnRUaXApO1xyXG5cclxuICAgICAgICAvLyBVc2UgYSBnYXMgZXN0aW1hdGUgb2YgYSBwcmV0dHkgaGlnaC1jb3N0IHBhaXJcclxuICAgICAgICBjb25zdCBnYXNFc3RpbWF0ZSA9IGNhbGN1bGF0ZUdhc0VzdGltYXRlKFxyXG4gICAgICAgICAgICAnMHg3ZmM2NjUwMGM4NGE3NmFkN2U5YzkzNDM3YmZjNWFjMzNlMmRkYWU5JywgLy8gQUFWRVxyXG4gICAgICAgICAgICAnMHhhMGI4Njk5MWM2MjE4YjM2YzFkMTlkNGEyZTllYjBjZTM2MDZlYjQ4JywgLy8gVVNEQ1xyXG4gICAgICAgICAgICAnb3RjJyxcclxuICAgICAgICAgICAgdHJ1ZSxcclxuICAgICAgICApO1xyXG5cclxuICAgICAgICByZXR1cm4gZ2FzUmF0ZS50aW1lcyhnYXNFc3RpbWF0ZSk7XHJcbiAgICB9XHJcblxyXG4gICAgLyoqXHJcbiAgICAgKiBDYWxjdWxhdGVkIGJ5IGxvb2tpbmcgYXQgaGlzdG9yaWNhbCBkYXRhIGFuZCBzZWVpbmcgd2UgYXZlcmFnZSAxLjUgdHJhbnNhY3Rpb25zXHJcbiAgICAgKiBwZXIgam9iLiBUaGlzIG1lYW5zIHdlIGV4cGVjdCB0byBwYXkgMi43NSBHV0VJIHByaW9yaXR5IGZlZSBwbHVzIHRoZSBiYXNlIGZlZS5cclxuICAgICAqL1xyXG4gICAgcHVibGljIGFzeW5jIGdldEV4cGVjdGVkVHJhbnNhY3Rpb25HYXNSYXRlQXN5bmMoKTogUHJvbWlzZTxXZWlQZXJHYXM+IHtcclxuICAgICAgICBjb25zdCBiYXNlRmVlID0gYXdhaXQgdGhpcy5fZ2FzT3JhY2xlLmdldEJhc2VGZWVQZXJHYXNXZWlBc3luYygpO1xyXG4gICAgICAgIC8vIEN1cnJlbnRseSB3ZSBzdWJtaXQgYSAyIEdXRUkgdGlwIHRoZW4gbXVsdGlwbHkgaXQgYnkgMS41IHBlciBzdWJtaXNzaW9uXHJcbiAgICAgICAgLy8gVHJhZGVzIHRha2UgfjEuNSBzdWJtaXNzaW9ucyBvbiBhdmVyYWdlLCBzbyB0aGF0J3MgMi43NSBHV0VJXHJcbiAgICAgICAgY29uc3QgYXZnTWF4UHJpb3JpdHlGZWVQZXJHYXNSYXRlID0gMjc1MDAwMDAwMDtcclxuICAgICAgICByZXR1cm4gYmFzZUZlZS5wbHVzKGF2Z01heFByaW9yaXR5RmVlUGVyR2FzUmF0ZSkuaW50ZWdlclZhbHVlKEJpZ051bWJlci5ST1VORF9DRUlMKTtcclxuICAgIH1cclxuXHJcbiAgICAvKipcclxuICAgICAqIFRoZSBzdWJtaXNzaW9uIHN0cmF0ZWd5IHN0YXJ0cyB3aXRoIGEgbWF4UHJpb3JpdHlGZWUgb2YgMiBHV0VJIGFuZCBhZGRzXHJcbiAgICAgKiAyIHggdGhlIGJhc2UgZmVlIHRvIGdldCB0aGUgaW5pdGlhbCBtYXhGZWVQZXJHYXMuXHJcbiAgICAgKi9cclxuICAgIHB1YmxpYyBhc3luYyBnZXROZXh0QmlkQXN5bmMoXHJcbiAgICAgICAgc3VibWlzc2lvbkNvbnRleHQ6IFN1Ym1pc3Npb25Db250ZXh0PFxyXG4gICAgICAgICAgICBSZnFtVjJUcmFuc2FjdGlvblN1Ym1pc3Npb25FbnRpdHlbXSB8IE1ldGFUcmFuc2FjdGlvblN1Ym1pc3Npb25FbnRpdHlbXVxyXG4gICAgICAgID4gfCBudWxsLFxyXG4gICAgKTogUHJvbWlzZTx7IG1heEZlZVBlckdhczogQmlnTnVtYmVyOyBtYXhQcmlvcml0eUZlZVBlckdhczogQmlnTnVtYmVyIH0gfCBudWxsPiB7XHJcbiAgICAgICAgY29uc3QgYmFzZUZlZSA9IGF3YWl0IHRoaXMuX2dhc09yYWNsZS5nZXRCYXNlRmVlUGVyR2FzV2VpQXN5bmMoKTtcclxuICAgICAgICBpZiAoIXN1Ym1pc3Npb25Db250ZXh0KSB7XHJcbiAgICAgICAgICAgIC8vIE91ciBmaXJzdCBiaWQgaXMgMnggdGhlIGJhc2UgZmVlICsgMiBHV0VJIHRpcFxyXG4gICAgICAgICAgICBjb25zdCBpbml0aWFsTWF4UHJpb3JpdHlGZWVQZXJHYXMgPSBuZXcgQmlnTnVtYmVyKElOSVRJQUxfTUFYX1BSSU9SSVRZX0ZFRV9QRVJfR0FTX0dXRUkpLnRpbWVzKFxyXG4gICAgICAgICAgICAgICAgTWF0aC5wb3coMTAsIEdXRUlfREVDSU1BTFMpLFxyXG4gICAgICAgICAgICApO1xyXG4gICAgICAgICAgICByZXR1cm4ge1xyXG4gICAgICAgICAgICAgICAgbWF4UHJpb3JpdHlGZWVQZXJHYXM6IGluaXRpYWxNYXhQcmlvcml0eUZlZVBlckdhcyxcclxuICAgICAgICAgICAgICAgIG1heEZlZVBlckdhczogYmFzZUZlZS50aW1lcygyKS5wbHVzKGluaXRpYWxNYXhQcmlvcml0eUZlZVBlckdhcyksXHJcbiAgICAgICAgICAgIH07XHJcbiAgICAgICAgfVxyXG4gICAgICAgIGNvbnN0IHsgbWF4RmVlUGVyR2FzOiBvbGRNYXhGZWVQZXJHYXMsIG1heFByaW9yaXR5RmVlUGVyR2FzOiBvbGRNYXhQcmlvcml0eUZlZVBlckdhcyB9ID1cclxuICAgICAgICAgICAgc3VibWlzc2lvbkNvbnRleHQubWF4R2FzRmVlcztcclxuICAgICAgICBjb25zdCBuZXdNYXhQcmlvcml0eUZlZVBlckdhcyA9IG9sZE1heFByaW9yaXR5RmVlUGVyR2FzLnRpbWVzKE1BWF9QUklPUklUWV9GRUVfUEVSX0dBU19NVUxUSVBMSUVSKTtcclxuICAgICAgICBpZiAobmV3TWF4UHJpb3JpdHlGZWVQZXJHYXMuaXNHcmVhdGVyVGhhbk9yRXF1YWxUbyhNQVhfUFJJT1JJVFlfRkVFX1BFUl9HQVNfQ0FQKSkge1xyXG4gICAgICAgICAgICAvLyBXZSd2ZSByZWFjaGVkIG91ciBtYXg7IGRvbid0IHB1dCBpbiBhbnkgbmV3IHRyYW5zYWN0aW9uc1xyXG4gICAgICAgICAgICByZXR1cm4gbnVsbDtcclxuICAgICAgICB9XHJcbiAgICAgICAgLy8gVGhlIFJQQyBub2RlcyBzdGlsbCBuZWVkIGF0IGxlYXN0IGEgMC4xIGluY3JlYXNlIGluIGJvdGggdmFsdWVzIHRvIGFjY2VwdCB0aGUgbmV3IHRyYW5zYWN0aW9uLlxyXG4gICAgICAgIC8vIEZvciB0aGUgbmV3IG1heCBmZWUgcGVyIGdhcywgd2UnbGwgdGFrZSB0aGUgbWF4aW11bSBvZiBhIDAuMSBpbmNyZWFzZSBmcm9tIHRoZSBsYXN0IHZhbHVlXHJcbiAgICAgICAgLy8gb3IgdGhlIHZhbHVlIGZyb20gYW4gaW5jcmVhc2UgaW4gdGhlIGJhc2UgZmVlLlxyXG4gICAgICAgIGNvbnN0IG5ld01heEZlZVBlckdhcyA9IEJpZ051bWJlci5tYXgoXHJcbiAgICAgICAgICAgIG9sZE1heEZlZVBlckdhcy5tdWx0aXBsaWVkQnkoMS4xKSwgLy8gdHNsaW50OmRpc2FibGUtbGluZTogY3VzdG9tLW5vLW1hZ2ljLW51bWJlcnNcclxuICAgICAgICAgICAgYmFzZUZlZS5tdWx0aXBsaWVkQnkoMikucGx1cyhuZXdNYXhQcmlvcml0eUZlZVBlckdhcyksXHJcbiAgICAgICAgKTtcclxuICAgICAgICByZXR1cm4ge1xyXG4gICAgICAgICAgICBtYXhQcmlvcml0eUZlZVBlckdhczogbmV3TWF4UHJpb3JpdHlGZWVQZXJHYXMuaW50ZWdlclZhbHVlKEJpZ051bWJlci5ST1VORF9DRUlMKSxcclxuICAgICAgICAgICAgbWF4RmVlUGVyR2FzOiBuZXdNYXhGZWVQZXJHYXMuaW50ZWdlclZhbHVlKEJpZ051bWJlci5ST1VORF9DRUlMKSxcclxuICAgICAgICB9O1xyXG4gICAgfVxyXG59XHJcbiJdLCJ2ZXJzaW9uIjozfQ==