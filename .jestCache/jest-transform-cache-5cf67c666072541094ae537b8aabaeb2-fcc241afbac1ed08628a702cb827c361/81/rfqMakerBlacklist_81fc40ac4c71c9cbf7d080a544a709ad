f9485424d9f595ccc1d2404993819a84
"use strict";
Object.defineProperty(exports, "__esModule", { value: true });
exports.RfqMakerBlacklist = void 0;
/**
 * Tracks a maker's history of timely responses, and manages whether a given
 * maker should be avoided for being too latent.
 */
const constants_1 = require("../core/constants");
const logger_1 = require("../logger");
class RfqMakerBlacklist {
    constructor(_blacklistDurationMinutes, _timeoutStreakThreshold) {
        this._blacklistDurationMinutes = _blacklistDurationMinutes;
        this._timeoutStreakThreshold = _timeoutStreakThreshold;
        this._makerTimeoutStreakLength = {};
        this._makerBlacklistedUntilDate = {};
    }
    logTimeoutOrLackThereof(makerUrl, didTimeout) {
        // $eslint-fix-me https://github.com/rhinodavid/eslint-fix-me
        // eslint-disable-next-line no-prototype-builtins
        if (!this._makerTimeoutStreakLength.hasOwnProperty(makerUrl)) {
            this._makerTimeoutStreakLength[makerUrl] = 0;
        }
        if (didTimeout) {
            this._makerTimeoutStreakLength[makerUrl] += 1;
            if (this._makerTimeoutStreakLength[makerUrl] === this._timeoutStreakThreshold) {
                const blacklistEnd = Date.now() + this._blacklistDurationMinutes * constants_1.ONE_MINUTE_MS;
                this._makerBlacklistedUntilDate[makerUrl] = blacklistEnd;
                logger_1.logger.info({ makerUrl, blacklistedUntil: new Date(blacklistEnd).toISOString() }, 'maker blacklisted');
            }
        }
        else {
            this._makerTimeoutStreakLength[makerUrl] = 0;
        }
    }
    isMakerBlacklisted(makerUrl) {
        const now = Date.now();
        if (now > this._makerBlacklistedUntilDate[makerUrl]) {
            delete this._makerBlacklistedUntilDate[makerUrl];
            logger_1.logger.info({ makerUrl }, 'maker unblacklisted');
        }
        return this._makerBlacklistedUntilDate[makerUrl] > now;
    }
}
exports.RfqMakerBlacklist = RfqMakerBlacklist;
//# sourceMappingURL=data:application/json;charset=utf-8;base64,eyJmaWxlIjoiL1VzZXJzL2Rhdmlkd2Fsc2gvY29kZS1sb2NhbC8weC1yZnEtYXBpL3NyYy9xdW90ZVJlcXVlc3Rvci9yZnFNYWtlckJsYWNrbGlzdC50cyIsIm1hcHBpbmdzIjoiOzs7QUFBQTs7O0dBR0c7QUFFSCxpREFBa0Q7QUFDbEQsc0NBQW1DO0FBRW5DLE1BQWEsaUJBQWlCO0lBRzFCLFlBQ3FCLHlCQUFpQyxFQUNqQyx1QkFBK0I7UUFEL0IsOEJBQXlCLEdBQXpCLHlCQUF5QixDQUFRO1FBQ2pDLDRCQUF1QixHQUF2Qix1QkFBdUIsQ0FBUTtRQUpuQyw4QkFBeUIsR0FBbUMsRUFBRSxDQUFDO1FBQy9ELCtCQUEwQixHQUFtQyxFQUFFLENBQUM7SUFJOUUsQ0FBQztJQUNHLHVCQUF1QixDQUFDLFFBQWdCLEVBQUUsVUFBbUI7UUFDaEUsNkRBQTZEO1FBQzdELGlEQUFpRDtRQUNqRCxJQUFJLENBQUMsSUFBSSxDQUFDLHlCQUF5QixDQUFDLGNBQWMsQ0FBQyxRQUFRLENBQUMsRUFBRTtZQUMxRCxJQUFJLENBQUMseUJBQXlCLENBQUMsUUFBUSxDQUFDLEdBQUcsQ0FBQyxDQUFDO1NBQ2hEO1FBQ0QsSUFBSSxVQUFVLEVBQUU7WUFDWixJQUFJLENBQUMseUJBQXlCLENBQUMsUUFBUSxDQUFDLElBQUksQ0FBQyxDQUFDO1lBQzlDLElBQUksSUFBSSxDQUFDLHlCQUF5QixDQUFDLFFBQVEsQ0FBQyxLQUFLLElBQUksQ0FBQyx1QkFBdUIsRUFBRTtnQkFDM0UsTUFBTSxZQUFZLEdBQUcsSUFBSSxDQUFDLEdBQUcsRUFBRSxHQUFHLElBQUksQ0FBQyx5QkFBeUIsR0FBRyx5QkFBYSxDQUFDO2dCQUNqRixJQUFJLENBQUMsMEJBQTBCLENBQUMsUUFBUSxDQUFDLEdBQUcsWUFBWSxDQUFDO2dCQUN6RCxlQUFNLENBQUMsSUFBSSxDQUFDLEVBQUUsUUFBUSxFQUFFLGdCQUFnQixFQUFFLElBQUksSUFBSSxDQUFDLFlBQVksQ0FBQyxDQUFDLFdBQVcsRUFBRSxFQUFFLEVBQUUsbUJBQW1CLENBQUMsQ0FBQzthQUMxRztTQUNKO2FBQU07WUFDSCxJQUFJLENBQUMseUJBQXlCLENBQUMsUUFBUSxDQUFDLEdBQUcsQ0FBQyxDQUFDO1NBQ2hEO0lBQ0wsQ0FBQztJQUNNLGtCQUFrQixDQUFDLFFBQWdCO1FBQ3RDLE1BQU0sR0FBRyxHQUFHLElBQUksQ0FBQyxHQUFHLEVBQUUsQ0FBQztRQUN2QixJQUFJLEdBQUcsR0FBRyxJQUFJLENBQUMsMEJBQTBCLENBQUMsUUFBUSxDQUFDLEVBQUU7WUFDakQsT0FBTyxJQUFJLENBQUMsMEJBQTBCLENBQUMsUUFBUSxDQUFDLENBQUM7WUFDakQsZUFBTSxDQUFDLElBQUksQ0FBQyxFQUFFLFFBQVEsRUFBRSxFQUFFLHFCQUFxQixDQUFDLENBQUM7U0FDcEQ7UUFDRCxPQUFPLElBQUksQ0FBQywwQkFBMEIsQ0FBQyxRQUFRLENBQUMsR0FBRyxHQUFHLENBQUM7SUFDM0QsQ0FBQztDQUNKO0FBaENELDhDQWdDQyIsIm5hbWVzIjpbXSwic291cmNlcyI6WyIvVXNlcnMvZGF2aWR3YWxzaC9jb2RlLWxvY2FsLzB4LXJmcS1hcGkvc3JjL3F1b3RlUmVxdWVzdG9yL3JmcU1ha2VyQmxhY2tsaXN0LnRzIl0sInNvdXJjZXNDb250ZW50IjpbIi8qKlxuICogVHJhY2tzIGEgbWFrZXIncyBoaXN0b3J5IG9mIHRpbWVseSByZXNwb25zZXMsIGFuZCBtYW5hZ2VzIHdoZXRoZXIgYSBnaXZlblxuICogbWFrZXIgc2hvdWxkIGJlIGF2b2lkZWQgZm9yIGJlaW5nIHRvbyBsYXRlbnQuXG4gKi9cblxuaW1wb3J0IHsgT05FX01JTlVURV9NUyB9IGZyb20gJy4uL2NvcmUvY29uc3RhbnRzJztcbmltcG9ydCB7IGxvZ2dlciB9IGZyb20gJy4uL2xvZ2dlcic7XG5cbmV4cG9ydCBjbGFzcyBSZnFNYWtlckJsYWNrbGlzdCB7XG4gICAgcHJpdmF0ZSByZWFkb25seSBfbWFrZXJUaW1lb3V0U3RyZWFrTGVuZ3RoOiB7IFttYWtlclVybDogc3RyaW5nXTogbnVtYmVyIH0gPSB7fTtcbiAgICBwcml2YXRlIHJlYWRvbmx5IF9tYWtlckJsYWNrbGlzdGVkVW50aWxEYXRlOiB7IFttYWtlclVybDogc3RyaW5nXTogbnVtYmVyIH0gPSB7fTtcbiAgICBjb25zdHJ1Y3RvcihcbiAgICAgICAgcHJpdmF0ZSByZWFkb25seSBfYmxhY2tsaXN0RHVyYXRpb25NaW51dGVzOiBudW1iZXIsXG4gICAgICAgIHByaXZhdGUgcmVhZG9ubHkgX3RpbWVvdXRTdHJlYWtUaHJlc2hvbGQ6IG51bWJlciwgLy8gIHB1YmxpYyBpbmZvTG9nZ2VyOiBMb2dGdW5jdGlvbiA9IGNvbnN0YW50cy5ERUZBVUxUX0lORk9fTE9HR0VSLFxuICAgICkge31cbiAgICBwdWJsaWMgbG9nVGltZW91dE9yTGFja1RoZXJlb2YobWFrZXJVcmw6IHN0cmluZywgZGlkVGltZW91dDogYm9vbGVhbik6IHZvaWQge1xuICAgICAgICAvLyAkZXNsaW50LWZpeC1tZSBodHRwczovL2dpdGh1Yi5jb20vcmhpbm9kYXZpZC9lc2xpbnQtZml4LW1lXG4gICAgICAgIC8vIGVzbGludC1kaXNhYmxlLW5leHQtbGluZSBuby1wcm90b3R5cGUtYnVpbHRpbnNcbiAgICAgICAgaWYgKCF0aGlzLl9tYWtlclRpbWVvdXRTdHJlYWtMZW5ndGguaGFzT3duUHJvcGVydHkobWFrZXJVcmwpKSB7XG4gICAgICAgICAgICB0aGlzLl9tYWtlclRpbWVvdXRTdHJlYWtMZW5ndGhbbWFrZXJVcmxdID0gMDtcbiAgICAgICAgfVxuICAgICAgICBpZiAoZGlkVGltZW91dCkge1xuICAgICAgICAgICAgdGhpcy5fbWFrZXJUaW1lb3V0U3RyZWFrTGVuZ3RoW21ha2VyVXJsXSArPSAxO1xuICAgICAgICAgICAgaWYgKHRoaXMuX21ha2VyVGltZW91dFN0cmVha0xlbmd0aFttYWtlclVybF0gPT09IHRoaXMuX3RpbWVvdXRTdHJlYWtUaHJlc2hvbGQpIHtcbiAgICAgICAgICAgICAgICBjb25zdCBibGFja2xpc3RFbmQgPSBEYXRlLm5vdygpICsgdGhpcy5fYmxhY2tsaXN0RHVyYXRpb25NaW51dGVzICogT05FX01JTlVURV9NUztcbiAgICAgICAgICAgICAgICB0aGlzLl9tYWtlckJsYWNrbGlzdGVkVW50aWxEYXRlW21ha2VyVXJsXSA9IGJsYWNrbGlzdEVuZDtcbiAgICAgICAgICAgICAgICBsb2dnZXIuaW5mbyh7IG1ha2VyVXJsLCBibGFja2xpc3RlZFVudGlsOiBuZXcgRGF0ZShibGFja2xpc3RFbmQpLnRvSVNPU3RyaW5nKCkgfSwgJ21ha2VyIGJsYWNrbGlzdGVkJyk7XG4gICAgICAgICAgICB9XG4gICAgICAgIH0gZWxzZSB7XG4gICAgICAgICAgICB0aGlzLl9tYWtlclRpbWVvdXRTdHJlYWtMZW5ndGhbbWFrZXJVcmxdID0gMDtcbiAgICAgICAgfVxuICAgIH1cbiAgICBwdWJsaWMgaXNNYWtlckJsYWNrbGlzdGVkKG1ha2VyVXJsOiBzdHJpbmcpOiBib29sZWFuIHtcbiAgICAgICAgY29uc3Qgbm93ID0gRGF0ZS5ub3coKTtcbiAgICAgICAgaWYgKG5vdyA+IHRoaXMuX21ha2VyQmxhY2tsaXN0ZWRVbnRpbERhdGVbbWFrZXJVcmxdKSB7XG4gICAgICAgICAgICBkZWxldGUgdGhpcy5fbWFrZXJCbGFja2xpc3RlZFVudGlsRGF0ZVttYWtlclVybF07XG4gICAgICAgICAgICBsb2dnZXIuaW5mbyh7IG1ha2VyVXJsIH0sICdtYWtlciB1bmJsYWNrbGlzdGVkJyk7XG4gICAgICAgIH1cbiAgICAgICAgcmV0dXJuIHRoaXMuX21ha2VyQmxhY2tsaXN0ZWRVbnRpbERhdGVbbWFrZXJVcmxdID4gbm93O1xuICAgIH1cbn1cbiJdLCJ2ZXJzaW9uIjozfQ==