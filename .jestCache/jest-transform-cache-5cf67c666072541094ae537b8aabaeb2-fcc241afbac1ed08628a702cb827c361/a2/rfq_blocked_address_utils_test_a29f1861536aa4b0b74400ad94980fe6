163ce198a5483d2dd0b272bf306ff019
"use strict";
Object.defineProperty(exports, "__esModule", { value: true });
const chai_1 = require("chai");
const constants_1 = require("../../src/core/constants");
const BlockedAddressEntity_1 = require("../../src/entities/BlockedAddressEntity");
const rfq_blocked_address_utils_1 = require("../../src/utils/rfq_blocked_address_utils");
const deployment_1 = require("../test_utils/deployment");
const initDbDataSourceAsync_1 = require("../test_utils/initDbDataSourceAsync");
const ttlMs = 50;
// tslint:disable-next-line: custom-no-magic-numbers
jest.setTimeout(constants_1.ONE_MINUTE_MS * 2);
let teardownDependencies;
describe('rfqBlockedAddressUtils', () => {
    let dataSource;
    let rfqBlacklistUtils;
    beforeAll(async () => {
        teardownDependencies = await (0, deployment_1.setupDependenciesAsync)(['postgres']);
        // tslint:disable-next-line: custom-no-magic-numbers
        dataSource = await (0, initDbDataSourceAsync_1.initDbDataSourceAsync)();
        rfqBlacklistUtils = new rfq_blocked_address_utils_1.RfqBlockedAddressUtils(dataSource, new Set(), ttlMs);
    });
    afterAll(async () => {
        const wasKilled = teardownDependencies();
        if (!wasKilled) {
            throw new Error('Dependencies failed to shut down');
        }
    });
    beforeEach(async () => {
        rfqBlacklistUtils = new rfq_blocked_address_utils_1.RfqBlockedAddressUtils(dataSource, new Set(), ttlMs);
    });
    afterEach(async () => {
        await dataSource.query('TRUNCATE TABLE blocked_addresses CASCADE;');
        await dataSource.query('TRUNCATE TABLE rfqm_jobs CASCADE;');
        await dataSource.query('TRUNCATE TABLE rfqm_quotes CASCADE;');
        await dataSource.query('TRUNCATE TABLE rfqm_transaction_submissions CASCADE;');
        await dataSource.query('TRUNCATE TABLE rfqm_v2_jobs CASCADE;');
        await dataSource.query('TRUNCATE TABLE rfqm_v2_quotes CASCADE;');
        await dataSource.query('TRUNCATE TABLE rfqm_v2_transaction_submissions CASCADE;');
    });
    describe('blocked_addresses table', () => {
        it('should only allow lower case insertions', async () => {
            const sampleBadAddress = '0xA10612Ee5432B6395d1F0d6fB2601299a1c64274';
            try {
                await dataSource.getRepository(BlockedAddressEntity_1.BlockedAddressEntity).save({
                    address: sampleBadAddress,
                });
                chai_1.expect.fail('should throw');
            }
            catch (err) {
                (0, chai_1.expect)(err.message).to.match(/violates check constraint/);
            }
            try {
                await dataSource.getRepository(BlockedAddressEntity_1.BlockedAddressEntity).save({
                    address: sampleBadAddress.toLowerCase(),
                });
            }
            catch (err) {
                chai_1.expect.fail('lower case should not throw');
            }
        });
    });
    it('should use stale values via isBlocked', async () => {
        const sampleBadAddress = '0xA10612Ee5432B6395d1F0d6fB2601299a1c64274';
        (0, chai_1.expect)(rfqBlacklistUtils.isBlocked(sampleBadAddress)).to.equal(false);
        // Add it to the blocked list
        await dataSource.getRepository(BlockedAddressEntity_1.BlockedAddressEntity).save({
            address: sampleBadAddress.toLowerCase(),
        });
        (0, chai_1.expect)(rfqBlacklistUtils.isBlocked(sampleBadAddress)).to.equal(false);
    });
    it('should use fresh values after the update is complete', async () => {
        const sampleBadAddress = '0xB10612Ee5432B6395d1F0d6fB2601299a1c64274';
        // Add it to the blocked list
        await dataSource.getRepository(BlockedAddressEntity_1.BlockedAddressEntity).save({
            address: sampleBadAddress.toLowerCase(),
        });
        // Initally not blocked
        const isBlocked_t0 = rfqBlacklistUtils.isBlocked(sampleBadAddress);
        (0, chai_1.expect)(isBlocked_t0).to.equal(false);
        // Await for the update to complete
        await rfqBlacklistUtils.completeUpdateAsync();
        // Now should be blocked
        const isBlocked_t1 = rfqBlacklistUtils.isBlocked(sampleBadAddress);
        (0, chai_1.expect)(isBlocked_t1).to.equal(true);
    });
    it('should be case insensitive', async () => {
        const sampleBadAddress = '0xC10612Ee5432B6395d1F0d6fB2601299a1c64274';
        await dataSource.getRepository(BlockedAddressEntity_1.BlockedAddressEntity).save({
            address: sampleBadAddress.toLowerCase(),
        });
        // Trigger the update and wait for completion
        rfqBlacklistUtils.isBlocked(sampleBadAddress);
        await rfqBlacklistUtils.completeUpdateAsync();
        const isChecksumBlocked = rfqBlacklistUtils.isBlocked(sampleBadAddress);
        const isLowerCaseBlocked = rfqBlacklistUtils.isBlocked(sampleBadAddress.toLowerCase());
        const isUpperCaseBlocked = rfqBlacklistUtils.isBlocked(sampleBadAddress.toUpperCase());
        (0, chai_1.expect)(isChecksumBlocked).to.equal(true);
        (0, chai_1.expect)(isLowerCaseBlocked).to.equal(true);
        (0, chai_1.expect)(isUpperCaseBlocked).to.equal(true);
    });
});
//# sourceMappingURL=data:application/json;charset=utf-8;base64,eyJmaWxlIjoiL1VzZXJzL2Rhdmlkd2Fsc2gvY29kZS1sb2NhbC8weC1yZnEtYXBpL3Rlc3QvdXRpbHMvcmZxX2Jsb2NrZWRfYWRkcmVzc191dGlsc190ZXN0LnRzIiwibWFwcGluZ3MiOiI7O0FBQUEsK0JBQThCO0FBRzlCLHdEQUF5RDtBQUN6RCxrRkFBK0U7QUFDL0UseUZBQW1GO0FBQ25GLHlEQUFzRztBQUN0RywrRUFBNEU7QUFFNUUsTUFBTSxLQUFLLEdBQUcsRUFBRSxDQUFDO0FBRWpCLG9EQUFvRDtBQUNwRCxJQUFJLENBQUMsVUFBVSxDQUFDLHlCQUFhLEdBQUcsQ0FBQyxDQUFDLENBQUM7QUFDbkMsSUFBSSxvQkFBd0QsQ0FBQztBQUU3RCxRQUFRLENBQUMsd0JBQXdCLEVBQUUsR0FBRyxFQUFFO0lBQ3BDLElBQUksVUFBc0IsQ0FBQztJQUMzQixJQUFJLGlCQUF5QyxDQUFDO0lBRTlDLFNBQVMsQ0FBQyxLQUFLLElBQUksRUFBRTtRQUNqQixvQkFBb0IsR0FBRyxNQUFNLElBQUEsbUNBQXNCLEVBQUMsQ0FBQyxVQUFVLENBQUMsQ0FBQyxDQUFDO1FBQ2xFLG9EQUFvRDtRQUNwRCxVQUFVLEdBQUcsTUFBTSxJQUFBLDZDQUFxQixHQUFFLENBQUM7UUFDM0MsaUJBQWlCLEdBQUcsSUFBSSxrREFBc0IsQ0FBQyxVQUFVLEVBQUUsSUFBSSxHQUFHLEVBQUUsRUFBRSxLQUFLLENBQUMsQ0FBQztJQUNqRixDQUFDLENBQUMsQ0FBQztJQUVILFFBQVEsQ0FBQyxLQUFLLElBQUksRUFBRTtRQUNoQixNQUFNLFNBQVMsR0FBRyxvQkFBb0IsRUFBRSxDQUFDO1FBQ3pDLElBQUksQ0FBQyxTQUFTLEVBQUU7WUFDWixNQUFNLElBQUksS0FBSyxDQUFDLGtDQUFrQyxDQUFDLENBQUM7U0FDdkQ7SUFDTCxDQUFDLENBQUMsQ0FBQztJQUVILFVBQVUsQ0FBQyxLQUFLLElBQUksRUFBRTtRQUNsQixpQkFBaUIsR0FBRyxJQUFJLGtEQUFzQixDQUFDLFVBQVUsRUFBRSxJQUFJLEdBQUcsRUFBRSxFQUFFLEtB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LENBQUMsQ0FBQyxFQUFFLENBQUMsS0FBSyxDQUFDLElBQUksQ0FBQyxDQUFDO0lBQzlDLENBQUMsQ0FBQyxDQUFDO0FBQ1AsQ0FBQyxDQUFDLENBQUMiLCJuYW1lcyI6W10sInNvdXJjZXMiOlsiL1VzZXJzL2Rhdmlkd2Fsc2gvY29kZS1sb2NhbC8weC1yZnEtYXBpL3Rlc3QvdXRpbHMvcmZxX2Jsb2NrZWRfYWRkcmVzc191dGlsc190ZXN0LnRzIl0sInNvdXJjZXNDb250ZW50IjpbImltcG9ydCB7IGV4cGVjdCB9IGZyb20gJ2NoYWknO1xuaW1wb3J0IHsgRGF0YVNvdXJjZSB9IGZyb20gJ3R5cGVvcm0nO1xuXG5pbXBvcnQgeyBPTkVfTUlOVVRFX01TIH0gZnJvbSAnLi4vLi4vc3JjL2NvcmUvY29uc3RhbnRzJztcbmltcG9ydCB7IEJsb2NrZWRBZGRyZXNzRW50aXR5IH0gZnJvbSAnLi4vLi4vc3JjL2VudGl0aWVzL0Jsb2NrZWRBZGRyZXNzRW50aXR5JztcbmltcG9ydCB7IFJmcUJsb2NrZWRBZGRyZXNzVXRpbHMgfSBmcm9tICcuLi8uLi9zcmMvdXRpbHMvcmZxX2Jsb2NrZWRfYWRkcmVzc191dGlscyc7XG5pbXBvcnQgeyBzZXR1cERlcGVuZGVuY2llc0FzeW5jLCBUZWFyZG93bkRlcGVuZGVuY2llc0Z1bmN0aW9uSGFuZGxlIH0gZnJvbSAnLi4vdGVzdF91dGlscy9kZXBsb3ltZW50JztcbmltcG9ydCB7IGluaXREYkRhdGFTb3VyY2VBc3luYyB9IGZyb20gJy4uL3Rlc3RfdXRpbHMvaW5pdERiRGF0YVNvdXJjZUFzeW5jJztcblxuY29uc3QgdHRsTXMgPSA1MDtcblxuLy8gdHNsaW50OmRpc2FibGUtbmV4dC1saW5lOiBjdXN0b20tbm8tbWFnaWMtbnVtYmVyc1xuamVzdC5zZXRUaW1lb3V0KE9ORV9NSU5VVEVfTVMgKiAyKTtcbmxldCB0ZWFyZG93bkRlcGVuZGVuY2llczogVGVhcmRvd25EZXBlbmRlbmNpZXNGdW5jdGlvbkhhbmRsZTtcblxuZGVzY3JpYmUoJ3JmcUJsb2NrZWRBZGRyZXNzVXRpbHMnLCAoKSA9PiB7XG4gICAgbGV0IGRhdGFTb3VyY2U6IERhdGFTb3VyY2U7XG4gICAgbGV0IHJmcUJsYWNrbGlzdFV0aWxzOiBSZnFCbG9ja2VkQWRkcmVzc1V0aWxzO1xuXG4gICAgYmVmb3JlQWxsKGFzeW5jICgpID0+IHtcbiAgICAgICAgdGVhcmRvd25EZXBlbmRlbmNpZXMgPSBhd2FpdCBzZXR1cERlcGVuZGVuY2llc0FzeW5jKFsncG9zdGdyZXMnXSk7XG4gICAgICAgIC8vIHRzbGludDpkaXNhYmxlLW5leHQtbGluZTogY3VzdG9tLW5vLW1hZ2ljLW51bWJlcnNcbiAgICAgICAgZGF0YVNvdXJjZSA9IGF3YWl0IGluaXREYkRhdGFTb3VyY2VBc3luYygpO1xuICAgICAgICByZnFCbGFja2xpc3RVdGlscyA9IG5ldyBSZnFCbG9ja2VkQWRkcmVzc1V0aWxzKGRhdGFTb3VyY2UsIG5ldyBTZXQoKSwgdHRsTXMpO1xuICAgIH0pO1xuXG4gICAgYWZ0ZXJBbGwoYXN5bmMgKCkgPT4ge1xuICAgICAgICBjb25zdCB3YXNLaWxsZWQgPSB0ZWFyZG93bkRlcGVuZGVuY2llcygpO1xuICAgICAgICBpZiAoIXdhc0tpbGxlZCkge1xuICAgICAgICAgICAgdGhyb3cgbmV3IEVycm9yKCdEZXBlbmRlbmNpZXMgZmFpbGVkIHRvIHNodXQgZG93bicpO1xuICAgICAgICB9XG4gICAgfSk7XG5cbiAgICBiZWZvcmVFYWNoKGFzeW5jICgpID0+IHtcbiAgICAgICAgcmZxQmxhY2tsaXN0VXRpbHMgPSBuZXcgUmZxQmxvY2tlZEFkZHJlc3NVdGlscyhkYXRhU291cmNlLCBuZXcgU2V0KCksIHR0bE1zKTtcbiAgICB9KTtcblxuICAgIGFmdGVyRWFjaChhc3luYyAoKSA9PiB7XG4gICAgICAgIGF3YWl0IGRhdGFTb3VyY2UucXVlcnkoJ1RSVU5DQVRFIFRBQkxFIGJsb2NrZWRfYWRkcmVzc2VzIENBU0NBREU7Jyk7XG4gICAgICAgIGF3YWl0IGRhdGFTb3VyY2UucXVlcnkoJ1RSVU5DQVRFIFRBQkxFIHJmcW1fam9icyBDQVNDQURFOycpO1xuICAgICAgICBhd2FpdCBkYXRhU291cmNlLnF1ZXJ5KCdUUlVOQ0FURSBUQUJMRSByZnFtX3F1b3RlcyBDQVNDQURFOycpO1xuICAgICAgICBhd2FpdCBkYXRhU291cmNlLnF1ZXJ5KCdUUlVOQ0FURSBUQUJMRSByZnFtX3RyYW5zYWN0aW9uX3N1Ym1pc3Npb25zIENBU0NBREU7Jyk7XG4gICAgICAgIGF3YWl0IGRhdGFTb3VyY2UucXVlcnkoJ1RSVU5DQVRFIFRBQkxFIHJmcW1fdjJfam9icyBDQVNDQURFOycpO1xuICAgICAgICBhd2FpdCBkYXRhU291cmNlLnF1ZXJ5KCdUUlVOQ0FURSBUQUJMRSByZnFtX3YyX3F1b3RlcyBDQVNDQURFOycpO1xuICAgICAgICBhd2FpdCBkYXRhU291cmNlLnF1ZXJ5KCdUUlVOQ0FURSBUQUJMRSByZnFtX3YyX3RyYW5zYWN0aW9uX3N1Ym1pc3Npb25zIENBU0NBREU7Jyk7XG4gICAgfSk7XG5cbiAgICBkZXNjcmliZSgnYmxvY2tlZF9hZGRyZXNzZXMgdGFibGUnLCAoKSA9PiB7XG4gICAgICAgIGl0KCdzaG91bGQgb25seSBhbGxvdyBsb3dlciBjYXNlIGluc2VydGlvbnMnLCBhc3luYyAoKSA9PiB7XG4gICAgICAgICAgICBjb25zdCBzYW1wbGVCYWRBZGRyZXNzID0gJzB4QTEwNjEyRWU1NDMyQjYzOTVkMUYwZDZmQjI2MDEyOTlhMWM2NDI3NCc7XG5cbiAgICAgICAgICAgIHRyeSB7XG4gICAgICAgICAgICAgICAgYXdhaXQgZGF0YVNvdXJjZS5nZXRSZXBvc2l0b3J5KEJsb2NrZWRBZGRyZXNzRW50aXR5KS5zYXZlKHtcbiAgICAgICAgICAgICAgICAgICAgYWRkcmVzczogc2FtcGxlQmFkQWRkcmVzcyxcbiAgICAgICAgICAgICAgICB9KTtcbiAgICAgICAgICAgICAgICBleHBlY3QuZmFpbCgnc2hvdWxkIHRocm93Jyk7XG4gICAgICAgICAgICB9IGNhdGNoIChlcnIpIHtcbiAgICAgICAgICAgICAgICBleHBlY3QoZXJyLm1lc3NhZ2UpLnRvLm1hdGNoKC92aW9sYXRlcyBjaGVjayBjb25zdHJhaW50Lyk7XG4gICAgICAgICAgICB9XG5cbiAgICAgICAgICAgIHRyeSB7XG4gICAgICAgICAgICAgICAgYXdhaXQgZGF0YVNvdXJjZS5nZXRSZXBvc2l0b3J5KEJsb2NrZWRBZGRyZXNzRW50aXR5KS5zYXZlKHtcbiAgICAgICAgICAgICAgICAgICAgYWRkcmVzczogc2FtcGxlQmFkQWRkcmVzcy50b0xvd2VyQ2FzZSgpLFxuICAgICAgICAgICAgICAgIH0pO1xuICAgICAgICAgICAgfSBjYXRjaCAoZXJyKSB7XG4gICAgICAgICAgICAgICAgZXhwZWN0LmZhaWwoJ2xvd2VyIGNhc2Ugc2hvdWxkIG5vdCB0aHJvdycpO1xuICAgICAgICAgICAgfVxuICAgICAgICB9KTtcbiAgICB9KTtcblxuICAgIGl0KCdzaG91bGQgdXNlIHN0YWxlIHZhbHVlcyB2aWEgaXNCbG9ja2VkJywgYXN5bmMgKCkgPT4ge1xuICAgICAgICBjb25zdCBzYW1wbGVCYWRBZGRyZXNzID0gJzB4QTEwNjEyRWU1NDMyQjYzOTVkMUYwZDZmQjI2MDEyOTlhMWM2NDI3NCc7XG4gICAgICAgIGV4cGVjdChyZnFCbGFja2xpc3RVdGlscy5pc0Jsb2NrZWQoc2FtcGxlQmFkQWRkcmVzcykpLnRvLmVxdWFsKGZhbHNlKTtcblxuICAgICAgICAvLyBBZGQgaXQgdG8gdGhlIGJsb2NrZWQgbGlzdFxuICAgICAgICBhd2FpdCBkYXRhU291cmNlLmdldFJlcG9zaXRvcnkoQmxvY2tlZEFkZHJlc3NFbnRpdHkpLnNhdmUoe1xuICAgICAgICAgICAgYWRkcmVzczogc2FtcGxlQmFkQWRkcmVzcy50b0xvd2VyQ2FzZSgpLFxuICAgICAgICB9KTtcblxuICAgICAgICBleHBlY3QocmZxQmxhY2tsaXN0VXRpbHMuaXNCbG9ja2VkKHNhbXBsZUJhZEFkZHJlc3MpKS50by5lcXVhbChmYWxzZSk7XG4gICAgfSk7XG5cbiAgICBpdCgnc2hvdWxkIHVzZSBmcmVzaCB2YWx1ZXMgYWZ0ZXIgdGhlIHVwZGF0ZSBpcyBjb21wbGV0ZScsIGFzeW5jICgpID0+IHtcbiAgICAgICAgY29uc3Qgc2FtcGxlQmFkQWRkcmVzcyA9ICcweEIxMDYxMkVlNTQzMkI2Mzk1ZDFGMGQ2ZkIyNjAxMjk5YTFjNjQyNzQnO1xuXG4gICAgICAgIC8vIEFkZCBpdCB0byB0aGUgYmxvY2tlZCBsaXN0XG4gICAgICAgIGF3YWl0IGRhdGFTb3VyY2UuZ2V0UmVwb3NpdG9yeShCbG9ja2VkQWRkcmVzc0VudGl0eSkuc2F2ZSh7XG4gICAgICAgICAgICBhZGRyZXNzOiBzYW1wbGVCYWRBZGRyZXNzLnRvTG93ZXJDYXNlKCksXG4gICAgICAgIH0pO1xuXG4gICAgICAgIC8vIEluaXRhbGx5IG5vdCBibG9ja2VkXG4gICAgICAgIGNvbnN0IGlzQmxvY2tlZF90MCA9IHJmcUJsYWNrbGlzdFV0aWxzLmlzQmxvY2tlZChzYW1wbGVCYWRBZGRyZXNzKTtcbiAgICAgICAgZXhwZWN0KGlzQmxvY2tlZF90MCkudG8uZXF1YWwoZmFsc2UpO1xuXG4gICAgICAgIC8vIEF3YWl0IGZvciB0aGUgdXBkYXRlIHRvIGNvbXBsZXRlXG4gICAgICAgIGF3YWl0IHJmcUJsYWNrbGlzdFV0aWxzLmNvbXBsZXRlVXBkYXRlQXN5bmMoKTtcblxuICAgICAgICAvLyBOb3cgc2hvdWxkIGJlIGJsb2NrZWRcbiAgICAgICAgY29uc3QgaXNCbG9ja2VkX3QxID0gcmZxQmxhY2tsaXN0VXRpbHMuaXNCbG9ja2VkKHNhbXBsZUJhZEFkZHJlc3MpO1xuICAgICAgICBleHBlY3QoaXNCbG9ja2VkX3QxKS50by5lcXVhbCh0cnVlKTtcbiAgICB9KTtcblxuICAgIGl0KCdzaG91bGQgYmUgY2FzZSBpbnNlbnNpdGl2ZScsIGFzeW5jICgpID0+IHtcbiAgICAgICAgY29uc3Qgc2FtcGxlQmFkQWRkcmVzcyA9ICcweEMxMDYxMkVlNTQzMkI2Mzk1ZDFGMGQ2ZkIyNjAxMjk5YTFjNjQyNzQnO1xuICAgICAgICBhd2FpdCBkYXRhU291cmNlLmdldFJlcG9zaXRvcnkoQmxvY2tlZEFkZHJlc3NFbnRpdHkpLnNhdmUoe1xuICAgICAgICAgICAgYWRkcmVzczogc2FtcGxlQmFkQWRkcmVzcy50b0xvd2VyQ2FzZSgpLFxuICAgICAgICB9KTtcblxuICAgICAgICAvLyBUcmlnZ2VyIHRoZSB1cGRhdGUgYW5kIHdhaXQgZm9yIGNvbXBsZXRpb25cbiAgICAgICAgcmZxQmxhY2tsaXN0VXRpbHMuaXNCbG9ja2VkKHNhbXBsZUJhZEFkZHJlc3MpO1xuICAgICAgICBhd2FpdCByZnFCbGFja2xpc3RVdGlscy5jb21wbGV0ZVVwZGF0ZUFzeW5jKCk7XG5cbiAgICAgICAgY29uc3QgaXNDaGVja3N1bUJsb2NrZWQgPSByZnFCbGFja2xpc3RVdGlscy5pc0Jsb2NrZWQoc2FtcGxlQmFkQWRkcmVzcyk7XG4gICAgICAgIGNvbnN0IGlzTG93ZXJDYXNlQmxvY2tlZCA9IHJmcUJsYWNrbGlzdFV0aWxzLmlzQmxvY2tlZChzYW1wbGVCYWRBZGRyZXNzLnRvTG93ZXJDYXNlKCkpO1xuICAgICAgICBjb25zdCBpc1VwcGVyQ2FzZUJsb2NrZWQgPSByZnFCbGFja2xpc3RVdGlscy5pc0Jsb2NrZWQoc2FtcGxlQmFkQWRkcmVzcy50b1VwcGVyQ2FzZSgpKTtcblxuICAgICAgICBleHBlY3QoaXNDaGVja3N1bUJsb2NrZWQpLnRvLmVxdWFsKHRydWUpO1xuICAgICAgICBleHBlY3QoaXNMb3dlckNhc2VCbG9ja2VkKS50by5lcXVhbCh0cnVlKTtcbiAgICAgICAgZXhwZWN0KGlzVXBwZXJDYXNlQmxvY2tlZCkudG8uZXF1YWwodHJ1ZSk7XG4gICAgfSk7XG59KTtcbi8vIHRzbGludDpkaXNhYmxlLWxpbmU6bWF4LWZpbGUtbGluZS1jb3VudFxuIl0sInZlcnNpb24iOjN9