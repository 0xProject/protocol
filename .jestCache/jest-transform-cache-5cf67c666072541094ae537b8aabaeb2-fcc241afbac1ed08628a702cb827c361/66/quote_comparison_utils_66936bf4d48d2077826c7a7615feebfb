a492d60151edce3b775632aa1c7b5725
"use strict";
Object.defineProperty(exports, "__esModule", { value: true });
exports.getBestQuote = void 0;
const asset_swapper_1 = require("@0x/asset-swapper");
const prom_client_1 = require("prom-client");
const constants_1 = require("../core/constants");
const logger_1 = require("../logger");
const pair_utils_1 = require("../core/pair_utils");
const RFQM_MAKER_BLOCKED_FOR_LOW_MAKER_BALANCE = new prom_client_1.Counter({
    name: 'rfqm_maker_blocked_for_low_maker_balance',
    help: 'A maker get blocked because of low maker balance',
    labelNames: ['maker_uri', 'chain_id', 'pair_key'],
});
/**
 * Selects the best quote from an array of quotes.
 *
 * Ignores quotes that:
 *  - are for the wrong pair
 *  - cannot fill 100% of the requested amount
 *  - expire in less than the validity window
 *  - cannot be filled by the maker due to insufficient balances, if quotedMakerBalances is present
 *      (only for firm quotes)
 *
 * And selects the one with the best price.
 */
function getBestQuote(quotes, isSelling, takerToken, makerToken, assetFillAmount, validityWindowMs, quotedMakerBalances) {
    // If maker balances are provided, quotes in which maker addresses cannot provide sufficient
    // balances to fully fill the order are filtered out
    let isMakerFillablePredicate = (_q, _idx) => true;
    if (quotedMakerBalances) {
        if (quotes.length !== quotedMakerBalances.length) {
            throw new Error('Quotes do not match with provided maker balances');
        }
        isMakerFillablePredicate = (q, idx) => {
            if (isFirmQuote(q) && q.order.makerAmount.gt(quotedMakerBalances[idx])) {
                RFQM_MAKER_BLOCKED_FOR_LOW_MAKER_BALANCE.labels(q.makerUri, q.order.chainId.toString(), (0, pair_utils_1.toPairString)(getMakerToken(q), getTakerToken(q))).inc();
                logger_1.logger.warn({
                    maker: q.makerUri,
                    makerBalance: quotedMakerBalances[idx],
                    order: q.order,
                }, 'Quote has insufficient maker balance');
                return false;
            }
            return true;
        };
    }
    const validityWindowSeconds = validityWindowMs / constants_1.ONE_SECOND_MS;
    const sortedQuotes = quotes
        .filter(isMakerFillablePredicate)
        .filter((q) => getTakerToken(q) === takerToken && getMakerToken(q) === makerToken)
        .filter((q) => {
        const requestedAmount = isSelling ? getTakerAmount(q) : getMakerAmount(q);
        return requestedAmount.eq(assetFillAmount);
    })
        .filter((q) => !willQuoteExpireIn(q, validityWindowSeconds))
        .sort((a, b) => {
        // Want the most amount of maker tokens for each taker token
        const aPrice = getMakerAmount(a).div(getTakerAmount(a));
        const bPrice = getMakerAmount(b).div(getTakerAmount(b));
        return bPrice.minus(aPrice).toNumber();
    });
    // No quotes found
    if (sortedQuotes.length === 0) {
        return null;
    }
    // Get the best quote
    return sortedQuotes[0];
}
exports.getBestQuote = getBestQuote;
/// Private getter functions
const getTakerToken = (quote) => {
    return isFirmQuote(quote) ? quote.order.takerToken : quote.takerToken;
};
const getMakerToken = (quote) => {
    return isFirmQuote(quote) ? quote.order.makerToken : quote.makerToken;
};
const getTakerAmount = (quote) => {
    return isFirmQuote(quote) ? quote.order.takerAmount : quote.takerAmount;
};
const getMakerAmount = (quote) => {
    return isFirmQuote(quote) ? quote.order.makerAmount : quote.makerAmount;
};
const willQuoteExpireIn = (quote, secondsFromNow) => {
    if (isFirmQuote(quote)) {
        return quote.order.willExpire(secondsFromNow);
    }
    // Handle indicative quote
    const nowSeconds = new asset_swapper_1.BigNumber(Date.now()).div(constants_1.ONE_SECOND_MS);
    const expirationCutoff = nowSeconds.plus(secondsFromNow);
    return quote.expiry.lt(expirationCutoff);
};
const isFirmQuote = (quote) => {
    return quote.order !== undefined;
};
//# sourceMappingURL=data:application/json;charset=utf-8;base64,eyJmaWxlIjoiL1VzZXJzL2Rhdmlkd2Fsc2gvY29kZS1sb2NhbC8weC1yZnEtYXBpL3NyYy91dGlscy9xdW90ZV9jb21wYXJpc29uX3V0aWxzLnRzIiwibWFwcGluZ3MiOiI7OztBQUFBLHFEQUFvRTtBQUNwRSw2Q0FBc0M7QUFFdEMsaURBQWtEO0FBQ2xELHNDQUFtQztBQUduQyxtREFBa0Q7QUFFbEQsTUFBTSx3Q0FBd0MsR0FBRyxJQUFJLHFCQUFPLENBQUM7SUFDekQsSUFBSSxFQUFFLDBDQUEwQztJQUNoRCxJQUFJLEVBQUUsa0RBQWtEO0lBQ3hELFVBQVUsRUFBRSxDQUFDLFdBQVcsRUFBRSxVQUFVLEVBQUUsVUFBVSxDQUFDO0NBQ3BELENBQUMsQ0FBQztBQUVIOzs7Ozs7Ozs7OztHQVdHO0FBQ0gsU0FBZ0IsWUFBWSxDQUN4QixNQUFXLEVBQ1gsU0FBa0IsRUFDbEIsVUFBa0IsRUFDbEIsVUFBa0IsRUFDbEIsZUFBMEIsRUFDMUIsZ0JBQXdCLEVBQ3hCLG1CQUFpQztJQUVqQyw0RkFBNEY7SUFDNUYsb0RBQW9EO0lBQ3BELElBQUksd0JBQXdCLEdBQUcsQ0FBQyxFQUFLLEVBQUUsSUFBWSxFQUFFLEVBQUUsQ0FBQyxJQUFJLENBQUM7SUFDN0QsSUFBSSxtQkFBbUIsRUFBRTtRQUNyQixJQUFJLE1BQU0sQ0FBQyxNQUFNLEtBQUssbUJBQW1CLENBQUMsTUFBTSxFQUFFO1lBQzlDLE1BQU0sSUFBSSxLQUFLLENBQUMsa0RBQWtELENBQUMsQ0FBQztTQUN2RTtRQUNELHdCQUF3QixHQUFHLENBQUMsQ0FBSSxFQUFFLEdBQVcsRUFBRSxFQUFFO1lBQzdDLElBQUksV0FBVyxDQUFDLENBQUMsQ0FBQyxJQUFJLENBQUMsQ0FBQyxLQUFLLENBQUMsV0FBVyxDQUFDLEVBQUUsQ0FBQyxtQkFBbUIsQ0FBQyxHQUFHLENBQUMsQ0FBQyxFQUFFO2dCQUNwRSx3Q0FBd0MsQ0FBQyxNQUFNLENBQzNDLENBQUMsQ0FBQyxRQUFRLEVBQ1YsQ0FBQyxDQUFDLEtBQUssQ0FBQyxPQUFPLENBQUMsUUFBUSxFQUFF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RyxDQUFDLEtBQTBDLEVBQWEsRUFBRTtJQUM3RSxPQUFPLFdBQVcsQ0FBQyxLQUFLLENBQUMsQ0FBQyxDQUFDLENBQUMsS0FBSyxDQUFDLEtBQUssQ0FBQyxXQUFXLENBQUMsQ0FBQyxDQUFDLEtBQUssQ0FBQyxXQUFXLENBQUM7QUFDNUUsQ0FBQyxDQUFDO0FBRUYsTUFBTSxpQkFBaUIsR0FBRyxDQUFDLEtBQTBDLEVBQUUsY0FBc0IsRUFBVyxFQUFFO0lBQ3RHLElBQUksV0FBVyxDQUFDLEtBQUssQ0FBQyxFQUFFO1FBQ3BCLE9BQU8sS0FBSyxDQUFDLEtBQUssQ0FBQyxVQUFVLENBQUMsY0FBYyxDQUFDLENBQUM7S0FDakQ7SUFFRCwwQkFBMEI7SUFDMUIsTUFBTSxVQUFVLEdBQUcsSUFBSSx5QkFBUyxDQUFDLElBQUksQ0FBQyxHQUFHLEVBQUUsQ0FBQyxDQUFDLEdBQUcsQ0FBQyx5QkFBYSxDQUFDLENBQUM7SUFDaEUsTUFBTSxnQkFBZ0IsR0FBRyxVQUFVLENBQUMsSUFBSSxDQUFDLGNBQWMsQ0FBQyxDQUFDO0lBQ3pELE9BQU8sS0FBSyxDQUFDLE1BQU0sQ0FBQyxFQUFFLENBQUMsZ0JBQWdCLENBQUMsQ0FBQztBQUM3QyxDQUFDLENBQUM7QUFFRixNQUFNLFdBQVcsR0FBRyxDQUFDLEtBQTBDLEVBQXlCLEVBQUU7SUFDdEYsT0FBUSxLQUFzQixDQUFDLEtBQUssS0FBSyxTQUFTLENBQUM7QUFDdkQsQ0FBQyxDQUFDIiwibmFtZXMiOltdLCJzb3VyY2VzIjpbIi9Vc2Vycy9kYXZpZHdhbHNoL2NvZGUtbG9jYWwvMHgtcmZxLWFwaS9zcmMvdXRpbHMvcXVvdGVfY29tcGFyaXNvbl91dGlscy50cyJdLCJzb3VyY2VzQ29udGVudCI6WyJpbXBvcnQgeyBCaWdOdW1iZXIsIFY0UkZRSW5kaWNhdGl2ZVF1b3RlIH0gZnJvbSAnQDB4L2Fzc2V0LXN3YXBwZXInO1xyXG5pbXBvcnQgeyBDb3VudGVyIH0gZnJvbSAncHJvbS1jbGllbnQnO1xyXG5cclxuaW1wb3J0IHsgT05FX1NFQ09ORF9NUyB9IGZyb20gJy4uL2NvcmUvY29uc3RhbnRzJztcclxuaW1wb3J0IHsgbG9nZ2VyIH0gZnJvbSAnLi4vbG9nZ2VyJztcclxuaW1wb3J0IHsgRmlybU90Y1F1b3RlLCBJbmRpY2F0aXZlUXVvdGUgfSBmcm9tICcuLi9jb3JlL3R5cGVzJztcclxuXHJcbmltcG9ydCB7IHRvUGFpclN0cmluZyB9IGZyb20gJy4uL2NvcmUvcGFpcl91dGlscyc7XHJcblxyXG5jb25zdCBSRlFNX01BS0VSX0JMT0NLRURfRk9SX0xPV19NQUtFUl9CQUxBTkNFID0gbmV3IENvdW50ZXIoe1xyXG4gICAgbmFtZTogJ3JmcW1fbWFrZXJfYmxvY2tlZF9mb3JfbG93X21ha2VyX2JhbGFuY2UnLFxyXG4gICAgaGVscDogJ0EgbWFrZXIgZ2V0IGJsb2NrZWQgYmVjYXVzZSBvZiBsb3cgbWFrZXIgYmFsYW5jZScsXHJcbiAgICBsYWJlbE5hbWVzOiBbJ21ha2VyX3VyaScsICdjaGFpbl9pZCcsICdwYWlyX2tleSddLFxyXG59KTtcclxuXHJcbi8qKlxyXG4gKiBTZWxlY3RzIHRoZSBiZXN0IHF1b3RlIGZyb20gYW4gYXJyYXkgb2YgcXVvdGVzLlxyXG4gKlxyXG4gKiBJZ25vcmVzIHF1b3RlcyB0aGF0OlxyXG4gKiAgLSBhcmUgZm9yIHRoZSB3cm9uZyBwYWlyXHJcbiAqICAtIGNhbm5vdCBmaWxsIDEwMCUgb2YgdGhlIHJlcXVlc3RlZCBhbW91bnRcclxuICogIC0gZXhwaXJlIGluIGxlc3MgdGhhbiB0aGUgdmFsaWRpdHkgd2luZG93XHJcbiAqICAtIGNhbm5vdCBiZSBmaWxsZWQgYnkgdGhlIG1ha2VyIGR1ZSB0byBpbnN1ZmZpY2llbnQgYmFsYW5jZXMsIGlmIHF1b3RlZE1ha2VyQmFsYW5jZXMgaXMgcHJlc2VudFxyXG4gKiAgICAgIChvbmx5IGZvciBmaXJtIHF1b3RlcylcclxuICpcclxuICogQW5kIHNlbGVjdHMgdGhlIG9uZSB3aXRoIHRoZSBiZXN0IHByaWNlLlxyXG4gKi9cclxuZXhwb3J0IGZ1bmN0aW9uIGdldEJlc3RRdW90ZTxUIGV4dGVuZHMgSW5kaWNhdGl2ZVF1b3RlIHwgRmlybU90Y1F1b3RlPihcclxuICAgIHF1b3RlczogVFtdLFxyXG4gICAgaXNTZWxsaW5nOiBib29sZWFuLFxyXG4gICAgdGFrZXJUb2tlbjogc3RyaW5nLFxyXG4gICAgbWFrZXJUb2tlbjogc3RyaW5nLFxyXG4gICAgYXNzZXRGaWxsQW1vdW50OiBCaWdOdW1iZXIsXHJcbiAgICB2YWxpZGl0eVdpbmRvd01zOiBudW1iZXIsXHJcbiAgICBxdW90ZWRNYWtlckJhbGFuY2VzPzogQmlnTnVtYmVyW10sXHJcbik6IFQgfCBudWxsIHtcclxuICAgIC8vIElmIG1ha2VyIGJhbGFuY2VzIGFyZSBwcm92aWRlZCwgcXVvdGVzIGluIHdoaWNoIG1ha2VyIGFkZHJlc3NlcyBjYW5ub3QgcHJvdmlkZSBzdWZmaWNpZW50XHJcbiAgICAvLyBiYWxhbmNlcyB0byBmdWxseSBmaWxsIHRoZSBvcmRlciBhcmUgZmlsdGVyZWQgb3V0XHJcbiAgICBsZXQgaXNNYWtlckZpbGxhYmxlUHJlZGljYXRlID0gKF9xOiBULCBfaWR4OiBudW1iZXIpID0+IHRydWU7XHJcbiAgICBpZiAocXVvdGVkTWFrZXJCYWxhbmNlcykge1xyXG4gICAgICAgIGlmIChxdW90ZXMubGVuZ3RoICE9PSBxdW90ZWRNYWtlckJhbGFuY2VzLmxlbmd0aCkge1xyXG4gICAgICAgICAgICB0aHJvdyBuZXcgRXJyb3IoJ1F1b3RlcyBkbyBub3QgbWF0Y2ggd2l0aCBwcm92aWRlZCBtYWtlciBiYWxhbmNlcycpO1xyXG4gICAgICAgIH1cclxuICAgICAgICBpc01ha2VyRmlsbGFibGVQcmVkaWNhdGUgPSAocTogVCwgaWR4OiBudW1iZXIpID0+IHtcclxuICAgICAgICAgICAgaWYgKGlzRmlybVF1b3RlKHEpICYmIHEub3JkZXIubWFrZXJBbW91bnQuZ3QocXVvdGVkTWFrZXJCYWxhbmNlc1tpZHhdKSkge1xyXG4gICAgICAgICAgICAgICAgUkZRTV9NQUtFUl9CTE9DS0VEX0ZPUl9MT1dfTUFLRVJfQkFMQU5DRS5sYWJlbHMoXHJcbiAgICAgICAgICAgICAgICAgICAgcS5tYWtlclVyaSxcclxuICAgICAgICAgICAgICAgICAgICBxLm9yZGVyLmNoYWluSWQudG9TdHJpbmcoKSxcclxuICAgICAgICAgICAgICAgICAgICB0b1BhaXJTdHJpbmcoZ2V0TWFrZXJUb2tlbihxKSwgZ2V0VGFrZXJUb2tlbihxKSksXHJcbiAgICAgICAgICAgICAgICApLmluYygpO1xyXG4gICAgICAgICAgICAgICAgbG9nZ2VyLndhcm4oXHJcbiAgICAgICAgICAgICAgICAgICAge1xyXG4gICAgICAgICAgICAgICAgICAgICAgICBtYWtlcjogcS5tYWtlclVyaSxcclxuICAgICAgICAgICAgICAgICAgICAgICAgbWFrZXJCYWxhbmNlOiBxdW90ZWRNYWtlckJhbGFuY2VzW2lkeF0sXHJcbiAgICAgICAgICAgICAgICAgICAgICAgIG9yZGVyOiBxLm9yZGVyLFxyXG4gICAgICAgICAgICAgICAgICAgIH0sXHJcbiAgICAgICAgICAgICAgICAgICAgJ1F1b3RlIGhhcyBpbnN1ZmZpY2llbnQgbWFrZXIgYmFsYW5jZScsXHJcbiAgICAgICAgICAgICAgICApO1xyXG4gICAgICAgICAgICAgICAgcmV0dXJuIGZhbHNlO1xyXG4gICAgICAgICAgICB9XHJcbiAgICAgICAgICAgIHJldHVybiB0cnVlO1xyXG4gICAgICAgIH07XHJcbiAgICB9XHJcblxyXG4gICAgY29uc3QgdmFsaWRpdHlXaW5kb3dTZWNvbmRzID0gdmFsaWRpdHlXaW5kb3dNcyAvIE9ORV9TRUNPTkRfTVM7XHJcbiAgICBjb25zdCBzb3J0ZWRRdW90ZXMgPSBxdW90ZXNcclxuICAgICAgICAuZmlsdGVyKGlzTWFrZXJGaWxsYWJsZVByZWRpY2F0ZSlcclxuICAgICAgICAuZmlsdGVyKChxKSA9PiBnZXRUYWtlclRva2VuKHEpID09PSB0YWtlclRva2VuICYmIGdldE1ha2VyVG9rZW4ocSkgPT09IG1ha2VyVG9rZW4pXHJcbiAgICAgICAgLmZpbHRlcigocSkgPT4ge1xyXG4gICAgICAgICAgICBjb25zdCByZXF1ZXN0ZWRBbW91bnQgPSBpc1NlbGxpbmcgPyBnZXRUYWtlckFtb3VudChxKSA6IGdldE1ha2VyQW1vdW50KHEpO1xyXG4gICAgICAgICAgICByZXR1cm4gcmVxdWVzdGVkQW1vdW50LmVxKGFzc2V0RmlsbEFtb3VudCk7XHJcbiAgICAgICAgfSlcclxuICAgICAgICAuZmlsdGVyKChxKSA9PiAhd2lsbFF1b3RlRXhwaXJlSW4ocSwgdmFsaWRpdHlXaW5kb3dTZWNvbmRzKSlcclxuICAgICAgICAuc29ydCgoYSwgYikgPT4ge1xyXG4gICAgICAgICAgICAvLyBXYW50IHRoZSBtb3N0IGFtb3VudCBvZiBtYWtlciB0b2tlbnMgZm9yIGVhY2ggdGFrZXIgdG9rZW5cclxuICAgICAgICAgICAgY29uc3QgYVByaWNlID0gZ2V0TWFrZXJBbW91bnQoYSkuZGl2KGdldFRha2VyQW1vdW50KGEpKTtcclxuICAgICAgICAgICAgY29uc3QgYlByaWNlID0gZ2V0TWFrZXJBbW91bnQoYikuZGl2KGdldFRha2VyQW1vdW50KGIpKTtcclxuICAgICAgICAgICAgcmV0dXJuIGJQcmljZS5taW51cyhhUHJpY2UpLnRvTnVtYmVyKCk7XHJcbiAgICAgICAgfSk7XHJcblxyXG4gICAgLy8gTm8gcXVvdGVzIGZvdW5kXHJcbiAgICBpZiAoc29ydGVkUXVvdGVzLmxlbmd0aCA9PT0gMCkge1xyXG4gICAgICAgIHJldHVybiBudWxsO1xyXG4gICAgfVxyXG5cclxuICAgIC8vIEdldCB0aGUgYmVzdCBxdW90ZVxyXG4gICAgcmV0dXJuIHNvcnRlZFF1b3Rlc1swXTtcclxufVxyXG5cclxuLy8vIFByaXZhdGUgZ2V0dGVyIGZ1bmN0aW9uc1xyXG5cclxuY29uc3QgZ2V0VGFrZXJUb2tlbiA9IChxdW90ZTogVjRSRlFJbmRpY2F0aXZlUXVvdGUgfCBGaXJtT3RjUXVvdGUpOiBzdHJpbmcgPT4ge1xyXG4gICAgcmV0dXJuIGlzRmlybVF1b3RlKHF1b3RlKSA/IHF1b3RlLm9yZGVyLnRha2VyVG9rZW4gOiBxdW90ZS50YWtlclRva2VuO1xyXG59O1xyXG5cclxuY29uc3QgZ2V0TWFrZXJUb2tlbiA9IChxdW90ZTogVjRSRlFJbmRpY2F0aXZlUXVvdGUgfCBGaXJtT3RjUXVvdGUpOiBzdHJpbmcgPT4ge1xyXG4gICAgcmV0dXJuIGlzRmlybVF1b3RlKHF1b3RlKSA/IHF1b3RlLm9yZGVyLm1ha2VyVG9rZW4gOiBxdW90ZS5tYWtlclRva2VuO1xyXG59O1xyXG5cclxuY29uc3QgZ2V0VGFrZXJBbW91bnQgPSAocXVvdGU6IFY0UkZRSW5kaWNhdGl2ZVF1b3RlIHwgRmlybU90Y1F1b3RlKTogQmlnTnVtYmVyID0+IHtcclxuICAgIHJldHVybiBpc0Zpcm1RdW90ZShxdW90ZSkgPyBxdW90ZS5vcmRlci50YWtlckFtb3VudCA6IHF1b3RlLnRha2VyQW1vdW50O1xyXG59O1xyXG5cclxuY29uc3QgZ2V0TWFrZXJBbW91bnQgPSAocXVvdGU6IFY0UkZRSW5kaWNhdGl2ZVF1b3RlIHwgRmlybU90Y1F1b3RlKTogQmlnTnVtYmVyID0+IHtcclxuICAgIHJldHVybiBpc0Zpcm1RdW90ZShxdW90ZSkgPyBxdW90ZS5vcmRlci5tYWtlckFtb3VudCA6IHF1b3RlLm1ha2VyQW1vdW50O1xyXG59O1xyXG5cclxuY29uc3Qgd2lsbFF1b3RlRXhwaXJlSW4gPSAocXVvdGU6IFY0UkZRSW5kaWNhdGl2ZVF1b3RlIHwgRmlybU90Y1F1b3RlLCBzZWNvbmRzRnJvbU5vdzogbnVtYmVyKTogYm9vbGVhbiA9PiB7XHJcbiAgICBpZiAoaXNGaXJtUXVvdGUocXVvdGUpKSB7XHJcbiAgICAgICAgcmV0dXJuIHF1b3RlLm9yZGVyLndpbGxFeHBpcmUoc2Vjb25kc0Zyb21Ob3cpO1xyXG4gICAgfVxyXG5cclxuICAgIC8vIEhhbmRsZSBpbmRpY2F0aXZlIHF1b3RlXHJcbiAgICBjb25zdCBub3dTZWNvbmRzID0gbmV3IEJpZ051bWJlcihEYXRlLm5vdygpKS5kaXYoT05FX1NFQ09ORF9NUyk7XHJcbiAgICBjb25zdCBleHBpcmF0aW9uQ3V0b2ZmID0gbm93U2Vjb25kcy5wbHVzKHNlY29uZHNGcm9tTm93KTtcclxuICAgIHJldHVybiBxdW90ZS5leHBpcnkubHQoZXhwaXJhdGlvbkN1dG9mZik7XHJcbn07XHJcblxyXG5jb25zdCBpc0Zpcm1RdW90ZSA9IChxdW90ZTogVjRSRlFJbmRpY2F0aXZlUXVvdGUgfCBGaXJtT3RjUXVvdGUpOiBxdW90ZSBpcyBGaXJtT3RjUXVvdGUgPT4ge1xyXG4gICAgcmV0dXJuIChxdW90ZSBhcyBGaXJtT3RjUXVvdGUpLm9yZGVyICE9PSB1bmRlZmluZWQ7XHJcbn07XHJcbiJdLCJ2ZXJzaW9uIjozfQ==