915ccc1c4de451cfdb634dde84afaa83
"use strict";
Object.defineProperty(exports, "__esModule", { value: true });
const web3_wrapper_1 = require("@0x/web3-wrapper");
const chai_1 = require("chai");
const ethereum_types_1 = require("ethereum-types");
const ethers_1 = require("ethers");
const ts_mockito_1 = require("ts-mockito");
const constants_1 = require("../../src/core/constants");
const rfqm_worker_balance_utils_1 = require("../../src/utils/rfqm_worker_balance_utils");
let providerMock;
describe('RFQM Worker balance utils', () => {
    describe('isWorkerReadyAndAbleAsync', () => {
        beforeEach(() => {
            providerMock = (0, ts_mockito_1.mock)(ethers_1.providers.Web3Provider);
        });
        it('should assess the balance to trade', async () => {
            (0, ts_mockito_1.when)(providerMock.getTransactionCount(constants_1.NULL_ADDRESS)).thenResolve(0);
            (0, ts_mockito_1.when)(providerMock.getTransactionCount(constants_1.NULL_ADDRESS, (0, ts_mockito_1.anything)())).thenResolve(0);
            const tests = [
                [web3_wrapper_1.Web3Wrapper.toBaseUnitAmount(0.5, 18), web3_wrapper_1.Web3Wrapper.toBaseUnitAmount(120, 9), true],
                [web3_wrapper_1.Web3Wrapper.toBaseUnitAmount(0.05, 18), web3_wrapper_1.Web3Wrapper.toBaseUnitAmount(120, 9), false],
                [web3_wrapper_1.Web3Wrapper.toBaseUnitAmount(0.05, 18), web3_wrapper_1.Web3Wrapper.toBaseUnitAmount(100, 9), true],
            ];
            for (const test of tests) {
                const [balance, gasPrice, isSuccessful] = test;
                (0, chai_1.expect)(await (0, rfqm_worker_balance_utils_1.isWorkerReadyAndAbleAsync)((0, ts_mockito_1.instance)(providerMock), constants_1.NULL_ADDRESS, balance, gasPrice, constants_1.RFQM_TX_GAS_ESTIMATE)).to.eql(isSuccessful);
            }
        });
        it('should fail with an outstanding transaction', async () => {
            (0, ts_mockito_1.when)(providerMock.getTransactionCount(constants_1.NULL_ADDRESS)).thenResolve(0);
            (0, ts_mockito_1.when)(providerMock.getTransactionCount(constants_1.NULL_ADDRESS, ethereum_types_1.BlockParamLiteral.Pending)).thenResolve(1);
            (0, chai_1.expect)(await (0, rfqm_worker_balance_utils_1.isWorkerReadyAndAbleAsync)((0, ts_mockito_1.instance)(providerMock), constants_1.NULL_ADDRESS, web3_wrapper_1.Web3Wrapper.toBaseUnitAmount(10, 18), web3_wrapper_1.Web3Wrapper.toBaseUnitAmount(120, 9), constants_1.RFQM_TX_GAS_ESTIMATE)).to.eql(false);
        });
    });
});
//# sourceMappingURL=data:application/json;charset=utf-8;base64,eyJmaWxlIjoiL1VzZXJzL2Rhdmlkd2Fsc2gvY29kZS1sb2NhbC8weC1yZnEtYXBpL3Rlc3QvdXRpbHMvcmZxbV93b3JrZXJfdGVzdC50cyIsIm1hcHBpbmdzIjoiOztBQUtBLG1EQUErQztBQUMvQywrQkFBOEI7QUFDOUIsbURBQW1EO0FBQ25ELG1DQUFtQztBQUNuQywyQ0FBNEQ7QUFFNUQsd0RBQThFO0FBQzlFLHlGQUFzRjtBQUV0RixJQUFJLFlBQWdDLENBQUM7QUFFckMsUUFBUSxDQUFDLDJCQUEyQixFQUFFLEdBQUcsRUFBRTtJQUN2QyxRQUFRLENBQUMsMkJBQTJCLEVBQUUsR0FBRyxFQUFFO1FBQ3ZDLFVBQVUsQ0FBQyxHQUFHLEVBQUU7WUFDWixZQUFZLEdBQUcsSUFBQSxpQkFBSSxFQUFDLGtCQUFTLENBQUMsWUFBWSxDQUFDLENBQUM7UUFDaEQsQ0FBQyxDQUFDLENBQUM7UUFDSCxFQUFFLENBQUMsb0NBQW9DLEVBQUUsS0FBSyxJQUFJLEVBQUU7WUFDaEQsSUFBQSxpQkFBSSxFQUFDLFlBQVksQ0FBQyxtQkFBbUIsQ0FBQyx3QkFBWSxDQUFDLENBQUMsQ0FBQyxXQUFXLENBQUMsQ0FBQyxDQUFDLENBQUM7WUFDcEUsSUFBQSxpQkFBSSxFQUFDLFlBQVksQ0FBQyxtQkFBbUIsQ0FBQyx3QkFBWSxFQUFFLElBQUEscUJBQVEsR0FBRSxDQUFDLENBQUMsQ0FBQyxXQUFXLENBQUMsQ0FBQyxDQUFDLENBQUM7WUFDaEYsTUFBTSxLQUFLLEdBQXNDO2dCQUM3QyxDQUFDLDBCQUFXLENBQUMsZ0JBQWdCLENBQUMsR0FBRyxFQUFFLEVBQUUsQ0FBQyxFQUFFLDBCQUFXLENBQUMsZ0JBQWdCLENBQUMsR0FBRyxFQUFFLENBQUMsQ0FBQyxFQUFFLElBQUksQ0FBQztnQkFDbkYsQ0FBQywwQkFBVyxDQUFDLGdCQUFnQixDQUFDLElBQUksRUFBRSxFQUFFLENBQUMsRUFBRSwwQkFBVyxDQUFDLGdCQUFnQixDQUFDLEdBQUcsRUFBRSxDQUFDLENBQUMsRUFBRSxLQUFLLENBQUM7Z0JBQ3JGLENBQUMsMEJBQVcsQ0FBQyxnQkFBZ0IsQ0FBQyxJQUFJLEVBQUUsRUFBRSxDQUFDLEVBQUUsMEJBQVcsQ0FBQyxnQkFBZ0IsQ0FBQyxHQUFHLEVBQUUsQ0FBQyxDQUFDLEVBQUUsSUFBSSxDQUFDO2FBQ3ZGLENBQUM7WUFDRixLQUFLLE1BQU0sSUFBSSxJQUFJLEtBQUssRUFBRTtnQkFDdEIsTUFBTSxDQUFDLE9BQU8sRUFBRSxRQUFRLEVBQUUsWUFBWSxDQUFDLEdBQUcsSUFBSSxDQUFDO2dCQUMvQyxJQUFBLGFBQU0sRUFDRixNQUFNLElBQUEscURBQXlCLEVBQzNCLElBQUEscUJBQVEsRUFBQyxZQUFZLENBQUMsRUFDdEIsd0JBQVksRUFDWixPQUFPLEVBQ1AsUUFBUSxFQUNSLGdDQUFvQixDQUN2QixDQUNKLENBQUMsRUFBRSxDQUFDLEdBQUcsQ0FBQyxZQUFZLENBQUMsQ0FBQzthQUMxQjtRQUNMLENBQUMsQ0FBQyxDQUFDO1FBQ0gsRUFBRSxDQUFDLDZDQUE2QyxFQUFFLEtBQUssSUFBSSxFQUFFO1lBQ3pELElBQUEsaUJBQUksRUFBQyxZQUFZLENBQUMsbUJBQW1CLENBQUMsd0JBQVksQ0FBQyxDQUFDLENBQUMsV0FBVyxDQUFDLENBQUMsQ0FBQyxDQUFDO1lBQ3BFLElBQUEsaUJBQUksRUFBQyxZQUFZLENBQUMsbUJBQW1CLENBQUMsd0JBQVksRUFBRSxrQ0FBaUIsQ0FBQyxPQUFPLENBQUMsQ0FBQyxDQUFDLFdBQVcsQ0FBQyxDQUFDLENBQUMsQ0FBQztZQUUvRixJQUFBLGFBQU0sRUFDRixNQUFNLElBQUEscURBQXlCLEVBQzNCLElBQUEscUJBQVEsRUFBQyxZQUFZLENBQUMsRUFDdEIsd0JBQVksRUFDWiwwQkFBVyxDQUFDLGdCQUFnQixDQUFDLEVBQUUsRUFBRSxFQUFFLENBQUMsRUFDcEMsMEJBQVcsQ0FBQyxnQkFBZ0IsQ0FBQyxHQUFHLEVBQUUsQ0FBQyxDQUFDLEVBQ3BDLGdDQUFvQixDQUN2QixDQUNKLENBQUMsRUFBRSxDQUFDLEdBQUcsQ0FBQyxLQUFLLENBQUMsQ0FBQztRQUNwQixDQUFDLENBQUMsQ0FBQztJQUNQLENBQUMsQ0FBQyxDQUFDO0FBQ1AsQ0FBQyxDQUFDLENBQUMiLCJuYW1lcyI6W10sInNvdXJjZXMiOlsiL1VzZXJzL2Rhdmlkd2Fsc2gvY29kZS1sb2NhbC8weC1yZnEtYXBpL3Rlc3QvdXRpbHMvcmZxbV93b3JrZXJfdGVzdC50cyJdLCJzb3VyY2VzQ29udGVudCI6WyIvLyB0c2xpbnQ6ZGlzYWJsZTpjdXN0b20tbm8tbWFnaWMtbnVtYmVyc1xyXG4vLyB0c2xpbnQ6ZGlzYWJsZTpuby1lbXB0eVxyXG4vLyB0c2xpbnQ6ZGlzYWJsZTptYXgtZmlsZS1saW5lLWNvdW50XHJcblxyXG5pbXBvcnQgeyBCaWdOdW1iZXIgfSBmcm9tICdAMHgvdXRpbHMnO1xyXG5pbXBvcnQgeyBXZWIzV3JhcHBlciB9IGZyb20gJ0AweC93ZWIzLXdyYXBwZXInO1xyXG5pbXBvcnQgeyBleHBlY3QgfSBmcm9tICdjaGFpJztcclxuaW1wb3J0IHsgQmxvY2tQYXJhbUxpdGVyYWwgfSBmcm9tICdldGhlcmV1bS10eXBlcyc7XHJcbmltcG9ydCB7IHByb3ZpZGVycyB9IGZyb20gJ2V0aGVycyc7XHJcbmltcG9ydCB7IGFueXRoaW5nLCBpbnN0YW5jZSwgbW9jaywgd2hlbiB9IGZyb20gJ3RzLW1vY2tpdG8nO1xyXG5cclxuaW1wb3J0IHsgTlVMTF9BRERSRVNTLCBSRlFNX1RYX0dBU19FU1RJTUFURSB9IGZyb20gJy4uLy4uL3NyYy9jb3JlL2NvbnN0YW50cyc7XHJcbmltcG9ydCB7IGlzV29ya2VyUmVhZHlBbmRBYmxlQXN5bmMgfSBmcm9tICcuLi8uLi9zcmMvdXRpbHMvcmZxbV93b3JrZXJfYmFsYW5jZV91dGlscyc7XHJcblxyXG5sZXQgcHJvdmlkZXJNb2NrOiBwcm92aWRlcnMuUHJvdmlkZXI7XHJcblxyXG5kZXNjcmliZSgnUkZRTSBXb3JrZXIgYmFsYW5jZSB1dGlscycsICgpID0+IHtcclxuICAgIGRlc2NyaWJlKCdpc1dvcmtlclJlYWR5QW5kQWJsZUFzeW5jJywgKCkgPT4ge1xyXG4gICAgICAgIGJlZm9yZUVhY2goKCkgPT4ge1xyXG4gICAgICAgICAgICBwcm92aWRlck1vY2sgPSBtb2NrKHByb3ZpZGVycy5XZWIzUHJvdmlkZXIpO1xyXG4gICAgICAgIH0pO1xyXG4gICAgICAgIGl0KCdzaG91bGQgYXNzZXNzIHRoZSBiYWxhbmNlIHRvIHRyYWRlJywgYXN5bmMgKCkgPT4ge1xyXG4gICAgICAgICAgICB3aGVuKHByb3ZpZGVyTW9jay5nZXRUcmFuc2FjdGlvbkNvdW50KE5VTExfQUREUkVTUykpLnRoZW5SZXNvbHZlKDApO1xyXG4gICAgICAgICAgICB3aGVuKHByb3ZpZGVyTW9jay5nZXRUcmFuc2FjdGlvbkNvdW50KE5VTExfQUREUkVTUywgYW55dGhpbmcoKSkpLnRoZW5SZXNvbHZlKDApO1xyXG4gICAgICAgICAgICBjb25zdCB0ZXN0czogW0JpZ051bWJlciwgQmlnTnVtYmVyLCBib29sZWFuXVtdID0gW1xyXG4gICAgICAgICAgICAgICAgW1dlYjNXcmFwcGVyLnRvQmFzZVVuaXRBbW91bnQoMC41LCAxOCksIFdlYjNXcmFwcGVyLnRvQmFzZVVuaXRBbW91bnQoMTIwLCA5KSwgdHJ1ZV0sXHJcbiAgICAgICAgICAgICAgICBbV2ViM1dyYXBwZXIudG9CYXNlVW5pdEFtb3VudCgwLjA1LCAxOCksIFdlYjNXcmFwcGVyLnRvQmFzZVVuaXRBbW91bnQoMTIwLCA5KSwgZmFsc2VdLFxyXG4gICAgICAgICAgICAgICAgW1dlYjNXcmFwcGVyLnRvQmFzZVVuaXRBbW91bnQoMC4wNSwgMTgpLCBXZWIzV3JhcHBlci50b0Jhc2VVbml0QW1vdW50KDEwMCwgOSksIHRydWVdLFxyXG4gICAgICAgICAgICBdO1xyXG4gICAgICAgICAgICBmb3IgKGNvbnN0IHRlc3Qgb2YgdGVzdHMpIHtcclxuICAgICAgICAgICAgICAgIGNvbnN0IFtiYWxhbmNlLCBnYXNQcmljZSwgaXNTdWNjZXNzZnVsXSA9IHRlc3Q7XHJcbiAgICAgICAgICAgICAgICBleHBlY3QoXHJcbiAgICAgICAgICAgICAgICAgICAgYXdhaXQgaXNXb3JrZXJSZWFkeUFuZEFibGVBc3luYyhcclxuICAgICAgICAgICAgICAgICAgICAgICAgaW5zdGFuY2UocHJvdmlkZXJNb2NrKSxcclxuICAgICAgICAgICAgICAgICAgICAgICAgTlVMTF9BRERSRVNTLFxyXG4gICAgICAgICAgICAgICAgICAgICAgICBiYWxhbmNlLFxyXG4gICAgICAgICAgICAgICAgICAgICAgICBnYXNQcmljZSxcclxuICAgICAgICAgICAgICAgICAgICAgICAgUkZRTV9UWF9HQVNfRVNUSU1BVEUsXHJcbiAgICAgICAgICAgICAgICAgICAgKSxcclxuICAgICAgICAgICAgICAgICkudG8uZXFsKGlzU3VjY2Vzc2Z1bCk7XHJcbiAgICAgICAgICAgIH1cclxuICAgICAgICB9KTtcclxuICAgICAgICBpdCgnc2hvdWxkIGZhaWwgd2l0aCBhbiBvdXRzdGFuZGluZyB0cmFuc2FjdGlvbicsIGFzeW5jICgpID0+IHtcclxuICAgICAgICAgICAgd2hlbihwcm92aWRlck1vY2suZ2V0VHJhbnNhY3Rpb25Db3VudChOVUxMX0FERFJFU1MpKS50aGVuUmVzb2x2ZSgwKTtcclxuICAgICAgICAgICAgd2hlbihwcm92aWRlck1vY2suZ2V0VHJhbnNhY3Rpb25Db3VudChOVUxMX0FERFJFU1MsIEJsb2NrUGFyYW1MaXRlcmFsLlBlbmRpbmcpKS50aGVuUmVzb2x2ZSgxKTtcclxuXHJcbiAgICAgICAgICAgIGV4cGVjdChcclxuICAgICAgICAgICAgICAgIGF3YWl0IGlzV29ya2VyUmVhZHlBbmRBYmxlQXN5bmMoXHJcbiAgICAgICAgICAgICAgICAgICAgaW5zdGFuY2UocHJvdmlkZXJNb2NrKSxcclxuICAgICAgICAgICAgICAgICAgICBOVUxMX0FERFJFU1MsXHJcbiAgICAgICAgICAgICAgICAgICAgV2ViM1dyYXBwZXIudG9CYXNlVW5pdEFtb3VudCgxMCwgMTgpLFxyXG4gICAgICAgICAgICAgICAgICAgIFdlYjNXcmFwcGVyLnRvQmFzZVVuaXRBbW91bnQoMTIwLCA5KSxcclxuICAgICAgICAgICAgICAgICAgICBSRlFNX1RYX0dBU19FU1RJTUFURSxcclxuICAgICAgICAgICAgICAgICksXHJcbiAgICAgICAgICAgICkudG8uZXFsKGZhbHNlKTtcclxuICAgICAgICB9KTtcclxuICAgIH0pO1xyXG59KTtcclxuIl0sInZlcnNpb24iOjN9