{"file":"/Users/davidwalsh/code-local/0x-rfq-api/src/utils/rfqm_health_check.ts","mappings":"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","names":[],"sources":["/Users/davidwalsh/code-local/0x-rfq-api/src/utils/rfqm_health_check.ts"],"sourcesContent":["import { RfqMakerAssetOfferings } from '@0x/asset-swapper/lib/src/types';\r\nimport { BigNumber } from '@0x/utils';\r\nimport { Gauge } from 'prom-client';\r\nimport { Producer } from 'sqs-producer';\r\n\r\nimport { ETH_DECIMALS, RFQM_TX_GAS_ESTIMATE } from '../core/constants';\r\nimport { RfqmWorkerHeartbeatEntity } from '../entities';\r\n\r\nconst SQS_QUEUE_SIZE_DEGRADED_THRESHOLD = 10; // More messages sitting in queue than this will cause a DEGRADED issue\r\nconst SQS_QUEUE_SIZE_FAILED_THRESHOLD = 20; // More messages sitting in queue than this will cause a FAILED issue\r\n\r\nconst RECENT_HEARTBEAT_AGE_THRESHOLD = 5; // (minutes) Heartbeats older than this will produce a DEGRADED issue. A FAILED issue is produced if NO heartbeats are newer than this.\r\n\r\nconst BALANCE_FAILED_THRESHOLD = 0.04; // (eth) If NO worker has a balance higher than this, a FAILED issue gets created.\r\n// tslint:disable-next-line: custom-no-magic-numbers\r\nconst BALANCE_DEGRADED_THRESHOLD = 0.1; // (eth) If < 2 workers have a balance lower than this, a DEGRADED issue gets created.\r\n\r\nconst MS_IN_MINUTE = 60000;\r\n\r\nconst BALANCE_DEGRADED_THRESHOLD_WEI = new BigNumber(BALANCE_DEGRADED_THRESHOLD).shiftedBy(ETH_DECIMALS);\r\nconst BALANCE_FAILED_THRESHOLD_WEI = new BigNumber(BALANCE_FAILED_THRESHOLD).shiftedBy(ETH_DECIMALS);\r\n\r\nconst RFQM_HEALTH_CHECK_ISSUE_GAUGE = new Gauge({\r\n    name: 'rfqm_health_check_issue_gauge',\r\n    labelNames: ['label' /* :HealthCheckLabel */, 'chain_id'],\r\n    help: 'Gauge indicating the current status for each label. Value corresponds to the `statusSeverity`',\r\n});\r\n\r\nconst RFQM_TOTAL_SYSTEM_TRADE_CAPACITY_GAUGE = new Gauge({\r\n    name: 'rfqm_total_system_trade_capacity',\r\n    labelNames: ['chain_id'],\r\n    help: 'Total amount of ETH in the worker pool divided by the current expected gas of a trade',\r\n});\r\n\r\nexport enum HealthCheckStatus {\r\n    Operational = 'operational',\r\n    Maintenance = 'maintenance',\r\n    Degraded = 'degraded',\r\n    Failed = 'failed',\r\n}\r\n\r\ntype HealthCheckLabel = 'RFQM_MAINTENANCE_MODE config `true`' | 'queue size' | 'worker balance' | 'worker heartbeat';\r\n\r\ninterface HealthCheckIssue {\r\n    status: HealthCheckStatus;\r\n    description: string;\r\n    label: HealthCheckLabel;\r\n}\r\n\r\n/**\r\n * The complete result of an RFQm health check routine.\r\n * For public users, this should be converted to a `RfqmHealthCheckShortResponse` before being\r\n * sent in the reponse in order to not expose potentially-sensitive system details.\r\n */\r\nexport interface HealthCheckResult {\r\n    status: HealthCheckStatus;\r\n    pairs: {\r\n        [pair: string]: HealthCheckStatus; // where the pair has the form `${contractA}-${contractB}`\r\n    };\r\n    http: {\r\n        status: HealthCheckStatus;\r\n        issues: HealthCheckIssue[];\r\n    };\r\n    workers: {\r\n        status: HealthCheckStatus;\r\n        issues: HealthCheckIssue[];\r\n    };\r\n    // TODO (rhinodavid): Add MarketMakers\r\n}\r\n\r\nexport interface RfqmHealthCheckShortResponse {\r\n    isOperational: boolean;\r\n    pairs: [string, string][];\r\n}\r\n\r\n/**\r\n * Produces a full health check from the given inupts.\r\n */\r\nexport async function computeHealthCheckAsync(\r\n    isMaintainenceMode: boolean,\r\n    offerings: RfqMakerAssetOfferings,\r\n    producer: Producer,\r\n    heartbeats: RfqmWorkerHeartbeatEntity[],\r\n    chainId: number,\r\n    gasPrice?: BigNumber,\r\n): Promise<HealthCheckResult> {\r\n    const pairs = transformPairs(offerings);\r\n\r\n    const httpIssues = getHttpIssues(isMaintainenceMode);\r\n    const httpStatus = getWorstStatus(httpIssues.map((issue) => issue.status));\r\n\r\n    const queueIssues = await checkSqsQueueAsync(producer);\r\n    const heartbeatIssues = await checkWorkerHeartbeatsAsync(heartbeats);\r\n    const workersIssues = [...queueIssues, ...heartbeatIssues];\r\n    const workersStatus = getWorstStatus(workersIssues.map((issue) => issue.status));\r\n\r\n    // Prometheus counters\r\n    const severityByLabel: Record<HealthCheckLabel, number> = {\r\n        'RFQM_MAINTENANCE_MODE config `true`': statusSeverity(HealthCheckStatus.Operational),\r\n        'queue size': statusSeverity(HealthCheckStatus.Operational),\r\n        'worker balance': statusSeverity(HealthCheckStatus.Operational),\r\n        'worker heartbeat': statusSeverity(HealthCheckStatus.Operational),\r\n    };\r\n    [...httpIssues, ...workersIssues].forEach(\r\n        (issue) =>\r\n            (severityByLabel[issue.label] = Math.max(severityByLabel[issue.label], statusSeverity(issue.status))),\r\n    );\r\n    Object.entries(severityByLabel).forEach(([label, severity]) => {\r\n        RFQM_HEALTH_CHECK_ISSUE_GAUGE.labels(label, chainId.toString()).set(severity);\r\n    });\r\n\r\n    if (gasPrice) {\r\n        // Note that this gauge is an estimation of the total number of trades, since two workers could have\r\n        // 50% of the amount for one trade and the gauge would show 1 but the actual capacity would be 0.\r\n        const totalWorkerBalance = heartbeats.reduce((total, { balance }) => total.plus(balance), new BigNumber(0));\r\n        const totalSystemTradeCapacity = totalWorkerBalance.div(gasPrice.times(RFQM_TX_GAS_ESTIMATE));\r\n        RFQM_TOTAL_SYSTEM_TRADE_CAPACITY_GAUGE.labels(chainId.toString()).set(totalSystemTradeCapacity.toNumber());\r\n    }\r\n\r\n    return {\r\n        status: getWorstStatus([httpStatus, workersStatus]),\r\n        pairs,\r\n        http: { status: httpStatus, issues: httpIssues },\r\n        workers: { status: workersStatus, issues: workersIssues },\r\n    };\r\n}\r\n\r\n/**\r\n * Transform the full health check result into the minimal response the Matcha UI requires.\r\n */\r\nexport function transformResultToShortResponse(result: HealthCheckResult): RfqmHealthCheckShortResponse {\r\n    return {\r\n        isOperational: result.status === HealthCheckStatus.Operational || result.status === HealthCheckStatus.Degraded,\r\n        pairs: Object.entries(result.pairs)\r\n            .filter(\r\n                ([_pair, status]) => status === HealthCheckStatus.Operational || status === HealthCheckStatus.Degraded,\r\n            )\r\n            .map(([pair, _status]) => {\r\n                const [tokenA, tokenB] = pair.split('-');\r\n                return [tokenA, tokenB];\r\n            }),\r\n    };\r\n}\r\n\r\n/**\r\n * Changes the set of trading pairs from the format used in config to the format used in the health check response.\r\n */\r\nfunction transformPairs(offerings: RfqMakerAssetOfferings): { [pair: string]: HealthCheckStatus } {\r\n    return Object.values(offerings)\r\n        .flat()\r\n        .reduce((result: { [pair: string]: HealthCheckStatus }, pair) => {\r\n            const [tokenA, tokenB] = pair.sort();\r\n            // Currently, we assume all pairs are operation. In the future, this may not be the case.\r\n            result[`${tokenA}-${tokenB}`] = HealthCheckStatus.Operational;\r\n            return result;\r\n        }, {});\r\n}\r\n\r\n/**\r\n * Creates issues related to the server/API not specific to the worker farm.\r\n */\r\nexport function getHttpIssues(isMaintainenceMode: boolean): HealthCheckIssue[] {\r\n    const issues: HealthCheckIssue[] = [];\r\n    if (isMaintainenceMode) {\r\n        issues.push({\r\n            status: HealthCheckStatus.Maintenance,\r\n            description: 'RFQM is set to maintainence mode via the 0x API configuration',\r\n            label: 'RFQM_MAINTENANCE_MODE config `true`',\r\n        });\r\n    }\r\n    return issues;\r\n}\r\n\r\n/**\r\n * Runs checks on the SQS queue to detect if there are messages piling up.\r\n */\r\nexport async function checkSqsQueueAsync(producer: Producer): Promise<HealthCheckIssue[]> {\r\n    const results: HealthCheckIssue[] = [];\r\n    const messagesInQueue = await producer.queueSize();\r\n    if (messagesInQueue === 0) {\r\n        return results;\r\n    }\r\n    if (messagesInQueue > SQS_QUEUE_SIZE_FAILED_THRESHOLD) {\r\n        results.push({\r\n            status: HealthCheckStatus.Failed,\r\n            description: `SQS queue contains ${messagesInQueue} messages (threshold is ${SQS_QUEUE_SIZE_FAILED_THRESHOLD})`,\r\n            label: 'queue size',\r\n        });\r\n    } else if (messagesInQueue > SQS_QUEUE_SIZE_DEGRADED_THRESHOLD) {\r\n        results.push({\r\n            status: HealthCheckStatus.Degraded,\r\n            description: `SQS queue contains ${messagesInQueue} messages (threshold is ${SQS_QUEUE_SIZE_DEGRADED_THRESHOLD})`,\r\n            label: 'queue size',\r\n        });\r\n    }\r\n    return results;\r\n}\r\n\r\n/**\r\n * Returns a numerical value which corresponds to the \"severity\" of a `HealthCheckStatus` enum member.\r\n * Higher values are more severe. (Oh to have SwiftLang enums here.)\r\n */\r\nfunction statusSeverity(status: HealthCheckStatus): number {\r\n    // tslint:disable custom-no-magic-numbers\r\n    switch (status) {\r\n        case HealthCheckStatus.Failed:\r\n            return 4;\r\n        case HealthCheckStatus.Maintenance:\r\n            return 3;\r\n        case HealthCheckStatus.Degraded:\r\n            return 2;\r\n        case HealthCheckStatus.Operational:\r\n            return 1;\r\n        default:\r\n            throw new Error(`Received unknown status: ${status}`);\r\n    }\r\n    // tslint:enable custom-no-magic-numbers\r\n}\r\n\r\n/**\r\n * Accepts a list of statuses and returns the worst status\r\n */\r\nfunction getWorstStatus(statuses: HealthCheckStatus[]): HealthCheckStatus {\r\n    if (!statuses.length) {\r\n        return HealthCheckStatus.Operational;\r\n    }\r\n    return statuses.reduce(\r\n        (worstStatus, currentStatus) =>\r\n            statusSeverity(currentStatus) > statusSeverity(worstStatus) ? currentStatus : worstStatus,\r\n        HealthCheckStatus.Operational,\r\n    );\r\n}\r\n\r\n/**\r\n * Looks at the worker heartbeats and produces appropriate issues based on the age\r\n * of the heartbeats and the worker balances.\r\n *\r\n * Heartbeat Age: Checks the most recent heartbeat and produces a FAILED issue if it is older than the failed\r\n * threshold. For heartbeats other than the most recent, will only produce a DEGRADED issue. (i.e. the check only\r\n * fails if ALL workers are stuck)\r\n *\r\n * Worker Balance: Like with the age check, this only produces a FAILED issue if all workers are below the failed\r\n * balance. Individual worker balances produce a DEGRADED issue if they are below BALANCE_DEGRADED_THRESHOLD.\r\n *\r\n * Current date is an optional parameter for testing.\r\n */\r\nexport async function checkWorkerHeartbeatsAsync(\r\n    heartbeats: RfqmWorkerHeartbeatEntity[],\r\n    nowDate: Date = new Date(),\r\n): Promise<HealthCheckIssue[]> {\r\n    const results: HealthCheckIssue[] = [];\r\n    if (!heartbeats.length) {\r\n        return [\r\n            {\r\n                status: HealthCheckStatus.Failed,\r\n                description: 'No worker heartbeats were found',\r\n                label: 'worker heartbeat',\r\n            },\r\n        ];\r\n    }\r\n\r\n    // Heartbeat Age\r\n    const sortedHeartbeats = heartbeats.sort((a, b) => b.timestamp.getTime() - a.timestamp.getTime());\r\n    const newestHeartbeat = sortedHeartbeats[0];\r\n    const newestHeartbeatAgeMinutes = (nowDate.getTime() - newestHeartbeat.timestamp.getTime()) / MS_IN_MINUTE;\r\n    if (newestHeartbeatAgeMinutes > RECENT_HEARTBEAT_AGE_THRESHOLD) {\r\n        results.push({\r\n            status: HealthCheckStatus.Failed,\r\n            description: `No worker has published a heartbeat in the last ${RECENT_HEARTBEAT_AGE_THRESHOLD} minutes`,\r\n            label: 'worker heartbeat',\r\n        });\r\n    }\r\n    // TODO (rhinodavid): Think about how this will work when we downscale and a worker isn't producing new\r\n    // hearbeats because it's been removed.\r\n    sortedHeartbeats.forEach(({ index, timestamp, address }) => {\r\n        const heartbeatAgeMinutes = (nowDate.getTime() - timestamp.getTime()) / MS_IN_MINUTE;\r\n        if (heartbeatAgeMinutes >= RECENT_HEARTBEAT_AGE_THRESHOLD) {\r\n            results.push({\r\n                status: HealthCheckStatus.Degraded,\r\n                description: `Worker ${index} (${address}) last heartbeat was ${heartbeatAgeMinutes} ago`,\r\n                label: 'worker heartbeat',\r\n            });\r\n        }\r\n    });\r\n\r\n    // Balances\r\n    const heartbeatsAboveCriticalBalanceThreshold = heartbeats.filter(({ balance }) =>\r\n        balance.isGreaterThanOrEqualTo(BALANCE_FAILED_THRESHOLD_WEI),\r\n    );\r\n    if (heartbeatsAboveCriticalBalanceThreshold.length === 0) {\r\n        results.push({\r\n            status: HealthCheckStatus.Failed,\r\n            description: `No worker has a balance greater than the failed threshold (${BALANCE_FAILED_THRESHOLD})`,\r\n            label: 'worker heartbeat',\r\n        });\r\n    }\r\n\r\n    const heartbeatsAboveDegradedBalanceThreshold = heartbeats.filter(({ balance }) =>\r\n        balance.isGreaterThan(BALANCE_DEGRADED_THRESHOLD_WEI),\r\n    );\r\n    if (heartbeatsAboveDegradedBalanceThreshold.length < 2) {\r\n        results.push({\r\n            status: HealthCheckStatus.Degraded,\r\n            description: `Less than two workers have a balance above the degraded threshold (${BALANCE_DEGRADED_THRESHOLD})`,\r\n            label: 'worker heartbeat',\r\n        });\r\n    }\r\n    return results;\r\n}\r\n"],"version":3}