4f5d63dc75a20bce4fe6b2cd870dd433
"use strict";
Object.defineProperty(exports, "__esModule", { value: true });
exports.checkWorkerHeartbeatsAsync = exports.checkSqsQueueAsync = exports.getHttpIssues = exports.transformResultToShortResponse = exports.computeHealthCheckAsync = exports.HealthCheckStatus = void 0;
const utils_1 = require("@0x/utils");
const prom_client_1 = require("prom-client");
const constants_1 = require("../core/constants");
const SQS_QUEUE_SIZE_DEGRADED_THRESHOLD = 10; // More messages sitting in queue than this will cause a DEGRADED issue
const SQS_QUEUE_SIZE_FAILED_THRESHOLD = 20; // More messages sitting in queue than this will cause a FAILED issue
const RECENT_HEARTBEAT_AGE_THRESHOLD = 5; // (minutes) Heartbeats older than this will produce a DEGRADED issue. A FAILED issue is produced if NO heartbeats are newer than this.
const BALANCE_FAILED_THRESHOLD = 0.04; // (eth) If NO worker has a balance higher than this, a FAILED issue gets created.
// tslint:disable-next-line: custom-no-magic-numbers
const BALANCE_DEGRADED_THRESHOLD = 0.1; // (eth) If < 2 workers have a balance lower than this, a DEGRADED issue gets created.
const MS_IN_MINUTE = 60000;
const BALANCE_DEGRADED_THRESHOLD_WEI = new utils_1.BigNumber(BALANCE_DEGRADED_THRESHOLD).shiftedBy(constants_1.ETH_DECIMALS);
const BALANCE_FAILED_THRESHOLD_WEI = new utils_1.BigNumber(BALANCE_FAILED_THRESHOLD).shiftedBy(constants_1.ETH_DECIMALS);
const RFQM_HEALTH_CHECK_ISSUE_GAUGE = new prom_client_1.Gauge({
    name: 'rfqm_health_check_issue_gauge',
    labelNames: ['label' /* :HealthCheckLabel */, 'chain_id'],
    help: 'Gauge indicating the current status for each label. Value corresponds to the `statusSeverity`',
});
const RFQM_TOTAL_SYSTEM_TRADE_CAPACITY_GAUGE = new prom_client_1.Gauge({
    name: 'rfqm_total_system_trade_capacity',
    labelNames: ['chain_id'],
    help: 'Total amount of ETH in the worker pool divided by the current expected gas of a trade',
});
var HealthCheckStatus;
(function (HealthCheckStatus) {
    HealthCheckStatus["Operational"] = "operational";
    HealthCheckStatus["Maintenance"] = "maintenance";
    HealthCheckStatus["Degraded"] = "degraded";
    HealthCheckStatus["Failed"] = "failed";
})(HealthCheckStatus = exports.HealthCheckStatus || (exports.HealthCheckStatus = {}));
/**
 * Produces a full health check from the given inupts.
 */
async function computeHealthCheckAsync(isMaintainenceMode, offerings, producer, heartbeats, chainId, gasPrice) {
    const pairs = transformPairs(offerings);
    const httpIssues = getHttpIssues(isMaintainenceMode);
    const httpStatus = getWorstStatus(httpIssues.map((issue) => issue.status));
    const queueIssues = await checkSqsQueueAsync(producer);
    const heartbeatIssues = await checkWorkerHeartbeatsAsync(heartbeats);
    const workersIssues = [...queueIssues, ...heartbeatIssues];
    const workersStatus = getWorstStatus(workersIssues.map((issue) => issue.status));
    // Prometheus counters
    const severityByLabel = {
        'RFQM_MAINTENANCE_MODE config `true`': statusSeverity(HealthCheckStatus.Operational),
        'queue size': statusSeverity(HealthCheckStatus.Operational),
        'worker balance': statusSeverity(HealthCheckStatus.Operational),
        'worker heartbeat': statusSeverity(HealthCheckStatus.Operational),
    };
    [...httpIssues, ...workersIssues].forEach((issue) => (severityByLabel[issue.label] = Math.max(severityByLabel[issue.label], statusSeverity(issue.status))));
    Object.entries(severityByLabel).forEach(([label, severity]) => {
        RFQM_HEALTH_CHECK_ISSUE_GAUGE.labels(label, chainId.toString()).set(severity);
    });
    if (gasPrice) {
        // Note that this gauge is an estimation of the total number of trades, since two workers could have
        // 50% of the amount for one trade and the gauge would show 1 but the actual capacity would be 0.
        const totalWorkerBalance = heartbeats.reduce((total, { balance }) => total.plus(balance), new utils_1.BigNumber(0));
        const totalSystemTradeCapacity = totalWorkerBalance.div(gasPrice.times(constants_1.RFQM_TX_GAS_ESTIMATE));
        RFQM_TOTAL_SYSTEM_TRADE_CAPACITY_GAUGE.labels(chainId.toString()).set(totalSystemTradeCapacity.toNumber());
    }
    return {
        status: getWorstStatus([httpStatus, workersStatus]),
        pairs,
        http: { status: httpStatus, issues: httpIssues },
        workers: { status: workersStatus, issues: workersIssues },
    };
}
exports.computeHealthCheckAsync = computeHealthCheckAsync;
/**
 * Transform the full health check result into the minimal response the Matcha UI requires.
 */
function transformResultToShortResponse(result) {
    return {
        isOperational: result.status === HealthCheckStatus.Operational || result.status === HealthCheckStatus.Degraded,
        pairs: Object.entries(result.pairs)
            .filter(([_pair, status]) => status === HealthCheckStatus.Operational || status === HealthCheckStatus.Degraded)
            .map(([pair, _status]) => {
            const [tokenA, tokenB] = pair.split('-');
            return [tokenA, tokenB];
        }),
    };
}
exports.transformResultToShortResponse = transformResultToShortResponse;
/**
 * Changes the set of trading pairs from the format used in config to the format used in the health check response.
 */
function transformPairs(offerings) {
    return Object.values(offerings)
        .flat()
        .reduce((result, pair) => {
        const [tokenA, tokenB] = pair.sort();
        // Currently, we assume all pairs are operation. In the future, this may not be the case.
        result[`${tokenA}-${tokenB}`] = HealthCheckStatus.Operational;
        return result;
    }, {});
}
/**
 * Creates issues related to the server/API not specific to the worker farm.
 */
function getHttpIssues(isMaintainenceMode) {
    const issues = [];
    if (isMaintainenceMode) {
        issues.push({
            status: HealthCheckStatus.Maintenance,
            description: 'RFQM is set to maintainence mode via the 0x API configuration',
            label: 'RFQM_MAINTENANCE_MODE config `true`',
        });
    }
    return issues;
}
exports.getHttpIssues = getHttpIssues;
/**
 * Runs checks on the SQS queue to detect if there are messages piling up.
 */
async function checkSqsQueueAsync(producer) {
    const results = [];
    const messagesInQueue = await producer.queueSize();
    if (messagesInQueue === 0) {
        return results;
    }
    if (messagesInQueue > SQS_QUEUE_SIZE_FAILED_THRESHOLD) {
        results.push({
            status: HealthCheckStatus.Failed,
            description: `SQS queue contains ${messagesInQueue} messages (threshold is ${SQS_QUEUE_SIZE_FAILED_THRESHOLD})`,
            label: 'queue size',
        });
    }
    else if (messagesInQueue > SQS_QUEUE_SIZE_DEGRADED_THRESHOLD) {
        results.push({
            status: HealthCheckStatus.Degraded,
            description: `SQS queue contains ${messagesInQueue} messages (threshold is ${SQS_QUEUE_SIZE_DEGRADED_THRESHOLD})`,
            label: 'queue size',
        });
    }
    return results;
}
exports.checkSqsQueueAsync = checkSqsQueueAsync;
/**
 * Returns a numerical value which corresponds to the "severity" of a `HealthCheckStatus` enum member.
 * Higher values are more severe. (Oh to have SwiftLang enums here.)
 */
function statusSeverity(status) {
    // tslint:disable custom-no-magic-numbers
    switch (status) {
        case HealthCheckStatus.Failed:
            return 4;
        case HealthCheckStatus.Maintenance:
            return 3;
        case HealthCheckStatus.Degraded:
            return 2;
        case HealthCheckStatus.Operational:
            return 1;
        default:
            throw new Error(`Received unknown status: ${status}`);
    }
    // tslint:enable custom-no-magic-numbers
}
/**
 * Accepts a list of statuses and returns the worst status
 */
function getWorstStatus(statuses) {
    if (!statuses.length) {
        return HealthCheckStatus.Operational;
    }
    return statuses.reduce((worstStatus, currentStatus) => statusSeverity(currentStatus) > statusSeverity(worstStatus) ? currentStatus : worstStatus, HealthCheckStatus.Operational);
}
/**
 * Looks at the worker heartbeats and produces appropriate issues based on the age
 * of the heartbeats and the worker balances.
 *
 * Heartbeat Age: Checks the most recent heartbeat and produces a FAILED issue if it is older than the failed
 * threshold. For heartbeats other than the most recent, will only produce a DEGRADED issue. (i.e. the check only
 * fails if ALL workers are stuck)
 *
 * Worker Balance: Like with the age check, this only produces a FAILED issue if all workers are below the failed
 * balance. Individual worker balances produce a DEGRADED issue if they are below BALANCE_DEGRADED_THRESHOLD.
 *
 * Current date is an optional parameter for testing.
 */
async function checkWorkerHeartbeatsAsync(heartbeats, nowDate = new Date()) {
    const results = [];
    if (!heartbeats.length) {
        return [
            {
                status: HealthCheckStatus.Failed,
                description: 'No worker heartbeats were found',
                label: 'worker heartbeat',
            },
        ];
    }
    // Heartbeat Age
    const sortedHeartbeats = heartbeats.sort((a, b) => b.timestamp.getTime() - a.timestamp.getTime());
    const newestHeartbeat = sortedHeartbeats[0];
    const newestHeartbeatAgeMinutes = (nowDate.getTime() - newestHeartbeat.timestamp.getTime()) / MS_IN_MINUTE;
    if (newestHeartbeatAgeMinutes > RECENT_HEARTBEAT_AGE_THRESHOLD) {
        results.push({
            status: HealthCheckStatus.Failed,
            description: `No worker has published a heartbeat in the last ${RECENT_HEARTBEAT_AGE_THRESHOLD} minutes`,
            label: 'worker heartbeat',
        });
    }
    // TODO (rhinodavid): Think about how this will work when we downscale and a worker isn't producing new
    // hearbeats because it's been removed.
    sortedHeartbeats.forEach(({ index, timestamp, address }) => {
        const heartbeatAgeMinutes = (nowDate.getTime() - timestamp.getTime()) / MS_IN_MINUTE;
        if (heartbeatAgeMinutes >= RECENT_HEARTBEAT_AGE_THRESHOLD) {
            results.push({
                status: HealthCheckStatus.Degraded,
                description: `Worker ${index} (${address}) last heartbeat was ${heartbeatAgeMinutes} ago`,
                label: 'worker heartbeat',
            });
        }
    });
    // Balances
    const heartbeatsAboveCriticalBalanceThreshold = heartbeats.filter(({ balance }) => balance.isGreaterThanOrEqualTo(BALANCE_FAILED_THRESHOLD_WEI));
    if (heartbeatsAboveCriticalBalanceThreshold.length === 0) {
        results.push({
            status: HealthCheckStatus.Failed,
            description: `No worker has a balance greater than the failed threshold (${BALANCE_FAILED_THRESHOLD})`,
            label: 'worker heartbeat',
        });
    }
    const heartbeatsAboveDegradedBalanceThreshold = heartbeats.filter(({ balance }) => balance.isGreaterThan(BALANCE_DEGRADED_THRESHOLD_WEI));
    if (heartbeatsAboveDegradedBalanceThreshold.length < 2) {
        results.push({
            status: HealthCheckStatus.Degraded,
            description: `Less than two workers have a balance above the degraded threshold (${BALANCE_DEGRADED_THRESHOLD})`,
            label: 'worker heartbeat',
        });
    }
    return results;
}
exports.checkWorkerHeartbeatsAsync = checkWorkerHeartbeatsAsync;
//# sourceMappingURL=data:application/json;charset=utf-8;base64,eyJmaWxlIjoiL1VzZXJzL2Rhdmlkd2Fsc2gvY29kZS1sb2NhbC8weC1yZnEtYXBpL3NyYy91dGlscy9yZnFtX2hlYWx0aF9jaGVjay50cyIsIm1hcHBpbmdzIjoiOzs7QUFDQSxxQ0FBc0M7QUFDdEMsNkNBQW9DO0FBR3BDLGlEQUF1RTtBQUd2RSxNQUFNLGlDQUFpQyxHQUFHLEVBQUUsQ0FBQyxDQUFDLHVFQUF1RTtBQUNySCxNQUFNLCtCQUErQixHQUFHLEVBQUUsQ0FBQyxDQUFDLHFFQUFxRTtBQUVqSCxNQUFNLDhCQUE4QixHQUFHLENBQUMsQ0FBQyxDQUFDLHVJQUF1STtBQUVqTCxNQUFNLHdCQUF3QixHQUFHLElBQUksQ0FBQyxDQUFDLGtGQUFrRjtBQUN6SCxvREFBb0Q7QUFDcEQsTUFBTSwwQkFBMEIsR0FBRyxHQUFHLENBQUMsQ0FBQyxzRkFBc0Y7QUFFOUgsTUFBTSxZQUFZLEdBQUcsS0FBSyxDQUFDO0FBRTNCLE1BQU0sOEJBQThCLEdBQUcsSUFBSSxpQkFBUyxDQUFDLDBCQUEwQixDQUFDLENBQUMsU0FBUyxDQUFDLHdCQUFZLENBQUMsQ0FBQztBQUN6RyxNQUFNLDRCQUE0QixHQUFHLElBQUksaUJBQVMsQ0FBQyx3QkFBd0IsQ0FBQyxDQUFDLFNBQVMsQ0FBQyx3QkFBWSxDQUFDLENBQUM7QUFFckcsTUFBTSw2QkFBNkIsR0FBRyxJQUFJLG1CQUFLLENBQUM7SUFDNUMsSUFBSSxFQUFFLCtCQUErQjtJQUNyQyxVQUFVLEVBQUUsQ0FBQyxPQUFPLENBQUMsdUJBQXVCLEVBQUUsVUFBVSxDQUFDO0lBQ3pELElBQUksRUFBRSwrRkFBK0Y7Q0FDeEcsQ0FBQyxDQUFDO0FBRUgsTUFBTSxzQ0FBc0MsR0FBRyxJQUFJLG1CQUFLLENBQUM7SUFDckQsSUFBSSxFQUFFLGtDQUFrQztJQUN4QyxVQUFVLEVBQUUsQ0FBQyxVQUFVLENBQUM7SUFDeEIsSUFBSSxFQUFFLHVGQUF1RjtDQUNoRyxDQUFDLENBQUM7QUFFSCxJQUFZLGlCQUtYO0FBTEQsV0FBWSxpQkFBaUI7SUFDekIsZ0RBQTJCLENB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QyxJQUFJLENBQUM7Z0JBQ1QsTUFBTSxFQUFFLGlCQUFpQixDQUFDLFFBQVE7Z0JBQ2xDLFdBQVcsRUFBRSxVQUFVLEtBQUssS0FBSyxPQUFPLHdCQUF3QixtQkFBbUIsTUFBTTtnQkFDekYsS0FBSyxFQUFFLGtCQUFrQjthQUM1QixDQUFDLENBQUM7U0FDTjtJQUNMLENBQUMsQ0FBQyxDQUFDO0lBRUgsV0FBVztJQUNYLE1BQU0sdUNBQXVDLEdBQUcsVUFBVSxDQUFDLE1BQU0sQ0FBQyxDQUFDLEVBQUUsT0FBTyxFQUFFLEVBQUUsRUFBRSxDQUM5RSxPQUFPLENBQUMsc0JBQXNCLENBQUMsNEJBQTRCLENBQUMsQ0FDL0QsQ0FBQztJQUNGLElBQUksdUNBQXVDLENBQUMsTUFBTSxLQUFLLENBQUMsRUFBRTtRQUN0RCxPQUFPLENBQUMsSUFBSSxDQUFDO1lBQ1QsTUFBTSxFQUFFLGlCQUFpQixDQUFDLE1BQU07WUFDaEMsV0FBVyxFQUFFLDhEQUE4RCx3QkFBd0IsR0FBRztZQUN0RyxLQUFLLEVBQUUsa0JBQWtCO1NBQzVCLENBQUMsQ0FBQztLQUNOO0lBRUQsTUFBTSx1Q0FBdUMsR0FBRyxVQUFVLENBQUMsTUFBTSxDQUFDLENBQUMsRUFBRSxPQUFPLEVBQUUsRUFBRSxFQUFFLENBQzlFLE9BQU8sQ0FBQyxhQUFhLENBQUMsOEJBQThCLENBQUMsQ0FDeEQsQ0FBQztJQUNGLElBQUksdUNBQXVDLENBQUMsTUFBTSxHQUFHLENBQUMsRUFBRTtRQUNwRCxPQUFPLENBQUMsSUFBSSxDQUFDO1lBQ1QsTUFBTSxFQUFFLGlCQUFpQixDQUFDLFFBQVE7WUFDbEMsV0FBVyxFQUFFLHNFQUFzRSwwQkFBMEIsR0FBRztZQUNoSCxLQUFLLEVBQUUsa0JBQWtCO1NBQzVCLENBQUMsQ0FBQztLQUNOO0lBQ0QsT0FBTyxPQUFPLENBQUM7QUFDbkIsQ0FBQztBQTlERCxnRUE4REMiLCJuYW1lcyI6W10sInNvdXJjZXMiOlsiL1VzZXJzL2Rhdmlkd2Fsc2gvY29kZS1sb2NhbC8weC1yZnEtYXBpL3NyYy91dGlscy9yZnFtX2hlYWx0aF9jaGVjay50cyJdLCJzb3VyY2VzQ29udGVudCI6WyJpbXBvcnQgeyBSZnFNYWtlckFzc2V0T2ZmZXJpbmdzIH0gZnJvbSAnQDB4L2Fzc2V0LXN3YXBwZXIvbGliL3NyYy90eXBlcyc7XHJcbmltcG9ydCB7IEJpZ051bWJlciB9IGZyb20gJ0AweC91dGlscyc7XHJcbmltcG9ydCB7IEdhdWdlIH0gZnJvbSAncHJvbS1jbGllbnQnO1xyXG5pbXBvcnQgeyBQcm9kdWNlciB9IGZyb20gJ3Nxcy1wcm9kdWNlcic7XHJcblxyXG5pbXBvcnQgeyBFVEhfREVDSU1BTFMsIFJGUU1fVFhfR0FTX0VTVElNQVRFIH0gZnJvbSAnLi4vY29yZS9jb25zdGFudHMnO1xyXG5pbXBvcnQgeyBSZnFtV29ya2VySGVhcnRiZWF0RW50aXR5IH0gZnJvbSAnLi4vZW50aXRpZXMnO1xyXG5cclxuY29uc3QgU1FTX1FVRVVFX1NJWkVfREVHUkFERURfVEhSRVNIT0xEID0gMTA7IC8vIE1vcmUgbWVzc2FnZXMgc2l0dGluZyBpbiBxdWV1ZSB0aGFuIHRoaXMgd2lsbCBjYXVzZSBhIERFR1JBREVEIGlzc3VlXHJcbmNvbnN0IFNRU19RVUVVRV9TSVpFX0ZBSUxFRF9USFJFU0hPTEQgPSAyMDsgLy8gTW9yZSBtZXNzYWdlcyBzaXR0aW5nIGluIHF1ZXVlIHRoYW4gdGhpcyB3aWxsIGNhdXNlIGEgRkFJTEVEIGlzc3VlXHJcblxyXG5jb25zdCBSRUNFTlRfSEVBUlRCRUFUX0FHRV9USFJFU0hPTEQgPSA1OyAvLyAobWludXRlcykgSGVhcnRiZWF0cyBvbGRlciB0aGFuIHRoaXMgd2lsbCBwcm9kdWNlIGEgREVHUkFERUQgaXNzdWUuIEEgRkFJTEVEIGlzc3VlIGlzIHByb2R1Y2VkIGlmIE5PIGhlYXJ0YmVhdHMgYXJlIG5ld2VyIHRoYW4gdGhpcy5cclxuXHJcbmNvbnN0IEJBTEFOQ0VfRkFJTEVEX1RIUkVTSE9MRCA9IDAuMDQ7IC8vIChldGgpIElmIE5PIHdvcmtlciBoYXMgYSBiYWxhbmNlIGhpZ2hlciB0aGFuIHRoaXMsIGEgRkFJTEVEIGlzc3VlIGdldHMgY3JlYXRlZC5cclxuLy8gdHNsaW50OmRpc2FibGUtbmV4dC1saW5lOiBjdXN0b20tbm8tbWFnaWMtbnVtYmVyc1xyXG5jb25zdCBCQUxBTkNFX0RFR1JBREVEX1RIUkVTSE9MRCA9IDAuMTsgLy8gKGV0aCkgSWYgPCAyIHdvcmtlcnMgaGF2ZSBhIGJhbGFuY2UgbG93ZXIgdGhhbiB0aGlzLCBhIERFR1JBREVEIGlzc3VlIGdldHMgY3JlYXRlZC5cclxuXHJcbmNvbnN0IE1TX0lOX01JTlVURSA9IDYwMDAwO1xyXG5cclxuY29uc3QgQkFMQU5DRV9ERUdSQURFRF9USFJFU0hPTERfV0VJID0gbmV3IEJpZ051bWJlcihCQUxBTkNFX0RFR1JBREVEX1RIUkVTSE9MRCkuc2hpZnRlZEJ5KEVUSF9ERUNJTUFMUyk7XHJcbmNvbnN0IEJBTEFOQ0VfRkFJTEVEX1RIUkVTSE9MRF9XRUkgPSBuZXcgQmlnTnVtYmVyKEJBTEFOQ0VfRkFJTEVEX1RIUkVTSE9MRCkuc2hpZnRlZEJ5KEVUSF9ERUNJTUFMUyk7XHJcblxyXG5jb25zdCBSRlFNX0hFQUxUSF9DSEVDS19JU1NVRV9HQVVHRSA9IG5ldyBHYXVnZSh7XHJcbiAgICBuYW1lOiAncmZxbV9oZWFsdGhfY2hlY2tfaXNzdWVfZ2F1Z2UnLFxyXG4gICAgbGFiZWxOYW1lczogWydsYWJlbCcgLyogOkhlYWx0aENoZWNrTGFiZWwgKi8sICdjaGFpbl9pZCddLFxyXG4gICAgaGVscDogJ0dhdWdlIGluZGljYXRpbmcgdGhlIGN1cnJlbnQgc3RhdHVzIGZvciBlYWNoIGxhYmVsLiBWYWx1ZSBjb3JyZXNwb25kcyB0byB0aGUgYHN0YXR1c1NldmVyaXR5YCcsXHJcbn0pO1xyXG5cclxuY29uc3QgUkZRTV9UT1RBTF9TWVNURU1fVFJBREVfQ0FQQUNJVFlfR0FVR0UgPSBuZXcgR2F1Z2Uoe1xyXG4gICAgbmFtZTogJ3JmcW1fdG90YWxfc3lzdGVtX3RyYWRlX2NhcGFjaXR5JyxcclxuICAgIGxhYmVsTmFtZXM6IFsnY2hhaW5faWQnXSxcclxuICAgIGhlbHA6ICdUb3RhbCBhbW91bnQgb2YgRVRIIGluIHRoZSB3b3JrZXIgcG9vbCBkaXZpZGVkIGJ5IHRoZSBjdXJyZW50IGV4cGVjdGVkIGdhcyBvZiBhIHRyYWRlJyxcclxufSk7XHJcblxyXG5leHBvcnQgZW51bSBIZWFsdGhDaGVja1N0YXR1cyB7XHJcbiAgICBPcGVyYXRpb25hbCA9ICdvcGVyYXRpb25hbCcsXHJcbiAgICBNYWludGVuYW5jZSA9ICdtYWludGVuYW5jZScsXHJcbiAgICBEZWdyYWRlZCA9ICdkZWdyYWRlZCcsXHJcbiAgICBGYWlsZWQgPSAnZmFpbGVkJyxcclxufVxyXG5cclxudHlwZSBIZWFsdGhDaGVja0xhYmVsID0gJ1JGUU1fTUFJTlRFTkFOQ0VfTU9ERSBjb25maWcgYHRydWVgJyB8ICdxdWV1ZSBzaXplJyB8ICd3b3JrZXIgYmFsYW5jZScgfCAnd29ya2VyIGhlYXJ0YmVhdCc7XHJcblxyXG5pbnRlcmZhY2UgSGVhbHRoQ2hlY2tJc3N1ZSB7XHJcbiAgICBzdGF0dXM6IEhlYWx0aENoZWNrU3RhdHVzO1xyXG4gICAgZGVzY3JpcHRpb246IHN0cmluZztcclxuICAgIGxhYmVsOiBIZWFsdGhDaGVja0xhYmVsO1xyXG59XHJcblxyXG4vKipcclxuICogVGhlIGNvbXBsZXRlIHJlc3VsdCBvZiBhbiBSRlFtIGhlYWx0aCBjaGVjayByb3V0aW5lLlxyXG4gKiBGb3IgcHVibGljIHVzZXJzLCB0aGlzIHNob3VsZCBiZSBjb252ZXJ0ZWQgdG8gYSBgUmZxbUhlYWx0aENoZWNrU2hvcnRSZXNwb25zZWAgYmVmb3JlIGJlaW5nXHJcbiAqIHNlbnQgaW4gdGhlIHJlcG9uc2UgaW4gb3JkZXIgdG8gbm90IGV4cG9zZSBwb3RlbnRpYWxseS1zZW5zaXRpdmUgc3lzdGVtIGRldGFpbHMuXHJcbiAqL1xyXG5leHBvcnQgaW50ZXJmYWNlIEhlYWx0aENoZWNrUmVzdWx0IHtcclxuICAgIHN0YXR1czogSGVhbHRoQ2hlY2tTdGF0dXM7XHJcbiAgICBwYWlyczoge1xyXG4gICAgICAgIFtwYWlyOiBzdHJpbmddOiBIZWFsdGhDaGVja1N0YXR1czsgLy8gd2hlcmUgdGhlIHBhaXIgaGFzIHRoZSBmb3JtIGAke2NvbnRyYWN0QX0tJHtjb250cmFjdEJ9YFxyXG4gICAgfTtcclxuICAgIGh0dHA6IHtcclxuICAgICAgICBzdGF0dXM6IEhlYWx0aENoZWNrU3RhdHVzO1xyXG4gICAgICAgIGlzc3VlczogSGVhbHRoQ2hlY2tJc3N1ZVtdO1xyXG4gICAgfTtcclxuICAgIHdvcmtlcnM6IHtcclxuICAgICAgICBzdGF0dXM6IEhlYWx0aENoZWNrU3RhdHVzO1xyXG4gICAgICAgIGlzc3VlczogSGVhbHRoQ2hlY2tJc3N1ZVtdO1xyXG4gICAgfTtcclxuICAgIC8vIFRPRE8gKHJoaW5vZGF2aWQpOiBBZGQgTWFya2V0TWFrZXJzXHJcbn1cclxuXHJcbmV4cG9ydCBpbnRlcmZhY2UgUmZxbUhlYWx0aENoZWNrU2hvcnRSZXNwb25zZSB7XHJcbiAgICBpc09wZXJhdGlvbmFsOiBib29sZWFuO1xyXG4gICAgcGFpcnM6IFtzdHJpbmcsIHN0cmluZ11bXTtcclxufVxyXG5cclxuLyoqXHJcbiAqIFByb2R1Y2VzIGEgZnVsbCBoZWFsdGggY2hlY2sgZnJvbSB0aGUgZ2l2ZW4gaW51cHRzLlxyXG4gKi9cclxuZXhwb3J0IGFzeW5jIGZ1bmN0aW9uIGNvbXB1dGVIZWFsdGhDaGVja0FzeW5jKFxyXG4gICAgaXNNYWludGFpbmVuY2VNb2RlOiBib29sZWFuLFxyXG4gICAgb2ZmZXJpbmdzOiBSZnFNYWtlckFzc2V0T2ZmZXJpbmdzLFxyXG4gICAgcHJvZHVjZXI6IFByb2R1Y2VyLFxyXG4gICAgaGVhcnRiZWF0czogUmZxbVdvcmtlckhlYXJ0YmVhdEVudGl0eVtdLFxyXG4gICAgY2hhaW5JZDogbnVtYmVyLFxyXG4gICAgZ2FzUHJpY2U/OiBCaWdOdW1iZXIsXHJcbik6IFByb21pc2U8SGVhbHRoQ2hlY2tSZXN1bHQ+IHtcclxuICAgIGNvbnN0IHBhaXJzID0gdHJhbnNmb3JtUGFpcnMob2ZmZXJpbmdzKTtcclxuXHJcbiAgICBjb25zdCBodHRwSXNzdWVzID0gZ2V0SHR0cElzc3Vlcyhpc01haW50YWluZW5jZU1vZGUpO1xyXG4gICAgY29uc3QgaHR0cFN0YXR1cyA9IGdldFdvcnN0U3RhdHVzKGh0dHBJc3N1ZXMubWFwKChpc3N1ZSkgPT4gaXNzdWUuc3RhdHVzKSk7XHJcblxyXG4gICAgY29uc3QgcXVldWVJc3N1ZXMgPSBhd2FpdCBjaGVja1Nxc1F1ZXVlQXN5bmMocHJvZHVjZXIpO1xyXG4gICAgY29uc3QgaGVhcnRiZWF0SXNzdWVzID0gYXdhaXQgY2hlY2tXb3JrZXJIZWFydGJlYXRzQXN5bmMoaGVhcnRiZWF0cyk7XHJcbiAgICBjb25zdCB3b3JrZXJzSXNzdWVzID0gWy4uLnF1ZXVlSXNzdWVzLCAuLi5oZWFydGJlYXRJc3N1ZXNdO1xyXG4gICAgY29uc3Qgd29ya2Vyc1N0YXR1cyA9IGdldFdvcnN0U3RhdHVzKHdvcmtlcnNJc3N1ZXMubWFwKChpc3N1ZSkgPT4gaXNzdWUuc3RhdHVzKSk7XHJcblxyXG4gICAgLy8gUHJvbWV0aGV1cyBjb3VudGVyc1xyXG4gICAgY29uc3Qgc2V2ZXJpdHlCeUxhYmVsOiBSZWNvcmQ8SGVhbHRoQ2hlY2tMYWJlbCwgbnVtYmVyPiA9IHtcclxuICAgICAgICAnUkZRTV9NQUlOVEVOQU5DRV9NT0RFIGNvbmZpZyBgdHJ1ZWAnOiBzdGF0dXNTZXZlcml0eShIZWFsdGhDaGVja1N0YXR1cy5PcGVyYXRpb25hbCksXHJcbiAgICAgICAgJ3F1ZXVlIHNpemUnOiBzdGF0dXNTZXZlcml0eShIZWFsdGhDaGVja1N0YXR1cy5PcGVyYXRpb25hbCksXHJcbiAgICAgICAgJ3dvcmtlciBiYWxhbmNlJzogc3RhdHVzU2V2ZXJpdHkoSGVhbHRoQ2hlY2tTdGF0dXMuT3BlcmF0aW9uYWwpLFxyXG4gICAgICAgICd3b3JrZXIgaGVhcnRiZWF0Jzogc3RhdHVzU2V2ZXJpdHkoSGVhbHRoQ2hlY2tTdGF0dXMuT3BlcmF0aW9uYWwpLFxyXG4gICAgfTtcclxuICAgIFsuLi5odHRwSXNzdWVzLCAuLi53b3JrZXJzSXNzdWVzXS5mb3JFYWNoKFxyXG4gICAgICAgIChpc3N1ZSkgPT5cclxuICAgICAgICAgICAgKHNldmVyaXR5QnlMYWJlbFtpc3N1ZS5sYWJlbF0gPSBNYXRoLm1heChzZXZlcml0eUJ5TGFiZWxbaXNzdWUubGFiZWxdLCBzdGF0dXNTZXZlcml0eShpc3N1ZS5zdGF0dXMpKSksXHJcbiAgICApO1xyXG4gICAgT2JqZWN0LmVudHJpZXMoc2V2ZXJpdHlCeUxhYmVsKS5mb3JFYWNoKChbbGFiZWwsIHNldmVyaXR5XSkgPT4ge1xyXG4gICAgICAgIFJGUU1fSEVBTFRIX0NIRUNLX0lTU1VFX0dBVUdFLmxhYmVscyhsYWJlbCwgY2hhaW5JZC50b1N0cmluZygpKS5zZXQoc2V2ZXJpdHkpO1xyXG4gICAgfSk7XHJcblxyXG4gICAgaWYgKGdhc1ByaWNlKSB7XHJcbiAgICAgICAgLy8gTm90ZSB0aGF0IHRoaXMgZ2F1Z2UgaXMgYW4gZXN0aW1hdGlvbiBvZiB0aGUgdG90YWwgbnVtYmVyIG9mIHRyYWRlcywgc2luY2UgdHdvIHdvcmtlcnMgY291bGQgaGF2ZVxyXG4gICAgICAgIC8vIDUwJSBvZiB0aGUgYW1vdW50IGZvciBvbmUgdHJhZGUgYW5kIHRoZSBnYXVnZSB3b3VsZCBzaG93IDEgYnV0IHRoZSBhY3R1YWwgY2FwYWNpdHkgd291bGQgYmUgMC5cclxuICAgICAgICBjb25zdCB0b3RhbFdvcmtlckJhbGFuY2UgPSBoZWFydGJlYXRzLnJlZHVjZSgodG90YWwsIHsgYmFsYW5jZSB9KSA9PiB0b3RhbC5wbHVzKGJhbGFuY2UpLCBuZXcgQmlnTnVtYmVyKDApKTtcclxuICAgICAgICBjb25zdCB0b3RhbFN5c3RlbVRyYWRlQ2FwYWNpdHkgPSB0b3RhbFdvcmtlckJhbGFuY2UuZGl2KGdhc1ByaWNlLnRpbWVzKFJGUU1fVFhfR0FTX0VTVElNQVRFKSk7XHJcbiAgICAgICAgUkZRTV9UT1RBTF9TWVNURU1fVFJBREVfQ0FQQUNJVFlfR0FVR0UubGFiZWxzKGNoYWluSWQudG9TdHJpbmcoKSkuc2V0KHRvdGFsU3lzdGVtVHJhZGVDYXBhY2l0eS50b051bWJlcigpKTtcclxuICAgIH1cclxuXHJcbiAgICByZXR1cm4ge1xyXG4gICAgICAgIHN0YXR1czogZ2V0V29yc3RTdGF0dXMoW2h0dHBTdGF0dXMsIHdvcmtlcnNTdGF0dXNdKSxcclxuICAgICAgICBwYWlycyxcclxuICAgICAgICBodHRwOiB7IHN0YXR1czogaHR0cFN0YXR1cywgaXNzdWVzOiBodHRwSXNzdWVzIH0sXHJcbiAgICAgICAgd29ya2VyczogeyBzdGF0dXM6IHdvcmtlcnNTdGF0dXMsIGlzc3Vlczogd29ya2Vyc0lzc3VlcyB9LFxyXG4gICAgfTtcclxufVxyXG5cclxuLyoqXHJcbiAqIFRyYW5zZm9ybSB0aGUgZnVsbCBoZWFsdGggY2hlY2sgcmVzdWx0IGludG8gdGhlIG1pbmltYWwgcmVzcG9uc2UgdGhlIE1hdGNoYSBVSSByZXF1aXJlcy5cclxuICovXHJcbmV4cG9ydCBmdW5jdGlvbiB0cmFuc2Zvcm1SZXN1bHRUb1Nob3J0UmVzcG9uc2UocmVzdWx0OiBIZWFsdGhDaGVja1Jlc3VsdCk6IFJmcW1IZWFsdGhDaGVja1Nob3J0UmVzcG9uc2Uge1xyXG4gICAgcmV0dXJuIHtcclxuICAgICAgICBpc09wZXJhdGlvbmFsOiByZXN1bHQuc3RhdHVzID09PSBIZWFsdGhDaGVja1N0YXR1cy5PcGVyYXRpb25hbCB8fCByZXN1bHQuc3RhdHVzID09PSBIZWFsdGhDaGVja1N0YXR1cy5EZWdyYWRlZCxcclxuICAgICAgICBwYWlyczogT2JqZWN0LmVudHJpZXMocmVzdWx0LnBhaXJzKVxyXG4gICAgICAgICAgICAuZmlsdGVyKFxyXG4gICAgICAgICAgICAgICAgKFtfcGFpciwgc3RhdHVzXSkgPT4gc3RhdHVzID09PSBIZWFsdGhDaGVja1N0YXR1cy5PcGVyYXRpb25hbCB8fCBzdGF0dXMgPT09IEhlYWx0aENoZWNrU3RhdHVzLkRlZ3JhZGVkLFxyXG4gICAgICAgICAgICApXHJcbiAgICAgICAgICAgIC5tYXAoKFtwYWlyLCBfc3RhdHVzXSkgPT4ge1xyXG4gICAgICAgICAgICAgICAgY29uc3QgW3Rva2VuQSwgdG9rZW5CXSA9IHBhaXIuc3BsaXQoJy0nKTtcclxuICAgICAgICAgICAgICAgIHJldHVybiBbdG9rZW5BLCB0b2tlbkJdO1xyXG4gICAgICAgICAgICB9KSxcclxuICAgIH07XHJcbn1cclxuXHJcbi8qKlxyXG4gKiBDaGFuZ2VzIHRoZSBzZXQgb2YgdHJhZGluZyBwYWlycyBmcm9tIHRoZSBmb3JtYXQgdXNlZCBpbiBjb25maWcgdG8gdGhlIGZvcm1hdCB1c2VkIGluIHRoZSBoZWFsdGggY2hlY2sgcmVzcG9uc2UuXHJcbiAqL1xyXG5mdW5jdGlvbiB0cmFuc2Zvcm1QYWlycyhvZmZlcmluZ3M6IFJmcU1ha2VyQXNzZXRPZmZlcmluZ3MpOiB7IFtwYWlyOiBzdHJpbmddOiBIZWFsdGhDaGVja1N0YXR1cyB9IHtcclxuICAgIHJldHVybiBPYmplY3QudmFsdWVzKG9mZmVyaW5ncylcclxuICAgICAgICAuZmxhdCgpXHJcbiAgICAgICAgLnJlZHVjZSgocmVzdWx0OiB7IFtwYWlyOiBzdHJpbmddOiBIZWFsdGhDaGVja1N0YXR1cyB9LCBwYWlyKSA9PiB7XHJcbiAgICAgICAgICAgIGNvbnN0IFt0b2tlbkEsIHRva2VuQl0gPSBwYWlyLnNvcnQoKTtcclxuICAgICAgICAgICAgLy8gQ3VycmVudGx5LCB3ZSBhc3N1bWUgYWxsIHBhaXJzIGFyZSBvcGVyYXRpb24uIEluIHRoZSBmdXR1cmUsIHRoaXMgbWF5IG5vdCBiZSB0aGUgY2FzZS5cclxuICAgICAgICAgICAgcmVzdWx0W2Ake3Rva2VuQX0tJHt0b2tlbkJ9YF0gPSBIZWFsdGhDaGVja1N0YXR1cy5PcGVyYXRpb25hbDtcclxuICAgICAgICAgICAgcmV0dXJuIHJlc3VsdDtcclxuICAgICAgICB9LCB7fSk7XHJcbn1cclxuXHJcbi8qKlxyXG4gKiBDcmVhdGVzIGlzc3VlcyByZWxhdGVkIHRvIHRoZSBzZXJ2ZXIvQVBJIG5vdCBzcGVjaWZpYyB0byB0aGUgd29ya2VyIGZhcm0uXHJcbiAqL1xyXG5leHBvcnQgZnVuY3Rpb24gZ2V0SHR0cElzc3Vlcyhpc01haW50YWluZW5jZU1vZGU6IGJvb2xlYW4pOiBIZWFsdGhDaGVja0lzc3VlW10ge1xyXG4gICAgY29uc3QgaXNzdWVzOiBIZWFsdGhDaGVja0lzc3VlW10gPSBbXTtcclxuICAgIGlmIChpc01haW50YWluZW5jZU1vZGUpIHtcclxuICAgICAgICBpc3N1ZXMucHVzaCh7XHJcbiAgICAgICAgICAgIHN0YXR1czogSGVhbHRoQ2hlY2tTdGF0dXMuTWFpbnRlbmFuY2UsXHJcbiAgICAgICAgICAgIGRlc2NyaXB0aW9uOiAnUkZRTSBpcyBzZXQgdG8gbWFpbnRhaW5lbmNlIG1vZGUgdmlhIHRoZSAweCBBUEkgY29uZmlndXJhdGlvbicsXHJcbiAgICAgICAgICAgIGxhYmVsOiAnUkZRTV9NQUlOVEVOQU5DRV9NT0RFIGNvbmZpZyBgdHJ1ZWAnLFxyXG4gICAgICAgIH0pO1xyXG4gICAgfVxyXG4gICAgcmV0dXJuIGlzc3VlcztcclxufVxyXG5cclxuLyoqXHJcbiAqIFJ1bnMgY2hlY2tzIG9uIHRoZSBTUVMgcXVldWUgdG8gZGV0ZWN0IGlmIHRoZXJlIGFyZSBtZXNzYWdlcyBwaWxpbmcgdXAuXHJcbiAqL1xyXG5leHBvcnQgYXN5bmMgZnVuY3Rpb24gY2hlY2tTcXNRdWV1ZUFzeW5jKHByb2R1Y2VyOiBQcm9kdWNlcik6IFByb21pc2U8SGVhbHRoQ2hlY2tJc3N1ZVtdPiB7XHJcbiAgICBjb25zdCByZXN1bHRzOiBIZWFsdGhDaGVja0lzc3VlW10gPSBbXTtcclxuICAgIGNvbnN0IG1lc3NhZ2VzSW5RdWV1ZSA9IGF3YWl0IHByb2R1Y2VyLnF1ZXVlU2l6ZSgpO1xyXG4gICAgaWYgKG1lc3NhZ2VzSW5RdWV1ZSA9PT0gMCkge1xyXG4gICAgICAgIHJldHVybiByZXN1bHRzO1xyXG4gICAgfVxyXG4gICAgaWYgKG1lc3NhZ2VzSW5RdWV1ZSA+IFNRU19RVUVVRV9TSVpFX0ZBSUxFRF9USFJFU0hPTEQpIHtcclxuICAgICAgICByZXN1bHRzLnB1c2goe1xyXG4gICAgICAgICAgICBzdGF0dXM6IEhlYWx0aENoZWNrU3RhdHVzLkZhaWxlZCxcclxuICAgICAgICAgICAgZGVzY3JpcHRpb246IGBTUVMgcXVldWUgY29udGFpbnMgJHttZXNzYWdlc0luUXVldWV9IG1lc3NhZ2VzICh0aHJlc2hvbGQgaXMgJHtTUVNfUVVFVUVfU0laRV9GQUlMRURfVEhSRVNIT0xEfSlgLFxyXG4gICAgICAgICAgICBsYWJlbDogJ3F1ZXVlIHNpemUnLFxyXG4gICAgICAgIH0pO1xyXG4gICAgfSBlbHNlIGlmIChtZXNzYWdlc0luUXVldWUgPiBTUVNfUVVFVUVfU0laRV9ERUdSQURFRF9USFJFU0hPTEQpIHtcclxuICAgICAgICByZXN1bHRzLnB1c2goe1xyXG4gICAgICAgICAgICBzdGF0dXM6IEhlYWx0aENoZWNrU3RhdHVzLkRlZ3JhZGVkLFxyXG4gICAgICAgICAgICBkZXNjcmlwdGlvbjogYFNRUyBxdWV1ZSBjb250YWlucyAke21lc3NhZ2VzSW5RdWV1ZX0gbWVzc2FnZXMgKHRocmVzaG9sZCBpcyAke1NRU19RVUVVRV9TSVpFX0RFR1JBREVEX1RIUkVTSE9MRH0pYCxcclxuICAgICAgICAgICAgbGFiZWw6ICdxdWV1ZSBzaXplJyxcclxuICAgICAgICB9KTtcclxuICAgIH1cclxuICAgIHJldHVybiByZXN1bHRzO1xyXG59XHJcblxyXG4vKipcclxuICogUmV0dXJucyBhIG51bWVyaWNhbCB2YWx1ZSB3aGljaCBjb3JyZXNwb25kcyB0byB0aGUgXCJzZXZlcml0eVwiIG9mIGEgYEhlYWx0aENoZWNrU3RhdHVzYCBlbnVtIG1lbWJlci5cclxuICogSGlnaGVyIHZhbHVlcyBhcmUgbW9yZSBzZXZlcmUuIChPaCB0byBoYXZlIFN3aWZ0TGFuZyBlbnVtcyBoZXJlLilcclxuICovXHJcbmZ1bmN0aW9uIHN0YXR1c1NldmVyaXR5KHN0YXR1czogSGVhbHRoQ2hlY2tTdGF0dXMpOiBudW1iZXIge1xyXG4gICAgLy8gdHNsaW50OmRpc2FibGUgY3VzdG9tLW5vLW1hZ2ljLW51bWJlcnNcclxuICAgIHN3aXRjaCAoc3RhdHVzKSB7XHJcbiAgICAgICAgY2FzZSBIZWFsdGhDaGVja1N0YXR1cy5GYWlsZWQ6XHJcbiAgICAgICAgICAgIHJldHVybiA0O1xyXG4gICAgICAgIGNhc2UgSGVhbHRoQ2hlY2tTdGF0dXMuTWFpbnRlbmFuY2U6XHJcbiAgICAgICAgICAgIHJldHVybiAzO1xyXG4gICAgICAgIGNhc2UgSGVhbHRoQ2hlY2tTdGF0dXMuRGVncmFkZWQ6XHJcbiAgICAgICAgICAgIHJldHVybiAyO1xyXG4gICAgICAgIGNhc2UgSGVhbHRoQ2hlY2tTdGF0dXMuT3BlcmF0aW9uYWw6XHJcbiAgICAgICAgICAgIHJldHVybiAxO1xyXG4gICAgICAgIGRlZmF1bHQ6XHJcbiAgICAgICAgICAgIHRocm93IG5ldyBFcnJvcihgUmVjZWl2ZWQgdW5rbm93biBzdGF0dXM6ICR7c3RhdHVzfWApO1xyXG4gICAgfVxyXG4gICAgLy8gdHNsaW50OmVuYWJsZSBjdXN0b20tbm8tbWFnaWMtbnVtYmVyc1xyXG59XHJcblxyXG4vKipcclxuICogQWNjZXB0cyBhIGxpc3Qgb2Ygc3RhdHVzZXMgYW5kIHJldHVybnMgdGhlIHdvcnN0IHN0YXR1c1xyXG4gKi9cclxuZnVuY3Rpb24gZ2V0V29yc3RTdGF0dXMoc3RhdHVzZXM6IEhlYWx0aENoZWNrU3RhdHVzW10pOiBIZWFsdGhDaGVja1N0YXR1cyB7XHJcbiAgICBpZiAoIXN0YXR1c2VzLmxlbmd0aCkge1xyXG4gICAgICAgIHJldHVybiBIZWFsdGhDaGVja1N0YXR1cy5PcGVyYXRpb25hbDtcclxuICAgIH1cclxuICAgIHJldHVybiBzdGF0dXNlcy5yZWR1Y2UoXHJcbiAgICAgICAgKHdvcnN0U3RhdHVzLCBjdXJyZW50U3RhdHVzKSA9PlxyXG4gICAgICAgICAgICBzdGF0dXNTZXZlcml0eShjdXJyZW50U3RhdHVzKSA+IHN0YXR1c1NldmVyaXR5KHdvcnN0U3RhdHVzKSA/IGN1cnJlbnRTdGF0dXMgOiB3b3JzdFN0YXR1cyxcclxuICAgICAgICBIZWFsdGhDaGVja1N0YXR1cy5PcGVyYXRpb25hbCxcclxuICAgICk7XHJcbn1cclxuXHJcbi8qKlxyXG4gKiBMb29rcyBhdCB0aGUgd29ya2VyIGhlYXJ0YmVhdHMgYW5kIHByb2R1Y2VzIGFwcHJvcHJpYXRlIGlzc3VlcyBiYXNlZCBvbiB0aGUgYWdlXHJcbiAqIG9mIHRoZSBoZWFydGJlYXRzIGFuZCB0aGUgd29ya2VyIGJhbGFuY2VzLlxyXG4gKlxyXG4gKiBIZWFydGJlYXQgQWdlOiBDaGVja3MgdGhlIG1vc3QgcmVjZW50IGhlYXJ0YmVhdCBhbmQgcHJvZHVjZXMgYSBGQUlMRUQgaXNzdWUgaWYgaXQgaXMgb2xkZXIgdGhhbiB0aGUgZmFpbGVkXHJcbiAqIHRocmVzaG9sZC4gRm9yIGhlYXJ0YmVhdHMgb3RoZXIgdGhhbiB0aGUgbW9zdCByZWNlbnQsIHdpbGwgb25seSBwcm9kdWNlIGEgREVHUkFERUQgaXNzdWUuIChpLmUuIHRoZSBjaGVjayBvbmx5XHJcbiAqIGZhaWxzIGlmIEFMTCB3b3JrZXJzIGFyZSBzdHVjaylcclxuICpcclxuICogV29ya2VyIEJhbGFuY2U6IExpa2Ugd2l0aCB0aGUgYWdlIGNoZWNrLCB0aGlzIG9ubHkgcHJvZHVjZXMgYSBGQUlMRUQgaXNzdWUgaWYgYWxsIHdvcmtlcnMgYXJlIGJlbG93IHRoZSBmYWlsZWRcclxuICogYmFsYW5jZS4gSW5kaXZpZHVhbCB3b3JrZXIgYmFsYW5jZXMgcHJvZHVjZSBhIERFR1JBREVEIGlzc3VlIGlmIHRoZXkgYXJlIGJlbG93IEJBTEFOQ0VfREVHUkFERURfVEhSRVNIT0xELlxyXG4gKlxyXG4gKiBDdXJyZW50IGRhdGUgaXMgYW4gb3B0aW9uYWwgcGFyYW1ldGVyIGZvciB0ZXN0aW5nLlxyXG4gKi9cclxuZXhwb3J0IGFzeW5jIGZ1bmN0aW9uIGNoZWNrV29ya2VySGVhcnRiZWF0c0FzeW5jKFxyXG4gICAgaGVhcnRiZWF0czogUmZxbVdvcmtlckhlYXJ0YmVhdEVudGl0eVtdLFxyXG4gICAgbm93RGF0ZTogRGF0ZSA9IG5ldyBEYXRlKCksXHJcbik6IFByb21pc2U8SGVhbHRoQ2hlY2tJc3N1ZVtdPiB7XHJcbiAgICBjb25zdCByZXN1bHRzOiBIZWFsdGhDaGVja0lzc3VlW10gPSBbXTtcclxuICAgIGlmICghaGVhcnRiZWF0cy5sZW5ndGgpIHtcclxuICAgICAgICByZXR1cm4gW1xyXG4gICAgICAgICAgICB7XHJcbiAgICAgICAgICAgICAgICBzdGF0dXM6IEhlYWx0aENoZWNrU3RhdHVzLkZhaWxlZCxcclxuICAgICAgICAgICAgICAgIGRlc2NyaXB0aW9uOiAnTm8gd29ya2VyIGhlYXJ0YmVhdHMgd2VyZSBmb3VuZCcsXHJcbiAgICAgICAgICAgICAgICBsYWJlbDogJ3dvcmtlciBoZWFydGJlYXQnLFxyXG4gICAgICAgICAgICB9LFxyXG4gICAgICAgIF07XHJcbiAgICB9XHJcblxyXG4gICAgLy8gSGVhcnRiZWF0IEFnZVxyXG4gICAgY29uc3Qgc29ydGVkSGVhcnRiZWF0cyA9IGhlYXJ0YmVhdHMuc29ydCgoYSwgYikgPT4gYi50aW1lc3RhbXAuZ2V0VGltZSgpIC0gYS50aW1lc3RhbXAuZ2V0VGltZSgpKTtcclxuICAgIGNvbnN0IG5ld2VzdEhlYXJ0YmVhdCA9IHNvcnRlZEhlYXJ0YmVhdHNbMF07XHJcbiAgICBjb25zdCBuZXdlc3RIZWFydGJlYXRBZ2VNaW51dGVzID0gKG5vd0RhdGUuZ2V0VGltZSgpIC0gbmV3ZXN0SGVhcnRiZWF0LnRpbWVzdGFtcC5nZXRUaW1lKCkpIC8gTVNfSU5fTUlOVVRFO1xyXG4gICAgaWYgKG5ld2VzdEhlYXJ0YmVhdEFnZU1pbnV0ZXMgPiBSRUNFTlRfSEVBUlRCRUFUX0FHRV9USFJFU0hPTEQpIHtcclxuICAgICAgICByZXN1bHRzLnB1c2goe1xyXG4gICAgICAgICAgICBzdGF0dXM6IEhlYWx0aENoZWNrU3RhdHVzLkZhaWxlZCxcclxuICAgICAgICAgICAgZGVzY3JpcHRpb246IGBObyB3b3JrZXIgaGFzIHB1Ymxpc2hlZCBhIGhlYXJ0YmVhdCBpbiB0aGUgbGFzdCAke1JFQ0VOVF9IRUFSVEJFQVRfQUdFX1RIUkVTSE9MRH0gbWludXRlc2AsXHJcbiAgICAgICAgICAgIGxhYmVsOiAnd29ya2VyIGhlYXJ0YmVhdCcsXHJcbiAgICAgICAgfSk7XHJcbiAgICB9XHJcbiAgICAvLyBUT0RPIChyaGlub2RhdmlkKTogVGhpbmsgYWJvdXQgaG93IHRoaXMgd2lsbCB3b3JrIHdoZW4gd2UgZG93bnNjYWxlIGFuZCBhIHdvcmtlciBpc24ndCBwcm9kdWNpbmcgbmV3XHJcbiAgICAvLyBoZWFyYmVhdHMgYmVjYXVzZSBpdCdzIGJlZW4gcmVtb3ZlZC5cclxuICAgIHNvcnRlZEhlYXJ0YmVhdHMuZm9yRWFjaCgoeyBpbmRleCwgdGltZXN0YW1wLCBhZGRyZXNzIH0pID0+IHtcclxuICAgICAgICBjb25zdCBoZWFydGJlYXRBZ2VNaW51dGVzID0gKG5vd0RhdGUuZ2V0VGltZSgpIC0gdGltZXN0YW1wLmdldFRpbWUoKSkgLyBNU19JTl9NSU5VVEU7XHJcbiAgICAgICAgaWYgKGhlYXJ0YmVhdEFnZU1pbnV0ZXMgPj0gUkVDRU5UX0hFQVJUQkVBVF9BR0VfVEhSRVNIT0xEKSB7XHJcbiAgICAgICAgICAgIHJlc3VsdHMucHVzaCh7XHJcbiAgICAgICAgICAgICAgICBzdGF0dXM6IEhlYWx0aENoZWNrU3RhdHVzLkRlZ3JhZGVkLFxyXG4gICAgICAgICAgICAgICAgZGVzY3JpcHRpb246IGBXb3JrZXIgJHtpbmRleH0gKCR7YWRkcmVzc30pIGxhc3QgaGVhcnRiZWF0IHdhcyAke2hlYXJ0YmVhdEFnZU1pbnV0ZXN9IGFnb2AsXHJcbiAgICAgICAgICAgICAgICBsYWJlbDogJ3dvcmtlciBoZWFydGJlYXQnLFxyXG4gICAgICAgICAgICB9KTtcclxuICAgICAgICB9XHJcbiAgICB9KTtcclxuXHJcbiAgICAvLyBCYWxhbmNlc1xyXG4gICAgY29uc3QgaGVhcnRiZWF0c0Fib3ZlQ3JpdGljYWxCYWxhbmNlVGhyZXNob2xkID0gaGVhcnRiZWF0cy5maWx0ZXIoKHsgYmFsYW5jZSB9KSA9PlxyXG4gICAgICAgIGJhbGFuY2UuaXNHcmVhdGVyVGhhbk9yRXF1YWxUbyhCQUxBTkNFX0ZBSUxFRF9USFJFU0hPTERfV0VJKSxcclxuICAgICk7XHJcbiAgICBpZiAoaGVhcnRiZWF0c0Fib3ZlQ3JpdGljYWxCYWxhbmNlVGhyZXNob2xkLmxlbmd0aCA9PT0gMCkge1xyXG4gICAgICAgIHJlc3VsdHMucHVzaCh7XHJcbiAgICAgICAgICAgIHN0YXR1czogSGVhbHRoQ2hlY2tTdGF0dXMuRmFpbGVkLFxyXG4gICAgICAgICAgICBkZXNjcmlwdGlvbjogYE5vIHdvcmtlciBoYXMgYSBiYWxhbmNlIGdyZWF0ZXIgdGhhbiB0aGUgZmFpbGVkIHRocmVzaG9sZCAoJHtCQUxBTkNFX0ZBSUxFRF9USFJFU0hPTER9KWAsXHJcbiAgICAgICAgICAgIGxhYmVsOiAnd29ya2VyIGhlYXJ0YmVhdCcsXHJcbiAgICAgICAgfSk7XHJcbiAgICB9XHJcblxyXG4gICAgY29uc3QgaGVhcnRiZWF0c0Fib3ZlRGVncmFkZWRCYWxhbmNlVGhyZXNob2xkID0gaGVhcnRiZWF0cy5maWx0ZXIoKHsgYmFsYW5jZSB9KSA9PlxyXG4gICAgICAgIGJhbGFuY2UuaXNHcmVhdGVyVGhhbihCQUxBTkNFX0RFR1JBREVEX1RIUkVTSE9MRF9XRUkpLFxyXG4gICAgKTtcclxuICAgIGlmIChoZWFydGJlYXRzQWJvdmVEZWdyYWRlZEJhbGFuY2VUaHJlc2hvbGQubGVuZ3RoIDwgMikge1xyXG4gICAgICAgIHJlc3VsdHMucHVzaCh7XHJcbiAgICAgICAgICAgIHN0YXR1czogSGVhbHRoQ2hlY2tTdGF0dXMuRGVncmFkZWQsXHJcbiAgICAgICAgICAgIGRlc2NyaXB0aW9uOiBgTGVzcyB0aGFuIHR3byB3b3JrZXJzIGhhdmUgYSBiYWxhbmNlIGFib3ZlIHRoZSBkZWdyYWRlZCB0aHJlc2hvbGQgKCR7QkFMQU5DRV9ERUdSQURFRF9USFJFU0hPTER9KWAsXHJcbiAgICAgICAgICAgIGxhYmVsOiAnd29ya2VyIGhlYXJ0YmVhdCcsXHJcbiAgICAgICAgfSk7XHJcbiAgICB9XHJcbiAgICByZXR1cm4gcmVzdWx0cztcclxufVxyXG4iXSwidmVyc2lvbiI6M30=