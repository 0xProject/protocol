b1c5fde986ed91b9d625a573d48d29f5
"use strict";
Object.defineProperty(exports, "__esModule", { value: true });
exports.SubmissionContext = exports.BLOCK_FINALITY_THRESHOLD = void 0;
const utils_1 = require("@0x/utils");
const constants_1 = require("../core/constants");
const types_1 = require("../entities/types");
exports.BLOCK_FINALITY_THRESHOLD = 3;
// https://stackoverflow.com/questions/47632622/typescript-and-filter-boolean
function isDefined(value) {
    return value !== null && value !== undefined;
}
/**
 * Encapsulates the transaction submissions for an RFQM job.
 *
 * Since one job can have multiple transactions, this class is used to treat them
 * all as one unit. It ensures consistency across transactions and makes retrieval
 * of the mined transaction receipt, if one exists, easy.
 */
class SubmissionContext {
    constructor(blockchainUtils, transactions) {
        this._ensureTransactionsAreConsistent(transactions);
        // $eslint-fix-me https://github.com/rhinodavid/eslint-fix-me
        // eslint-disable-next-line no-extra-boolean-cast
        this._transactionType = !!transactions[0].gasPrice ? 0 : 2;
        this._transactions = transactions;
        this._blockchainUtils = blockchainUtils;
    }
    static isBlockConfirmed(currentBlock, receiptBlockNumber) {
        // We specify a finality threshold of n blocks deep to have greater confidence
        // in the transaction receipt
        return currentBlock - receiptBlockNumber >= exports.BLOCK_FINALITY_THRESHOLD;
    }
    /**
     * Get corresponding job status given status of submission context for `RfqmTransactionSubmissionType.Approval`.
     * Different submission context status would trigger different job status transition.
     *
     * @returns Corresponding job status.
     */
    static approvalSubmissionContextStatusToJobStatus(submissionContextStatus) {
        switch (submissionContextStatus) {
            case types_1.SubmissionContextStatus.FailedExpired:
                return types_1.RfqmJobStatus.FailedExpired;
            case types_1.SubmissionContextStatus.FailedRevertedConfirmed:
                return types_1.RfqmJobStatus.FailedRevertedConfirmed;
            case types_1.SubmissionContextStatus.FailedRevertedUnconfirmed:
                return types_1.RfqmJobStatus.FailedRevertedUnconfirmed;
            case types_1.SubmissionContextStatus.PendingSubmitted:
            case types_1.SubmissionContextStatus.SucceededConfirmed:
            case types_1.SubmissionContextStatus.SucceededUnconfirmed:
                // For the first version of gasless approval, a successful approval submission
                // would still keep the job in pending submitted status
                return types_1.RfqmJobStatus.PendingSubmitted;
            default:
                ((_x) => {
                    throw new Error('unreachable');
                })(submissionContextStatus);
        }
    }
    /**
     * Get corresponding job status given status of submission context for `RfqmTransactionSubmissionType.Trade`.
     * Different submission context status would trigger different job status transition.
     *
     * @param submissionContextStatus Status of submission context.
     */
    static tradeSubmissionContextStatusToJobStatus(submissionContextStatus) {
        switch (submissionContextStatus) {
            case types_1.SubmissionContextStatus.FailedExpired:
                return types_1.RfqmJobStatus.FailedExpired;
            case types_1.SubmissionContextStatus.FailedRevertedConfirmed:
                return types_1.RfqmJobStatus.FailedRevertedConfirmed;
            case types_1.SubmissionContextStatus.FailedRevertedUnconfirmed:
                return types_1.RfqmJobStatus.FailedRevertedUnconfirmed;
            case types_1.SubmissionContextStatus.PendingSubmitted:
                return types_1.RfqmJobStatus.PendingSubmitted;
            case types_1.SubmissionContextStatus.SucceededConfirmed:
                return types_1.RfqmJobStatus.SucceededConfirmed;
            case types_1.SubmissionContextStatus.SucceededUnconfirmed:
                return types_1.RfqmJobStatus.SucceededUnconfirmed;
            default:
                ((_x) => {
                    throw new Error('unreachable');
                })(submissionContextStatus);
        }
    }
    get transactions() {
        return this._transactions;
    }
    // Gets the transaction hashes for the transactions in the SubmissionContext
    get transactionHashes() {
        return this._transactions.map((t) => t.transactionHash).filter(isDefined);
    }
    /**
     * Gets the type of the transactions in the `SubmissionContext`:
     * 0 for non-EIP1559 transactions and 2 for EIP-1559 transactions.
     */
    get transactionType() {
        return this._transactionType;
    }
    /**
     * Adds a transaction to the SubmissionContext. Throws if the transaction has a nonce or type
     * different than the existing transactions.
     */
    addTransaction(transaction) {
        // TODO (Vic): Remove any[] once https://github.com/microsoft/TypeScript/issues/44373 is fixed
        // $eslint-fix-me https://github.com/rhinodavid/eslint-fix-me
        // eslint-disable-next-line @typescript-eslint/no-explicit-any
        this._transactions.push(transaction);
        this._ensureTransactionsAreConsistent(this._transactions);
    }
    /**
     * Gets the nonce of the transactions of the `SubmissionContext`
     */
    get nonce() {
        const nonce = this._transactions[0].nonce;
        if (nonce === undefined || nonce === null) {
            throw new Error('Transaction does not have a nonce');
        }
        return nonce;
    }
    /**
     * Gets the max gas price set for any transaction in the `SubmissionContext`
     */
    get maxGasPrice() {
        if (this._transactionType !== 0) {
            throw new Error('Attempted to access the max gas price of a EIP-1559 transaction set');
        }
        return (this._transactions
            // $eslint-fix-me https://github.com/rhinodavid/eslint-fix-me
            // eslint-disable-next-line @typescript-eslint/no-non-null-assertion
            .map((t) => t.gasPrice)
            .filter(Boolean)
            .reduce((result, gasPrice) => utils_1.BigNumber.maximum(result, gasPrice)));
    }
    /**
     * Gets the maximum values for the `maxFeePerGas` and the `maxPriorityFeePerGas` for a
     * set of EIP-1559 transactions.
     */
    get maxGasFees() {
        if (this._transactionType !== 2) {
            throw new Error('Attempted to access the max gas fees for a non-EIP-1559 transaction set');
        }
        return {
            // $eslint-fix-me https://github.com/rhinodavid/eslint-fix-me
            // eslint-disable-next-line @typescript-eslint/no-non-null-assertion
            maxFeePerGas: utils_1.BigNumber.maximum(...this._transactions.map((t) => t.maxFeePerGas)),
            // $eslint-fix-me https://github.com/rhinodavid/eslint-fix-me
            // eslint-disable-next-line @typescript-eslint/no-non-null-assertion
            maxPriorityFeePerGas: utils_1.BigNumber.maximum(...this._transactions.map((t) => t.maxPriorityFeePerGas)),
        };
    }
    /**
     * Gets the epoch time, in seconds, of the earliest transaction submission.
     * Note: This uses the database time the transaction submission was created,
     * not the blockchain timestamp.
     */
    get firstSubmissionTimestampS() {
        const submissionCreationTimesS = this._transactions
            .map((t) => t.createdAt.getTime() / constants_1.ONE_SECOND_MS)
            .map((t) => Math.round(t));
        return submissionCreationTimesS.reduce((result, time) => Math.min(result, time), Infinity);
    }
    /**
     * Returns the transaction receipt if one of the transactions in the SubmissionContext
     * has been mined; otherwise returns `null`.
     */
    async getReceiptAsync() {
        // $eslint-fix-me https://github.com/rhinodavid/eslint-fix-me
        /* eslint-disable @typescript-eslint/no-non-null-assertion */
        const receipts = (await this._blockchainUtils.getReceiptsAsync(this._transactions.map((t) => t.transactionHash))).filter(isDefined);
        /* eslint-enable @typescript-eslint/no-non-null-assertion */
        if (receipts.length > 1) {
            throw new Error('Found more than one transaction receipt');
        }
        return receipts.length ? receipts[0] : null;
    }
    /**
     * 1. Updates the in-memory transactions in response to a mined transaction receipt.
     * 2. Updates the statuses of all transaction submission.
     */
    async updateForReceiptAsync(receipt, now = new Date()) {
        const isTransactionSuccessful = receipt.status === 1;
        const currentBlock = await this._blockchainUtils.getCurrentBlockAsync();
        const isTransactionConfirmed = SubmissionContext.isBlockConfirmed(currentBlock, receipt.blockNumber);
        this._transactions = this._transactions.map((transaction) => {
            transaction.updatedAt = now;
            if (transaction.transactionHash === receipt.transactionHash) {
                const submissionStatus = isTransactionSuccessful
                    ? isTransactionConfirmed
                        ? types_1.RfqmTransactionSubmissionStatus.SucceededConfirmed
                        : types_1.RfqmTransactionSubmissionStatus.SucceededUnconfirmed
                    : isTransactionConfirmed
                        ? types_1.RfqmTransactionSubmissionStatus.RevertedConfirmed
                        : types_1.RfqmTransactionSubmissionStatus.RevertedUnconfirmed;
                transaction.status = submissionStatus;
                transaction.blockMined = new utils_1.BigNumber(receipt.blockNumber);
                transaction.gasUsed = new utils_1.BigNumber(receipt.gasUsed.toString());
                if (transaction.gasPrice === null) {
                    transaction.gasPrice = new utils_1.BigNumber(receipt.effectiveGasPrice.toString());
                }
            }
            else {
                transaction.status = types_1.RfqmTransactionSubmissionStatus.DroppedAndReplaced;
            }
            return transaction;
        });
    }
    /**
     * Returns the appropriate job status given the statuses of the transactions
     */
    get jobStatus() {
        for (const transaction of this._transactions) {
            switch (transaction.status) {
                case types_1.RfqmTransactionSubmissionStatus.DroppedAndReplaced:
                    continue;
                case types_1.RfqmTransactionSubmissionStatus.Presubmit:
                    continue;
                case types_1.RfqmTransactionSubmissionStatus.RevertedConfirmed:
                    return types_1.RfqmJobStatus.FailedRevertedConfirmed;
                case types_1.RfqmTransactionSubmissionStatus.RevertedUnconfirmed:
                    return types_1.RfqmJobStatus.FailedRevertedUnconfirmed;
                case types_1.RfqmTransactionSubmissionStatus.Submitted:
                    continue;
                case types_1.RfqmTransactionSubmissionStatus.SucceededConfirmed:
                    return types_1.RfqmJobStatus.SucceededConfirmed;
                case types_1.RfqmTransactionSubmissionStatus.SucceededUnconfirmed:
                    return types_1.RfqmJobStatus.SucceededUnconfirmed;
                default:
                    ((_x) => {
                        throw new Error('unreachable');
                    })(transaction.status);
            }
        }
        return types_1.RfqmJobStatus.PendingSubmitted;
    }
    /**
     * Returns the submission context status given the statuses of the transactions. A submission context contains
     * multiple transactions and the submission context status is the collective status for all transactions.
     */
    get submissionContextStatus() {
        for (const transaction of this._transactions) {
            switch (transaction.status) {
                case types_1.RfqmTransactionSubmissionStatus.DroppedAndReplaced:
                    continue;
                case types_1.RfqmTransactionSubmissionStatus.Presubmit:
                    continue;
                case types_1.RfqmTransactionSubmissionStatus.RevertedConfirmed:
                    return types_1.SubmissionContextStatus.FailedRevertedConfirmed;
                case types_1.RfqmTransactionSubmissionStatus.RevertedUnconfirmed:
                    return types_1.SubmissionContextStatus.FailedRevertedUnconfirmed;
                case types_1.RfqmTransactionSubmissionStatus.Submitted:
                    continue;
                case types_1.RfqmTransactionSubmissionStatus.SucceededConfirmed:
                    return types_1.SubmissionContextStatus.SucceededConfirmed;
                case types_1.RfqmTransactionSubmissionStatus.SucceededUnconfirmed:
                    return types_1.SubmissionContextStatus.SucceededUnconfirmed;
                default:
                    throw new Error(`Transaction status ${transaction.status} should not be reached`);
            }
        }
        return types_1.SubmissionContextStatus.PendingSubmitted;
    }
    /**
     * Assesses whether the given transactions have the same nonce, type (EIP-1559 or not),
     * and unique transaction hashes; throws if they do not.
     *
     * Throws if `transactions` has a zero length.
     *
     * `perfer-function-over-method` rule is disabled to since a function would not be able to use the
     * `T` generic type.
     */
    // tslint:disable-next-line: prefer-function-over-method
    _ensureTransactionsAreConsistent(transactions) {
        if (!transactions.length) {
            throw new Error('`transactions` must have a nonzero length');
        }
        if (!transactions.map((t) => t.nonce).every((n, _, nonces) => n === nonces[0])) {
            throw new Error('Transactions do not have the same nonce');
        }
        if (new Set(transactions.map((t) => t.transactionHash)).size !== transactions.length) {
            throw new Error('Transactions are not unique');
        }
        // TODO (Vic): Remove any[] once https://github.com/microsoft/TypeScript/issues/44373 is fixed
        // $eslint-fix-me https://github.com/rhinodavid/eslint-fix-me
        // eslint-disable-next-line @typescript-eslint/no-explicit-any
        const areAllGasPricesNonNull = transactions.every((t) => t.gasPrice !== null);
        // $eslint-fix-me https://github.com/rhinodavid/eslint-fix-me
        // eslint-disable-next-line @typescript-eslint/no-explicit-any
        const areAllMaxFeesPerGasNonNull = transactions.every((t) => t.maxFeePerGas !== null);
        // $eslint-fix-me https://github.com/rhinodavid/eslint-fix-me
        // eslint-disable-next-line @typescript-eslint/no-explicit-any
        const areAllMaxPriorityFeesPerGasNonNull = transactions.every((t) => t.maxPriorityFeePerGas !== null);
        if (!(areAllGasPricesNonNull || (areAllMaxFeesPerGasNonNull && areAllMaxPriorityFeesPerGasNonNull))) {
            throw new Error('Transactions do not have the same gas type');
        }
    }
}
exports.SubmissionContext = SubmissionContext;
//# sourceMappingURL=data:application/json;charset=utf-8;base64,eyJmaWxlIjoiL1VzZXJzL2Rhdmlkd2Fsc2gvY29kZS1sb2NhbC8weC1yZnEtYXBpL3NyYy91dGlscy9TdWJtaXNzaW9uQ29udGV4dC50cyIsIm1hcHBpbmdzIjoiOzs7QUFBQSxxQ0FBc0M7QUFHdEMsaURBQWtEO0FBRWxELDZDQUE0RztBQUkvRixRQUFBLHdCQUF3QixHQUFHLENBQUMsQ0FBQztBQUkxQyw2RUFBNkU7QUFDN0UsU0FBUyxTQUFTLENBQUksS0FBUTtJQUMxQixPQUFPLEtBQUssS0FBSyxJQUFJLElBQUksS0FBSyxLQUFLLFNBQVMsQ0FBQztBQUNqRCxDQUFDO0FBRUQ7Ozs7OztHQU1HO0FBQ0gsTUFBYSxpQkFBaUI7SUFxRTFCLFlBQVksZUFBbUMsRUFBRSxZQUFlO1FBQzVELElBQUksQ0FBQyxnQ0FBZ0MsQ0FBQyxZQUFZLENBQUMsQ0FBQztRQUNwRCw2REFBNkQ7UUFDN0QsaURBQWlEO1FBQ2pELElBQUksQ0FBQyxnQkFBZ0IsR0FBRyxDQUFDLENBQUMsWUFBWSxDQUFDLENBQUMsQ0FBQyxDQUFDLFFBQVEsQ0FBQyxDQUFDLENBQUMsQ0FBQyxDQUFDLENBQUMsQ0FBQyxDQUFDLENBQUM7UUFDM0QsSUFBSSxDQUFDLGFBQWEsR0FBRyxZQUFZLENBQUM7UUFDbEMsSUFBSSxDQUFDLGdCQUFnQixHQUFHLGVBQWUsQ0FBQztJQUM1QyxDQUFDO0lBdkVNLE1BQU0sQ0FBQyxnQkFBZ0IsQ0FBQyxZQUFvQixFQUFFLGtCQUEwQjtRQUMzRSw4RUFBOEU7UUFDOUUsNkJBQTZCO1FBQzdCLE9BQU8sWUFBWSxHQUFHLGtCQUFrQixJQUFJLGdDQUF3QixDQUFDO0lBQ3pFLENBQUM7SUFFRDs7Ozs7T0FLRztJQUNJLE1BQU0sQ0FBQywwQ0FBMEMsQ0FDcEQsdUJBQWdEO1FBRWhELFFBQVEsdUJBQXVCLEVBQUU7WUFDN0IsS0FBSywrQkFBdUIsQ0FBQyxhQUFhO2dCQUN0QyxPQUFPLHFCQUFhLENBQUMsYUFBYSxDQUFDO1lBQ3ZDLEtBQUssK0JBQXVCLENBQUMsdUJBQXVCO2dCQUNoRCxPQUFPLHFC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QkFBc0IsR0FBSSxZQUFzQixDQUFDLEtBQUssQ0FBQyxDQUFDLENBQUMsRUFBRSxFQUFFLENBQUMsQ0FBQyxDQUFDLFFBQVEsS0FBSyxJQUFJLENBQUMsQ0FBQztRQUN6Riw2REFBNkQ7UUFDN0QsOERBQThEO1FBQzlELE1BQU0sMEJBQTBCLEdBQUksWUFBc0IsQ0FBQyxLQUFLLENBQUMsQ0FBQyxDQUFDLEVBQUUsRUFBRSxDQUFDLENBQUMsQ0FBQyxZQUFZLEtBQUssSUFBSSxDQUFDLENBQUM7UUFDakcsNkRBQTZEO1FBQzdELDhEQUE4RDtRQUM5RCxNQUFNLGtDQUFrQyxHQUFJLFlBQXNCLENBQUMsS0FBSyxDQUNwRSxDQUFDLENBQUMsRUFBRSxFQUFFLENBQUMsQ0FBQyxDQUFDLG9CQUFvQixLQUFLLElBQUksQ0FDekMsQ0FBQztRQUNGLElBQUksQ0FBQyxDQUFDLHNCQUFzQixJQUFJLENBQUMsMEJBQTBCLElBQUksa0NBQWtDLENBQUMsQ0FBQyxFQUFFO1lBQ2pHLE1BQU0sSUFBSSxLQUFLLENBQUMsNENBQTRDLENBQUMsQ0FBQztTQUNqRTtJQUNMLENBQUM7Q0FDSjtBQS9URCw4Q0ErVEMiLCJuYW1lcyI6W10sInNvdXJjZXMiOlsiL1VzZXJzL2Rhdmlkd2Fsc2gvY29kZS1sb2NhbC8weC1yZnEtYXBpL3NyYy91dGlscy9TdWJtaXNzaW9uQ29udGV4dC50cyJdLCJzb3VyY2VzQ29udGVudCI6WyJpbXBvcnQgeyBCaWdOdW1iZXIgfSBmcm9tICdAMHgvdXRpbHMnO1xuaW1wb3J0IHsgcHJvdmlkZXJzIH0gZnJvbSAnZXRoZXJzJztcblxuaW1wb3J0IHsgT05FX1NFQ09ORF9NUyB9IGZyb20gJy4uL2NvcmUvY29uc3RhbnRzJztcbmltcG9ydCB7IE1ldGFUcmFuc2FjdGlvblN1Ym1pc3Npb25FbnRpdHksIFJmcW1WMlRyYW5zYWN0aW9uU3VibWlzc2lvbkVudGl0eSB9IGZyb20gJy4uL2VudGl0aWVzJztcbmltcG9ydCB7IFJmcW1Kb2JTdGF0dXMsIFJmcW1UcmFuc2FjdGlvblN1Ym1pc3Npb25TdGF0dXMsIFN1Ym1pc3Npb25Db250ZXh0U3RhdHVzIH0gZnJvbSAnLi4vZW50aXRpZXMvdHlwZXMnO1xuXG5pbXBvcnQgeyBSZnFCbG9ja2NoYWluVXRpbHMgfSBmcm9tICcuL3JmcV9ibG9ja2NoYWluX3V0aWxzJztcblxuZXhwb3J0IGNvbnN0IEJMT0NLX0ZJTkFMSVRZX1RIUkVTSE9MRCA9IDM7XG5cbnR5cGUgVHJhbnNhY3Rpb25SZWNlaXB0ID0gcHJvdmlkZXJzLlRyYW5zYWN0aW9uUmVjZWlwdDtcblxuLy8gaHR0cHM6Ly9zdGFja292ZXJmbG93LmNvbS9xdWVzdGlvbnMvNDc2MzI2MjIvdHlwZXNjcmlwdC1hbmQtZmlsdGVyLWJvb2xlYW5cbmZ1bmN0aW9uIGlzRGVmaW5lZDxUPih2YWx1ZTogVCk6IHZhbHVlIGlzIE5vbk51bGxhYmxlPFQ+IHtcbiAgICByZXR1cm4gdmFsdWUgIT09IG51bGwgJiYgdmFsdWUgIT09IHVuZGVmaW5lZDtcbn1cblxuLyoqXG4gKiBFbmNhcHN1bGF0ZXMgdGhlIHRyYW5zYWN0aW9uIHN1Ym1pc3Npb25zIGZvciBhbiBSRlFNIGpvYi5cbiAqXG4gKiBTaW5jZSBvbmUgam9iIGNhbiBoYXZlIG11bHRpcGxlIHRyYW5zYWN0aW9ucywgdGhpcyBjbGFzcyBpcyB1c2VkIHRvIHRyZWF0IHRoZW1cbiAqIGFsbCBhcyBvbmUgdW5pdC4gSXQgZW5zdXJlcyBjb25zaXN0ZW5jeSBhY3Jvc3MgdHJhbnNhY3Rpb25zIGFuZCBtYWtlcyByZXRyaWV2YWxcbiAqIG9mIHRoZSBtaW5lZCB0cmFuc2FjdGlvbiByZWNlaXB0LCBpZiBvbmUgZXhpc3RzLCBlYXN5LlxuICovXG5leHBvcnQgY2xhc3MgU3VibWlzc2lvbkNvbnRleHQ8VCBleHRlbmRzIFJmcW1WMlRyYW5zYWN0aW9uU3VibWlzc2lvbkVudGl0eVtdIHwgTWV0YVRyYW5zYWN0aW9uU3VibWlzc2lvbkVudGl0eVtdPiB7XG4gICAgcHJpdmF0ZSBfdHJhbnNhY3Rpb25zOiBUO1xuICAgIHByaXZhdGUgcmVhZG9ubHkgX2Jsb2NrY2hhaW5VdGlsczogUmZxQmxvY2tjaGFpblV0aWxzO1xuICAgIHByaXZhdGUgcmVhZG9ubHkgX3RyYW5zYWN0aW9uVHlwZTogMCB8IDI7XG5cbiAgICBwdWJsaWMgc3RhdGljIGlzQmxvY2tDb25maXJtZWQoY3VycmVudEJsb2NrOiBudW1iZXIsIHJlY2VpcHRCbG9ja051bWJlcjogbnVtYmVyKTogYm9vbGVhbiB7XG4gICAgICAgIC8vIFdlIHNwZWNpZnkgYSBmaW5hbGl0eSB0aHJlc2hvbGQgb2YgbiBibG9ja3MgZGVlcCB0byBoYXZlIGdyZWF0ZXIgY29uZmlkZW5jZVxuICAgICAgICAvLyBpbiB0aGUgdHJhbnNhY3Rpb24gcmVjZWlwdFxuICAgICAgICByZXR1cm4gY3VycmVudEJsb2NrIC0gcmVjZWlwdEJsb2NrTnVtYmVyID49IEJMT0NLX0ZJTkFMSVRZX1RIUkVTSE9MRDtcbiAgICB9XG5cbiAgICAvKipcbiAgICAgKiBHZXQgY29ycmVzcG9uZGluZyBqb2Igc3RhdHVzIGdpdmVuIHN0YXR1cyBvZiBzdWJtaXNzaW9uIGNvbnRleHQgZm9yIGBSZnFtVHJhbnNhY3Rpb25TdWJtaXNzaW9uVHlwZS5BcHByb3ZhbGAuXG4gICAgICogRGlmZmVyZW50IHN1Ym1pc3Npb24gY29udGV4dCBzdGF0dXMgd291bGQgdHJpZ2dlciBkaWZmZXJlbnQgam9iIHN0YXR1cyB0cmFuc2l0aW9uLlxuICAgICAqXG4gICAgICogQHJldHVybnMgQ29ycmVzcG9uZGluZyBqb2Igc3RhdHVzLlxuICAgICAqL1xuICAgIHB1YmxpYyBzdGF0aWMgYXBwcm92YWxTdWJtaXNzaW9uQ29udGV4dFN0YXR1c1RvSm9iU3RhdHVzKFxuICAgICAgICBzdWJtaXNzaW9uQ29udGV4dFN0YXR1czogU3VibWlzc2lvbkNvbnRleHRTdGF0dXMsXG4gICAgKTogUmZxbUpvYlN0YXR1cyB7XG4gICAgICAgIHN3aXRjaCAoc3VibWlzc2lvbkNvbnRleHRTdGF0dXMpIHtcbiAgICAgICAgICAgIGNhc2UgU3VibWlzc2lvbkNvbnRleHRTdGF0dXMuRmFpbGVkRXhwaXJlZDpcbiAgICAgICAgICAgICAgICByZXR1cm4gUmZxbUpvYlN0YXR1cy5GYWlsZWRFeHBpcmVkO1xuICAgICAgICAgICAgY2FzZSBTdWJtaXNzaW9uQ29udGV4dFN0YXR1cy5GYWlsZWRSZXZlcnRlZENvbmZpcm1lZDpcbiAgICAgICAgICAgICAgICByZXR1cm4gUmZxbUpvYlN0YXR1cy5GYWlsZWRSZXZlcnRlZENvbmZpcm1lZDtcbiAgICAgICAgICAgIGNhc2UgU3VibWlzc2lvbkNvbnRleHRTdGF0dXMuRmFpbGVkUmV2ZXJ0ZWRVbmNvbmZpcm1lZDpcbiAgICAgICAgICAgICAgICByZXR1cm4gUmZxbUpvYlN0YXR1cy5GYWlsZWRSZXZlcnRlZFVuY29uZmlybWVkO1xuICAgICAgICAgICAgY2FzZSBTdWJtaXNzaW9uQ29udGV4dFN0YXR1cy5QZW5kaW5nU3VibWl0dGVkOlxuICAgICAgICAgICAgY2FzZSBTdWJtaXNzaW9uQ29udGV4dFN0YXR1cy5TdWNjZWVkZWRDb25maXJtZWQ6XG4gICAgICAgICAgICBjYXNlIFN1Ym1pc3Npb25Db250ZXh0U3RhdHVzLlN1Y2NlZWRlZFVuY29uZmlybWVkOlxuICAgICAgICAgICAgICAgIC8vIEZvciB0aGUgZmlyc3QgdmVyc2lvbiBvZiBnYXNsZXNzIGFwcHJvdmFsLCBhIHN1Y2Nlc3NmdWwgYXBwcm92YWwgc3VibWlzc2lvblxuICAgICAgICAgICAgICAgIC8vIHdvdWxkIHN0aWxsIGtlZXAgdGhlIGpvYiBpbiBwZW5kaW5nIHN1Ym1pdHRlZCBzdGF0dXNcbiAgICAgICAgICAgICAgICByZXR1cm4gUmZxbUpvYlN0YXR1cy5QZW5kaW5nU3VibWl0dGVkO1xuICAgICAgICAgICAgZGVmYXVsdDpcbiAgICAgICAgICAgICAgICAoKF94OiBuZXZlcikgPT4ge1xuICAgICAgICAgICAgICAgICAgICB0aHJvdyBuZXcgRXJyb3IoJ3VucmVhY2hhYmxlJyk7XG4gICAgICAgICAgICAgICAgfSkoc3VibWlzc2lvbkNvbnRleHRTdGF0dXMpO1xuICAgICAgICB9XG4gICAgfVxuXG4gICAgLyoqXG4gICAgICogR2V0IGNvcnJlc3BvbmRpbmcgam9iIHN0YXR1cyBnaXZlbiBzdGF0dXMgb2Ygc3VibWlzc2lvbiBjb250ZXh0IGZvciBgUmZxbVRyYW5zYWN0aW9uU3VibWlzc2lvblR5cGUuVHJhZGVgLlxuICAgICAqIERpZmZlcmVudCBzdWJtaXNzaW9uIGNvbnRleHQgc3RhdHVzIHdvdWxkIHRyaWdnZXIgZGlmZmVyZW50IGpvYiBzdGF0dXMgdHJhbnNpdGlvbi5cbiAgICAgKlxuICAgICAqIEBwYXJhbSBzdWJtaXNzaW9uQ29udGV4dFN0YXR1cyBTdGF0dXMgb2Ygc3VibWlzc2lvbiBjb250ZXh0LlxuICAgICAqL1xuICAgIHB1YmxpYyBzdGF0aWMgdHJhZGVTdWJtaXNzaW9uQ29udGV4dFN0YXR1c1RvSm9iU3RhdHVzKFxuICAgICAgICBzdWJtaXNzaW9uQ29udGV4dFN0YXR1czogU3VibWlzc2lvbkNvbnRleHRTdGF0dXMsXG4gICAgKTogUmZxbUpvYlN0YXR1cyB7XG4gICAgICAgIHN3aXRjaCAoc3VibWlzc2lvbkNvbnRleHRTdGF0dXMpIHtcbiAgICAgICAgICAgIGNhc2UgU3VibWlzc2lvbkNvbnRleHRTdGF0dXMuRmFpbGVkRXhwaXJlZDpcbiAgICAgICAgICAgICAgICByZXR1cm4gUmZxbUpvYlN0YXR1cy5GYWlsZWRFeHBpcmVkO1xuICAgICAgICAgICAgY2FzZSBTdWJtaXNzaW9uQ29udGV4dFN0YXR1cy5GYWlsZWRSZXZlcnRlZENvbmZpcm1lZDpcbiAgICAgICAgICAgICAgICByZXR1cm4gUmZxbUpvYlN0YXR1cy5GYWlsZWRSZXZlcnRlZENvbmZpcm1lZDtcbiAgICAgICAgICAgIGNhc2UgU3VibWlzc2lvbkNvbnRleHRTdGF0dXMuRmFpbGVkUmV2ZXJ0ZWRVbmNvbmZpcm1lZDpcbiAgICAgICAgICAgICAgICByZXR1cm4gUmZxbUpvYlN0YXR1cy5GYWlsZWRSZXZlcnRlZFVuY29uZmlybWVkO1xuICAgICAgICAgICAgY2FzZSBTdWJtaXNzaW9uQ29udGV4dFN0YXR1cy5QZW5kaW5nU3VibWl0dGVkOlxuICAgICAgICAgICAgICAgIHJldHVybiBSZnFtSm9iU3RhdHVzLlBlbmRpbmdTdWJtaXR0ZWQ7XG4gICAgICAgICAgICBjYXNlIFN1Ym1pc3Npb25Db250ZXh0U3RhdHVzLlN1Y2NlZWRlZENvbmZpcm1lZDpcbiAgICAgICAgICAgICAgICByZXR1cm4gUmZxbUpvYlN0YXR1cy5TdWNjZWVkZWRDb25maXJtZWQ7XG4gICAgICAgICAgICBjYXNlIFN1Ym1pc3Npb25Db250ZXh0U3RhdHVzLlN1Y2NlZWRlZFVuY29uZmlybWVkOlxuICAgICAgICAgICAgICAgIHJldHVybiBSZnFtSm9iU3RhdHVzLlN1Y2NlZWRlZFVuY29uZmlybWVkO1xuICAgICAgICAgICAgZGVmYXVsdDpcbiAgICAgICAgICAgICAgICAoKF94OiBuZXZlcikgPT4ge1xuICAgICAgICAgICAgICAgICAgICB0aHJvdyBuZXcgRXJyb3IoJ3VucmVhY2hhYmxlJyk7XG4gICAgICAgICAgICAgICAgfSkoc3VibWlzc2lvbkNvbnRleHRTdGF0dXMpO1xuICAgICAgICB9XG4gICAgfVxuXG4gICAgY29uc3RydWN0b3IoYmxvY2tjaGFpblV0aWxzOiBSZnFCbG9ja2NoYWluVXRpbHMsIHRyYW5zYWN0aW9uczogVCkge1xuICAgICAgICB0aGlzLl9lbnN1cmVUcmFuc2FjdGlvbnNBcmVDb25zaXN0ZW50KHRyYW5zYWN0aW9ucyk7XG4gICAgICAgIC8vICRlc2xpbnQtZml4LW1lIGh0dHBzOi8vZ2l0aHViLmNvbS9yaGlub2RhdmlkL2VzbGludC1maXgtbWVcbiAgICAgICAgLy8gZXNsaW50LWRpc2FibGUtbmV4dC1saW5lIG5vLWV4dHJhLWJvb2xlYW4tY2FzdFxuICAgICAgICB0aGlzLl90cmFuc2FjdGlvblR5cGUgPSAhIXRyYW5zYWN0aW9uc1swXS5nYXNQcmljZSA/IDAgOiAyO1xuICAgICAgICB0aGlzLl90cmFuc2FjdGlvbnMgPSB0cmFuc2FjdGlvbnM7XG4gICAgICAgIHRoaXMuX2Jsb2NrY2hhaW5VdGlscyA9IGJsb2NrY2hhaW5VdGlscztcbiAgICB9XG5cbiAgICBwdWJsaWMgZ2V0IHRyYW5zYWN0aW9ucygpOiBUIHtcbiAgICAgICAgcmV0dXJuIHRoaXMuX3RyYW5zYWN0aW9ucztcbiAgICB9XG5cbiAgICAvLyBHZXRzIHRoZSB0cmFuc2FjdGlvbiBoYXNoZXMgZm9yIHRoZSB0cmFuc2FjdGlvbnMgaW4gdGhlIFN1Ym1pc3Npb25Db250ZXh0XG4gICAgcHVibGljIGdldCB0cmFuc2FjdGlvbkhhc2hlcygpOiBzdHJpbmdbXSB7XG4gICAgICAgIHJldHVybiB0aGlzLl90cmFuc2FjdGlvbnMubWFwKCh0KSA9PiB0LnRyYW5zYWN0aW9uSGFzaCkuZmlsdGVyKGlzRGVmaW5lZCk7XG4gICAgfVxuXG4gICAgLyoqXG4gICAgICogR2V0cyB0aGUgdHlwZSBvZiB0aGUgdHJhbnNhY3Rpb25zIGluIHRoZSBgU3VibWlzc2lvbkNvbnRleHRgOlxuICAgICAqIDAgZm9yIG5vbi1FSVAxNTU5IHRyYW5zYWN0aW9ucyBhbmQgMiBmb3IgRUlQLTE1NTkgdHJhbnNhY3Rpb25zLlxuICAgICAqL1xuICAgIHB1YmxpYyBnZXQgdHJhbnNhY3Rpb25UeXBlKCk6IDAgfCAyIHtcbiAgICAgICAgcmV0dXJuIHRoaXMuX3RyYW5zYWN0aW9uVHlwZTtcbiAgICB9XG5cbiAgICAvKipcbiAgICAgKiBBZGRzIGEgdHJhbnNhY3Rpb24gdG8gdGhlIFN1Ym1pc3Npb25Db250ZXh0LiBUaHJvd3MgaWYgdGhlIHRyYW5zYWN0aW9uIGhhcyBhIG5vbmNlIG9yIHR5cGVcbiAgICAgKiBkaWZmZXJlbnQgdGhhbiB0aGUgZXhpc3RpbmcgdHJhbnNhY3Rpb25zLlxuICAgICAqL1xuICAgIHB1YmxpYyBhZGRUcmFuc2FjdGlvbih0cmFuc2FjdGlvbjogVFtudW1iZXJdKTogdm9pZCB7XG4gICAgICAgIC8vIFRPRE8gKFZpYyk6IFJlbW92ZSBhbnlbXSBvbmNlIGh0dHBzOi8vZ2l0aHViLmNvbS9taWNyb3NvZnQvVHlwZVNjcmlwdC9pc3N1ZXMvNDQzNzMgaXMgZml4ZWRcbiAgICAgICAgLy8gJGVzbGludC1maXgtbWUgaHR0cHM6Ly9naXRodWIuY29tL3JoaW5vZGF2aWQvZXNsaW50LWZpeC1tZVxuICAgICAgICAvLyBlc2xpbnQtZGlzYWJsZS1uZXh0LWxpbmUgQHR5cGVzY3JpcHQtZXNsaW50L25vLWV4cGxpY2l0LWFueVxuICAgICAgICAodGhpcy5fdHJhbnNhY3Rpb25zIGFzIGFueVtdKS5wdXNoKHRyYW5zYWN0aW9uKTtcbiAgICAgICAgdGhpcy5fZW5zdXJlVHJhbnNhY3Rpb25zQXJlQ29uc2lzdGVudCh0aGlzLl90cmFuc2FjdGlvbnMpO1xuICAgIH1cblxuICAgIC8qKlxuICAgICAqIEdldHMgdGhlIG5vbmNlIG9mIHRoZSB0cmFuc2FjdGlvbnMgb2YgdGhlIGBTdWJtaXNzaW9uQ29udGV4dGBcbiAgICAgKi9cbiAgICBwdWJsaWMgZ2V0IG5vbmNlKCk6IG51bWJlciB7XG4gICAgICAgIGNvbnN0IG5vbmNlID0gdGhpcy5fdHJhbnNhY3Rpb25zWzBdLm5vbmNlO1xuICAgICAgICBpZiAobm9uY2UgPT09IHVuZGVmaW5lZCB8fCBub25jZSA9PT0gbnVsbCkge1xuICAgICAgICAgICAgdGhyb3cgbmV3IEVycm9yKCdUcmFuc2FjdGlvbiBkb2VzIG5vdCBoYXZlIGEgbm9uY2UnKTtcbiAgICAgICAgfVxuICAgICAgICByZXR1cm4gbm9uY2U7XG4gICAgfVxuXG4gICAgLyoqXG4gICAgICogR2V0cyB0aGUgbWF4IGdhcyBwcmljZSBzZXQgZm9yIGFueSB0cmFuc2FjdGlvbiBpbiB0aGUgYFN1Ym1pc3Npb25Db250ZXh0YFxuICAgICAqL1xuICAgIHB1YmxpYyBnZXQgbWF4R2FzUHJpY2UoKTogQmlnTnVtYmVyIHtcbiAgICAgICAgaWYgKHRoaXMuX3RyYW5zYWN0aW9uVHlwZSAhPT0gMCkge1xuICAgICAgICAgICAgdGhyb3cgbmV3IEVycm9yKCdBdHRlbXB0ZWQgdG8gYWNjZXNzIHRoZSBtYXggZ2FzIHByaWNlIG9mIGEgRUlQLTE1NTkgdHJhbnNhY3Rpb24gc2V0Jyk7XG4gICAgICAgIH1cbiAgICAgICAgcmV0dXJuIChcbiAgICAgICAgICAgIHRoaXMuX3RyYW5zYWN0aW9uc1xuICAgICAgICAgICAgICAgIC8vICRlc2xpbnQtZml4LW1lIGh0dHBzOi8vZ2l0aHViLmNvbS9yaGlub2RhdmlkL2VzbGludC1maXgtbWVcbiAgICAgICAgICAgICAgICAvLyBlc2xpbnQtZGlzYWJsZS1uZXh0LWxpbmUgQHR5cGVzY3JpcHQtZXNsaW50L25vLW5vbi1udWxsLWFzc2VydGlvblxuICAgICAgICAgICAgICAgIC5tYXAoKHQpID0+IHQuZ2FzUHJpY2UhKVxuICAgICAgICAgICAgICAgIC5maWx0ZXIoQm9vbGVhbilcbiAgICAgICAgICAgICAgICAucmVkdWNlKChyZXN1bHQsIGdhc1ByaWNlKSA9PiBCaWdOdW1iZXIubWF4aW11bShyZXN1bHQsIGdhc1ByaWNlKSlcbiAgICAgICAgKTtcbiAgICB9XG5cbiAgICAvKipcbiAgICAgKiBHZXRzIHRoZSBtYXhpbXVtIHZhbHVlcyBmb3IgdGhlIGBtYXhGZWVQZXJHYXNgIGFuZCB0aGUgYG1heFByaW9yaXR5RmVlUGVyR2FzYCBmb3IgYVxuICAgICAqIHNldCBvZiBFSVAtMTU1OSB0cmFuc2FjdGlvbnMuXG4gICAgICovXG4gICAgcHVibGljIGdldCBtYXhHYXNGZWVzKCk6IHsgbWF4RmVlUGVyR2FzOiBCaWdOdW1iZXI7IG1heFByaW9yaXR5RmVlUGVyR2FzOiBCaWdOdW1iZXIgfSB7XG4gICAgICAgIGlmICh0aGlzLl90cmFuc2FjdGlvblR5cGUgIT09IDIpIHtcbiAgICAgICAgICAgIHRocm93IG5ldyBFcnJvcignQXR0ZW1wdGVkIHRvIGFjY2VzcyB0aGUgbWF4IGdhcyBmZWVzIGZvciBhIG5vbi1FSVAtMTU1OSB0cmFuc2FjdGlvbiBzZXQnKTtcbiAgICAgICAgfVxuICAgICAgICByZXR1cm4ge1xuICAgICAgICAgICAgLy8gJGVzbGludC1maXgtbWUgaHR0cHM6Ly9naXRodWIuY29tL3JoaW5vZGF2aWQvZXNsaW50LWZpeC1tZVxuICAgICAgICAgICAgLy8gZXNsaW50LWRpc2FibGUtbmV4dC1saW5lIEB0eXBlc2NyaXB0LWVzbGludC9uby1ub24tbnVsbC1hc3NlcnRpb25cbiAgICAgICAgICAgIG1heEZlZVBlckdhczogQmlnTnVtYmVyLm1heGltdW0oLi4udGhpcy5fdHJhbnNhY3Rpb25zLm1hcCgodCkgPT4gdC5tYXhGZWVQZXJHYXMhKSksXG4gICAgICAgICAgICAvLyAkZXNsaW50LWZpeC1tZSBodHRwczovL2dpdGh1Yi5jb20vcmhpbm9kYXZpZC9lc2xpbnQtZml4LW1lXG4gICAgICAgICAgICAvLyBlc2xpbnQtZGlzYWJsZS1uZXh0LWxpbmUgQHR5cGVzY3JpcHQtZXNsaW50L25vLW5vbi1udWxsLWFzc2VydGlvblxuICAgICAgICAgICAgbWF4UHJpb3JpdHlGZWVQZXJHYXM6IEJpZ051bWJlci5tYXhpbXVtKC4uLnRoaXMuX3RyYW5zYWN0aW9ucy5tYXAoKHQpID0+IHQubWF4UHJpb3JpdHlGZWVQZXJHYXMhKSksXG4gICAgICAgIH07XG4gICAgfVxuXG4gICAgLyoqXG4gICAgICogR2V0cyB0aGUgZXBvY2ggdGltZSwgaW4gc2Vjb25kcywgb2YgdGhlIGVhcmxpZXN0IHRyYW5zYWN0aW9uIHN1Ym1pc3Npb24uXG4gICAgICogTm90ZTogVGhpcyB1c2VzIHRoZSBkYXRhYmFzZSB0aW1lIHRoZSB0cmFuc2FjdGlvbiBzdWJtaXNzaW9uIHdhcyBjcmVhdGVkLFxuICAgICAqIG5vdCB0aGUgYmxvY2tjaGFpbiB0aW1lc3RhbXAuXG4gICAgICovXG4gICAgcHVibGljIGdldCBmaXJzdFN1Ym1pc3Npb25UaW1lc3RhbXBTKCk6IG51bWJlciB7XG4gICAgICAgIGNvbnN0IHN1Ym1pc3Npb25DcmVhdGlvblRpbWVzUyA9IHRoaXMuX3RyYW5zYWN0aW9uc1xuICAgICAgICAgICAgLm1hcCgodCkgPT4gdC5jcmVhdGVkQXQuZ2V0VGltZSgpIC8gT05FX1NFQ09ORF9NUylcbiAgICAgICAgICAgIC5tYXAoKHQpID0+IE1hdGgucm91bmQodCkpO1xuICAgICAgICByZXR1cm4gc3VibWlzc2lvbkNyZWF0aW9uVGltZXNTLnJlZHVjZSgocmVzdWx0LCB0aW1lKSA9PiBNYXRoLm1pbihyZXN1bHQsIHRpbWUpLCBJbmZpbml0eSk7XG4gICAgfVxuXG4gICAgLyoqXG4gICAgICogUmV0dXJucyB0aGUgdHJhbnNhY3Rpb24gcmVjZWlwdCBpZiBvbmUgb2YgdGhlIHRyYW5zYWN0aW9ucyBpbiB0aGUgU3VibWlzc2lvbkNvbnRleHRcbiAgICAgKiBoYXMgYmVlbiBtaW5lZDsgb3RoZXJ3aXNlIHJldHVybnMgYG51bGxgLlxuICAgICAqL1xuICAgIHB1YmxpYyBhc3luYyBnZXRSZWNlaXB0QXN5bmMoKTogUHJvbWlzZTxUcmFuc2FjdGlvblJlY2VpcHQgfCBudWxsPiB7XG4gICAgICAgIC8vICRlc2xpbnQtZml4LW1lIGh0dHBzOi8vZ2l0aHViLmNvbS9yaGlub2RhdmlkL2VzbGludC1maXgtbWVcbiAgICAgICAgLyogZXNsaW50LWRpc2FibGUgQHR5cGVzY3JpcHQtZXNsaW50L25vLW5vbi1udWxsLWFzc2VydGlvbiAqL1xuICAgICAgICBjb25zdCByZWNlaXB0cyA9IChcbiAgICAgICAgICAgIGF3YWl0IHRoaXMuX2Jsb2NrY2hhaW5VdGlscy5nZXRSZWNlaXB0c0FzeW5jKHRoaXMuX3RyYW5zYWN0aW9ucy5tYXAoKHQpID0+IHQudHJhbnNhY3Rpb25IYXNoISkpXG4gICAgICAgICkuZmlsdGVyKGlzRGVmaW5lZCk7XG4gICAgICAgIC8qIGVzbGludC1lbmFibGUgQHR5cGVzY3JpcHQtZXNsaW50L25vLW5vbi1udWxsLWFzc2VydGlvbiAqL1xuICAgICAgICBpZiAocmVjZWlwdHMubGVuZ3RoID4gMSkge1xuICAgICAgICAgICAgdGhyb3cgbmV3IEVycm9yKCdGb3VuZCBtb3JlIHRoYW4gb25lIHRyYW5zYWN0aW9uIHJlY2VpcHQnKTtcbiAgICAgICAgfVxuICAgICAgICByZXR1cm4gcmVjZWlwdHMubGVuZ3RoID8gcmVjZWlwdHNbMF0gOiBudWxsO1xuICAgIH1cblxuICAgIC8qKlxuICAgICAqIDEuIFVwZGF0ZXMgdGhlIGluLW1lbW9yeSB0cmFuc2FjdGlvbnMgaW4gcmVzcG9uc2UgdG8gYSBtaW5lZCB0cmFuc2FjdGlvbiByZWNlaXB0LlxuICAgICAqIDIuIFVwZGF0ZXMgdGhlIHN0YXR1c2VzIG9mIGFsbCB0cmFuc2FjdGlvbiBzdWJtaXNzaW9uLlxuICAgICAqL1xuICAgIHB1YmxpYyBhc3luYyB1cGRhdGVGb3JSZWNlaXB0QXN5bmMocmVjZWlwdDogVHJhbnNhY3Rpb25SZWNlaXB0LCBub3c6IERhdGUgPSBuZXcgRGF0ZSgpKTogUHJvbWlzZTx2b2lkPiB7XG4gICAgICAgIGNvbnN0IGlzVHJhbnNhY3Rpb25TdWNjZXNzZnVsID0gcmVjZWlwdC5zdGF0dXMgPT09IDE7XG4gICAgICAgIGNvbnN0IGN1cnJlbnRCbG9jayA9IGF3YWl0IHRoaXMuX2Jsb2NrY2hhaW5VdGlscy5nZXRDdXJyZW50QmxvY2tBc3luYygpO1xuICAgICAgICBjb25zdCBpc1RyYW5zYWN0aW9uQ29uZmlybWVkID0gU3VibWlzc2lvbkNvbnRleHQuaXNCbG9ja0NvbmZpcm1lZChjdXJyZW50QmxvY2ssIHJlY2VpcHQuYmxvY2tOdW1iZXIpO1xuXG4gICAgICAgIHRoaXMuX3RyYW5zYWN0aW9ucyA9IHRoaXMuX3RyYW5zYWN0aW9ucy5tYXAoKHRyYW5zYWN0aW9uKSA9PiB7XG4gICAgICAgICAgICB0cmFuc2FjdGlvbi51cGRhdGVkQXQgPSBub3c7XG4gICAgICAgICAgICBpZiAodHJhbnNhY3Rpb24udHJhbnNhY3Rpb25IYXNoID09PSByZWNlaXB0LnRyYW5zYWN0aW9uSGFzaCkge1xuICAgICAgICAgICAgICAgIGNvbnN0IHN1Ym1pc3Npb25TdGF0dXMgPSBpc1RyYW5zYWN0aW9uU3VjY2Vzc2Z1bFxuICAgICAgICAgICAgICAgICAgICA/IGlzVHJhbnNhY3Rpb25Db25maXJtZWRcbiAgICAgICAgICAgICAgICAgICAgICAgID8gUmZxbVRyYW5zYWN0aW9uU3VibWlzc2lvblN0YXR1cy5TdWNjZWVkZWRDb25maXJtZWRcbiAgICAgICAgICAgICAgICAgICAgICAgIDogUmZxbVRyYW5zYWN0aW9uU3VibWlzc2lvblN0YXR1cy5TdWNjZWVkZWRVbmNvbmZpcm1lZFxuICAgICAgICAgICAgICAgICAgICA6IGlzVHJhbnNhY3Rpb25Db25maXJtZWRcbiAgICAgICAgICAgICAgICAgICAgPyBSZnFtVHJhbnNhY3Rpb25TdWJtaXNzaW9uU3RhdHVzLlJldmVydGVkQ29uZmlybWVkXG4gICAgICAgICAgICAgICAgICAgIDogUmZxbVRyYW5zYWN0aW9uU3VibWlzc2lvblN0YXR1cy5SZXZlcnRlZFVuY29uZmlybWVkO1xuXG4gICAgICAgICAgICAgICAgdHJhbnNhY3Rpb24uc3RhdHVzID0gc3VibWlzc2lvblN0YXR1cztcbiAgICAgICAgICAgICAgICB0cmFuc2FjdGlvbi5ibG9ja01pbmVkID0gbmV3IEJpZ051bWJlcihyZWNlaXB0LmJsb2NrTnVtYmVyKTtcbiAgICAgICAgICAgICAgICB0cmFuc2FjdGlvbi5nYXNVc2VkID0gbmV3IEJpZ051bWJlcihyZWNlaXB0Lmdhc1VzZWQudG9TdHJpbmcoKSk7XG4gICAgICAgICAgICAgICAgaWYgKHRyYW5zYWN0aW9uLmdhc1ByaWNlID09PSBudWxsKSB7XG4gICAgICAgICAgICAgICAgICAgIHRyYW5zYWN0aW9uLmdhc1ByaWNlID0gbmV3IEJpZ051bWJlcihyZWNlaXB0LmVmZmVjdGl2ZUdhc1ByaWNlLnRvU3RyaW5nKCkpO1xuICAgICAgICAgICAgICAgIH1cbiAgICAgICAgICAgIH0gZWxzZSB7XG4gICAgICAgICAgICAgICAgdHJhbnNhY3Rpb24uc3RhdHVzID0gUmZxbVRyYW5zYWN0aW9uU3VibWlzc2lvblN0YXR1cy5Ecm9wcGVkQW5kUmVwbGFjZWQ7XG4gICAgICAgICAgICB9XG5cbiAgICAgICAgICAgIHJldHVybiB0cmFuc2FjdGlvbjtcbiAgICAgICAgfSkgYXMgVDtcbiAgICB9XG5cbiAgICAvKipcbiAgICAgKiBSZXR1cm5zIHRoZSBhcHByb3ByaWF0ZSBqb2Igc3RhdHVzIGdpdmVuIHRoZSBzdGF0dXNlcyBvZiB0aGUgdHJhbnNhY3Rpb25zXG4gICAgICovXG4gICAgcHVibGljIGdldCBqb2JTdGF0dXMoKTpcbiAgICAgICAgfCBSZnFtSm9iU3RhdHVzLlBlbmRpbmdTdWJtaXR0ZWRcbiAgICAgICAgfCBSZnFtSm9iU3RhdHVzLkZhaWxlZFJldmVydGVkQ29uZmlybWVkXG4gICAgICAgIHwgUmZxbUpvYlN0YXR1cy5GYWlsZWRSZXZlcnRlZFVuY29uZmlybWVkXG4gICAgICAgIHwgUmZxbUpvYlN0YXR1cy5TdWNjZWVkZWRDb25maXJtZWRcbiAgICAgICAgfCBSZnFtSm9iU3RhdHVzLlN1Y2NlZWRlZFVuY29uZmlybWVkIHtcbiAgICAgICAgZm9yIChjb25zdCB0cmFuc2FjdGlvbiBvZiB0aGlzLl90cmFuc2FjdGlvbnMpIHtcbiAgICAgICAgICAgIHN3aXRjaCAodHJhbnNhY3Rpb24uc3RhdHVzKSB7XG4gICAgICAgICAgICAgICAgY2FzZSBSZnFtVHJhbnNhY3Rpb25TdWJtaXNzaW9uU3RhdHVzLkRyb3BwZWRBbmRSZXBsYWNlZDpcbiAgICAgICAgICAgICAgICAgICAgY29udGludWU7XG4gICAgICAgICAgICAgICAgY2FzZSBSZnFtVHJhbnNhY3Rpb25TdWJtaXNzaW9uU3RhdHVzLlByZXN1Ym1pdDpcbiAgICAgICAgICAgICAgICAgICAgY29udGludWU7XG4gICAgICAgICAgICAgICAgY2FzZSBSZnFtVHJhbnNhY3Rpb25TdWJtaXNzaW9uU3RhdHVzLlJldmVydGVkQ29uZmlybWVkOlxuICAgICAgICAgICAgICAgICAgICByZXR1cm4gUmZxbUpvYlN0YXR1cy5GYWlsZWRSZXZlcnRlZENvbmZpcm1lZDtcbiAgICAgICAgICAgICAgICBjYXNlIFJmcW1UcmFuc2FjdGlvblN1Ym1pc3Npb25TdGF0dXMuUmV2ZXJ0ZWRVbmNvbmZpcm1lZDpcbiAgICAgICAgICAgICAgICAgICAgcmV0dXJuIFJmcW1Kb2JTdGF0dXMuRmFpbGVkUmV2ZXJ0ZWRVbmNvbmZpcm1lZDtcbiAgICAgICAgICAgICAgICBjYXNlIFJmcW1UcmFuc2FjdGlvblN1Ym1pc3Npb25TdGF0dXMuU3VibWl0dGVkOlxuICAgICAgICAgICAgICAgICAgICBjb250aW51ZTtcbiAgICAgICAgICAgICAgICBjYXNlIFJmcW1UcmFuc2FjdGlvblN1Ym1pc3Npb25TdGF0dXMuU3VjY2VlZGVkQ29uZmlybWVkOlxuICAgICAgICAgICAgICAgICAgICByZXR1cm4gUmZxbUpvYlN0YXR1cy5TdWNjZWVkZWRDb25maXJtZWQ7XG4gICAgICAgICAgICAgICAgY2FzZSBSZnFtVHJhbnNhY3Rpb25TdWJtaXNzaW9uU3RhdHVzLlN1Y2NlZWRlZFVuY29uZmlybWVkOlxuICAgICAgICAgICAgICAgICAgICByZXR1cm4gUmZxbUpvYlN0YXR1cy5TdWNjZWVkZWRVbmNvbmZpcm1lZDtcbiAgICAgICAgICAgICAgICBkZWZhdWx0OlxuICAgICAgICAgICAgICAgICAgICAoKF94OiBuZXZlcikgPT4ge1xuICAgICAgICAgICAgICAgICAgICAgICAgdGhyb3cgbmV3IEVycm9yKCd1bnJlYWNoYWJsZScpO1xuICAgICAgICAgICAgICAgICAgICB9KSh0cmFuc2FjdGlvbi5zdGF0dXMpO1xuICAgICAgICAgICAgfVxuICAgICAgICB9XG4gICAgICAgIHJldHVybiBSZnFtSm9iU3RhdHVzLlBlbmRpbmdTdWJtaXR0ZWQ7XG4gICAgfVxuXG4gICAgLyoqXG4gICAgICogUmV0dXJucyB0aGUgc3VibWlzc2lvbiBjb250ZXh0IHN0YXR1cyBnaXZlbiB0aGUgc3RhdHVzZXMgb2YgdGhlIHRyYW5zYWN0aW9ucy4gQSBzdWJtaXNzaW9uIGNvbnRleHQgY29udGFpbnNcbiAgICAgKiBtdWx0aXBsZSB0cmFuc2FjdGlvbnMgYW5kIHRoZSBzdWJtaXNzaW9uIGNvbnRleHQgc3RhdHVzIGlzIHRoZSBjb2xsZWN0aXZlIHN0YXR1cyBmb3IgYWxsIHRyYW5zYWN0aW9ucy5cbiAgICAgKi9cbiAgICBwdWJsaWMgZ2V0IHN1Ym1pc3Npb25Db250ZXh0U3RhdHVzKCk6XG4gICAgICAgIHwgU3VibWlzc2lvbkNvbnRleHRTdGF0dXMuUGVuZGluZ1N1Ym1pdHRlZFxuICAgICAgICB8IFN1Ym1pc3Npb25Db250ZXh0U3RhdHVzLkZhaWxlZFJldmVydGVkQ29uZmlybWVkXG4gICAgICAgIHwgU3VibWlzc2lvbkNvbnRleHRTdGF0dXMuRmFpbGVkUmV2ZXJ0ZWRVbmNvbmZpcm1lZFxuICAgICAgICB8IFN1Ym1pc3Npb25Db250ZXh0U3RhdHVzLlN1Y2NlZWRlZENvbmZpcm1lZFxuICAgICAgICB8IFN1Ym1pc3Npb25Db250ZXh0U3RhdHVzLlN1Y2NlZWRlZFVuY29uZmlybWVkIHtcbiAgICAgICAgZm9yIChjb25zdCB0cmFuc2FjdGlvbiBvZiB0aGlzLl90cmFuc2FjdGlvbnMpIHtcbiAgICAgICAgICAgIHN3aXRjaCAodHJhbnNhY3Rpb24uc3RhdHVzKSB7XG4gICAgICAgICAgICAgICAgY2FzZSBSZnFtVHJhbnNhY3Rpb25TdWJtaXNzaW9uU3RhdHVzLkRyb3BwZWRBbmRSZXBsYWNlZDpcbiAgICAgICAgICAgICAgICAgICAgY29udGludWU7XG4gICAgICAgICAgICAgICAgY2FzZSBSZnFtVHJhbnNhY3Rpb25TdWJtaXNzaW9uU3RhdHVzLlByZXN1Ym1pdDpcbiAgICAgICAgICAgICAgICAgICAgY29udGludWU7XG4gICAgICAgICAgICAgICAgY2FzZSBSZnFtVHJhbnNhY3Rpb25TdWJtaXNzaW9uU3RhdHVzLlJldmVydGVkQ29uZmlybWVkOlxuICAgICAgICAgICAgICAgICAgICByZXR1cm4gU3VibWlzc2lvbkNvbnRleHRTdGF0dXMuRmFpbGVkUmV2ZXJ0ZWRDb25maXJtZWQ7XG4gICAgICAgICAgICAgICAgY2FzZSBSZnFtVHJhbnNhY3Rpb25TdWJtaXNzaW9uU3RhdHVzLlJldmVydGVkVW5jb25maXJtZWQ6XG4gICAgICAgICAgICAgICAgICAgIHJldHVybiBTdWJtaXNzaW9uQ29udGV4dFN0YXR1cy5GYWlsZWRSZXZlcnRlZFVuY29uZmlybWVkO1xuICAgICAgICAgICAgICAgIGNhc2UgUmZxbVRyYW5zYWN0aW9uU3VibWlzc2lvblN0YXR1cy5TdWJtaXR0ZWQ6XG4gICAgICAgICAgICAgICAgICAgIGNvbnRpbnVlO1xuICAgICAgICAgICAgICAgIGNhc2UgUmZxbVRyYW5zYWN0aW9uU3VibWlzc2lvblN0YXR1cy5TdWNjZWVkZWRDb25maXJtZWQ6XG4gICAgICAgICAgICAgICAgICAgIHJldHVybiBTdWJtaXNzaW9uQ29udGV4dFN0YXR1cy5TdWNjZWVkZWRDb25maXJtZWQ7XG4gICAgICAgICAgICAgICAgY2FzZSBSZnFtVHJhbnNhY3Rpb25TdWJtaXNzaW9uU3RhdHVzLlN1Y2NlZWRlZFVuY29uZmlybWVkOlxuICAgICAgICAgICAgICAgICAgICByZXR1cm4gU3VibWlzc2lvbkNvbnRleHRTdGF0dXMuU3VjY2VlZGVkVW5jb25maXJtZWQ7XG4gICAgICAgICAgICAgICAgZGVmYXVsdDpcbiAgICAgICAgICAgICAgICAgICAgdGhyb3cgbmV3IEVycm9yKGBUcmFuc2FjdGlvbiBzdGF0dXMgJHt0cmFuc2FjdGlvbi5zdGF0dXN9IHNob3VsZCBub3QgYmUgcmVhY2hlZGApO1xuICAgICAgICAgICAgfVxuICAgICAgICB9XG4gICAgICAgIHJldHVybiBTdWJtaXNzaW9uQ29udGV4dFN0YXR1cy5QZW5kaW5nU3VibWl0dGVkO1xuICAgIH1cblxuICAgIC8qKlxuICAgICAqIEFzc2Vzc2VzIHdoZXRoZXIgdGhlIGdpdmVuIHRyYW5zYWN0aW9ucyBoYXZlIHRoZSBzYW1lIG5vbmNlLCB0eXBlIChFSVAtMTU1OSBvciBub3QpLFxuICAgICAqIGFuZCB1bmlxdWUgdHJhbnNhY3Rpb24gaGFzaGVzOyB0aHJvd3MgaWYgdGhleSBkbyBub3QuXG4gICAgICpcbiAgICAgKiBUaHJvd3MgaWYgYHRyYW5zYWN0aW9uc2AgaGFzIGEgemVybyBsZW5ndGguXG4gICAgICpcbiAgICAgKiBgcGVyZmVyLWZ1bmN0aW9uLW92ZXItbWV0aG9kYCBydWxlIGlzIGRpc2FibGVkIHRvIHNpbmNlIGEgZnVuY3Rpb24gd291bGQgbm90IGJlIGFibGUgdG8gdXNlIHRoZVxuICAgICAqIGBUYCBnZW5lcmljIHR5cGUuXG4gICAgICovXG4gICAgLy8gdHNsaW50OmRpc2FibGUtbmV4dC1saW5lOiBwcmVmZXItZnVuY3Rpb24tb3Zlci1tZXRob2RcbiAgICBwcml2YXRlIF9lbnN1cmVUcmFuc2FjdGlvbnNBcmVDb25zaXN0ZW50KHRyYW5zYWN0aW9uczogVCk6IHZvaWQge1xuICAgICAgICBpZiAoIXRyYW5zYWN0aW9ucy5sZW5ndGgpIHtcbiAgICAgICAgICAgIHRocm93IG5ldyBFcnJvcignYHRyYW5zYWN0aW9uc2AgbXVzdCBoYXZlIGEgbm9uemVybyBsZW5ndGgnKTtcbiAgICAgICAgfVxuICAgICAgICBpZiAoIXRyYW5zYWN0aW9ucy5tYXAoKHQpID0+IHQubm9uY2UpLmV2ZXJ5KChuLCBfLCBub25jZXMpID0+IG4gPT09IG5vbmNlc1swXSkpIHtcbiAgICAgICAgICAgIHRocm93IG5ldyBFcnJvcignVHJhbnNhY3Rpb25zIGRvIG5vdCBoYXZlIHRoZSBzYW1lIG5vbmNlJyk7XG4gICAgICAgIH1cbiAgICAgICAgaWYgKG5ldyBTZXQodHJhbnNhY3Rpb25zLm1hcCgodCkgPT4gdC50cmFuc2FjdGlvbkhhc2gpKS5zaXplICE9PSB0cmFuc2FjdGlvbnMubGVuZ3RoKSB7XG4gICAgICAgICAgICB0aHJvdyBuZXcgRXJyb3IoJ1RyYW5zYWN0aW9ucyBhcmUgbm90IHVuaXF1ZScpO1xuICAgICAgICB9XG4gICAgICAgIC8vIFRPRE8gKFZpYyk6IFJlbW92ZSBhbnlbXSBvbmNlIGh0dHBzOi8vZ2l0aHViLmNvbS9taWNyb3NvZnQvVHlwZVNjcmlwdC9pc3N1ZXMvNDQzNzMgaXMgZml4ZWRcbiAgICAgICAgLy8gJGVzbGludC1maXgtbWUgaHR0cHM6Ly9naXRodWIuY29tL3JoaW5vZGF2aWQvZXNsaW50LWZpeC1tZVxuICAgICAgICAvLyBlc2xpbnQtZGlzYWJsZS1uZXh0LWxpbmUgQHR5cGVzY3JpcHQtZXNsaW50L25vLWV4cGxpY2l0LWFueVxuICAgICAgICBjb25zdCBhcmVBbGxHYXNQcmljZXNOb25OdWxsID0gKHRyYW5zYWN0aW9ucyBhcyBhbnlbXSkuZXZlcnkoKHQpID0+IHQuZ2FzUHJpY2UgIT09IG51bGwpO1xuICAgICAgICAvLyAkZXNsaW50LWZpeC1tZSBodHRwczovL2dpdGh1Yi5jb20vcmhpbm9kYXZpZC9lc2xpbnQtZml4LW1lXG4gICAgICAgIC8vIGVzbGludC1kaXNhYmxlLW5leHQtbGluZSBAdHlwZXNjcmlwdC1lc2xpbnQvbm8tZXhwbGljaXQtYW55XG4gICAgICAgIGNvbnN0IGFyZUFsbE1heEZlZXNQZXJHYXNOb25OdWxsID0gKHRyYW5zYWN0aW9ucyBhcyBhbnlbXSkuZXZlcnkoKHQpID0+IHQubWF4RmVlUGVyR2FzICE9PSBudWxsKTtcbiAgICAgICAgLy8gJGVzbGludC1maXgtbWUgaHR0cHM6Ly9naXRodWIuY29tL3JoaW5vZGF2aWQvZXNsaW50LWZpeC1tZVxuICAgICAgICAvLyBlc2xpbnQtZGlzYWJsZS1uZXh0LWxpbmUgQHR5cGVzY3JpcHQtZXNsaW50L25vLWV4cGxpY2l0LWFueVxuICAgICAgICBjb25zdCBhcmVBbGxNYXhQcmlvcml0eUZlZXNQZXJHYXNOb25OdWxsID0gKHRyYW5zYWN0aW9ucyBhcyBhbnlbXSkuZXZlcnkoXG4gICAgICAgICAgICAodCkgPT4gdC5tYXhQcmlvcml0eUZlZVBlckdhcyAhPT0gbnVsbCxcbiAgICAgICAgKTtcbiAgICAgICAgaWYgKCEoYXJlQWxsR2FzUHJpY2VzTm9uTnVsbCB8fCAoYXJlQWxsTWF4RmVlc1Blckdhc05vbk51bGwgJiYgYXJlQWxsTWF4UHJpb3JpdHlGZWVzUGVyR2FzTm9uTnVsbCkpKSB7XG4gICAgICAgICAgICB0aHJvdyBuZXcgRXJyb3IoJ1RyYW5zYWN0aW9ucyBkbyBub3QgaGF2ZSB0aGUgc2FtZSBnYXMgdHlwZScpO1xuICAgICAgICB9XG4gICAgfVxufVxuIl0sInZlcnNpb24iOjN9