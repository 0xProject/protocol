8dff87bf4a2be2fcec87aa34ea6fa231
"use strict";
Object.defineProperty(exports, "__esModule", { value: true });
// tslint:disable:custom-no-magic-numbers
// tslint:disable:no-empty
// tslint:disable:max-file-line-count
const chai_1 = require("chai");
const ts_mockito_1 = require("ts-mockito");
const sqs_client_1 = require("../../src/utils/sqs_client");
const sqs_consumer_1 = require("../../src/utils/sqs_consumer");
describe('SqsConsumer', () => {
    describe('consumeOnceAsync', () => {
        describe('beforeHandle', () => {
            it('should not call handleMessage if beforeHandle returns false', async () => {
                // Given
                const sqsClientMock = (0, ts_mockito_1.mock)(sqs_client_1.SqsClient);
                let isHandleCalled = false;
                const beforeHandle = async () => false;
                const handleMessage = async () => {
                    isHandleCalled = true;
                };
                const consumer = new sqs_consumer_1.SqsConsumer({
                    workerIndex: 0,
                    workerAddress: 'id',
                    sqsClient: sqsClientMock,
                    handleMessage,
                    beforeHandle,
                });
                // When
                await consumer.consumeOnceAsync();
                // Then
                (0, chai_1.expect)(isHandleCalled).to.equal(false);
            });
            it('should not call handleMessage if beforeHandle throws an error', async () => {
                // Given
                const sqsClientMock = (0, ts_mockito_1.mock)(sqs_client_1.SqsClient);
                let isHandleCalled = false;
                const beforeHandle = async () => Promise.reject('error!');
                const handleMessage = async () => {
                    isHandleCalled = true;
                };
                const consumer = new sqs_consumer_1.SqsConsumer({
                    workerIndex: 0,
                    workerAddress: 'id',
                    sqsClient: sqsClientMock,
                    handleMessage,
                    beforeHandle,
                });
                // When
                await consumer.consumeOnceAsync();
                // Then
                (0, chai_1.expect)(isHandleCalled).to.equal(false);
            });
            it('should call handleMessage if no beforeHandle', async () => {
                // Given
                const sqsClientMock = (0, ts_mockito_1.mock)(sqs_client_1.SqsClient);
                (0, ts_mockito_1.when)(sqsClientMock.receiveMessageAsync()).thenResolve({
                    Body: '0xdeadbeef',
                });
                const sqsClientInstance = (0, ts_mockito_1.instance)(sqsClientMock);
                let isHandleCalled = false;
                const handleMessage = async () => {
                    isHandleCalled = true;
                };
                const consumer = new sqs_consumer_1.SqsConsumer({
                    workerIndex: 0,
                    workerAddress: 'id',
                    sqsClient: sqsClientInstance,
                    handleMessage,
                });
                // When
                await consumer.consumeOnceAsync();
                // Then
                (0, chai_1.expect)(isHandleCalled).to.equal(true);
            });
            it('should call handleMessage if beforeHandle returns true', async () => {
                // Given
                const sqsClientMock = (0, ts_mockito_1.mock)(sqs_client_1.SqsClient);
                (0, ts_mockito_1.when)(sqsClientMock.receiveMessageAsync()).thenResolve({
                    Body: '0xdeadbeef',
                });
                const sqsClientInstance = (0, ts_mockito_1.instance)(sqsClientMock);
                const beforeHandle = async () => true;
                let isHandleCalled = false;
                const handleMessage = async () => {
                    isHandleCalled = true;
                };
                const consumer = new sqs_consumer_1.SqsConsumer({
                    workerIndex: 0,
                    workerAddress: 'id',
                    sqsClient: sqsClientInstance,
                    beforeHandle,
                    handleMessage,
                });
                // When
                await consumer.consumeOnceAsync();
                // Then
                (0, chai_1.expect)(isHandleCalled).to.equal(true);
            });
        });
        describe('handleMessage', () => {
            it('should not be called if no message is recieved', async () => {
                // Given
                const sqsClientMock = (0, ts_mockito_1.mock)(sqs_client_1.SqsClient);
                (0, ts_mockito_1.when)(sqsClientMock.receiveMessageAsync()).thenResolve(null);
                const sqsClientInstance = (0, ts_mockito_1.instance)(sqsClientMock);
                let isHandleCalled = false;
                const handleMessage = async () => {
                    isHandleCalled = true;
                };
                const consumer = new sqs_consumer_1.SqsConsumer({
                    workerIndex: 0,
                    workerAddress: 'id',
                    sqsClient: sqsClientInstance,
                    handleMessage,
                });
                // When
                await consumer.consumeOnceAsync();
                // Then
                (0, chai_1.expect)(isHandleCalled).to.equal(false);
            });
            it('should call changeMessageVisibility if a SqsRetryableError is encountered (triggers a retry)', async () => {
                // Given
                const sqsClientMock = (0, ts_mockito_1.mock)(sqs_client_1.SqsClient);
                (0, ts_mockito_1.when)(sqsClientMock.receiveMessageAsync()).thenResolve({
                    Body: '0xdeadbeef',
                    ReceiptHandle: '1',
                });
                const sqsClientInstance = (0, ts_mockito_1.instance)(sqsClientMock);
                const handleMessage = async () => {
                    throw new sqs_consumer_1.SqsRetryableError('error');
                };
                const consumer = new sqs_consumer_1.SqsConsumer({
                    workerIndex: 0,
                    workerAddress: 'id',
                    sqsClient: sqsClientInstance,
                    handleMessage,
                });
                // When
                await consumer.consumeOnceAsync();
                // Then
                (0, ts_mockito_1.verify)(sqsClientMock.changeMessageVisibilityAsync((0, ts_mockito_1.anyString)(), 0)).once();
            });
            it('should not call changeMessageVisibility if a non SqsRetryableError is encountered', async () => {
                // Given
                const sqsClientMock = (0, ts_mockito_1.mock)(sqs_client_1.SqsClient);
                (0, ts_mockito_1.when)(sqsClientMock.receiveMessageAsync()).thenResolve({
                    Body: '0xdeadbeef',
                    ReceiptHandle: '1',
                });
                const sqsClientInstance = (0, ts_mockito_1.instance)(sqsClientMock);
                const handleMessage = async () => {
                    throw new Error('error');
                };
                const consumer = new sqs_consumer_1.SqsConsumer({
                    workerIndex: 0,
                    workerAddress: 'id',
                    sqsClient: sqsClientInstance,
                    handleMessage,
                });
                // When
                await consumer.consumeOnceAsync();
                // Then
                (0, ts_mockito_1.verify)(sqsClientMock.changeMessageVisibilityAsync((0, ts_mockito_1.anything)(), (0, ts_mockito_1.anything)())).never();
            });
            it('should call deleteMessageAsync if message is successfully handled', async () => {
                // Given
                const sqsClientMock = (0, ts_mockito_1.mock)(sqs_client_1.SqsClient);
                (0, ts_mockito_1.when)(sqsClientMock.receiveMessageAsync()).thenResolve({
                    Body: '0xdeadbeef',
                    ReceiptHandle: '1',
                });
                const sqsClientInstance = (0, ts_mockito_1.instance)(sqsClientMock);
                let isHandleCalled = false;
                const handleMessage = async () => {
                    isHandleCalled = true;
                };
                const consumer = new sqs_consumer_1.SqsConsumer({
                    workerIndex: 0,
                    workerAddress: 'id',
                    sqsClient: sqsClientInstance,
                    handleMessage,
                });
                // When
                await consumer.consumeOnceAsync();
                // Then
                (0, chai_1.expect)(isHandleCalled).to.equal(true);
                (0, ts_mockito_1.verify)(sqsClientMock.deleteMessageAsync((0, ts_mockito_1.anyString)())).once();
            });
        });
        describe('afterHandle', () => {
            it('should be called once everything is successful', async () => {
                // Given
                const sqsClientMock = (0, ts_mockito_1.mock)(sqs_client_1.SqsClient);
                (0, ts_mockito_1.when)(sqsClientMock.receiveMessageAsync()).thenResolve({
                    Body: '0xdeadbeef',
                    ReceiptHandle: '1',
                });
                const sqsClientInstance = (0, ts_mockito_1.instance)(sqsClientMock);
                let isAfterCalled = false;
                const afterHandle = async () => {
                    isAfterCalled = true;
                };
                const consumer = new sqs_consumer_1.SqsConsumer({
                    workerIndex: 0,
                    workerAddress: 'id',
                    sqsClient: sqsClientInstance,
                    // $eslint-fix-me https://github.com/rhinodavid/eslint-fix-me
                    // eslint-disable-next-line @typescript-eslint/no-empty-function
                    handleMessage: async () => { },
                    afterHandle,
                });
                // When
                await consumer.consumeOnceAsync();
                // Then
                (0, chai_1.expect)(isAfterCalled).to.equal(true);
            });
            it('should be passed an error if a non-retryable error was encountered', async () => {
                // Given
                const sqsClientMock = (0, ts_mockito_1.mock)(sqs_client_1.SqsClient);
                (0, ts_mockito_1.when)(sqsClientMock.receiveMessageAsync()).thenResolve({
                    Body: '0xdeadbeef',
                    ReceiptHandle: '1',
                });
                const sqsClientInstance = (0, ts_mockito_1.instance)(sqsClientMock);
                let isAfterCalledWithError = false;
                const consumer = new sqs_consumer_1.SqsConsumer({
                    workerIndex: 0,
                    workerAddress: 'id',
                    sqsClient: sqsClientInstance,
                    handleMessage: async () => {
                        throw new Error();
                    },
                    afterHandle: async (_, error) => {
                        if (error) {
                            isAfterCalledWithError = true;
                        }
                    },
                });
                // When
                await consumer.consumeOnceAsync();
                // Then
                (0, chai_1.expect)(isAfterCalledWithError).to.equal(true);
            });
        });
    });
});
//# sourceMappingURL=data:application/json;charset=utf-8;base64,eyJmaWxlIjoiL1VzZXJzL2Rhdmlkd2Fsc2gvY29kZS1sb2NhbC8weC1yZnEtYXBpL3Rlc3QvdXRpbHMvc3FzX2NvbnN1bWVyX3Rlc3QudHMiLCJtYXBwaW5ncyI6Ijs7QUFBQSx5Q0FBeUM7QUFDekMsMEJBQTBCO0FBQzFCLHFDQUFxQztBQUVyQywrQkFBOEI7QUFDOUIsMkNBQStFO0FBRS9FLDJEQUF1RDtBQUN2RCwrREFBOEU7QUFFOUUsUUFBUSxDQUFDLGFBQWEsRUFBRSxHQUFHLEVBQUU7SUFDekIsUUFBUSxDQUFDLGtCQUFrQixFQUFFLEdBQUcsRUFBRTtRQUM5QixRQUFRLENBQUMsY0FBYyxFQUFFLEdBQUcsRUFBRTtZQUMxQixFQUFFLENBQUMsNkRBQTZELEVBQUUsS0FBSyxJQUFJLEVBQUU7Z0JBQ3pFLFFBQVE7Z0JBQ1IsTUFBTSxhQUFhLEdBQUcsSUFBQSxpQkFBSSxFQUFDLHNCQUFTLENBQUMsQ0FBQztnQkFDdEMsSUFBSSxjQUFjLEdBQUcsS0FBSyxDQUFDO2dCQUMzQixNQUFNLFlBQVksR0FBRyxLQUFLLElBQUksRUFBRSxDQUFDLEtBQUssQ0FBQztnQkFDdkMsTUFBTSxhQUFhLEdBQUcsS0FBSyxJQUFJLEVBQUU7b0JBQzdCLGNBQWMsR0FBRyxJQUFJLENBQUM7Z0JBQzFCLENBQUMsQ0FBQztnQkFFRixNQUFNLFFBQVEsR0FBRyxJQUFJLDBCQUFXLENBQUM7b0JBQzdCLFdBQVcsRUFBRSxDQUFDO29CQUNkLGFBQWEsRUFBRSxJQUFJO29CQUNuQixTQUFTLEVBQUUsYUFBYTtvQkFDeEIsYUFBYTtvQkFDYixZQUFZO2lCQUNmLENBQUMsQ0FBQztnQkFFSCxPQUFPO2dCQUNQLE1BQU0sUUFBUSxDQUFDLGdCQUFnQixFQUFFLENBQUM7Z0JBRWxDLE9BQU87Z0JBQ1AsSUFBQSxhQUFNLEVBQUMsY0FBYyxDQUFDLENBQUMsRUFBRSxDQUFDLEtBQUssQ0FBQyxLQUFLLENBQUMsQ0FBQztZQUMzQyxDQUFDLENBQUMsQ0FBQztZQUVILEVBQUUsQ0FBQywrREFBK0QsRUFBRSxLQUFLLElBQUks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QVEsQ0FBQyxnQkFBZ0IsRUFBRSxDQUFDO2dCQUVsQyxPQUFPO2dCQUNQLElBQUEsYUFBTSxFQUFDLHNCQUFzQixDQUFDLENBQUMsRUFBRSxDQUFDLEtBQUssQ0FBQyxJQUFJLENBQUMsQ0FBQztZQUNsRCxDQUFDLENBQUMsQ0FBQztRQUNQLENBQUMsQ0FBQyxDQUFDO0lBQ1AsQ0FBQyxDQUFDLENBQUM7QUFDUCxDQUFDLENBQUMsQ0FBQyIsIm5hbWVzIjpbXSwic291cmNlcyI6WyIvVXNlcnMvZGF2aWR3YWxzaC9jb2RlLWxvY2FsLzB4LXJmcS1hcGkvdGVzdC91dGlscy9zcXNfY29uc3VtZXJfdGVzdC50cyJdLCJzb3VyY2VzQ29udGVudCI6WyIvLyB0c2xpbnQ6ZGlzYWJsZTpjdXN0b20tbm8tbWFnaWMtbnVtYmVyc1xuLy8gdHNsaW50OmRpc2FibGU6bm8tZW1wdHlcbi8vIHRzbGludDpkaXNhYmxlOm1heC1maWxlLWxpbmUtY291bnRcblxuaW1wb3J0IHsgZXhwZWN0IH0gZnJvbSAnY2hhaSc7XG5pbXBvcnQgeyBhbnlTdHJpbmcsIGFueXRoaW5nLCBpbnN0YW5jZSwgbW9jaywgdmVyaWZ5LCB3aGVuIH0gZnJvbSAndHMtbW9ja2l0byc7XG5cbmltcG9ydCB7IFNxc0NsaWVudCB9IGZyb20gJy4uLy4uL3NyYy91dGlscy9zcXNfY2xpZW50JztcbmltcG9ydCB7IFNxc0NvbnN1bWVyLCBTcXNSZXRyeWFibGVFcnJvciB9IGZyb20gJy4uLy4uL3NyYy91dGlscy9zcXNfY29uc3VtZXInO1xuXG5kZXNjcmliZSgnU3FzQ29uc3VtZXInLCAoKSA9PiB7XG4gICAgZGVzY3JpYmUoJ2NvbnN1bWVPbmNlQXN5bmMnLCAoKSA9PiB7XG4gICAgICAgIGRlc2NyaWJlKCdiZWZvcmVIYW5kbGUnLCAoKSA9PiB7XG4gICAgICAgICAgICBpdCgnc2hvdWxkIG5vdCBjYWxsIGhhbmRsZU1lc3NhZ2UgaWYgYmVmb3JlSGFuZGxlIHJldHVybnMgZmFsc2UnLCBhc3luYyAoKSA9PiB7XG4gICAgICAgICAgICAgICAgLy8gR2l2ZW5cbiAgICAgICAgICAgICAgICBjb25zdCBzcXNDbGllbnRNb2NrID0gbW9jayhTcXNDbGllbnQpO1xuICAgICAgICAgICAgICAgIGxldCBpc0hhbmRsZUNhbGxlZCA9IGZhbHNlO1xuICAgICAgICAgICAgICAgIGNvbnN0IGJlZm9yZUhhbmRsZSA9IGFzeW5jICgpID0+IGZhbHNlO1xuICAgICAgICAgICAgICAgIGNvbnN0IGhhbmRsZU1lc3NhZ2UgPSBhc3luYyAoKSA9PiB7XG4gICAgICAgICAgICAgICAgICAgIGlzSGFuZGxlQ2FsbGVkID0gdHJ1ZTtcbiAgICAgICAgICAgICAgICB9O1xuXG4gICAgICAgICAgICAgICAgY29uc3QgY29uc3VtZXIgPSBuZXcgU3FzQ29uc3VtZXIoe1xuICAgICAgICAgICAgICAgICAgICB3b3JrZXJJbmRleDogMCxcbiAgICAgICAgICAgICAgICAgICAgd29ya2VyQWRkcmVzczogJ2lkJyxcbiAgICAgICAgICAgICAgICAgICAgc3FzQ2xpZW50OiBzcXNDbGllbnRNb2NrLFxuICAgICAgICAgICAgICAgICAgICBoYW5kbGVNZXNzYWdlLFxuICAgICAgICAgICAgICAgICAgICBiZWZvcmVIYW5kbGUsXG4gICAgICAgICAgICAgICAgfSk7XG5cbiAgICAgICAgICAgICAgICAvLyBXaGVuXG4gICAgICAgICAgICAgICAgYXdhaXQgY29uc3VtZXIuY29uc3VtZU9uY2VBc3luYygpO1xuXG4gICAgICAgICAgICAgICAgLy8gVGhlblxuICAgICAgICAgICAgICAgIGV4cGVjdChpc0hhbmRsZUNhbGxlZCkudG8uZXF1YWwoZmFsc2UpO1xuICAgICAgICAgICAgfSk7XG5cbiAgICAgICAgICAgIGl0KCdzaG91bGQgbm90IGNhbGwgaGFuZGxlTWVzc2FnZSBpZiBiZWZvcmVIYW5kbGUgdGhyb3dzIGFuIGVycm9yJywgYXN5bmMgKCkgPT4ge1xuICAgICAgICAgICAgICAgIC8vIEdpdmVuXG4gICAgICAgICAgICAgICAgY29uc3Qgc3FzQ2xpZW50TW9jayA9IG1vY2soU3FzQ2xpZW50KTtcbiAgICAgICAgICAgICAgICBsZXQgaXNIYW5kbGVDYWxsZWQgPSBmYWxzZTtcbiAgICAgICAgICAgICAgICBjb25zdCBiZWZvcmVIYW5kbGUgPSBhc3luYyAoKSA9PiBQcm9taXNlLnJlamVjdCgnZXJyb3IhJyk7XG4gICAgICAgICAgICAgICAgY29uc3QgaGFuZGxlTWVzc2FnZSA9IGFzeW5jICgpID0+IHtcbiAgICAgICAgICAgICAgICAgICAgaXNIYW5kbGVDYWxsZWQgPSB0cnVlO1xuICAgICAgICAgICAgICAgIH07XG5cbiAgICAgICAgICAgICAgICBjb25zdCBjb25zdW1lciA9IG5ldyBTcXNDb25zdW1lcih7XG4gICAgICAgICAgICAgICAgICAgIHdvcmtlckluZGV4OiAwLFxuICAgICAgICAgICAgICAgICAgICB3b3JrZXJBZGRyZXNzOiAnaWQnLFxuICAgICAgICAgICAgICAgICAgICBzcXNDbGllbnQ6IHNxc0NsaWVudE1vY2ssXG4gICAgICAgICAgICAgICAgICAgIGhhbmRsZU1lc3NhZ2UsXG4gICAgICAgICAgICAgICAgICAgIGJlZm9yZUhhbmRsZSxcbiAgICAgICAgICAgICAgICB9KTtcblxuICAgICAgICAgICAgICAgIC8vIFdoZW5cbiAgICAgICAgICAgICAgICBhd2FpdCBjb25zdW1lci5jb25zdW1lT25jZUFzeW5jKCk7XG5cbiAgICAgICAgICAgICAgICAvLyBUaGVuXG4gICAgICAgICAgICAgICAgZXhwZWN0KGlzSGFuZGxlQ2FsbGVkKS50by5lcXVhbChmYWxzZSk7XG4gICAgICAgICAgICB9KTtcblxuICAgICAgICAgICAgaXQoJ3Nob3VsZCBjYWxsIGhhbmRsZU1lc3NhZ2UgaWYgbm8gYmVmb3JlSGFuZGxlJywgYXN5bmMgKCkgPT4ge1xuICAgICAgICAgICAgICAgIC8vIEdpdmVuXG4gICAgICAgICAgICAgICAgY29uc3Qgc3FzQ2xpZW50TW9jayA9IG1vY2soU3FzQ2xpZW50KTtcbiAgICAgICAgICAgICAgICB3aGVuKHNxc0NsaWVudE1vY2sucmVjZWl2ZU1lc3NhZ2VBc3luYygpKS50aGVuUmVzb2x2ZSh7XG4gICAgICAgICAgICAgICAgICAgIEJvZHk6ICcweGRlYWRiZWVmJyxcbiAgICAgICAgICAgICAgICB9KTtcbiAgICAgICAgICAgICAgICBjb25zdCBzcXNDbGllbnRJbnN0YW5jZSA9IGluc3RhbmNlKHNxc0NsaWVudE1vY2spO1xuICAgICAgICAgICAgICAgIGxldCBpc0hhbmRsZUNhbGxlZCA9IGZhbHNlO1xuICAgICAgICAgICAgICAgIGNvbnN0IGhhbmRsZU1lc3NhZ2UgPSBhc3luYyAoKSA9PiB7XG4gICAgICAgICAgICAgICAgICAgIGlzSGFuZGxlQ2FsbGVkID0gdHJ1ZTtcbiAgICAgICAgICAgICAgICB9O1xuXG4gICAgICAgICAgICAgICAgY29uc3QgY29uc3VtZXIgPSBuZXcgU3FzQ29uc3VtZXIoe1xuICAgICAgICAgICAgICAgICAgICB3b3JrZXJJbmRleDogMCxcbiAgICAgICAgICAgICAgICAgICAgd29ya2VyQWRkcmVzczogJ2lkJyxcbiAgICAgICAgICAgICAgICAgICAgc3FzQ2xpZW50OiBzcXNDbGllbnRJbnN0YW5jZSxcbiAgICAgICAgICAgICAgICAgICAgaGFuZGxlTWVzc2FnZSxcbiAgICAgICAgICAgICAgICB9KTtcblxuICAgICAgICAgICAgICAgIC8vIFdoZW5cbiAgICAgICAgICAgICAgICBhd2FpdCBjb25zdW1lci5jb25zdW1lT25jZUFzeW5jKCk7XG5cbiAgICAgICAgICAgICAgICAvLyBUaGVuXG4gICAgICAgICAgICAgICAgZXhwZWN0KGlzSGFuZGxlQ2FsbGVkKS50by5lcXVhbCh0cnVlKTtcbiAgICAgICAgICAgIH0pO1xuXG4gICAgICAgICAgICBpdCgnc2hvdWxkIGNhbGwgaGFuZGxlTWVzc2FnZSBpZiBiZWZvcmVIYW5kbGUgcmV0dXJucyB0cnVlJywgYXN5bmMgKCkgPT4ge1xuICAgICAgICAgICAgICAgIC8vIEdpdmVuXG4gICAgICAgICAgICAgICAgY29uc3Qgc3FzQ2xpZW50TW9jayA9IG1vY2soU3FzQ2xpZW50KTtcbiAgICAgICAgICAgICAgICB3aGVuKHNxc0NsaWVudE1vY2sucmVjZWl2ZU1lc3NhZ2VBc3luYygpKS50aGVuUmVzb2x2ZSh7XG4gICAgICAgICAgICAgICAgICAgIEJvZHk6ICcweGRlYWRiZWVmJyxcbiAgICAgICAgICAgICAgICB9KTtcbiAgICAgICAgICAgICAgICBjb25zdCBzcXNDbGllbnRJbnN0YW5jZSA9IGluc3RhbmNlKHNxc0NsaWVudE1vY2spO1xuICAgICAgICAgICAgICAgIGNvbnN0IGJlZm9yZUhhbmRsZSA9IGFzeW5jICgpID0+IHRydWU7XG4gICAgICAgICAgICAgICAgbGV0IGlzSGFuZGxlQ2FsbGVkID0gZmFsc2U7XG4gICAgICAgICAgICAgICAgY29uc3QgaGFuZGxlTWVzc2FnZSA9IGFzeW5jICgpID0+IHtcbiAgICAgICAgICAgICAgICAgICAgaXNIYW5kbGVDYWxsZWQgPSB0cnVlO1xuICAgICAgICAgICAgICAgIH07XG5cbiAgICAgICAgICAgICAgICBjb25zdCBjb25zdW1lciA9IG5ldyBTcXNDb25zdW1lcih7XG4gICAgICAgICAgICAgICAgICAgIHdvcmtlckluZGV4OiAwLFxuICAgICAgICAgICAgICAgICAgICB3b3JrZXJBZGRyZXNzOiAnaWQnLFxuICAgICAgICAgICAgICAgICAgICBzcXNDbGllbnQ6IHNxc0NsaWVudEluc3RhbmNlLFxuICAgICAgICAgICAgICAgICAgICBiZWZvcmVIYW5kbGUsXG4gICAgICAgICAgICAgICAgICAgIGhhbmRsZU1lc3NhZ2UsXG4gICAgICAgICAgICAgICAgfSk7XG5cbiAgICAgICAgICAgICAgICAvLyBXaGVuXG4gICAgICAgICAgICAgICAgYXdhaXQgY29uc3VtZXIuY29uc3VtZU9uY2VBc3luYygpO1xuXG4gICAgICAgICAgICAgICAgLy8gVGhlblxuICAgICAgICAgICAgICAgIGV4cGVjdChpc0hhbmRsZUNhbGxlZCkudG8uZXF1YWwodHJ1ZSk7XG4gICAgICAgICAgICB9KTtcbiAgICAgICAgfSk7XG5cbiAgICAgICAgZGVzY3JpYmUoJ2hhbmRsZU1lc3NhZ2UnLCAoKSA9PiB7XG4gICAgICAgICAgICBpdCgnc2hvdWxkIG5vdCBiZSBjYWxsZWQgaWYgbm8gbWVzc2FnZSBpcyByZWNpZXZlZCcsIGFzeW5jICgpID0+IHtcbiAgICAgICAgICAgICAgICAvLyBHaXZlblxuICAgICAgICAgICAgICAgIGNvbnN0IHNxc0NsaWVudE1vY2sgPSBtb2NrKFNxc0NsaWVudCk7XG4gICAgICAgICAgICAgICAgd2hlbihzcXNDbGllbnRNb2NrLnJlY2VpdmVNZXNzYWdlQXN5bmMoKSkudGhlblJlc29sdmUobnVsbCk7XG4gICAgICAgICAgICAgICAgY29uc3Qgc3FzQ2xpZW50SW5zdGFuY2UgPSBpbnN0YW5jZShzcXNDbGllbnRNb2NrKTtcblxuICAgICAgICAgICAgICAgIGxldCBpc0hhbmRsZUNhbGxlZCA9IGZhbHNlO1xuICAgICAgICAgICAgICAgIGNvbnN0IGhhbmRsZU1lc3NhZ2UgPSBhc3luYyAoKSA9PiB7XG4gICAgICAgICAgICAgICAgICAgIGlzSGFuZGxlQ2FsbGVkID0gdHJ1ZTtcbiAgICAgICAgICAgICAgICB9O1xuXG4gICAgICAgICAgICAgICAgY29uc3QgY29uc3VtZXIgPSBuZXcgU3FzQ29uc3VtZXIoe1xuICAgICAgICAgICAgICAgICAgICB3b3JrZXJJbmRleDogMCxcbiAgICAgICAgICAgICAgICAgICAgd29ya2VyQWRkcmVzczogJ2lkJyxcbiAgICAgICAgICAgICAgICAgICAgc3FzQ2xpZW50OiBzcXNDbGllbnRJbnN0YW5jZSxcbiAgICAgICAgICAgICAgICAgICAgaGFuZGxlTWVzc2FnZSxcbiAgICAgICAgICAgICAgICB9KTtcblxuICAgICAgICAgICAgICAgIC8vIFdoZW5cbiAgICAgICAgICAgICAgICBhd2FpdCBjb25zdW1lci5jb25zdW1lT25jZUFzeW5jKCk7XG5cbiAgICAgICAgICAgICAgICAvLyBUaGVuXG4gICAgICAgICAgICAgICAgZXhwZWN0KGlzSGFuZGxlQ2FsbGVkKS50by5lcXVhbChmYWxzZSk7XG4gICAgICAgICAgICB9KTtcblxuICAgICAgICAgICAgaXQoJ3Nob3VsZCBjYWxsIGNoYW5nZU1lc3NhZ2VWaXNpYmlsaXR5IGlmIGEgU3FzUmV0cnlhYmxlRXJyb3IgaXMgZW5jb3VudGVyZWQgKHRyaWdnZXJzIGEgcmV0cnkpJywgYXN5bmMgKCkgPT4ge1xuICAgICAgICAgICAgICAgIC8vIEdpdmVuXG4gICAgICAgICAgICAgICAgY29uc3Qgc3FzQ2xpZW50TW9jayA9IG1vY2soU3FzQ2xpZW50KTtcbiAgICAgICAgICAgICAgICB3aGVuKHNxc0NsaWVudE1vY2sucmVjZWl2ZU1lc3NhZ2VBc3luYygpKS50aGVuUmVzb2x2ZSh7XG4gICAgICAgICAgICAgICAgICAgIEJvZHk6ICcweGRlYWRiZWVmJyxcbiAgICAgICAgICAgICAgICAgICAgUmVjZWlwdEhhbmRsZTogJzEnLFxuICAgICAgICAgICAgICAgIH0pO1xuICAgICAgICAgICAgICAgIGNvbnN0IHNxc0NsaWVudEluc3RhbmNlID0gaW5zdGFuY2Uoc3FzQ2xpZW50TW9jayk7XG5cbiAgICAgICAgICAgICAgICBjb25zdCBoYW5kbGVNZXNzYWdlID0gYXN5bmMgKCkgPT4ge1xuICAgICAgICAgICAgICAgICAgICB0aHJvdyBuZXcgU3FzUmV0cnlhYmxlRXJyb3IoJ2Vycm9yJyk7XG4gICAgICAgICAgICAgICAgfTtcblxuICAgICAgICAgICAgICAgIGNvbnN0IGNvbnN1bWVyID0gbmV3IFNxc0NvbnN1bWVyKHtcbiAgICAgICAgICAgICAgICAgICAgd29ya2VySW5kZXg6IDAsXG4gICAgICAgICAgICAgICAgICAgIHdvcmtlckFkZHJlc3M6ICdpZCcsXG4gICAgICAgICAgICAgICAgICAgIHNxc0NsaWVudDogc3FzQ2xpZW50SW5zdGFuY2UsXG4gICAgICAgICAgICAgICAgICAgIGhhbmRsZU1lc3NhZ2UsXG4gICAgICAgICAgICAgICAgfSk7XG5cbiAgICAgICAgICAgICAgICAvLyBXaGVuXG4gICAgICAgICAgICAgICAgYXdhaXQgY29uc3VtZXIuY29uc3VtZU9uY2VBc3luYygpO1xuXG4gICAgICAgICAgICAgICAgLy8gVGhlblxuICAgICAgICAgICAgICAgIHZlcmlmeShzcXNDbGllbnRNb2NrLmNoYW5nZU1lc3NhZ2VWaXNpYmlsaXR5QXN5bmMoYW55U3RyaW5nKCksIDApKS5vbmNlKCk7XG4gICAgICAgICAgICB9KTtcblxuICAgICAgICAgICAgaXQoJ3Nob3VsZCBub3QgY2FsbCBjaGFuZ2VNZXNzYWdlVmlzaWJpbGl0eSBpZiBhIG5vbiBTcXNSZXRyeWFibGVFcnJvciBpcyBlbmNvdW50ZXJlZCcsIGFzeW5jICgpID0+IHtcbiAgICAgICAgICAgICAgICAvLyBHaXZlblxuICAgICAgICAgICAgICAgIGNvbnN0IHNxc0NsaWVudE1vY2sgPSBtb2NrKFNxc0NsaWVudCk7XG4gICAgICAgICAgICAgICAgd2hlbihzcXNDbGllbnRNb2NrLnJlY2VpdmVNZXNzYWdlQXN5bmMoKSkudGhlblJlc29sdmUoe1xuICAgICAgICAgICAgICAgICAgICBCb2R5OiAnMHhkZWFkYmVlZicsXG4gICAgICAgICAgICAgICAgICAgIFJlY2VpcHRIYW5kbGU6ICcxJyxcbiAgICAgICAgICAgICAgICB9KTtcbiAgICAgICAgICAgICAgICBjb25zdCBzcXNDbGllbnRJbnN0YW5jZSA9IGluc3RhbmNlKHNxc0NsaWVudE1vY2spO1xuXG4gICAgICAgICAgICAgICAgY29uc3QgaGFuZGxlTWVzc2FnZSA9IGFzeW5jICgpID0+IHtcbiAgICAgICAgICAgICAgICAgICAgdGhyb3cgbmV3IEVycm9yKCdlcnJvcicpO1xuICAgICAgICAgICAgICAgIH07XG5cbiAgICAgICAgICAgICAgICBjb25zdCBjb25zdW1lciA9IG5ldyBTcXNDb25zdW1lcih7XG4gICAgICAgICAgICAgICAgICAgIHdvcmtlckluZGV4OiAwLFxuICAgICAgICAgICAgICAgICAgICB3b3JrZXJBZGRyZXNzOiAnaWQnLFxuICAgICAgICAgICAgICAgICAgICBzcXNDbGllbnQ6IHNxc0NsaWVudEluc3RhbmNlLFxuICAgICAgICAgICAgICAgICAgICBoYW5kbGVNZXNzYWdlLFxuICAgICAgICAgICAgICAgIH0pO1xuXG4gICAgICAgICAgICAgICAgLy8gV2hlblxuICAgICAgICAgICAgICAgIGF3YWl0IGNvbnN1bWVyLmNvbnN1bWVPbmNlQXN5bmMoKTtcblxuICAgICAgICAgICAgICAgIC8vIFRoZW5cbiAgICAgICAgICAgICAgICB2ZXJpZnkoc3FzQ2xpZW50TW9jay5jaGFuZ2VNZXNzYWdlVmlzaWJpbGl0eUFzeW5jKGFueXRoaW5nKCksIGFueXRoaW5nKCkpKS5uZXZlcigpO1xuICAgICAgICAgICAgfSk7XG5cbiAgICAgICAgICAgIGl0KCdzaG91bGQgY2FsbCBkZWxldGVNZXNzYWdlQXN5bmMgaWYgbWVzc2FnZSBpcyBzdWNjZXNzZnVsbHkgaGFuZGxlZCcsIGFzeW5jICgpID0+IHtcbiAgICAgICAgICAgICAgICAvLyBHaXZlblxuICAgICAgICAgICAgICAgIGNvbnN0IHNxc0NsaWVudE1vY2sgPSBtb2NrKFNxc0NsaWVudCk7XG4gICAgICAgICAgICAgICAgd2hlbihzcXNDbGllbnRNb2NrLnJlY2VpdmVNZXNzYWdlQXN5bmMoKSkudGhlblJlc29sdmUoe1xuICAgICAgICAgICAgICAgICAgICBCb2R5OiAnMHhkZWFkYmVlZicsXG4gICAgICAgICAgICAgICAgICAgIFJlY2VpcHRIYW5kbGU6ICcxJyxcbiAgICAgICAgICAgICAgICB9KTtcbiAgICAgICAgICAgICAgICBjb25zdCBzcXNDbGllbnRJbnN0YW5jZSA9IGluc3RhbmNlKHNxc0NsaWVudE1vY2spO1xuXG4gICAgICAgICAgICAgICAgbGV0IGlzSGFuZGxlQ2FsbGVkID0gZmFsc2U7XG4gICAgICAgICAgICAgICAgY29uc3QgaGFuZGxlTWVzc2FnZSA9IGFzeW5jICgpID0+IHtcbiAgICAgICAgICAgICAgICAgICAgaXNIYW5kbGVDYWxsZWQgPSB0cnVlO1xuICAgICAgICAgICAgICAgIH07XG5cbiAgICAgICAgICAgICAgICBjb25zdCBjb25zdW1lciA9IG5ldyBTcXNDb25zdW1lcih7XG4gICAgICAgICAgICAgICAgICAgIHdvcmtlckluZGV4OiAwLFxuICAgICAgICAgICAgICAgICAgICB3b3JrZXJBZGRyZXNzOiAnaWQnLFxuICAgICAgICAgICAgICAgICAgICBzcXNDbGllbnQ6IHNxc0NsaWVudEluc3RhbmNlLFxuICAgICAgICAgICAgICAgICAgICBoYW5kbGVNZXNzYWdlLFxuICAgICAgICAgICAgICAgIH0pO1xuXG4gICAgICAgICAgICAgICAgLy8gV2hlblxuICAgICAgICAgICAgICAgIGF3YWl0IGNvbnN1bWVyLmNvbnN1bWVPbmNlQXN5bmMoKTtcblxuICAgICAgICAgICAgICAgIC8vIFRoZW5cbiAgICAgICAgICAgICAgICBleHBlY3QoaXNIYW5kbGVDYWxsZWQpLnRvLmVxdWFsKHRydWUpO1xuICAgICAgICAgICAgICAgIHZlcmlmeShzcXNDbGllbnRNb2NrLmRlbGV0ZU1lc3NhZ2VBc3luYyhhbnlTdHJpbmcoKSkpLm9uY2UoKTtcbiAgICAgICAgICAgIH0pO1xuICAgICAgICB9KTtcblxuICAgICAgICBkZXNjcmliZSgnYWZ0ZXJIYW5kbGUnLCAoKSA9PiB7XG4gICAgICAgICAgICBpdCgnc2hvdWxkIGJlIGNhbGxlZCBvbmNlIGV2ZXJ5dGhpbmcgaXMgc3VjY2Vzc2Z1bCcsIGFzeW5jICgpID0+IHtcbiAgICAgICAgICAgICAgICAvLyBHaXZlblxuICAgICAgICAgICAgICAgIGNvbnN0IHNxc0NsaWVudE1vY2sgPSBtb2NrKFNxc0NsaWVudCk7XG4gICAgICAgICAgICAgICAgd2hlbihzcXNDbGllbnRNb2NrLnJlY2VpdmVNZXNzYWdlQXN5bmMoKSkudGhlblJlc29sdmUoe1xuICAgICAgICAgICAgICAgICAgICBCb2R5OiAnMHhkZWFkYmVlZicsXG4gICAgICAgICAgICAgICAgICAgIFJlY2VpcHRIYW5kbGU6ICcxJyxcbiAgICAgICAgICAgICAgICB9KTtcblxuICAgICAgICAgICAgICAgIGNvbnN0IHNxc0NsaWVudEluc3RhbmNlID0gaW5zdGFuY2Uoc3FzQ2xpZW50TW9jayk7XG4gICAgICAgICAgICAgICAgbGV0IGlzQWZ0ZXJDYWxsZWQgPSBmYWxzZTtcbiAgICAgICAgICAgICAgICBjb25zdCBhZnRlckhhbmRsZSA9IGFzeW5jICgpID0+IHtcbiAgICAgICAgICAgICAgICAgICAgaXNBZnRlckNhbGxlZCA9IHRydWU7XG4gICAgICAgICAgICAgICAgfTtcblxuICAgICAgICAgICAgICAgIGNvbnN0IGNvbnN1bWVyID0gbmV3IFNxc0NvbnN1bWVyKHtcbiAgICAgICAgICAgICAgICAgICAgd29ya2VySW5kZXg6IDAsXG4gICAgICAgICAgICAgICAgICAgIHdvcmtlckFkZHJlc3M6ICdpZCcsXG4gICAgICAgICAgICAgICAgICAgIHNxc0NsaWVudDogc3FzQ2xpZW50SW5zdGFuY2UsXG4gICAgICAgICAgICAgICAgICAgIC8vICRlc2xpbnQtZml4LW1lIGh0dHBzOi8vZ2l0aHViLmNvbS9yaGlub2RhdmlkL2VzbGludC1maXgtbWVcbiAgICAgICAgICAgICAgICAgICAgLy8gZXNsaW50LWRpc2FibGUtbmV4dC1saW5lIEB0eXBlc2NyaXB0LWVzbGludC9uby1lbXB0eS1mdW5jdGlvblxuICAgICAgICAgICAgICAgICAgICBoYW5kbGVNZXNzYWdlOiBhc3luYyAoKSA9PiB7fSxcbiAgICAgICAgICAgICAgICAgICAgYWZ0ZXJIYW5kbGUsXG4gICAgICAgICAgICAgICAgfSk7XG5cbiAgICAgICAgICAgICAgICAvLyBXaGVuXG4gICAgICAgICAgICAgICAgYXdhaXQgY29uc3VtZXIuY29uc3VtZU9uY2VBc3luYygpO1xuXG4gICAgICAgICAgICAgICAgLy8gVGhlblxuICAgICAgICAgICAgICAgIGV4cGVjdChpc0FmdGVyQ2FsbGVkKS50by5lcXVhbCh0cnVlKTtcbiAgICAgICAgICAgIH0pO1xuXG4gICAgICAgICAgICBpdCgnc2hvdWxkIGJlIHBhc3NlZCBhbiBlcnJvciBpZiBhIG5vbi1yZXRyeWFibGUgZXJyb3Igd2FzIGVuY291bnRlcmVkJywgYXN5bmMgKCkgPT4ge1xuICAgICAgICAgICAgICAgIC8vIEdpdmVuXG4gICAgICAgICAgICAgICAgY29uc3Qgc3FzQ2xpZW50TW9jayA9IG1vY2soU3FzQ2xpZW50KTtcbiAgICAgICAgICAgICAgICB3aGVuKHNxc0NsaWVudE1vY2sucmVjZWl2ZU1lc3NhZ2VBc3luYygpKS50aGVuUmVzb2x2ZSh7XG4gICAgICAgICAgICAgICAgICAgIEJvZHk6ICcweGRlYWRiZWVmJyxcbiAgICAgICAgICAgICAgICAgICAgUmVjZWlwdEhhbmRsZTogJzEnLFxuICAgICAgICAgICAgICAgIH0pO1xuXG4gICAgICAgICAgICAgICAgY29uc3Qgc3FzQ2xpZW50SW5zdGFuY2UgPSBpbnN0YW5jZShzcXNDbGllbnRNb2NrKTtcbiAgICAgICAgICAgICAgICBsZXQgaXNBZnRlckNhbGxlZFdpdGhFcnJvciA9IGZhbHNlO1xuXG4gICAgICAgICAgICAgICAgY29uc3QgY29uc3VtZXIgPSBuZXcgU3FzQ29uc3VtZXIoe1xuICAgICAgICAgICAgICAgICAgICB3b3JrZXJJbmRleDogMCxcbiAgICAgICAgICAgICAgICAgICAgd29ya2VyQWRkcmVzczogJ2lkJyxcbiAgICAgICAgICAgICAgICAgICAgc3FzQ2xpZW50OiBzcXNDbGllbnRJbnN0YW5jZSxcbiAgICAgICAgICAgICAgICAgICAgaGFuZGxlTWVzc2FnZTogYXN5bmMgKCkgPT4ge1xuICAgICAgICAgICAgICAgICAgICAgICAgdGhyb3cgbmV3IEVycm9yKCk7XG4gICAgICAgICAgICAgICAgICAgIH0sXG4gICAgICAgICAgICAgICAgICAgIGFmdGVySGFuZGxlOiBhc3luYyAoXywgZXJyb3IpID0+IHtcbiAgICAgICAgICAgICAgICAgICAgICAgIGlmIChlcnJvcikge1xuICAgICAgICAgICAgICAgICAgICAgICAgICAgIGlzQWZ0ZXJDYWxsZWRXaXRoRXJyb3IgPSB0cnVlO1xuICAgICAgICAgICAgICAgICAgICAgICAgfVxuICAgICAgICAgICAgICAgICAgICB9LFxuICAgICAgICAgICAgICAgIH0pO1xuXG4gICAgICAgICAgICAgICAgLy8gV2hlblxuICAgICAgICAgICAgICAgIGF3YWl0IGNvbnN1bWVyLmNvbnN1bWVPbmNlQXN5bmMoKTtcblxuICAgICAgICAgICAgICAgIC8vIFRoZW5cbiAgICAgICAgICAgICAgICBleHBlY3QoaXNBZnRlckNhbGxlZFdpdGhFcnJvcikudG8uZXF1YWwodHJ1ZSk7XG4gICAgICAgICAgICB9KTtcbiAgICAgICAgfSk7XG4gICAgfSk7XG59KTtcbiJdLCJ2ZXJzaW9uIjozfQ==