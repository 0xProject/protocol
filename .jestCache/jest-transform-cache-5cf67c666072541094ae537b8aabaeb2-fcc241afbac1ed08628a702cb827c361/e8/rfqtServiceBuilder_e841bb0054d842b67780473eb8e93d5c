6b969e0c8c1129da8a19f2192e6fca6d
"use strict";
Object.defineProperty(exports, "__esModule", { value: true });
exports.buildRfqtServicesAsync = void 0;
const asset_swapper_1 = require("@0x/asset-swapper");
const contract_addresses_1 = require("@0x/contract-addresses");
const token_metadata_1 = require("@0x/token-metadata");
const axios_1 = require("axios");
const ethers_1 = require("ethers");
const http_1 = require("http");
const https_1 = require("https");
const kafkajs_1 = require("kafkajs");
const config_1 = require("../config");
const constants_1 = require("../core/constants");
const RefreshingQuoteRequestor_1 = require("../quoteRequestor/RefreshingQuoteRequestor");
const fee_service_1 = require("../services/fee_service");
const RfqtService_1 = require("../services/RfqtService");
const rfq_maker_balance_cache_service_1 = require("../services/rfq_maker_balance_cache_service");
const balance_checker_1 = require("./balance_checker");
const cache_client_1 = require("./cache_client");
const config_manager_1 = require("./config_manager");
const GasStationAttendantUtils_1 = require("./GasStationAttendantUtils");
const provider_utils_1 = require("./provider_utils");
const quote_server_client_1 = require("./quote_server_client");
const rfq_blockchain_utils_1 = require("./rfq_blockchain_utils");
const rfq_maker_manager_1 = require("./rfq_maker_manager");
const TokenMetadataManager_1 = require("./TokenMetadataManager");
const TokenPriceOracle_1 = require("./TokenPriceOracle");
const ZeroExApiClient_1 = require("./ZeroExApiClient");
const DEFAULT_AXIOS_TIMEOUT = 600; // ms
/**
 * Creates an RFQT Service for each chain present in `ChainConfigurations`.
 *
 * Intended for use by the top-level runners.
 */
async function buildRfqtServicesAsync(chainConfigurations, rfqMakerDbUtils, redis) {
    const axiosInstance = axios_1.default.create(getAxiosRequestConfig());
    const configManager = new config_manager_1.ConfigManager();
    const altRfqOptions = config_1.ALT_RFQ_MM_API_KEY !== undefined && config_1.ALT_RFQ_MM_PROFILE !== undefined
        ? {
            // $eslint-fix-me https://github.com/rhinodavid/eslint-fix-me
            // eslint-disable-next-line @typescript-eslint/no-non-null-assertion
            altRfqApiKey: config_1.ALT_RFQ_MM_API_KEY,
            // $eslint-fix-me https://github.com/rhinodavid/eslint-fix-me
            // eslint-disable-next-line @typescript-eslint/no-non-null-assertion
            altRfqProfile: config_1.ALT_RFQ_MM_PROFILE,
        }
        : undefined;
    const services = await Promise.all(chainConfigurations.map(async (chain) => {
        const { rfqt: rfqtConfiguration, chainId } = chain;
        if (!rfqtConfiguration) {
            throw new Error(`RFQt Service for chain ${chainId} does not exist`);
        }
        const rfqMakerManager = new rfq_maker_manager_1.RfqMakerManager(configManager, rfqMakerDbUtils, chainId);
        await rfqMakerManager.initializeAsync();
        const quoteRequestor = new RefreshingQuoteRequestor_1.RefreshingQuoteRequestor(rfqMakerManager, axiosInstance, altRfqOptions);
        const quoteServerClient = new quote_server_client_1.QuoteServerClient(axiosInstance);
        const contractAddresses = (0, contract_addresses_1.getContractAddressesForChainOrThrow)(chainId);
        const ethersProvider = new ethers_1.providers.JsonRpcProvider(chain.rpcUrl, chainId);
        const provider = provider_utils_1.providerUtils.createWeb3Provider(chain.rpcUrl);
        const balanceChecker = new balance_checker_1.BalanceChecker(provider);
        const rfqBlockchainUtils = new rfq_blockchain_utils_1.RfqBlockchainUtils(provider, contractAddresses.exchangeProxy, balanceChecker, ethersProvider);
        const tokenMetadataManager = new TokenMetadataManager_1.TokenMetadataManager(chainId, rfqBlockchainUtils);
        const balanceCheckUtils = new rfq_blockchain_utils_1.RfqBalanceCheckUtils(balanceChecker, contractAddresses.exchangeProxy);
        const cacheClient = new cache_client_1.CacheClient(redis);
        const rfqMakerBalanceCacheService = new rfq_maker_balance_cache_service_1.RfqMakerBalanceCacheService(cacheClient, balanceCheckUtils);
        const kafkaProducer = getKafkaProducer();
        const feeTokenMetadata = (0, token_metadata_1.getTokenMetadataIfExists)(contractAddresses.etherToken, chainId);
        if (feeTokenMetadata === undefined) {
            throw new Error(`Fee token ${contractAddresses.etherToken} on chain ${chainId} could not be found!`);
        }
        const protocolFeeUtils = asset_swapper_1.ProtocolFeeUtils.getInstance(constants_1.PROTOCOL_FEE_UTILS_POLLING_INTERVAL_IN_MS, chain.gasStationUrl);
        const gasStationAttendant = (0, GasStationAttendantUtils_1.getGasStationAttendant)(chain, axiosInstance, protocolFeeUtils);
        const tokenPriceOracle = new TokenPriceOracle_1.TokenPriceOracle(axiosInstance, config_1.DEFINED_FI_API_KEY, config_1.DEFINED_FI_ENDPOINT);
        const zeroExApiClient = new ZeroExApiClient_1.ZeroExApiClient(axios_1.default.create(), config_1.ZERO_EX_API_KEY, chain);
        const feeService = new fee_service_1.FeeService(chainId, feeTokenMetadata, configManager, gasStationAttendant, tokenPriceOracle, zeroExApiClient, rfqtConfiguration.minExpiryDurationMs || constants_1.DEFAULT_MIN_EXPIRY_DURATION_MS);
        return new RfqtService_1.RfqtService(chainId, rfqMakerManager, quoteRequestor, quoteServerClient, rfqtConfiguration.minExpiryDurationMs || constants_1.DEFAULT_MIN_EXPIRY_DURATION_MS, rfqBlockchainUtils, tokenMetadataManager, contractAddresses, feeService, rfqtConfiguration.feeModelVersion || 0, rfqMakerBalanceCacheService, kafkaProducer, rfqtConfiguration.feeEventTopic);
    }));
    return new Map(services.map((s, i) => [chainConfigurations[i].chainId, s]));
}
exports.buildRfqtServicesAsync = buildRfqtServicesAsync;
/**
 * Creates the Axios Request Config
 */
function getAxiosRequestConfig() {
    const axiosRequestConfig = {
        httpAgent: new http_1.Agent({ keepAlive: true, timeout: constants_1.KEEP_ALIVE_TTL }),
        httpsAgent: new https_1.Agent({ keepAlive: true, timeout: constants_1.KEEP_ALIVE_TTL }),
        timeout: DEFAULT_AXIOS_TIMEOUT,
    };
    if (config_1.RFQ_PROXY_ADDRESS !== undefined && config_1.RFQ_PROXY_PORT !== undefined) {
        axiosRequestConfig.proxy = {
            host: config_1.RFQ_PROXY_ADDRESS,
            port: config_1.RFQ_PROXY_PORT,
        };
    }
    return axiosRequestConfig;
}
/**
 * Initialize a kafka producer if KAFKA_BROKERS is set
 */
function getKafkaProducer() {
    let kafkaProducer;
    if (config_1.KAFKA_BROKERS !== undefined) {
        const kafka = new kafkajs_1.Kafka({
            clientId: '0x-api',
            brokers: config_1.KAFKA_BROKERS,
        });
        kafkaProducer = kafka.producer();
        // tslint:disable-next-line: no-floating-promises
        kafkaProducer.connect();
    }
    return kafkaProducer;
}
//# sourceMappingURL=data:application/json;charset=utf-8;base64,eyJmaWxlIjoiL1VzZXJzL2Rhdmlkd2Fsc2gvY29kZS1sb2NhbC8weC1yZnEtYXBpL3NyYy91dGlscy9yZnF0U2VydmljZUJ1aWxkZXIudHMiLCJtYXBwaW5ncyI6Ijs7O0FBQUEscURBQXdFO0FBQ3hFLCtEQUE2RTtBQUM3RSx1REFBOEQ7QUFDOUQsaUNBQWtEO0FBQ2xELG1DQUFtQztBQUNuQywrQkFBMEM7QUFDMUMsaUNBQTRDO0FBRTVDLHFDQUEyRDtBQUUzRCxzQ0FVbUI7QUFDbkIsaURBSTJCO0FBQzNCLHlGQUFzRjtBQUN0Rix5REFBcUQ7QUFDckQseURBQXNEO0FBQ3RELGlHQUEwRjtBQUUxRix1REFBbUQ7QUFDbkQsaURBQTZDO0FBQzdDLHFEQUFpRDtBQUNqRCx5RUFBb0U7QUFDcEUscURBQWlEO0FBQ2pELCtEQUEwRDtBQUMxRCxpRUFBa0Y7QUFFbEYsMkRBQXNEO0FBQ3RELGlFQUE4RDtBQUM5RCx5REFBc0Q7QUFDdEQsdURBQW9EO0FBSXBELE1BQU0scUJBQXFCLEdBQUcsR0FBRyxDQUFDLENBQUMsS0FBSztBQUV4Qzs7OztHQUlHO0FBQ0ksS0FBSyxVQUFVLHNCQUFzQixDQUN4QyxtQkFBd0MsRUFDeEMsZUFBZ0MsRUFDaEMsS0FBWTtJQUVaLE1BQU0sYUFBYSxHQUFHLGVBQUssQ0FBQyxNQUFNLENBQUMscUJBQXFCLEVBQUUsQ0FBQyxDQUFDO0lBQzVELE1BQU0sYUFBYSxHQUFHLElBQUksOEJBQWEsRUFBRSxDQUFDO0lBQzFDLE1BQU0sYUFBYSxHQUNmLDJCQUFrQixLQUFLLFNBQVMsSUFBSSwyQkFBa0IsS0FBSyxTQUFTO1FBQ2hFLENBQUMsQ0FBQztZQUNJLDZEQUE2RDtZQUM3RCxvRUFBb0U7WUFDcEUsWUFBWSxFQUFFLDJCQUFtQjtZQUNqQyw2REFBNkQ7WUFDN0Qsb0VBQW9FO1lBQ3BFLGFBQWEsRUFBRSwyQkFBbUI7U0FDckM7UUFDSCxDQUFDLENBQUMsU0FBUyxDQUFDO0lBQ3BCLE1BQU0sUUFBUSxHQUFHLE1BQU0sT0FBTyxDQUFDLEdBQUcsQ0FDOUIsbUJBQW1CLENB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TUFBTSxLQUFLLEdBQUcsSUFBSSxlQUFLLENBQUM7WUFDcEIsUUFBUSxFQUFFLFFBQVE7WUFDbEIsT0FBTyxFQUFFLHNCQUFhO1NBQ3pCLENBQUMsQ0FBQztRQUVILGFBQWEsR0FBRyxLQUFLLENBQUMsUUFBUSxFQUFFLENBQUM7UUFDakMsaURBQWlEO1FBQ2pELGFBQWEsQ0FBQyxPQUFPLEVBQUUsQ0FBQztLQUMzQjtJQUNELE9BQU8sYUFBYSxDQUFDO0FBQ3pCLENBQUMiLCJuYW1lcyI6W10sInNvdXJjZXMiOlsiL1VzZXJzL2Rhdmlkd2Fsc2gvY29kZS1sb2NhbC8weC1yZnEtYXBpL3NyYy91dGlscy9yZnF0U2VydmljZUJ1aWxkZXIudHMiXSwic291cmNlc0NvbnRlbnQiOlsiaW1wb3J0IHsgUHJvdG9jb2xGZWVVdGlscywgU3VwcG9ydGVkUHJvdmlkZXIgfSBmcm9tICdAMHgvYXNzZXQtc3dhcHBlcic7XHJcbmltcG9ydCB7IGdldENvbnRyYWN0QWRkcmVzc2VzRm9yQ2hhaW5PclRocm93IH0gZnJvbSAnQDB4L2NvbnRyYWN0LWFkZHJlc3Nlcyc7XHJcbmltcG9ydCB7IGdldFRva2VuTWV0YWRhdGFJZkV4aXN0cyB9IGZyb20gJ0AweC90b2tlbi1tZXRhZGF0YSc7XHJcbmltcG9ydCBBeGlvcywgeyBBeGlvc1JlcXVlc3RDb25maWcgfSBmcm9tICdheGlvcyc7XHJcbmltcG9ydCB7IHByb3ZpZGVycyB9IGZyb20gJ2V0aGVycyc7XHJcbmltcG9ydCB7IEFnZW50IGFzIEh0dHBBZ2VudCB9IGZyb20gJ2h0dHAnO1xyXG5pbXBvcnQgeyBBZ2VudCBhcyBIdHRwc0FnZW50IH0gZnJvbSAnaHR0cHMnO1xyXG5pbXBvcnQgUmVkaXMgZnJvbSAnaW9yZWRpcyc7XHJcbmltcG9ydCB7IEthZmthLCBQcm9kdWNlciBhcyBLYWZrYVByb2R1Y2VyIH0gZnJvbSAna2Fma2Fqcyc7XHJcblxyXG5pbXBvcnQge1xyXG4gICAgQUxUX1JGUV9NTV9BUElfS0VZLFxyXG4gICAgQUxUX1JGUV9NTV9QUk9GSUxFLFxyXG4gICAgQ2hhaW5Db25maWd1cmF0aW9ucyxcclxuICAgIERFRklORURfRklfQVBJX0tFWSxcclxuICAgIERFRklORURfRklfRU5EUE9JTlQsXHJcbiAgICBLQUZLQV9CUk9LRVJTLFxyXG4gICAgUkZRX1BST1hZX0FERFJFU1MsXHJcbiAgICBSRlFfUFJPWFlfUE9SVCxcclxuICAgIFpFUk9fRVhfQVBJX0tFWSxcclxufSBmcm9tICcuLi9jb25maWcnO1xyXG5pbXBvcnQge1xyXG4gICAgREVGQVVMVF9NSU5fRVhQSVJZX0RVUkFUSU9OX01TLFxyXG4gICAgS0VFUF9BTElWRV9UVEwsXHJcbiAgICBQUk9UT0NPTF9GRUVfVVRJTFNfUE9MTElOR19JTlRFUlZBTF9JTl9NUyxcclxufSBmcm9tICcuLi9jb3JlL2NvbnN0YW50cyc7XHJcbmltcG9ydCB7IFJlZnJlc2hpbmdRdW90ZVJlcXVlc3RvciB9IGZyb20gJy4uL3F1b3RlUmVxdWVzdG9yL1JlZnJlc2hpbmdRdW90ZVJlcXVlc3Rvcic7XHJcbmltcG9ydCB7IEZlZVNlcnZpY2UgfSBmcm9tICcuLi9zZXJ2aWNlcy9mZWVfc2VydmljZSc7XHJcbmltcG9ydCB7IFJmcXRTZXJ2aWNlIH0gZnJvbSAnLi4vc2VydmljZXMvUmZxdFNlcnZpY2UnO1xyXG5pbXBvcnQgeyBSZnFNYWtlckJhbGFuY2VDYWNoZVNlcnZpY2UgfSBmcm9tICcuLi9zZXJ2aWNlcy9yZnFfbWFrZXJfYmFsYW5jZV9jYWNoZV9zZXJ2aWNlJztcclxuXHJcbmltcG9ydCB7IEJhbGFuY2VDaGVja2VyIH0gZnJvbSAnLi9iYWxhbmNlX2NoZWNrZXInO1xyXG5pbXBvcnQgeyBDYWNoZUNsaWVudCB9IGZyb20gJy4vY2FjaGVfY2xpZW50JztcclxuaW1wb3J0IHsgQ29uZmlnTWFuYWdlciB9IGZyb20gJy4vY29uZmlnX21hbmFnZXInO1xyXG5pbXBvcnQgeyBnZXRHYXNTdGF0aW9uQXR0ZW5kYW50IH0gZnJvbSAnLi9HYXNTdGF0aW9uQXR0ZW5kYW50VXRpbHMnO1xyXG5pbXBvcnQgeyBwcm92aWRlclV0aWxzIH0gZnJvbSAnLi9wcm92aWRlcl91dGlscyc7XHJcbmltcG9ydCB7IFF1b3RlU2VydmVyQ2xpZW50IH0gZnJvbSAnLi9xdW90ZV9zZXJ2ZXJfY2xpZW50JztcclxuaW1wb3J0IHsgUmZxQmFsYW5jZUNoZWNrVXRpbHMsIFJmcUJsb2NrY2hhaW5VdGlscyB9IGZyb20gJy4vcmZxX2Jsb2NrY2hhaW5fdXRpbHMnO1xyXG5pbXBvcnQgeyBSZnFNYWtlckRiVXRpbHMgfSBmcm9tICcuL3JmcV9tYWtlcl9kYl91dGlscyc7XHJcbmltcG9ydCB7IFJmcU1ha2VyTWFuYWdlciB9IGZyb20gJy4vcmZxX21ha2VyX21hbmFnZXInO1xyXG5pbXBvcnQgeyBUb2tlbk1ldGFkYXRhTWFuYWdlciB9IGZyb20gJy4vVG9rZW5NZXRhZGF0YU1hbmFnZXInO1xyXG5pbXBvcnQgeyBUb2tlblByaWNlT3JhY2xlIH0gZnJvbSAnLi9Ub2tlblByaWNlT3JhY2xlJztcclxuaW1wb3J0IHsgWmVyb0V4QXBpQ2xpZW50IH0gZnJvbSAnLi9aZXJvRXhBcGlDbGllbnQnO1xyXG5cclxuZXhwb3J0IHR5cGUgUmZxdFNlcnZpY2VzID0gTWFwPG51bWJlciwgUmZxdFNlcnZpY2U+O1xyXG5cclxuY29uc3QgREVGQVVMVF9BWElPU19USU1FT1VUID0gNjAwOyAvLyBtc1xyXG5cclxuLyoqXHJcbiAqIENyZWF0ZXMgYW4gUkZRVCBTZXJ2aWNlIGZvciBlYWNoIGNoYWluIHByZXNlbnQgaW4gYENoYWluQ29uZmlndXJhdGlvbnNgLlxyXG4gKlxyXG4gKiBJbnRlbmRlZCBmb3IgdXNlIGJ5IHRoZSB0b3AtbGV2ZWwgcnVubmVycy5cclxuICovXHJcbmV4cG9ydCBhc3luYyBmdW5jdGlvbiBidWlsZFJmcXRTZXJ2aWNlc0FzeW5jKFxyXG4gICAgY2hhaW5Db25maWd1cmF0aW9uczogQ2hhaW5Db25maWd1cmF0aW9ucyxcclxuICAgIHJmcU1ha2VyRGJVdGlsczogUmZxTWFrZXJEYlV0aWxzLFxyXG4gICAgcmVkaXM6IFJlZGlzLFxyXG4pOiBQcm9taXNlPFJmcXRTZXJ2aWNlcz4ge1xyXG4gICAgY29uc3QgYXhpb3NJbnN0YW5jZSA9IEF4aW9zLmNyZWF0ZShnZXRBeGlvc1JlcXVlc3RDb25maWcoKSk7XHJcbiAgICBjb25zdCBjb25maWdNYW5hZ2VyID0gbmV3IENvbmZpZ01hbmFnZXIoKTtcclxuICAgIGNvbnN0IGFsdFJmcU9wdGlvbnMgPVxyXG4gICAgICAgIEFMVF9SRlFfTU1fQVBJX0tFWSAhPT0gdW5kZWZpbmVkICYmIEFMVF9SRlFfTU1fUFJPRklMRSAhPT0gdW5kZWZpbmVkXHJcbiAgICAgICAgICAgID8ge1xyXG4gICAgICAgICAgICAgICAgICAvLyAkZXNsaW50LWZpeC1tZSBodHRwczovL2dpdGh1Yi5jb20vcmhpbm9kYXZpZC9lc2xpbnQtZml4LW1lXHJcbiAgICAgICAgICAgICAgICAgIC8vIGVzbGludC1kaXNhYmxlLW5leHQtbGluZSBAdHlwZXNjcmlwdC1lc2xpbnQvbm8tbm9uLW51bGwtYXNzZXJ0aW9uXHJcbiAgICAgICAgICAgICAgICAgIGFsdFJmcUFwaUtleTogQUxUX1JGUV9NTV9BUElfS0VZISxcclxuICAgICAgICAgICAgICAgICAgLy8gJGVzbGludC1maXgtbWUgaHR0cHM6Ly9naXRodWIuY29tL3JoaW5vZGF2aWQvZXNsaW50LWZpeC1tZVxyXG4gICAgICAgICAgICAgICAgICAvLyBlc2xpbnQtZGlzYWJsZS1uZXh0LWxpbmUgQHR5cGVzY3JpcHQtZXNsaW50L25vLW5vbi1udWxsLWFzc2VydGlvblxyXG4gICAgICAgICAgICAgICAgICBhbHRSZnFQcm9maWxlOiBBTFRfUkZRX01NX1BST0ZJTEUhLFxyXG4gICAgICAgICAgICAgIH1cclxuICAgICAgICAgICAgOiB1bmRlZmluZWQ7XHJcbiAgICBjb25zdCBzZXJ2aWNlcyA9IGF3YWl0IFByb21pc2UuYWxsKFxyXG4gICAgICAgIGNoYWluQ29uZmlndXJhdGlvbnMubWFwKGFzeW5jIChjaGFpbikgPT4ge1xyXG4gICAgICAgICAgICBjb25zdCB7IHJmcXQ6IHJmcXRDb25maWd1cmF0aW9uLCBjaGFpbklkIH0gPSBjaGFpbjtcclxuICAgICAgICAgICAgaWYgKCFyZnF0Q29uZmlndXJhdGlvbikge1xyXG4gICAgICAgICAgICAgICAgdGhyb3cgbmV3IEVycm9yKGBSRlF0IFNlcnZpY2UgZm9yIGNoYWluICR7Y2hhaW5JZH0gZG9lcyBub3QgZXhpc3RgKTtcclxuICAgICAgICAgICAgfVxyXG5cclxuICAgICAgICAgICAgY29uc3QgcmZxTWFrZXJNYW5hZ2VyID0gbmV3IFJmcU1ha2VyTWFuYWdlcihjb25maWdNYW5hZ2VyLCByZnFNYWtlckRiVXRpbHMsIGNoYWluSWQpO1xyXG4gICAgICAgICAgICBhd2FpdCByZnFNYWtlck1hbmFnZXIuaW5pdGlhbGl6ZUFzeW5jKCk7XHJcbiAgICAgICAgICAgIGNvbnN0IHF1b3RlUmVxdWVzdG9yID0gbmV3IFJlZnJlc2hpbmdRdW90ZVJlcXVlc3RvcihyZnFNYWtlck1hbmFnZXIsIGF4aW9zSW5zdGFuY2UsIGFsdFJmcU9wdGlvbnMpO1xyXG4gICAgICAgICAgICBjb25zdCBxdW90ZVNlcnZlckNsaWVudCA9IG5ldyBRdW90ZVNlcnZlckNsaWVudChheGlvc0luc3RhbmNlKTtcclxuICAgICAgICAgICAgY29uc3QgY29udHJhY3RBZGRyZXNzZXMgPSBnZXRDb250cmFjdEFkZHJlc3Nlc0ZvckNoYWluT3JUaHJvdyhjaGFpbklkKTtcclxuICAgICAgICAgICAgY29uc3QgZXRoZXJzUHJvdmlkZXIgPSBuZXcgcHJvdmlkZXJzLkpzb25ScGNQcm92aWRlcihjaGFpbi5ycGNVcmwsIGNoYWluSWQpO1xyXG4gICAgICAgICAgICBjb25zdCBwcm92aWRlcjogU3VwcG9ydGVkUHJvdmlkZXIgPSBwcm92aWRlclV0aWxzLmNyZWF0ZVdlYjNQcm92aWRlcihjaGFpbi5ycGNVcmwpO1xyXG5cclxuICAgICAgICAgICAgY29uc3QgYmFsYW5jZUNoZWNrZXIgPSBuZXcgQmFsYW5jZUNoZWNrZXIocHJvdmlkZXIpO1xyXG4gICAgICAgICAgICBjb25zdCByZnFCbG9ja2NoYWluVXRpbHMgPSBuZXcgUmZxQmxvY2tjaGFpblV0aWxzKFxyXG4gICAgICAgICAgICAgICAgcHJvdmlkZXIsXHJcbiAgICAgICAgICAgICAgICBjb250cmFjdEFkZHJlc3Nlcy5leGNoYW5nZVByb3h5LFxyXG4gICAgICAgICAgICAgICAgYmFsYW5jZUNoZWNrZXIsXHJcbiAgICAgICAgICAgICAgICBldGhlcnNQcm92aWRlcixcclxuICAgICAgICAgICAgKTtcclxuICAgICAgICAgICAgY29uc3QgdG9rZW5NZXRhZGF0YU1hbmFnZXIgPSBuZXcgVG9rZW5NZXRhZGF0YU1hbmFnZXIoY2hhaW5JZCwgcmZxQmxvY2tjaGFpblV0aWxzKTtcclxuXHJcbiAgICAgICAgICAgIGNvbnN0IGJhbGFuY2VDaGVja1V0aWxzID0gbmV3IFJmcUJhbGFuY2VDaGVja1V0aWxzKGJhbGFuY2VDaGVja2VyLCBjb250cmFjdEFkZHJlc3Nlcy5leGNoYW5nZVByb3h5KTtcclxuICAgICAgICAgICAgY29uc3QgY2FjaGVDbGllbnQgPSBuZXcgQ2FjaGVDbGllbnQocmVkaXMpO1xyXG4gICAgICAgICAgICBjb25zdCByZnFNYWtlckJhbGFuY2VDYWNoZVNlcnZpY2UgPSBuZXcgUmZxTWFrZXJCYWxhbmNlQ2FjaGVTZXJ2aWNlKGNhY2hlQ2xpZW50LCBiYWxhbmNlQ2hlY2tVdGlscyk7XHJcblxyXG4gICAgICAgICAgICBjb25zdCBrYWZrYVByb2R1Y2VyID0gZ2V0S2Fma2FQcm9kdWNlcigpO1xyXG5cclxuICAgICAgICAgICAgY29uc3QgZmVlVG9rZW5NZXRhZGF0YSA9IGdldFRva2VuTWV0YWRhdGFJZkV4aXN0cyhjb250cmFjdEFkZHJlc3Nlcy5ldGhlclRva2VuLCBjaGFpbklkKTtcclxuICAgICAgICAgICAgaWYgKGZlZVRva2VuTWV0YWRhdGEgPT09IHVuZGVmaW5lZCkge1xyXG4gICAgICAgICAgICAgICAgdGhyb3cgbmV3IEVycm9yKGBGZWUgdG9rZW4gJHtjb250cmFjdEFkZHJlc3Nlcy5ldGhlclRva2VufSBvbiBjaGFpbiAke2NoYWluSWR9IGNvdWxkIG5vdCBiZSBmb3VuZCFgKTtcclxuICAgICAgICAgICAgfVxyXG5cclxuICAgICAgICAgICAgY29uc3QgcHJvdG9jb2xGZWVVdGlscyA9IFByb3RvY29sRmVlVXRpbHMuZ2V0SW5zdGFuY2UoXHJcbiAgICAgICAgICAgICAgICBQUk9UT0NPTF9GRUVfVVRJTFNfUE9MTElOR19JTlRFUlZBTF9JTl9NUyxcclxuICAgICAgICAgICAgICAgIGNoYWluLmdhc1N0YXRpb25VcmwsXHJcbiAgICAgICAgICAgICk7XHJcbiAgICAgICAgICAgIGNvbnN0IGdhc1N0YXRpb25BdHRlbmRhbnQgPSBnZXRHYXNTdGF0aW9uQXR0ZW5kYW50KGNoYWluLCBheGlvc0luc3RhbmNlLCBwcm90b2NvbEZlZVV0aWxzKTtcclxuICAgICAgICAgICAgY29uc3QgdG9rZW5QcmljZU9yYWNsZSA9IG5ldyBUb2tlblByaWNlT3JhY2xlKGF4aW9zSW5zdGFuY2UsIERFRklORURfRklfQVBJX0tFWSwgREVGSU5FRF9GSV9FTkRQT0lOVCk7XHJcbiAgICAgICAgICAgIGNvbnN0IHplcm9FeEFwaUNsaWVudCA9IG5ldyBaZXJvRXhBcGlDbGllbnQoQXhpb3MuY3JlYXRlKCksIFpFUk9fRVhfQVBJX0tFWSwgY2hhaW4pO1xyXG4gICAgICAgICAgICBjb25zdCBmZWVTZXJ2aWNlID0gbmV3IEZlZVNlcnZpY2UoXHJcbiAgICAgICAgICAgICAgICBjaGFpbklkLFxyXG4gICAgICAgICAgICAgICAgZmVlVG9rZW5NZXRhZGF0YSxcclxuICAgICAgICAgICAgICAgIGNvbmZpZ01hbmFnZXIsXHJcbiAgICAgICAgICAgICAgICBnYXNTdGF0aW9uQXR0ZW5kYW50LFxyXG4gICAgICAgICAgICAgICAgdG9rZW5QcmljZU9yYWNsZSxcclxuICAgICAgICAgICAgICAgIHplcm9FeEFwaUNsaWVudCxcclxuICAgICAgICAgICAgICAgIHJmcXRDb25maWd1cmF0aW9uLm1pbkV4cGlyeUR1cmF0aW9uTXMgfHwgREVGQVVMVF9NSU5fRVhQSVJZX0RVUkFUSU9OX01TLFxyXG4gICAgICAgICAgICApO1xyXG5cclxuICAgICAgICAgICAgcmV0dXJuIG5ldyBSZnF0U2VydmljZShcclxuICAgICAgICAgICAgICAgIGNoYWluSWQsXHJcbiAgICAgICAgICAgICAgICByZnFNYWtlck1hbmFnZXIsXHJcbiAgICAgICAgICAgICAgICBxdW90ZVJlcXVlc3RvcixcclxuICAgICAgICAgICAgICAgIHF1b3RlU2VydmVyQ2xpZW50LFxyXG4gICAgICAgICAgICAgICAgcmZxdENvbmZpZ3VyYXRpb24ubWluRXhwaXJ5RHVyYXRpb25NcyB8fCBERUZBVUxUX01JTl9FWFBJUllfRFVSQVRJT05fTVMsXHJcbiAgICAgICAgICAgICAgICByZnFCbG9ja2NoYWluVXRpbHMsXHJcbiAgICAgICAgICAgICAgICB0b2tlbk1ldGFkYXRhTWFuYWdlcixcclxuICAgICAgICAgICAgICAgIGNvbnRyYWN0QWRkcmVzc2VzLFxyXG4gICAgICAgICAgICAgICAgZmVlU2VydmljZSxcclxuICAgICAgICAgICAgICAgIHJmcXRDb25maWd1cmF0aW9uLmZlZU1vZGVsVmVyc2lvbiB8fCAwLFxyXG4gICAgICAgICAgICAgICAgcmZxTWFrZXJCYWxhbmNlQ2FjaGVTZXJ2aWNlLFxyXG4gICAgICAgICAgICAgICAga2Fma2FQcm9kdWNlcixcclxuICAgICAgICAgICAgICAgIHJmcXRDb25maWd1cmF0aW9uLmZlZUV2ZW50VG9waWMsXHJcbiAgICAgICAgICAgICk7XHJcbiAgICAgICAgfSksXHJcbiAgICApO1xyXG4gICAgcmV0dXJuIG5ldyBNYXAoc2VydmljZXMubWFwKChzLCBpKSA9PiBbY2hhaW5Db25maWd1cmF0aW9uc1tpXS5jaGFpbklkLCBzXSkpO1xyXG59XHJcblxyXG4vKipcclxuICogQ3JlYXRlcyB0aGUgQXhpb3MgUmVxdWVzdCBDb25maWdcclxuICovXHJcbmZ1bmN0aW9uIGdldEF4aW9zUmVxdWVzdENvbmZpZygpOiBBeGlvc1JlcXVlc3RDb25maWcge1xyXG4gICAgY29uc3QgYXhpb3NSZXF1ZXN0Q29uZmlnOiBBeGlvc1JlcXVlc3RDb25maWcgPSB7XHJcbiAgICAgICAgaHR0cEFnZW50OiBuZXcgSHR0cEFnZW50KHsga2VlcEFsaXZlOiB0cnVlLCB0aW1lb3V0OiBLRUVQX0FMSVZFX1RUTCB9KSxcclxuICAgICAgICBodHRwc0FnZW50OiBuZXcgSHR0cHNBZ2VudCh7IGtlZXBBbGl2ZTogdHJ1ZSwgdGltZW91dDogS0VFUF9BTElWRV9UVEwgfSksXHJcbiAgICAgICAgdGltZW91dDogREVGQVVMVF9BWElPU19USU1FT1VULFxyXG4gICAgfTtcclxuICAgIGlmIChSRlFfUFJPWFlfQUREUkVTUyAhPT0gdW5kZWZpbmVkICYmIFJGUV9QUk9YWV9QT1JUICE9PSB1bmRlZmluZWQpIHtcclxuICAgICAgICBheGlvc1JlcXVlc3RDb25maWcucHJveHkgPSB7XHJcbiAgICAgICAgICAgIGhvc3Q6IFJGUV9QUk9YWV9BRERSRVNTLFxyXG4gICAgICAgICAgICBwb3J0OiBSRlFfUFJPWFlfUE9SVCxcclxuICAgICAgICB9O1xyXG4gICAgfVxyXG5cclxuICAgIHJldHVybiBheGlvc1JlcXVlc3RDb25maWc7XHJcbn1cclxuXHJcbi8qKlxyXG4gKiBJbml0aWFsaXplIGEga2Fma2EgcHJvZHVjZXIgaWYgS0FGS0FfQlJPS0VSUyBpcyBzZXRcclxuICovXHJcbmZ1bmN0aW9uIGdldEthZmthUHJvZHVjZXIoKTogS2Fma2FQcm9kdWNlciB8IHVuZGVmaW5lZCB7XHJcbiAgICBsZXQga2Fma2FQcm9kdWNlcjogS2Fma2FQcm9kdWNlciB8IHVuZGVmaW5lZDtcclxuICAgIGlmIChLQUZLQV9CUk9LRVJTICE9PSB1bmRlZmluZWQpIHtcclxuICAgICAgICBjb25zdCBrYWZrYSA9IG5ldyBLYWZrYSh7XHJcbiAgICAgICAgICAgIGNsaWVudElkOiAnMHgtYXBpJyxcclxuICAgICAgICAgICAgYnJva2VyczogS0FGS0FfQlJPS0VSUyxcclxuICAgICAgICB9KTtcclxuXHJcbiAgICAgICAga2Fma2FQcm9kdWNlciA9IGthZmthLnByb2R1Y2VyKCk7XHJcbiAgICAgICAgLy8gdHNsaW50OmRpc2FibGUtbmV4dC1saW5lOiBuby1mbG9hdGluZy1wcm9taXNlc1xyXG4gICAgICAgIGthZmthUHJvZHVjZXIuY29ubmVjdCgpO1xyXG4gICAgfVxyXG4gICAgcmV0dXJuIGthZmthUHJvZHVjZXI7XHJcbn1cclxuIl0sInZlcnNpb24iOjN9