{"file":"/Users/davidwalsh/code-local/0x-rfq-api/src/utils/quote_server_client.ts","mappings":"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","names":[],"sources":["/Users/davidwalsh/code-local/0x-rfq-api/src/utils/quote_server_client.ts"],"sourcesContent":["import { MarketOperation } from '@0x/asset-swapper/lib/src/types';\r\nimport { SchemaValidator } from '@0x/json-schemas';\r\nimport { Signature } from '@0x/protocol-utils';\r\nimport { schemas as quoteServerSchemas } from '../quote-server/schemas';\r\nimport { SignRequest } from '../quote-server/types';\r\nimport { BigNumber } from '@0x/utils';\r\nimport { AxiosInstance } from 'axios';\r\nimport { OK } from 'http-status-codes';\r\n// $eslint-fix-me https://github.com/rhinodavid/eslint-fix-me\r\nimport { Summary } from 'prom-client';\r\nimport * as uuid from 'uuid';\r\n\r\nimport {\r\n    Integrator,\r\n    RFQ_PRICE_ENDPOINT_TIMEOUT_MS,\r\n    RFQ_SIGN_ENDPOINT_TIMEOUT_MS,\r\n    TAKER_SPECIFIED_SIDE_ENABLED,\r\n} from '../config';\r\nimport { ZERO } from '../core/constants';\r\nimport { logger } from '../logger';\r\nimport { schemas } from '../core/schemas';\r\nimport { Fee, IndicativeQuote, QuoteServerPriceParams } from '../core/types';\r\n\r\nconst MARKET_MAKER_SIGN_LATENCY = new Summary({\r\n    name: 'market_maker_sign_latency',\r\n    help: 'Latency for sign request to Market Makers',\r\n    labelNames: ['makerUri', 'statusCode'],\r\n});\r\n\r\nconst RFQ_MARKET_MAKER_PRICE_REQUEST_DURATION_SECONDS = new Summary({\r\n    name: 'rfq_market_maker_price_request_duration_seconds',\r\n    help: 'Provides stats around market maker network interactions',\r\n    percentiles: [0.5, 0.9, 0.95, 0.99, 0.999], // tslint:disable-line: custom-no-magic-numbers\r\n    labelNames: ['type', 'integratorLabel', 'makerUri', 'chainId', 'statusCode', 'market'],\r\n    maxAgeSeconds: 60,\r\n    ageBuckets: 5,\r\n});\r\n\r\nconst KNOWN_TOKENS: { [key: string]: string } = {\r\n    // Mainnet\r\n    '0x6b175474e89094c44da98b954eedeac495271d0f': 'DAI',\r\n    '0xdac17f958d2ee523a2206206994597c13d831ec7': 'USDT',\r\n    '0xa0b86991c6218b36c1d19d4a2e9eb0ce3606eb48': 'USDC',\r\n    '0xc02aaa39b223fe8d0a0e5c4f27ead9083c756cc2': 'WETH',\r\n    // Polygon\r\n    '0x8f3cf7ad23cd3cadbd9735aff958023239c6a063': 'DAI',\r\n    '0xc2132d05d31c914a87c6611c10748aeb04b58e8f': 'USDT',\r\n    '0x2791bca1f2de4661ed88a30c99a7a9449aa84174': 'USDC',\r\n    '0x7ceb23fd6bc0add59e62ac25578270cff1b9f619': 'WETH',\r\n    '0x0d500b1d8e8ef31e21c99d1db9a6444d3adf1270': 'WMATIC',\r\n};\r\n\r\n/**\r\n * [Read this in Daniel's voice] Returns a human-readable label for Prometheus counters.\r\n * Only popular most relevant pairs should be displayed in Prometheus (since it overload the service)\r\n * and any other market that does not contain popular pairs will simply return \"Other\".\r\n *\r\n * @param tokenSold the token being sold\r\n * @param tokenPurchased the token being purchased\r\n * @returns a market like \"WETH-DAI\", or \"Other\" is a pair is unknown\r\n */\r\nfunction getMarketLabel(tokenSold: string, tokenPurchased: string): string {\r\n    const items = [tokenSold.toLowerCase(), tokenPurchased.toLowerCase()];\r\n    items.sort();\r\n\r\n    const tokenA: string | undefined = KNOWN_TOKENS[items[0]];\r\n    const tokenB: string | undefined = KNOWN_TOKENS[items[1]];\r\n    if (!tokenA || !tokenB) {\r\n        return 'Other';\r\n    }\r\n    return `${tokenA}-${tokenB}`;\r\n}\r\n\r\nconst schemaValidator = new SchemaValidator();\r\nschemaValidator.addSchema(quoteServerSchemas.feeSchema);\r\nschemaValidator.addSchema(quoteServerSchemas.submitRequestSchema);\r\nschemaValidator.addSchema(quoteServerSchemas.submitReceiptSchema);\r\nschemaValidator.addSchema(quoteServerSchemas.otcQuoteResponseSchema);\r\n\r\nexport class QuoteServerClient {\r\n    /**\r\n     * Prepares the query parameters (copied from QuoteRequestor)\r\n     */\r\n    public static makeQueryParameters(input: {\r\n        chainId?: number;\r\n        txOrigin: string;\r\n        takerAddress: string;\r\n        marketOperation: MarketOperation;\r\n        buyTokenAddress: string; // maker token\r\n        sellTokenAddress: string; // taker token\r\n        assetFillAmount: BigNumber;\r\n        comparisonPrice?: BigNumber;\r\n        isLastLook?: boolean | undefined;\r\n        fee?: Fee | undefined;\r\n    }): QuoteServerPriceParams {\r\n        const {\r\n            chainId,\r\n            txOrigin,\r\n            takerAddress,\r\n            marketOperation,\r\n            buyTokenAddress,\r\n            sellTokenAddress,\r\n            assetFillAmount,\r\n            comparisonPrice,\r\n            isLastLook,\r\n            fee,\r\n        } = input;\r\n        const { buyAmountBaseUnits, sellAmountBaseUnits } =\r\n            marketOperation === MarketOperation.Buy\r\n                ? {\r\n                      buyAmountBaseUnits: assetFillAmount,\r\n                      sellAmountBaseUnits: undefined,\r\n                  }\r\n                : {\r\n                      sellAmountBaseUnits: assetFillAmount,\r\n                      buyAmountBaseUnits: undefined,\r\n                  };\r\n\r\n        const requestParamsWithBigNumbers: Pick<\r\n            QuoteServerPriceParams,\r\n            | 'chainId'\r\n            | 'txOrigin'\r\n            | 'takerAddress'\r\n            | 'buyTokenAddress'\r\n            | 'sellTokenAddress'\r\n            | 'comparisonPrice'\r\n            | 'isLastLook'\r\n            | 'protocolVersion'\r\n            | 'feeAmount'\r\n            | 'feeToken'\r\n            | 'feeType'\r\n        > = {\r\n            txOrigin,\r\n            takerAddress,\r\n            buyTokenAddress,\r\n            sellTokenAddress,\r\n            protocolVersion: '4',\r\n        };\r\n\r\n        if (comparisonPrice) {\r\n            requestParamsWithBigNumbers.comparisonPrice = comparisonPrice.toString();\r\n        }\r\n\r\n        if (isLastLook) {\r\n            if (fee === undefined) {\r\n                throw new Error(`isLastLook cannot be passed without a fee parameter`);\r\n            }\r\n            requestParamsWithBigNumbers.isLastLook = isLastLook.toString();\r\n        }\r\n\r\n        if (fee) {\r\n            requestParamsWithBigNumbers.feeAmount = fee.amount.toString();\r\n            requestParamsWithBigNumbers.feeToken = fee.token;\r\n            requestParamsWithBigNumbers.feeType = fee.type;\r\n        }\r\n\r\n        if (chainId) {\r\n            requestParamsWithBigNumbers.chainId = String(chainId);\r\n        }\r\n\r\n        // convert BigNumbers to strings so they are digestible by axios\r\n        if (sellAmountBaseUnits) {\r\n            return {\r\n                ...requestParamsWithBigNumbers,\r\n                sellAmountBaseUnits: sellAmountBaseUnits.toString(),\r\n            };\r\n        } else if (buyAmountBaseUnits) {\r\n            return {\r\n                ...requestParamsWithBigNumbers,\r\n                buyAmountBaseUnits: buyAmountBaseUnits.toString(),\r\n            };\r\n        } else {\r\n            throw new Error('Neither \"buyAmountBaseUnits\" or \"sellAmountBaseUnits\" were defined');\r\n        }\r\n    }\r\n\r\n    constructor(private readonly _axiosInstance: AxiosInstance) {}\r\n\r\n    /**\r\n     * Fetch a price (indicative quote)\r\n     *\r\n     * @param makerUri - the maker URI\r\n     * @param integrator - the integrator\r\n     * @param parameters - the query parameters (created via {@link QuoteServerClient.makeQueryParameters} )\r\n     * @param makerUriToUrl - function to transform the maker URI into its `price` endpoint\r\n     * @returns - a Promise containing the indicative quote if available, else undefined\r\n     * @throws - Will throw an error if a 4xx or 5xx is returned\r\n     */\r\n    public async getPriceV2Async(\r\n        makerUri: string,\r\n        integrator: Integrator,\r\n        parameters: QuoteServerPriceParams,\r\n        makerUriToUrl: (u: string) => string,\r\n    ): Promise<IndicativeQuote | undefined> {\r\n        const timerStopFn = RFQ_MARKET_MAKER_PRICE_REQUEST_DURATION_SECONDS.startTimer();\r\n        const headers = {\r\n            '0x-request-uuid': uuid.v4(),\r\n            '0x-integrator-id': integrator.integratorId,\r\n            '0x-api-key': integrator.integratorId,\r\n        };\r\n        logger.info({ headers, parameters, integratorId: integrator.integratorId, makerUri }, 'v2/price request to MM');\r\n        const response = await this._axiosInstance.get(makerUriToUrl(makerUri), {\r\n            timeout: RFQ_PRICE_ENDPOINT_TIMEOUT_MS,\r\n            validateStatus: (status: number) => {\r\n                // tslint:disable-next-line: custom-no-magic-numbers\r\n                if (status >= 300) {\r\n                    logger.warn({ status, makerUri }, 'Received non-OK status requesting price from market maker');\r\n                }\r\n                // Don't throw errors on 4xx or 5xx\r\n                return true;\r\n            },\r\n            headers,\r\n            params: parameters,\r\n        });\r\n        logger.info({ makerUri, body: response.data, status: response.status }, 'v2/price response from MM');\r\n\r\n        timerStopFn({\r\n            type: makerUriToUrl(''), // HACK - used to distinguish between RFQm and RFQt\r\n            integratorLabel: integrator.label,\r\n            makerUri,\r\n            chainId: parameters.chainId,\r\n            statusCode: response.status,\r\n            market: getMarketLabel(parameters.sellTokenAddress, parameters.buyTokenAddress),\r\n        });\r\n\r\n        // Empty response from MM (not 200, no data, or empty object)\r\n        if (response.status !== OK || !response.data || Object.keys(response.data).length === 0) {\r\n            return;\r\n        }\r\n\r\n        const validationResult = schemaValidator.validate(response.data, schemas.indicativeOtcQuoteResponseSchema);\r\n        if (validationResult.errors && validationResult.errors.length > 0) {\r\n            const errorsMsg = validationResult.errors.map((err) => err.message).join(',');\r\n            logger.error({ response: response.data, makerUri, status: response.status }, 'Malformed price response');\r\n            throw new Error(`Error from validator: ${errorsMsg}`);\r\n        }\r\n\r\n        return {\r\n            expiry: new BigNumber(response.data.expiry),\r\n            maker: response.data.maker,\r\n            makerAmount: new BigNumber(response.data.makerAmount),\r\n            makerToken: response.data.makerToken,\r\n            makerUri,\r\n            takerAmount: new BigNumber(response.data.takerAmount),\r\n            takerToken: response.data.takerToken,\r\n        };\r\n    }\r\n\r\n    /**\r\n     * Fetch a batch of prices. Ignores all quotes that return errors\r\n     *\r\n     * @param makerUris - a list of maker URIs\r\n     * @param integrator - the integrator\r\n     * @param parameters - the query parameters (created via {@link QuoteServerClient.makeQueryParameters} )\r\n     * @param makerUriToUrl - function to transform the maker URI into its `price` endpoint\r\n     * @returns - a Promise containing a list of indicative quotes\r\n     */\r\n    public async batchGetPriceV2Async(\r\n        makerUris: string[],\r\n        integrator: Integrator,\r\n        parameters: QuoteServerPriceParams,\r\n        makerUriToUrl: (u: string) => string = (u: string) => `${u}/rfqm/v2/price`,\r\n    ): Promise<IndicativeQuote[]> {\r\n        return Promise.all(\r\n            makerUris.map(async (makerUri) => {\r\n                return this.getPriceV2Async(makerUri, integrator, parameters, makerUriToUrl).catch((err) => {\r\n                    logger.error(\r\n                        {\r\n                            errorMessage: err?.message,\r\n                            makerUri,\r\n                            status: err?.response?.status ?? 'unknown',\r\n                        },\r\n                        'Encountered an error requesting an indicative quote',\r\n                    );\r\n                    return undefined;\r\n                });\r\n            }),\r\n        ).then((arr) => arr.filter((result): result is IndicativeQuote => result !== undefined));\r\n    }\r\n\r\n    /**\r\n     * Request a signature from a MM for a given OtcOrder\r\n     *\r\n     * @param makerUri - the MM's uri\r\n     * @param integratorId - the integrator id\r\n     * @param payload - the payload of the request. RFQm transactions require\r\n     *   `takerSignature` to be present, while `takerSignature` will not be\r\n     *   present for RFQt transactions.\r\n     * @param requireProceedWithFill - whether or not to require the response\r\n     *  to include a `proceedWithFill` field. This field is specific to RFQm\r\n     *  and isn't required for an RFQt sign request.\r\n     * @param makerUriToUrl - function to transform the maker URI into its `sign` endpoint\r\n     * @returns - The signature if successful, undefined otherwise\r\n     * @throws - Will throw an error if a 4xx or 5xx is returned\r\n     */\r\n    public async signV2Async(\r\n        makerUri: string,\r\n        integratorId: string,\r\n        payload: Omit<SignRequest, 'takerSignature'> & Pick<Partial<SignRequest>, 'takerSignature'>,\r\n        makerUriToUrl: (u: string) => string = (u: string) => `${u}/rfqm/v2/sign`,\r\n        // $eslint-fix-me https://github.com/rhinodavid/eslint-fix-me\r\n        // eslint-disable-next-line @typescript-eslint/no-inferrable-types\r\n        requireProceedWithFill: boolean = true,\r\n    ): Promise<Signature | undefined> {\r\n        const timerStopFn = MARKET_MAKER_SIGN_LATENCY.startTimer();\r\n        const requestUuid = uuid.v4();\r\n        const headers = {\r\n            '0x-api-key': integratorId,\r\n            '0x-integrator-id': integratorId,\r\n            '0x-request-uuid': requestUuid,\r\n            'Content-Type': 'application/json',\r\n        };\r\n        logger.info({ headers, payload, integratorId, makerUri }, 'v2/sign request to MM');\r\n        const rawResponse = await this._axiosInstance.post(\r\n            makerUriToUrl(makerUri),\r\n            {\r\n                order: payload.order,\r\n                orderHash: payload.orderHash,\r\n                expiry: payload.expiry,\r\n                takerSignature: payload.takerSignature,\r\n                feeToken: payload.fee.token,\r\n                feeAmount: payload.fee.amount,\r\n                ...(TAKER_SPECIFIED_SIDE_ENABLED &&\r\n                    payload.takerSpecifiedSide && { takerSpecifiedSide: payload.takerSpecifiedSide }),\r\n            },\r\n            {\r\n                timeout: RFQ_SIGN_ENDPOINT_TIMEOUT_MS,\r\n                headers: {\r\n                    '0x-api-key': integratorId,\r\n                    '0x-integrator-id': integratorId,\r\n                    '0x-request-uuid': requestUuid,\r\n                    'Content-Type': 'application/json',\r\n                },\r\n                validateStatus: () => true, // Don't throw errors on 4xx or 5xx\r\n            },\r\n        );\r\n        logger.info(\r\n            {\r\n                makerUri,\r\n                requestUuid,\r\n                status: rawResponse.status,\r\n                body: rawResponse.data,\r\n            },\r\n            'v2/sign response from MM',\r\n        );\r\n        timerStopFn({\r\n            makerUri,\r\n            statusCode: rawResponse.status,\r\n        });\r\n\r\n        // TODO (rhinodavid): Filter out non-successful statuses from validation step\r\n\r\n        const validationResult = schemaValidator.validate(rawResponse.data, schemas.signResponseSchema);\r\n        if (validationResult.errors && validationResult.errors.length > 0) {\r\n            const errorsMsg = validationResult.errors.map((err) => err.message).join(',');\r\n            logger.error(\r\n                { response: rawResponse.data, makerUri, status: rawResponse.status },\r\n                'Malformed sign response',\r\n            );\r\n            throw new Error(`Error from validator: ${errorsMsg}`);\r\n        }\r\n\r\n        const proceedWithFill = rawResponse.data?.proceedWithFill as boolean | undefined;\r\n        const makerSignature: Signature | undefined = rawResponse.data?.makerSignature;\r\n        const feeAmount = new BigNumber(rawResponse.data?.feeAmount);\r\n\r\n        if (!proceedWithFill && requireProceedWithFill) {\r\n            logger.info({ makerUri }, 'Sign request rejected');\r\n            return undefined;\r\n        }\r\n\r\n        if (!payload.fee.amount.eq(ZERO) && !feeAmount.gte(payload.fee.amount)) {\r\n            logger.warn(\r\n                { requestFeeAmount: payload.fee.amount, responseFeeAmount: feeAmount, makerUri },\r\n                'Invalid fee acknowledgement',\r\n            );\r\n            return undefined;\r\n        }\r\n\r\n        if (makerSignature === undefined) {\r\n            logger.warn({ makerUri }, 'Signature is missing');\r\n            return undefined;\r\n        }\r\n\r\n        return makerSignature;\r\n    }\r\n}\r\n"],"version":3}