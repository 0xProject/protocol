d08729008bf82939529e0233bb5a3a9b
"use strict";
Object.defineProperty(exports, "__esModule", { value: true });
// tslint:disable:custom-no-magic-numbers
const protocol_utils_1 = require("@0x/protocol-utils");
const utils_1 = require("@0x/utils");
const chai_1 = require("chai");
const ts_mockito_1 = require("ts-mockito");
const constants_1 = require("../../src/core/constants");
const entities_1 = require("../../src/entities");
const types_1 = require("../../src/entities/types");
const rfq_admin_service_1 = require("../../src/services/rfq_admin_service");
const rfqm_db_utils_1 = require("../../src/utils/rfqm_db_utils");
describe('RFQ Admin Service Logic', () => {
    describe('cleanupJobsAsync', () => {
        const expiry = new utils_1.BigNumber(Date.now() - 1000000).dividedBy(constants_1.ONE_SECOND_MS).decimalPlaces(0);
        const otcOrder = new protocol_utils_1.OtcOrder({
            txOrigin: '0x0000000000000000000000000000000000000000',
            taker: '0x1111111111111111111111111111111111111111',
            maker: '0x2222222222222222222222222222222222222222',
            makerToken: '0x3333333333333333333333333333333333333333',
            takerToken: '0x4444444444444444444444444444444444444444',
            expiryAndNonce: protocol_utils_1.OtcOrder.encodeExpiryAndNonce(expiry, constants_1.ZERO, expiry),
            chainId: 1337,
            verifyingContract: '0x0000000000000000000000000000000000000000',
        });
        const BASE_JOB = new entities_1.RfqmV2JobEntity({
            chainId: 1337,
            expiry,
            makerUri: '',
            orderHash: '0x00',
            fee: {
                token: '0xToken',
                amount: '100',
                type: 'fixed',
            },
            order: (0, rfqm_db_utils_1.otcOrderToStoredOtcOrder)(otcOrder),
        });
        it('should clean up stuck jobs', async () => {
            const job = new entities_1.RfqmV2JobEntity({ ...BASE_JOB, status: types_1.RfqmJobStatus.PendingProcessing });
            const dbUtilsMock = (0, ts_mockito_1.mock)(rfqm_db_utils_1.RfqmDbUtils);
            (0, ts_mockito_1.when)(dbUtilsMock.findV2JobByOrderHashAsync((0, ts_mockito_1.anything)())).thenResolve(job);
            (0, ts_mockito_1.when)(dbUtilsMock.findV2TransactionSubmissionsByOrderHashAsync((0, ts_mockito_1.anything)())).thenResolve([]);
            const adminService = new rfq_admin_service_1.RfqAdminService((0, ts_mockito_1.instance)(dbUtilsMock));
            const res = await adminService.cleanupJobsAsync(['0x00']);
            (0, chai_1.expect)(res.modifiedJobs[0]).to.equal(BASE_JOB.orderHash);
            (0, ts_mockito_1.verify)(dbUtilsMock.updateRfqmJobAsync((0, ts_mockito_1.deepEqual)(new entities_1.RfqmV2JobEntity({ ...BASE_JOB, status: types_1.RfqmJobStatus.FailedExpired })))).called();
        });
        it('should not modify unexpired jobs', async () => {
            const job = new entities_1.RfqmV2JobEntity({
                ...BASE_JOB,
                status: types_1.RfqmJobStatus.PendingProcessing,
                expiry: new utils_1.BigNumber(Date.now() + 60000).dividedBy(constants_1.ONE_SECOND_MS).decimalPlaces(0),
            });
            const dbUtilsMock = (0, ts_mockito_1.mock)(rfqm_db_utils_1.RfqmDbUtils);
            (0, ts_mockito_1.when)(dbUtilsMock.findV2JobByOrderHashAsync((0, ts_mockito_1.anything)())).thenResolve(job);
            (0, ts_mockito_1.when)(dbUtilsMock.findV2TransactionSubmissionsByOrderHashAsync((0, ts_mockito_1.anything)())).thenResolve([]);
            const adminService = new rfq_admin_service_1.RfqAdminService((0, ts_mockito_1.instance)(dbUtilsMock));
            const res = await adminService.cleanupJobsAsync(['0x00']);
            (0, chai_1.expect)(res.unmodifiedJobs[0]).to.equal(BASE_JOB.orderHash);
            (0, ts_mockito_1.verify)(dbUtilsMock.updateRfqmJobAsync((0, ts_mockito_1.anything)())).never();
        });
        it('should not modify resolved jobs', async () => {
            const job = new entities_1.RfqmV2JobEntity({ ...BASE_JOB, status: types_1.RfqmJobStatus.FailedExpired });
            const dbUtilsMock = (0, ts_mockito_1.mock)(rfqm_db_utils_1.RfqmDbUtils);
            (0, ts_mockito_1.when)(dbUtilsMock.findV2JobByOrderHashAsync((0, ts_mockito_1.anything)())).thenResolve(job);
            (0, ts_mockito_1.when)(dbUtilsMock.findV2TransactionSubmissionsByOrderHashAsync((0, ts_mockito_1.anything)())).thenResolve([]);
            const adminService = new rfq_admin_service_1.RfqAdminService((0, ts_mockito_1.instance)(dbUtilsMock));
            const res = await adminService.cleanupJobsAsync(['0x00']);
            (0, chai_1.expect)(res.unmodifiedJobs[0]).to.equal(BASE_JOB.orderHash);
            (0, ts_mockito_1.verify)(dbUtilsMock.updateRfqmJobAsync((0, ts_mockito_1.anything)())).never();
        });
    });
});
//# sourceMappingURL=data:application/json;charset=utf-8;base64,eyJmaWxlIjoiL1VzZXJzL2Rhdmlkd2Fsc2gvY29kZS1sb2NhbC8weC1yZnEtYXBpL3Rlc3Qvc2VydmljZXMvcmZxX2FkbWluX3NlcnZpY2VfdGVzdC50cyIsIm1hcHBpbmdzIjoiOztBQUFBLHlDQUF5QztBQUV6Qyx1REFBOEM7QUFDOUMscUNBQXNDO0FBQ3RDLCtCQUE4QjtBQUM5QiwyQ0FBK0U7QUFFL0Usd0RBQStEO0FBQy9ELGlEQUFxRDtBQUNyRCxvREFBeUQ7QUFDekQsNEVBQXVFO0FBQ3ZFLGlFQUFzRjtBQUV0RixRQUFRLENBQUMseUJBQXlCLEVBQUUsR0FBRyxFQUFFO0lBQ3JDLFFBQVEsQ0FBQyxrQkFBa0IsRUFBRSxHQUFHLEVBQUU7UUFDOUIsTUFBTSxNQUFNLEdBQUcsSUFBSSxpQkFBUyxDQUFDLElBQUksQ0FBQyxHQUFHLEVBQUUsR0FBRyxPQUFTLENBQUMsQ0FBQyxTQUFTLENBQUMseUJBQWEsQ0FBQyxDQUFDLGFBQWEsQ0FBQyxDQUFDLENBQUMsQ0FBQztRQUMvRixNQUFNLFFBQVEsR0FBRyxJQUFJLHlCQUFRLENBQUM7WUFDMUIsUUFBUSxFQUFFLDRDQUE0QztZQUN0RCxLQUFLLEVBQUUsNENBQTRDO1lBQ25ELEtBQUssRUFBRSw0Q0FBNEM7WUFDbkQsVUFBVSxFQUFFLDRDQUE0QztZQUN4RCxVQUFVLEVBQUUsNENBQTRDO1lBQ3hELGNBQWMsRUFBRSx5QkFBUSxDQUFDLG9CQUFvQixDQUFDLE1BQU0sRUFBRSxnQkFBSSxFQUFFLE1BQU0sQ0FBQztZQUNuRSxPQUFPLEVBQUUsSUFBSTtZQUNiLGlCQUFpQixFQUFFLDRDQUE0QztTQUNsRSxDQUFDLENBQUM7UUFDSCxNQUFNLFFBQVEsR0FBRyxJQUFJLDBCQUFlLENBQUM7WUFDakMsT0FBTyxFQUFFLElBQUk7WUFDYixNQUFNO1lBQ04sUUFBUSxFQUFFLEVBQUU7WUFDWixTQUFTLEVBQUUsTUFBTTtZQUNqQixHQUFHLEVBQUU7Z0JBQ0QsS0FBSyxFQUFFLFNBQVM7Z0JBQ2hCLE1BQU0sRUFBRSxLQUFLO2dCQUNiLElBQUksRUFB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QyxpQ0FBaUMsRUFBRSxLQUFLLElBQUksRUFBRTtZQUM3QyxNQUFNLEdBQUcsR0FBRyxJQUFJLDBCQUFlLENBQUMsRUFBRSxHQUFHLFFBQVEsRUFBRSxNQUFNLEVBQUUscUJBQWEsQ0FBQyxhQUFhLEVBQUUsQ0FBQyxDQUFDO1lBQ3RGLE1BQU0sV0FBVyxHQUFHLElBQUEsaUJBQUksRUFBQywyQkFBVyxDQUFDLENBQUM7WUFDdEMsSUFBQSxpQkFBSSxFQUFDLFdBQVcsQ0FBQyx5QkFBeUIsQ0FBQyxJQUFBLHFCQUFRLEdBQUUsQ0FBQyxDQUFDLENBQUMsV0FBVyxDQUFDLEdBQUcsQ0FBQyxDQUFDO1lBQ3pFLElBQUEsaUJBQUksRUFBQyxXQUFXLENBQUMsNENBQTRDLENBQUMsSUFBQSxxQkFBUSxHQUFFLENBQUMsQ0FBQyxDQUFDLFdBQVcsQ0FBQyxFQUFFLENBQUMsQ0FBQztZQUMzRixNQUFNLFlBQVksR0FBRyxJQUFJLG1DQUFlLENBQUMsSUFBQSxxQkFBUSxFQUFDLFdBQVcsQ0FBQyxDQUFDLENBQUM7WUFFaEUsTUFBTSxHQUFHLEdBQUcsTUFBTSxZQUFZLENBQUMsZ0JBQWdCLENBQUMsQ0FBQyxNQUFNLENBQUMsQ0FBQyxDQUFDO1lBRTFELElBQUEsYUFBTSxFQUFDLEdBQUcsQ0FBQyxjQUFjLENBQUMsQ0FBQyxDQUFDLENBQUMsQ0FBQyxFQUFFLENBQUMsS0FBSyxDQUFDLFFBQVEsQ0FBQyxTQUFTLENBQUMsQ0FBQztZQUMzRCxJQUFBLG1CQUFNLEVBQUMsV0FBVyxDQUFDLGtCQUFrQixDQUFDLElBQUEscUJBQVEsR0FBRSxDQUFDLENBQUMsQ0FBQyxLQUFLLEVBQUUsQ0FBQztRQUMvRCxDQUFDLENBQUMsQ0FBQztJQUNQLENBQUMsQ0FBQyxDQUFDO0FBQ1AsQ0FBQyxDQUFDLENBQUMiLCJuYW1lcyI6W10sInNvdXJjZXMiOlsiL1VzZXJzL2Rhdmlkd2Fsc2gvY29kZS1sb2NhbC8weC1yZnEtYXBpL3Rlc3Qvc2VydmljZXMvcmZxX2FkbWluX3NlcnZpY2VfdGVzdC50cyJdLCJzb3VyY2VzQ29udGVudCI6WyIvLyB0c2xpbnQ6ZGlzYWJsZTpjdXN0b20tbm8tbWFnaWMtbnVtYmVyc1xyXG5cclxuaW1wb3J0IHsgT3RjT3JkZXIgfSBmcm9tICdAMHgvcHJvdG9jb2wtdXRpbHMnO1xyXG5pbXBvcnQgeyBCaWdOdW1iZXIgfSBmcm9tICdAMHgvdXRpbHMnO1xyXG5pbXBvcnQgeyBleHBlY3QgfSBmcm9tICdjaGFpJztcclxuaW1wb3J0IHsgYW55dGhpbmcsIGRlZXBFcXVhbCwgaW5zdGFuY2UsIG1vY2ssIHZlcmlmeSwgd2hlbiB9IGZyb20gJ3RzLW1vY2tpdG8nO1xyXG5cclxuaW1wb3J0IHsgT05FX1NFQ09ORF9NUywgWkVSTyB9IGZyb20gJy4uLy4uL3NyYy9jb3JlL2NvbnN0YW50cyc7XHJcbmltcG9ydCB7IFJmcW1WMkpvYkVudGl0eSB9IGZyb20gJy4uLy4uL3NyYy9lbnRpdGllcyc7XHJcbmltcG9ydCB7IFJmcW1Kb2JTdGF0dXMgfSBmcm9tICcuLi8uLi9zcmMvZW50aXRpZXMvdHlwZXMnO1xyXG5pbXBvcnQgeyBSZnFBZG1pblNlcnZpY2UgfSBmcm9tICcuLi8uLi9zcmMvc2VydmljZXMvcmZxX2FkbWluX3NlcnZpY2UnO1xyXG5pbXBvcnQgeyBvdGNPcmRlclRvU3RvcmVkT3RjT3JkZXIsIFJmcW1EYlV0aWxzIH0gZnJvbSAnLi4vLi4vc3JjL3V0aWxzL3JmcW1fZGJfdXRpbHMnO1xyXG5cclxuZGVzY3JpYmUoJ1JGUSBBZG1pbiBTZXJ2aWNlIExvZ2ljJywgKCkgPT4ge1xyXG4gICAgZGVzY3JpYmUoJ2NsZWFudXBKb2JzQXN5bmMnLCAoKSA9PiB7XHJcbiAgICAgICAgY29uc3QgZXhwaXJ5ID0gbmV3IEJpZ051bWJlcihEYXRlLm5vdygpIC0gMV8wMDBfMDAwKS5kaXZpZGVkQnkoT05FX1NFQ09ORF9NUykuZGVjaW1hbFBsYWNlcygwKTtcclxuICAgICAgICBjb25zdCBvdGNPcmRlciA9IG5ldyBPdGNPcmRlcih7XHJcbiAgICAgICAgICAgIHR4T3JpZ2luOiAnMHgwMDAwMDAwMDAwMDAwMDAwMDAwMDAwMDAwMDAwMDAwMDAwMDAwMDAwJyxcclxuICAgICAgICAgICAgdGFrZXI6ICcweDExMTExMTExMTExMTExMTExMTExMTExMTExMTExMTExMTExMTExMTEnLFxyXG4gICAgICAgICAgICBtYWtlcjogJzB4MjIyMjIyMjIyMjIyMjIyMjIyMjIyMjIyMjIyMjIyMjIyMjIyMjIyMicsXHJcbiAgICAgICAgICAgIG1ha2VyVG9rZW46ICcweDMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMnLFxyXG4gICAgICAgICAgICB0YWtlclRva2VuOiAnMHg0NDQ0NDQ0NDQ0NDQ0NDQ0NDQ0NDQ0NDQ0NDQ0NDQ0NDQ0NDQ0NDQ0JyxcclxuICAgICAgICAgICAgZXhwaXJ5QW5kTm9uY2U6IE90Y09yZGVyLmVuY29kZUV4cGlyeUFuZE5vbmNlKGV4cGlyeSwgWkVSTywgZXhwaXJ5KSxcclxuICAgICAgICAgICAgY2hhaW5JZDogMTMzNyxcclxuICAgICAgICAgICAgdmVyaWZ5aW5nQ29udHJhY3Q6ICcweDAwMDAwMDAwMDAwMDAwMDAwMDAwMDAwMDAwMDAwMDAwMDAwMDAwMDAnLFxyXG4gICAgICAgIH0pO1xyXG4gICAgICAgIGNvbnN0IEJBU0VfSk9CID0gbmV3IFJmcW1WMkpvYkVudGl0eSh7XHJcbiAgICAgICAgICAgIGNoYWluSWQ6IDEzMzcsXHJcbiAgICAgICAgICAgIGV4cGlyeSxcclxuICAgICAgICAgICAgbWFrZXJVcmk6ICcnLFxyXG4gICAgICAgICAgICBvcmRlckhhc2g6ICcweDAwJyxcclxuICAgICAgICAgICAgZmVlOiB7XHJcbiAgICAgICAgICAgICAgICB0b2tlbjogJzB4VG9rZW4nLFxyXG4gICAgICAgICAgICAgICAgYW1vdW50OiAnMTAwJyxcclxuICAgICAgICAgICAgICAgIHR5cGU6ICdmaXhlZCcsXHJcbiAgICAgICAgICAgIH0sXHJcbiAgICAgICAgICAgIG9yZGVyOiBvdGNPcmRlclRvU3RvcmVkT3RjT3JkZXIob3RjT3JkZXIpLFxyXG4gICAgICAgIH0pO1xyXG4gICAgICAgIGl0KCdzaG91bGQgY2xlYW4gdXAgc3R1Y2sgam9icycsIGFzeW5jICgpID0+IHtcclxuICAgICAgICAgICAgY29uc3Qgam9iID0gbmV3IFJmcW1WMkpvYkVudGl0eSh7IC4uLkJBU0VfSk9CLCBzdGF0dXM6IFJmcW1Kb2JTdGF0dXMuUGVuZGluZ1Byb2Nlc3NpbmcgfSk7XHJcbiAgICAgICAgICAgIGNvbnN0IGRiVXRpbHNNb2NrID0gbW9jayhSZnFtRGJVdGlscyk7XHJcbiAgICAgICAgICAgIHdoZW4oZGJVdGlsc01vY2suZmluZFYySm9iQnlPcmRlckhhc2hBc3luYyhhbnl0aGluZygpKSkudGhlblJlc29sdmUoam9iKTtcclxuICAgICAgICAgICAgd2hlbihkYlV0aWxzTW9jay5maW5kVjJUcmFuc2FjdGlvblN1Ym1pc3Npb25zQnlPcmRlckhhc2hBc3luYyhhbnl0aGluZygpKSkudGhlblJlc29sdmUoW10pO1xyXG4gICAgICAgICAgICBjb25zdCBhZG1pblNlcnZpY2UgPSBuZXcgUmZxQWRtaW5TZXJ2aWNlKGluc3RhbmNlKGRiVXRpbHNNb2NrKSk7XHJcblxyXG4gICAgICAgICAgICBjb25zdCByZXMgPSBhd2FpdCBhZG1pblNlcnZpY2UuY2xlYW51cEpvYnNBc3luYyhbJzB4MDAnXSk7XHJcblxyXG4gICAgICAgICAgICBleHBlY3QocmVzLm1vZGlmaWVkSm9ic1swXSkudG8uZXF1YWwoQkFTRV9KT0Iub3JkZXJIYXNoKTtcclxuICAgICAgICAgICAgdmVyaWZ5KFxyXG4gICAgICAgICAgICAgICAgZGJVdGlsc01vY2sudXBkYXRlUmZxbUpvYkFzeW5jKFxyXG4gICAgICAgICAgICAgICAgICAgIGRlZXBFcXVhbChuZXcgUmZxbVYySm9iRW50aXR5KHsgLi4uQkFTRV9KT0IsIHN0YXR1czogUmZxbUpvYlN0YXR1cy5GYWlsZWRFeHBpcmVkIH0pKSxcclxuICAgICAgICAgICAgICAgICksXHJcbiAgICAgICAgICAgICkuY2FsbGVkKCk7XHJcbiAgICAgICAgfSk7XHJcbiAgICAgICAgaXQoJ3Nob3VsZCBub3QgbW9kaWZ5IHVuZXhwaXJlZCBqb2JzJywgYXN5bmMgKCkgPT4ge1xyXG4gICAgICAgICAgICBjb25zdCBqb2IgPSBuZXcgUmZxbVYySm9iRW50aXR5KHtcclxuICAgICAgICAgICAgICAgIC4uLkJBU0VfSk9CLFxyXG4gICAgICAgICAgICAgICAgc3RhdHVzOiBSZnFtSm9iU3RhdHVzLlBlbmRpbmdQcm9jZXNzaW5nLFxyXG4gICAgICAgICAgICAgICAgZXhwaXJ5OiBuZXcgQmlnTnVtYmVyKERhdGUubm93KCkgKyA2MF8wMDApLmRpdmlkZWRCeShPTkVfU0VDT05EX01TKS5kZWNpbWFsUGxhY2VzKDApLFxyXG4gICAgICAgICAgICB9KTtcclxuICAgICAgICAgICAgY29uc3QgZGJVdGlsc01vY2sgPSBtb2NrKFJmcW1EYlV0aWxzKTtcclxuICAgICAgICAgICAgd2hlbihkYlV0aWxzTW9jay5maW5kVjJKb2JCeU9yZGVySGFzaEFzeW5jKGFueXRoaW5nKCkpKS50aGVuUmVzb2x2ZShqb2IpO1xyXG4gICAgICAgICAgICB3aGVuKGRiVXRpbHNNb2NrLmZpbmRWMlRyYW5zYWN0aW9uU3VibWlzc2lvbnNCeU9yZGVySGFzaEFzeW5jKGFueXRoaW5nKCkpKS50aGVuUmVzb2x2ZShbXSk7XHJcbiAgICAgICAgICAgIGNvbnN0IGFkbWluU2VydmljZSA9IG5ldyBSZnFBZG1pblNlcnZpY2UoaW5zdGFuY2UoZGJVdGlsc01vY2spKTtcclxuXHJcbiAgICAgICAgICAgIGNvbnN0IHJlcyA9IGF3YWl0IGFkbWluU2VydmljZS5jbGVhbnVwSm9ic0FzeW5jKFsnMHgwMCddKTtcclxuXHJcbiAgICAgICAgICAgIGV4cGVjdChyZXMudW5tb2RpZmllZEpvYnNbMF0pLnRvLmVxdWFsKEJBU0VfSk9CLm9yZGVySGFzaCk7XHJcbiAgICAgICAgICAgIHZlcmlmeShkYlV0aWxzTW9jay51cGRhdGVSZnFtSm9iQXN5bmMoYW55dGhpbmcoKSkpLm5ldmVyKCk7XHJcbiAgICAgICAgfSk7XHJcbiAgICAgICAgaXQoJ3Nob3VsZCBub3QgbW9kaWZ5IHJlc29sdmVkIGpvYnMnLCBhc3luYyAoKSA9PiB7XHJcbiAgICAgICAgICAgIGNvbnN0IGpvYiA9IG5ldyBSZnFtVjJKb2JFbnRpdHkoeyAuLi5CQVNFX0pPQiwgc3RhdHVzOiBSZnFtSm9iU3RhdHVzLkZhaWxlZEV4cGlyZWQgfSk7XHJcbiAgICAgICAgICAgIGNvbnN0IGRiVXRpbHNNb2NrID0gbW9jayhSZnFtRGJVdGlscyk7XHJcbiAgICAgICAgICAgIHdoZW4oZGJVdGlsc01vY2suZmluZFYySm9iQnlPcmRlckhhc2hBc3luYyhhbnl0aGluZygpKSkudGhlblJlc29sdmUoam9iKTtcclxuICAgICAgICAgICAgd2hlbihkYlV0aWxzTW9jay5maW5kVjJUcmFuc2FjdGlvblN1Ym1pc3Npb25zQnlPcmRlckhhc2hBc3luYyhhbnl0aGluZygpKSkudGhlblJlc29sdmUoW10pO1xyXG4gICAgICAgICAgICBjb25zdCBhZG1pblNlcnZpY2UgPSBuZXcgUmZxQWRtaW5TZXJ2aWNlKGluc3RhbmNlKGRiVXRpbHNNb2NrKSk7XHJcblxyXG4gICAgICAgICAgICBjb25zdCByZXMgPSBhd2FpdCBhZG1pblNlcnZpY2UuY2xlYW51cEpvYnNBc3luYyhbJzB4MDAnXSk7XHJcblxyXG4gICAgICAgICAgICBleHBlY3QocmVzLnVubW9kaWZpZWRKb2JzWzBdKS50by5lcXVhbChCQVNFX0pPQi5vcmRlckhhc2gpO1xyXG4gICAgICAgICAgICB2ZXJpZnkoZGJVdGlsc01vY2sudXBkYXRlUmZxbUpvYkFzeW5jKGFueXRoaW5nKCkpKS5uZXZlcigpO1xyXG4gICAgICAgIH0pO1xyXG4gICAgfSk7XHJcbn0pO1xyXG4iXSwidmVyc2lvbiI6M30=