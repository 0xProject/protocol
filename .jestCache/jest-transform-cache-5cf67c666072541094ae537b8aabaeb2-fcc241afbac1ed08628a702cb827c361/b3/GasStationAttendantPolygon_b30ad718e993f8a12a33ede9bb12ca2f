1bf2d1cd474334fe851bf404930fe480
"use strict";
Object.defineProperty(exports, "__esModule", { value: true });
exports.GasStationAttendantPolygon = void 0;
const utils_1 = require("@0x/utils");
const constants_1 = require("../core/constants");
// The total minimum bid recommended by the post here:
// https://forum.matic.network/t/recommended-min-gas-price-setting/2531
// Expect bids lower than this to be rejected by the RPC node.
const MINIMUM_BID_WEI = 30000000000;
// The maximum tip we're willing to pay, based on p99 historical data
// Increase multiplier for tip with each resubmission cycle
const TEN_PERCENT_INCREASE = 1.1;
/**
 * An implementation of `GasStationAttendant` designed for Polygon.
 *
 * Currently, the 0x Gas Oracle does not provide pricing for Polygon
 * in EIP-1559 format. Therefore, we'll use the 'fast' gas as a
 * `maxPriorityFeePerGas` estimate. This actually works out okay because
 * the Polygon base fee is always essentially zero as of April 2022.
 */
class GasStationAttendantPolygon {
    constructor(gasOracleType0) {
        this._gasOracleType0 = gasOracleType0;
    }
    /**
     * The Safe Balance For Trade is from the p95 data shown here:
     * https://0xproject.slack.com/archives/CQG0ZGBFS/p1649708977452469
     */
    // tslint:disable-next-line: prefer-function-over-method
    async getSafeBalanceForTradeAsync() {
        const p95PriorityFeeGwei = 261;
        // Base fee is essentially zero
        // TODO (rhinodavid): Make this smarter as we have more historical data
        const gasEstimate = constants_1.RFQM_TX_OTC_ORDER_GAS_ESTIMATE;
        // 0.0261 MATIC
        return new utils_1.BigNumber(p95PriorityFeeGwei).shiftedBy(constants_1.GWEI_DECIMALS).times(gasEstimate);
    }
    /**
     * Uses the current fast gas price as the `maxPriorityFeePerGas`
     * estimate. Plans for 3 resubmits at a 10% tip increase. Assumes
     * no base fee.
     *
     * Uses a fixed value of 110,000 for the transaction gas amount
     * estimate.
     */
    async getWorkerBalanceForTradeAsync() {
        // TODO (rhinodavid): Once the 0x gas oracle can give EIP-1559 data for Polygon
        // use that instead of the legacy fast gas price.
        const gasPriceEstimateWei = await this._gasOracleType0.getGasWeiAsync('fast');
        // Since the base fee is basically nothing, use this for our initial max priority fee
        const maxPriorityFeePerGas = gasPriceEstimateWei;
        // Pad the tip for 3 10% increases
        const maxPriorityFeePad = Math.pow(TEN_PERCENT_INCREASE, 3); // tslint:disable-line: custom-no-magic-numbers
        const paddedMaxPriorityFeePerGas = maxPriorityFeePerGas.times(maxPriorityFeePad);
        const gasRateWei = utils_1.BigNumber.max(paddedMaxPriorityFeePerGas.plus(0), MINIMUM_BID_WEI); // Amortizing the base fee to 0
        // Pad a little until we get a better idea of token-specific costs
        const padding = 1.1;
        const gasEstimate = constants_1.RFQM_TX_OTC_ORDER_GAS_ESTIMATE * padding;
        return gasRateWei.times(gasEstimate);
    }
    /**
     * Calculated using a similar methodology to `getWorkerBalanceForTradeAsync`,
     * but assumes we submit and average 1.5 transactions per trade, which is
     * what we see on Ethereum.
     *
     * TODO (rhinodavid): Update this once we have more historical data
     */
    async getExpectedTransactionGasRateAsync() {
        const gasPriceEstimateWei = await this._gasOracleType0.getGasWeiAsync('fast');
        // Since the base fee is basically nothing, use this for our initial max priority fee
        const maxPriorityFeePerGas = gasPriceEstimateWei;
        // Pad the tip for 1.5 10% increases
        const baseFeePad = Math.pow(TEN_PERCENT_INCREASE, 1.5); // tslint:disable-line: custom-no-magic-numbers
        const paddedMaxPriorityFeePerGas = maxPriorityFeePerGas.times(baseFeePad);
        const gasRateWei = paddedMaxPriorityFeePerGas.plus(0); // Amortizing the base fee to 0
        return gasRateWei.integerValue(utils_1.BigNumber.ROUND_CEIL);
    }
}
exports.GasStationAttendantPolygon = GasStationAttendantPolygon;
//# sourceMappingURL=data:application/json;charset=utf-8;base64,eyJmaWxlIjoiL1VzZXJzL2Rhdmlkd2Fsc2gvY29kZS1sb2NhbC8weC1yZnEtYXBpL3NyYy91dGlscy9HYXNTdGF0aW9uQXR0ZW5kYW50UG9seWdvbi50cyIsIm1hcHBpbmdzIjoiOzs7QUFBQSxxQ0FBc0M7QUFFdEMsaURBQWtGO0FBS2xGLHNEQUFzRDtBQUN0RCx1RUFBdUU7QUFDdkUsOERBQThEO0FBQzlELE1BQU0sZUFBZSxHQUFHLFdBQVcsQ0FBQztBQUVwQyxxRUFBcUU7QUFFckUsMkRBQTJEO0FBQzNELE1BQU0sb0JBQW9CLEdBQUcsR0FBRyxDQUFDO0FBRWpDOzs7Ozs7O0dBT0c7QUFDSCxNQUFhLDBCQUEwQjtJQUduQyxZQUFZLGNBQThCO1FBQ3RDLElBQUksQ0FBQyxlQUFlLEdBQUcsY0FBYyxDQUFDO0lBQzFDLENBQUM7SUFFRDs7O09BR0c7SUFDSCx3REFBd0Q7SUFDakQsS0FBSyxDQUFDLDJCQUEyQjtRQUNwQyxNQUFNLGtCQUFrQixHQUFHLEdBQUcsQ0FBQztRQUMvQiwrQkFBK0I7UUFDL0IsdUVBQXVFO1FBQ3ZFLE1BQU0sV0FBVyxHQUFHLDBDQUE4QixDQUFDO1FBQ25ELGVBQWU7UUFDZixPQUFPLElBQUksaUJBQVMsQ0FBQyxrQkFBa0IsQ0FBQyxDQUFDLFNBQVMsQ0FBQyx5QkFBYSxDQUFDLENBQUMsS0FBSyxDQUFDLFdBQVcsQ0FBQyxDQUFDO0lBQ3pGLENBQUM7SUFFRDs7Ozs7OztPQU9HO0lBQ0ksS0FBSyxDQUFDLDZCQUE2QjtRQUN0QywrRUFBK0U7UUFDL0UsaURBQWlEO1FBQ2pELE1BQU0sbUJBQW1CLEdBQUcsTUFBTSxJQUFJLENBQUMsZUFBZSxDQUFDLGNBQWMsQ0FBQyxNQUFNLENBQUMsQ0FBQztRQUU5RSxxRkFBcUY7UUFDckYsTUFBTSxvQkFBb0IsR0FBRyxtQkFBbUIsQ0FBQztRQUVqRCxrQ0FBa0M7UUFDbEMsTUFBTSxpQkFBaUIsR0FBRyxJQUFJLENBQUMsR0FBRyxDQUFDLG9CQUFvQixFQUFFLENBQUMsQ0FBQyxDQUFDLENBQUMsK0NBQStDO1FBQzVHLE1BQU0sMEJBQTBCLEdBQUcsb0JBQW9CLENBQUMsS0FBSyxDQUFDLGlCQUFpQixDQUFDLENBQUM7UUFDakYsTUFBTSxVQUFVLEdBQUcsaUJBQVMsQ0FBQyxHQUFHLENBQUMsMEJBQTBCLENBQUMsSUFBSSxDQUFDLENBQUMsQ0FBQyxFQUFFLGVBQWUsQ0FBQyxDQUFDLENBQUMsK0JBQStCO1FBRXRILGtFQUFrRTtRQUNsRSxNQUFNLE9BQU8sR0FBRyxHQUFHLENBQUM7UUFDcEIsTUFBTSxXQUFXLEdBQUcsMENBQThCLEdBQUcsT0FBTyxDQUFDO1FBRTdELE9BQU8sVUFBVSxDQUFDLEtBQUssQ0FBQyxXQUFXLENBQUMsQ0FBQztJQUN6QyxDQUFDO0lBRUQ7Ozs7OztPQU1HO0lBQ0ksS0FBSyxDQUFDLGtDQUFrQztRQUMzQyxNQUFNLG1CQUFtQixHQUFHLE1BQU0sSUFBSSxDQUFDLGVBQWUsQ0FBQyxjQUFjLENBQUMsTUFBTSxDQUFDLENBQUM7UUFFOUUscUZBQXFGO1FBQ3JGLE1BQU0sb0JBQW9CLEdBQUcsbUJBQW1CLENBQUM7UUFFakQsb0NBQW9DO1FBQ3BDLE1BQU0sVUFBVSxHQUFHLElBQUksQ0FBQyxHQUFHLENBQUMsb0JBQW9CLEVBQUUsR0FBRyxDQUFDLENBQUMsQ0FBQywrQ0FBK0M7UUFDdkcsTUFBTSwwQkFBMEIsR0FBRyxvQkFBb0IsQ0FBQyxLQUFLLENBQUMsVUFBVSxDQUFDLENBQUM7UUFDMUUsTUFBTSxVQUFVLEdBQUcsMEJBQTBCLENBQUMsSUFBSSxDQUFDLENBQUMsQ0FBQyxDQUFDLENBQUMsK0JBQStCO1FBRXRGLE9BQU8sVUFBVSxDQUFDLFlBQVksQ0FBQyxpQkFBUyxDQUFDLFVBQVUsQ0FBQyxDQUFDO0lBQ3pELENBQUM7Q0FDSjtBQXJFRCxnRUFxRUMiLCJuYW1lcyI6W10sInNvdXJjZXMiOlsiL1VzZXJzL2Rhdmlkd2Fsc2gvY29kZS1sb2NhbC8weC1yZnEtYXBpL3NyYy91dGlscy9HYXNTdGF0aW9uQXR0ZW5kYW50UG9seWdvbi50cyJdLCJzb3VyY2VzQ29udGVudCI6WyJpbXBvcnQgeyBCaWdOdW1iZXIgfSBmcm9tICdAMHgvdXRpbHMnO1xuXG5pbXBvcnQgeyBHV0VJX0RFQ0lNQUxTLCBSRlFNX1RYX09UQ19PUkRFUl9HQVNfRVNUSU1BVEUgfSBmcm9tICcuLi9jb3JlL2NvbnN0YW50cyc7XG5pbXBvcnQgeyBHYXNPcmFjbGVUeXBlMCB9IGZyb20gJy4vR2FzT3JhY2xlVHlwZTAnO1xuXG5pbXBvcnQgeyBHYXNTdGF0aW9uQXR0ZW5kYW50LCBXZWksIFdlaVBlckdhcyB9IGZyb20gJy4vR2FzU3RhdGlvbkF0dGVuZGFudCc7XG5cbi8vIFRoZSB0b3RhbCBtaW5pbXVtIGJpZCByZWNvbW1lbmRlZCBieSB0aGUgcG9zdCBoZXJlOlxuLy8gaHR0cHM6Ly9mb3J1bS5tYXRpYy5uZXR3b3JrL3QvcmVjb21tZW5kZWQtbWluLWdhcy1wcmljZS1zZXR0aW5nLzI1MzFcbi8vIEV4cGVjdCBiaWRzIGxvd2VyIHRoYW4gdGhpcyB0byBiZSByZWplY3RlZCBieSB0aGUgUlBDIG5vZGUuXG5jb25zdCBNSU5JTVVNX0JJRF9XRUkgPSAzMDAwMDAwMDAwMDtcblxuLy8gVGhlIG1heGltdW0gdGlwIHdlJ3JlIHdpbGxpbmcgdG8gcGF5LCBiYXNlZCBvbiBwOTkgaGlzdG9yaWNhbCBkYXRhXG5cbi8vIEluY3JlYXNlIG11bHRpcGxpZXIgZm9yIHRpcCB3aXRoIGVhY2ggcmVzdWJtaXNzaW9uIGN5Y2xlXG5jb25zdCBURU5fUEVSQ0VOVF9JTkNSRUFTRSA9IDEuMTtcblxuLyoqXG4gKiBBbiBpbXBsZW1lbnRhdGlvbiBvZiBgR2FzU3RhdGlvbkF0dGVuZGFudGAgZGVzaWduZWQgZm9yIFBvbHlnb24uXG4gKlxuICogQ3VycmVudGx5LCB0aGUgMHggR2FzIE9yYWNsZSBkb2VzIG5vdCBwcm92aWRlIHByaWNpbmcgZm9yIFBvbHlnb25cbiAqIGluIEVJUC0xNTU5IGZvcm1hdC4gVGhlcmVmb3JlLCB3ZSdsbCB1c2UgdGhlICdmYXN0JyBnYXMgYXMgYVxuICogYG1heFByaW9yaXR5RmVlUGVyR2FzYCBlc3RpbWF0ZS4gVGhpcyBhY3R1YWxseSB3b3JrcyBvdXQgb2theSBiZWNhdXNlXG4gKiB0aGUgUG9seWdvbiBiYXNlIGZlZSBpcyBhbHdheXMgZXNzZW50aWFsbHkgemVybyBhcyBvZiBBcHJpbCAyMDIyLlxuICovXG5leHBvcnQgY2xhc3MgR2FzU3RhdGlvbkF0dGVuZGFudFBvbHlnb24gaW1wbGVtZW50cyBHYXNTdGF0aW9uQXR0ZW5kYW50IHtcbiAgICBwcml2YXRlIHJlYWRvbmx5IF9nYXNPcmFjbGVUeXBlMDogR2FzT3JhY2xlVHlwZTA7XG5cbiAgICBjb25zdHJ1Y3RvcihnYXNPcmFjbGVUeXBlMDogR2FzT3JhY2xlVHlwZTApIHtcbiAgICAgICAgdGhpcy5fZ2FzT3JhY2xlVHlwZTAgPSBnYXNPcmFjbGVUeXBlMDtcbiAgICB9XG5cbiAgICAvKipcbiAgICAgKiBUaGUgU2FmZSBCYWxhbmNlIEZvciBUcmFkZSBpcyBmcm9tIHRoZSBwOTUgZGF0YSBzaG93biBoZXJlOlxuICAgICAqIGh0dHBzOi8vMHhwcm9qZWN0LnNsYWNrLmNvbS9hcmNoaXZlcy9DUUcwWkdCRlMvcDE2NDk3MDg5Nzc0NTI0NjlcbiAgICAgKi9cbiAgICAvLyB0c2xpbnQ6ZGlzYWJsZS1uZXh0LWxpbmU6IHByZWZlci1mdW5jdGlvbi1vdmVyLW1ldGhvZFxuICAgIHB1YmxpYyBhc3luYyBnZXRTYWZlQmFsYW5jZUZvclRyYWRlQXN5bmMoKTogUHJvbWlzZTxXZWk+IHtcbiAgICAgICAgY29uc3QgcDk1UHJpb3JpdHlGZWVHd2VpID0gMjYxO1xuICAgICAgICAvLyBCYXNlIGZlZSBpcyBlc3NlbnRpYWxseSB6ZXJvXG4gICAgICAgIC8vIFRPRE8gKHJoaW5vZGF2aWQpOiBNYWtlIHRoaXMgc21hcnRlciBhcyB3ZSBoYXZlIG1vcmUgaGlzdG9yaWNhbCBkYXRhXG4gICAgICAgIGNvbnN0IGdhc0VzdGltYXRlID0gUkZRTV9UWF9PVENfT1JERVJfR0FTX0VTVElNQVRFO1xuICAgICAgICAvLyAwLjAyNjEgTUFUSUNcbiAgICAgICAgcmV0dXJuIG5ldyBCaWdOdW1iZXIocDk1UHJpb3JpdHlGZWVHd2VpKS5zaGlmdGVkQnkoR1dFSV9ERUNJTUFMUykudGltZXMoZ2FzRXN0aW1hdGUpO1xuICAgIH1cblxuICAgIC8qKlxuICAgICAqIFVzZXMgdGhlIGN1cnJlbnQgZmFzdCBnYXMgcHJpY2UgYXMgdGhlIGBtYXhQcmlvcml0eUZlZVBlckdhc2BcbiAgICAgKiBlc3RpbWF0ZS4gUGxhbnMgZm9yIDMgcmVzdWJtaXRzIGF0IGEgMTAlIHRpcCBpbmNyZWFzZS4gQXNzdW1lc1xuICAgICAqIG5vIGJhc2UgZmVlLlxuICAgICAqXG4gICAgICogVXNlcyBhIGZpeGVkIHZhbHVlIG9mIDExMCwwMDAgZm9yIHRoZSB0cmFuc2FjdGlvbiBnYXMgYW1vdW50XG4gICAgICogZXN0aW1hdGUuXG4gICAgICovXG4gICAgcHVibGljIGFzeW5jIGdldFdvcmtlckJhbGFuY2VGb3JUcmFkZUFzeW5jKCk6IFByb21pc2U8V2VpUGVyR2FzPiB7XG4gICAgICAgIC8vIFRPRE8gKHJoaW5vZGF2aWQpOiBPbmNlIHRoZSAweCBnYXMgb3JhY2xlIGNhbiBnaXZlIEVJUC0xNTU5IGRhdGEgZm9yIFBvbHlnb25cbiAgICAgICAgLy8gdXNlIHRoYXQgaW5zdGVhZCBvZiB0aGUgbGVnYWN5IGZhc3QgZ2FzIHByaWNlLlxuICAgICAgICBjb25zdCBnYXNQcmljZUVzdGltYXRlV2VpID0gYXdhaXQgdGhpcy5fZ2FzT3JhY2xlVHlwZTAuZ2V0R2FzV2VpQXN5bmMoJ2Zhc3QnKTtcblxuICAgICAgICAvLyBTaW5jZSB0aGUgYmFzZSBmZWUgaXMgYmFzaWNhbGx5IG5vdGhpbmcsIHVzZSB0aGlzIGZvciBvdXIgaW5pdGlhbCBtYXggcHJpb3JpdHkgZmVlXG4gICAgICAgIGNvbnN0IG1heFByaW9yaXR5RmVlUGVyR2FzID0gZ2FzUHJpY2VFc3RpbWF0ZVdlaTtcblxuICAgICAgICAvLyBQYWQgdGhlIHRpcCBmb3IgMyAxMCUgaW5jcmVhc2VzXG4gICAgICAgIGNvbnN0IG1heFByaW9yaXR5RmVlUGFkID0gTWF0aC5wb3coVEVOX1BFUkNFTlRfSU5DUkVBU0UsIDMpOyAvLyB0c2xpbnQ6ZGlzYWJsZS1saW5lOiBjdXN0b20tbm8tbWFnaWMtbnVtYmVyc1xuICAgICAgICBjb25zdCBwYWRkZWRNYXhQcmlvcml0eUZlZVBlckdhcyA9IG1heFByaW9yaXR5RmVlUGVyR2FzLnRpbWVzKG1heFByaW9yaXR5RmVlUGFkKTtcbiAgICAgICAgY29uc3QgZ2FzUmF0ZVdlaSA9IEJpZ051bWJlci5tYXgocGFkZGVkTWF4UHJpb3JpdHlGZWVQZXJHYXMucGx1cygwKSwgTUlOSU1VTV9CSURfV0VJKTsgLy8gQW1vcnRpemluZyB0aGUgYmFzZSBmZWUgdG8gMFxuXG4gICAgICAgIC8vIFBhZCBhIGxpdHRsZSB1bnRpbCB3ZSBnZXQgYSBiZXR0ZXIgaWRlYSBvZiB0b2tlbi1zcGVjaWZpYyBjb3N0c1xuICAgICAgICBjb25zdCBwYWRkaW5nID0gMS4xO1xuICAgICAgICBjb25zdCBnYXNFc3RpbWF0ZSA9IFJGUU1fVFhfT1RDX09SREVSX0dBU19FU1RJTUFURSAqIHBhZGRpbmc7XG5cbiAgICAgICAgcmV0dXJuIGdhc1JhdGVXZWkudGltZXMoZ2FzRXN0aW1hdGUpO1xuICAgIH1cblxuICAgIC8qKlxuICAgICAqIENhbGN1bGF0ZWQgdXNpbmcgYSBzaW1pbGFyIG1ldGhvZG9sb2d5IHRvIGBnZXRXb3JrZXJCYWxhbmNlRm9yVHJhZGVBc3luY2AsXG4gICAgICogYnV0IGFzc3VtZXMgd2Ugc3VibWl0IGFuZCBhdmVyYWdlIDEuNSB0cmFuc2FjdGlvbnMgcGVyIHRyYWRlLCB3aGljaCBpc1xuICAgICAqIHdoYXQgd2Ugc2VlIG9uIEV0aGVyZXVtLlxuICAgICAqXG4gICAgICogVE9ETyAocmhpbm9kYXZpZCk6IFVwZGF0ZSB0aGlzIG9uY2Ugd2UgaGF2ZSBtb3JlIGhpc3RvcmljYWwgZGF0YVxuICAgICAqL1xuICAgIHB1YmxpYyBhc3luYyBnZXRFeHBlY3RlZFRyYW5zYWN0aW9uR2FzUmF0ZUFzeW5jKCk6IFByb21pc2U8V2VpUGVyR2FzPiB7XG4gICAgICAgIGNvbnN0IGdhc1ByaWNlRXN0aW1hdGVXZWkgPSBhd2FpdCB0aGlzLl9nYXNPcmFjbGVUeXBlMC5nZXRHYXNXZWlBc3luYygnZmFzdCcpO1xuXG4gICAgICAgIC8vIFNpbmNlIHRoZSBiYXNlIGZlZSBpcyBiYXNpY2FsbHkgbm90aGluZywgdXNlIHRoaXMgZm9yIG91ciBpbml0aWFsIG1heCBwcmlvcml0eSBmZWVcbiAgICAgICAgY29uc3QgbWF4UHJpb3JpdHlGZWVQZXJHYXMgPSBnYXNQcmljZUVzdGltYXRlV2VpO1xuXG4gICAgICAgIC8vIFBhZCB0aGUgdGlwIGZvciAxLjUgMTAlIGluY3JlYXNlc1xuICAgICAgICBjb25zdCBiYXNlRmVlUGFkID0gTWF0aC5wb3coVEVOX1BFUkNFTlRfSU5DUkVBU0UsIDEuNSk7IC8vIHRzbGludDpkaXNhYmxlLWxpbmU6IGN1c3RvbS1uby1tYWdpYy1udW1iZXJzXG4gICAgICAgIGNvbnN0IHBhZGRlZE1heFByaW9yaXR5RmVlUGVyR2FzID0gbWF4UHJpb3JpdHlGZWVQZXJHYXMudGltZXMoYmFzZUZlZVBhZCk7XG4gICAgICAgIGNvbnN0IGdhc1JhdGVXZWkgPSBwYWRkZWRNYXhQcmlvcml0eUZlZVBlckdhcy5wbHVzKDApOyAvLyBBbW9ydGl6aW5nIHRoZSBiYXNlIGZlZSB0byAwXG5cbiAgICAgICAgcmV0dXJuIGdhc1JhdGVXZWkuaW50ZWdlclZhbHVlKEJpZ051bWJlci5ST1VORF9DRUlMKTtcbiAgICB9XG59XG4iXSwidmVyc2lvbiI6M30=