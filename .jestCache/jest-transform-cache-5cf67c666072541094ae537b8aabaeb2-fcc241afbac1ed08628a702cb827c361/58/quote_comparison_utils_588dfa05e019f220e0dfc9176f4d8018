58bd93758899c45f962866b7d232d584
"use strict";
Object.defineProperty(exports, "__esModule", { value: true });
exports.getBestQuote = void 0;
const prom_client_1 = require("prom-client");
const constants_1 = require("../core/constants");
const logger_1 = require("../logger");
const pair_utils_1 = require("../core/pair_utils");
const utils_1 = require("@0x/utils");
const RFQM_MAKER_BLOCKED_FOR_LOW_MAKER_BALANCE = new prom_client_1.Counter({
    name: 'rfqm_maker_blocked_for_low_maker_balance',
    help: 'A maker get blocked because of low maker balance',
    labelNames: ['maker_uri', 'chain_id', 'pair_key'],
});
/**
 * Selects the best quote from an array of quotes.
 *
 * Ignores quotes that:
 *  - are for the wrong pair
 *  - cannot fill 100% of the requested amount
 *  - expire in less than the validity window
 *  - cannot be filled by the maker due to insufficient balances, if quotedMakerBalances is present
 *      (only for firm quotes)
 *
 * And selects the one with the best price.
 */
function getBestQuote(quotes, isSelling, takerToken, makerToken, assetFillAmount, validityWindowMs, quotedMakerBalances) {
    // If maker balances are provided, quotes in which maker addresses cannot provide sufficient
    // balances to fully fill the order are filtered out
    let isMakerFillablePredicate = (_q, _idx) => true;
    if (quotedMakerBalances) {
        if (quotes.length !== quotedMakerBalances.length) {
            throw new Error('Quotes do not match with provided maker balances');
        }
        isMakerFillablePredicate = (q, idx) => {
            if (isFirmQuote(q) && q.order.makerAmount.gt(quotedMakerBalances[idx])) {
                RFQM_MAKER_BLOCKED_FOR_LOW_MAKER_BALANCE.labels(q.makerUri, q.order.chainId.toString(), (0, pair_utils_1.toPairString)(getMakerToken(q), getTakerToken(q))).inc();
                logger_1.logger.warn({
                    maker: q.makerUri,
                    makerBalance: quotedMakerBalances[idx],
                    order: q.order,
                }, 'Quote has insufficient maker balance');
                return false;
            }
            return true;
        };
    }
    const validityWindowSeconds = validityWindowMs / constants_1.ONE_SECOND_MS;
    const sortedQuotes = quotes
        .filter(isMakerFillablePredicate)
        .filter((q) => getTakerToken(q) === takerToken && getMakerToken(q) === makerToken)
        .filter((q) => {
        const requestedAmount = isSelling ? getTakerAmount(q) : getMakerAmount(q);
        return requestedAmount.eq(assetFillAmount);
    })
        .filter((q) => !willQuoteExpireIn(q, validityWindowSeconds))
        .sort((a, b) => {
        // Want the most amount of maker tokens for each taker token
        const aPrice = getMakerAmount(a).div(getTakerAmount(a));
        const bPrice = getMakerAmount(b).div(getTakerAmount(b));
        return bPrice.minus(aPrice).toNumber();
    });
    // No quotes found
    if (sortedQuotes.length === 0) {
        return null;
    }
    // Get the best quote
    return sortedQuotes[0];
}
exports.getBestQuote = getBestQuote;
/// Private getter functions
const getTakerToken = (quote) => {
    return isFirmQuote(quote) ? quote.order.takerToken : quote.takerToken;
};
const getMakerToken = (quote) => {
    return isFirmQuote(quote) ? quote.order.makerToken : quote.makerToken;
};
const getTakerAmount = (quote) => {
    return isFirmQuote(quote) ? quote.order.takerAmount : quote.takerAmount;
};
const getMakerAmount = (quote) => {
    return isFirmQuote(quote) ? quote.order.makerAmount : quote.makerAmount;
};
const willQuoteExpireIn = (quote, secondsFromNow) => {
    if (isFirmQuote(quote)) {
        return quote.order.willExpire(secondsFromNow);
    }
    // Handle indicative quote
    const nowSeconds = new utils_1.BigNumber(Date.now()).div(constants_1.ONE_SECOND_MS);
    const expirationCutoff = nowSeconds.plus(secondsFromNow);
    return quote.expiry.lt(expirationCutoff);
};
const isFirmQuote = (quote) => {
    return quote.order !== undefined;
};
//# sourceMappingURL=data:application/json;charset=utf-8;base64,eyJmaWxlIjoiL1VzZXJzL2Rhdmlkd2Fsc2gvY29kZS1sb2NhbC8weC1yZnEtYXBpL3NyYy91dGlscy9xdW90ZV9jb21wYXJpc29uX3V0aWxzLnRzIiwibWFwcGluZ3MiOiI7OztBQUFBLDZDQUFzQztBQUV0QyxpREFBa0Q7QUFDbEQsc0NBQW1DO0FBR25DLG1EQUFrRDtBQUNsRCxxQ0FBc0M7QUFHdEMsTUFBTSx3Q0FBd0MsR0FBRyxJQUFJLHFCQUFPLENBQUM7SUFDekQsSUFBSSxFQUFFLDBDQUEwQztJQUNoRCxJQUFJLEVBQUUsa0RBQWtEO0lBQ3hELFVBQVUsRUFBRSxDQUFDLFdBQVcsRUFBRSxVQUFVLEVBQUUsVUFBVSxDQUFDO0NBQ3BELENBQUMsQ0FBQztBQUVIOzs7Ozs7Ozs7OztHQVdHO0FBQ0gsU0FBZ0IsWUFBWSxDQUN4QixNQUFXLEVBQ1gsU0FBa0IsRUFDbEIsVUFBa0IsRUFDbEIsVUFBa0IsRUFDbEIsZUFBMEIsRUFDMUIsZ0JBQXdCLEVBQ3hCLG1CQUFpQztJQUVqQyw0RkFBNEY7SUFDNUYsb0RBQW9EO0lBQ3BELElBQUksd0JBQXdCLEdBQUcsQ0FBQyxFQUFLLEVBQUUsSUFBWSxFQUFFLEVBQUUsQ0FBQyxJQUFJLENBQUM7SUFDN0QsSUFBSSxtQkFBbUIsRUFBRTtRQUNyQixJQUFJLE1BQU0sQ0FBQyxNQUFNLEtBQUssbUJBQW1CLENBQUMsTUFBTSxFQUFFO1lBQzlDLE1BQU0sSUFBSSxLQUFLLENBQUMsa0RBQWtELENBQUMsQ0FBQztTQUN2RTtRQUNELHdCQUF3QixHQUFHLENBQUMsQ0FBSSxFQUFFLEdBQVcsRUFBRSxFQUFFO1lBQzdDLElBQUksV0FBVyxDQUFDLENBQUMsQ0FBQyxJQUFJLENBQUMsQ0FBQyxLQUFLLENBQUMsV0FBVyxDQUFDLEVBQUUsQ0FBQyxtQkFBbUIsQ0FBQyxHQUFHLENBQUMsQ0FBQyxFQUFFO2dCQUNwRSx3Q0FBd0MsQ0FBQyxNQUFNLENBQzNDLENBQUMsQ0FBQyxRQUFRLEVBQ1YsQ0FBQyxDQUFDLEtBQUssQ0FBQyxPQUFPLENBQUMsUUFBUSxFQUFFLEVBQzFCLElBQUEseUJBQVksRUFBQyxhQUFhLENBQUMsQ0FBQyxDQUFDLEVBQUUsYUFBYSxDQUFDLENBQUMsQ0FBQyxDQUFDLENBQ25ELENBQUMsR0FBRyxFQUFFLENBQUM7Z0JBQ1IsZUFBTSxDQUFDLElBQUksQ0FDUDtvQkFDSSxLQUFLLEVBQUUsQ0FBQyxDQUFDLFFBQVE7b0JBQ2pCLFlBQVksRUFBRSxtQkFBbUIsQ0FBQyxHQUFHLENBQUM7b0JBQ3RDLEtBQUssRUFBRSxDQUFDLENBQUMsS0FBSztpQkFDakIsRUFDRCxzQ0FBc0MsQ0FDekMsQ0FBQztnQkFDRixPQUFPLEtBQUssQ0FBQzthQUNoQjtZQUNELE9BQU8sSUFBSSxDQUFDO1FBQ2hCLENBQUMsQ0FBQztLQUNMO0lBRUQsTUFBTSxxQkFBcUIsR0FBRyxnQkFBZ0IsR0FBRyx5QkFBYSxDQUFDO0lBQy9ELE1BQU0sWUFBWSxHQUFHLE1BQU07U0FDdEIsTUFBTSxDQUFDLHdCQUF3QixDQUFDO1NBQ2hDLE1BQU0sQ0FBQyxDQUFDLENBQUMsRUFBRSxFQUFFLENBQUMsYUFBYSxDQUFDLENBQUMsQ0FBQyxLQUFLLFVBQVUsSUFBSSxhQUFhLENBQUMsQ0FBQyxDQUFDLEtBQUssVUFBVSxDQUFDO1NBQ2pGLE1BQU0sQ0FBQyxDQUFDLENBQUMsRUFBRSxFQUFFO1FBQ1YsTUFBTSxlQUFlLEdBQUcsU0FBUyxDQUFDLENBQUMsQ0FBQyxjQUFjLENBQUMsQ0FBQyxDQUFDLENBQUMsQ0FBQyxDQUFDLGNBQWMsQ0FBQyxDQUFDLENBQUMsQ0FBQztRQUMxRSxPQUFPLGVBQWUsQ0FBQyxFQUFFLENBQUMsZUFBZSxDQUFDLENBQUM7SUFDL0MsQ0FBQyxDQUFDO1NBQ0QsTUFBTSxDQUFDLENBQUMsQ0FBQyxFQUFFLEVBQUUsQ0FBQyxDQUFDLGlCQUFpQixDQUFDLENBQUMsRUFBRSxxQkFBcUIsQ0FBQyxDQUFDO1NBQzNELElBQUksQ0FBQyxDQUFDLENBQUMsRUFBRSxDQUFDLEVBQUUsRUFBRTtRQUNYLDREQUE0RDtRQUM1RCxNQUFNLE1BQU0sR0FBRyxjQUFjLENBQUMsQ0FBQyxDQUFDLENBQUMsR0FBRyxDQUFDLGNBQWMsQ0FBQyxDQUFDLENBQUMsQ0FBQyxDQUFDO1FBQ3hELE1BQU0sTUFBTSxHQUFHLGNBQWMsQ0FBQyxDQUFDLENBQUMsQ0FBQyxHQUFHLENBQUMsY0FBYyxDQUFDLENBQUMsQ0FBQyxDQUFDLENBQUM7UUFDeEQsT0FBTyxNQUFNLENBQUMsS0FBSyxDQUFDLE1BQU0sQ0FBQyxDQUFDLFFBQVEsRUFBRSxDQUFDO0lBQzNDLENBQUMsQ0FBQyxDQUFDO0lBRVAsa0JBQWtCO0lBQ2xCLElBQUksWUFBWSxDQUFDLE1BQU0sS0FBSyxDQUFDLEVBQUU7UUFDM0IsT0FBTyxJQUFJLENBQUM7S0FDZjtJQUVELHFCQUFxQjtJQUNyQixPQUFPLFlBQVksQ0FBQyxDQUFDLENBQUMsQ0FBQztBQUMzQixDQUFDO0FBNURELG9DQTREQztBQUVELDRCQUE0QjtBQUU1QixNQUFNLGFBQWEsR0FBRyxDQUFDLEtBQTBDLEVBQVUsRUFBRTtJQUN6RSxPQUFPLFdBQVcsQ0FBQyxLQUFLLENBQUMsQ0FBQyxDQUFDLENBQUMsS0FBSyxDQUFDLEtBQUssQ0FBQyxVQUFVLENBQUMsQ0FBQyxDQUFDLEtBQUssQ0FBQyxVQUFVLENBQUM7QUFDMUUsQ0FBQyxDQUFDO0FBRUYsTUFBTSxhQUFhLEdBQUcsQ0FBQyxLQUEwQyxFQUFVLEVBQUU7SUFDekUsT0FBTyxXQUFXLENBQUMsS0FBSyxDQUFDLENBQUMsQ0FBQyxDQUFDLEtBQUssQ0FBQyxLQUFLLENBQUMsVUFBVSxDQUFDLENBQUMsQ0FBQyxLQUFLLENBQUMsVUFBVSxDQUFDO0FBQzFFLENBQUMsQ0FBQztBQUVGLE1BQU0sY0FBYyxHQUFHLENBQUMsS0FBMEMsRUFBYSxFQUFFO0lBQzdFLE9BQU8sV0FBVyxDQUFDLEtBQUssQ0FBQyxDQUFDLENBQUMsQ0FBQyxLQUFLLENBQUMsS0FBSyxDQUFDLFdBQVcsQ0FBQyxDQUFDLENBQUMsS0FBSyxDQUFDLFdBQVcsQ0FBQztBQUM1RSxDQUFDLENBQUM7QUFFRixNQUFNLGNBQWMsR0FBRyxDQUFDLEtBQTBDLEVBQWEsRUFBRTtJQUM3RSxPQUFPLFdBQVcsQ0FBQyxLQUFLLENBQUMsQ0FBQyxDQUFDLENBQUMsS0FBSyxDQUFDLEtBQUssQ0FBQyxXQUFXLENBQUMsQ0FBQyxDQUFDLEtBQUssQ0FBQyxXQUFXLENBQUM7QUFDNUUsQ0FBQyxDQUFDO0FBRUYsTUFBTSxpQkFBaUIsR0FBRyxDQUFDLEtBQTBDLEVBQUUsY0FBc0IsRUFBVyxFQUFFO0lBQ3RHLElBQUksV0FBVyxDQUFDLEtBQUssQ0FBQyxFQUFFO1FBQ3BCLE9BQU8sS0FBSyxDQUFDLEtBQUssQ0FBQyxVQUFVLENBQUMsY0FBYyxDQUFDLENBQUM7S0FDakQ7SUFFRCwwQkFBMEI7SUFDMUIsTUFBTSxVQUFVLEdBQUcsSUFBSSxpQkFBUyxDQUFDLElBQUksQ0FBQyxHQUFHLEVBQUUsQ0FBQyxDQUFDLEdBQUcsQ0FBQyx5QkFBYSxDQUFDLENBQUM7SUFDaEUsTUFBTSxnQkFBZ0IsR0FBRyxVQUFVLENBQUMsSUFBSSxDQUFDLGNBQWMsQ0FBQyxDQUFDO0lBQ3pELE9BQU8sS0FBSyxDQUFDLE1BQU0sQ0FBQyxFQUFFLENBQUMsZ0JBQWdCLENBQUMsQ0FBQztBQUM3QyxDQUFDLENBQUM7QUFFRixNQUFNLFdBQVcsR0FBRyxDQUFDLEtBQTBDLEVBQXlCLEVBQUU7SUFDdEYsT0FBUSxLQUFzQixDQUFDLEtBQUssS0FBSyxTQUFTLENBQUM7QUFDdkQsQ0FBQyxDQUFDIiwibmFtZXMiOltdLCJzb3VyY2VzIjpbIi9Vc2Vycy9kYXZpZHdhbHNoL2NvZGUtbG9jYWwvMHgtcmZxLWFwaS9zcmMvdXRpbHMvcXVvdGVfY29tcGFyaXNvbl91dGlscy50cyJdLCJzb3VyY2VzQ29udGVudCI6WyJpbXBvcnQgeyBDb3VudGVyIH0gZnJvbSAncHJvbS1jbGllbnQnO1xuXG5pbXBvcnQgeyBPTkVfU0VDT05EX01TIH0gZnJvbSAnLi4vY29yZS9jb25zdGFudHMnO1xuaW1wb3J0IHsgbG9nZ2VyIH0gZnJvbSAnLi4vbG9nZ2VyJztcbmltcG9ydCB7IEZpcm1PdGNRdW90ZSwgSW5kaWNhdGl2ZVF1b3RlIH0gZnJvbSAnLi4vY29yZS90eXBlcyc7XG5cbmltcG9ydCB7IHRvUGFpclN0cmluZyB9IGZyb20gJy4uL2NvcmUvcGFpcl91dGlscyc7XG5pbXBvcnQgeyBCaWdOdW1iZXIgfSBmcm9tICdAMHgvdXRpbHMnO1xuaW1wb3J0IHsgVjRSRlFJbmRpY2F0aXZlUXVvdGUgfSBmcm9tICcuLi9xdW90ZS1zZXJ2ZXIvdHlwZXMnO1xuXG5jb25zdCBSRlFNX01BS0VSX0JMT0NLRURfRk9SX0xPV19NQUtFUl9CQUxBTkNFID0gbmV3IENvdW50ZXIoe1xuICAgIG5hbWU6ICdyZnFtX21ha2VyX2Jsb2NrZWRfZm9yX2xvd19tYWtlcl9iYWxhbmNlJyxcbiAgICBoZWxwOiAnQSBtYWtlciBnZXQgYmxvY2tlZCBiZWNhdXNlIG9mIGxvdyBtYWtlciBiYWxhbmNlJyxcbiAgICBsYWJlbE5hbWVzOiBbJ21ha2VyX3VyaScsICdjaGFpbl9pZCcsICdwYWlyX2tleSddLFxufSk7XG5cbi8qKlxuICogU2VsZWN0cyB0aGUgYmVzdCBxdW90ZSBmcm9tIGFuIGFycmF5IG9mIHF1b3Rlcy5cbiAqXG4gKiBJZ25vcmVzIHF1b3RlcyB0aGF0OlxuICogIC0gYXJlIGZvciB0aGUgd3JvbmcgcGFpclxuICogIC0gY2Fubm90IGZpbGwgMTAwJSBvZiB0aGUgcmVxdWVzdGVkIGFtb3VudFxuICogIC0gZXhwaXJlIGluIGxlc3MgdGhhbiB0aGUgdmFsaWRpdHkgd2luZG93XG4gKiAgLSBjYW5ub3QgYmUgZmlsbGVkIGJ5IHRoZSBtYWtlciBkdWUgdG8gaW5zdWZmaWNpZW50IGJhbGFuY2VzLCBpZiBxdW90ZWRNYWtlckJhbGFuY2VzIGlzIHByZXNlbnRcbiAqICAgICAgKG9ubHkgZm9yIGZpcm0gcXVvdGVzKVxuICpcbiAqIEFuZCBzZWxlY3RzIHRoZSBvbmUgd2l0aCB0aGUgYmVzdCBwcmljZS5cbiAqL1xuZXhwb3J0IGZ1bmN0aW9uIGdldEJlc3RRdW90ZTxUIGV4dGVuZHMgSW5kaWNhdGl2ZVF1b3RlIHwgRmlybU90Y1F1b3RlPihcbiAgICBxdW90ZXM6IFRbXSxcbiAgICBpc1NlbGxpbmc6IGJvb2xlYW4sXG4gICAgdGFrZXJUb2tlbjogc3RyaW5nLFxuICAgIG1ha2VyVG9rZW46IHN0cmluZyxcbiAgICBhc3NldEZpbGxBbW91bnQ6IEJpZ051bWJlcixcbiAgICB2YWxpZGl0eVdpbmRvd01zOiBudW1iZXIsXG4gICAgcXVvdGVkTWFrZXJCYWxhbmNlcz86IEJpZ051bWJlcltdLFxuKTogVCB8IG51bGwge1xuICAgIC8vIElmIG1ha2VyIGJhbGFuY2VzIGFyZSBwcm92aWRlZCwgcXVvdGVzIGluIHdoaWNoIG1ha2VyIGFkZHJlc3NlcyBjYW5ub3QgcHJvdmlkZSBzdWZmaWNpZW50XG4gICAgLy8gYmFsYW5jZXMgdG8gZnVsbHkgZmlsbCB0aGUgb3JkZXIgYXJlIGZpbHRlcmVkIG91dFxuICAgIGxldCBpc01ha2VyRmlsbGFibGVQcmVkaWNhdGUgPSAoX3E6IFQsIF9pZHg6IG51bWJlcikgPT4gdHJ1ZTtcbiAgICBpZiAocXVvdGVkTWFrZXJCYWxhbmNlcykge1xuICAgICAgICBpZiAocXVvdGVzLmxlbmd0aCAhPT0gcXVvdGVkTWFrZXJCYWxhbmNlcy5sZW5ndGgpIHtcbiAgICAgICAgICAgIHRocm93IG5ldyBFcnJvcignUXVvdGVzIGRvIG5vdCBtYXRjaCB3aXRoIHByb3ZpZGVkIG1ha2VyIGJhbGFuY2VzJyk7XG4gICAgICAgIH1cbiAgICAgICAgaXNNYWtlckZpbGxhYmxlUHJlZGljYXRlID0gKHE6IFQsIGlkeDogbnVtYmVyKSA9PiB7XG4gICAgICAgICAgICBpZiAoaXNGaXJtUXVvdGUocSkgJiYgcS5vcmRlci5tYWtlckFtb3VudC5ndChxdW90ZWRNYWtlckJhbGFuY2VzW2lkeF0pKSB7XG4gICAgICAgICAgICAgICAgUkZRTV9NQUtFUl9CTE9DS0VEX0ZPUl9MT1dfTUFLRVJfQkFMQU5DRS5sYWJlbHMoXG4gICAgICAgICAgICAgICAgICAgIHEubWFrZXJVcmksXG4gICAgICAgICAgICAgICAgICAgIHEub3JkZXIuY2hhaW5JZC50b1N0cmluZygpLFxuICAgICAgICAgICAgICAgICAgICB0b1BhaXJTdHJpbmcoZ2V0TWFrZXJUb2tlbihxKSwgZ2V0VGFrZXJUb2tlbihxKSksXG4gICAgICAgICAgICAgICAgKS5pbmMoKTtcbiAgICAgICAgICAgICAgICBsb2dnZXIud2FybihcbiAgICAgICAgICAgICAgICAgICAge1xuICAgICAgICAgICAgICAgICAgICAgICAgbWFrZXI6IHEubWFrZXJVcmksXG4gICAgICAgICAgICAgICAgICAgICAgICBtYWtlckJhbGFuY2U6IHF1b3RlZE1ha2VyQmFsYW5jZXNbaWR4XSxcbiAgICAgICAgICAgICAgICAgICAgICAgIG9yZGVyOiBxLm9yZGVyLFxuICAgICAgICAgICAgICAgICAgICB9LFxuICAgICAgICAgICAgICAgICAgICAnUXVvdGUgaGFzIGluc3VmZmljaWVudCBtYWtlciBiYWxhbmNlJyxcbiAgICAgICAgICAgICAgICApO1xuICAgICAgICAgICAgICAgIHJldHVybiBmYWxzZTtcbiAgICAgICAgICAgIH1cbiAgICAgICAgICAgIHJldHVybiB0cnVlO1xuICAgICAgICB9O1xuICAgIH1cblxuICAgIGNvbnN0IHZhbGlkaXR5V2luZG93U2Vjb25kcyA9IHZhbGlkaXR5V2luZG93TXMgLyBPTkVfU0VDT05EX01TO1xuICAgIGNvbnN0IHNvcnRlZFF1b3RlcyA9IHF1b3Rlc1xuICAgICAgICAuZmlsdGVyKGlzTWFrZXJGaWxsYWJsZVByZWRpY2F0ZSlcbiAgICAgICAgLmZpbHRlcigocSkgPT4gZ2V0VGFrZXJUb2tlbihxKSA9PT0gdGFrZXJUb2tlbiAmJiBnZXRNYWtlclRva2VuKHEpID09PSBtYWtlclRva2VuKVxuICAgICAgICAuZmlsdGVyKChxKSA9PiB7XG4gICAgICAgICAgICBjb25zdCByZXF1ZXN0ZWRBbW91bnQgPSBpc1NlbGxpbmcgPyBnZXRUYWtlckFtb3VudChxKSA6IGdldE1ha2VyQW1vdW50KHEpO1xuICAgICAgICAgICAgcmV0dXJuIHJlcXVlc3RlZEFtb3VudC5lcShhc3NldEZpbGxBbW91bnQpO1xuICAgICAgICB9KVxuICAgICAgICAuZmlsdGVyKChxKSA9PiAhd2lsbFF1b3RlRXhwaXJlSW4ocSwgdmFsaWRpdHlXaW5kb3dTZWNvbmRzKSlcbiAgICAgICAgLnNvcnQoKGEsIGIpID0+IHtcbiAgICAgICAgICAgIC8vIFdhbnQgdGhlIG1vc3QgYW1vdW50IG9mIG1ha2VyIHRva2VucyBmb3IgZWFjaCB0YWtlciB0b2tlblxuICAgICAgICAgICAgY29uc3QgYVByaWNlID0gZ2V0TWFrZXJBbW91bnQoYSkuZGl2KGdldFRha2VyQW1vdW50KGEpKTtcbiAgICAgICAgICAgIGNvbnN0IGJQcmljZSA9IGdldE1ha2VyQW1vdW50KGIpLmRpdihnZXRUYWtlckFtb3VudChiKSk7XG4gICAgICAgICAgICByZXR1cm4gYlByaWNlLm1pbnVzKGFQcmljZSkudG9OdW1iZXIoKTtcbiAgICAgICAgfSk7XG5cbiAgICAvLyBObyBxdW90ZXMgZm91bmRcbiAgICBpZiAoc29ydGVkUXVvdGVzLmxlbmd0aCA9PT0gMCkge1xuICAgICAgICByZXR1cm4gbnVsbDtcbiAgICB9XG5cbiAgICAvLyBHZXQgdGhlIGJlc3QgcXVvdGVcbiAgICByZXR1cm4gc29ydGVkUXVvdGVzWzBdO1xufVxuXG4vLy8gUHJpdmF0ZSBnZXR0ZXIgZnVuY3Rpb25zXG5cbmNvbnN0IGdldFRha2VyVG9rZW4gPSAocXVvdGU6IFY0UkZRSW5kaWNhdGl2ZVF1b3RlIHwgRmlybU90Y1F1b3RlKTogc3RyaW5nID0+IHtcbiAgICByZXR1cm4gaXNGaXJtUXVvdGUocXVvdGUpID8gcXVvdGUub3JkZXIudGFrZXJUb2tlbiA6IHF1b3RlLnRha2VyVG9rZW47XG59O1xuXG5jb25zdCBnZXRNYWtlclRva2VuID0gKHF1b3RlOiBWNFJGUUluZGljYXRpdmVRdW90ZSB8IEZpcm1PdGNRdW90ZSk6IHN0cmluZyA9PiB7XG4gICAgcmV0dXJuIGlzRmlybVF1b3RlKHF1b3RlKSA/IHF1b3RlLm9yZGVyLm1ha2VyVG9rZW4gOiBxdW90ZS5tYWtlclRva2VuO1xufTtcblxuY29uc3QgZ2V0VGFrZXJBbW91bnQgPSAocXVvdGU6IFY0UkZRSW5kaWNhdGl2ZVF1b3RlIHwgRmlybU90Y1F1b3RlKTogQmlnTnVtYmVyID0+IHtcbiAgICByZXR1cm4gaXNGaXJtUXVvdGUocXVvdGUpID8gcXVvdGUub3JkZXIudGFrZXJBbW91bnQgOiBxdW90ZS50YWtlckFtb3VudDtcbn07XG5cbmNvbnN0IGdldE1ha2VyQW1vdW50ID0gKHF1b3RlOiBWNFJGUUluZGljYXRpdmVRdW90ZSB8IEZpcm1PdGNRdW90ZSk6IEJpZ051bWJlciA9PiB7XG4gICAgcmV0dXJuIGlzRmlybVF1b3RlKHF1b3RlKSA/IHF1b3RlLm9yZGVyLm1ha2VyQW1vdW50IDogcXVvdGUubWFrZXJBbW91bnQ7XG59O1xuXG5jb25zdCB3aWxsUXVvdGVFeHBpcmVJbiA9IChxdW90ZTogVjRSRlFJbmRpY2F0aXZlUXVvdGUgfCBGaXJtT3RjUXVvdGUsIHNlY29uZHNGcm9tTm93OiBudW1iZXIpOiBib29sZWFuID0+IHtcbiAgICBpZiAoaXNGaXJtUXVvdGUocXVvdGUpKSB7XG4gICAgICAgIHJldHVybiBxdW90ZS5vcmRlci53aWxsRXhwaXJlKHNlY29uZHNGcm9tTm93KTtcbiAgICB9XG5cbiAgICAvLyBIYW5kbGUgaW5kaWNhdGl2ZSBxdW90ZVxuICAgIGNvbnN0IG5vd1NlY29uZHMgPSBuZXcgQmlnTnVtYmVyKERhdGUubm93KCkpLmRpdihPTkVfU0VDT05EX01TKTtcbiAgICBjb25zdCBleHBpcmF0aW9uQ3V0b2ZmID0gbm93U2Vjb25kcy5wbHVzKHNlY29uZHNGcm9tTm93KTtcbiAgICByZXR1cm4gcXVvdGUuZXhwaXJ5Lmx0KGV4cGlyYXRpb25DdXRvZmYpO1xufTtcblxuY29uc3QgaXNGaXJtUXVvdGUgPSAocXVvdGU6IFY0UkZRSW5kaWNhdGl2ZVF1b3RlIHwgRmlybU90Y1F1b3RlKTogcXVvdGUgaXMgRmlybU90Y1F1b3RlID0+IHtcbiAgICByZXR1cm4gKHF1b3RlIGFzIEZpcm1PdGNRdW90ZSkub3JkZXIgIT09IHVuZGVmaW5lZDtcbn07XG4iXSwidmVyc2lvbiI6M30=