{"file":"/Users/davidwalsh/code-local/0x-rfq-api/src/background-jobs/maker_balance_cache_evict.ts","mappings":"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","names":[],"sources":["/Users/davidwalsh/code-local/0x-rfq-api/src/background-jobs/maker_balance_cache_evict.ts"],"sourcesContent":["// tslint:disable:custom-no-magic-numbers\nimport { Job, Queue } from 'bullmq';\nimport { Counter } from 'prom-client';\n\nimport { CHAIN_CONFIGURATIONS } from '../config';\nimport { logger } from '../logger';\nimport { buildRfqMakerBalanceCacheServiceAsync } from '../utils/rfqm_service_builder';\n\nimport { BackgroundJobBlueprint } from './blueprint';\n\nconst QUEUE_NAME = 'maker-balance-cache-evict';\n// keep successful job history for 1 day\nconst REMOVE_ON_COMPLETE_OPS = {\n    count: 24 * 60 * 0.5,\n};\n// keep failed job history for 3 days\nconst REMOVE_ON_FAILURE_OPS = {\n    count: 3 * 24 * 60 * 0.5,\n};\nconst MAKER_BALANCE_CACHE_EVICT_SCHEDULE = '*/2 * * * *'; // job will be scheduled at every 2 minutes\nconst DESCRIPTION = 'Periodically evicts stale entries from maker balance cache.';\n\nexport interface BackgroundJobMBCEvictData {\n    chainId: number;\n    timestamp: number;\n}\n\nexport interface BackgroundJobMBCEvictResult {\n    chainId: number;\n    jobName: string;\n    numEvicted: number;\n    timestamp: number;\n}\n\nconst backgroundJobMBCEvict: BackgroundJobBlueprint<BackgroundJobMBCEvictData, BackgroundJobMBCEvictResult> = {\n    queueName: QUEUE_NAME,\n    schedule: MAKER_BALANCE_CACHE_EVICT_SCHEDULE,\n    description: DESCRIPTION,\n    createAsync,\n    processAsync,\n};\n// tslint:disable-next-line: no-default-export\nexport default backgroundJobMBCEvict;\n\nconst MAKER_BALANCE_CACHE_EVICT_PROCESS_COUNT = new Counter({\n    name: 'rfq_background_job_mbc_evict_process_total',\n    help: 'Number of times the processor method of the maker balance cache evict background job is triggered',\n});\n\n/**\n * Creates a background job by queues a message that performs an eviction on the maker balance cache.\n *\n * @param queue Queue to push the message.\n * @param data Necessary data for processor to execute the background job.\n * @returns Promise of the background job.\n */\nasync function createAsync(\n    queue: Queue,\n    data: BackgroundJobMBCEvictData,\n): Promise<Job<BackgroundJobMBCEvictData, BackgroundJobMBCEvictResult>> {\n    logger.info({ queue: QUEUE_NAME, data }, 'Creating the maker balance cache background job on queue');\n    return queue.add(`${QUEUE_NAME}.${data.timestamp}`, data, {\n        removeOnComplete: REMOVE_ON_COMPLETE_OPS,\n        removeOnFail: REMOVE_ON_FAILURE_OPS,\n    });\n}\n\n/**\n * Processor method for the maker balance cache evict job. Evicts entries with zero balances from the cache.\n *\n * @param job Maker balance cache evict background job.\n * @returns Result of the evict background job.\n */\nasync function processAsync(\n    job: Job<BackgroundJobMBCEvictData, BackgroundJobMBCEvictResult>,\n): Promise<BackgroundJobMBCEvictResult> {\n    await job.updateProgress(0);\n    logger.info(\n        { jobName: job.name, queue: job.queueName, data: job.data, timestamp: Date.now() },\n        'Processing the maker balance cache evict background job on queue',\n    );\n\n    const chainId = job.data.chainId;\n\n    // Build dependencies\n    const chain = CHAIN_CONFIGURATIONS.find((c) => c.chainId === chainId);\n    if (!chain) {\n        throw new Error(`Tried to start background job process for chain ${chainId}\n        but no chain configuration was present`);\n    }\n    const rfqMakerBalanceCacheService = await buildRfqMakerBalanceCacheServiceAsync(chain);\n    if (!rfqMakerBalanceCacheService) {\n        logger.error(\n            { jobName: job.name, queue: job.queueName, data: job.data, timestamp: Date.now() },\n            'Failed to initialize dependencies for maker-balance-cache-evict',\n        );\n        throw new Error('Failed to initialize dependencies for maker-balance-cache-evict');\n    }\n    await job.updateProgress(50);\n\n    // Perform eviction on maker balance cache entries\n    let numEvicted;\n    try {\n        numEvicted = await rfqMakerBalanceCacheService.evictZeroBalancesAsync(chainId);\n        MAKER_BALANCE_CACHE_EVICT_PROCESS_COUNT.inc();\n    } catch (error) {\n        logger.error(\n            { jobName: job.name, queue: job.queueName, data: job.data, timestamp: Date.now() },\n            'Failed to evict maker balance cache while running scheduled background job',\n        );\n        throw new Error('Failed to evict maker balance cache while running scheduled background job');\n    } finally {\n        await rfqMakerBalanceCacheService.closeAsync();\n    }\n\n    await job.updateProgress(100);\n    return {\n        chainId,\n        jobName: job.name,\n        numEvicted,\n        timestamp: Date.now(),\n    };\n}\n"],"version":3}