68d71ca40c867aa79c7fc2ff54401280
"use strict";
Object.defineProperty(exports, "__esModule", { value: true });
exports.RfqtHandlers = void 0;
const types_1 = require("@0x/types");
const utils_1 = require("@0x/utils");
const HttpStatus = require("http-status-codes");
const prom_client_1 = require("prom-client");
const logger_1 = require("../logger");
const RFQT_V1_PRICE_REQUEST_SUCCEEDED = new prom_client_1.Counter({
    name: 'rfqt_v1_price_request_succeeded_total',
    help: 'Request made to fetch rfqt v1 price succeeded',
});
const RFQT_V1_PRICE_REQUEST_FAILED = new prom_client_1.Counter({
    name: 'rfqt_v1_price_request_failed_total',
    help: 'Request made to fetch rfqt v1 price failed',
});
const RFQT_V1_QUOTE_REQUEST_SUCCEEDED = new prom_client_1.Counter({
    name: 'rfqt_v1_quote_request_succeeded_total',
    help: 'Request to fetch rfqt v1 quote succeeded',
});
const RFQT_V1_QUOTE_REQUEST_FAILED = new prom_client_1.Counter({
    name: 'rfqt_v1_quote_request_failed_total',
    help: 'Request to fetch rfqt v1 quote failed',
});
const RFQT_V2_PRICE_REQUEST_SUCCEEDED = new prom_client_1.Counter({
    name: 'rfqt_v2_price_request_succeeded_total',
    help: 'Request made to fetch rfqt v2 price succeeded',
});
const RFQT_V2_PRICE_REQUEST_FAILED = new prom_client_1.Counter({
    name: 'rfqt_v2_price_request_failed_total',
    help: 'Request made to fetch rfqt v2 price failed',
});
const RFQT_V2_QUOTE_REQUEST_SUCCEEDED = new prom_client_1.Counter({
    name: 'rfqt_v2_quote_request_succeeded_total',
    help: 'Request to fetch rfqt v2 quote succeeded',
});
const RFQT_V2_QUOTE_REQUEST_FAILED = new prom_client_1.Counter({
    name: 'rfqt_v2_quote_request_failed_total',
    help: 'Request to fetch rfqt v2 quote failed',
});
/**
 * Handles parsing the request from RFQt routes, meters calls with prometheus counters,
 * calls the appropriate service method and returns the result.
 *
 * Error boundary for http calls; all errors should be caught and returned to the
 * caller as part of the response.
 */
class RfqtHandlers {
    constructor(_rfqtServices, _configManager) {
        this._rfqtServices = _rfqtServices;
        this._configManager = _configManager;
    }
    /**
     * Gets prices ("indicative quotes") for the given asset pair from market makers
     * operating on the `RfqOrder` RFQt platform
     */
    async getV1PricesAsync(req, 
    // $eslint-fix-me https://github.com/rhinodavid/eslint-fix-me
    // eslint-disable-next-line @typescript-eslint/no-explicit-any
    res) {
        let parsedParameters;
        let service;
        try {
            parsedParameters = this._parseV1RequestParameters(req);
            service = this._getServiceForChain(parsedParameters.chainId);
        }
        catch (error) {
            RFQT_V1_PRICE_REQUEST_FAILED.inc();
            logger_1.logger.error({ error: error.message }, 'Rfqt V1 price request failed');
            res.status(HttpStatus.BAD_REQUEST).json({ error: error.message });
            return;
        }
        try {
            const prices = await service.getV1PricesAsync(parsedParameters);
            RFQT_V1_PRICE_REQUEST_SUCCEEDED.inc();
            logger_1.logger.info('Rfqt V1 price request succeeded');
            res.status(HttpStatus.OK).json({
                prices,
            });
        }
        catch (error) {
            RFQT_V1_PRICE_REQUEST_FAILED.inc();
            logger_1.logger.error({ error: error.message }, 'Rfqt V1 price request failed');
            res.status(HttpStatus.INTERNAL_SERVER_ERROR).json({ error: error.message });
        }
    }
    /**
     * Gets prices ("firm quotes") for the given asset pair from market makers
     * operating on the `RfqOrder` RFQt platform
     */
    async getV1QuotesAsync(req, 
    // $eslint-fix-me https://github.com/rhinodavid/eslint-fix-me
    // eslint-disable-next-line @typescript-eslint/no-explicit-any
    res) {
        let parsedParameters;
        let service;
        let txOrigin;
        try {
            parsedParameters = this._parseV1RequestParameters(req);
            if (parsedParameters.txOrigin === undefined) {
                throw new Error('Received request with missing parameter txOrigin');
            }
            txOrigin = parsedParameters.txOrigin;
            service = this._getServiceForChain(parsedParameters.chainId);
        }
        catch (error) {
            RFQT_V1_QUOTE_REQUEST_FAILED.inc();
            logger_1.logger.error({ error }, 'Rfqt V1 quote request failed');
            res.status(HttpStatus.BAD_REQUEST).json({ error });
            return;
        }
        try {
            const quotes = await service.getV1QuotesAsync({
                ...parsedParameters,
                txOrigin,
            });
            RFQT_V1_QUOTE_REQUEST_SUCCEEDED.inc();
            logger_1.logger.info('Rfqt V1 quote request succeeded');
            res.status(HttpStatus.OK).json({
                quotes,
            });
        }
        catch (error) {
            RFQT_V1_QUOTE_REQUEST_FAILED.inc();
            logger_1.logger.error({ error }, 'Rfqt V1 quote request failed');
            res.status(HttpStatus.INTERNAL_SERVER_ERROR).json({ error: error.message });
        }
    }
    /**
     * Gets prices ("indicative quotes") for the given asset pair from market makers
     * operating on the `OtcOrder` RFQt platform
     */
    async getV2PricesAsync(req, 
    // $eslint-fix-me https://github.com/rhinodavid/eslint-fix-me
    // eslint-disable-next-line @typescript-eslint/no-explicit-any
    res) {
        let quoteContext;
        let service;
        try {
            const chainId = this._extractChainId(req);
            service = this._getServiceForChain(chainId);
            quoteContext = await this._extractQuoteContextAsync(req, chainId, false, service);
        }
        catch (error) {
            RFQT_V2_PRICE_REQUEST_FAILED.inc();
            logger_1.logger.error({ error: error.message }, 'Rfqt V2 price request failed');
            res.status(HttpStatus.BAD_REQUEST).json({ error: error.message });
            return;
        }
        try {
            const prices = await service.getV2PricesAsync(quoteContext);
            RFQT_V2_PRICE_REQUEST_SUCCEEDED.inc();
            logger_1.logger.info('Rfqt V2 price request succeeded');
            res.status(HttpStatus.OK).json({
                prices,
            });
        }
        catch (error) {
            RFQT_V2_PRICE_REQUEST_FAILED.inc();
            logger_1.logger.error({ error: error.message }, 'Rfqt V2 price request failed');
            res.status(HttpStatus.INTERNAL_SERVER_ERROR).json({ error: error.message });
        }
    }
    /**
     * Gets quotes ("firm quotes") for the given asset pair from market makers
     * operating on the `OtcOrder` RFQt platform
     */
    async getV2QuotesAsync(req, 
    // $eslint-fix-me https://github.com/rhinodavid/eslint-fix-me
    // eslint-disable-next-line @typescript-eslint/no-explicit-any
    res) {
        let quoteContext;
        let service;
        try {
            const chainId = this._extractChainId(req);
            service = this._getServiceForChain(chainId);
            quoteContext = (await this._extractQuoteContextAsync(req, chainId, true, service));
        }
        catch (error) {
            RFQT_V2_QUOTE_REQUEST_FAILED.inc();
            logger_1.logger.error({ error }, 'Rfqt V2 quote request failed');
            res.status(HttpStatus.BAD_REQUEST).json({ error });
            return;
        }
        try {
            const quotes = await service.getV2QuotesAsync(quoteContext);
            RFQT_V2_QUOTE_REQUEST_SUCCEEDED.inc();
            logger_1.logger.info('Rfqt V2 quote request succeeded');
            res.status(HttpStatus.OK).json({
                quotes,
            });
        }
        catch (error) {
            RFQT_V2_QUOTE_REQUEST_FAILED.inc();
            logger_1.logger.error({ error }, 'Rfqt V2 quote request failed');
            res.status(HttpStatus.INTERNAL_SERVER_ERROR).json({ error: error.message });
        }
    }
    /**
     * Parses and runtime-checks request parameters. After running the method, the parameters
     * should match their TypeScript types.
     */
    _parseV1RequestParameters(request) {
        const { body } = request;
        // Doing this before destructuring the body, otherwise the error
        // thrown will be something like:
        // 'Cannot destructure property 'altRfqAssetOfferings' of 'request.body' as it is undefined.'
        if (!body.altRfqAssetOfferings ||
            !body.assetFillAmount ||
            !body.makerToken ||
            !body.marketOperation ||
            !body.takerToken ||
            !body.takerAddress ||
            typeof body.intentOnFilling !== 'boolean' ||
            !body.integratorId) {
            throw new Error('Received request with missing parameters');
        }
        const { assetFillAmount, comparisonPrice, marketOperation, integratorId } = request.body;
        const parsedChainId = this._extractChainId(request);
        if (Number.isNaN(parsedChainId)) {
            throw new Error('Chain ID is invalid');
        }
        if (marketOperation !== types_1.MarketOperation.Buy.toString() &&
            marketOperation !== types_1.MarketOperation.Sell.toString()) {
            throw new Error('Received request with invalid market operation');
        }
        let integrator;
        try {
            integrator = this._configManager.getIntegratorByIdOrThrow(integratorId);
        }
        catch (error) {
            throw new Error('No integrator found for integrator ID');
        }
        return {
            ...request.body,
            assetFillAmount: new utils_1.BigNumber(assetFillAmount),
            chainId: parsedChainId,
            comparisonPrice: comparisonPrice ? new utils_1.BigNumber(comparisonPrice) : undefined,
            integrator,
        };
    }
    /**
     * Extract chainId from request parameters.
     */
    _extractChainId(request) {
        const chainIdFromHeader = request.header('0x-chain-id');
        if (chainIdFromHeader === undefined) {
            throw new Error('Chain ID is not provided');
        }
        else {
            const parsedChainId = parseInt(chainIdFromHeader, 10);
            if (Number.isNaN(parsedChainId)) {
                throw new Error('Chain ID is invalid');
            }
            return parsedChainId;
        }
    }
    /**
     * Extract quote context from request parameters. After running the method, the parameters
     * should match their TypeScript types.
     */
    async _extractQuoteContextAsync(request, chainId, isFirm, service) {
        const { body } = request;
        // Doing this before destructuring the body, otherwise the error
        // thrown will be something like:
        // 'Cannot destructure property 'assetFillAmount' of 'request.body' as it is undefined.'
        if (!body.assetFillAmount ||
            !body.makerToken ||
            !body.marketOperation ||
            !body.takerToken ||
            !body.takerAddress ||
            // TODO: add body.trader to these checks once we've rolled out completely
            typeof body.intentOnFilling !== 'boolean' ||
            !body.integratorId) {
            throw new Error('Received request with missing parameters');
        }
        const { takerToken, makerToken, trader, gasless, takerAddress, txOrigin, assetFillAmount: assetFillAmountStr, marketOperation, integratorId, } = request.body;
        if (marketOperation !== types_1.MarketOperation.Buy.toString() &&
            marketOperation !== types_1.MarketOperation.Sell.toString()) {
            throw new Error('Received request with invalid market operation');
        }
        let integrator;
        try {
            integrator = this._configManager.getIntegratorByIdOrThrow(integratorId);
        }
        catch (error) {
            throw new Error('No integrator found for integrator ID');
        }
        if (isFirm && txOrigin === undefined) {
            throw new Error('Received request with missing parameter txOrigin');
        }
        const isSelling = marketOperation === types_1.MarketOperation.Sell.toString();
        const assetFillAmount = new utils_1.BigNumber(assetFillAmountStr);
        let takerAmount, makerAmount;
        if (isSelling) {
            takerAmount = assetFillAmount;
        }
        else {
            makerAmount = assetFillAmount;
        }
        const takerTokenDecimals = await service.getTokenDecimalsAsync(takerToken);
        const makerTokenDecimals = await service.getTokenDecimalsAsync(makerToken);
        return {
            workflow: gasless ? 'gasless-rfqt' : 'rfqt',
            chainId,
            isFirm,
            takerToken,
            makerToken,
            originalMakerToken: makerToken,
            trader,
            takerAddress,
            txOrigin,
            takerAmount,
            makerAmount,
            takerTokenDecimals,
            makerTokenDecimals,
            integrator,
            isUnwrap: false,
            isSelling,
            assetFillAmount,
            feeModelVersion: service.feeModelVersion,
        };
    }
    /**
     * Gets the appropriate `RfqtService` instance from the
     * Chain ID -> Rfqt Service Map. Throws if no service is found
     * for `chainId`.
     */
    _getServiceForChain(chainId) {
        const service = this._rfqtServices.get(chainId);
        if (!service) {
            throw new Error('No configuration exists for chain');
        }
        return service;
    }
}
exports.RfqtHandlers = RfqtHandlers;
//# sourceMappingURL=data:application/json;charset=utf-8;base64,eyJmaWxlIjoiL1VzZXJzL2Rhdmlkd2Fsc2gvY29kZS1sb2NhbC8weC1yZnEtYXBpL3NyYy9oYW5kbGVycy9SZnF0SGFuZGxlcnMudHMiLCJtYXBwaW5ncyI6Ijs7O0FBRUEscUNBQTRDO0FBQzVDLHFDQUFzQztBQUV0QyxnREFBZ0Q7QUFDaEQsNkNBQXNDO0FBR3RDLHNDQUFtQztBQVFuQyxNQUFNLCtCQUErQixHQUFHLElBQUkscUJBQU8sQ0FBQztJQUNoRCxJQUFJLEVBQUUsdUNBQXVDO0lBQzdDLElBQUksRUFBRSwrQ0FBK0M7Q0FDeEQsQ0FBQyxDQUFDO0FBRUgsTUFBTSw0QkFBNEIsR0FBRyxJQUFJLHFCQUFPLENBQUM7SUFDN0MsSUFBSSxFQUFFLG9DQUFvQztJQUMxQyxJQUFJLEVBQUUsNENBQTRDO0NBQ3JELENBQUMsQ0FBQztBQUVILE1BQU0sK0JBQStCLEdBQUcsSUFBSSxxQkFBTyxDQUFDO0lBQ2hELElBQUksRUFBRSx1Q0FBdUM7SUFDN0MsSUFBSSxFQUFFLDBDQUEwQztDQUNuRCxDQUFDLENBQUM7QUFFSCxNQUFNLDRCQUE0QixHQUFHLElBQUkscUJBQU8sQ0FBQztJQUM3QyxJQUFJLEVBQUUsb0NBQW9DO0lBQzFDLElBQUksRUFBRSx1Q0FBdUM7Q0FDaEQsQ0FBQyxDQUFDO0FBRUgsTUFBTSwrQkFBK0IsR0FBRyxJQUFJLHFCQUFPLENBQUM7SUFDaEQsSUFBSSxFQUFFLHVDQUF1QztJQUM3QyxJQUFJLEVBQUUsK0NBQStDO0NBQ3hELENBQUMsQ0FBQztBQUVILE1BQU0sNEJBQTRCLEdBQUcsSUFBSSxxQkFBTyxDQUFDO0lBQzdDLElBQUksRUFBRSxvQ0FBb0M7SUFDMUMsSUFBSSxFQUFFLDRDQUE0QztDQUNyRCxDQUFDLENBQUM7QUFFSCxNQUFNLCtCQUErQixHQUFHLElBQUkscUJBQU8sQ0FBQztJQUNoRCxJQUFJLEVBQUUsdUNBQXVDO0lBQzdDLElBQUksRUFBRSwwQ0FBMEM7Q0FDbkQsQ0FBQyxDQUFDO0FBRUgsTUFBTSw0QkFBNEIsR0FBRyxJQUFJLHFCQUFPLENBQUM7SUFD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U0FDakM7YUFBTTtZQUNILFdBQVcsR0FBRyxlQUFlLENBQUM7U0FDakM7UUFDRCxNQUFNLGtCQUFrQixHQUFHLE1BQU0sT0FBTyxDQUFDLHFCQUFxQixDQUFDLFVBQVUsQ0FBQyxDQUFDO1FBQzNFLE1BQU0sa0JBQWtCLEdBQUcsTUFBTSxPQUFPLENBQUMscUJBQXFCLENBQUMsVUFBVSxDQUFDLENBQUM7UUFFM0UsT0FBTztZQUNILFFBQVEsRUFBRSxPQUFPLENBQUMsQ0FBQyxDQUFDLGNBQWMsQ0FBQyxDQUFDLENBQUMsTUFBTTtZQUMzQyxPQUFPO1lBQ1AsTUFBTTtZQUNOLFVBQVU7WUFDVixVQUFVO1lBQ1Ysa0JBQWtCLEVBQUUsVUFBVTtZQUM5QixNQUFNO1lBQ04sWUFBWTtZQUNaLFFBQVE7WUFDUixXQUFXO1lBQ1gsV0FBVztZQUNYLGtCQUFrQjtZQUNsQixrQkFBa0I7WUFDbEIsVUFBVTtZQUNWLFFBQVEsRUFBRSxLQUFLO1lBQ2YsU0FBUztZQUNULGVBQWU7WUFDZixlQUFlLEVBQUUsT0FBTyxDQUFDLGVBQWU7U0FDM0IsQ0FBQztJQUN0QixDQUFDO0lBRUQ7Ozs7T0FJRztJQUNLLG1CQUFtQixDQUFDLE9BQWU7UUFDdkMsTUFBTSxPQUFPLEdBQUcsSUFBSSxDQUFDLGFBQWEsQ0FBQyxHQUFHLENBQUMsT0FBTyxDQUFDLENBQUM7UUFFaEQsSUFBSSxDQUFDLE9BQU8sRUFBRTtZQUNWLE1BQU0sSUFBSSxLQUFLLENBQUMsbUNBQW1DLENBQUMsQ0FBQztTQUN4RDtRQUNELE9BQU8sT0FBTyxDQUFDO0lBQ25CLENBQUM7Q0FDSjtBQTVVRCxvQ0E0VUMiLCJuYW1lcyI6W10sInNvdXJjZXMiOlsiL1VzZXJzL2Rhdmlkd2Fsc2gvY29kZS1sb2NhbC8weC1yZnEtYXBpL3NyYy9oYW5kbGVycy9SZnF0SGFuZGxlcnMudHMiXSwic291cmNlc0NvbnRlbnQiOlsiLy8gdHNsaW50OmRpc2FibGU6bWF4LWZpbGUtbGluZS1jb3VudFxyXG5pbXBvcnQgeyBBbHRSZnFNYWtlckFzc2V0T2ZmZXJpbmdzLCBTaWduZWROYXRpdmVPcmRlciB9IGZyb20gJ0AweC9hc3NldC1zd2FwcGVyL2xpYi9zcmMvdHlwZXMnO1xyXG5pbXBvcnQgeyBNYXJrZXRPcGVyYXRpb24gfSBmcm9tICdAMHgvdHlwZXMnO1xyXG5pbXBvcnQgeyBCaWdOdW1iZXIgfSBmcm9tICdAMHgvdXRpbHMnO1xyXG5pbXBvcnQgKiBhcyBleHByZXNzIGZyb20gJ2V4cHJlc3MnO1xyXG5pbXBvcnQgKiBhcyBIdHRwU3RhdHVzIGZyb20gJ2h0dHAtc3RhdHVzLWNvZGVzJztcclxuaW1wb3J0IHsgQ291bnRlciB9IGZyb20gJ3Byb20tY2xpZW50JztcclxuXHJcbmltcG9ydCB7IEludGVncmF0b3IgfSBmcm9tICcuLi9jb25maWcnO1xyXG5pbXBvcnQgeyBsb2dnZXIgfSBmcm9tICcuLi9sb2dnZXInO1xyXG5pbXBvcnQgeyBWNFJGUUluZGljYXRpdmVRdW90ZU1NIH0gZnJvbSAnLi4vcXVvdGVSZXF1ZXN0b3IvUXVvdGVSZXF1ZXN0b3InO1xyXG5pbXBvcnQgeyBSZnF0U2VydmljZSB9IGZyb20gJy4uL3NlcnZpY2VzL1JmcXRTZXJ2aWNlJztcclxuaW1wb3J0IHsgRmlybVF1b3RlQ29udGV4dCwgUXVvdGVDb250ZXh0IH0gZnJvbSAnLi4vc2VydmljZXMvdHlwZXMnO1xyXG5pbXBvcnQgeyBSZnF0VjJQcmljZSwgUmZxdFYyUXVvdGUsIFJmcXRWMlJlcXVlc3QgfSBmcm9tICcuLi9jb3JlL3R5cGVzJztcclxuaW1wb3J0IHsgQ29uZmlnTWFuYWdlciB9IGZyb20gJy4uL3V0aWxzL2NvbmZpZ19tYW5hZ2VyJztcclxuaW1wb3J0IHsgUmZxdFNlcnZpY2VzIH0gZnJvbSAnLi4vdXRpbHMvcmZxdFNlcnZpY2VCdWlsZGVyJztcclxuXHJcbmNvbnN0IFJGUVRfVjFfUFJJQ0VfUkVRVUVTVF9TVUNDRUVERUQgPSBuZXcgQ291bnRlcih7XHJcbiAgICBuYW1lOiAncmZxdF92MV9wcmljZV9yZXF1ZXN0X3N1Y2NlZWRlZF90b3RhbCcsXHJcbiAgICBoZWxwOiAnUmVxdWVzdCBtYWRlIHRvIGZldGNoIHJmcXQgdjEgcHJpY2Ugc3VjY2VlZGVkJyxcclxufSk7XHJcblxyXG5jb25zdCBSRlFUX1YxX1BSSUNFX1JFUVVFU1RfRkFJTEVEID0gbmV3IENvdW50ZXIoe1xyXG4gICAgbmFtZTogJ3JmcXRfdjFfcHJpY2VfcmVxdWVzdF9mYWlsZWRfdG90YWwnLFxyXG4gICAgaGVscDogJ1JlcXVlc3QgbWFkZSB0byBmZXRjaCByZnF0IHYxIHByaWNlIGZhaWxlZCcsXHJcbn0pO1xyXG5cclxuY29uc3QgUkZRVF9WMV9RVU9URV9SRVFVRVNUX1NVQ0NFRURFRCA9IG5ldyBDb3VudGVyKHtcclxuICAgIG5hbWU6ICdyZnF0X3YxX3F1b3RlX3JlcXVlc3Rfc3VjY2VlZGVkX3RvdGFsJyxcclxuICAgIGhlbHA6ICdSZXF1ZXN0IHRvIGZldGNoIHJmcXQgdjEgcXVvdGUgc3VjY2VlZGVkJyxcclxufSk7XHJcblxyXG5jb25zdCBSRlFUX1YxX1FVT1RFX1JFUVVFU1RfRkFJTEVEID0gbmV3IENvdW50ZXIoe1xyXG4gICAgbmFtZTogJ3JmcXRfdjFfcXVvdGVfcmVxdWVzdF9mYWlsZWRfdG90YWwnLFxyXG4gICAgaGVscDogJ1JlcXVlc3QgdG8gZmV0Y2ggcmZxdCB2MSBxdW90ZSBmYWlsZWQnLFxyXG59KTtcclxuXHJcbmNvbnN0IFJGUVRfVjJfUFJJQ0VfUkVRVUVTVF9TVUNDRUVERUQgPSBuZXcgQ291bnRlcih7XHJcbiAgICBuYW1lOiAncmZxdF92Ml9wcmljZV9yZXF1ZXN0X3N1Y2NlZWRlZF90b3RhbCcsXHJcbiAgICBoZWxwOiAnUmVxdWVzdCBtYWRlIHRvIGZldGNoIHJmcXQgdjIgcHJpY2Ugc3VjY2VlZGVkJyxcclxufSk7XHJcblxyXG5jb25zdCBSRlFUX1YyX1BSSUNFX1JFUVVFU1RfRkFJTEVEID0gbmV3IENvdW50ZXIoe1xyXG4gICAgbmFtZTogJ3JmcXRfdjJfcHJpY2VfcmVxdWVzdF9mYWlsZWRfdG90YWwnLFxyXG4gICAgaGVscDogJ1JlcXVlc3QgbWFkZSB0byBmZXRjaCByZnF0IHYyIHByaWNlIGZhaWxlZCcsXHJcbn0pO1xyXG5cclxuY29uc3QgUkZRVF9WMl9RVU9URV9SRVFVRVNUX1NVQ0NFRURFRCA9IG5ldyBDb3VudGVyKHtcclxuICAgIG5hbWU6ICdyZnF0X3YyX3F1b3RlX3JlcXVlc3Rfc3VjY2VlZGVkX3RvdGFsJyxcclxuICAgIGhlbHA6ICdSZXF1ZXN0IHRvIGZldGNoIHJmcXQgdjIgcXVvdGUgc3VjY2VlZGVkJyxcclxufSk7XHJcblxyXG5jb25zdCBSRlFUX1YyX1FVT1RFX1JFUVVFU1RfRkFJTEVEID0gbmV3IENvdW50ZXIoe1xyXG4gICAgbmFtZTogJ3JmcXRfdjJfcXVvdGVfcmVxdWVzdF9mYWlsZWRfdG90YWwnLFxyXG4gICAgaGVscDogJ1JlcXVlc3QgdG8gZmV0Y2ggcmZxdCB2MiBxdW90ZSBmYWlsZWQnLFxyXG59KTtcclxuXHJcbi8qKlxyXG4gKiBUeXBlZCBwYXJhbWV0ZXJzIGZvciBib3RoIHRoZSBWMSBwcmljZXMgZW5kcG9pbnRcclxuICogYW5kIHRoZSBWMSBxdW90ZXMgZW5kcG9pbnRcclxuICovXHJcbmludGVyZmFjZSBWMVJlcXVlc3RQYXJhbWV0ZXJzIHtcclxuICAgIGFsdFJmcUFzc2V0T2ZmZXJpbmdzOiBBbHRSZnFNYWtlckFzc2V0T2ZmZXJpbmdzO1xyXG4gICAgYXNzZXRGaWxsQW1vdW50OiBCaWdOdW1iZXI7XHJcbiAgICBjaGFpbklkOiBudW1iZXI7XHJcbiAgICBjb21wYXJpc29uUHJpY2U6IEJpZ051bWJlciB8IHVuZGVmaW5lZDtcclxuICAgIG1ha2VyVG9rZW46IHN0cmluZztcclxuICAgIG1hcmtldE9wZXJhdGlvbjogTWFya2V0T3BlcmF0aW9uO1xyXG4gICAgdGFrZXJBZGRyZXNzOiBzdHJpbmc7IC8vIGV4cGVjdCB0aGlzIHRvIGJlIE5VTExfQUREUkVTU1xyXG4gICAgdGFrZXJUb2tlbjogc3RyaW5nO1xyXG4gICAgdHhPcmlnaW4/OiBzdHJpbmc7IC8vIGV4cGVjdCB0aGlzIHRvIGJlIHRoZSB0YWtlciBhZGRyZXNzLCBjYW4gYmUgbWlzc2luZyBmb3IgL3ByaWNlIGJ1dCBub3QgL3F1b3RlXHJcbiAgICBpbnRlbnRPbkZpbGxpbmc6IGJvb2xlYW47XHJcbiAgICBpbnRlZ3JhdG9ySWQ6IHN0cmluZztcclxufVxyXG5cclxuaW50ZXJmYWNlIFR5cGVkUmVxdWVzdDxUQm9keT4gZXh0ZW5kcyBleHByZXNzLlJlcXVlc3Qge1xyXG4gICAgYm9keTogVEJvZHk7XHJcbn1cclxuXHJcbi8qKlxyXG4gKiBIYW5kbGVzIHBhcnNpbmcgdGhlIHJlcXVlc3QgZnJvbSBSRlF0IHJvdXRlcywgbWV0ZXJzIGNhbGxzIHdpdGggcHJvbWV0aGV1cyBjb3VudGVycyxcclxuICogY2FsbHMgdGhlIGFwcHJvcHJpYXRlIHNlcnZpY2UgbWV0aG9kIGFuZCByZXR1cm5zIHRoZSByZXN1bHQuXHJcbiAqXHJcbiAqIEVycm9yIGJvdW5kYXJ5IGZvciBodHRwIGNhbGxzOyBhbGwgZXJyb3JzIHNob3VsZCBiZSBjYXVnaHQgYW5kIHJldHVybmVkIHRvIHRoZVxyXG4gKiBjYWxsZXIgYXMgcGFydCBvZiB0aGUgcmVzcG9uc2UuXHJcbiAqL1xyXG5leHBvcnQgY2xhc3MgUmZxdEhhbmRsZXJzIHtcclxuICAgIGNvbnN0cnVjdG9yKHByaXZhdGUgcmVhZG9ubHkgX3JmcXRTZXJ2aWNlczogUmZxdFNlcnZpY2VzLCBwcml2YXRlIHJlYWRvbmx5IF9jb25maWdNYW5hZ2VyOiBDb25maWdNYW5hZ2VyKSB7fVxyXG5cclxuICAgIC8qKlxyXG4gICAgICogR2V0cyBwcmljZXMgKFwiaW5kaWNhdGl2ZSBxdW90ZXNcIikgZm9yIHRoZSBnaXZlbiBhc3NldCBwYWlyIGZyb20gbWFya2V0IG1ha2Vyc1xyXG4gICAgICogb3BlcmF0aW5nIG9uIHRoZSBgUmZxT3JkZXJgIFJGUXQgcGxhdGZvcm1cclxuICAgICAqL1xyXG4gICAgcHVibGljIGFzeW5jIGdldFYxUHJpY2VzQXN5bmMoXHJcbiAgICAgICAgcmVxOiBUeXBlZFJlcXVlc3Q8VjFSZXF1ZXN0UGFyYW1ldGVycz4sXHJcbiAgICAgICAgLy8gJGVzbGludC1maXgtbWUgaHR0cHM6Ly9naXRodWIuY29tL3JoaW5vZGF2aWQvZXNsaW50LWZpeC1tZVxyXG4gICAgICAgIC8vIGVzbGludC1kaXNhYmxlLW5leHQtbGluZSBAdHlwZXNjcmlwdC1lc2xpbnQvbm8tZXhwbGljaXQtYW55XHJcbiAgICAgICAgcmVzOiBleHByZXNzLlJlc3BvbnNlPHsgcHJpY2VzOiBWNFJGUUluZGljYXRpdmVRdW90ZU1NW10gfSB8IHsgZXJyb3I6IGFueSB9PixcclxuICAgICk6IFByb21pc2U8dm9pZD4ge1xyXG4gICAgICAgIGxldCBwYXJzZWRQYXJhbWV0ZXJzOiBPbWl0PFYxUmVxdWVzdFBhcmFtZXRlcnMsICdpbnRlZ3JhdG9ySWQnPiAmIHsgaW50ZWdyYXRvcjogSW50ZWdyYXRvciB9O1xyXG4gICAgICAgIGxldCBzZXJ2aWNlOiBSZnF0U2VydmljZTtcclxuICAgICAgICB0cnkge1xyXG4gICAgICAgICAgICBwYXJzZWRQYXJhbWV0ZXJzID0gdGhpcy5fcGFyc2VWMVJlcXVlc3RQYXJhbWV0ZXJzKHJlcSk7XHJcbiAgICAgICAgICAgIHNlcnZpY2UgPSB0aGlzLl9nZXRTZXJ2aWNlRm9yQ2hhaW4ocGFyc2VkUGFyYW1ldGVycy5jaGFpbklkKTtcclxuICAgICAgICB9IGNhdGNoIChlcnJvcikge1xyXG4gICAgICAgICAgICBSRlFUX1YxX1BSSUNFX1JFUVVFU1RfRkFJTEVELmluYygpO1xyXG4gICAgICAgICAgICBsb2dnZXIuZXJyb3IoeyBlcnJvcjogZXJyb3IubWVzc2FnZSB9LCAnUmZxdCBWMSBwcmljZSByZXF1ZXN0IGZhaWxlZCcpO1xyXG4gICAgICAgICAgICByZXMuc3RhdHVzKEh0dHBTdGF0dXMuQkFEX1JFUVVFU1QpLmpzb24oeyBlcnJvcjogZXJyb3IubWVzc2FnZSB9KTtcclxuICAgICAgICAgICAgcmV0dXJuO1xyXG4gICAgICAgIH1cclxuXHJcbiAgICAgICAgdHJ5IHtcclxuICAgICAgICAgICAgY29uc3QgcHJpY2VzID0gYXdhaXQgc2VydmljZS5nZXRWMVByaWNlc0FzeW5jKHBhcnNlZFBhcmFtZXRlcnMpO1xyXG4gICAgICAgICAgICBSRlFUX1YxX1BSSUNFX1JFUVVFU1RfU1VDQ0VFREVELmluYygpO1xyXG4gICAgICAgICAgICBsb2dnZXIuaW5mbygnUmZxdCBWMSBwcmljZSByZXF1ZXN0IHN1Y2NlZWRlZCcpO1xyXG4gICAgICAgICAgICByZXMuc3RhdHVzKEh0dHBTdGF0dXMuT0spLmpzb24oe1xyXG4gICAgICAgICAgICAgICAgcHJpY2VzLFxyXG4gICAgICAgICAgICB9KTtcclxuICAgICAgICB9IGNhdGNoIChlcnJvcikge1xyXG4gICAgICAgICAgICBSRlFUX1YxX1BSSUNFX1JFUVVFU1RfRkFJTEVELmluYygpO1xyXG4gICAgICAgICAgICBsb2dnZXIuZXJyb3IoeyBlcnJvcjogZXJyb3IubWVzc2FnZSB9LCAnUmZxdCBWMSBwcmljZSByZXF1ZXN0IGZhaWxlZCcpO1xyXG4gICAgICAgICAgICByZXMuc3RhdHVzKEh0dHBTdGF0dXMuSU5URVJOQUxfU0VSVkVSX0VSUk9SKS5qc29uKHsgZXJyb3I6IGVycm9yLm1lc3NhZ2UgfSk7XHJcbiAgICAgICAgfVxyXG4gICAgfVxyXG5cclxuICAgIC8qKlxyXG4gICAgICogR2V0cyBwcmljZXMgKFwiZmlybSBxdW90ZXNcIikgZm9yIHRoZSBnaXZlbiBhc3NldCBwYWlyIGZyb20gbWFya2V0IG1ha2Vyc1xyXG4gICAgICogb3BlcmF0aW5nIG9uIHRoZSBgUmZxT3JkZXJgIFJGUXQgcGxhdGZvcm1cclxuICAgICAqL1xyXG4gICAgcHVibGljIGFzeW5jIGdldFYxUXVvdGVzQXN5bmMoXHJcbiAgICAgICAgcmVxOiBUeXBlZFJlcXVlc3Q8VjFSZXF1ZXN0UGFyYW1ldGVycz4sXHJcbiAgICAgICAgLy8gJGVzbGludC1maXgtbWUgaHR0cHM6Ly9naXRodWIuY29tL3JoaW5vZGF2aWQvZXNsaW50LWZpeC1tZVxyXG4gICAgICAgIC8vIGVzbGludC1kaXNhYmxlLW5leHQtbGluZSBAdHlwZXNjcmlwdC1lc2xpbnQvbm8tZXhwbGljaXQtYW55XHJcbiAgICAgICAgcmVzOiBleHByZXNzLlJlc3BvbnNlPHsgcXVvdGVzOiBTaWduZWROYXRpdmVPcmRlcltdIH0gfCB7IGVycm9yOiBhbnkgfT4sXHJcbiAgICApOiBQcm9taXNlPHZvaWQ+IHtcclxuICAgICAgICBsZXQgcGFyc2VkUGFyYW1ldGVyczogT21pdDxWMVJlcXVlc3RQYXJhbWV0ZXJzLCAnaW50ZWdyYXRvcklkJz4gJiB7IGludGVncmF0b3I6IEludGVncmF0b3IgfTtcclxuICAgICAgICBsZXQgc2VydmljZTogUmZxdFNlcnZpY2U7XHJcbiAgICAgICAgbGV0IHR4T3JpZ2luOiBzdHJpbmc7XHJcbiAgICAgICAgdHJ5IHtcclxuICAgICAgICAgICAgcGFyc2VkUGFyYW1ldGVycyA9IHRoaXMuX3BhcnNlVjFSZXF1ZXN0UGFyYW1ldGVycyhyZXEpO1xyXG4gICAgICAgICAgICBpZiAocGFyc2VkUGFyYW1ldGVycy50eE9yaWdpbiA9PT0gdW5kZWZpbmVkKSB7XHJcbiAgICAgICAgICAgICAgICB0aHJvdyBuZXcgRXJyb3IoJ1JlY2VpdmVkIHJlcXVlc3Qgd2l0aCBtaXNzaW5nIHBhcmFtZXRlciB0eE9yaWdpbicpO1xyXG4gICAgICAgICAgICB9XHJcbiAgICAgICAgICAgIHR4T3JpZ2luID0gcGFyc2VkUGFyYW1ldGVycy50eE9yaWdpbjtcclxuICAgICAgICAgICAgc2VydmljZSA9IHRoaXMuX2dldFNlcnZpY2VGb3JDaGFpbihwYXJzZWRQYXJhbWV0ZXJzLmNoYWluSWQpO1xyXG4gICAgICAgIH0gY2F0Y2ggKGVycm9yKSB7XHJcbiAgICAgICAgICAgIFJGUVRfVjFfUVVPVEVfUkVRVUVTVF9GQUlMRUQuaW5jKCk7XHJcbiAgICAgICAgICAgIGxvZ2dlci5lcnJvcih7IGVycm9yIH0sICdSZnF0IFYxIHF1b3RlIHJlcXVlc3QgZmFpbGVkJyk7XHJcbiAgICAgICAgICAgIHJlcy5zdGF0dXMoSHR0cFN0YXR1cy5CQURfUkVRVUVTVCkuanNvbih7IGVycm9yIH0pO1xyXG4gICAgICAgICAgICByZXR1cm47XHJcbiAgICAgICAgfVxyXG5cclxuICAgICAgICB0cnkge1xyXG4gICAgICAgICAgICBjb25zdCBxdW90ZXMgPSBhd2FpdCBzZXJ2aWNlLmdldFYxUXVvdGVzQXN5bmMoe1xyXG4gICAgICAgICAgICAgICAgLi4ucGFyc2VkUGFyYW1ldGVycyxcclxuICAgICAgICAgICAgICAgIHR4T3JpZ2luLFxyXG4gICAgICAgICAgICB9KTtcclxuICAgICAgICAgICAgUkZRVF9WMV9RVU9URV9SRVFVRVNUX1NVQ0NFRURFRC5pbmMoKTtcclxuICAgICAgICAgICAgbG9nZ2VyLmluZm8oJ1JmcXQgVjEgcXVvdGUgcmVxdWVzdCBzdWNjZWVkZWQnKTtcclxuICAgICAgICAgICAgcmVzLnN0YXR1cyhIdHRwU3RhdHVzLk9LKS5qc29uKHtcclxuICAgICAgICAgICAgICAgIHF1b3RlcyxcclxuICAgICAgICAgICAgfSk7XHJcbiAgICAgICAgfSBjYXRjaCAoZXJyb3IpIHtcclxuICAgICAgICAgICAgUkZRVF9WMV9RVU9URV9SRVFVRVNUX0ZBSUxFRC5pbmMoKTtcclxuICAgICAgICAgICAgbG9nZ2VyLmVycm9yKHsgZXJyb3IgfSwgJ1JmcXQgVjEgcXVvdGUgcmVxdWVzdCBmYWlsZWQnKTtcclxuICAgICAgICAgICAgcmVzLnN0YXR1cyhIdHRwU3RhdHVzLklOVEVSTkFMX1NFUlZFUl9FUlJPUikuanNvbih7IGVycm9yOiBlcnJvci5tZXNzYWdlIH0pO1xyXG4gICAgICAgIH1cclxuICAgIH1cclxuXHJcbiAgICAvKipcclxuICAgICAqIEdldHMgcHJpY2VzIChcImluZGljYXRpdmUgcXVvdGVzXCIpIGZvciB0aGUgZ2l2ZW4gYXNzZXQgcGFpciBmcm9tIG1hcmtldCBtYWtlcnNcclxuICAgICAqIG9wZXJhdGluZyBvbiB0aGUgYE90Y09yZGVyYCBSRlF0IHBsYXRmb3JtXHJcbiAgICAgKi9cclxuICAgIHB1YmxpYyBhc3luYyBnZXRWMlByaWNlc0FzeW5jKFxyXG4gICAgICAgIHJlcTogVHlwZWRSZXF1ZXN0PFJmcXRWMlJlcXVlc3Q+LFxyXG4gICAgICAgIC8vICRlc2xpbnQtZml4LW1lIGh0dHBzOi8vZ2l0aHViLmNvbS9yaGlub2RhdmlkL2VzbGludC1maXgtbWVcclxuICAgICAgICAvLyBlc2xpbnQtZGlzYWJsZS1uZXh0LWxpbmUgQHR5cGVzY3JpcHQtZXNsaW50L25vLWV4cGxpY2l0LWFueVxyXG4gICAgICAgIHJlczogZXhwcmVzcy5SZXNwb25zZTx7IHByaWNlczogUmZxdFYyUHJpY2VbXSB9IHwgeyBlcnJvcjogYW55IH0+LFxyXG4gICAgKTogUHJvbWlzZTx2b2lkPiB7XHJcbiAgICAgICAgbGV0IHF1b3RlQ29udGV4dDogUXVvdGVDb250ZXh0O1xyXG4gICAgICAgIGxldCBzZXJ2aWNlOiBSZnF0U2VydmljZTtcclxuICAgICAgICB0cnkge1xyXG4gICAgICAgICAgICBjb25zdCBjaGFpbklkID0gdGhpcy5fZXh0cmFjdENoYWluSWQocmVxKTtcclxuICAgICAgICAgICAgc2VydmljZSA9IHRoaXMuX2dldFNlcnZpY2VGb3JDaGFpbihjaGFpbklkKTtcclxuICAgICAgICAgICAgcXVvdGVDb250ZXh0ID0gYXdhaXQgdGhpcy5fZXh0cmFjdFF1b3RlQ29udGV4dEFzeW5jKHJlcSwgY2hhaW5JZCwgZmFsc2UsIHNlcnZpY2UpO1xyXG4gICAgICAgIH0gY2F0Y2ggKGVycm9yKSB7XHJcbiAgICAgICAgICAgIFJGUVRfVjJfUFJJQ0VfUkVRVUVTVF9GQUlMRUQuaW5jKCk7XHJcbiAgICAgICAgICAgIGxvZ2dlci5lcnJvcih7IGVycm9yOiBlcnJvci5tZXNzYWdlIH0sICdSZnF0IFYyIHByaWNlIHJlcXVlc3QgZmFpbGVkJyk7XHJcbiAgICAgICAgICAgIHJlcy5zdGF0dXMoSHR0cFN0YXR1cy5CQURfUkVRVUVTVCkuanNvbih7IGVycm9yOiBlcnJvci5tZXNzYWdlIH0pO1xyXG4gICAgICAgICAgICByZXR1cm47XHJcbiAgICAgICAgfVxyXG5cclxuICAgICAgICB0cnkge1xyXG4gICAgICAgICAgICBjb25zdCBwcmljZXMgPSBhd2FpdCBzZXJ2aWNlLmdldFYyUHJpY2VzQXN5bmMocXVvdGVDb250ZXh0KTtcclxuICAgICAgICAgICAgUkZRVF9WMl9QUklDRV9SRVFVRVNUX1NVQ0NFRURFRC5pbmMoKTtcclxuICAgICAgICAgICAgbG9nZ2VyLmluZm8oJ1JmcXQgVjIgcHJpY2UgcmVxdWVzdCBzdWNjZWVkZWQnKTtcclxuICAgICAgICAgICAgcmVzLnN0YXR1cyhIdHRwU3RhdHVzLk9LKS5qc29uKHtcclxuICAgICAgICAgICAgICAgIHByaWNlcyxcclxuICAgICAgICAgICAgfSk7XHJcbiAgICAgICAgfSBjYXRjaCAoZXJyb3IpIHtcclxuICAgICAgICAgICAgUkZRVF9WMl9QUklDRV9SRVFVRVNUX0ZBSUxFRC5pbmMoKTtcclxuICAgICAgICAgICAgbG9nZ2VyLmVycm9yKHsgZXJyb3I6IGVycm9yLm1lc3NhZ2UgfSwgJ1JmcXQgVjIgcHJpY2UgcmVxdWVzdCBmYWlsZWQnKTtcclxuICAgICAgICAgICAgcmVzLnN0YXR1cyhIdHRwU3RhdHVzLklOVEVSTkFMX1NFUlZFUl9FUlJPUikuanNvbih7IGVycm9yOiBlcnJvci5tZXNzYWdlIH0pO1xyXG4gICAgICAgIH1cclxuICAgIH1cclxuXHJcbiAgICAvKipcclxuICAgICAqIEdldHMgcXVvdGVzIChcImZpcm0gcXVvdGVzXCIpIGZvciB0aGUgZ2l2ZW4gYXNzZXQgcGFpciBmcm9tIG1hcmtldCBtYWtlcnNcclxuICAgICAqIG9wZXJhdGluZyBvbiB0aGUgYE90Y09yZGVyYCBSRlF0IHBsYXRmb3JtXHJcbiAgICAgKi9cclxuICAgIHB1YmxpYyBhc3luYyBnZXRWMlF1b3Rlc0FzeW5jKFxyXG4gICAgICAgIHJlcTogVHlwZWRSZXF1ZXN0PFJmcXRWMlJlcXVlc3Q+LFxyXG4gICAgICAgIC8vICRlc2xpbnQtZml4LW1lIGh0dHBzOi8vZ2l0aHViLmNvbS9yaGlub2RhdmlkL2VzbGludC1maXgtbWVcclxuICAgICAgICAvLyBlc2xpbnQtZGlzYWJsZS1uZXh0LWxpbmUgQHR5cGVzY3JpcHQtZXNsaW50L25vLWV4cGxpY2l0LWFueVxyXG4gICAgICAgIHJlczogZXhwcmVzcy5SZXNwb25zZTx7IHF1b3RlczogUmZxdFYyUXVvdGVbXSB9IHwgeyBlcnJvcjogYW55IH0+LFxyXG4gICAgKTogUHJvbWlzZTx2b2lkPiB7XHJcbiAgICAgICAgbGV0IHF1b3RlQ29udGV4dDogRmlybVF1b3RlQ29udGV4dDtcclxuICAgICAgICBsZXQgc2VydmljZTogUmZxdFNlcnZpY2U7XHJcbiAgICAgICAgdHJ5IHtcclxuICAgICAgICAgICAgY29uc3QgY2hhaW5JZCA9IHRoaXMuX2V4dHJhY3RDaGFpbklkKHJlcSk7XHJcbiAgICAgICAgICAgIHNlcnZpY2UgPSB0aGlzLl9nZXRTZXJ2aWNlRm9yQ2hhaW4oY2hhaW5JZCk7XHJcbiAgICAgICAgICAgIHF1b3RlQ29udGV4dCA9IChhd2FpdCB0aGlzLl9leHRyYWN0UXVvdGVDb250ZXh0QXN5bmMocmVxLCBjaGFpbklkLCB0cnVlLCBzZXJ2aWNlKSkgYXMgRmlybVF1b3RlQ29udGV4dDtcclxuICAgICAgICB9IGNhdGNoIChlcnJvcikge1xyXG4gICAgICAgICAgICBSRlFUX1YyX1FVT1RFX1JFUVVFU1RfRkFJTEVELmluYygpO1xyXG4gICAgICAgICAgICBsb2dnZXIuZXJyb3IoeyBlcnJvciB9LCAnUmZxdCBWMiBxdW90ZSByZXF1ZXN0IGZhaWxlZCcpO1xyXG4gICAgICAgICAgICByZXMuc3RhdHVzKEh0dHBTdGF0dXMuQkFEX1JFUVVFU1QpLmpzb24oeyBlcnJvciB9KTtcclxuICAgICAgICAgICAgcmV0dXJuO1xyXG4gICAgICAgIH1cclxuXHJcbiAgICAgICAgdHJ5IHtcclxuICAgICAgICAgICAgY29uc3QgcXVvdGVzID0gYXdhaXQgc2VydmljZS5nZXRWMlF1b3Rlc0FzeW5jKHF1b3RlQ29udGV4dCk7XHJcbiAgICAgICAgICAgIFJGUVRfVjJfUVVPVEVfUkVRVUVTVF9TVUNDRUVERUQuaW5jKCk7XHJcbiAgICAgICAgICAgIGxvZ2dlci5pbmZvKCdSZnF0IFYyIHF1b3RlIHJlcXVlc3Qgc3VjY2VlZGVkJyk7XHJcbiAgICAgICAgICAgIHJlcy5zdGF0dXMoSHR0cFN0YXR1cy5PSykuanNvbih7XHJcbiAgICAgICAgICAgICAgICBxdW90ZXMsXHJcbiAgICAgICAgICAgIH0pO1xyXG4gICAgICAgIH0gY2F0Y2ggKGVycm9yKSB7XHJcbiAgICAgICAgICAgIFJGUVRfVjJfUVVPVEVfUkVRVUVTVF9GQUlMRUQuaW5jKCk7XHJcbiAgICAgICAgICAgIGxvZ2dlci5lcnJvcih7IGVycm9yIH0sICdSZnF0IFYyIHF1b3RlIHJlcXVlc3QgZmFpbGVkJyk7XHJcbiAgICAgICAgICAgIHJlcy5zdGF0dXMoSHR0cFN0YXR1cy5JTlRFUk5BTF9TRVJWRVJfRVJST1IpLmpzb24oeyBlcnJvcjogZXJyb3IubWVzc2FnZSB9KTtcclxuICAgICAgICB9XHJcbiAgICB9XHJcblxyXG4gICAgLyoqXHJcbiAgICAgKiBQYXJzZXMgYW5kIHJ1bnRpbWUtY2hlY2tzIHJlcXVlc3QgcGFyYW1ldGVycy4gQWZ0ZXIgcnVubmluZyB0aGUgbWV0aG9kLCB0aGUgcGFyYW1ldGVyc1xyXG4gICAgICogc2hvdWxkIG1hdGNoIHRoZWlyIFR5cGVTY3JpcHQgdHlwZXMuXHJcbiAgICAgKi9cclxuICAgIHByaXZhdGUgX3BhcnNlVjFSZXF1ZXN0UGFyYW1ldGVyczxUUmVxdWVzdCBleHRlbmRzIFR5cGVkUmVxdWVzdDxWMVJlcXVlc3RQYXJhbWV0ZXJzPj4oXHJcbiAgICAgICAgcmVxdWVzdDogVFJlcXVlc3QsXHJcbiAgICApOiBWMVJlcXVlc3RQYXJhbWV0ZXJzICYgeyBpbnRlZ3JhdG9yOiBJbnRlZ3JhdG9yIH0ge1xyXG4gICAgICAgIGNvbnN0IHsgYm9keSB9ID0gcmVxdWVzdDtcclxuXHJcbiAgICAgICAgLy8gRG9pbmcgdGhpcyBiZWZvcmUgZGVzdHJ1Y3R1cmluZyB0aGUgYm9keSwgb3RoZXJ3aXNlIHRoZSBlcnJvclxyXG4gICAgICAgIC8vIHRocm93biB3aWxsIGJlIHNvbWV0aGluZyBsaWtlOlxyXG4gICAgICAgIC8vICdDYW5ub3QgZGVzdHJ1Y3R1cmUgcHJvcGVydHkgJ2FsdFJmcUFzc2V0T2ZmZXJpbmdzJyBvZiAncmVxdWVzdC5ib2R5JyBhcyBpdCBpcyB1bmRlZmluZWQuJ1xyXG4gICAgICAgIGlmIChcclxuICAgICAgICAgICAgIWJvZHkuYWx0UmZxQXNzZXRPZmZlcmluZ3MgfHxcclxuICAgICAgICAgICAgIWJvZHkuYXNzZXRGaWxsQW1vdW50IHx8XHJcbiAgICAgICAgICAgICFib2R5Lm1ha2VyVG9rZW4gfHxcclxuICAgICAgICAgICAgIWJvZHkubWFya2V0T3BlcmF0aW9uIHx8XHJcbiAgICAgICAgICAgICFib2R5LnRha2VyVG9rZW4gfHxcclxuICAgICAgICAgICAgIWJvZHkudGFrZXJBZGRyZXNzIHx8XHJcbiAgICAgICAgICAgIHR5cGVvZiBib2R5LmludGVudE9uRmlsbGluZyAhPT0gJ2Jvb2xlYW4nIHx8XHJcbiAgICAgICAgICAgICFib2R5LmludGVncmF0b3JJZFxyXG4gICAgICAgICkge1xyXG4gICAgICAgICAgICB0aHJvdyBuZXcgRXJyb3IoJ1JlY2VpdmVkIHJlcXVlc3Qgd2l0aCBtaXNzaW5nIHBhcmFtZXRlcnMnKTtcclxuICAgICAgICB9XHJcblxyXG4gICAgICAgIGNvbnN0IHsgYXNzZXRGaWxsQW1vdW50LCBjb21wYXJpc29uUHJpY2UsIG1hcmtldE9wZXJhdGlvbiwgaW50ZWdyYXRvcklkIH0gPSByZXF1ZXN0LmJvZHk7XHJcblxyXG4gICAgICAgIGNvbnN0IHBhcnNlZENoYWluSWQgPSB0aGlzLl9leHRyYWN0Q2hhaW5JZChyZXF1ZXN0KTtcclxuICAgICAgICBpZiAoTnVtYmVyLmlzTmFOKHBhcnNlZENoYWluSWQpKSB7XHJcbiAgICAgICAgICAgIHRocm93IG5ldyBFcnJvcignQ2hhaW4gSUQgaXMgaW52YWxpZCcpO1xyXG4gICAgICAgIH1cclxuXHJcbiAgICAgICAgaWYgKFxyXG4gICAgICAgICAgICAobWFya2V0T3BlcmF0aW9uIGFzIHN0cmluZykgIT09IE1hcmtldE9wZXJhdGlvbi5CdXkudG9TdHJpbmcoKSAmJlxyXG4gICAgICAgICAgICAobWFya2V0T3BlcmF0aW9uIGFzIHN0cmluZykgIT09IE1hcmtldE9wZXJhdGlvbi5TZWxsLnRvU3RyaW5nKClcclxuICAgICAgICApIHtcclxuICAgICAgICAgICAgdGhyb3cgbmV3IEVycm9yKCdSZWNlaXZlZCByZXF1ZXN0IHdpdGggaW52YWxpZCBtYXJrZXQgb3BlcmF0aW9uJyk7XHJcbiAgICAgICAgfVxyXG5cclxuICAgICAgICBsZXQgaW50ZWdyYXRvcjogSW50ZWdyYXRvcjtcclxuICAgICAgICB0cnkge1xyXG4gICAgICAgICAgICBpbnRlZ3JhdG9yID0gdGhpcy5fY29uZmlnTWFuYWdlci5nZXRJbnRlZ3JhdG9yQnlJZE9yVGhyb3coaW50ZWdyYXRvcklkKTtcclxuICAgICAgICB9IGNhdGNoIChlcnJvcikge1xyXG4gICAgICAgICAgICB0aHJvdyBuZXcgRXJyb3IoJ05vIGludGVncmF0b3IgZm91bmQgZm9yIGludGVncmF0b3IgSUQnKTtcclxuICAgICAgICB9XHJcblxyXG4gICAgICAgIHJldHVybiB7XHJcbiAgICAgICAgICAgIC4uLnJlcXVlc3QuYm9keSxcclxuICAgICAgICAgICAgYXNzZXRGaWxsQW1vdW50OiBuZXcgQmlnTnVtYmVyKGFzc2V0RmlsbEFtb3VudCksXHJcbiAgICAgICAgICAgIGNoYWluSWQ6IHBhcnNlZENoYWluSWQsXHJcbiAgICAgICAgICAgIGNvbXBhcmlzb25QcmljZTogY29tcGFyaXNvblByaWNlID8gbmV3IEJpZ051bWJlcihjb21wYXJpc29uUHJpY2UpIDogdW5kZWZpbmVkLFxyXG4gICAgICAgICAgICBpbnRlZ3JhdG9yLFxyXG4gICAgICAgIH07XHJcbiAgICB9XHJcblxyXG4gICAgLyoqXHJcbiAgICAgKiBFeHRyYWN0IGNoYWluSWQgZnJvbSByZXF1ZXN0IHBhcmFtZXRlcnMuXHJcbiAgICAgKi9cclxuICAgIHByaXZhdGUgX2V4dHJhY3RDaGFpbklkPFRSZXF1ZXN0IGV4dGVuZHMgVHlwZWRSZXF1ZXN0PFJmcXRWMlJlcXVlc3Q+PihyZXF1ZXN0OiBUUmVxdWVzdCk6IG51bWJlciB7XHJcbiAgICAgICAgY29uc3QgY2hhaW5JZEZyb21IZWFkZXIgPSByZXF1ZXN0LmhlYWRlcignMHgtY2hhaW4taWQnKTtcclxuICAgICAgICBpZiAoY2hhaW5JZEZyb21IZWFkZXIgPT09IHVuZGVmaW5lZCkge1xyXG4gICAgICAgICAgICB0aHJvdyBuZXcgRXJyb3IoJ0NoYWluIElEIGlzIG5vdCBwcm92aWRlZCcpO1xyXG4gICAgICAgIH0gZWxzZSB7XHJcbiAgICAgICAgICAgIGNvbnN0IHBhcnNlZENoYWluSWQgPSBwYXJzZUludChjaGFpbklkRnJvbUhlYWRlciwgMTApO1xyXG4gICAgICAgICAgICBpZiAoTnVtYmVyLmlzTmFOKHBhcnNlZENoYWluSWQpKSB7XHJcbiAgICAgICAgICAgICAgICB0aHJvdyBuZXcgRXJyb3IoJ0NoYWluIElEIGlzIGludmFsaWQnKTtcclxuICAgICAgICAgICAgfVxyXG4gICAgICAgICAgICByZXR1cm4gcGFyc2VkQ2hhaW5JZDtcclxuICAgICAgICB9XHJcbiAgICB9XHJcblxyXG4gICAgLyoqXHJcbiAgICAgKiBFeHRyYWN0IHF1b3RlIGNvbnRleHQgZnJvbSByZXF1ZXN0IHBhcmFtZXRlcnMuIEFmdGVyIHJ1bm5pbmcgdGhlIG1ldGhvZCwgdGhlIHBhcmFtZXRlcnNcclxuICAgICAqIHNob3VsZCBtYXRjaCB0aGVpciBUeXBlU2NyaXB0IHR5cGVzLlxyXG4gICAgICovXHJcbiAgICBwcml2YXRlIGFzeW5jIF9leHRyYWN0UXVvdGVDb250ZXh0QXN5bmM8VFJlcXVlc3QgZXh0ZW5kcyBUeXBlZFJlcXVlc3Q8UmZxdFYyUmVxdWVzdD4+KFxyXG4gICAgICAgIHJlcXVlc3Q6IFRSZXF1ZXN0LFxyXG4gICAgICAgIGNoYWluSWQ6IG51bWJlcixcclxuICAgICAgICBpc0Zpcm06IGJvb2xlYW4sXHJcbiAgICAgICAgc2VydmljZTogUmZxdFNlcnZpY2UsXHJcbiAgICApOiBQcm9taXNlPFF1b3RlQ29udGV4dD4ge1xyXG4gICAgICAgIGNvbnN0IHsgYm9keSB9ID0gcmVxdWVzdDtcclxuXHJcbiAgICAgICAgLy8gRG9pbmcgdGhpcyBiZWZvcmUgZGVzdHJ1Y3R1cmluZyB0aGUgYm9keSwgb3RoZXJ3aXNlIHRoZSBlcnJvclxyXG4gICAgICAgIC8vIHRocm93biB3aWxsIGJlIHNvbWV0aGluZyBsaWtlOlxyXG4gICAgICAgIC8vICdDYW5ub3QgZGVzdHJ1Y3R1cmUgcHJvcGVydHkgJ2Fzc2V0RmlsbEFtb3VudCcgb2YgJ3JlcXVlc3QuYm9keScgYXMgaXQgaXMgdW5kZWZpbmVkLidcclxuICAgICAgICBpZiAoXHJcbiAgICAgICAgICAgICFib2R5LmFzc2V0RmlsbEFtb3VudCB8fFxyXG4gICAgICAgICAgICAhYm9keS5tYWtlclRva2VuIHx8XHJcbiAgICAgICAgICAgICFib2R5Lm1hcmtldE9wZXJhdGlvbiB8fFxyXG4gICAgICAgICAgICAhYm9keS50YWtlclRva2VuIHx8XHJcbiAgICAgICAgICAgICFib2R5LnRha2VyQWRkcmVzcyB8fFxyXG4gICAgICAgICAgICAvLyBUT0RPOiBhZGQgYm9keS50cmFkZXIgdG8gdGhlc2UgY2hlY2tzIG9uY2Ugd2UndmUgcm9sbGVkIG91dCBjb21wbGV0ZWx5XHJcbiAgICAgICAgICAgIHR5cGVvZiBib2R5LmludGVudE9uRmlsbGluZyAhPT0gJ2Jvb2xlYW4nIHx8XHJcbiAgICAgICAgICAgICFib2R5LmludGVncmF0b3JJZFxyXG4gICAgICAgICkge1xyXG4gICAgICAgICAgICB0aHJvdyBuZXcgRXJyb3IoJ1JlY2VpdmVkIHJlcXVlc3Qgd2l0aCBtaXNzaW5nIHBhcmFtZXRlcnMnKTtcclxuICAgICAgICB9XHJcblxyXG4gICAgICAgIGNvbnN0IHtcclxuICAgICAgICAgICAgdGFrZXJUb2tlbixcclxuICAgICAgICAgICAgbWFrZXJUb2tlbixcclxuICAgICAgICAgICAgdHJhZGVyLFxyXG4gICAgICAgICAgICBnYXNsZXNzLFxyXG4gICAgICAgICAgICB0YWtlckFkZHJlc3MsXHJcbiAgICAgICAgICAgIHR4T3JpZ2luLFxyXG4gICAgICAgICAgICBhc3NldEZpbGxBbW91bnQ6IGFzc2V0RmlsbEFtb3VudFN0cixcclxuICAgICAgICAgICAgbWFya2V0T3BlcmF0aW9uLFxyXG4gICAgICAgICAgICBpbnRlZ3JhdG9ySWQsXHJcbiAgICAgICAgfSA9IHJlcXVlc3QuYm9keTtcclxuXHJcbiAgICAgICAgaWYgKFxyXG4gICAgICAgICAgICAobWFya2V0T3BlcmF0aW9uIGFzIHN0cmluZykgIT09IE1hcmtldE9wZXJhdGlvbi5CdXkudG9TdHJpbmcoKSAmJlxyXG4gICAgICAgICAgICAobWFya2V0T3BlcmF0aW9uIGFzIHN0cmluZykgIT09IE1hcmtldE9wZXJhdGlvbi5TZWxsLnRvU3RyaW5nKClcclxuICAgICAgICApIHtcclxuICAgICAgICAgICAgdGhyb3cgbmV3IEVycm9yKCdSZWNlaXZlZCByZXF1ZXN0IHdpdGggaW52YWxpZCBtYXJrZXQgb3BlcmF0aW9uJyk7XHJcbiAgICAgICAgfVxyXG5cclxuICAgICAgICBsZXQgaW50ZWdyYXRvcjogSW50ZWdyYXRvcjtcclxuICAgICAgICB0cnkge1xyXG4gICAgICAgICAgICBpbnRlZ3JhdG9yID0gdGhpcy5fY29uZmlnTWFuYWdlci5nZXRJbnRlZ3JhdG9yQnlJZE9yVGhyb3coaW50ZWdyYXRvcklkKTtcclxuICAgICAgICB9IGNhdGNoIChlcnJvcikge1xyXG4gICAgICAgICAgICB0aHJvdyBuZXcgRXJyb3IoJ05vIGludGVncmF0b3IgZm91bmQgZm9yIGludGVncmF0b3IgSUQnKTtcclxuICAgICAgICB9XHJcblxyXG4gICAgICAgIGlmIChpc0Zpcm0gJiYgdHhPcmlnaW4gPT09IHVuZGVmaW5lZCkge1xyXG4gICAgICAgICAgICB0aHJvdyBuZXcgRXJyb3IoJ1JlY2VpdmVkIHJlcXVlc3Qgd2l0aCBtaXNzaW5nIHBhcmFtZXRlciB0eE9yaWdpbicpO1xyXG4gICAgICAgIH1cclxuXHJcbiAgICAgICAgY29uc3QgaXNTZWxsaW5nID0gKG1hcmtldE9wZXJhdGlvbiBhcyBzdHJpbmcpID09PSBNYXJrZXRPcGVyYXRpb24uU2VsbC50b1N0cmluZygpO1xyXG4gICAgICAgIGNvbnN0IGFzc2V0RmlsbEFtb3VudCA9IG5ldyBCaWdOdW1iZXIoYXNzZXRGaWxsQW1vdW50U3RyKTtcclxuICAgICAgICBsZXQgdGFrZXJBbW91bnQsIG1ha2VyQW1vdW50O1xyXG4gICAgICAgIGlmIChpc1NlbGxpbmcpIHtcclxuICAgICAgICAgICAgdGFrZXJBbW91bnQgPSBhc3NldEZpbGxBbW91bnQ7XHJcbiAgICAgICAgfSBlbHNlIHtcclxuICAgICAgICAgICAgbWFrZXJBbW91bnQgPSBhc3NldEZpbGxBbW91bnQ7XHJcbiAgICAgICAgfVxyXG4gICAgICAgIGNvbnN0IHRha2VyVG9rZW5EZWNpbWFscyA9IGF3YWl0IHNlcnZpY2UuZ2V0VG9rZW5EZWNpbWFsc0FzeW5jKHRha2VyVG9rZW4pO1xyXG4gICAgICAgIGNvbnN0IG1ha2VyVG9rZW5EZWNpbWFscyA9IGF3YWl0IHNlcnZpY2UuZ2V0VG9rZW5EZWNpbWFsc0FzeW5jKG1ha2VyVG9rZW4pO1xyXG5cclxuICAgICAgICByZXR1cm4ge1xyXG4gICAgICAgICAgICB3b3JrZmxvdzogZ2FzbGVzcyA/ICdnYXNsZXNzLXJmcXQnIDogJ3JmcXQnLFxyXG4gICAgICAgICAgICBjaGFpbklkLFxyXG4gICAgICAgICAgICBpc0Zpcm0sXHJcbiAgICAgICAgICAgIHRha2VyVG9rZW4sXHJcbiAgICAgICAgICAgIG1ha2VyVG9rZW4sXHJcbiAgICAgICAgICAgIG9yaWdpbmFsTWFrZXJUb2tlbjogbWFrZXJUb2tlbixcclxuICAgICAgICAgICAgdHJhZGVyLFxyXG4gICAgICAgICAgICB0YWtlckFkZHJlc3MsXHJcbiAgICAgICAgICAgIHR4T3JpZ2luLFxyXG4gICAgICAgICAgICB0YWtlckFtb3VudCxcclxuICAgICAgICAgICAgbWFrZXJBbW91bnQsXHJcbiAgICAgICAgICAgIHRha2VyVG9rZW5EZWNpbWFscyxcclxuICAgICAgICAgICAgbWFrZXJUb2tlbkRlY2ltYWxzLFxyXG4gICAgICAgICAgICBpbnRlZ3JhdG9yLFxyXG4gICAgICAgICAgICBpc1Vud3JhcDogZmFsc2UsXHJcbiAgICAgICAgICAgIGlzU2VsbGluZyxcclxuICAgICAgICAgICAgYXNzZXRGaWxsQW1vdW50LFxyXG4gICAgICAgICAgICBmZWVNb2RlbFZlcnNpb246IHNlcnZpY2UuZmVlTW9kZWxWZXJzaW9uLFxyXG4gICAgICAgIH0gYXMgUXVvdGVDb250ZXh0O1xyXG4gICAgfVxyXG5cclxuICAgIC8qKlxyXG4gICAgICogR2V0cyB0aGUgYXBwcm9wcmlhdGUgYFJmcXRTZXJ2aWNlYCBpbnN0YW5jZSBmcm9tIHRoZVxyXG4gICAgICogQ2hhaW4gSUQgLT4gUmZxdCBTZXJ2aWNlIE1hcC4gVGhyb3dzIGlmIG5vIHNlcnZpY2UgaXMgZm91bmRcclxuICAgICAqIGZvciBgY2hhaW5JZGAuXHJcbiAgICAgKi9cclxuICAgIHByaXZhdGUgX2dldFNlcnZpY2VGb3JDaGFpbihjaGFpbklkOiBudW1iZXIpOiBSZnF0U2VydmljZSB7XHJcbiAgICAgICAgY29uc3Qgc2VydmljZSA9IHRoaXMuX3JmcXRTZXJ2aWNlcy5nZXQoY2hhaW5JZCk7XHJcblxyXG4gICAgICAgIGlmICghc2VydmljZSkge1xyXG4gICAgICAgICAgICB0aHJvdyBuZXcgRXJyb3IoJ05vIGNvbmZpZ3VyYXRpb24gZXhpc3RzIGZvciBjaGFpbicpO1xyXG4gICAgICAgIH1cclxuICAgICAgICByZXR1cm4gc2VydmljZTtcclxuICAgIH1cclxufVxyXG4iXSwidmVyc2lvbiI6M30=