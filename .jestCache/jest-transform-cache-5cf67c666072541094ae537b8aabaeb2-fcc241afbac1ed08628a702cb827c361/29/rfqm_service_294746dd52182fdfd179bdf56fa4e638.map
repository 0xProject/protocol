{"file":"/Users/davidwalsh/code-local/0x-rfq-api/src/services/rfqm_service.ts","mappings":"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","names":[],"sources":["/Users/davidwalsh/code-local/0x-rfq-api/src/services/rfqm_service.ts"],"sourcesContent":["// tslint:disable:max-file-line-count\r\nimport { TooManyRequestsError } from '@0x/api-utils';\r\nimport { AssetSwapperContractAddresses, MarketOperation } from '@0x/asset-swapper';\r\nimport { OtcOrder, ZERO } from '@0x/protocol-utils';\r\nimport {\r\n    getTokenMetadataIfExists,\r\n    nativeTokenSymbol,\r\n    nativeWrappedTokenSymbol,\r\n    TokenMetadata,\r\n} from '@0x/token-metadata';\r\nimport { BigNumber } from '@0x/utils';\r\nimport { Web3Wrapper } from '@0x/web3-wrapper';\r\nimport { retry } from '@lifeomic/attempt';\r\nimport { Producer as KafkaProducer } from 'kafkajs';\r\nimport * as _ from 'lodash';\r\nimport { Counter } from 'prom-client';\r\nimport { Producer } from 'sqs-producer';\r\n\r\nimport { ENABLE_LLR_COOLDOWN, RFQM_MAINTENANCE_MODE } from '../config';\r\nimport { NULL_ADDRESS, ONE_SECOND_MS, RFQM_NUM_BUCKETS } from '../core/constants';\r\nimport { MetaTransactionSubmissionEntity, RfqmV2TransactionSubmissionEntity } from '../entities';\r\nimport { RfqmV2JobApprovalOpts, RfqmV2JobConstructorOpts } from '../entities/RfqmV2JobEntity';\r\nimport {\r\n    JobFailureReason,\r\n    RfqmJobStatus,\r\n    RfqmTransactionSubmissionStatus,\r\n    RfqmTransactionSubmissionType,\r\n} from '../entities/types';\r\nimport { REASON_ON_STATUS_ERROR_RESPONSE_ENABLED } from '../config';\r\nimport { InternalServerError, NotFoundError, ValidationError, ValidationErrorCodes } from '../core/errors';\r\nimport { logger } from '../logger';\r\nimport { feeToStoredFee } from '../core/fee_utils';\r\nimport { toPairString } from '../core/pair_utils';\r\nimport {\r\n    Eip712DataField,\r\n    ExecuteMetaTransactionApproval,\r\n    ExecuteMetaTransactionEip712Context,\r\n    Fee,\r\n    FeeModelVersion,\r\n    FirmOtcQuote,\r\n    GaslessApprovalTypes,\r\n    GaslessTypes,\r\n    IndicativeQuote,\r\n    PermitApproval,\r\n    PermitEip712Context,\r\n} from '../core/types';\r\nimport { CacheClient } from '../utils/cache_client';\r\nimport { getBestQuote } from '../utils/quote_comparison_utils';\r\nimport { ExtendedQuoteReport, quoteReportUtils } from '../utils/quote_report_utils';\r\nimport { QuoteServerClient } from '../utils/quote_server_client';\r\nimport { otcOrderToStoredOtcOrder, RfqmDbUtils } from '../utils/rfqm_db_utils';\r\nimport { computeHealthCheckAsync, HealthCheckResult } from '../utils/rfqm_health_check';\r\nimport { RfqBlockchainUtils } from '../utils/rfq_blockchain_utils';\r\nimport { RfqMakerManager } from '../utils/rfq_maker_manager';\r\nimport { getSignerFromHash, padSignature } from '../utils/signature_utils';\r\nimport { TokenMetadataManager } from '../utils/TokenMetadataManager';\r\n\r\nimport { FeeService } from './fee_service';\r\nimport { RfqMakerBalanceCacheService } from './rfq_maker_balance_cache_service';\r\nimport {\r\n    ApprovalResponse,\r\n    FetchFirmQuoteParams,\r\n    FetchIndicativeQuoteParams,\r\n    FetchIndicativeQuoteResponse,\r\n    OtcOrderRfqmQuoteResponse,\r\n    OtcOrderSubmitRfqmSignedQuoteParams,\r\n    OtcOrderSubmitRfqmSignedQuoteResponse,\r\n    QuoteContext,\r\n    StatusResponse,\r\n    SubmitApprovalParams,\r\n    SubmitRfqmSignedQuoteWithApprovalParams,\r\n    SubmitRfqmSignedQuoteWithApprovalResponse,\r\n    TransactionDetails,\r\n} from './types';\r\n\r\nconst RFQM_QUOTE_INSERTED = new Counter({\r\n    name: 'rfqm_quote_inserted',\r\n    help: 'An RfqmQuote was inserted in the DB',\r\n    labelNames: ['apiKey', 'integratorId', 'makerUri'],\r\n});\r\n\r\nconst RFQM_SIGNED_QUOTE_NOT_FOUND = new Counter({\r\n    name: 'rfqm_signed_quote_not_found',\r\n    labelNames: ['chain_id'],\r\n    help: 'A submitted quote did not match any stored quotes',\r\n});\r\nconst RFQM_TAKER_AND_TAKERTOKEN_TRADE_EXISTS = new Counter({\r\n    name: 'rfqm_signed_quote_taker_and_takertoken_trade_exists',\r\n    labelNames: ['chain_id'],\r\n    help: 'A trade was submitted when the system already had a pending trade for the same taker and takertoken',\r\n});\r\nconst RFQM_SUBMIT_BALANCE_CHECK_FAILED = new Counter({\r\n    name: 'rfqm_submit_balance_check_failed',\r\n    labelNames: ['makerAddress', 'chain_id'],\r\n    help: 'A trade was submitted but our on-chain balance check failed',\r\n});\r\n\r\nconst RFQM_MAKER_BLOCKED_FOR_LLR_COOLDOWN = new Counter({\r\n    name: 'rfqm_maker_blocked_for_llr_cooldown',\r\n    help: 'A maker get blocked because of LLR cooldown',\r\n    labelNames: ['maker_id', 'chain_id', 'pair_key'],\r\n});\r\n\r\nconst RFQM_MM_RETURNED_DIFFERENT_AMOUNT = new Counter({\r\n    name: 'rfqm_mm_returned_different_amount_total',\r\n    help: 'A maker responded a quote with different amount than requested',\r\n    labelNames: ['maker_uri', 'chain_id', 'modification_type'],\r\n});\r\n\r\nconst PRICE_DECIMAL_PLACES = 6;\r\n\r\nconst getTokenAddressFromSymbol = (symbol: string, chainId: number): string => {\r\n    return (getTokenMetadataIfExists(symbol, chainId) as TokenMetadata).tokenAddress;\r\n};\r\n\r\n/**\r\n * RfqmService is the coordination layer for HTTP based RFQM flows.\r\n */\r\nexport class RfqmService {\r\n    private readonly _nativeTokenAddress: string;\r\n    private readonly _nativeTokenSymbol: string;\r\n    private readonly _nativeWrappedTokenSymbol: string;\r\n    private readonly _nativeWrappedTokenAddress: string;\r\n\r\n    private static _getSellAmountGivenBuyAmountAndQuote(\r\n        buyAmount: BigNumber,\r\n        quotedTakerAmount: BigNumber,\r\n        quotedMakerAmount: BigNumber,\r\n    ): BigNumber {\r\n        // Solving for x given the following proportion:\r\n        // x / buyAmount = quotedTakerAmount / quotedMakerAmount\r\n        return quotedTakerAmount.div(quotedMakerAmount).times(buyAmount).decimalPlaces(0);\r\n    }\r\n\r\n    private static _getBuyAmountGivenSellAmountAndQuote(\r\n        sellAmount: BigNumber,\r\n        quotedTakerAmount: BigNumber,\r\n        quotedMakerAmount: BigNumber,\r\n    ): BigNumber {\r\n        // Solving for y given the following proportion:\r\n        // y / sellAmount =  quotedMakerAmount / quotedTakerAmount\r\n        return quotedMakerAmount.div(quotedTakerAmount).times(sellAmount).decimalPlaces(0);\r\n    }\r\n\r\n    /**\r\n     * Transform a transaction submission to type `TransactionDetails`.\r\n     *\r\n     * @returns Corresponding `TransactionDetails` or null if transaction hash is not available.\r\n     */\r\n    private static _transformTransactionSubmission(\r\n        transactionSubmission: Pick<\r\n            RfqmV2TransactionSubmissionEntity | MetaTransactionSubmissionEntity,\r\n            'createdAt' | 'transactionHash'\r\n        >,\r\n    ): TransactionDetails | null {\r\n        const { transactionHash: hash, createdAt } = transactionSubmission;\r\n        return hash ? { hash, timestamp: createdAt.getTime() } : null;\r\n    }\r\n\r\n    /**\r\n     * Get details of the successful transaction submission (there will only be one).\r\n     *\r\n     * @param opts Options object that contains:\r\n     *             - `hash`: The hash of the order or metatransaction.\r\n     *             - `type`: The type of the transaction submissions.\r\n     *             - `transactionSubmssions`: List of transaction submissions to filter.\r\n     * @returns The details (hash and timestamp) of the successful transaction submission.\r\n     * @throws - When the number of the successful transaction submission is not 1\r\n     *         - The successful transaction submission does not have transaction hash\r\n     */\r\n    private static _getSuccessfulTransactionSubmissionDetails(opts: {\r\n        hash: string;\r\n        type: RfqmTransactionSubmissionType;\r\n        transactionSubmssions: Pick<\r\n            RfqmV2TransactionSubmissionEntity | MetaTransactionSubmissionEntity,\r\n            'createdAt' | 'status' | 'transactionHash'\r\n        >[];\r\n    }): TransactionDetails {\r\n        const { hash, type, transactionSubmssions } = opts;\r\n        const successfulTransactionSubmissions = transactionSubmssions.filter(\r\n            (s) =>\r\n                s.status === RfqmTransactionSubmissionStatus.SucceededUnconfirmed ||\r\n                s.status === RfqmTransactionSubmissionStatus.SucceededConfirmed,\r\n        );\r\n        if (successfulTransactionSubmissions.length !== 1) {\r\n            throw new Error(\r\n                `Expected exactly one successful transaction submission of type ${type} for hash ${hash}; found ${successfulTransactionSubmissions.length}`,\r\n            );\r\n        }\r\n        const successfulTransactionSubmission = successfulTransactionSubmissions[0];\r\n        const successfulTransactionSubmissionDetails = this._transformTransactionSubmission(\r\n            successfulTransactionSubmission,\r\n        );\r\n        if (!successfulTransactionSubmissionDetails) {\r\n            throw new Error(`Successful transaction of type ${type} does not have a hash ${hash}`);\r\n        }\r\n\r\n        return successfulTransactionSubmissionDetails;\r\n    }\r\n\r\n    private static _jobFailureStatusToReason(failureStatus: RfqmJobStatus): JobFailureReason {\r\n        switch (failureStatus) {\r\n            case RfqmJobStatus.FailedEthCallFailed:\r\n                return JobFailureReason.TransactionSimulationFailed;\r\n            case RfqmJobStatus.FailedExpired:\r\n                return JobFailureReason.OrderExpired;\r\n            case RfqmJobStatus.FailedLastLookDeclined:\r\n                return JobFailureReason.LastLookDeclined;\r\n            case RfqmJobStatus.FailedSignFailed:\r\n                return JobFailureReason.MarketMakerSignatureError;\r\n            case RfqmJobStatus.FailedRevertedConfirmed:\r\n            case RfqmJobStatus.FailedRevertedUnconfirmed:\r\n                return JobFailureReason.TransactionReverted;\r\n            default:\r\n                return JobFailureReason.InternalError;\r\n        }\r\n    }\r\n\r\n    constructor(\r\n        private readonly _chainId: number,\r\n        private readonly _feeService: FeeService,\r\n        private readonly _feeModelVersion: FeeModelVersion,\r\n        private readonly _contractAddresses: AssetSwapperContractAddresses,\r\n        private readonly _registryAddress: string,\r\n        private readonly _blockchainUtils: RfqBlockchainUtils,\r\n        private readonly _dbUtils: RfqmDbUtils,\r\n        private readonly _sqsProducer: Producer,\r\n        private readonly _quoteServerClient: QuoteServerClient,\r\n        private readonly _minExpiryDurationMs: number,\r\n        private readonly _cacheClient: CacheClient,\r\n        private readonly _rfqMakerBalanceCacheService: RfqMakerBalanceCacheService,\r\n        private readonly _rfqMakerManager: RfqMakerManager,\r\n        private readonly _tokenMetadataManager: TokenMetadataManager,\r\n        private readonly _kafkaProducer?: KafkaProducer,\r\n        private readonly _quoteReportTopic?: string,\r\n    ) {\r\n        this._nativeTokenSymbol = nativeTokenSymbol(this._chainId);\r\n        this._nativeTokenAddress = getTokenAddressFromSymbol(this._nativeTokenSymbol, this._chainId);\r\n        this._nativeWrappedTokenSymbol = nativeWrappedTokenSymbol(this._chainId);\r\n        this._nativeWrappedTokenAddress = getTokenAddressFromSymbol(this._nativeWrappedTokenSymbol, this._chainId);\r\n    }\r\n\r\n    /**\r\n     * Passthrough to TokenMetadataManager's `getTokenDecimalsAsync` method\r\n     */\r\n    public async getTokenDecimalsAsync(tokenAddress: string): Promise<number> {\r\n        return this._tokenMetadataManager.getTokenDecimalsAsync(tokenAddress);\r\n    }\r\n\r\n    /**\r\n     * Fetch the best indicative quote available. Returns null if no valid quotes found\r\n     */\r\n    public async fetchIndicativeQuoteAsync(\r\n        params: FetchIndicativeQuoteParams,\r\n        extendedQuoteReportSubmissionBy: ExtendedQuoteReport['submissionBy'] = 'rfqm',\r\n    ): Promise<FetchIndicativeQuoteResponse | null> {\r\n        const affiliateAddress = params.affiliateAddress ?? params.integrator.affiliateAddress;\r\n\r\n        // Retrieve quote context\r\n        const quoteContext = this._retrieveQuoteContext({ ...params, affiliateAddress }, /* isFirm */ false);\r\n        const {\r\n            isFirm,\r\n            takerAmount,\r\n            makerAmount,\r\n            takerToken,\r\n            makerToken,\r\n            originalMakerToken,\r\n            takerTokenDecimals,\r\n            makerTokenDecimals,\r\n            takerAddress,\r\n            isSelling,\r\n            assetFillAmount,\r\n            integrator,\r\n        } = quoteContext;\r\n\r\n        // (Optimization) When `quotesWithGasFee` is returned, we can use this value and revise it, to avoid another fetch to MMs\r\n        const { feeWithDetails, quotesWithGasFee, ammQuoteUniqueId } = await this._feeService.calculateFeeAsync(\r\n            quoteContext,\r\n            this._fetchIndicativeQuotesAsync.bind(this),\r\n        );\r\n\r\n        // Calculate fees (other than gas fee) to charge MMs\r\n        const otherFeesAmount = feeWithDetails.amount.minus(feeWithDetails.details.gasFeeAmount);\r\n\r\n        const finalQuotes = quotesWithGasFee\r\n            ? await this._feeService.reviseQuotesAsync(quotesWithGasFee, otherFeesAmount, quoteContext)\r\n            : await this._fetchIndicativeQuotesAsync(quoteContext, feeWithDetails);\r\n\r\n        // (Quote Report) If otherFees > 0, then we \"revised\" the quotes from MMs. We want to save both the original quotes (aka intermediateQuotes) and the revised (finalQuotes)\r\n        const intermediateQuotes = quotesWithGasFee && otherFeesAmount.gt(ZERO) ? quotesWithGasFee : [];\r\n\r\n        // Get the best quote\r\n        const bestQuote = getBestQuote(\r\n            finalQuotes,\r\n            isSelling,\r\n            takerToken,\r\n            makerToken,\r\n            assetFillAmount,\r\n            this._minExpiryDurationMs,\r\n        );\r\n\r\n        const isLiquidityAvailable = bestQuote !== null;\r\n\r\n        // Quote Report\r\n        if (this._kafkaProducer) {\r\n            await quoteReportUtils.publishRFQMQuoteReportAsync(\r\n                {\r\n                    isFirmQuote: isFirm,\r\n                    taker: takerAddress,\r\n                    buyTokenAddress: originalMakerToken,\r\n                    sellTokenAddress: takerToken,\r\n                    buyAmount: makerAmount,\r\n                    sellAmount: takerAmount,\r\n                    integratorId: integrator?.integratorId,\r\n                    finalQuotes,\r\n                    intermediateQuotes,\r\n                    bestQuote,\r\n                    fee: feeToStoredFee(feeWithDetails),\r\n                    ammQuoteUniqueId,\r\n                    isLiquidityAvailable,\r\n                },\r\n                this._kafkaProducer,\r\n                this._quoteReportTopic,\r\n                extendedQuoteReportSubmissionBy,\r\n            );\r\n        }\r\n\r\n        // No quotes found\r\n        if (!isLiquidityAvailable) {\r\n            return null;\r\n        }\r\n\r\n        // Prepare the price\r\n        const makerAmountInUnit = Web3Wrapper.toUnitAmount(bestQuote.makerAmount, makerTokenDecimals);\r\n        const takerAmountInUnit = Web3Wrapper.toUnitAmount(bestQuote.takerAmount, takerTokenDecimals);\r\n        const price = isSelling ? makerAmountInUnit.div(takerAmountInUnit) : takerAmountInUnit.div(makerAmountInUnit);\r\n        // The way the BigNumber round down behavior (https://mikemcl.github.io/bignumber.js/#dp) works requires us\r\n        // to add 1 to PRICE_DECIMAL_PLACES in order to actually come out with the decimal places specified.\r\n        const roundedPrice = price.decimalPlaces(PRICE_DECIMAL_PLACES + 1, BigNumber.ROUND_DOWN);\r\n\r\n        // Prepare response\r\n        return {\r\n            price: roundedPrice,\r\n            gas: feeWithDetails.details.gasPrice,\r\n            buyAmount: bestQuote.makerAmount,\r\n            buyTokenAddress: originalMakerToken,\r\n            sellAmount: bestQuote.takerAmount,\r\n            sellTokenAddress: bestQuote.takerToken,\r\n            allowanceTarget: this._contractAddresses.exchangeProxy,\r\n        };\r\n    }\r\n\r\n    /**\r\n     * Fetch the best firm quote available, including a metatransaction. Returns null if no valid quotes found\r\n     */\r\n    public async fetchFirmQuoteAsync(\r\n        params: FetchFirmQuoteParams,\r\n        extendedQuoteReportSubmissionBy: ExtendedQuoteReport['submissionBy'] = 'rfqm',\r\n    ): Promise<{ quote: OtcOrderRfqmQuoteResponse | null; quoteReportId: string | null }> {\r\n        const affiliateAddress = params.affiliateAddress ?? params.integrator.affiliateAddress;\r\n        // Retrieve quote context\r\n        const quoteContext = this._retrieveQuoteContext({ ...params, affiliateAddress }, /* isFirm */ true);\r\n        const {\r\n            isFirm,\r\n            takerAmount,\r\n            makerAmount,\r\n            takerToken,\r\n            makerToken,\r\n            originalMakerToken,\r\n            takerTokenDecimals,\r\n            makerTokenDecimals,\r\n            takerAddress,\r\n            integrator,\r\n            isUnwrap,\r\n            isSelling,\r\n            assetFillAmount,\r\n        } = quoteContext;\r\n\r\n        // (Optimization) When `quotesWithGasFee` is returned, we can sometimes reuse it, to avoid another fetch to MMs\r\n        // NOTE: this optimization differs from the optimization for indicative quotes because we do NOT revise firm quotes\r\n        const { feeWithDetails, quotesWithGasFee, ammQuoteUniqueId } = await this._feeService.calculateFeeAsync(\r\n            quoteContext,\r\n            this._fetchIndicativeQuotesAsync.bind(this),\r\n        );\r\n\r\n        // Calculate fees (other than gas fee) to charge MMs. If there are other fees, we don't reuse `quotesWithGasFee`\r\n        const otherFeesAmount = feeWithDetails.amount.minus(feeWithDetails.details.gasFeeAmount);\r\n\r\n        // If `quotesWithGasFee` have been obtained and there are no other fees, reuse the quotes. Otherwise call MMs with full fee to get new quotes.\r\n        const finalQuotes =\r\n            quotesWithGasFee && otherFeesAmount.eq(ZERO)\r\n                ? await this._convertToFirmQuotesAsync(quotesWithGasFee, quoteContext)\r\n                : await this._fetchFirmQuotesAsync(quoteContext, feeWithDetails);\r\n\r\n        // (Quote Report) If `quotesWithGasFee` have not been reused, save them as intermediate quotes\r\n        const intermediateQuotes = quotesWithGasFee && otherFeesAmount.gt(ZERO) ? quotesWithGasFee : [];\r\n\r\n        // (Maker Balance Cache) Fetch maker balances to validate whether quotes are fully fillable\r\n        let quotedMakerBalances: BigNumber[] | undefined;\r\n        const quotedERC20Owners = finalQuotes.map((quote) => {\r\n            return {\r\n                owner: quote.order.maker,\r\n                token: makerToken,\r\n            };\r\n        });\r\n        try {\r\n            quotedMakerBalances = await this._rfqMakerBalanceCacheService.getERC20OwnerBalancesAsync(\r\n                this._chainId,\r\n                quotedERC20Owners,\r\n            );\r\n        } catch (e) {\r\n            logger.error(\r\n                { chainId: this._chainId, quotedERC20Owners, errorMessage: e.message },\r\n                'Failed to fetch maker balances to validate firm quotes',\r\n            );\r\n        }\r\n\r\n        // Get the best quote\r\n        const bestQuote = getBestQuote(\r\n            finalQuotes,\r\n            isSelling,\r\n            takerToken,\r\n            makerToken,\r\n            assetFillAmount,\r\n            this._minExpiryDurationMs,\r\n            quotedMakerBalances,\r\n        );\r\n\r\n        const isLiquidityAvailable = bestQuote !== null;\r\n\r\n        const storedFeeWithDetails = feeToStoredFee(feeWithDetails);\r\n\r\n        let quoteReportId: string | null = null;\r\n        // Quote Report\r\n        if (this._kafkaProducer) {\r\n            quoteReportId = await quoteReportUtils.publishRFQMQuoteReportAsync(\r\n                {\r\n                    isFirmQuote: isFirm,\r\n                    taker: takerAddress,\r\n                    buyTokenAddress: originalMakerToken,\r\n                    sellTokenAddress: takerToken,\r\n                    buyAmount: makerAmount,\r\n                    sellAmount: takerAmount,\r\n                    integratorId: integrator?.integratorId,\r\n                    finalQuotes,\r\n                    intermediateQuotes,\r\n                    bestQuote,\r\n                    fee: storedFeeWithDetails,\r\n                    ammQuoteUniqueId,\r\n                    isLiquidityAvailable,\r\n                },\r\n                this._kafkaProducer,\r\n                this._quoteReportTopic,\r\n                extendedQuoteReportSubmissionBy,\r\n            );\r\n        }\r\n\r\n        // No quote found\r\n        if (!isLiquidityAvailable) {\r\n            return { quote: null, quoteReportId };\r\n        }\r\n\r\n        // Get the makerUri\r\n        const makerUri = bestQuote.makerUri;\r\n        if (makerUri === undefined) {\r\n            logger.error({ makerAddress: bestQuote.order.maker }, 'makerUri unknown for maker address');\r\n            throw new Error(`makerUri unknown for maker address ${bestQuote.order.maker}`);\r\n        }\r\n\r\n        // Prepare the price\r\n        const makerAmountInUnit = Web3Wrapper.toUnitAmount(bestQuote.order.makerAmount, makerTokenDecimals);\r\n        const takerAmountInUnit = Web3Wrapper.toUnitAmount(bestQuote.order.takerAmount, takerTokenDecimals);\r\n        const price = isSelling ? makerAmountInUnit.div(takerAmountInUnit) : takerAmountInUnit.div(makerAmountInUnit);\r\n        // The way the BigNumber round down behavior (https://mikemcl.github.io/bignumber.js/#dp) works requires us\r\n        // to add 1 to PRICE_DECIMAL_PLACES in order to actually come out with the decimal places specified.\r\n        const roundedPrice = price.decimalPlaces(PRICE_DECIMAL_PLACES + 1, BigNumber.ROUND_DOWN);\r\n\r\n        // Prepare the final takerAmount and makerAmount\r\n        const sellAmount = isSelling\r\n            ? // $eslint-fix-me https://github.com/rhinodavid/eslint-fix-me\r\n              // eslint-disable-next-line @typescript-eslint/no-non-null-assertion\r\n              takerAmount!\r\n            : RfqmService._getSellAmountGivenBuyAmountAndQuote(\r\n                  // $eslint-fix-me https://github.com/rhinodavid/eslint-fix-me\r\n                  // eslint-disable-next-line @typescript-eslint/no-non-null-assertion\r\n                  makerAmount!,\r\n                  bestQuote.order.takerAmount,\r\n                  bestQuote.order.makerAmount,\r\n              );\r\n\r\n        const buyAmount = isSelling\r\n            ? RfqmService._getBuyAmountGivenSellAmountAndQuote(\r\n                  // $eslint-fix-me https://github.com/rhinodavid/eslint-fix-me\r\n                  // eslint-disable-next-line @typescript-eslint/no-non-null-assertion\r\n                  takerAmount!,\r\n                  bestQuote.order.takerAmount,\r\n                  bestQuote.order.makerAmount,\r\n              )\r\n            : // $eslint-fix-me https://github.com/rhinodavid/eslint-fix-me\r\n              // eslint-disable-next-line @typescript-eslint/no-non-null-assertion\r\n              makerAmount!;\r\n\r\n        // Get the Order and its hash\r\n        const orderHash = bestQuote.order.getHash();\r\n\r\n        const otcOrder = bestQuote.order;\r\n        await this._dbUtils.writeV2QuoteAsync({\r\n            orderHash,\r\n            chainId: this._chainId,\r\n            fee: storedFeeWithDetails,\r\n            order: otcOrderToStoredOtcOrder(otcOrder),\r\n            makerUri,\r\n            affiliateAddress,\r\n            integratorId: integrator.integratorId,\r\n            isUnwrap,\r\n            takerSpecifiedSide: params.sellAmount ? 'takerToken' : 'makerToken',\r\n        });\r\n\r\n        const approval = params.checkApproval\r\n            ? // $eslint-fix-me https://github.com/rhinodavid/eslint-fix-me\r\n              // eslint-disable-next-line @typescript-eslint/no-non-null-assertion\r\n              await this.getGaslessApprovalResponseAsync(takerAddress!, takerToken, sellAmount)\r\n            : null;\r\n\r\n        RFQM_QUOTE_INSERTED.labels(integrator.integratorId, integrator.integratorId, makerUri).inc();\r\n        return {\r\n            quote: {\r\n                type: GaslessTypes.OtcOrder,\r\n                price: roundedPrice,\r\n                gas: feeWithDetails.details.gasPrice,\r\n                buyAmount,\r\n                buyTokenAddress: originalMakerToken,\r\n                sellAmount,\r\n                sellTokenAddress: bestQuote.order.takerToken,\r\n                allowanceTarget: this._contractAddresses.exchangeProxy,\r\n                order: bestQuote.order,\r\n                orderHash,\r\n                // use approval variable directly is not ideal as we don't want to include approval field if `approval` is null\r\n                ...(approval && { approval }),\r\n            },\r\n            quoteReportId,\r\n        };\r\n    }\r\n\r\n    /**\r\n     * Get the value of the approval response in firm quote responses. The approval response contains whether an approval is required, is gasless approval\r\n     * is available for the token (optional), the type of the gasless approval (optional) and the EIP712 context (optional).\r\n     *\r\n     * @param takerAddress The address of the taker.\r\n     * @param tokenToApprove Token address to be approved.\r\n     * @param sellAmount Amount of token to sell in base unit.\r\n     * @returns The approval response.\r\n     */\r\n    public async getGaslessApprovalResponseAsync(\r\n        takerAddress: string,\r\n        tokenToApprove: string,\r\n        sellAmount: BigNumber,\r\n    ): Promise<ApprovalResponse> {\r\n        const allowance = await this._blockchainUtils.getAllowanceAsync(\r\n            tokenToApprove,\r\n            takerAddress,\r\n            this._blockchainUtils.getExchangeProxyAddress(),\r\n        );\r\n        const isRequired = allowance.lte(sellAmount);\r\n        if (!isRequired) {\r\n            return {\r\n                isRequired,\r\n            };\r\n        }\r\n\r\n        const gaslessApproval = await this._blockchainUtils.getGaslessApprovalAsync(\r\n            this._chainId,\r\n            tokenToApprove,\r\n            takerAddress,\r\n        );\r\n        const isGaslessAvailable = gaslessApproval !== null;\r\n        if (!isGaslessAvailable) {\r\n            return {\r\n                isRequired,\r\n                isGaslessAvailable,\r\n            };\r\n        }\r\n\r\n        return {\r\n            isRequired,\r\n            isGaslessAvailable,\r\n            type: gaslessApproval.kind,\r\n            eip712: gaslessApproval.eip712,\r\n        };\r\n    }\r\n\r\n    public async getStatusAsync(tradeHash: string): Promise<StatusResponse | null> {\r\n        const transformSubmissions = (\r\n            submissions: RfqmV2TransactionSubmissionEntity[] | MetaTransactionSubmissionEntity[],\r\n        ) => {\r\n            // `_transformTransactionSubmission` is a static method so no-unbound-method does not apply here\r\n            // tslint:disable-next-line:no-unbound-method\r\n            return submissions.map(RfqmService._transformTransactionSubmission).flatMap((s) => (s ? s : []));\r\n        };\r\n\r\n        const job = await Promise.all([\r\n            this._dbUtils.findV2JobByOrderHashAsync(tradeHash),\r\n            this._dbUtils.findMetaTransactionJobByMetaTransactionHashAsync(tradeHash),\r\n        ]).then((jobs) => jobs.find((x) => x));\r\n\r\n        if (!job) {\r\n            return null;\r\n        }\r\n\r\n        const { status, expiry } = job;\r\n\r\n        if (status === RfqmJobStatus.PendingEnqueued && expiry.multipliedBy(ONE_SECOND_MS).lt(Date.now())) {\r\n            // the workers are dead/on vacation and the expiration time has passed\r\n            return {\r\n                status: 'failed',\r\n                transactions: [],\r\n                ...(REASON_ON_STATUS_ERROR_RESPONSE_ENABLED && {\r\n                    reason: JobFailureReason.OrderExpired,\r\n                }),\r\n            };\r\n        }\r\n\r\n        const tradeTransactionSubmissions =\r\n            job.kind === 'rfqm_v2_job'\r\n                ? await this._dbUtils.findV2TransactionSubmissionsByOrderHashAsync(\r\n                      job.orderHash,\r\n                      RfqmTransactionSubmissionType.Trade,\r\n                  )\r\n                : await this._dbUtils.findMetaTransactionSubmissionsByJobIdAsync(\r\n                      job.id,\r\n                      RfqmTransactionSubmissionType.Trade,\r\n                  );\r\n        const shouldIncludeApproval = !!job.approval;\r\n        let approvalTransactionSubmissions: RfqmV2TransactionSubmissionEntity[] | MetaTransactionSubmissionEntity[] =\r\n            [];\r\n        if (shouldIncludeApproval) {\r\n            approvalTransactionSubmissions =\r\n                job.kind === 'rfqm_v2_job'\r\n                    ? await this._dbUtils.findV2TransactionSubmissionsByOrderHashAsync(\r\n                          job.orderHash,\r\n                          RfqmTransactionSubmissionType.Approval,\r\n                      )\r\n                    : await this._dbUtils.findMetaTransactionSubmissionsByJobIdAsync(\r\n                          job.id,\r\n                          RfqmTransactionSubmissionType.Approval,\r\n                      );\r\n        }\r\n\r\n        switch (status) {\r\n            case RfqmJobStatus.PendingEnqueued:\r\n            case RfqmJobStatus.PendingProcessing:\r\n            case RfqmJobStatus.PendingLastLookAccepted:\r\n                return { status: 'pending', transactions: [] };\r\n            case RfqmJobStatus.PendingSubmitted:\r\n                return {\r\n                    status: 'submitted',\r\n                    transactions: transformSubmissions(tradeTransactionSubmissions),\r\n                    ...(shouldIncludeApproval && {\r\n                        approvalTransactions: transformSubmissions(approvalTransactionSubmissions),\r\n                    }),\r\n                };\r\n            case RfqmJobStatus.FailedEthCallFailed:\r\n            case RfqmJobStatus.FailedExpired:\r\n            case RfqmJobStatus.FailedLastLookDeclined:\r\n            case RfqmJobStatus.FailedPresignValidationFailed:\r\n            case RfqmJobStatus.FailedRevertedConfirmed:\r\n            case RfqmJobStatus.FailedRevertedUnconfirmed:\r\n            case RfqmJobStatus.FailedSignFailed:\r\n            case RfqmJobStatus.FailedSubmitFailed:\r\n            case RfqmJobStatus.FailedValidationNoCallData:\r\n            case RfqmJobStatus.FailedValidationNoFee:\r\n            case RfqmJobStatus.FailedValidationNoMakerUri:\r\n            case RfqmJobStatus.FailedValidationNoOrder:\r\n            case RfqmJobStatus.FailedValidationNoTakerSignature:\r\n                return {\r\n                    status: 'failed',\r\n                    transactions: transformSubmissions(tradeTransactionSubmissions),\r\n                    ...(shouldIncludeApproval && {\r\n                        approvalTransactions: transformSubmissions(approvalTransactionSubmissions),\r\n                    }),\r\n                    ...(REASON_ON_STATUS_ERROR_RESPONSE_ENABLED && {\r\n                        reason: RfqmService._jobFailureStatusToReason(status),\r\n                    }),\r\n                };\r\n            case RfqmJobStatus.SucceededConfirmed:\r\n            case RfqmJobStatus.SucceededUnconfirmed:\r\n                return {\r\n                    status: status === RfqmJobStatus.SucceededUnconfirmed ? 'succeeded' : 'confirmed',\r\n                    transactions: [\r\n                        RfqmService._getSuccessfulTransactionSubmissionDetails({\r\n                            hash: job.getHash(),\r\n                            type: RfqmTransactionSubmissionType.Trade,\r\n                            transactionSubmssions: tradeTransactionSubmissions,\r\n                        }),\r\n                    ],\r\n                    ...(shouldIncludeApproval && {\r\n                        approvalTransactions: [\r\n                            RfqmService._getSuccessfulTransactionSubmissionDetails({\r\n                                hash: job.getHash(),\r\n                                type: RfqmTransactionSubmissionType.Approval,\r\n                                transactionSubmssions: approvalTransactionSubmissions,\r\n                            }),\r\n                        ],\r\n                    }),\r\n                };\r\n            default:\r\n                ((_x: never): never => {\r\n                    throw new Error('Unreachable');\r\n                })(status);\r\n        }\r\n    }\r\n\r\n    /**\r\n     * Runs checks to determine the health of the RFQm system. The results may be distilled to a format needed by integrators.\r\n     */\r\n    public async runHealthCheckAsync(): Promise<HealthCheckResult> {\r\n        const heartbeats = await this._dbUtils.findRfqmWorkerHeartbeatsAsync(this._chainId);\r\n        let gasPrice: BigNumber | undefined;\r\n        try {\r\n            gasPrice = await this._feeService.getGasPriceEstimationAsync();\r\n        } catch (error) {\r\n            logger.warn({ errorMessage: error.message }, 'Failed to get gas price for health check');\r\n        }\r\n        return computeHealthCheckAsync(\r\n            RFQM_MAINTENANCE_MODE,\r\n            this._rfqMakerManager.getRfqmV2MakerOfferings(),\r\n            this._sqsProducer,\r\n            heartbeats,\r\n            this._chainId,\r\n            gasPrice,\r\n        );\r\n    }\r\n\r\n    /**\r\n     * Validates and enqueues the Taker Signed Otc Order with approval for submission.\r\n     * Can also be used to submit order without approval if approval params are not supplied.\r\n     */\r\n    public async submitTakerSignedOtcOrderWithApprovalAsync<\r\n        T extends ExecuteMetaTransactionEip712Context | PermitEip712Context,\r\n    >(params: SubmitRfqmSignedQuoteWithApprovalParams<T>): Promise<SubmitRfqmSignedQuoteWithApprovalResponse> {\r\n        let submitRfqmSignedQuoteWithApprovalRes: SubmitRfqmSignedQuoteWithApprovalResponse;\r\n        const { approval, trade } = params;\r\n\r\n        const rfqmApprovalOpts = approval\r\n            ? await this.createApprovalAsync(approval, trade.order.getHash(), trade.order.takerToken)\r\n            : undefined;\r\n        // $eslint-fix-me https://github.com/rhinodavid/eslint-fix-me\r\n        // eslint-disable-next-line prefer-const\r\n        submitRfqmSignedQuoteWithApprovalRes = await this.submitTakerSignedOtcOrderAsync(trade, rfqmApprovalOpts);\r\n\r\n        return submitRfqmSignedQuoteWithApprovalRes;\r\n    }\r\n\r\n    /**\r\n     * Processes a signed approval sent to the submission endpoint in order to\r\n     * create the approval data needed by the job.\r\n     */\r\n    public async createApprovalAsync<T extends ExecuteMetaTransactionEip712Context | PermitEip712Context>(\r\n        approval: SubmitApprovalParams<T>,\r\n        tradeHash: string,\r\n        takerToken: string,\r\n    ): Promise<RfqmV2JobApprovalOpts> {\r\n        let { signature } = approval;\r\n\r\n        // validate and convert EIP712 context to corresponding Approval object\r\n        const parsedApproval = this._convertEIP712ContextToApproval(approval.eip712, tradeHash);\r\n\r\n        // pad approval signature if there are missing bytes\r\n        const paddedSignature = padSignature(signature);\r\n        if (paddedSignature.r !== signature.r || paddedSignature.s !== signature.s) {\r\n            logger.warn(\r\n                { tradeHash, r: paddedSignature.r, s: paddedSignature.s },\r\n                'Got approval signature with missing bytes',\r\n            );\r\n            signature = paddedSignature;\r\n        }\r\n\r\n        // perform an eth_call on the approval object and signature\r\n        try {\r\n            const approvalCalldata = await this._blockchainUtils.generateApprovalCalldataAsync(\r\n                takerToken,\r\n                parsedApproval,\r\n                signature,\r\n            );\r\n            await retry(\r\n                async () => {\r\n                    // Use `estimateGasForAsync` to simulate the transaction. In ethers.js, provider.call and\r\n                    // provider.send('eth_call', ...) might not throw exception and the behavior might be dependent\r\n                    // on providers. Revisit this later\r\n                    return this._blockchainUtils.estimateGasForAsync({ to: takerToken, data: approvalCalldata });\r\n                },\r\n                {\r\n                    delay: ONE_SECOND_MS,\r\n                    factor: 1,\r\n                    maxAttempts: 3,\r\n                    handleError: (error, context, _options) => {\r\n                        const { attemptNum: attemptNumber, attemptsRemaining } = context;\r\n                        logger.warn(\r\n                            {\r\n                                attemptNumber,\r\n                                attemptsRemaining,\r\n                                errorMessage: error.message,\r\n                                stack: error.stack,\r\n                                tradeHash,\r\n                            },\r\n                            'Error during eth_call approval validation. Retrying.',\r\n                        );\r\n                    },\r\n                },\r\n            );\r\n        } catch (error) {\r\n            logger.error({ errorMessage: error.message }, 'Eth call approval validation failed');\r\n            throw new Error('Eth call approval validation failed');\r\n        }\r\n\r\n        return {\r\n            approval: parsedApproval,\r\n            approvalSignature: signature,\r\n        };\r\n    }\r\n\r\n    /**\r\n     * Validates and enqueues the Taker Signed Otc Order for submission\r\n     */\r\n    public async submitTakerSignedOtcOrderAsync(\r\n        params: OtcOrderSubmitRfqmSignedQuoteParams,\r\n        rfqmApprovalOpts?: RfqmV2JobApprovalOpts,\r\n    ): Promise<OtcOrderSubmitRfqmSignedQuoteResponse> {\r\n        const { order } = params;\r\n        let { signature: takerSignature } = params;\r\n        const orderHash = order.getHash();\r\n        const takerAddress = order.taker.toLowerCase();\r\n        const makerAddress = order.maker.toLowerCase();\r\n        const takerToken = order.takerToken.toLowerCase();\r\n        const makerToken = order.makerToken.toLowerCase();\r\n        // check that the orderHash is indeed a recognized quote\r\n        const quote = await this._dbUtils.findV2QuoteByOrderHashAsync(orderHash);\r\n        if (!quote) {\r\n            RFQM_SIGNED_QUOTE_NOT_FOUND.inc();\r\n            throw new NotFoundError('quote not found');\r\n        }\r\n\r\n        // validate that the expiration window is long enough to fill quote\r\n        const currentTimeMs = new Date().getTime();\r\n        if (!order.expiry.times(ONE_SECOND_MS).isGreaterThan(currentTimeMs + this._minExpiryDurationMs)) {\r\n            throw new ValidationError([\r\n                {\r\n                    field: 'expiryAndNonce',\r\n                    code: ValidationErrorCodes.FieldInvalid,\r\n                    reason: `order will expire too soon`,\r\n                },\r\n            ]);\r\n        }\r\n\r\n        // validate that there is not a pending transaction for this taker and taker token\r\n        const pendingJobs = await this._dbUtils.findV2JobsWithStatusesAsync([\r\n            RfqmJobStatus.PendingEnqueued,\r\n            RfqmJobStatus.PendingProcessing,\r\n            RfqmJobStatus.PendingLastLookAccepted,\r\n            RfqmJobStatus.PendingSubmitted,\r\n        ]);\r\n\r\n        if (\r\n            pendingJobs.some(\r\n                (job) =>\r\n                    job.order?.order.taker.toLowerCase() === quote.order?.order.taker.toLowerCase() &&\r\n                    job.order?.order.takerToken.toLowerCase() === quote.order?.order.takerToken.toLowerCase() &&\r\n                    // Other logic handles the case where the same order is submitted twice\r\n                    job.orderHash !== quote.orderHash,\r\n            )\r\n        ) {\r\n            RFQM_TAKER_AND_TAKERTOKEN_TRADE_EXISTS.labels(this._chainId.toString()).inc();\r\n            throw new TooManyRequestsError('a pending trade for this taker and takertoken already exists');\r\n        }\r\n\r\n        // In the unlikely event that takers submit a signature with a missing byte, pad the signature.\r\n        const paddedSignature = padSignature(takerSignature);\r\n        if (paddedSignature.r !== takerSignature.r || paddedSignature.s !== takerSignature.s) {\r\n            logger.warn(\r\n                { orderHash, r: paddedSignature.r, s: paddedSignature.s },\r\n                'Got taker signature with missing bytes',\r\n            );\r\n            takerSignature = paddedSignature;\r\n        }\r\n\r\n        // validate that the given taker signature is valid\r\n        const signerAddress = getSignerFromHash(orderHash, takerSignature).toLowerCase();\r\n        if (signerAddress !== takerAddress) {\r\n            logger.warn({ signerAddress, takerAddress, orderHash }, 'Signature is invalid');\r\n            throw new ValidationError([\r\n                {\r\n                    field: 'signature',\r\n                    code: ValidationErrorCodes.InvalidSignatureOrHash,\r\n                    reason: `signature is not valid`,\r\n                },\r\n            ]);\r\n        }\r\n\r\n        // Validate that order is fillable by both the maker and the taker according to balances and/or allowances.\r\n        // If rfqmApprovalOpts is not passed, allowances are not checked at this stage since gasless approval has not been done yet.\r\n        const [makerBalance] = await this._rfqMakerBalanceCacheService.getERC20OwnerBalancesAsync(this._chainId, [\r\n            {\r\n                owner: makerAddress,\r\n                token: makerToken,\r\n            },\r\n        ]);\r\n        const [takerBalance] = rfqmApprovalOpts\r\n            ? await this._blockchainUtils.getTokenBalancesAsync({ owner: takerAddress, token: takerToken })\r\n            : await this._blockchainUtils.getMinOfBalancesAndAllowancesAsync({\r\n                  owner: takerAddress,\r\n                  token: takerToken,\r\n              });\r\n\r\n        if (makerBalance.lt(order.makerAmount) || takerBalance.lt(order.takerAmount)) {\r\n            RFQM_SUBMIT_BALANCE_CHECK_FAILED.labels(makerAddress, this._chainId.toString()).inc();\r\n            logger.warn(\r\n                {\r\n                    makerBalance,\r\n                    takerBalance,\r\n                    makerAddress,\r\n                    takerAddress,\r\n                    orderHash,\r\n                    order,\r\n                },\r\n                'Balance check failed while user was submitting',\r\n            );\r\n            throw new ValidationError([\r\n                {\r\n                    field: 'n/a',\r\n                    code: ValidationErrorCodes.InvalidOrder,\r\n                    reason: `order is not fillable`,\r\n                },\r\n            ]);\r\n        }\r\n\r\n        // prepare the job\r\n        let rfqmJobOpts: RfqmV2JobConstructorOpts = {\r\n            // $eslint-fix-me https://github.com/rhinodavid/eslint-fix-me\r\n            // eslint-disable-next-line @typescript-eslint/no-non-null-assertion\r\n            orderHash: quote.orderHash!,\r\n            createdAt: new Date(),\r\n            expiry: order.expiry,\r\n            chainId: this._chainId,\r\n            integratorId: quote.integratorId ? quote.integratorId : null,\r\n            makerUri: quote.makerUri,\r\n            status: RfqmJobStatus.PendingEnqueued,\r\n            fee: quote.fee,\r\n            order: quote.order,\r\n            takerSignature,\r\n            affiliateAddress: quote.affiliateAddress,\r\n            isUnwrap: quote.isUnwrap,\r\n            takerSpecifiedSide: quote.takerSpecifiedSide,\r\n        };\r\n\r\n        // if approval opts are supplied, add params to job table\r\n        if (rfqmApprovalOpts) {\r\n            rfqmJobOpts = {\r\n                ...rfqmJobOpts,\r\n                ...rfqmApprovalOpts,\r\n            };\r\n        }\r\n\r\n        // this insert will fail if a job has already been created, ensuring\r\n        // that a signed quote cannot be queued twice\r\n        try {\r\n            // make sure job data is persisted to Postgres before queueing task\r\n            await this._dbUtils.writeV2JobAsync(rfqmJobOpts);\r\n            // $eslint-fix-me https://github.com/rhinodavid/eslint-fix-me\r\n            // eslint-disable-next-line @typescript-eslint/no-non-null-assertion\r\n            await this._enqueueJobAsync(quote.orderHash!, GaslessTypes.OtcOrder);\r\n        } catch (error) {\r\n            logger.error({ errorMessage: error.message }, 'Failed to queue the quote for submission.');\r\n            throw new InternalServerError(\r\n                `failed to queue the quote for submission, it may have already been submitted`,\r\n            );\r\n        }\r\n\r\n        return {\r\n            type: GaslessTypes.OtcOrder,\r\n            // $eslint-fix-me https://github.com/rhinodavid/eslint-fix-me\r\n            // eslint-disable-next-line @typescript-eslint/no-non-null-assertion\r\n            orderHash: quote.orderHash!,\r\n        };\r\n    }\r\n\r\n    /**\r\n     * Internal method to retrieve quote context, based on either indicative or firm quote parameters\r\n     */\r\n    private _retrieveQuoteContext(\r\n        params: FetchIndicativeQuoteParams | FetchFirmQuoteParams,\r\n        isFirm: boolean,\r\n    ): QuoteContext {\r\n        const {\r\n            sellAmount: takerAmount,\r\n            buyAmount: makerAmount,\r\n            sellToken: takerToken,\r\n            buyToken: originalMakerToken,\r\n            takerAddress,\r\n            sellTokenDecimals: takerTokenDecimals,\r\n            buyTokenDecimals: makerTokenDecimals,\r\n            integrator,\r\n            affiliateAddress,\r\n        } = params;\r\n\r\n        const isUnwrap = originalMakerToken === this._nativeTokenAddress;\r\n        const isSelling = takerAmount !== undefined;\r\n        // $eslint-fix-me https://github.com/rhinodavid/eslint-fix-me\r\n        // eslint-disable-next-line @typescript-eslint/no-non-null-assertion\r\n        const assetFillAmount = isSelling ? takerAmount! : makerAmount!;\r\n\r\n        let makerToken = originalMakerToken;\r\n\r\n        // If the originalMakerToken is the native token, we will trade the wrapped version and unwrap at the end\r\n        if (isUnwrap) {\r\n            makerToken = this._nativeWrappedTokenAddress;\r\n        }\r\n\r\n        return {\r\n            workflow: 'rfqm',\r\n            chainId: this._chainId,\r\n            isFirm,\r\n            takerAmount,\r\n            makerAmount,\r\n            takerToken,\r\n            makerToken,\r\n            originalMakerToken,\r\n            // $eslint-fix-me https://github.com/rhinodavid/eslint-fix-me\r\n            // eslint-disable-next-line @typescript-eslint/no-non-null-assertion\r\n            takerAddress: takerAddress!,\r\n            // $eslint-fix-me https://github.com/rhinodavid/eslint-fix-me\r\n            // eslint-disable-next-line @typescript-eslint/no-non-null-assertion\r\n            trader: takerAddress!,\r\n            txOrigin: this._registryAddress,\r\n            takerTokenDecimals,\r\n            makerTokenDecimals,\r\n            integrator,\r\n            affiliateAddress,\r\n            isUnwrap,\r\n            isSelling,\r\n            assetFillAmount,\r\n            feeModelVersion: this._feeModelVersion,\r\n        };\r\n    }\r\n\r\n    /**\r\n     * Internal method to fetch indicative quotes.\r\n     */\r\n    private async _fetchIndicativeQuotesAsync(quoteContext: QuoteContext, fee: Fee): Promise<IndicativeQuote[]> {\r\n        // Extract quote context\r\n        const { isSelling, assetFillAmount, takerToken, makerToken, integrator } = quoteContext;\r\n\r\n        // Create Otc Order request options\r\n        const otcOrderParams = QuoteServerClient.makeQueryParameters({\r\n            chainId: this._chainId,\r\n            txOrigin: this._registryAddress,\r\n            takerAddress: NULL_ADDRESS,\r\n            marketOperation: isSelling ? MarketOperation.Sell : MarketOperation.Buy,\r\n            buyTokenAddress: makerToken,\r\n            sellTokenAddress: takerToken,\r\n            assetFillAmount,\r\n            isLastLook: true,\r\n            fee,\r\n        });\r\n\r\n        // If LLR Cooldown is enabled, filter out makers in cooldown before querying the quote server\r\n        let makerIdsInCooldown: string[] | undefined;\r\n        if (ENABLE_LLR_COOLDOWN) {\r\n            try {\r\n                makerIdsInCooldown = await this._cacheClient.getMakersInCooldownForPairAsync(\r\n                    this._chainId,\r\n                    makerToken,\r\n                    takerToken,\r\n                );\r\n                // log blocked maker ids\r\n                makerIdsInCooldown.map((makerId) => {\r\n                    RFQM_MAKER_BLOCKED_FOR_LLR_COOLDOWN.labels(\r\n                        makerId,\r\n                        this._chainId.toString(),\r\n                        toPairString(makerToken, takerToken),\r\n                    ).inc();\r\n                    logger.warn(\r\n                        {\r\n                            makerId,\r\n                            makerToken,\r\n                            takerToken,\r\n                            timestamp: Date.now(),\r\n                        },\r\n                        'Maker is on cooldown due to a bad last look reject',\r\n                    );\r\n                });\r\n            } catch (e) {\r\n                logger.error(\r\n                    { chainId: this._chainId, makerToken, takerToken, errorMessage: e.message },\r\n                    'Encountered an error while filtering makers on LLR cooldown',\r\n                );\r\n            }\r\n        }\r\n\r\n        const otcOrderMakerUris = this._rfqMakerManager.getRfqmV2MakerUrisForPair(\r\n            makerToken,\r\n            takerToken,\r\n            integrator.whitelistMakerIds || null,\r\n            makerIdsInCooldown || null,\r\n        );\r\n\r\n        const quotes = await this._quoteServerClient.batchGetPriceV2Async(\r\n            otcOrderMakerUris,\r\n            integrator,\r\n            otcOrderParams,\r\n        );\r\n\r\n        // Log any quotes that are for the incorrect amount\r\n        quotes.forEach((quote) => {\r\n            const quotedAmount = isSelling ? quote.takerAmount : quote.makerAmount;\r\n            if (quotedAmount.eq(assetFillAmount)) {\r\n                return;\r\n            }\r\n            const modificationType = quotedAmount.gt(assetFillAmount) ? 'overfill' : 'underfill';\r\n            logger.warn(\r\n                {\r\n                    isSelling,\r\n                    overOrUnder: modificationType,\r\n                    requestedAmount: assetFillAmount,\r\n                    quotedAmount,\r\n                    quote,\r\n                },\r\n                'Maker returned an incorrect amount',\r\n            );\r\n            RFQM_MM_RETURNED_DIFFERENT_AMOUNT.labels(quote.makerUri, this._chainId.toString(), modificationType).inc();\r\n        });\r\n\r\n        return quotes;\r\n    }\r\n\r\n    /**\r\n     * Internal method to fetch firm quotes.\r\n     */\r\n    private async _fetchFirmQuotesAsync(quoteContext: QuoteContext, fee: Fee): Promise<FirmOtcQuote[]> {\r\n        const quotes = await this._fetchIndicativeQuotesAsync(quoteContext, fee);\r\n        return this._convertToFirmQuotesAsync(quotes, quoteContext);\r\n    }\r\n\r\n    /**\r\n     * Internal method to convert indicative quotes to firm quotes.\r\n     */\r\n    private async _convertToFirmQuotesAsync(\r\n        quotes: IndicativeQuote[],\r\n        quoteContext: QuoteContext,\r\n    ): Promise<FirmOtcQuote[]> {\r\n        const { takerAddress } = quoteContext;\r\n        const currentBucket = (await this._cacheClient.getNextOtcOrderBucketAsync(this._chainId)) % RFQM_NUM_BUCKETS;\r\n        const nowSeconds = Math.floor(Date.now() / ONE_SECOND_MS);\r\n        const otcQuotes = quotes.map((q) =>\r\n            this._mapIndicativeQuoteToFirmOtcQuote(\r\n                q,\r\n                // $eslint-fix-me https://github.com/rhinodavid/eslint-fix-me\r\n                // eslint-disable-next-line @typescript-eslint/no-non-null-assertion\r\n                takerAddress!,\r\n                new BigNumber(currentBucket),\r\n                new BigNumber(nowSeconds),\r\n            ),\r\n        );\r\n\r\n        const firmQuotesWithCorrectChainId = otcQuotes.filter((quote) => {\r\n            if (quote.order.chainId !== this._chainId) {\r\n                logger.error({ quote }, 'Received a quote with incorrect chain id');\r\n                return false;\r\n            }\r\n            return true;\r\n        });\r\n\r\n        return firmQuotesWithCorrectChainId;\r\n    }\r\n\r\n    private async _enqueueJobAsync(orderHash: string, type: GaslessTypes): Promise<void> {\r\n        await this._sqsProducer.send({\r\n            // wait, it's all order hash?\r\n            // always has been.\r\n            groupId: orderHash,\r\n            id: orderHash,\r\n            body: JSON.stringify({ orderHash, type }),\r\n            deduplicationId: orderHash,\r\n        });\r\n    }\r\n\r\n    /**\r\n     * Maps an IndicativeQuote to a FirmOtcQuote. Handles txOrigin, chainId, expiryAndNonce, etc\r\n     */\r\n    private _mapIndicativeQuoteToFirmOtcQuote(\r\n        q: IndicativeQuote,\r\n        takerAddress: string,\r\n        nonceBucket: BigNumber,\r\n        nonce: BigNumber,\r\n    ): FirmOtcQuote {\r\n        return {\r\n            kind: 'otc',\r\n            makerUri: q.makerUri,\r\n            order: new OtcOrder({\r\n                txOrigin: this._registryAddress,\r\n                expiryAndNonce: OtcOrder.encodeExpiryAndNonce(q.expiry, nonceBucket, nonce),\r\n                maker: q.maker,\r\n                taker: takerAddress,\r\n                makerToken: q.makerToken,\r\n                takerToken: q.takerToken,\r\n                makerAmount: q.makerAmount,\r\n                takerAmount: q.takerAmount,\r\n                chainId: this._chainId,\r\n                verifyingContract: this._contractAddresses.exchangeProxy,\r\n            }),\r\n        };\r\n    }\r\n\r\n    /**\r\n     * Validates and converts EIP-712 context to an Approval object.\r\n     * @param kind Type of gasless approval\r\n     * @param eip712 EIP-712 context parsed from the handler\r\n     * @param tradeHash The order hash or metatransaction hash,\r\n     *  only used for logging in case of validation error\r\n     * @returns The Approval object\r\n     */\r\n    // tslint:disable-next-line: prefer-function-over-method\r\n    private _convertEIP712ContextToApproval<T extends ExecuteMetaTransactionEip712Context | PermitEip712Context>(\r\n        eip712: T,\r\n        tradeHash: string,\r\n    ): T extends ExecuteMetaTransactionEip712Context ? ExecuteMetaTransactionApproval : PermitApproval {\r\n        const { types, primaryType, domain, message } = eip712;\r\n        switch (primaryType) {\r\n            case 'MetaTransaction': {\r\n                if (\r\n                    !_.isEqual(\r\n                        _.keys(message).sort(),\r\n                        types.MetaTransaction.map((dataField: Eip712DataField) => dataField.name).sort(),\r\n                    )\r\n                ) {\r\n                    logger.warn({ primaryType, tradeHash }, 'Invalid message field provided for Approval');\r\n                    throw new ValidationError([\r\n                        {\r\n                            field: 'message',\r\n                            code: ValidationErrorCodes.FieldInvalid,\r\n                            reason: `Invalid message field provided for Approval of primaryType ${primaryType}`,\r\n                        },\r\n                    ]);\r\n                }\r\n                const executeMetaTransactionApproval: ExecuteMetaTransactionApproval = {\r\n                    kind: GaslessApprovalTypes.ExecuteMetaTransaction,\r\n                    eip712: {\r\n                        types,\r\n                        primaryType,\r\n                        domain,\r\n                        message: {\r\n                            nonce: message.nonce,\r\n                            from: message.from,\r\n                            functionSignature: message.functionSignature,\r\n                        },\r\n                    },\r\n                };\r\n                return executeMetaTransactionApproval as T extends ExecuteMetaTransactionEip712Context\r\n                    ? ExecuteMetaTransactionApproval\r\n                    : PermitApproval;\r\n            }\r\n            case 'Permit': {\r\n                if (\r\n                    !_.isEqual(\r\n                        _.keys(message).sort(),\r\n                        types.Permit.map((dataField: Eip712DataField) => dataField.name).sort(),\r\n                    )\r\n                ) {\r\n                    logger.warn({ primaryType, tradeHash }, 'Invalid message field provided for Approval');\r\n                    throw new ValidationError([\r\n                        {\r\n                            field: 'message',\r\n                            code: ValidationErrorCodes.FieldInvalid,\r\n                            reason: `Invalid message field provided for Approval of primaryType ${primaryType}`,\r\n                        },\r\n                    ]);\r\n                }\r\n                const permitApproval: PermitApproval = {\r\n                    kind: GaslessApprovalTypes.Permit,\r\n                    eip712: {\r\n                        types,\r\n                        primaryType,\r\n                        domain,\r\n                        message: {\r\n                            owner: message.owner,\r\n                            spender: message.spender,\r\n                            value: message.value,\r\n                            nonce: message.nonce,\r\n                            deadline: message.deadline,\r\n                        },\r\n                    },\r\n                };\r\n\r\n                return permitApproval as T extends ExecuteMetaTransactionEip712Context\r\n                    ? ExecuteMetaTransactionApproval\r\n                    : PermitApproval;\r\n            }\r\n            default:\r\n                ((_x: never) => {\r\n                    throw new Error('unreachable');\r\n                })(primaryType);\r\n        }\r\n    }\r\n}\r\n"],"version":3}