f5a9ce3e0cde050ef68f98645bf3bf22
"use strict";
Object.defineProperty(exports, "__esModule", { value: true });
exports.getFeeConfigsFromParams = exports.feesToTruncatedFees = exports.rawFeesToFees = void 0;
const utils_1 = require("@0x/utils");
const config_1 = require("../config");
const pair_utils_1 = require("./pair_utils");
function rawFeesToFees(rawFees) {
    if (!rawFees) {
        return undefined;
    }
    let integratorFee;
    if (rawFees.integratorFee) {
        const rawIntegratorFee = rawFees.integratorFee;
        integratorFee = {
            type: 'volume',
            feeToken: rawIntegratorFee.feeToken,
            feeAmount: new utils_1.BigNumber(rawIntegratorFee.feeAmount),
            billingType: rawIntegratorFee.billingType,
            feeRecipient: rawFees.integratorFee.feeRecipient,
            volumePercentage: new utils_1.BigNumber(rawFees.integratorFee.volumePercentage),
        };
    }
    let zeroExFee;
    if (rawFees.zeroExFee) {
        const rawZeroExFee = rawFees.zeroExFee;
        if (rawZeroExFee.type === 'volume') {
            zeroExFee = {
                type: 'volume',
                feeToken: rawZeroExFee.feeToken,
                feeAmount: new utils_1.BigNumber(rawZeroExFee.feeAmount),
                billingType: rawZeroExFee.billingType,
                feeRecipient: rawZeroExFee.feeRecipient,
                volumePercentage: new utils_1.BigNumber(rawZeroExFee.volumePercentage),
            };
        }
        else if (rawZeroExFee.type === 'integrator_share') {
            zeroExFee = {
                type: 'integrator_share',
                feeToken: rawZeroExFee.feeToken,
                feeAmount: new utils_1.BigNumber(rawZeroExFee.feeAmount),
                billingType: rawZeroExFee.billingType,
                feeRecipient: rawZeroExFee.feeRecipient,
                integratorSharePercentage: new utils_1.BigNumber(rawZeroExFee.integratorSharePercentage),
            };
        }
    }
    let gasFee;
    if (rawFees.gasFee) {
        const rawGasFee = rawFees.gasFee;
        gasFee = {
            type: 'gas',
            feeToken: rawGasFee.feeToken,
            feeAmount: new utils_1.BigNumber(rawGasFee.feeAmount),
            feeRecipient: rawGasFee.feeRecipient,
            billingType: rawGasFee.billingType,
            gasPrice: new utils_1.BigNumber(rawGasFee.gasPrice),
            estimatedGas: new utils_1.BigNumber(rawGasFee.estimatedGas),
            feeTokenAmountPerBaseUnitNativeToken: new utils_1.BigNumber(rawGasFee.feeTokenAmountPerBaseUnitNativeToken),
        };
    }
    return {
        integratorFee,
        zeroExFee,
        gasFee,
    };
}
exports.rawFeesToFees = rawFeesToFees;
/**
 * Convert `Fees` to `TruncatedFees` which is returned in the payload to callers.
 */
function feesToTruncatedFees(fees) {
    if (!fees) {
        return undefined;
    }
    let integratorFee;
    let zeroExFee;
    let gasFee;
    if (fees.integratorFee) {
        const { type, feeToken, feeAmount } = fees.integratorFee;
        integratorFee = {
            feeType: type,
            feeToken,
            feeAmount,
        };
    }
    if (fees.zeroExFee) {
        const { type, feeToken, feeAmount } = fees.zeroExFee;
        zeroExFee = {
            feeType: type,
            feeToken,
            feeAmount,
        };
    }
    if (fees.gasFee) {
        const { type, feeToken, feeAmount } = fees.gasFee;
        gasFee = {
            feeType: type,
            feeToken,
            feeAmount,
        };
    }
    return {
        integratorFee,
        zeroExFee,
        gasFee,
    };
}
exports.feesToTruncatedFees = feesToTruncatedFees;
function getFeeConfigsFromParams(params) {
    let integratorFee;
    let zeroExFee;
    let gasFee;
    if (params.integratorFeeConfig) {
        integratorFee = {
            type: params.integratorFeeConfig.type,
            feeRecipient: params.integratorFeeConfig.recipient,
            billingType: params.integratorFeeConfig.billingType,
            volumePercentage: params.integratorFeeConfig.sellTokenPercentage,
        };
    }
    // If integrator id has an entry, use integrator id as key to get fee config. Otherwise, use wildcard.
    const feeConfigurationByChainId = config_1.ZERO_EX_FEE_CONFIGURATION_MAP.get(params.integratorId)
        ? config_1.ZERO_EX_FEE_CONFIGURATION_MAP.get(params.integratorId)
        : config_1.ZERO_EX_FEE_CONFIGURATION_MAP.get('*');
    if (feeConfigurationByChainId) {
        const feeConfiguration = feeConfigurationByChainId.get(params.chainId);
        if (feeConfiguration) {
            zeroExFee = getZeroExFeeConfig(feeConfiguration, params.sellToken, params.buyToken);
            gasFee = {
                type: 'gas',
                feeRecipient: feeConfiguration.gas.feeRecipient,
                billingType: feeConfiguration.gas.billingType,
            };
        }
    }
    return {
        integratorFee,
        zeroExFee,
        gasFee,
    };
}
exports.getFeeConfigsFromParams = getFeeConfigsFromParams;
/**
 * Get 0x fee config from `ZeroExFeeConfiguration` object given sell and buy tokens. The function would match sell and buy tokens based on the following precedence:
 * 1. Specific pair
 * 2. Cartesian product
 * 3. Token
 *
 * For example, if `feeConfiguration` is the following:
 * {
 *      name: 'Coinbase',
 *      feeOn: 'volume',
 *      zeroExFeeRecipient: '0x123456...',
 *      gasFeeRecipient: '0x654321...',
 *      pairsFeeEntries:  { // Map
 *          // This means for USDC <-> WETH pair 0x charge 0.5% sell token as fee
 *          '0xa0b86991c6218b36c1d19d4a2e9eb0ce3606eb48-0xc02aaa39b223fe8d0a0e5c4f27ead9083c756cc2': 0.5,
 *          // This means for USDT <-> WETH pair 0x charge 0.5% sell token as fee
 *          '0xc02aaa39b223fe8d0a0e5c4f27ead9083c756cc2-0xdac17f958d2ee523a2206206994597c13d831ec7': 0.5,
 *      },
 *      cartesianProductFeeEntries: [{
 *          // Set consists of USDC, USDT and DAI
 *          setA: { '0xa0b86991c6218b36c1d19d4a2e9eb0ce3606eb48', '0xdac17f958d2ee523a2206206994597c13d831ec7', '0x6b175474e89094c44da98b954eedeac495271d0f' }
 *          // Set consists of WETH and WBTC
 *          setB: { '0xc02aaa39b223fe8d0a0e5c4f27ead9083c756cc2', '0x2260fac5e5542a773aa44fbcfedf7c193bc2c599' }
 *          // This means for any combination between `setA` and `setB`, 0x charge 0.7% sell token as fee
 *          parameter: 0.7,
 *      }], [{
 *          // Set consists of USDC, USDT and DAI
 *          setA: { '0xa0b86991c6218b36c1d19d4a2e9eb0ce3606eb48', '0xdac17f958d2ee523a2206206994597c13d831ec7', '0x6b175474e89094c44da98b954eedeac495271d0f' }
 *          // Set consists of USDC, USDT and DAI
 *          setB: { '0xa0b86991c6218b36c1d19d4a2e9eb0ce3606eb48', '0xdac17f958d2ee523a2206206994597c13d831ec7', '0x6b175474e89094c44da98b954eedeac495271d0f' }
 *          // This means for any combination between `setA` and `setB`, 0x charge 0.1% sell token as fee
 *          parameter: 0.1,
 *      }],
 *      tokensEntries: { // Map
 *          // This means 0x charges 1.5% as fee if sell / buy token is WBTC
 *          '0x2260fac5e5542a773aa44fbcfedf7c193bc2c599': 1.5, // WBTC
 *          // This means 0x charges all other sell tokens 0.05% as fee
 *          '*': 0.05,
 *      }
 * }
 *
 * With this example,
 * - if `sellToken` is 0xa0b86991c6218b36c1d19d4a2e9eb0ce3606eb48 (USDC) and `buyToken` is 0xc02aaa39b223fe8d0a0e5c4f27ead9083c756cc2 (WETH), there is a pair matches,
 *   the fee percentage would be 0.5
 * - if `sellToken` is 0x6b175474e89094c44da98b954eedeac495271d0f (DAI) and `buyToken` is 0x2260fac5e5542a773aa44fbcfedf7c193bc2c599 (WBTC), there is no pair matches but
 *   a cartesian product match, the fee percentage would be 0.7
 * - if `sellToken` is 0x2260fac5e5542a773aa44fbcfedf7c193bc2c599 (WBTC) and `buyToken` is 0x95ad61b0a150d79219dcf64e1e6cc01f0b64c4ce (SHIB), there is no pair matches,
 *   no cartesian product match but a token match, the fee percentage would be 1.5%
 * - if `sellToken` is 0x95ad61b0a150d79219dcf64e1e6cc01f0b64c4ce (SHIB) and `buyToken` is 0x7fc66500c84a76ad7e9c93437bfc5ac33e2ddae9 (AAVE), there is no pair matches,
 *   no cartesian product match, no exact token match but wildcard, the fee percentage would be 0.05%
 *
 * @param feeConfiguration Correponding fee configuration for an integrator and chain id.
 * @param sellToken Address of the sell token.
 * @param buyToken Address of the buy token.
 * @returns 0x fee config
 */
function getZeroExFeeConfig(feeConfiguration, sellToken, buyToken) {
    const [sellTokenLowerCase, buyTokenLowerCase] = [sellToken, buyToken].map((token) => token.toLowerCase());
    const pairString = (0, pair_utils_1.toPairString)(sellTokenLowerCase, buyTokenLowerCase);
    // specific pair has the highest precedence
    const pairFeeParameter = feeConfiguration.pairsFeeEntries.get(pairString);
    if (pairFeeParameter) {
        // pair fee config exists
        if (feeConfiguration.feeOn === 'volume') {
            return {
                type: 'volume',
                feeRecipient: feeConfiguration.zeroEx.feeRecipient,
                billingType: feeConfiguration.zeroEx.billingType,
                volumePercentage: pairFeeParameter,
            };
        }
        else if (feeConfiguration.feeOn === 'integrator_share') {
            return {
                type: 'integrator_share',
                feeRecipient: feeConfiguration.zeroEx.feeRecipient,
                billingType: feeConfiguration.zeroEx.billingType,
                integratorSharePercentage: pairFeeParameter,
            };
        }
    }
    // cartesian product has the second precedence
    for (const cartesianProductFeeEntry of feeConfiguration.cartesianProductFeeEntries) {
        if ((cartesianProductFeeEntry.setA.has(sellTokenLowerCase) &&
            cartesianProductFeeEntry.setB.has(buyTokenLowerCase)) ||
            (cartesianProductFeeEntry.setA.has(buyTokenLowerCase) &&
                cartesianProductFeeEntry.setB.has(sellTokenLowerCase))) {
            // cartesian product config exists
            if (feeConfiguration.feeOn === 'volume') {
                return {
                    type: 'volume',
                    feeRecipient: feeConfiguration.zeroEx.feeRecipient,
                    billingType: feeConfiguration.zeroEx.billingType,
                    volumePercentage: cartesianProductFeeEntry.parameter,
                };
            }
            else if (feeConfiguration.feeOn === 'integrator_share') {
                return {
                    type: 'integrator_share',
                    feeRecipient: feeConfiguration.zeroEx.feeRecipient,
                    billingType: feeConfiguration.zeroEx.billingType,
                    integratorSharePercentage: cartesianProductFeeEntry.parameter,
                };
            }
        }
    }
    // If sell/buy token has an entry, use sell/buy token as key to get fee config. Otherwise, use wildcard.
    let tokenFeeParameter;
    if (feeConfiguration.tokensEntries.get(sellTokenLowerCase)) {
        tokenFeeParameter = feeConfiguration.tokensEntries.get(sellTokenLowerCase);
    }
    else if (feeConfiguration.tokensEntries.get(buyTokenLowerCase)) {
        tokenFeeParameter = feeConfiguration.tokensEntries.get(buyTokenLowerCase);
    }
    else {
        tokenFeeParameter = feeConfiguration.tokensEntries.get('*');
    }
    // Tokens has the lowest precedence
    if (tokenFeeParameter) {
        // find a match
        if (feeConfiguration.feeOn === 'volume') {
            return {
                type: 'volume',
                feeRecipient: feeConfiguration.zeroEx.feeRecipient,
                billingType: feeConfiguration.zeroEx.billingType,
                volumePercentage: tokenFeeParameter,
            };
        }
        else if (feeConfiguration.feeOn === 'integrator_share') {
            return {
                type: 'integrator_share',
                feeRecipient: feeConfiguration.zeroEx.feeRecipient,
                billingType: feeConfiguration.zeroEx.billingType,
                integratorSharePercentage: tokenFeeParameter,
            };
        }
    }
    return undefined;
}
//# sourceMappingURL=data:application/json;charset=utf-8;base64,eyJmaWxlIjoiL1VzZXJzL2Rhdmlkd2Fsc2gvY29kZS1sb2NhbC8weC1yZnEtYXBpL3NyYy9jb3JlL21ldGFfdHJhbnNhY3Rpb25fZmVlX3V0aWxzLnRzIiwibWFwcGluZ3MiOiI7OztBQUFBLHFDQUFzQztBQUN0QyxzQ0FBa0Y7QUFDbEYsNkNBQTRDO0FBZTVDLFNBQWdCLGFBQWEsQ0FBQyxPQUE0QjtJQUN0RCxJQUFJLENBQUMsT0FBTyxFQUFFO1FBQ1YsT0FBTyxTQUFTLENBQUM7S0FDcEI7SUFFRCxJQUFJLGFBQXlDLENBQUM7SUFDOUMsSUFBSSxPQUFPLENBQUMsYUFBYSxFQUFFO1FBQ3ZCLE1BQU0sZ0JBQWdCLEdBQUcsT0FBTyxDQUFDLGFBQWEsQ0FBQztRQUUvQyxhQUFhLEdBQUc7WUFDWixJQUFJLEVBQUUsUUFBUTtZQUNkLFFBQVEsRUFBRSxnQkFBZ0IsQ0FBQyxRQUFRO1lBQ25DLFNBQVMsRUFBRSxJQUFJLGlCQUFTLENBQUMsZ0JBQWdCLENBQUMsU0FBUyxDQUFDO1lBQ3BELFdBQVcsRUFBRSxnQkFBZ0IsQ0FBQyxXQUFXO1lBQ3pDLFlBQVksRUFBRSxPQUFPLENBQUMsYUFBYSxDQUFDLFlBQVk7WUFDaEQsZ0JBQWdCLEVBQUUsSUFBSSxpQkFBUyxDQUFDLE9BQU8sQ0FBQyxhQUFhLENBQUMsZ0JBQWdCLENBQUM7U0FDMUUsQ0FBQztLQUNMO0lBRUQsSUFBSSxTQUEwRCxDQUFDO0lBQy9ELElBQUksT0FBTyxDQUFDLFNBQVMsRUFBRTtRQUNuQixNQUFNLFlBQVksR0FBRyxPQUFPLENBQUMsU0FBUyxDQUFDO1FBRXZDLElBQUksWUFBWSxDQUFDLElBQUksS0FBSyxRQUFRLEVBQUU7WUFDaEMsU0FBUyxHQUFHO2dCQUNSLElBQUksRUFBRSxRQUFRO2dCQUNkLFFBQVEsRUFBRSxZQUFZLENBQUMsUUFBUTtnQkFDL0IsU0FBUyxFQUFFLElBQUksaUJBQVMsQ0FBQyxZQUFZLENBQUMsU0FBUyxDQUFDO2dCQUNoRCxXQUFXLEVBQUUsWUFBWSxDQUFDLFdBQVc7Z0JBQ3JDLFlBQVksRUFBRSxZ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QWlCLENBQUMsQ0FBQztLQUM3RTtTQUFNO1FBQ0gsaUJBQWlCLEdBQUcsZ0JBQWdCLENBQUMsYUFBYSxDQUFDLEdBQUcsQ0FBQyxHQUFHLENBQUMsQ0FBQztLQUMvRDtJQUVELG1DQUFtQztJQUNuQyxJQUFJLGlCQUFpQixFQUFFO1FBQ25CLGVBQWU7UUFDZixJQUFJLGdCQUFnQixDQUFDLEtBQUssS0FBSyxRQUFRLEVBQUU7WUFDckMsT0FBTztnQkFDSCxJQUFJLEVBQUUsUUFBUTtnQkFDZCxZQUFZLEVBQUUsZ0JBQWdCLENBQUMsTUFBTSxDQUFDLFlBQVk7Z0JBQ2xELFdBQVcsRUFBRSxnQkFBZ0IsQ0FBQyxNQUFNLENBQUMsV0FBVztnQkFDaEQsZ0JBQWdCLEVBQUUsaUJBQWlCO2FBQ3RDLENBQUM7U0FDTDthQUFNLElBQUksZ0JBQWdCLENBQUMsS0FBSyxLQUFLLGtCQUFrQixFQUFFO1lBQ3RELE9BQU87Z0JBQ0gsSUFBSSxFQUFFLGtCQUFrQjtnQkFDeEIsWUFBWSxFQUFFLGdCQUFnQixDQUFDLE1BQU0sQ0FBQyxZQUFZO2dCQUNsRCxXQUFXLEVBQUUsZ0JBQWdCLENBQUMsTUFBTSxDQUFDLFdBQVc7Z0JBQ2hELHlCQUF5QixFQUFFLGlCQUFpQjthQUMvQyxDQUFDO1NBQ0w7S0FDSjtJQUVELE9BQU8sU0FBUyxDQUFDO0FBQ3JCLENBQUMiLCJuYW1lcyI6W10sInNvdXJjZXMiOlsiL1VzZXJzL2Rhdmlkd2Fsc2gvY29kZS1sb2NhbC8weC1yZnEtYXBpL3NyYy9jb3JlL21ldGFfdHJhbnNhY3Rpb25fZmVlX3V0aWxzLnRzIl0sInNvdXJjZXNDb250ZW50IjpbImltcG9ydCB7IEJpZ051bWJlciB9IGZyb20gJ0AweC91dGlscyc7XG5pbXBvcnQgeyBaZXJvRXhGZWVDb25maWd1cmF0aW9uLCBaRVJPX0VYX0ZFRV9DT05GSUdVUkFUSU9OX01BUCB9IGZyb20gJy4uL2NvbmZpZyc7XG5pbXBvcnQgeyB0b1BhaXJTdHJpbmcgfSBmcm9tICcuL3BhaXJfdXRpbHMnO1xuaW1wb3J0IHtcbiAgICBGZWVDb25maWdzLFxuICAgIEZlZXMsXG4gICAgR2FzRmVlLFxuICAgIEdhc0ZlZUNvbmZpZyxcbiAgICBJbnRlZ3JhdG9yU2hhcmVGZWUsXG4gICAgSW50ZWdyYXRvclNoYXJlRmVlQ29uZmlnLFxuICAgIFJhd0ZlZXMsXG4gICAgVHJ1bmNhdGVkRmVlLFxuICAgIFRydW5jYXRlZEZlZXMsXG4gICAgVm9sdW1lQmFzZWRGZWUsXG4gICAgVm9sdW1lQmFzZWRGZWVDb25maWcsXG59IGZyb20gJy4vdHlwZXMvbWV0YV90cmFuc2FjdGlvbl9mZWVzJztcblxuZXhwb3J0IGZ1bmN0aW9uIHJhd0ZlZXNUb0ZlZXMocmF3RmVlczogUmF3RmVlcyB8IHVuZGVmaW5lZCk6IEZlZXMgfCB1bmRlZmluZWQge1xuICAgIGlmICghcmF3RmVlcykge1xuICAgICAgICByZXR1cm4gdW5kZWZpbmVkO1xuICAgIH1cblxuICAgIGxldCBpbnRlZ3JhdG9yRmVlOiBWb2x1bWVCYXNlZEZlZSB8IHVuZGVmaW5lZDtcbiAgICBpZiAocmF3RmVlcy5pbnRlZ3JhdG9yRmVlKSB7XG4gICAgICAgIGNvbnN0IHJhd0ludGVncmF0b3JGZWUgPSByYXdGZWVzLmludGVncmF0b3JGZWU7XG5cbiAgICAgICAgaW50ZWdyYXRvckZlZSA9IHtcbiAgICAgICAgICAgIHR5cGU6ICd2b2x1bWUnLFxuICAgICAgICAgICAgZmVlVG9rZW46IHJhd0ludGVncmF0b3JGZWUuZmVlVG9rZW4sXG4gICAgICAgICAgICBmZWVBbW91bnQ6IG5ldyBCaWdOdW1iZXIocmF3SW50ZWdyYXRvckZlZS5mZWVBbW91bnQpLFxuICAgICAgICAgICAgYmlsbGluZ1R5cGU6IHJhd0ludGVncmF0b3JGZWUuYmlsbGluZ1R5cGUsXG4gICAgICAgICAgICBmZWVSZWNpcGllbnQ6IHJhd0ZlZXMuaW50ZWdyYXRvckZlZS5mZWVSZWNpcGllbnQsXG4gICAgICAgICAgICB2b2x1bWVQZXJjZW50YWdlOiBuZXcgQmlnTnVtYmVyKHJhd0ZlZXMuaW50ZWdyYXRvckZlZS52b2x1bWVQZXJjZW50YWdlKSxcbiAgICAgICAgfTtcbiAgICB9XG5cbiAgICBsZXQgemVyb0V4RmVlOiBWb2x1bWVCYXNlZEZlZSB8IEludGVncmF0b3JTaGFyZUZlZSB8IHVuZGVmaW5lZDtcbiAgICBpZiAocmF3RmVlcy56ZXJvRXhGZWUpIHtcbiAgICAgICAgY29uc3QgcmF3WmVyb0V4RmVlID0gcmF3RmVlcy56ZXJvRXhGZWU7XG5cbiAgICAgICAgaWYgKHJhd1plcm9FeEZlZS50eXBlID09PSAndm9sdW1lJykge1xuICAgICAgICAgICAgemVyb0V4RmVlID0ge1xuICAgICAgICAgICAgICAgIHR5cGU6ICd2b2x1bWUnLFxuICAgICAgICAgICAgICAgIGZlZVRva2VuOiByYXdaZXJvRXhGZWUuZmVlVG9rZW4sXG4gICAgICAgICAgICAgICAgZmVlQW1vdW50OiBuZXcgQmlnTnVtYmVyKHJhd1plcm9FeEZlZS5mZWVBbW91bnQpLFxuICAgICAgICAgICAgICAgIGJpbGxpbmdUeXBlOiByYXdaZXJvRXhGZWUuYmlsbGluZ1R5cGUsXG4gICAgICAgICAgICAgICAgZmVlUmVjaXBpZW50OiByYXdaZXJvRXhGZWUuZmVlUmVjaXBpZW50LFxuICAgICAgICAgICAgICAgIHZvbHVtZVBlcmNlbnRhZ2U6IG5ldyBCaWdOdW1iZXIocmF3WmVyb0V4RmVlLnZvbHVtZVBlcmNlbnRhZ2UpLFxuICAgICAgICAgICAgfTtcbiAgICAgICAgfSBlbHNlIGlmIChyYXdaZXJvRXhGZWUudHlwZSA9PT0gJ2ludGVncmF0b3Jfc2hhcmUnKSB7XG4gICAgICAgICAgICB6ZXJvRXhGZWUgPSB7XG4gICAgICAgICAgICAgICAgdHlwZTogJ2ludGVncmF0b3Jfc2hhcmUnLFxuICAgICAgICAgICAgICAgIGZlZVRva2VuOiByYXdaZXJvRXhGZWUuZmVlVG9rZW4sXG4gICAgICAgICAgICAgICAgZmVlQW1vdW50OiBuZXcgQmlnTnVtYmVyKHJhd1plcm9FeEZlZS5mZWVBbW91bnQpLFxuICAgICAgICAgICAgICAgIGJpbGxpbmdUeXBlOiByYXdaZXJvRXhGZWUuYmlsbGluZ1R5cGUsXG4gICAgICAgICAgICAgICAgZmVlUmVjaXBpZW50OiByYXdaZXJvRXhGZWUuZmVlUmVjaXBpZW50LFxuICAgICAgICAgICAgICAgIGludGVncmF0b3JTaGFyZVBlcmNlbnRhZ2U6IG5ldyBCaWdOdW1iZXIocmF3WmVyb0V4RmVlLmludGVncmF0b3JTaGFyZVBlcmNlbnRhZ2UpLFxuICAgICAgICAgICAgfTtcbiAgICAgICAgfVxuICAgIH1cblxuICAgIGxldCBnYXNGZWU6IEdhc0ZlZSB8IHVuZGVmaW5lZDtcbiAgICBpZiAocmF3RmVlcy5nYXNGZWUpIHtcbiAgICAgICAgY29uc3QgcmF3R2FzRmVlID0gcmF3RmVlcy5nYXNGZWU7XG5cbiAgICAgICAgZ2FzRmVlID0ge1xuICAgICAgICAgICAgdHlwZTogJ2dhcycsXG4gICAgICAgICAgICBmZWVUb2tlbjogcmF3R2FzRmVlLmZlZVRva2VuLFxuICAgICAgICAgICAgZmVlQW1vdW50OiBuZXcgQmlnTnVtYmVyKHJhd0dhc0ZlZS5mZWVBbW91bnQpLFxuICAgICAgICAgICAgZmVlUmVjaXBpZW50OiByYXdHYXNGZWUuZmVlUmVjaXBpZW50LFxuICAgICAgICAgICAgYmlsbGluZ1R5cGU6IHJhd0dhc0ZlZS5iaWxsaW5nVHlwZSxcbiAgICAgICAgICAgIGdhc1ByaWNlOiBuZXcgQmlnTnVtYmVyKHJhd0dhc0ZlZS5nYXNQcmljZSksXG4gICAgICAgICAgICBlc3RpbWF0ZWRHYXM6IG5ldyBCaWdOdW1iZXIocmF3R2FzRmVlLmVzdGltYXRlZEdhcyksXG4gICAgICAgICAgICBmZWVUb2tlbkFtb3VudFBlckJhc2VVbml0TmF0aXZlVG9rZW46IG5ldyBCaWdOdW1iZXIocmF3R2FzRmVlLmZlZVRva2VuQW1vdW50UGVyQmFzZVVuaXROYXRpdmVUb2tlbiksXG4gICAgICAgIH07XG4gICAgfVxuXG4gICAgcmV0dXJuIHtcbiAgICAgICAgaW50ZWdyYXRvckZlZSxcbiAgICAgICAgemVyb0V4RmVlLFxuICAgICAgICBnYXNGZWUsXG4gICAgfTtcbn1cblxuLyoqXG4gKiBDb252ZXJ0IGBGZWVzYCB0byBgVHJ1bmNhdGVkRmVlc2Agd2hpY2ggaXMgcmV0dXJuZWQgaW4gdGhlIHBheWxvYWQgdG8gY2FsbGVycy5cbiAqL1xuZXhwb3J0IGZ1bmN0aW9uIGZlZXNUb1RydW5jYXRlZEZlZXMoZmVlczogRmVlcyB8IHVuZGVmaW5lZCk6IFRydW5jYXRlZEZlZXMgfCB1bmRlZmluZWQge1xuICAgIGlmICghZmVlcykge1xuICAgICAgICByZXR1cm4gdW5kZWZpbmVkO1xuICAgIH1cblxuICAgIGxldCBpbnRlZ3JhdG9yRmVlOiBUcnVuY2F0ZWRGZWUgfCB1bmRlZmluZWQ7XG4gICAgbGV0IHplcm9FeEZlZTogVHJ1bmNhdGVkRmVlIHwgdW5kZWZpbmVkO1xuICAgIGxldCBnYXNGZWU6IFRydW5jYXRlZEZlZSB8IHVuZGVmaW5lZDtcblxuICAgIGlmIChmZWVzLmludGVncmF0b3JGZWUpIHtcbiAgICAgICAgY29uc3QgeyB0eXBlLCBmZWVUb2tlbiwgZmVlQW1vdW50IH0gPSBmZWVzLmludGVncmF0b3JGZWU7XG4gICAgICAgIGludGVncmF0b3JGZWUgPSB7XG4gICAgICAgICAgICBmZWVUeXBlOiB0eXBlLFxuICAgICAgICAgICAgZmVlVG9rZW4sXG4gICAgICAgICAgICBmZWVBbW91bnQsXG4gICAgICAgIH07XG4gICAgfVxuICAgIGlmIChmZWVzLnplcm9FeEZlZSkge1xuICAgICAgICBjb25zdCB7IHR5cGUsIGZlZVRva2VuLCBmZWVBbW91bnQgfSA9IGZlZXMuemVyb0V4RmVlO1xuICAgICAgICB6ZXJvRXhGZWUgPSB7XG4gICAgICAgICAgICBmZWVUeXBlOiB0eXBlLFxuICAgICAgICAgICAgZmVlVG9rZW4sXG4gICAgICAgICAgICBmZWVBbW91bnQsXG4gICAgICAgIH07XG4gICAgfVxuICAgIGlmIChmZWVzLmdhc0ZlZSkge1xuICAgICAgICBjb25zdCB7IHR5cGUsIGZlZVRva2VuLCBmZWVBbW91bnQgfSA9IGZlZXMuZ2FzRmVlO1xuICAgICAgICBnYXNGZWUgPSB7XG4gICAgICAgICAgICBmZWVUeXBlOiB0eXBlLFxuICAgICAgICAgICAgZmVlVG9rZW4sXG4gICAgICAgICAgICBmZWVBbW91bnQsXG4gICAgICAgIH07XG4gICAgfVxuXG4gICAgcmV0dXJuIHtcbiAgICAgICAgaW50ZWdyYXRvckZlZSxcbiAgICAgICAgemVyb0V4RmVlLFxuICAgICAgICBnYXNGZWUsXG4gICAgfTtcbn1cblxuZXhwb3J0IGZ1bmN0aW9uIGdldEZlZUNvbmZpZ3NGcm9tUGFyYW1zKHBhcmFtczoge1xuICAgIGludGVncmF0b3JJZDogc3RyaW5nO1xuICAgIGNoYWluSWQ6IG51bWJlcjtcbiAgICBzZWxsVG9rZW46IHN0cmluZztcbiAgICBidXlUb2tlbjogc3RyaW5nO1xuICAgIGludGVncmF0b3JGZWVDb25maWc/OiB7XG4gICAgICAgIHR5cGU6ICd2b2x1bWUnOyAvLyBgZmVlVHlwZWAgZmllbGQgaW4gYEZldGNoUXVvdGVQYXJhbXNCYXNlYFxuICAgICAgICByZWNpcGllbnQ6IHN0cmluZzsgLy8gYGZlZVJlY2lwaWVudGAgZmllbGQgaW4gYEZldGNoUXVvdGVQYXJhbXNCYXNlYFxuICAgICAgICBiaWxsaW5nVHlwZTogJ29uLWNoYWluJyB8ICdvZmYtY2hhaW4nO1xuICAgICAgICBzZWxsVG9rZW5QZXJjZW50YWdlOiBCaWdOdW1iZXI7IC8vIGBmZWVTZWxsVG9rZW5QZXJjZW50YWdlYCBmaWVsZCBpbiBgRmV0Y2hRdW90ZVBhcmFtc0Jhc2VgXG4gICAgfTtcbn0pOiBGZWVDb25maWdzIHtcbiAgICBsZXQgaW50ZWdyYXRvckZlZTogVm9sdW1lQmFzZWRGZWVDb25maWcgfCB1bmRlZmluZWQ7XG4gICAgbGV0IHplcm9FeEZlZTogVm9sdW1lQmFzZWRGZWVDb25maWcgfCBJbnRlZ3JhdG9yU2hhcmVGZWVDb25maWcgfCB1bmRlZmluZWQ7XG4gICAgbGV0IGdhc0ZlZTogR2FzRmVlQ29uZmlnIHwgdW5kZWZpbmVkO1xuXG4gICAgaWYgKHBhcmFtcy5pbnRlZ3JhdG9yRmVlQ29uZmlnKSB7XG4gICAgICAgIGludGVncmF0b3JGZWUgPSB7XG4gICAgICAgICAgICB0eXBlOiBwYXJhbXMuaW50ZWdyYXRvckZlZUNvbmZpZy50eXBlLFxuICAgICAgICAgICAgZmVlUmVjaXBpZW50OiBwYXJhbXMuaW50ZWdyYXRvckZlZUNvbmZpZy5yZWNpcGllbnQsXG4gICAgICAgICAgICBiaWxsaW5nVHlwZTogcGFyYW1zLmludGVncmF0b3JGZWVDb25maWcuYmlsbGluZ1R5cGUsXG4gICAgICAgICAgICB2b2x1bWVQZXJjZW50YWdlOiBwYXJhbXMuaW50ZWdyYXRvckZlZUNvbmZpZy5zZWxsVG9rZW5QZXJjZW50YWdlLFxuICAgICAgICB9O1xuICAgIH1cblxuICAgIC8vIElmIGludGVncmF0b3IgaWQgaGFzIGFuIGVudHJ5LCB1c2UgaW50ZWdyYXRvciBpZCBhcyBrZXkgdG8gZ2V0IGZlZSBjb25maWcuIE90aGVyd2lzZSwgdXNlIHdpbGRjYXJkLlxuICAgIGNvbnN0IGZlZUNvbmZpZ3VyYXRpb25CeUNoYWluSWQgPSBaRVJPX0VYX0ZFRV9DT05GSUdVUkFUSU9OX01BUC5nZXQocGFyYW1zLmludGVncmF0b3JJZClcbiAgICAgICAgPyBaRVJPX0VYX0ZFRV9DT05GSUdVUkFUSU9OX01BUC5nZXQocGFyYW1zLmludGVncmF0b3JJZClcbiAgICAgICAgOiBaRVJPX0VYX0ZFRV9DT05GSUdVUkFUSU9OX01BUC5nZXQoJyonKTtcbiAgICBpZiAoZmVlQ29uZmlndXJhdGlvbkJ5Q2hhaW5JZCkge1xuICAgICAgICBjb25zdCBmZWVDb25maWd1cmF0aW9uID0gZmVlQ29uZmlndXJhdGlvbkJ5Q2hhaW5JZC5nZXQocGFyYW1zLmNoYWluSWQpO1xuICAgICAgICBpZiAoZmVlQ29uZmlndXJhdGlvbikge1xuICAgICAgICAgICAgemVyb0V4RmVlID0gZ2V0WmVyb0V4RmVlQ29uZmlnKGZlZUNvbmZpZ3VyYXRpb24sIHBhcmFtcy5zZWxsVG9rZW4sIHBhcmFtcy5idXlUb2tlbik7XG4gICAgICAgICAgICBnYXNGZWUgPSB7XG4gICAgICAgICAgICAgICAgdHlwZTogJ2dhcycsXG4gICAgICAgICAgICAgICAgZmVlUmVjaXBpZW50OiBmZWVDb25maWd1cmF0aW9uLmdhcy5mZWVSZWNpcGllbnQsXG4gICAgICAgICAgICAgICAgYmlsbGluZ1R5cGU6IGZlZUNvbmZpZ3VyYXRpb24uZ2FzLmJpbGxpbmdUeXBlLFxuICAgICAgICAgICAgfTtcbiAgICAgICAgfVxuICAgIH1cblxuICAgIHJldHVybiB7XG4gICAgICAgIGludGVncmF0b3JGZWUsXG4gICAgICAgIHplcm9FeEZlZSxcbiAgICAgICAgZ2FzRmVlLFxuICAgIH07XG59XG5cbi8qKlxuICogR2V0IDB4IGZlZSBjb25maWcgZnJvbSBgWmVyb0V4RmVlQ29uZmlndXJhdGlvbmAgb2JqZWN0IGdpdmVuIHNlbGwgYW5kIGJ1eSB0b2tlbnMuIFRoZSBmdW5jdGlvbiB3b3VsZCBtYXRjaCBzZWxsIGFuZCBidXkgdG9rZW5zIGJhc2VkIG9uIHRoZSBmb2xsb3dpbmcgcHJlY2VkZW5jZTpcbiAqIDEuIFNwZWNpZmljIHBhaXJcbiAqIDIuIENhcnRlc2lhbiBwcm9kdWN0XG4gKiAzLiBUb2tlblxuICpcbiAqIEZvciBleGFtcGxlLCBpZiBgZmVlQ29uZmlndXJhdGlvbmAgaXMgdGhlIGZvbGxvd2luZzpcbiAqIHtcbiAqICAgICAgbmFtZTogJ0NvaW5iYXNlJyxcbiAqICAgICAgZmVlT246ICd2b2x1bWUnLFxuICogICAgICB6ZXJvRXhGZWVSZWNpcGllbnQ6ICcweDEyMzQ1Ni4uLicsXG4gKiAgICAgIGdhc0ZlZVJlY2lwaWVudDogJzB4NjU0MzIxLi4uJyxcbiAqICAgICAgcGFpcnNGZWVFbnRyaWVzOiAgeyAvLyBNYXBcbiAqICAgICAgICAgIC8vIFRoaXMgbWVhbnMgZm9yIFVTREMgPC0+IFdFVEggcGFpciAweCBjaGFyZ2UgMC41JSBzZWxsIHRva2VuIGFzIGZlZVxuICogICAgICAgICAgJzB4YTBiODY5OTFjNjIxOGIzNmMxZDE5ZDRhMmU5ZWIwY2UzNjA2ZWI0OC0weGMwMmFhYTM5YjIyM2ZlOGQwYTBlNWM0ZjI3ZWFkOTA4M2M3NTZjYzInOiAwLjUsXG4gKiAgICAgICAgICAvLyBUaGlzIG1lYW5zIGZvciBVU0RUIDwtPiBXRVRIIHBhaXIgMHggY2hhcmdlIDAuNSUgc2VsbCB0b2tlbiBhcyBmZWVcbiAqICAgICAgICAgICcweGMwMmFhYTM5YjIyM2ZlOGQwYTBlNWM0ZjI3ZWFkOTA4M2M3NTZjYzItMHhkYWMxN2Y5NThkMmVlNTIzYTIyMDYyMDY5OTQ1OTdjMTNkODMxZWM3JzogMC41LFxuICogICAgICB9LFxuICogICAgICBjYXJ0ZXNpYW5Qcm9kdWN0RmVlRW50cmllczogW3tcbiAqICAgICAgICAgIC8vIFNldCBjb25zaXN0cyBvZiBVU0RDLCBVU0RUIGFuZCBEQUlcbiAqICAgICAgICAgIHNldEE6IHsgJzB4YTBiODY5OTFjNjIxOGIzNmMxZDE5ZDRhMmU5ZWIwY2UzNjA2ZWI0OCcsICcweGRhYzE3Zjk1OGQyZWU1MjNhMjIwNjIwNjk5NDU5N2MxM2Q4MzFlYzcnLCAnMHg2YjE3NTQ3NGU4OTA5NGM0NGRhOThiOTU0ZWVkZWFjNDk1MjcxZDBmJyB9XG4gKiAgICAgICAgICAvLyBTZXQgY29uc2lzdHMgb2YgV0VUSCBhbmQgV0JUQ1xuICogICAgICAgICAgc2V0QjogeyAnMHhjMDJhYWEzOWIyMjNmZThkMGEwZTVjNGYyN2VhZDkwODNjNzU2Y2MyJywgJzB4MjI2MGZhYzVlNTU0MmE3NzNhYTQ0ZmJjZmVkZjdjMTkzYmMyYzU5OScgfVxuICogICAgICAgICAgLy8gVGhpcyBtZWFucyBmb3IgYW55IGNvbWJpbmF0aW9uIGJldHdlZW4gYHNldEFgIGFuZCBgc2V0QmAsIDB4IGNoYXJnZSAwLjclIHNlbGwgdG9rZW4gYXMgZmVlXG4gKiAgICAgICAgICBwYXJhbWV0ZXI6IDAuNyxcbiAqICAgICAgfV0sIFt7XG4gKiAgICAgICAgICAvLyBTZXQgY29uc2lzdHMgb2YgVVNEQywgVVNEVCBhbmQgREFJXG4gKiAgICAgICAgICBzZXRBOiB7ICcweGEwYjg2OTkxYzYyMThiMzZjMWQxOWQ0YTJlOWViMGNlMzYwNmViNDgnLCAnMHhkYWMxN2Y5NThkMmVlNTIzYTIyMDYyMDY5OTQ1OTdjMTNkODMxZWM3JywgJzB4NmIxNzU0NzRlODkwOTRjNDRkYTk4Yjk1NGVlZGVhYzQ5NTI3MWQwZicgfVxuICogICAgICAgICAgLy8gU2V0IGNvbnNpc3RzIG9mIFVTREMsIFVTRFQgYW5kIERBSVxuICogICAgICAgICAgc2V0QjogeyAnMHhhMGI4Njk5MWM2MjE4YjM2YzFkMTlkNGEyZTllYjBjZTM2MDZlYjQ4JywgJzB4ZGFjMTdmOTU4ZDJlZTUyM2EyMjA2MjA2OTk0NTk3YzEzZDgzMWVjNycsICcweDZiMTc1NDc0ZTg5MDk0YzQ0ZGE5OGI5NTRlZWRlYWM0OTUyNzFkMGYnIH1cbiAqICAgICAgICAgIC8vIFRoaXMgbWVhbnMgZm9yIGFueSBjb21iaW5hdGlvbiBiZXR3ZWVuIGBzZXRBYCBhbmQgYHNldEJgLCAweCBjaGFyZ2UgMC4xJSBzZWxsIHRva2VuIGFzIGZlZVxuICogICAgICAgICAgcGFyYW1ldGVyOiAwLjEsXG4gKiAgICAgIH1dLFxuICogICAgICB0b2tlbnNFbnRyaWVzOiB7IC8vIE1hcFxuICogICAgICAgICAgLy8gVGhpcyBtZWFucyAweCBjaGFyZ2VzIDEuNSUgYXMgZmVlIGlmIHNlbGwgLyBidXkgdG9rZW4gaXMgV0JUQ1xuICogICAgICAgICAgJzB4MjI2MGZhYzVlNTU0MmE3NzNhYTQ0ZmJjZmVkZjdjMTkzYmMyYzU5OSc6IDEuNSwgLy8gV0JUQ1xuICogICAgICAgICAgLy8gVGhpcyBtZWFucyAweCBjaGFyZ2VzIGFsbCBvdGhlciBzZWxsIHRva2VucyAwLjA1JSBhcyBmZWVcbiAqICAgICAgICAgICcqJzogMC4wNSxcbiAqICAgICAgfVxuICogfVxuICpcbiAqIFdpdGggdGhpcyBleGFtcGxlLFxuICogLSBpZiBgc2VsbFRva2VuYCBpcyAweGEwYjg2OTkxYzYyMThiMzZjMWQxOWQ0YTJlOWViMGNlMzYwNmViNDggKFVTREMpIGFuZCBgYnV5VG9rZW5gIGlzIDB4YzAyYWFhMzliMjIzZmU4ZDBhMGU1YzRmMjdlYWQ5MDgzYzc1NmNjMiAoV0VUSCksIHRoZXJlIGlzIGEgcGFpciBtYXRjaGVzLFxuICogICB0aGUgZmVlIHBlcmNlbnRhZ2Ugd291bGQgYmUgMC41XG4gKiAtIGlmIGBzZWxsVG9rZW5gIGlzIDB4NmIxNzU0NzRlODkwOTRjNDRkYTk4Yjk1NGVlZGVhYzQ5NTI3MWQwZiAoREFJKSBhbmQgYGJ1eVRva2VuYCBpcyAweDIyNjBmYWM1ZTU1NDJhNzczYWE0NGZiY2ZlZGY3YzE5M2JjMmM1OTkgKFdCVEMpLCB0aGVyZSBpcyBubyBwYWlyIG1hdGNoZXMgYnV0XG4gKiAgIGEgY2FydGVzaWFuIHByb2R1Y3QgbWF0Y2gsIHRoZSBmZWUgcGVyY2VudGFnZSB3b3VsZCBiZSAwLjdcbiAqIC0gaWYgYHNlbGxUb2tlbmAgaXMgMHgyMjYwZmFjNWU1NTQyYTc3M2FhNDRmYmNmZWRmN2MxOTNiYzJjNTk5IChXQlRDKSBhbmQgYGJ1eVRva2VuYCBpcyAweDk1YWQ2MWIwYTE1MGQ3OTIxOWRjZjY0ZTFlNmNjMDFmMGI2NGM0Y2UgKFNISUIpLCB0aGVyZSBpcyBubyBwYWlyIG1hdGNoZXMsXG4gKiAgIG5vIGNhcnRlc2lhbiBwcm9kdWN0IG1hdGNoIGJ1dCBhIHRva2VuIG1hdGNoLCB0aGUgZmVlIHBlcmNlbnRhZ2Ugd291bGQgYmUgMS41JVxuICogLSBpZiBgc2VsbFRva2VuYCBpcyAweDk1YWQ2MWIwYTE1MGQ3OTIxOWRjZjY0ZTFlNmNjMDFmMGI2NGM0Y2UgKFNISUIpIGFuZCBgYnV5VG9rZW5gIGlzIDB4N2ZjNjY1MDBjODRhNzZhZDdlOWM5MzQzN2JmYzVhYzMzZTJkZGFlOSAoQUFWRSksIHRoZXJlIGlzIG5vIHBhaXIgbWF0Y2hlcyxcbiAqICAgbm8gY2FydGVzaWFuIHByb2R1Y3QgbWF0Y2gsIG5vIGV4YWN0IHRva2VuIG1hdGNoIGJ1dCB3aWxkY2FyZCwgdGhlIGZlZSBwZXJjZW50YWdlIHdvdWxkIGJlIDAuMDUlXG4gKlxuICogQHBhcmFtIGZlZUNvbmZpZ3VyYXRpb24gQ29ycmVwb25kaW5nIGZlZSBjb25maWd1cmF0aW9uIGZvciBhbiBpbnRlZ3JhdG9yIGFuZCBjaGFpbiBpZC5cbiAqIEBwYXJhbSBzZWxsVG9rZW4gQWRkcmVzcyBvZiB0aGUgc2VsbCB0b2tlbi5cbiAqIEBwYXJhbSBidXlUb2tlbiBBZGRyZXNzIG9mIHRoZSBidXkgdG9rZW4uXG4gKiBAcmV0dXJucyAweCBmZWUgY29uZmlnXG4gKi9cbmZ1bmN0aW9uIGdldFplcm9FeEZlZUNvbmZpZyhcbiAgICBmZWVDb25maWd1cmF0aW9uOiBaZXJvRXhGZWVDb25maWd1cmF0aW9uLFxuICAgIHNlbGxUb2tlbjogc3RyaW5nLFxuICAgIGJ1eVRva2VuOiBzdHJpbmcsXG4pOiBWb2x1bWVCYXNlZEZlZUNvbmZpZyB8IEludGVncmF0b3JTaGFyZUZlZUNvbmZpZyB8IHVuZGVmaW5lZCB7XG4gICAgY29uc3QgW3NlbGxUb2tlbkxvd2VyQ2FzZSwgYnV5VG9rZW5Mb3dlckNhc2VdID0gW3NlbGxUb2tlbiwgYnV5VG9rZW5dLm1hcCgodG9rZW4pID0+IHRva2VuLnRvTG93ZXJDYXNlKCkpO1xuICAgIGNvbnN0IHBhaXJTdHJpbmcgPSB0b1BhaXJTdHJpbmcoc2VsbFRva2VuTG93ZXJDYXNlLCBidXlUb2tlbkxvd2VyQ2FzZSk7XG5cbiAgICAvLyBzcGVjaWZpYyBwYWlyIGhhcyB0aGUgaGlnaGVzdCBwcmVjZWRlbmNlXG4gICAgY29uc3QgcGFpckZlZVBhcmFtZXRlciA9IGZlZUNvbmZpZ3VyYXRpb24ucGFpcnNGZWVFbnRyaWVzLmdldChwYWlyU3RyaW5nKTtcbiAgICBpZiAocGFpckZlZVBhcmFtZXRlcikge1xuICAgICAgICAvLyBwYWlyIGZlZSBjb25maWcgZXhpc3RzXG4gICAgICAgIGlmIChmZWVDb25maWd1cmF0aW9uLmZlZU9uID09PSAndm9sdW1lJykge1xuICAgICAgICAgICAgcmV0dXJuIHtcbiAgICAgICAgICAgICAgICB0eXBlOiAndm9sdW1lJyxcbiAgICAgICAgICAgICAgICBmZWVSZWNpcGllbnQ6IGZlZUNvbmZpZ3VyYXRpb24uemVyb0V4LmZlZVJlY2lwaWVudCxcbiAgICAgICAgICAgICAgICBiaWxsaW5nVHlwZTogZmVlQ29uZmlndXJhdGlvbi56ZXJvRXguYmlsbGluZ1R5cGUsXG4gICAgICAgICAgICAgICAgdm9sdW1lUGVyY2VudGFnZTogcGFpckZlZVBhcmFtZXRlcixcbiAgICAgICAgICAgIH07XG4gICAgICAgIH0gZWxzZSBpZiAoZmVlQ29uZmlndXJhdGlvbi5mZWVPbiA9PT0gJ2ludGVncmF0b3Jfc2hhcmUnKSB7XG4gICAgICAgICAgICByZXR1cm4ge1xuICAgICAgICAgICAgICAgIHR5cGU6ICdpbnRlZ3JhdG9yX3NoYXJlJyxcbiAgICAgICAgICAgICAgICBmZWVSZWNpcGllbnQ6IGZlZUNvbmZpZ3VyYXRpb24uemVyb0V4LmZlZVJlY2lwaWVudCxcbiAgICAgICAgICAgICAgICBiaWxsaW5nVHlwZTogZmVlQ29uZmlndXJhdGlvbi56ZXJvRXguYmlsbGluZ1R5cGUsXG4gICAgICAgICAgICAgICAgaW50ZWdyYXRvclNoYXJlUGVyY2VudGFnZTogcGFpckZlZVBhcmFtZXRlcixcbiAgICAgICAgICAgIH07XG4gICAgICAgIH1cbiAgICB9XG5cbiAgICAvLyBjYXJ0ZXNpYW4gcHJvZHVjdCBoYXMgdGhlIHNlY29uZCBwcmVjZWRlbmNlXG4gICAgZm9yIChjb25zdCBjYXJ0ZXNpYW5Qcm9kdWN0RmVlRW50cnkgb2YgZmVlQ29uZmlndXJhdGlvbi5jYXJ0ZXNpYW5Qcm9kdWN0RmVlRW50cmllcykge1xuICAgICAgICBpZiAoXG4gICAgICAgICAgICAoY2FydGVzaWFuUHJvZHVjdEZlZUVudHJ5LnNldEEuaGFzKHNlbGxUb2tlbkxvd2VyQ2FzZSkgJiZcbiAgICAgICAgICAgICAgICBjYXJ0ZXNpYW5Qcm9kdWN0RmVlRW50cnkuc2V0Qi5oYXMoYnV5VG9rZW5Mb3dlckNhc2UpKSB8fFxuICAgICAgICAgICAgKGNhcnRlc2lhblByb2R1Y3RGZWVFbnRyeS5zZXRBLmhhcyhidXlUb2tlbkxvd2VyQ2FzZSkgJiZcbiAgICAgICAgICAgICAgICBjYXJ0ZXNpYW5Qcm9kdWN0RmVlRW50cnkuc2V0Qi5oYXMoc2VsbFRva2VuTG93ZXJDYXNlKSlcbiAgICAgICAgKSB7XG4gICAgICAgICAgICAvLyBjYXJ0ZXNpYW4gcHJvZHVjdCBjb25maWcgZXhpc3RzXG4gICAgICAgICAgICBpZiAoZmVlQ29uZmlndXJhdGlvbi5mZWVPbiA9PT0gJ3ZvbHVtZScpIHtcbiAgICAgICAgICAgICAgICByZXR1cm4ge1xuICAgICAgICAgICAgICAgICAgICB0eXBlOiAndm9sdW1lJyxcbiAgICAgICAgICAgICAgICAgICAgZmVlUmVjaXBpZW50OiBmZWVDb25maWd1cmF0aW9uLnplcm9FeC5mZWVSZWNpcGllbnQsXG4gICAgICAgICAgICAgICAgICAgIGJpbGxpbmdUeXBlOiBmZWVDb25maWd1cmF0aW9uLnplcm9FeC5iaWxsaW5nVHlwZSxcbiAgICAgICAgICAgICAgICAgICAgdm9sdW1lUGVyY2VudGFnZTogY2FydGVzaWFuUHJvZHVjdEZlZUVudHJ5LnBhcmFtZXRlcixcbiAgICAgICAgICAgICAgICB9O1xuICAgICAgICAgICAgfSBlbHNlIGlmIChmZWVDb25maWd1cmF0aW9uLmZlZU9uID09PSAnaW50ZWdyYXRvcl9zaGFyZScpIHtcbiAgICAgICAgICAgICAgICByZXR1cm4ge1xuICAgICAgICAgICAgICAgICAgICB0eXBlOiAnaW50ZWdyYXRvcl9zaGFyZScsXG4gICAgICAgICAgICAgICAgICAgIGZlZVJlY2lwaWVudDogZmVlQ29uZmlndXJhdGlvbi56ZXJvRXguZmVlUmVjaXBpZW50LFxuICAgICAgICAgICAgICAgICAgICBiaWxsaW5nVHlwZTogZmVlQ29uZmlndXJhdGlvbi56ZXJvRXguYmlsbGluZ1R5cGUsXG4gICAgICAgICAgICAgICAgICAgIGludGVncmF0b3JTaGFyZVBlcmNlbnRhZ2U6IGNhcnRlc2lhblByb2R1Y3RGZWVFbnRyeS5wYXJhbWV0ZXIsXG4gICAgICAgICAgICAgICAgfTtcbiAgICAgICAgICAgIH1cbiAgICAgICAgfVxuICAgIH1cblxuICAgIC8vIElmIHNlbGwvYnV5IHRva2VuIGhhcyBhbiBlbnRyeSwgdXNlIHNlbGwvYnV5IHRva2VuIGFzIGtleSB0byBnZXQgZmVlIGNvbmZpZy4gT3RoZXJ3aXNlLCB1c2Ugd2lsZGNhcmQuXG4gICAgbGV0IHRva2VuRmVlUGFyYW1ldGVyOiBCaWdOdW1iZXIgfCB1bmRlZmluZWQ7XG4gICAgaWYgKGZlZUNvbmZpZ3VyYXRpb24udG9rZW5zRW50cmllcy5nZXQoc2VsbFRva2VuTG93ZXJDYXNlKSkge1xuICAgICAgICB0b2tlbkZlZVBhcmFtZXRlciA9IGZlZUNvbmZpZ3VyYXRpb24udG9rZW5zRW50cmllcy5nZXQoc2VsbFRva2VuTG93ZXJDYXNlKTtcbiAgICB9IGVsc2UgaWYgKGZlZUNvbmZpZ3VyYXRpb24udG9rZW5zRW50cmllcy5nZXQoYnV5VG9rZW5Mb3dlckNhc2UpKSB7XG4gICAgICAgIHRva2VuRmVlUGFyYW1ldGVyID0gZmVlQ29uZmlndXJhdGlvbi50b2tlbnNFbnRyaWVzLmdldChidXlUb2tlbkxvd2VyQ2FzZSk7XG4gICAgfSBlbHNlIHtcbiAgICAgICAgdG9rZW5GZWVQYXJhbWV0ZXIgPSBmZWVDb25maWd1cmF0aW9uLnRva2Vuc0VudHJpZXMuZ2V0KCcqJyk7XG4gICAgfVxuXG4gICAgLy8gVG9rZW5zIGhhcyB0aGUgbG93ZXN0IHByZWNlZGVuY2VcbiAgICBpZiAodG9rZW5GZWVQYXJhbWV0ZXIpIHtcbiAgICAgICAgLy8gZmluZCBhIG1hdGNoXG4gICAgICAgIGlmIChmZWVDb25maWd1cmF0aW9uLmZlZU9uID09PSAndm9sdW1lJykge1xuICAgICAgICAgICAgcmV0dXJuIHtcbiAgICAgICAgICAgICAgICB0eXBlOiAndm9sdW1lJyxcbiAgICAgICAgICAgICAgICBmZWVSZWNpcGllbnQ6IGZlZUNvbmZpZ3VyYXRpb24uemVyb0V4LmZlZVJlY2lwaWVudCxcbiAgICAgICAgICAgICAgICBiaWxsaW5nVHlwZTogZmVlQ29uZmlndXJhdGlvbi56ZXJvRXguYmlsbGluZ1R5cGUsXG4gICAgICAgICAgICAgICAgdm9sdW1lUGVyY2VudGFnZTogdG9rZW5GZWVQYXJhbWV0ZXIsXG4gICAgICAgICAgICB9O1xuICAgICAgICB9IGVsc2UgaWYgKGZlZUNvbmZpZ3VyYXRpb24uZmVlT24gPT09ICdpbnRlZ3JhdG9yX3NoYXJlJykge1xuICAgICAgICAgICAgcmV0dXJuIHtcbiAgICAgICAgICAgICAgICB0eXBlOiAnaW50ZWdyYXRvcl9zaGFyZScsXG4gICAgICAgICAgICAgICAgZmVlUmVjaXBpZW50OiBmZWVDb25maWd1cmF0aW9uLnplcm9FeC5mZWVSZWNpcGllbnQsXG4gICAgICAgICAgICAgICAgYmlsbGluZ1R5cGU6IGZlZUNvbmZpZ3VyYXRpb24uemVyb0V4LmJpbGxpbmdUeXBlLFxuICAgICAgICAgICAgICAgIGludGVncmF0b3JTaGFyZVBlcmNlbnRhZ2U6IHRva2VuRmVlUGFyYW1ldGVyLFxuICAgICAgICAgICAgfTtcbiAgICAgICAgfVxuICAgIH1cblxuICAgIHJldHVybiB1bmRlZmluZWQ7XG59XG4iXSwidmVyc2lvbiI6M30=