{"file":"/Users/davidwalsh/code-local/0x-rfq-api/src/quoteRequestor/RefreshingQuoteRequestor.ts","mappings":";;;AAKA,iDAAkD;AAClD,kEAA6D;AAE7D,yDAAmD;AACnD,qDAAwF;AAExF,wHAAwH;AACxH,oDAAoD;AACpD,MAAM,wBAAwB,GAAG,yBAAa,GAAG,EAAE,CAAC;AAEpD;;;;GAIG;AACH,MAAa,wBAAwB;IAGjC,YACqB,gBAAiC,EACjC,yBAAwC,EACxC,YAA8D,EAC9D,kBAA0B,wBAAwB;QAHlD,qBAAgB,GAAhB,gBAAgB,CAAiB;QACjC,8BAAyB,GAAzB,yBAAyB,CAAe;QACxC,iBAAY,GAAZ,YAAY,CAAkD;QAC9D,oBAAe,GAAf,eAAe,CAAmC;QAEnE,IAAI,CAAC,QAAQ,GAAG,gCAAa,CAAC;QAC9B,IAAI,CAAC,eAAe,GAAG,IAAI,CAAC,qBAAqB,EAAE,CAAC;QACpD,IAAI,CAAC,gBAAgB,CAAC,EAAE,CACpB,mCAAe,CAAC,eAAe,EAC/B,GAAG,EAAE,CAAC,CAAC,IAAI,CAAC,eAAe,GAAG,IAAI,CAAC,qBAAqB,EAAE,CAAC,CAC9D,CAAC;IACN,CAAC;IAED;;;OAGG;IACI,KAAK,CAAC,gCAAgC,CACzC,UAAkB,EAClB,UAAkB,EAClB,eAA0B,EAC1B,eAAgC,EAChC,eAAsC,EACtC,OAAuB;QAEvB,OAAO,IAAI,CAAC,eAAe,CAAC,gCAAgC,CACxD,UAAU,EACV,UAAU,EACV,eAAe,EACf,eAAe,EACf,eAAe,EACf,OAAO,CACV,CAAC;IACN,CAAC;IAED;;;OAGG;IACI,KAAK,CAAC,0BAA0B,CACnC,UAAkB,EAAE,cAAc;IAClC,UAAkB,EAAE,cAAc;IAClC,eAA0B,EAC1B,eAAgC,EAChC,eAAsC,EACtC,OAAuB;QAEvB,OAAO,IAAI,CAAC,eAAe,CAAC,0BAA0B,CAClD,UAAU,EACV,UAAU,EACV,eAAe,EACf,eAAe,EACf,eAAe,EACf,OAAO,CACV,CAAC;IACN,CAAC;IAED;;;OAGG;IACI,uBAAuB,CAAC,SAAoB;QAC/C,OAAO,IAAI,CAAC,eAAe,CAAC,uBAAuB,CAAC,SAAS,CAAC,CAAC;IACnE,CAAC;IAED;;;OAGG;IACK,qBAAqB;QACzB,MAAM,iBAAiB,GAAG,IAAI,CAAC,gBAAgB,CAAC,uBAAuB,EAAE,CAAC;QAC1E,OAAO,IAAI,+BAAc,CACrB,iBAAiB,EACjB,IAAI,CAAC,yBAAyB,EAC9B,IAAI,CAAC,YAAY,EACjB,IAAI,CAAC,eAAe,EACpB,IAAI,CAAC,QAAQ,CAChB,CAAC;IACN,CAAC;CACJ;AAnFD,4DAmFC","names":[],"sources":["/Users/davidwalsh/code-local/0x-rfq-api/src/quoteRequestor/RefreshingQuoteRequestor.ts"],"sourcesContent":["import { MarketOperation, RfqRequestOpts, SignedNativeOrder } from '@0x/asset-swapper/lib/src/types';\r\nimport { Signature } from '@0x/protocol-utils';\r\nimport { BigNumber } from '@0x/utils';\r\nimport { AxiosInstance } from 'axios';\r\n\r\nimport { ONE_SECOND_MS } from '../core/constants';\r\nimport { RfqMakerManager } from '../utils/rfq_maker_manager';\r\n\r\nimport { METRICS_PROXY } from './MetricsProxyImpl';\r\nimport { MetricsProxy, QuoteRequestor, V4RFQIndicativeQuoteMM } from './QuoteRequestor';\r\n\r\n// This number should not be greater than 90s. Otherwise, the RFQt quotes from Jump and WM are likely to be filtered out\r\n// tslint:disable-next-line: custom-no-magic-numbers\r\nconst DEFAULT_EXPIRY_BUFFER_MS = ONE_SECOND_MS * 80;\r\n\r\n/**\r\n * A wrapper of `QuoteRequestor` constructed with an instance of `RfqMakerManager`\r\n * instead of `rfqAssetOfferings`. This allows the underlying Quote Requestor\r\n * to be refreshed with the pairs of RfqMakerManager are refreshed.\r\n */\r\nexport class RefreshingQuoteRequestor {\r\n    private _quoteRequestor: QuoteRequestor;\r\n    private readonly _metrics: MetricsProxy;\r\n    constructor(\r\n        private readonly _rfqMakerManager: RfqMakerManager,\r\n        private readonly _quoteRequestorHttpClient: AxiosInstance,\r\n        private readonly _altRfqCreds?: { altRfqApiKey: string; altRfqProfile: string },\r\n        private readonly _expiryBufferMs: number = DEFAULT_EXPIRY_BUFFER_MS,\r\n    ) {\r\n        this._metrics = METRICS_PROXY;\r\n        this._quoteRequestor = this._createQuoteRequestor();\r\n        this._rfqMakerManager.on(\r\n            RfqMakerManager.REFRESHED_EVENT,\r\n            () => (this._quoteRequestor = this._createQuoteRequestor()),\r\n        );\r\n    }\r\n\r\n    /**\r\n     * Passthrough to the internal `QuoteRequestor`'s `requestRfqtIndicativeQuotesAsync`\r\n     * method.\r\n     */\r\n    public async requestRfqtIndicativeQuotesAsync(\r\n        makerToken: string,\r\n        takerToken: string,\r\n        assetFillAmount: BigNumber,\r\n        marketOperation: MarketOperation,\r\n        comparisonPrice: BigNumber | undefined,\r\n        options: RfqRequestOpts,\r\n    ): Promise<V4RFQIndicativeQuoteMM[]> {\r\n        return this._quoteRequestor.requestRfqtIndicativeQuotesAsync(\r\n            makerToken,\r\n            takerToken,\r\n            assetFillAmount,\r\n            marketOperation,\r\n            comparisonPrice,\r\n            options,\r\n        );\r\n    }\r\n\r\n    /**\r\n     * Passthrough to the internal `QuoteRequestor`'s `requestRfqtFirmQuotesAsync`\r\n     * method.\r\n     */\r\n    public async requestRfqtFirmQuotesAsync(\r\n        makerToken: string, // maker token\r\n        takerToken: string, // taker token\r\n        assetFillAmount: BigNumber,\r\n        marketOperation: MarketOperation,\r\n        comparisonPrice: BigNumber | undefined,\r\n        options: RfqRequestOpts,\r\n    ): Promise<SignedNativeOrder[]> {\r\n        return this._quoteRequestor.requestRfqtFirmQuotesAsync(\r\n            makerToken,\r\n            takerToken,\r\n            assetFillAmount,\r\n            marketOperation,\r\n            comparisonPrice,\r\n            options,\r\n        );\r\n    }\r\n\r\n    /**\r\n     * Passthrough to the internal `QuoteRequestor`'s `getMakerUriForSignature`\r\n     * method.\r\n     */\r\n    public getMakerUriForSignature(signature: Signature): string | undefined {\r\n        return this._quoteRequestor.getMakerUriForSignature(signature);\r\n    }\r\n\r\n    /**\r\n     * Handler for when the RFQ Maker Manager emits a pairs refreshed event.\r\n     * Creates a new `QuoteRequestor` instance with new pairs.\r\n     */\r\n    private _createQuoteRequestor(): QuoteRequestor {\r\n        const rfqAssetOfferings = this._rfqMakerManager.getRfqtV1MakerOfferings();\r\n        return new QuoteRequestor(\r\n            rfqAssetOfferings,\r\n            this._quoteRequestorHttpClient,\r\n            this._altRfqCreds,\r\n            this._expiryBufferMs,\r\n            this._metrics,\r\n        );\r\n    }\r\n}\r\n"],"version":3}