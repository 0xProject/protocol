6b8e02f4c42d9c19d633ad57f01f849c
"use strict";
Object.defineProperty(exports, "__esModule", { value: true });
exports.RfqMakerHandlers = void 0;
const HttpStatus = require("http-status-codes");
const prom_client_1 = require("prom-client");
const constants_1 = require("../core/constants");
const logger_1 = require("../logger");
const rfq_maker_service_1 = require("../services/rfq_maker_service");
const RFQ_MAKER_INVALID_KEY = new prom_client_1.Counter({
    name: 'rfq_maker_invalid_key',
    help: 'A request to maker endpoints failed because of invalid api key.',
});
const RFQ_MAKER_UPDATE_CLIENT_ERROR = new prom_client_1.Counter({
    name: 'rfq_maker_update_client_error',
    help: 'A request to update maker configs failed because of client side error.',
    labelNames: ['makerId'],
});
const RFQ_MAKER_UPDATE_SEVER_ERROR = new prom_client_1.Counter({
    name: 'rfq_maker_update_sever_error',
    help: 'A request to update maker configs failed because of sever side error.',
    labelNames: ['makerId'],
});
const RFQ_MAKER_UPDATE_SUCCEED = new prom_client_1.Counter({
    name: 'rfq_maker_update_succeed',
    help: 'A request to update maker configs succeeded.',
    labelNames: ['makerId'],
});
const RFQ_MAKER_GET_CLIENT_ERROR = new prom_client_1.Counter({
    name: 'rfq_maker_get_client_error',
    help: 'A request to GET maker failed because of client side error.',
    labelNames: ['makerId'],
});
const RFQ_MAKER_GET_SEVER_ERROR = new prom_client_1.Counter({
    name: 'rfq_maker_get_sever_error',
    help: 'A request to GET maker endpoint failed because of sever side error.',
    labelNames: ['makerId'],
});
const RFQ_MAKER_GET_SUCCEED = new prom_client_1.Counter({
    name: 'rfq_maker_get_succeed',
    help: 'A request to GET maker succeeded.',
    labelNames: ['makerId'],
});
const convertToLowerCase = (pairs) => {
    return pairs.map((pair) => {
        return [pair[0].toLowerCase(), pair[1].toLowerCase()];
    });
};
/**
 * Validates the request body of a PUT request.
 */
const validatePutPayloadOrThrow = (body) => {
    rfq_maker_service_1.RfqMakerService.validatePairsPayloadOrThrow(body.pairs);
    rfq_maker_service_1.RfqMakerService.validateUriOrThrow('rfqtUri', body.rfqtUri);
    rfq_maker_service_1.RfqMakerService.validateUriOrThrow('rfqmUri', body.rfqmUri);
};
/**
 * Validates the request body of a PATCH request.
 */
const validatePatchPayloadOrThrow = (body) => {
    if (body.pairs !== undefined) {
        rfq_maker_service_1.RfqMakerService.validatePairsPayloadOrThrow(body.pairs);
    }
    if (body.rfqtUri !== undefined) {
        rfq_maker_service_1.RfqMakerService.validateUriOrThrow('rfqtUri', body.rfqtUri);
    }
    if (body.rfqmUri !== undefined) {
        rfq_maker_service_1.RfqMakerService.validateUriOrThrow('rfqmUri', body.rfqmUri);
    }
    if (body.pairs === undefined && body.rfqtUri === undefined && body.rfqmUri === undefined) {
        throw new Error('No valid field is specified.');
    }
};
class RfqMakerHandlers {
    constructor(_rfqMakerService) {
        this._rfqMakerService = _rfqMakerService;
    }
    /**
     * Handler for PUT operation of the `/maker/v1/chain-id/:chainId` endpoint.
     */
    async putRfqMakerAsync(req, res) {
        const requestId = req.id;
        const makerApiKey = req.headers[constants_1.RFQ_MAKER_API_KEY_HEADER];
        const makerId = this._rfqMakerService.mapMakerApiKeyToId(makerApiKey);
        if (makerId === null) {
            const message = `Invalid api key.`;
            logger_1.logger.info({ requestId, apiKey: makerApiKey }, message);
            RFQ_MAKER_INVALID_KEY.inc();
            res.status(HttpStatus.UNAUTHORIZED).send({ error: message });
            return;
        }
        if (!rfq_maker_service_1.RfqMakerService.isValidChainId(req.params.chainId)) {
            const message = `Invalid chainId.`;
            logger_1.logger.info({ requestId, makerId, chainId: req.params.chainId }, message);
            RFQ_MAKER_UPDATE_CLIENT_ERROR.labels(makerId).inc();
            res.status(HttpStatus.BAD_REQUEST).send({ error: message });
            return;
        }
        const chainId = Number(req.params.chainId);
        try {
            validatePutPayloadOrThrow(req.body);
        }
        catch ({ message }) {
            logger_1.logger.info({ requestId, makerId, chainId }, message);
            RFQ_MAKER_UPDATE_CLIENT_ERROR.labels(makerId).inc();
            res.status(HttpStatus.BAD_REQUEST).send({ error: message });
            return;
        }
        try {
            const pairs = req.body.pairs;
            const rfqtUri = req.body.rfqtUri;
            const rfqmUri = req.body.rfqmUri;
            const rfqMaker = await this._rfqMakerService.createOrUpdateRfqMakerAsync(makerId, chainId, convertToLowerCase(pairs), rfqtUri, rfqmUri);
            res.status(HttpStatus.CREATED).send(rfqMaker);
            const rfqmMakerUri = rfqMaker.rfqmUri;
            logger_1.logger.info({ requestId, makerId, chainId, rfqmMakerUri }, 'Successfully created or updated RfqMaker entity.');
            RFQ_MAKER_UPDATE_SUCCEED.labels(makerId).inc();
        }
        catch (error) {
            const message = `Failed to create or update RfqMaker entity.`;
            logger_1.logger.error({ requestId, makerId, chainId, errorMessage: error.message }, message);
            RFQ_MAKER_UPDATE_SEVER_ERROR.labels(makerId).inc();
            res.status(HttpStatus.INTERNAL_SERVER_ERROR).send({ message });
        }
    }
    /**
     * Handler for PATCH operation of the `/maker/v1/chain-id/:chainId` endpoint.
     */
    async patchRfqMakerAsync(req, res) {
        const requestId = req.id;
        const makerApiKey = req.headers[constants_1.RFQ_MAKER_API_KEY_HEADER];
        const makerId = this._rfqMakerService.mapMakerApiKeyToId(makerApiKey);
        if (makerId === null) {
            const message = `Invalid api key.`;
            logger_1.logger.info({ requestId, apiKey: makerApiKey }, message);
            RFQ_MAKER_INVALID_KEY.inc();
            res.status(HttpStatus.UNAUTHORIZED).send({ error: message });
            return;
        }
        if (!rfq_maker_service_1.RfqMakerService.isValidChainId(req.params.chainId)) {
            const message = `Invalid chainId.`;
            logger_1.logger.info({ requestId, makerId, chainId: req.params.chainId }, message);
            RFQ_MAKER_UPDATE_CLIENT_ERROR.labels(makerId).inc();
            res.status(HttpStatus.BAD_REQUEST).send({ error: message });
            return;
        }
        const chainId = Number(req.params.chainId);
        try {
            validatePatchPayloadOrThrow(req.body);
        }
        catch ({ message }) {
            logger_1.logger.info({ requestId, makerId, chainId }, message);
            RFQ_MAKER_UPDATE_CLIENT_ERROR.labels(makerId).inc();
            res.status(HttpStatus.BAD_REQUEST).send({ error: message });
            return;
        }
        try {
            const pairs = req.body.pairs;
            const rfqtUri = req.body.rfqtUri;
            const rfqmUri = req.body.rfqmUri;
            const rfqMaker = await this._rfqMakerService.patchRfqMakerAsync(makerId, chainId, pairs !== undefined ? convertToLowerCase(pairs) : undefined, rfqtUri, rfqmUri);
            res.status(HttpStatus.OK).send(rfqMaker);
            const rfqmMakerUri = rfqMaker.rfqmUri;
            logger_1.logger.info({ requestId, makerId, chainId, rfqmMakerUri }, 'Successfully patched RfqMaker entity.');
            RFQ_MAKER_UPDATE_SUCCEED.labels(makerId).inc();
        }
        catch (error) {
            const message = `Failed to patch RfqMaker entity.`;
            logger_1.logger.error({ requestId, makerId, chainId, errorMessage: error.message }, message);
            RFQ_MAKER_UPDATE_SEVER_ERROR.labels(makerId).inc();
            res.status(HttpStatus.INTERNAL_SERVER_ERROR).send({ message });
        }
    }
    /**
     * Handler for GET operation of the `/maker/v1/chain-id/:chainId` endpoint.
     */
    async getRfqMakerAsync(req, res) {
        const requestId = req.id;
        const makerApiKey = req.headers[constants_1.RFQ_MAKER_API_KEY_HEADER];
        const makerId = this._rfqMakerService.mapMakerApiKeyToId(makerApiKey);
        if (makerId === null) {
            const message = `Invalid api key.`;
            logger_1.logger.info({ requestId, apiKey: makerApiKey }, message);
            RFQ_MAKER_INVALID_KEY.inc();
            res.status(HttpStatus.UNAUTHORIZED).send({ error: message });
            return;
        }
        if (!rfq_maker_service_1.RfqMakerService.isValidChainId(req.params.chainId)) {
            const message = `Invalid chainId.`;
            logger_1.logger.info({ requestId, makerId, chainId: req.params.chainId }, message);
            RFQ_MAKER_GET_CLIENT_ERROR.labels(makerId).inc();
            res.status(HttpStatus.BAD_REQUEST).send({ error: message });
            return;
        }
        const chainId = Number(req.params.chainId);
        try {
            const rfqMaker = await this._rfqMakerService.getRfqMakerAsync(makerId, chainId);
            res.status(HttpStatus.OK).send(rfqMaker);
            logger_1.logger.info({ requestId, makerId, chainId }, 'Successfully got RfqMaker entity.');
            RFQ_MAKER_GET_SUCCEED.labels(makerId).inc();
        }
        catch (error) {
            const message = `Failed to get RfqMaker entity.`;
            logger_1.logger.error({ requestId, makerId, chainId, errorMessage: error.message }, message);
            RFQ_MAKER_GET_SEVER_ERROR.labels(makerId).inc();
            res.status(HttpStatus.INTERNAL_SERVER_ERROR).send({ message });
        }
    }
}
exports.RfqMakerHandlers = RfqMakerHandlers;
//# sourceMappingURL=data:application/json;charset=utf-8;base64,eyJmaWxlIjoiL1VzZXJzL2Rhdmlkd2Fsc2gvY29kZS1sb2NhbC8weC1yZnEtYXBpL3NyYy9oYW5kbGVycy9yZnFfbWFrZXJfaGFuZGxlcnMudHMiLCJtYXBwaW5ncyI6Ijs7O0FBQ0EsZ0RBQWdEO0FBQ2hELDZDQUFzQztBQUV0QyxpREFBNkQ7QUFFN0Qsc0NBQW1DO0FBQ25DLHFFQUFnRTtBQUVoRSxNQUFNLHFCQUFxQixHQUFHLElBQUkscUJBQU8sQ0FBQztJQUN0QyxJQUFJLEVBQUUsdUJBQXVCO0lBQzdCLElBQUksRUFBRSxpRUFBaUU7Q0FDMUUsQ0FBQyxDQUFDO0FBQ0gsTUFBTSw2QkFBNkIsR0FBRyxJQUFJLHFCQUFPLENBQUM7SUFDOUMsSUFBSSxFQUFFLCtCQUErQjtJQUNyQyxJQUFJLEVBQUUsd0VBQXdFO0lBQzlFLFVBQVUsRUFBRSxDQUFDLFNBQVMsQ0FBQztDQUMxQixDQUFDLENBQUM7QUFDSCxNQUFNLDRCQUE0QixHQUFHLElBQUkscUJBQU8sQ0FBQztJQUM3QyxJQUFJLEVBQUUsOEJBQThCO0lBQ3BDLElBQUksRUFBRSx1RUFBdUU7SUFDN0UsVUFBVSxFQUFFLENBQUMsU0FBUyxDQUFDO0NBQzFCLENBQUMsQ0FBQztBQUNILE1BQU0sd0JBQXdCLEdBQUcsSUFBSSxxQkFBTyxDQUFDO0lBQ3pDLElBQUksRUFBRSwwQkFBMEI7SUFDaEMsSUFBSSxFQUFFLDhDQUE4QztJQUNwRCxVQUFVLEVBQUUsQ0FBQyxTQUFTLENBQUM7Q0FDMUIsQ0FBQyxDQUFDO0FBQ0gsTUFBTSwwQkFBMEIsR0FBRyxJQUFJLHFCQUFPLENBQUM7SUFDM0MsSUFBSSxFQUFFLDRCQUE0QjtJQUNsQyxJQUFJLEVBQUUsNkRBQTZEO0lBQ25FLFVBQVUsRUFBRSxDQUFDLFNBQVMsQ0FBQztDQUMxQixDQUFDLENBQUM7QUFDSCxNQUFNLHlCQUF5QixHQUFHLElBQUkscUJBQU8sQ0FBQztJQUMxQyxJQUFJLEVBQUUsMkJBQTJCO0lBQ2pDLElBQUksRUFBRSxxRUFBcUU7SUFDM0UsVUFBVSxFQUFFLENBQUMsU0FBUyxD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QUM7WUFDaEQsR0FBRyxDQUFDLE1BQU0sQ0FBQyxVQUFVLENBQUMscUJBQXFCLENBQUMsQ0FBQyxJQUFJLENBQUMsRUFBRSxPQUFPLEVBQUUsQ0FBQyxDQUFDO1NBQ2xFO0lBQ0wsQ0FBQztDQUNKO0FBOUpELDRDQThKQyIsIm5hbWVzIjpbXSwic291cmNlcyI6WyIvVXNlcnMvZGF2aWR3YWxzaC9jb2RlLWxvY2FsLzB4LXJmcS1hcGkvc3JjL2hhbmRsZXJzL3JmcV9tYWtlcl9oYW5kbGVycy50cyJdLCJzb3VyY2VzQ29udGVudCI6WyJpbXBvcnQgKiBhcyBleHByZXNzIGZyb20gJ2V4cHJlc3MnO1xyXG5pbXBvcnQgKiBhcyBIdHRwU3RhdHVzIGZyb20gJ2h0dHAtc3RhdHVzLWNvZGVzJztcclxuaW1wb3J0IHsgQ291bnRlciB9IGZyb20gJ3Byb20tY2xpZW50JztcclxuXHJcbmltcG9ydCB7IFJGUV9NQUtFUl9BUElfS0VZX0hFQURFUiB9IGZyb20gJy4uL2NvcmUvY29uc3RhbnRzJztcclxuaW1wb3J0IHsgUmZxTWFrZXIgfSBmcm9tICcuLi9lbnRpdGllcyc7XHJcbmltcG9ydCB7IGxvZ2dlciB9IGZyb20gJy4uL2xvZ2dlcic7XHJcbmltcG9ydCB7IFJmcU1ha2VyU2VydmljZSB9IGZyb20gJy4uL3NlcnZpY2VzL3JmcV9tYWtlcl9zZXJ2aWNlJztcclxuXHJcbmNvbnN0IFJGUV9NQUtFUl9JTlZBTElEX0tFWSA9IG5ldyBDb3VudGVyKHtcclxuICAgIG5hbWU6ICdyZnFfbWFrZXJfaW52YWxpZF9rZXknLFxyXG4gICAgaGVscDogJ0EgcmVxdWVzdCB0byBtYWtlciBlbmRwb2ludHMgZmFpbGVkIGJlY2F1c2Ugb2YgaW52YWxpZCBhcGkga2V5LicsXHJcbn0pO1xyXG5jb25zdCBSRlFfTUFLRVJfVVBEQVRFX0NMSUVOVF9FUlJPUiA9IG5ldyBDb3VudGVyKHtcclxuICAgIG5hbWU6ICdyZnFfbWFrZXJfdXBkYXRlX2NsaWVudF9lcnJvcicsXHJcbiAgICBoZWxwOiAnQSByZXF1ZXN0IHRvIHVwZGF0ZSBtYWtlciBjb25maWdzIGZhaWxlZCBiZWNhdXNlIG9mIGNsaWVudCBzaWRlIGVycm9yLicsXHJcbiAgICBsYWJlbE5hbWVzOiBbJ21ha2VySWQnXSxcclxufSk7XHJcbmNvbnN0IFJGUV9NQUtFUl9VUERBVEVfU0VWRVJfRVJST1IgPSBuZXcgQ291bnRlcih7XHJcbiAgICBuYW1lOiAncmZxX21ha2VyX3VwZGF0ZV9zZXZlcl9lcnJvcicsXHJcbiAgICBoZWxwOiAnQSByZXF1ZXN0IHRvIHVwZGF0ZSBtYWtlciBjb25maWdzIGZhaWxlZCBiZWNhdXNlIG9mIHNldmVyIHNpZGUgZXJyb3IuJyxcclxuICAgIGxhYmVsTmFtZXM6IFsnbWFrZXJJZCddLFxyXG59KTtcclxuY29uc3QgUkZRX01BS0VSX1VQREFURV9TVUNDRUVEID0gbmV3IENvdW50ZXIoe1xyXG4gICAgbmFtZTogJ3JmcV9tYWtlcl91cGRhdGVfc3VjY2VlZCcsXHJcbiAgICBoZWxwOiAnQSByZXF1ZXN0IHRvIHVwZGF0ZSBtYWtlciBjb25maWdzIHN1Y2NlZWRlZC4nLFxyXG4gICAgbGFiZWxOYW1lczogWydtYWtlcklkJ10sXHJcbn0pO1xyXG5jb25zdCBSRlFfTUFLRVJfR0VUX0NMSUVOVF9FUlJPUiA9IG5ldyBDb3VudGVyKHtcclxuICAgIG5hbWU6ICdyZnFfbWFrZXJfZ2V0X2NsaWVudF9lcnJvcicsXHJcbiAgICBoZWxwOiAnQSByZXF1ZXN0IHRvIEdFVCBtYWtlciBmYWlsZWQgYmVjYXVzZSBvZiBjbGllbnQgc2lkZSBlcnJvci4nLFxyXG4gICAgbGFiZWxOYW1lczogWydtYWtlcklkJ10sXHJcbn0pO1xyXG5jb25zdCBSRlFfTUFLRVJfR0VUX1NFVkVSX0VSUk9SID0gbmV3IENvdW50ZXIoe1xyXG4gICAgbmFtZTogJ3JmcV9tYWtlcl9nZXRfc2V2ZXJfZXJyb3InLFxyXG4gICAgaGVscDogJ0EgcmVxdWVzdCB0byBHRVQgbWFrZXIgZW5kcG9pbnQgZmFpbGVkIGJlY2F1c2Ugb2Ygc2V2ZXIgc2lkZSBlcnJvci4nLFxyXG4gICAgbGFiZWxOYW1lczogWydtYWtlcklkJ10sXHJcbn0pO1xyXG5jb25zdCBSRlFfTUFLRVJfR0VUX1NVQ0NFRUQgPSBuZXcgQ291bnRlcih7XHJcbiAgICBuYW1lOiAncmZxX21ha2VyX2dldF9zdWNjZWVkJyxcclxuICAgIGhlbHA6ICdBIHJlcXVlc3QgdG8gR0VUIG1ha2VyIHN1Y2NlZWRlZC4nLFxyXG4gICAgbGFiZWxOYW1lczogWydtYWtlcklkJ10sXHJcbn0pO1xyXG5cclxuY29uc3QgY29udmVydFRvTG93ZXJDYXNlID0gKHBhaXJzOiBbc3RyaW5nLCBzdHJpbmddW10pOiBbc3RyaW5nLCBzdHJpbmddW10gPT4ge1xyXG4gICAgcmV0dXJuIHBhaXJzLm1hcCgocGFpcikgPT4ge1xyXG4gICAgICAgIHJldHVybiBbcGFpclswXS50b0xvd2VyQ2FzZSgpLCBwYWlyWzFdLnRvTG93ZXJDYXNlKCldO1xyXG4gICAgfSk7XHJcbn07XHJcblxyXG4vKipcclxuICogVmFsaWRhdGVzIHRoZSByZXF1ZXN0IGJvZHkgb2YgYSBQVVQgcmVxdWVzdC5cclxuICovXHJcbmNvbnN0IHZhbGlkYXRlUHV0UGF5bG9hZE9yVGhyb3cgPSAoYm9keTogeyBwYWlyczogW107IHJmcXRVcmk6IHN0cmluZzsgcmZxbVVyaTogc3RyaW5nIH0pID0+IHtcclxuICAgIFJmcU1ha2VyU2VydmljZS52YWxpZGF0ZVBhaXJzUGF5bG9hZE9yVGhyb3coYm9keS5wYWlycyk7XHJcbiAgICBSZnFNYWtlclNlcnZpY2UudmFsaWRhdGVVcmlPclRocm93KCdyZnF0VXJpJywgYm9keS5yZnF0VXJpKTtcclxuICAgIFJmcU1ha2VyU2VydmljZS52YWxpZGF0ZVVyaU9yVGhyb3coJ3JmcW1VcmknLCBib2R5LnJmcW1VcmkpO1xyXG59O1xyXG5cclxuLyoqXHJcbiAqIFZhbGlkYXRlcyB0aGUgcmVxdWVzdCBib2R5IG9mIGEgUEFUQ0ggcmVxdWVzdC5cclxuICovXHJcbmNvbnN0IHZhbGlkYXRlUGF0Y2hQYXlsb2FkT3JUaHJvdyA9IChib2R5OiB7IHBhaXJzPzogW107IHJmcXRVcmk/OiBzdHJpbmc7IHJmcW1Vcmk/OiBzdHJpbmcgfSkgPT4ge1xyXG4gICAgaWYgKGJvZHkucGFpcnMgIT09IHVuZGVmaW5lZCkge1xyXG4gICAgICAgIFJmcU1ha2VyU2VydmljZS52YWxpZGF0ZVBhaXJzUGF5bG9hZE9yVGhyb3coYm9keS5wYWlycyk7XHJcbiAgICB9XHJcblxyXG4gICAgaWYgKGJvZHkucmZxdFVyaSAhPT0gdW5kZWZpbmVkKSB7XHJcbiAgICAgICAgUmZxTWFrZXJTZXJ2aWNlLnZhbGlkYXRlVXJpT3JUaHJvdygncmZxdFVyaScsIGJvZHkucmZxdFVyaSk7XHJcbiAgICB9XHJcblxyXG4gICAgaWYgKGJvZHkucmZxbVVyaSAhPT0gdW5kZWZpbmVkKSB7XHJcbiAgICAgICAgUmZxTWFrZXJTZXJ2aWNlLnZhbGlkYXRlVXJpT3JUaHJvdygncmZxbVVyaScsIGJvZHkucmZxbVVyaSk7XHJcbiAgICB9XHJcblxyXG4gICAgaWYgKGJvZHkucGFpcnMgPT09IHVuZGVmaW5lZCAmJiBib2R5LnJmcXRVcmkgPT09IHVuZGVmaW5lZCAmJiBib2R5LnJmcW1VcmkgPT09IHVuZGVmaW5lZCkge1xyXG4gICAgICAgIHRocm93IG5ldyBFcnJvcignTm8gdmFsaWQgZmllbGQgaXMgc3BlY2lmaWVkLicpO1xyXG4gICAgfVxyXG59O1xyXG5cclxuZXhwb3J0IGNsYXNzIFJmcU1ha2VySGFuZGxlcnMge1xyXG4gICAgY29uc3RydWN0b3IocHJpdmF0ZSByZWFkb25seSBfcmZxTWFrZXJTZXJ2aWNlOiBSZnFNYWtlclNlcnZpY2UpIHt9XHJcblxyXG4gICAgLyoqXHJcbiAgICAgKiBIYW5kbGVyIGZvciBQVVQgb3BlcmF0aW9uIG9mIHRoZSBgL21ha2VyL3YxL2NoYWluLWlkLzpjaGFpbklkYCBlbmRwb2ludC5cclxuICAgICAqL1xyXG4gICAgcHVibGljIGFzeW5jIHB1dFJmcU1ha2VyQXN5bmMocmVxOiBleHByZXNzLlJlcXVlc3QsIHJlczogZXhwcmVzcy5SZXNwb25zZSk6IFByb21pc2U8dm9pZD4ge1xyXG4gICAgICAgIGNvbnN0IHJlcXVlc3RJZCA9IHJlcS5pZDtcclxuICAgICAgICBjb25zdCBtYWtlckFwaUtleSA9IHJlcS5oZWFkZXJzW1JGUV9NQUtFUl9BUElfS0VZX0hFQURFUl0gYXMgc3RyaW5nO1xyXG4gICAgICAgIGNvbnN0IG1ha2VySWQgPSB0aGlzLl9yZnFNYWtlclNlcnZpY2UubWFwTWFrZXJBcGlLZXlUb0lkKG1ha2VyQXBpS2V5KTtcclxuXHJcbiAgICAgICAgaWYgKG1ha2VySWQgPT09IG51bGwpIHtcclxuICAgICAgICAgICAgY29uc3QgbWVzc2FnZSA9IGBJbnZhbGlkIGFwaSBrZXkuYDtcclxuICAgICAgICAgICAgbG9nZ2VyLmluZm8oeyByZXF1ZXN0SWQsIGFwaUtleTogbWFrZXJBcGlLZXkgfSwgbWVzc2FnZSk7XHJcbiAgICAgICAgICAgIFJGUV9NQUtFUl9JTlZBTElEX0tFWS5pbmMoKTtcclxuICAgICAgICAgICAgcmVzLnN0YXR1cyhIdHRwU3RhdHVzLlVOQVVUSE9SSVpFRCkuc2VuZCh7IGVycm9yOiBtZXNzYWdlIH0pO1xyXG4gICAgICAgICAgICByZXR1cm47XHJcbiAgICAgICAgfVxyXG5cclxuICAgICAgICBpZiAoIVJmcU1ha2VyU2VydmljZS5pc1ZhbGlkQ2hhaW5JZChyZXEucGFyYW1zLmNoYWluSWQpKSB7XHJcbiAgICAgICAgICAgIGNvbnN0IG1lc3NhZ2UgPSBgSW52YWxpZCBjaGFpbklkLmA7XHJcbiAgICAgICAgICAgIGxvZ2dlci5pbmZvKHsgcmVxdWVzdElkLCBtYWtlcklkLCBjaGFpbklkOiByZXEucGFyYW1zLmNoYWluSWQgfSwgbWVzc2FnZSk7XHJcbiAgICAgICAgICAgIFJGUV9NQUtFUl9VUERBVEVfQ0xJRU5UX0VSUk9SLmxhYmVscyhtYWtlcklkKS5pbmMoKTtcclxuICAgICAgICAgICAgcmVzLnN0YXR1cyhIdHRwU3RhdHVzLkJBRF9SRVFVRVNUKS5zZW5kKHsgZXJyb3I6IG1lc3NhZ2UgfSk7XHJcbiAgICAgICAgICAgIHJldHVybjtcclxuICAgICAgICB9XHJcblxyXG4gICAgICAgIGNvbnN0IGNoYWluSWQgPSBOdW1iZXIocmVxLnBhcmFtcy5jaGFpbklkKTtcclxuICAgICAgICB0cnkge1xyXG4gICAgICAgICAgICB2YWxpZGF0ZVB1dFBheWxvYWRPclRocm93KHJlcS5ib2R5KTtcclxuICAgICAgICB9IGNhdGNoICh7IG1lc3NhZ2UgfSkge1xyXG4gICAgICAgICAgICBsb2dnZXIuaW5mbyh7IHJlcXVlc3RJZCwgbWFrZXJJZCwgY2hhaW5JZCB9LCBtZXNzYWdlKTtcclxuICAgICAgICAgICAgUkZRX01BS0VSX1VQREFURV9DTElFTlRfRVJST1IubGFiZWxzKG1ha2VySWQpLmluYygpO1xyXG4gICAgICAgICAgICByZXMuc3RhdHVzKEh0dHBTdGF0dXMuQkFEX1JFUVVFU1QpLnNlbmQoeyBlcnJvcjogbWVzc2FnZSB9KTtcclxuICAgICAgICAgICAgcmV0dXJuO1xyXG4gICAgICAgIH1cclxuXHJcbiAgICAgICAgdHJ5IHtcclxuICAgICAgICAgICAgY29uc3QgcGFpcnMgPSByZXEuYm9keS5wYWlycztcclxuICAgICAgICAgICAgY29uc3QgcmZxdFVyaSA9IHJlcS5ib2R5LnJmcXRVcmk7XHJcbiAgICAgICAgICAgIGNvbnN0IHJmcW1VcmkgPSByZXEuYm9keS5yZnFtVXJpO1xyXG4gICAgICAgICAgICBjb25zdCByZnFNYWtlcjogUmZxTWFrZXIgPSBhd2FpdCB0aGlzLl9yZnFNYWtlclNlcnZpY2UuY3JlYXRlT3JVcGRhdGVSZnFNYWtlckFzeW5jKFxyXG4gICAgICAgICAgICAgICAgbWFrZXJJZCxcclxuICAgICAgICAgICAgICAgIGNoYWluSWQsXHJcbiAgICAgICAgICAgICAgICBjb252ZXJ0VG9Mb3dlckNhc2UocGFpcnMpLFxyXG4gICAgICAgICAgICAgICAgcmZxdFVyaSxcclxuICAgICAgICAgICAgICAgIHJmcW1VcmksXHJcbiAgICAgICAgICAgICk7XHJcbiAgICAgICAgICAgIHJlcy5zdGF0dXMoSHR0cFN0YXR1cy5DUkVBVEVEKS5zZW5kKHJmcU1ha2VyKTtcclxuICAgICAgICAgICAgY29uc3QgcmZxbU1ha2VyVXJpID0gcmZxTWFrZXIucmZxbVVyaTtcclxuICAgICAgICAgICAgbG9nZ2VyLmluZm8oXHJcbiAgICAgICAgICAgICAgICB7IHJlcXVlc3RJZCwgbWFrZXJJZCwgY2hhaW5JZCwgcmZxbU1ha2VyVXJpIH0sXHJcbiAgICAgICAgICAgICAgICAnU3VjY2Vzc2Z1bGx5IGNyZWF0ZWQgb3IgdXBkYXRlZCBSZnFNYWtlciBlbnRpdHkuJyxcclxuICAgICAgICAgICAgKTtcclxuICAgICAgICAgICAgUkZRX01BS0VSX1VQREFURV9TVUNDRUVELmxhYmVscyhtYWtlcklkKS5pbmMoKTtcclxuICAgICAgICB9IGNhdGNoIChlcnJvcikge1xyXG4gICAgICAgICAgICBjb25zdCBtZXNzYWdlID0gYEZhaWxlZCB0byBjcmVhdGUgb3IgdXBkYXRlIFJmcU1ha2VyIGVudGl0eS5gO1xyXG4gICAgICAgICAgICBsb2dnZXIuZXJyb3IoeyByZXF1ZXN0SWQsIG1ha2VySWQsIGNoYWluSWQsIGVycm9yTWVzc2FnZTogZXJyb3IubWVzc2FnZSB9LCBtZXNzYWdlKTtcclxuICAgICAgICAgICAgUkZRX01BS0VSX1VQREFURV9TRVZFUl9FUlJPUi5sYWJlbHMobWFrZXJJZCkuaW5jKCk7XHJcbiAgICAgICAgICAgIHJlcy5zdGF0dXMoSHR0cFN0YXR1cy5JTlRFUk5BTF9TRVJWRVJfRVJST1IpLnNlbmQoeyBtZXNzYWdlIH0pO1xyXG4gICAgICAgIH1cclxuICAgIH1cclxuXHJcbiAgICAvKipcclxuICAgICAqIEhhbmRsZXIgZm9yIFBBVENIIG9wZXJhdGlvbiBvZiB0aGUgYC9tYWtlci92MS9jaGFpbi1pZC86Y2hhaW5JZGAgZW5kcG9pbnQuXHJcbiAgICAgKi9cclxuICAgIHB1YmxpYyBhc3luYyBwYXRjaFJmcU1ha2VyQXN5bmMocmVxOiBleHByZXNzLlJlcXVlc3QsIHJlczogZXhwcmVzcy5SZXNwb25zZSk6IFByb21pc2U8dm9pZD4ge1xyXG4gICAgICAgIGNvbnN0IHJlcXVlc3RJZCA9IHJlcS5pZDtcclxuICAgICAgICBjb25zdCBtYWtlckFwaUtleSA9IHJlcS5oZWFkZXJzW1JGUV9NQUtFUl9BUElfS0VZX0hFQURFUl0gYXMgc3RyaW5nO1xyXG4gICAgICAgIGNvbnN0IG1ha2VySWQgPSB0aGlzLl9yZnFNYWtlclNlcnZpY2UubWFwTWFrZXJBcGlLZXlUb0lkKG1ha2VyQXBpS2V5KTtcclxuXHJcbiAgICAgICAgaWYgKG1ha2VySWQgPT09IG51bGwpIHtcclxuICAgICAgICAgICAgY29uc3QgbWVzc2FnZSA9IGBJbnZhbGlkIGFwaSBrZXkuYDtcclxuICAgICAgICAgICAgbG9nZ2VyLmluZm8oeyByZXF1ZXN0SWQsIGFwaUtleTogbWFrZXJBcGlLZXkgfSwgbWVzc2FnZSk7XHJcbiAgICAgICAgICAgIFJGUV9NQUtFUl9JTlZBTElEX0tFWS5pbmMoKTtcclxuICAgICAgICAgICAgcmVzLnN0YXR1cyhIdHRwU3RhdHVzLlVOQVVUSE9SSVpFRCkuc2VuZCh7IGVycm9yOiBtZXNzYWdlIH0pO1xyXG4gICAgICAgICAgICByZXR1cm47XHJcbiAgICAgICAgfVxyXG5cclxuICAgICAgICBpZiAoIVJmcU1ha2VyU2VydmljZS5pc1ZhbGlkQ2hhaW5JZChyZXEucGFyYW1zLmNoYWluSWQpKSB7XHJcbiAgICAgICAgICAgIGNvbnN0IG1lc3NhZ2UgPSBgSW52YWxpZCBjaGFpbklkLmA7XHJcbiAgICAgICAgICAgIGxvZ2dlci5pbmZvKHsgcmVxdWVzdElkLCBtYWtlcklkLCBjaGFpbklkOiByZXEucGFyYW1zLmNoYWluSWQgfSwgbWVzc2FnZSk7XHJcbiAgICAgICAgICAgIFJGUV9NQUtFUl9VUERBVEVfQ0xJRU5UX0VSUk9SLmxhYmVscyhtYWtlcklkKS5pbmMoKTtcclxuICAgICAgICAgICAgcmVzLnN0YXR1cyhIdHRwU3RhdHVzLkJBRF9SRVFVRVNUKS5zZW5kKHsgZXJyb3I6IG1lc3NhZ2UgfSk7XHJcbiAgICAgICAgICAgIHJldHVybjtcclxuICAgICAgICB9XHJcblxyXG4gICAgICAgIGNvbnN0IGNoYWluSWQgPSBOdW1iZXIocmVxLnBhcmFtcy5jaGFpbklkKTtcclxuICAgICAgICB0cnkge1xyXG4gICAgICAgICAgICB2YWxpZGF0ZVBhdGNoUGF5bG9hZE9yVGhyb3cocmVxLmJvZHkpO1xyXG4gICAgICAgIH0gY2F0Y2ggKHsgbWVzc2FnZSB9KSB7XHJcbiAgICAgICAgICAgIGxvZ2dlci5pbmZvKHsgcmVxdWVzdElkLCBtYWtlcklkLCBjaGFpbklkIH0sIG1lc3NhZ2UpO1xyXG4gICAgICAgICAgICBSRlFfTUFLRVJfVVBEQVRFX0NMSUVOVF9FUlJPUi5sYWJlbHMobWFrZXJJZCkuaW5jKCk7XHJcbiAgICAgICAgICAgIHJlcy5zdGF0dXMoSHR0cFN0YXR1cy5CQURfUkVRVUVTVCkuc2VuZCh7IGVycm9yOiBtZXNzYWdlIH0pO1xyXG4gICAgICAgICAgICByZXR1cm47XHJcbiAgICAgICAgfVxyXG5cclxuICAgICAgICB0cnkge1xyXG4gICAgICAgICAgICBjb25zdCBwYWlycyA9IHJlcS5ib2R5LnBhaXJzO1xyXG4gICAgICAgICAgICBjb25zdCByZnF0VXJpID0gcmVxLmJvZHkucmZxdFVyaTtcclxuICAgICAgICAgICAgY29uc3QgcmZxbVVyaSA9IHJlcS5ib2R5LnJmcW1Vcmk7XHJcbiAgICAgICAgICAgIGNvbnN0IHJmcU1ha2VyOiBSZnFNYWtlciA9IGF3YWl0IHRoaXMuX3JmcU1ha2VyU2VydmljZS5wYXRjaFJmcU1ha2VyQXN5bmMoXHJcbiAgICAgICAgICAgICAgICBtYWtlcklkLFxyXG4gICAgICAgICAgICAgICAgY2hhaW5JZCxcclxuICAgICAgICAgICAgICAgIHBhaXJzICE9PSB1bmRlZmluZWQgPyBjb252ZXJ0VG9Mb3dlckNhc2UocGFpcnMpIDogdW5kZWZpbmVkLFxyXG4gICAgICAgICAgICAgICAgcmZxdFVyaSxcclxuICAgICAgICAgICAgICAgIHJmcW1VcmksXHJcbiAgICAgICAgICAgICk7XHJcbiAgICAgICAgICAgIHJlcy5zdGF0dXMoSHR0cFN0YXR1cy5PSykuc2VuZChyZnFNYWtlcik7XHJcbiAgICAgICAgICAgIGNvbnN0IHJmcW1NYWtlclVyaSA9IHJmcU1ha2VyLnJmcW1Vcmk7XHJcbiAgICAgICAgICAgIGxvZ2dlci5pbmZvKHsgcmVxdWVzdElkLCBtYWtlcklkLCBjaGFpbklkLCByZnFtTWFrZXJVcmkgfSwgJ1N1Y2Nlc3NmdWxseSBwYXRjaGVkIFJmcU1ha2VyIGVudGl0eS4nKTtcclxuICAgICAgICAgICAgUkZRX01BS0VSX1VQREFURV9TVUNDRUVELmxhYmVscyhtYWtlcklkKS5pbmMoKTtcclxuICAgICAgICB9IGNhdGNoIChlcnJvcikge1xyXG4gICAgICAgICAgICBjb25zdCBtZXNzYWdlID0gYEZhaWxlZCB0byBwYXRjaCBSZnFNYWtlciBlbnRpdHkuYDtcclxuICAgICAgICAgICAgbG9nZ2VyLmVycm9yKHsgcmVxdWVzdElkLCBtYWtlcklkLCBjaGFpbklkLCBlcnJvck1lc3NhZ2U6IGVycm9yLm1lc3NhZ2UgfSwgbWVzc2FnZSk7XHJcbiAgICAgICAgICAgIFJGUV9NQUtFUl9VUERBVEVfU0VWRVJfRVJST1IubGFiZWxzKG1ha2VySWQpLmluYygpO1xyXG4gICAgICAgICAgICByZXMuc3RhdHVzKEh0dHBTdGF0dXMuSU5URVJOQUxfU0VSVkVSX0VSUk9SKS5zZW5kKHsgbWVzc2FnZSB9KTtcclxuICAgICAgICB9XHJcbiAgICB9XHJcblxyXG4gICAgLyoqXHJcbiAgICAgKiBIYW5kbGVyIGZvciBHRVQgb3BlcmF0aW9uIG9mIHRoZSBgL21ha2VyL3YxL2NoYWluLWlkLzpjaGFpbklkYCBlbmRwb2ludC5cclxuICAgICAqL1xyXG4gICAgcHVibGljIGFzeW5jIGdldFJmcU1ha2VyQXN5bmMocmVxOiBleHByZXNzLlJlcXVlc3QsIHJlczogZXhwcmVzcy5SZXNwb25zZSk6IFByb21pc2U8dm9pZD4ge1xyXG4gICAgICAgIGNvbnN0IHJlcXVlc3RJZCA9IHJlcS5pZDtcclxuICAgICAgICBjb25zdCBtYWtlckFwaUtleSA9IHJlcS5oZWFkZXJzW1JGUV9NQUtFUl9BUElfS0VZX0hFQURFUl0gYXMgc3RyaW5nO1xyXG4gICAgICAgIGNvbnN0IG1ha2VySWQgPSB0aGlzLl9yZnFNYWtlclNlcnZpY2UubWFwTWFrZXJBcGlLZXlUb0lkKG1ha2VyQXBpS2V5KTtcclxuXHJcbiAgICAgICAgaWYgKG1ha2VySWQgPT09IG51bGwpIHtcclxuICAgICAgICAgICAgY29uc3QgbWVzc2FnZSA9IGBJbnZhbGlkIGFwaSBrZXkuYDtcclxuICAgICAgICAgICAgbG9nZ2VyLmluZm8oeyByZXF1ZXN0SWQsIGFwaUtleTogbWFrZXJBcGlLZXkgfSwgbWVzc2FnZSk7XHJcbiAgICAgICAgICAgIFJGUV9NQUtFUl9JTlZBTElEX0tFWS5pbmMoKTtcclxuICAgICAgICAgICAgcmVzLnN0YXR1cyhIdHRwU3RhdHVzLlVOQVVUSE9SSVpFRCkuc2VuZCh7IGVycm9yOiBtZXNzYWdlIH0pO1xyXG4gICAgICAgICAgICByZXR1cm47XHJcbiAgICAgICAgfVxyXG5cclxuICAgICAgICBpZiAoIVJmcU1ha2VyU2VydmljZS5pc1ZhbGlkQ2hhaW5JZChyZXEucGFyYW1zLmNoYWluSWQpKSB7XHJcbiAgICAgICAgICAgIGNvbnN0IG1lc3NhZ2UgPSBgSW52YWxpZCBjaGFpbklkLmA7XHJcbiAgICAgICAgICAgIGxvZ2dlci5pbmZvKHsgcmVxdWVzdElkLCBtYWtlcklkLCBjaGFpbklkOiByZXEucGFyYW1zLmNoYWluSWQgfSwgbWVzc2FnZSk7XHJcbiAgICAgICAgICAgIFJGUV9NQUtFUl9HRVRfQ0xJRU5UX0VSUk9SLmxhYmVscyhtYWtlcklkKS5pbmMoKTtcclxuICAgICAgICAgICAgcmVzLnN0YXR1cyhIdHRwU3RhdHVzLkJBRF9SRVFVRVNUKS5zZW5kKHsgZXJyb3I6IG1lc3NhZ2UgfSk7XHJcbiAgICAgICAgICAgIHJldHVybjtcclxuICAgICAgICB9XHJcblxyXG4gICAgICAgIGNvbnN0IGNoYWluSWQgPSBOdW1iZXIocmVxLnBhcmFtcy5jaGFpbklkKTtcclxuXHJcbiAgICAgICAgdHJ5IHtcclxuICAgICAgICAgICAgY29uc3QgcmZxTWFrZXI6IFJmcU1ha2VyID0gYXdhaXQgdGhpcy5fcmZxTWFrZXJTZXJ2aWNlLmdldFJmcU1ha2VyQXN5bmMobWFrZXJJZCwgY2hhaW5JZCk7XHJcbiAgICAgICAgICAgIHJlcy5zdGF0dXMoSHR0cFN0YXR1cy5PSykuc2VuZChyZnFNYWtlcik7XHJcbiAgICAgICAgICAgIGxvZ2dlci5pbmZvKHsgcmVxdWVzdElkLCBtYWtlcklkLCBjaGFpbklkIH0sICdTdWNjZXNzZnVsbHkgZ290IFJmcU1ha2VyIGVudGl0eS4nKTtcclxuICAgICAgICAgICAgUkZRX01BS0VSX0dFVF9TVUNDRUVELmxhYmVscyhtYWtlcklkKS5pbmMoKTtcclxuICAgICAgICB9IGNhdGNoIChlcnJvcikge1xyXG4gICAgICAgICAgICBjb25zdCBtZXNzYWdlID0gYEZhaWxlZCB0byBnZXQgUmZxTWFrZXIgZW50aXR5LmA7XHJcbiAgICAgICAgICAgIGxvZ2dlci5lcnJvcih7IHJlcXVlc3RJZCwgbWFrZXJJZCwgY2hhaW5JZCwgZXJyb3JNZXNzYWdlOiBlcnJvci5tZXNzYWdlIH0sIG1lc3NhZ2UpO1xyXG4gICAgICAgICAgICBSRlFfTUFLRVJfR0VUX1NFVkVSX0VSUk9SLmxhYmVscyhtYWtlcklkKS5pbmMoKTtcclxuICAgICAgICAgICAgcmVzLnN0YXR1cyhIdHRwU3RhdHVzLklOVEVSTkFMX1NFUlZFUl9FUlJPUikuc2VuZCh7IG1lc3NhZ2UgfSk7XHJcbiAgICAgICAgfVxyXG4gICAgfVxyXG59XHJcbiJdLCJ2ZXJzaW9uIjozfQ==