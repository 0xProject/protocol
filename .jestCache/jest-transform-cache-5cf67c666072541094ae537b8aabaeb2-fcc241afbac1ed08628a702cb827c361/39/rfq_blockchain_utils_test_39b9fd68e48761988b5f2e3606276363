1afd1917a87aabb2b6bc1ed2efab5c32
"use strict";
Object.defineProperty(exports, "__esModule", { value: true });
const utils_1 = require("@0x/utils");
const ethers_1 = require("ethers");
const ts_mockito_1 = require("ts-mockito");
const constants_1 = require("../../src/core/constants");
const eip712registry_1 = require("../../src/eip712registry");
const types_1 = require("../../src/core/types");
const balance_checker_1 = require("../../src/utils/balance_checker");
const Eip712Utils_1 = require("../../src/utils/Eip712Utils");
const rfq_blockchain_utils_1 = require("../../src/utils/rfq_blockchain_utils");
let supportedProvider;
let balancerChecker;
let ethersProvider;
let ethersWallet;
let rfqBlockchainUtils;
const ACCESS_LIST_ADDR_1 = '0xC02aaA39b223FE8D0A0e5C4F27eAD9083C756Cc2';
const STORAGE_KEY_1 = '0x0000000000000000000000000000000000000000000000000000000000000000';
const ACCESS_LIST_ADDR_2 = '0xA0b86991c6218b36c1d19D4a2e9Eb0cE3606eB48';
const STORAGE_KEY_2 = '0x3617319a054d772f909f7c479a2cebe5066e836a939412e32403c99029b92eff';
const CALLDATA = '0xd0e30db0';
const PROXY_ADDR = '0xdef1c0ded9bec7f1a1670819833240f027b25eff';
const FROM = '0xdef1c0ded9bec7f1a1670819833240f027b25ef1';
describe('RfqBlockchainUtils', () => {
    beforeEach(() => {
        supportedProvider = (0, ts_mockito_1.mock)();
        balancerChecker = (0, ts_mockito_1.mock)(balance_checker_1.BalanceChecker);
        ethersProvider = (0, ts_mockito_1.mock)(ethers_1.providers.JsonRpcProvider);
        ethersWallet = (0, ts_mockito_1.mock)(ethers_1.Wallet);
        rfqBlockchainUtils = new rfq_blockchain_utils_1.RfqBlockchainUtils((0, ts_mockito_1.instance)(supportedProvider), PROXY_ADDR, (0, ts_mockito_1.instance)(balancerChecker), (0, ts_mockito_1.instance)(ethersProvider), (0, ts_mockito_1.instance)(ethersWallet));
    });
    describe('createAccessListForAsync', () => {
        it('returns correct TxAccessListWithGas object', async () => {
            (0, ts_mockito_1.when)(ethersProvider.send((0, ts_mockito_1.anything)(), (0, ts_mockito_1.anything)())).thenResolve({
                accessList: [
                    {
                        address: ACCESS_LIST_ADDR_1,
                        storageKeys: [STORAGE_KEY_1],
                    },
                    {
                        address: ACCESS_LIST_ADDR_2,
                        storageKeys: [STORAGE_KEY_2],
                    },
                ],
                gasUsed: '0x651a',
            });
            expect(await rfqBlockchainUtils.createAccessListForAsync({ data: CALLDATA, from: FROM })).toEqual({
                accessList: {
                    [ACCESS_LIST_ADDR_1]: [STORAGE_KEY_1],
                    [ACCESS_LIST_ADDR_2]: [STORAGE_KEY_2],
                },
                gasEstimate: 25882,
            });
        });
        it('throws exception on failed eth_createAccessList RPC call', async () => {
            (0, ts_mockito_1.when)(ethersProvider.send((0, ts_mockito_1.anything)(), (0, ts_mockito_1.anything)())).thenReject(new Error('RPC error'));
            await expect(async () => {
                await rfqBlockchainUtils.createAccessListForAsync({ data: CALLDATA, from: FROM });
            }).rejects.toThrow('createAccessListForAsync');
        });
        it('throws exception on malformed RPC response', async () => {
            (0, ts_mockito_1.when)(ethersProvider.send((0, ts_mockito_1.anything)(), (0, ts_mockito_1.anything)())).thenResolve(1);
            await expect(async () => {
                await rfqBlockchainUtils.createAccessListForAsync({ data: CALLDATA, from: FROM });
            }).rejects.toThrow('createAccessListForAsync');
        });
    });
    describe('getGaslessApprovalAsync', () => {
        it('returns null if a token does not exist in EIP-712 registry', async () => {
            expect(await rfqBlockchainUtils.getGaslessApprovalAsync(12345, 'random', '0x1234')).toBeNull();
            expect(await rfqBlockchainUtils.getGaslessApprovalAsync(137, 'random', '0x1234')).toBeNull();
        });
        it('returns the correct approval object for executeMetaTransaction::approve', async () => {
            // Given
            const executeMetaTxToken = '0x9a71012b13ca4d3d0cdc72a177df3ef03b0e76a3'; // BAL
            const { domain } = eip712registry_1.EIP_712_REGISTRY[137][executeMetaTxToken];
            (0, ts_mockito_1.when)(ethersProvider._isProvider).thenReturn(true);
            const spiedBlockchainUtils = (0, ts_mockito_1.spy)(rfqBlockchainUtils);
            (0, ts_mockito_1.when)(spiedBlockchainUtils.getMetaTransactionNonceAsync((0, ts_mockito_1.anything)(), (0, ts_mockito_1.anything)())).thenResolve(new utils_1.BigNumber('0x1'));
            // When
            const approval = await rfqBlockchainUtils.getGaslessApprovalAsync(137, executeMetaTxToken, FROM);
            // Then
            expect(approval).toEqual({
                kind: types_1.GaslessApprovalTypes.ExecuteMetaTransaction,
                eip712: {
                    types: {
                        ...(0, Eip712Utils_1.extractEIP712DomainType)(domain),
                        ...constants_1.EXECUTE_META_TRANSACTION_EIP_712_TYPES,
                    },
                    primaryType: 'MetaTransaction',
                    domain,
                    message: {
                        nonce: 1,
                        from: FROM,
                        functionSignature: '0x095ea7b3000000000000000000000000def1c0ded9bec7f1a1670819833240f027b25effffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffff',
                    },
                },
            });
        });
        it('returns the correct approval object for permit', async () => {
            // Given
            const permitToken = '0x2791bca1f2de4661ed88a30c99a7a9449aa84174'; // USDC
            const { domain } = eip712registry_1.EIP_712_REGISTRY[137][permitToken];
            (0, ts_mockito_1.when)(ethersProvider._isProvider).thenReturn(true);
            const spiedBlockchainUtils = (0, ts_mockito_1.spy)(rfqBlockchainUtils);
            (0, ts_mockito_1.when)(spiedBlockchainUtils.getPermitNonceAsync((0, ts_mockito_1.anything)(), (0, ts_mockito_1.anything)())).thenResolve(new utils_1.BigNumber('0x1'));
            // When
            const approval = await rfqBlockchainUtils.getGaslessApprovalAsync(137, permitToken, FROM, 0);
            // Then
            expect(approval).toEqual({
                kind: types_1.GaslessApprovalTypes.Permit,
                eip712: {
                    types: {
                        ...(0, Eip712Utils_1.extractEIP712DomainType)(domain),
                        ...constants_1.PERMIT_EIP_712_TYPES,
                    },
                    primaryType: 'Permit',
                    domain,
                    message: {
                        owner: FROM,
                        spender: PROXY_ADDR,
                        value: '115792089237316195423570985008687907853269984665640564039457584007913129639935',
                        nonce: 1,
                        deadline: '600', // 10 minutes from 0
                    },
                },
            });
        });
    });
});
//# sourceMappingURL=data:application/json;charset=utf-8;base64,eyJmaWxlIjoiL1VzZXJzL2Rhdmlkd2Fsc2gvY29kZS1sb2NhbC8weC1yZnEtYXBpL3Rlc3QvdXRpbHMvcmZxX2Jsb2NrY2hhaW5fdXRpbHNfdGVzdC50cyIsIm1hcHBpbmdzIjoiOztBQUVBLHFDQUFzQztBQUN0QyxtQ0FBMkM7QUFDM0MsMkNBQWlFO0FBRWpFLHdEQUF3RztBQUN4Ryw2REFBNEQ7QUFDNUQsZ0RBQTREO0FBQzVELHFFQUFpRTtBQUNqRSw2REFBc0U7QUFDdEUsK0VBQTBFO0FBRTFFLElBQUksaUJBQW9DLENBQUM7QUFDekMsSUFBSSxlQUErQixDQUFDO0FBQ3BDLElBQUksY0FBeUMsQ0FBQztBQUM5QyxJQUFJLFlBQW9CLENBQUM7QUFDekIsSUFBSSxrQkFBc0MsQ0FBQztBQUUzQyxNQUFNLGtCQUFrQixHQUFHLDRDQUE0QyxDQUFDO0FBQ3hFLE1BQU0sYUFBYSxHQUFHLG9FQUFvRSxDQUFDO0FBQzNGLE1BQU0sa0JBQWtCLEdBQUcsNENBQTRDLENBQUM7QUFDeEUsTUFBTSxhQUFhLEdBQUcsb0VBQW9FLENBQUM7QUFDM0YsTUFBTSxRQUFRLEdBQUcsWUFBWSxDQUFDO0FBQzlCLE1BQU0sVUFBVSxHQUFHLDRDQUE0QyxDQUFDO0FBQ2hFLE1BQU0sSUFBSSxHQUFHLDRDQUE0QyxDQUFDO0FBRTFELFFBQVEsQ0FBQyxvQkFBb0IsRUFBRSxHQUFHLEVBQUU7SUFDaEMsVUFBVSxDQUFDLEdBQUcsRUFBRTtRQUNaLGlCQUFpQixHQUFHLElBQUEsaUJBQUksR0FBcUIsQ0FBQztRQUM5QyxlQUFlLEdBQUcsSUFBQSxpQkFBSSxFQUFDLGdDQUFjLENBQUMsQ0FBQztRQUN2QyxjQUFjLEdBQUcsSUFBQSxpQkFBSSxFQUFDLGtCQUFTLENBQUMsZUFBZSxDQUFDLENBQUM7UUFDakQsWUFBWSxHQUFHLElBQUEsaUJBQUksRUFBQyxlQUFNLENBQUMsQ0FBQztRQUM1QixrQkFBa0IsR0FBRyxJQUFJLHlDQUFrQixDQUN2QyxJQUFBLHFCQUFRLEVBQUMsaUJBQWlCLENBQUMsRUFDM0IsVUFBVSxFQUNW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S0FBSyxFQUFFLENBQUM7d0JBQ1IsUUFBUSxFQUFFLEtBQUssRUFBRSxvQkFBb0I7cUJBQ3hDO2lCQUNKO2FBQ0osQ0FBQyxDQUFDO1FBQ1AsQ0FBQyxDQUFDLENBQUM7SUFDUCxDQUFDLENBQUMsQ0FBQztBQUNQLENBQUMsQ0FBQyxDQUFDIiwibmFtZXMiOltdLCJzb3VyY2VzIjpbIi9Vc2Vycy9kYXZpZHdhbHNoL2NvZGUtbG9jYWwvMHgtcmZxLWFwaS90ZXN0L3V0aWxzL3JmcV9ibG9ja2NoYWluX3V0aWxzX3Rlc3QudHMiXSwic291cmNlc0NvbnRlbnQiOlsiLy8gdHNsaW50OmRpc2FibGU6Y3VzdG9tLW5vLW1hZ2ljLW51bWJlcnMgbm8tdW51c2VkLWV4cHJlc3Npb25cbmltcG9ydCB7IFN1cHBvcnRlZFByb3ZpZGVyIH0gZnJvbSAnQDB4L3N1YnByb3ZpZGVycyc7XG5pbXBvcnQgeyBCaWdOdW1iZXIgfSBmcm9tICdAMHgvdXRpbHMnO1xuaW1wb3J0IHsgcHJvdmlkZXJzLCBXYWxsZXQgfSBmcm9tICdldGhlcnMnO1xuaW1wb3J0IHsgYW55dGhpbmcsIGluc3RhbmNlLCBtb2NrLCBzcHksIHdoZW4gfSBmcm9tICd0cy1tb2NraXRvJztcblxuaW1wb3J0IHsgRVhFQ1VURV9NRVRBX1RSQU5TQUNUSU9OX0VJUF83MTJfVFlQRVMsIFBFUk1JVF9FSVBfNzEyX1RZUEVTIH0gZnJvbSAnLi4vLi4vc3JjL2NvcmUvY29uc3RhbnRzJztcbmltcG9ydCB7IEVJUF83MTJfUkVHSVNUUlkgfSBmcm9tICcuLi8uLi9zcmMvZWlwNzEycmVnaXN0cnknO1xuaW1wb3J0IHsgR2FzbGVzc0FwcHJvdmFsVHlwZXMgfSBmcm9tICcuLi8uLi9zcmMvY29yZS90eXBlcyc7XG5pbXBvcnQgeyBCYWxhbmNlQ2hlY2tlciB9IGZyb20gJy4uLy4uL3NyYy91dGlscy9iYWxhbmNlX2NoZWNrZXInO1xuaW1wb3J0IHsgZXh0cmFjdEVJUDcxMkRvbWFpblR5cGUgfSBmcm9tICcuLi8uLi9zcmMvdXRpbHMvRWlwNzEyVXRpbHMnO1xuaW1wb3J0IHsgUmZxQmxvY2tjaGFpblV0aWxzIH0gZnJvbSAnLi4vLi4vc3JjL3V0aWxzL3JmcV9ibG9ja2NoYWluX3V0aWxzJztcblxubGV0IHN1cHBvcnRlZFByb3ZpZGVyOiBTdXBwb3J0ZWRQcm92aWRlcjtcbmxldCBiYWxhbmNlckNoZWNrZXI6IEJhbGFuY2VDaGVja2VyO1xubGV0IGV0aGVyc1Byb3ZpZGVyOiBwcm92aWRlcnMuSnNvblJwY1Byb3ZpZGVyO1xubGV0IGV0aGVyc1dhbGxldDogV2FsbGV0O1xubGV0IHJmcUJsb2NrY2hhaW5VdGlsczogUmZxQmxvY2tjaGFpblV0aWxzO1xuXG5jb25zdCBBQ0NFU1NfTElTVF9BRERSXzEgPSAnMHhDMDJhYUEzOWIyMjNGRThEMEEwZTVDNEYyN2VBRDkwODNDNzU2Q2MyJztcbmNvbnN0IFNUT1JBR0VfS0VZXzEgPSAnMHgwMDAwMDAwMDAwMDAwMDAwMDAwMDAwMDAwMDAwMDAwMDAwMDAwMDAwMDAwMDAwMDAwMDAwMDAwMDAwMDAwMDAwJztcbmNvbnN0IEFDQ0VTU19MSVNUX0FERFJfMiA9ICcweEEwYjg2OTkxYzYyMThiMzZjMWQxOUQ0YTJlOUViMGNFMzYwNmVCNDgnO1xuY29uc3QgU1RPUkFHRV9LRVlfMiA9ICcweDM2MTczMTlhMDU0ZDc3MmY5MDlmN2M0NzlhMmNlYmU1MDY2ZTgzNmE5Mzk0MTJlMzI0MDNjOTkwMjliOTJlZmYnO1xuY29uc3QgQ0FMTERBVEEgPSAnMHhkMGUzMGRiMCc7XG5jb25zdCBQUk9YWV9BRERSID0gJzB4ZGVmMWMwZGVkOWJlYzdmMWExNjcwODE5ODMzMjQwZjAyN2IyNWVmZic7XG5jb25zdCBGUk9NID0gJzB4ZGVmMWMwZGVkOWJlYzdmMWExNjcwODE5ODMzMjQwZjAyN2IyNWVmMSc7XG5cbmRlc2NyaWJlKCdSZnFCbG9ja2NoYWluVXRpbHMnLCAoKSA9PiB7XG4gICAgYmVmb3JlRWFjaCgoKSA9PiB7XG4gICAgICAgIHN1cHBvcnRlZFByb3ZpZGVyID0gbW9jazxTdXBwb3J0ZWRQcm92aWRlcj4oKTtcbiAgICAgICAgYmFsYW5jZXJDaGVja2VyID0gbW9jayhCYWxhbmNlQ2hlY2tlcik7XG4gICAgICAgIGV0aGVyc1Byb3ZpZGVyID0gbW9jayhwcm92aWRlcnMuSnNvblJwY1Byb3ZpZGVyKTtcbiAgICAgICAgZXRoZXJzV2FsbGV0ID0gbW9jayhXYWxsZXQpO1xuICAgICAgICByZnFCbG9ja2NoYWluVXRpbHMgPSBuZXcgUmZxQmxvY2tjaGFpblV0aWxzKFxuICAgICAgICAgICAgaW5zdGFuY2Uoc3VwcG9ydGVkUHJvdmlkZXIpLFxuICAgICAgICAgICAgUFJPWFlfQUREUixcbiAgICAgICAgICAgIGluc3RhbmNlKGJhbGFuY2VyQ2hlY2tlciksXG4gICAgICAgICAgICBpbnN0YW5jZShldGhlcnNQcm92aWRlciksXG4gICAgICAgICAgICBpbnN0YW5jZShldGhlcnNXYWxsZXQpLFxuICAgICAgICApO1xuICAgIH0pO1xuXG4gICAgZGVzY3JpYmUoJ2NyZWF0ZUFjY2Vzc0xpc3RGb3JBc3luYycsICgpID0+IHtcbiAgICAgICAgaXQoJ3JldHVybnMgY29ycmVjdCBUeEFjY2Vzc0xpc3RXaXRoR2FzIG9iamVjdCcsIGFzeW5jICgpID0+IHtcbiAgICAgICAgICAgIHdoZW4oZXRoZXJzUHJvdmlkZXIuc2VuZChhbnl0aGluZygpLCBhbnl0aGluZygpKSkudGhlblJlc29sdmUoe1xuICAgICAgICAgICAgICAgIGFjY2Vzc0xpc3Q6IFtcbiAgICAgICAgICAgICAgICAgICAge1xuICAgICAgICAgICAgICAgICAgICAgICAgYWRkcmVzczogQUNDRVNTX0xJU1RfQUREUl8xLFxuICAgICAgICAgICAgICAgICAgICAgICAgc3RvcmFnZUtleXM6IFtTVE9SQUdFX0tFWV8xXSxcbiAgICAgICAgICAgICAgICAgICAgfSxcbiAgICAgICAgICAgICAgICAgICAge1xuICAgICAgICAgICAgICAgICAgICAgICAgYWRkcmVzczogQUNDRVNTX0xJU1RfQUREUl8yLFxuICAgICAgICAgICAgICAgICAgICAgICAgc3RvcmFnZUtleXM6IFtTVE9SQUdFX0tFWV8yXSxcbiAgICAgICAgICAgICAgICAgICAgfSxcbiAgICAgICAgICAgICAgICBdLFxuICAgICAgICAgICAgICAgIGdhc1VzZWQ6ICcweDY1MWEnLFxuICAgICAgICAgICAgfSk7XG5cbiAgICAgICAgICAgIGV4cGVjdChhd2FpdCByZnFCbG9ja2NoYWluVXRpbHMuY3JlYXRlQWNjZXNzTGlzdEZvckFzeW5jKHsgZGF0YTogQ0FMTERBVEEsIGZyb206IEZST00gfSkpLnRvRXF1YWwoe1xuICAgICAgICAgICAgICAgIGFjY2Vzc0xpc3Q6IHtcbiAgICAgICAgICAgICAgICAgICAgW0FDQ0VTU19MSVNUX0FERFJfMV06IFtTVE9SQUdFX0tFWV8xXSxcbiAgICAgICAgICAgICAgICAgICAgW0FDQ0VTU19MSVNUX0FERFJfMl06IFtTVE9SQUdFX0tFWV8yXSxcbiAgICAgICAgICAgICAgICB9LFxuICAgICAgICAgICAgICAgIGdhc0VzdGltYXRlOiAyNTg4MixcbiAgICAgICAgICAgIH0pO1xuICAgICAgICB9KTtcblxuICAgICAgICBpdCgndGhyb3dzIGV4Y2VwdGlvbiBvbiBmYWlsZWQgZXRoX2NyZWF0ZUFjY2Vzc0xpc3QgUlBDIGNhbGwnLCBhc3luYyAoKSA9PiB7XG4gICAgICAgICAgICB3aGVuKGV0aGVyc1Byb3ZpZGVyLnNlbmQoYW55dGhpbmcoKSwgYW55dGhpbmcoKSkpLnRoZW5SZWplY3QobmV3IEVycm9yKCdSUEMgZXJyb3InKSk7XG5cbiAgICAgICAgICAgIGF3YWl0IGV4cGVjdChhc3luYyAoKSA9PiB7XG4gICAgICAgICAgICAgICAgYXdhaXQgcmZxQmxvY2tjaGFpblV0aWxzLmNyZWF0ZUFjY2Vzc0xpc3RGb3JBc3luYyh7IGRhdGE6IENBTExEQVRBLCBmcm9tOiBGUk9NIH0pO1xuICAgICAgICAgICAgfSkucmVqZWN0cy50b1Rocm93KCdjcmVhdGVBY2Nlc3NMaXN0Rm9yQXN5bmMnKTtcbiAgICAgICAgfSk7XG5cbiAgICAgICAgaXQoJ3Rocm93cyBleGNlcHRpb24gb24gbWFsZm9ybWVkIFJQQyByZXNwb25zZScsIGFzeW5jICgpID0+IHtcbiAgICAgICAgICAgIHdoZW4oZXRoZXJzUHJvdmlkZXIuc2VuZChhbnl0aGluZygpLCBhbnl0aGluZygpKSkudGhlblJlc29sdmUoMSk7XG5cbiAgICAgICAgICAgIGF3YWl0IGV4cGVjdChhc3luYyAoKSA9PiB7XG4gICAgICAgICAgICAgICAgYXdhaXQgcmZxQmxvY2tjaGFpblV0aWxzLmNyZWF0ZUFjY2Vzc0xpc3RGb3JBc3luYyh7IGRhdGE6IENBTExEQVRBLCBmcm9tOiBGUk9NIH0pO1xuICAgICAgICAgICAgfSkucmVqZWN0cy50b1Rocm93KCdjcmVhdGVBY2Nlc3NMaXN0Rm9yQXN5bmMnKTtcbiAgICAgICAgfSk7XG4gICAgfSk7XG5cbiAgICBkZXNjcmliZSgnZ2V0R2FzbGVzc0FwcHJvdmFsQXN5bmMnLCAoKSA9PiB7XG4gICAgICAgIGl0KCdyZXR1cm5zIG51bGwgaWYgYSB0b2tlbiBkb2VzIG5vdCBleGlzdCBpbiBFSVAtNzEyIHJlZ2lzdHJ5JywgYXN5bmMgKCkgPT4ge1xuICAgICAgICAgICAgZXhwZWN0KGF3YWl0IHJmcUJsb2NrY2hhaW5VdGlscy5nZXRHYXNsZXNzQXBwcm92YWxBc3luYygxMjM0NSwgJ3JhbmRvbScsICcweDEyMzQnKSkudG9CZU51bGwoKTtcbiAgICAgICAgICAgIGV4cGVjdChhd2FpdCByZnFCbG9ja2NoYWluVXRpbHMuZ2V0R2FzbGVzc0FwcHJvdmFsQXN5bmMoMTM3LCAncmFuZG9tJywgJzB4MTIzNCcpKS50b0JlTnVsbCgpO1xuICAgICAgICB9KTtcblxuICAgICAgICBpdCgncmV0dXJucyB0aGUgY29ycmVjdCBhcHByb3ZhbCBvYmplY3QgZm9yIGV4ZWN1dGVNZXRhVHJhbnNhY3Rpb246OmFwcHJvdmUnLCBhc3luYyAoKSA9PiB7XG4gICAgICAgICAgICAvLyBHaXZlblxuICAgICAgICAgICAgY29uc3QgZXhlY3V0ZU1ldGFUeFRva2VuID0gJzB4OWE3MTAxMmIxM2NhNGQzZDBjZGM3MmExNzdkZjNlZjAzYjBlNzZhMyc7IC8vIEJBTFxuICAgICAgICAgICAgY29uc3QgeyBkb21haW4gfSA9IEVJUF83MTJfUkVHSVNUUllbMTM3XVtleGVjdXRlTWV0YVR4VG9rZW5dO1xuICAgICAgICAgICAgd2hlbihldGhlcnNQcm92aWRlci5faXNQcm92aWRlcikudGhlblJldHVybih0cnVlKTtcbiAgICAgICAgICAgIGNvbnN0IHNwaWVkQmxvY2tjaGFpblV0aWxzID0gc3B5KHJmcUJsb2NrY2hhaW5VdGlscyk7XG4gICAgICAgICAgICB3aGVuKHNwaWVkQmxvY2tjaGFpblV0aWxzLmdldE1ldGFUcmFuc2FjdGlvbk5vbmNlQXN5bmMoYW55dGhpbmcoKSwgYW55dGhpbmcoKSkpLnRoZW5SZXNvbHZlKFxuICAgICAgICAgICAgICAgIG5ldyBCaWdOdW1iZXIoJzB4MScpLFxuICAgICAgICAgICAgKTtcblxuICAgICAgICAgICAgLy8gV2hlblxuICAgICAgICAgICAgY29uc3QgYXBwcm92YWwgPSBhd2FpdCByZnFCbG9ja2NoYWluVXRpbHMuZ2V0R2FzbGVzc0FwcHJvdmFsQXN5bmMoMTM3LCBleGVjdXRlTWV0YVR4VG9rZW4sIEZST00pO1xuXG4gICAgICAgICAgICAvLyBUaGVuXG4gICAgICAgICAgICBleHBlY3QoYXBwcm92YWwpLnRvRXF1YWwoe1xuICAgICAgICAgICAgICAgIGtpbmQ6IEdhc2xlc3NBcHByb3ZhbFR5cGVzLkV4ZWN1dGVNZXRhVHJhbnNhY3Rpb24sXG4gICAgICAgICAgICAgICAgZWlwNzEyOiB7XG4gICAgICAgICAgICAgICAgICAgIHR5cGVzOiB7XG4gICAgICAgICAgICAgICAgICAgICAgICAuLi5leHRyYWN0RUlQNzEyRG9tYWluVHlwZShkb21haW4pLFxuICAgICAgICAgICAgICAgICAgICAgICAgLi4uRVhFQ1VURV9NRVRBX1RSQU5TQUNUSU9OX0VJUF83MTJfVFlQRVMsXG4gICAgICAgICAgICAgICAgICAgIH0sXG4gICAgICAgICAgICAgICAgICAgIHByaW1hcnlUeXBlOiAnTWV0YVRyYW5zYWN0aW9uJyxcbiAgICAgICAgICAgICAgICAgICAgZG9tYWluLFxuICAgICAgICAgICAgICAgICAgICBtZXNzYWdlOiB7XG4gICAgICAgICAgICAgICAgICAgICAgICBub25jZTogMSxcbiAgICAgICAgICAgICAgICAgICAgICAgIGZyb206IEZST00sXG4gICAgICAgICAgICAgICAgICAgICAgICBmdW5jdGlvblNpZ25hdHVyZTpcbiAgICAgICAgICAgICAgICAgICAgICAgICAgICAnMHgwOTVlYTdiMzAwMDAwMDAwMDAwMDAwMDAwMDAwMDAwMGRlZjFjMGRlZDliZWM3ZjFhMTY3MDgxOTgzMzI0MGYwMjdiMjVlZmZmZmZmZmZmZmZmZmZmZmZmZmZmZmZmZmZmZmZmZmZmZmZmZmZmZmZmZmZmZmZmZmZmZmZmZmZmZmZmZmZmZmZmJyxcbiAgICAgICAgICAgICAgICAgICAgfSxcbiAgICAgICAgICAgICAgICB9LFxuICAgICAgICAgICAgfSk7XG4gICAgICAgIH0pO1xuXG4gICAgICAgIGl0KCdyZXR1cm5zIHRoZSBjb3JyZWN0IGFwcHJvdmFsIG9iamVjdCBmb3IgcGVybWl0JywgYXN5bmMgKCkgPT4ge1xuICAgICAgICAgICAgLy8gR2l2ZW5cbiAgICAgICAgICAgIGNvbnN0IHBlcm1pdFRva2VuID0gJzB4Mjc5MWJjYTFmMmRlNDY2MWVkODhhMzBjOTlhN2E5NDQ5YWE4NDE3NCc7IC8vIFVTRENcbiAgICAgICAgICAgIGNvbnN0IHsgZG9tYWluIH0gPSBFSVBfNzEyX1JFR0lTVFJZWzEzN11bcGVybWl0VG9rZW5dO1xuICAgICAgICAgICAgd2hlbihldGhlcnNQcm92aWRlci5faXNQcm92aWRlcikudGhlblJldHVybih0cnVlKTtcbiAgICAgICAgICAgIGNvbnN0IHNwaWVkQmxvY2tjaGFpblV0aWxzID0gc3B5KHJmcUJsb2NrY2hhaW5VdGlscyk7XG4gICAgICAgICAgICB3aGVuKHNwaWVkQmxvY2tjaGFpblV0aWxzLmdldFBlcm1pdE5vbmNlQXN5bmMoYW55dGhpbmcoKSwgYW55dGhpbmcoKSkpLnRoZW5SZXNvbHZlKG5ldyBCaWdOdW1iZXIoJzB4MScpKTtcblxuICAgICAgICAgICAgLy8gV2hlblxuICAgICAgICAgICAgY29uc3QgYXBwcm92YWwgPSBhd2FpdCByZnFCbG9ja2NoYWluVXRpbHMuZ2V0R2FzbGVzc0FwcHJvdmFsQXN5bmMoMTM3LCBwZXJtaXRUb2tlbiwgRlJPTSwgMCk7XG5cbiAgICAgICAgICAgIC8vIFRoZW5cbiAgICAgICAgICAgIGV4cGVjdChhcHByb3ZhbCkudG9FcXVhbCh7XG4gICAgICAgICAgICAgICAga2luZDogR2FzbGVzc0FwcHJvdmFsVHlwZXMuUGVybWl0LFxuICAgICAgICAgICAgICAgIGVpcDcxMjoge1xuICAgICAgICAgICAgICAgICAgICB0eXBlczoge1xuICAgICAgICAgICAgICAgICAgICAgICAgLi4uZXh0cmFjdEVJUDcxMkRvbWFpblR5cGUoZG9tYWluKSxcbiAgICAgICAgICAgICAgICAgICAgICAgIC4uLlBFUk1JVF9FSVBfNzEyX1RZUEVTLFxuICAgICAgICAgICAgICAgICAgICB9LFxuICAgICAgICAgICAgICAgICAgICBwcmltYXJ5VHlwZTogJ1Blcm1pdCcsXG4gICAgICAgICAgICAgICAgICAgIGRvbWFpbixcbiAgICAgICAgICAgICAgICAgICAgbWVzc2FnZToge1xuICAgICAgICAgICAgICAgICAgICAgICAgb3duZXI6IEZST00sXG4gICAgICAgICAgICAgICAgICAgICAgICBzcGVuZGVyOiBQUk9YWV9BRERSLFxuICAgICAgICAgICAgICAgICAgICAgICAgdmFsdWU6ICcxMTU3OTIwODkyMzczMTYxOTU0MjM1NzA5ODUwMDg2ODc5MDc4NTMyNjk5ODQ2NjU2NDA1NjQwMzk0NTc1ODQwMDc5MTMxMjk2Mzk5MzUnLCAvLyBpbmZpbml0ZSBhcHByb3ZhbFxuICAgICAgICAgICAgICAgICAgICAgICAgbm9uY2U6IDEsXG4gICAgICAgICAgICAgICAgICAgICAgICBkZWFkbGluZTogJzYwMCcsIC8vIDEwIG1pbnV0ZXMgZnJvbSAwXG4gICAgICAgICAgICAgICAgICAgIH0sXG4gICAgICAgICAgICAgICAgfSxcbiAgICAgICAgICAgIH0pO1xuICAgICAgICB9KTtcbiAgICB9KTtcbn0pO1xuIl0sInZlcnNpb24iOjN9