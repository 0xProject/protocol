e92daa6988b5ab1fcf46539e07c36bd3
"use strict";
Object.defineProperty(exports, "__esModule", { value: true });
// tslint:disable custom-no-magic-numbers
const utils_1 = require("@0x/utils");
const chai_1 = require("chai");
const sqs_producer_1 = require("sqs-producer");
const ts_mockito_1 = require("ts-mockito");
const constants_1 = require("../../src/core/constants");
const entities_1 = require("../../src/entities");
const rfqm_health_check_1 = require("../../src/utils/rfqm_health_check");
let producerMock;
const MS_IN_MINUTE = 60000;
const fullBalance = new utils_1.BigNumber(1).shiftedBy(constants_1.ETH_DECIMALS);
describe('RFQm Health Check', () => {
    describe('checkSqsQueueAsync', () => {
        beforeEach(() => {
            producerMock = (0, ts_mockito_1.mock)(sqs_producer_1.Producer);
        });
        describe('queue size check', () => {
            it('creates no issues if there are 10 or less jobs in the queue', async () => {
                (0, ts_mockito_1.when)(producerMock.queueSize()).thenResolve(1);
                const issues = await (0, rfqm_health_check_1.checkSqsQueueAsync)((0, ts_mockito_1.instance)(producerMock));
                (0, chai_1.expect)(issues).to.have.length(0);
            });
            it('creates a DEGRADED issue if there are more than 5 messages in the queue', async () => {
                (0, ts_mockito_1.when)(producerMock.queueSize()).thenResolve(11);
                const issues = await (0, rfqm_health_check_1.checkSqsQueueAsync)((0, ts_mockito_1.instance)(producerMock));
                (0, chai_1.expect)(issues).to.have.length(1);
                (0, chai_1.expect)(issues[0].status).to.equal(rfqm_health_check_1.HealthCheckStatus.Degraded);
            });
            it('creates a FAILED issue if there are more than 20 messages in the queue', async () => {
                (0, ts_mockito_1.when)(producerMock.queueSize()).thenResolve(21);
                const issues = await (0, rfqm_health_check_1.checkSqsQueueAsync)((0, ts_mockito_1.instance)(producerMock));
                (0, chai_1.expect)(issues).to.have.length(1);
                (0, chai_1.expect)(issues[0].status).to.equal(rfqm_health_check_1.HealthCheckStatus.Failed);
            });
        });
    });
    describe('checkWorkerHeartbeatsAsync', () => {
        it('creates a failed issue when no heartbeats are found', async () => {
            const issues = await (0, rfqm_health_check_1.checkWorkerHeartbeatsAsync)([]);
            (0, chai_1.expect)(issues).to.have.length(1);
            (0, chai_1.expect)(issues[0].status).to.equal(rfqm_health_check_1.HealthCheckStatus.Failed);
        });
        describe('Heartbeat age', () => {
            it('creates a failed issue with no recent heartbeats', async () => {
                const now = new Date();
                const nowTime = now.getTime();
                const heartbeat = new entities_1.RfqmWorkerHeartbeatEntity({
                    address: '0x00',
                    balance: fullBalance,
                    index: 0,
                    timestamp: new Date(nowTime - MS_IN_MINUTE * 6),
                    chainId: 1337,
                });
                const issues = await (0, rfqm_health_check_1.checkWorkerHeartbeatsAsync)([heartbeat], now);
                const failedIssues = issues.filter(({ status }) => status === rfqm_health_check_1.HealthCheckStatus.Failed);
                (0, chai_1.expect)(failedIssues).to.have.length(1);
            });
            it('creates degraded issues for stale heartbeats', async () => {
                const now = new Date();
                const nowTime = now.getTime();
                const heartbeat1 = new entities_1.RfqmWorkerHeartbeatEntity({
                    address: '0x00',
                    balance: fullBalance,
                    index: 0,
                    timestamp: now,
                    chainId: 1337,
                });
                const heartbeat2 = new entities_1.RfqmWorkerHeartbeatEntity({
                    address: '0x01',
                    balance: fullBalance,
                    index: 1,
                    timestamp: new Date(nowTime - MS_IN_MINUTE * 8),
                    chainId: 1337,
                });
                const issues = await (0, rfqm_health_check_1.checkWorkerHeartbeatsAsync)([heartbeat1, heartbeat2], now);
                const failedIssues = issues.filter(({ status }) => status === rfqm_health_check_1.HealthCheckStatus.Failed);
                (0, chai_1.expect)(failedIssues).to.have.length(0);
                const degradedIssues = issues.filter(({ status }) => status === rfqm_health_check_1.HealthCheckStatus.Degraded);
                (0, chai_1.expect)(degradedIssues).to.have.length(1);
                (0, chai_1.expect)(degradedIssues[0].description).to.contain('0x01');
            });
        });
        describe('Worker balance', () => {
            it('creates a failed issue when no worker has a balance above the failed threshold', async () => {
                const now = new Date();
                const heartbeat = new entities_1.RfqmWorkerHeartbeatEntity({
                    address: '0x00',
                    balance: new utils_1.BigNumber(0.01),
                    index: 0,
                    timestamp: now,
                    chainId: 1337,
                });
                const issues = await (0, rfqm_health_check_1.checkWorkerHeartbeatsAsync)([heartbeat], now);
                const failedIssues = issues.filter(({ status }) => status === rfqm_health_check_1.HealthCheckStatus.Failed);
                (0, chai_1.expect)(failedIssues).to.have.length(1);
            });
            it('creates degraded issues for low worker balances', async () => {
                const now = new Date();
                const heartbeat1 = new entities_1.RfqmWorkerHeartbeatEntity({
                    address: '0x00',
                    balance: new utils_1.BigNumber(0.01),
                    index: 0,
                    timestamp: now,
                    chainId: 1337,
                });
                const heartbeat2 = new entities_1.RfqmWorkerHeartbeatEntity({
                    address: '0x01',
                    balance: fullBalance,
                    index: 1,
                    timestamp: now,
                    chainId: 1337,
                });
                const issues = await (0, rfqm_health_check_1.checkWorkerHeartbeatsAsync)([heartbeat1, heartbeat2], now);
                const failedIssues = issues.filter(({ status }) => status === rfqm_health_check_1.HealthCheckStatus.Failed);
                (0, chai_1.expect)(failedIssues).to.have.length(0);
                const degradedIssues = issues.filter(({ status }) => status === rfqm_health_check_1.HealthCheckStatus.Degraded);
                (0, chai_1.expect)(degradedIssues).to.have.length(1);
                (0, chai_1.expect)(degradedIssues[0].description).to.contain('Less than two workers have a balance above the degraded threshold');
            });
        });
    });
    describe('getHttpIssues', () => {
        it('goes into maintainence mode', async () => {
            const issues = (0, rfqm_health_check_1.getHttpIssues)(/* isMaintainenceMode */ true);
            (0, chai_1.expect)(issues[0].status).to.equal(rfqm_health_check_1.HealthCheckStatus.Maintenance);
        });
    });
});
//# sourceMappingURL=data:application/json;charset=utf-8;base64,eyJmaWxlIjoiL1VzZXJzL2Rhdmlkd2Fsc2gvY29kZS1sb2NhbC8weC1yZnEtYXBpL3Rlc3QvdXRpbHMvcmZxbV9oZWFsdGhfY2hlY2tfdGVzdC50cyIsIm1hcHBpbmdzIjoiOztBQUFBLHlDQUF5QztBQUN6QyxxQ0FBc0M7QUFDdEMsK0JBQThCO0FBQzlCLCtDQUF3QztBQUN4QywyQ0FBa0Q7QUFFbEQsd0RBQXdEO0FBQ3hELGlEQUErRDtBQUMvRCx5RUFLMkM7QUFFM0MsSUFBSSxZQUFzQixDQUFDO0FBRTNCLE1BQU0sWUFBWSxHQUFHLEtBQUssQ0FBQztBQUMzQixNQUFNLFdBQVcsR0FBRyxJQUFJLGlCQUFTLENBQUMsQ0FBQyxDQUFDLENBQUMsU0FBUyxDQUFDLHdCQUFZLENBQUMsQ0FBQztBQUU3RCxRQUFRLENBQUMsbUJBQW1CLEVBQUUsR0FBRyxFQUFFO0lBQy9CLFFBQVEsQ0FBQyxvQkFBb0IsRUFBRSxHQUFHLEVBQUU7UUFDaEMsVUFBVSxDQUFDLEdBQUcsRUFBRTtZQUNaLFlBQVksR0FBRyxJQUFBLGlCQUFJLEVBQUMsdUJBQVEsQ0FBQyxDQUFDO1FBQ2xDLENBQUMsQ0FBQyxDQUFDO1FBRUgsUUFBUSxDQUFDLGtCQUFrQixFQUFFLEdBQUcsRUFBRTtZQUM5QixFQUFFLENBQUMsNkRBQTZELEVBQUUsS0FBSyxJQUFJLEVBQUU7Z0JBQ3pFLElBQUEsaUJBQUksRUFBQyxZQUFZLENBQUMsU0FBUyxFQUFFLENBQUMsQ0FBQyxXQUFXLENBQUMsQ0FBQyxDQUFDLENBQUM7Z0JBRTlDLE1BQU0sTUFBTSxHQUFHLE1BQU0sSUFBQSxzQ0FBa0IsRUFBQyxJQUFBLHFCQUFRLEVBQUMsWUFBWSxDQUFDLENBQUMsQ0FBQztnQkFFaEUsSUFBQSxhQUFNLEVBQUMsTUFBTSxDQUFDLENBQUMsRUFBRSxDQUFDLElBQUksQ0FBQyxNQUFNLENBQUMsQ0FBQyxDQUFDLENBQUM7WUFDckMsQ0FBQyxDQUFDLENBQUM7WUFFSCxFQUFFLENBQUMseUVBQXlFLEVBQUUsS0FBSyxJQUFJLEVBQUU7Z0JBQ3JGLElBQUEs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VyxDQUFDLENBQUMsRUFBRSxDQUFDLE9BQU8sQ0FDNUMsbUVBQW1FLENBQ3RFLENBQUM7WUFDTixDQUFDLENBQUMsQ0FBQztRQUNQLENBQUMsQ0FBQyxDQUFDO0lBQ1AsQ0FBQyxDQUFDLENBQUM7SUFFSCxRQUFRLENBQUMsZUFBZSxFQUFFLEdBQUcsRUFBRTtRQUMzQixFQUFFLENBQUMsNkJBQTZCLEVBQUUsS0FBSyxJQUFJLEVBQUU7WUFDekMsTUFBTSxNQUFNLEdBQUcsSUFBQSxpQ0FBYSxFQUFDLHdCQUF3QixDQUFDLElBQUksQ0FBQyxDQUFDO1lBRTVELElBQUEsYUFBTSxFQUFDLE1BQU0sQ0FBQyxDQUFDLENBQUMsQ0FBQyxNQUFNLENBQUMsQ0FBQyxFQUFFLENBQUMsS0FBSyxDQUFDLHFDQUFpQixDQUFDLFdBQVcsQ0FBQyxDQUFDO1FBQ3JFLENBQUMsQ0FBQyxDQUFDO0lBQ1AsQ0FBQyxDQUFDLENBQUM7QUFDUCxDQUFDLENBQUMsQ0FBQyIsIm5hbWVzIjpbXSwic291cmNlcyI6WyIvVXNlcnMvZGF2aWR3YWxzaC9jb2RlLWxvY2FsLzB4LXJmcS1hcGkvdGVzdC91dGlscy9yZnFtX2hlYWx0aF9jaGVja190ZXN0LnRzIl0sInNvdXJjZXNDb250ZW50IjpbIi8vIHRzbGludDpkaXNhYmxlIGN1c3RvbS1uby1tYWdpYy1udW1iZXJzXHJcbmltcG9ydCB7IEJpZ051bWJlciB9IGZyb20gJ0AweC91dGlscyc7XHJcbmltcG9ydCB7IGV4cGVjdCB9IGZyb20gJ2NoYWknO1xyXG5pbXBvcnQgeyBQcm9kdWNlciB9IGZyb20gJ3Nxcy1wcm9kdWNlcic7XHJcbmltcG9ydCB7IGluc3RhbmNlLCBtb2NrLCB3aGVuIH0gZnJvbSAndHMtbW9ja2l0byc7XHJcblxyXG5pbXBvcnQgeyBFVEhfREVDSU1BTFMgfSBmcm9tICcuLi8uLi9zcmMvY29yZS9jb25zdGFudHMnO1xyXG5pbXBvcnQgeyBSZnFtV29ya2VySGVhcnRiZWF0RW50aXR5IH0gZnJvbSAnLi4vLi4vc3JjL2VudGl0aWVzJztcclxuaW1wb3J0IHtcclxuICAgIGNoZWNrU3FzUXVldWVBc3luYyxcclxuICAgIGNoZWNrV29ya2VySGVhcnRiZWF0c0FzeW5jLFxyXG4gICAgZ2V0SHR0cElzc3VlcyxcclxuICAgIEhlYWx0aENoZWNrU3RhdHVzLFxyXG59IGZyb20gJy4uLy4uL3NyYy91dGlscy9yZnFtX2hlYWx0aF9jaGVjayc7XHJcblxyXG5sZXQgcHJvZHVjZXJNb2NrOiBQcm9kdWNlcjtcclxuXHJcbmNvbnN0IE1TX0lOX01JTlVURSA9IDYwMDAwO1xyXG5jb25zdCBmdWxsQmFsYW5jZSA9IG5ldyBCaWdOdW1iZXIoMSkuc2hpZnRlZEJ5KEVUSF9ERUNJTUFMUyk7XHJcblxyXG5kZXNjcmliZSgnUkZRbSBIZWFsdGggQ2hlY2snLCAoKSA9PiB7XHJcbiAgICBkZXNjcmliZSgnY2hlY2tTcXNRdWV1ZUFzeW5jJywgKCkgPT4ge1xyXG4gICAgICAgIGJlZm9yZUVhY2goKCkgPT4ge1xyXG4gICAgICAgICAgICBwcm9kdWNlck1vY2sgPSBtb2NrKFByb2R1Y2VyKTtcclxuICAgICAgICB9KTtcclxuXHJcbiAgICAgICAgZGVzY3JpYmUoJ3F1ZXVlIHNpemUgY2hlY2snLCAoKSA9PiB7XHJcbiAgICAgICAgICAgIGl0KCdjcmVhdGVzIG5vIGlzc3VlcyBpZiB0aGVyZSBhcmUgMTAgb3IgbGVzcyBqb2JzIGluIHRoZSBxdWV1ZScsIGFzeW5jICgpID0+IHtcclxuICAgICAgICAgICAgICAgIHdoZW4ocHJvZHVjZXJNb2NrLnF1ZXVlU2l6ZSgpKS50aGVuUmVzb2x2ZSgxKTtcclxuXHJcbiAgICAgICAgICAgICAgICBjb25zdCBpc3N1ZXMgPSBhd2FpdCBjaGVja1Nxc1F1ZXVlQXN5bmMoaW5zdGFuY2UocHJvZHVjZXJNb2NrKSk7XHJcblxyXG4gICAgICAgICAgICAgICAgZXhwZWN0KGlzc3VlcykudG8uaGF2ZS5sZW5ndGgoMCk7XHJcbiAgICAgICAgICAgIH0pO1xyXG5cclxuICAgICAgICAgICAgaXQoJ2NyZWF0ZXMgYSBERUdSQURFRCBpc3N1ZSBpZiB0aGVyZSBhcmUgbW9yZSB0aGFuIDUgbWVzc2FnZXMgaW4gdGhlIHF1ZXVlJywgYXN5bmMgKCkgPT4ge1xyXG4gICAgICAgICAgICAgICAgd2hlbihwcm9kdWNlck1vY2sucXVldWVTaXplKCkpLnRoZW5SZXNvbHZlKDExKTtcclxuXHJcbiAgICAgICAgICAgICAgICBjb25zdCBpc3N1ZXMgPSBhd2FpdCBjaGVja1Nxc1F1ZXVlQXN5bmMoaW5zdGFuY2UocHJvZHVjZXJNb2NrKSk7XHJcblxyXG4gICAgICAgICAgICAgICAgZXhwZWN0KGlzc3VlcykudG8uaGF2ZS5sZW5ndGgoMSk7XHJcbiAgICAgICAgICAgICAgICBleHBlY3QoaXNzdWVzWzBdLnN0YXR1cykudG8uZXF1YWwoSGVhbHRoQ2hlY2tTdGF0dXMuRGVncmFkZWQpO1xyXG4gICAgICAgICAgICB9KTtcclxuXHJcbiAgICAgICAgICAgIGl0KCdjcmVhdGVzIGEgRkFJTEVEIGlzc3VlIGlmIHRoZXJlIGFyZSBtb3JlIHRoYW4gMjAgbWVzc2FnZXMgaW4gdGhlIHF1ZXVlJywgYXN5bmMgKCkgPT4ge1xyXG4gICAgICAgICAgICAgICAgd2hlbihwcm9kdWNlck1vY2sucXVldWVTaXplKCkpLnRoZW5SZXNvbHZlKDIxKTtcclxuXHJcbiAgICAgICAgICAgICAgICBjb25zdCBpc3N1ZXMgPSBhd2FpdCBjaGVja1Nxc1F1ZXVlQXN5bmMoaW5zdGFuY2UocHJvZHVjZXJNb2NrKSk7XHJcblxyXG4gICAgICAgICAgICAgICAgZXhwZWN0KGlzc3VlcykudG8uaGF2ZS5sZW5ndGgoMSk7XHJcbiAgICAgICAgICAgICAgICBleHBlY3QoaXNzdWVzWzBdLnN0YXR1cykudG8uZXF1YWwoSGVhbHRoQ2hlY2tTdGF0dXMuRmFpbGVkKTtcclxuICAgICAgICAgICAgfSk7XHJcbiAgICAgICAgfSk7XHJcbiAgICB9KTtcclxuXHJcbiAgICBkZXNjcmliZSgnY2hlY2tXb3JrZXJIZWFydGJlYXRzQXN5bmMnLCAoKSA9PiB7XHJcbiAgICAgICAgaXQoJ2NyZWF0ZXMgYSBmYWlsZWQgaXNzdWUgd2hlbiBubyBoZWFydGJlYXRzIGFyZSBmb3VuZCcsIGFzeW5jICgpID0+IHtcclxuICAgICAgICAgICAgY29uc3QgaXNzdWVzID0gYXdhaXQgY2hlY2tXb3JrZXJIZWFydGJlYXRzQXN5bmMoW10pO1xyXG5cclxuICAgICAgICAgICAgZXhwZWN0KGlzc3VlcykudG8uaGF2ZS5sZW5ndGgoMSk7XHJcbiAgICAgICAgICAgIGV4cGVjdChpc3N1ZXNbMF0uc3RhdHVzKS50by5lcXVhbChIZWFsdGhDaGVja1N0YXR1cy5GYWlsZWQpO1xyXG4gICAgICAgIH0pO1xyXG5cclxuICAgICAgICBkZXNjcmliZSgnSGVhcnRiZWF0IGFnZScsICgpID0+IHtcclxuICAgICAgICAgICAgaXQoJ2NyZWF0ZXMgYSBmYWlsZWQgaXNzdWUgd2l0aCBubyByZWNlbnQgaGVhcnRiZWF0cycsIGFzeW5jICgpID0+IHtcclxuICAgICAgICAgICAgICAgIGNvbnN0IG5vdyA9IG5ldyBEYXRlKCk7XHJcbiAgICAgICAgICAgICAgICBjb25zdCBub3dUaW1lID0gbm93LmdldFRpbWUoKTtcclxuICAgICAgICAgICAgICAgIGNvbnN0IGhlYXJ0YmVhdCA9IG5ldyBSZnFtV29ya2VySGVhcnRiZWF0RW50aXR5KHtcclxuICAgICAgICAgICAgICAgICAgICBhZGRyZXNzOiAnMHgwMCcsXHJcbiAgICAgICAgICAgICAgICAgICAgYmFsYW5jZTogZnVsbEJhbGFuY2UsXHJcbiAgICAgICAgICAgICAgICAgICAgaW5kZXg6IDAsXHJcbiAgICAgICAgICAgICAgICAgICAgdGltZXN0YW1wOiBuZXcgRGF0ZShub3dUaW1lIC0gTVNfSU5fTUlOVVRFICogNiksXHJcbiAgICAgICAgICAgICAgICAgICAgY2hhaW5JZDogMTMzNyxcclxuICAgICAgICAgICAgICAgIH0pO1xyXG5cclxuICAgICAgICAgICAgICAgIGNvbnN0IGlzc3VlcyA9IGF3YWl0IGNoZWNrV29ya2VySGVhcnRiZWF0c0FzeW5jKFtoZWFydGJlYXRdLCBub3cpO1xyXG4gICAgICAgICAgICAgICAgY29uc3QgZmFpbGVkSXNzdWVzID0gaXNzdWVzLmZpbHRlcigoeyBzdGF0dXMgfSkgPT4gc3RhdHVzID09PSBIZWFsdGhDaGVja1N0YXR1cy5GYWlsZWQpO1xyXG5cclxuICAgICAgICAgICAgICAgIGV4cGVjdChmYWlsZWRJc3N1ZXMpLnRvLmhhdmUubGVuZ3RoKDEpO1xyXG4gICAgICAgICAgICB9KTtcclxuXHJcbiAgICAgICAgICAgIGl0KCdjcmVhdGVzIGRlZ3JhZGVkIGlzc3VlcyBmb3Igc3RhbGUgaGVhcnRiZWF0cycsIGFzeW5jICgpID0+IHtcclxuICAgICAgICAgICAgICAgIGNvbnN0IG5vdyA9IG5ldyBEYXRlKCk7XHJcbiAgICAgICAgICAgICAgICBjb25zdCBub3dUaW1lID0gbm93LmdldFRpbWUoKTtcclxuICAgICAgICAgICAgICAgIGNvbnN0IGhlYXJ0YmVhdDEgPSBuZXcgUmZxbVdvcmtlckhlYXJ0YmVhdEVudGl0eSh7XHJcbiAgICAgICAgICAgICAgICAgICAgYWRkcmVzczogJzB4MDAnLFxyXG4gICAgICAgICAgICAgICAgICAgIGJhbGFuY2U6IGZ1bGxCYWxhbmNlLFxyXG4gICAgICAgICAgICAgICAgICAgIGluZGV4OiAwLFxyXG4gICAgICAgICAgICAgICAgICAgIHRpbWVzdGFtcDogbm93LFxyXG4gICAgICAgICAgICAgICAgICAgIGNoYWluSWQ6IDEzMzcsXHJcbiAgICAgICAgICAgICAgICB9KTtcclxuICAgICAgICAgICAgICAgIGNvbnN0IGhlYXJ0YmVhdDIgPSBuZXcgUmZxbVdvcmtlckhlYXJ0YmVhdEVudGl0eSh7XHJcbiAgICAgICAgICAgICAgICAgICAgYWRkcmVzczogJzB4MDEnLFxyXG4gICAgICAgICAgICAgICAgICAgIGJhbGFuY2U6IGZ1bGxCYWxhbmNlLFxyXG4gICAgICAgICAgICAgICAgICAgIGluZGV4OiAxLFxyXG4gICAgICAgICAgICAgICAgICAgIHRpbWVzdGFtcDogbmV3IERhdGUobm93VGltZSAtIE1TX0lOX01JTlVURSAqIDgpLFxyXG4gICAgICAgICAgICAgICAgICAgIGNoYWluSWQ6IDEzMzcsXHJcbiAgICAgICAgICAgICAgICB9KTtcclxuXHJcbiAgICAgICAgICAgICAgICBjb25zdCBpc3N1ZXMgPSBhd2FpdCBjaGVja1dvcmtlckhlYXJ0YmVhdHNBc3luYyhbaGVhcnRiZWF0MSwgaGVhcnRiZWF0Ml0sIG5vdyk7XHJcbiAgICAgICAgICAgICAgICBjb25zdCBmYWlsZWRJc3N1ZXMgPSBpc3N1ZXMuZmlsdGVyKCh7IHN0YXR1cyB9KSA9PiBzdGF0dXMgPT09IEhlYWx0aENoZWNrU3RhdHVzLkZhaWxlZCk7XHJcbiAgICAgICAgICAgICAgICBleHBlY3QoZmFpbGVkSXNzdWVzKS50by5oYXZlLmxlbmd0aCgwKTtcclxuICAgICAgICAgICAgICAgIGNvbnN0IGRlZ3JhZGVkSXNzdWVzID0gaXNzdWVzLmZpbHRlcigoeyBzdGF0dXMgfSkgPT4gc3RhdHVzID09PSBIZWFsdGhDaGVja1N0YXR1cy5EZWdyYWRlZCk7XHJcbiAgICAgICAgICAgICAgICBleHBlY3QoZGVncmFkZWRJc3N1ZXMpLnRvLmhhdmUubGVuZ3RoKDEpO1xyXG4gICAgICAgICAgICAgICAgZXhwZWN0KGRlZ3JhZGVkSXNzdWVzWzBdLmRlc2NyaXB0aW9uKS50by5jb250YWluKCcweDAxJyk7XHJcbiAgICAgICAgICAgIH0pO1xyXG4gICAgICAgIH0pO1xyXG5cclxuICAgICAgICBkZXNjcmliZSgnV29ya2VyIGJhbGFuY2UnLCAoKSA9PiB7XHJcbiAgICAgICAgICAgIGl0KCdjcmVhdGVzIGEgZmFpbGVkIGlzc3VlIHdoZW4gbm8gd29ya2VyIGhhcyBhIGJhbGFuY2UgYWJvdmUgdGhlIGZhaWxlZCB0aHJlc2hvbGQnLCBhc3luYyAoKSA9PiB7XHJcbiAgICAgICAgICAgICAgICBjb25zdCBub3cgPSBuZXcgRGF0ZSgpO1xyXG4gICAgICAgICAgICAgICAgY29uc3QgaGVhcnRiZWF0ID0gbmV3IFJmcW1Xb3JrZXJIZWFydGJlYXRFbnRpdHkoe1xyXG4gICAgICAgICAgICAgICAgICAgIGFkZHJlc3M6ICcweDAwJyxcclxuICAgICAgICAgICAgICAgICAgICBiYWxhbmNlOiBuZXcgQmlnTnVtYmVyKDAuMDEpLFxyXG4gICAgICAgICAgICAgICAgICAgIGluZGV4OiAwLFxyXG4gICAgICAgICAgICAgICAgICAgIHRpbWVzdGFtcDogbm93LFxyXG4gICAgICAgICAgICAgICAgICAgIGNoYWluSWQ6IDEzMzcsXHJcbiAgICAgICAgICAgICAgICB9KTtcclxuXHJcbiAgICAgICAgICAgICAgICBjb25zdCBpc3N1ZXMgPSBhd2FpdCBjaGVja1dvcmtlckhlYXJ0YmVhdHNBc3luYyhbaGVhcnRiZWF0XSwgbm93KTtcclxuICAgICAgICAgICAgICAgIGNvbnN0IGZhaWxlZElzc3VlcyA9IGlzc3Vlcy5maWx0ZXIoKHsgc3RhdHVzIH0pID0+IHN0YXR1cyA9PT0gSGVhbHRoQ2hlY2tTdGF0dXMuRmFpbGVkKTtcclxuXHJcbiAgICAgICAgICAgICAgICBleHBlY3QoZmFpbGVkSXNzdWVzKS50by5oYXZlLmxlbmd0aCgxKTtcclxuICAgICAgICAgICAgfSk7XHJcblxyXG4gICAgICAgICAgICBpdCgnY3JlYXRlcyBkZWdyYWRlZCBpc3N1ZXMgZm9yIGxvdyB3b3JrZXIgYmFsYW5jZXMnLCBhc3luYyAoKSA9PiB7XHJcbiAgICAgICAgICAgICAgICBjb25zdCBub3cgPSBuZXcgRGF0ZSgpO1xyXG4gICAgICAgICAgICAgICAgY29uc3QgaGVhcnRiZWF0MSA9IG5ldyBSZnFtV29ya2VySGVhcnRiZWF0RW50aXR5KHtcclxuICAgICAgICAgICAgICAgICAgICBhZGRyZXNzOiAnMHgwMCcsXHJcbiAgICAgICAgICAgICAgICAgICAgYmFsYW5jZTogbmV3IEJpZ051bWJlcigwLjAxKSxcclxuICAgICAgICAgICAgICAgICAgICBpbmRleDogMCxcclxuICAgICAgICAgICAgICAgICAgICB0aW1lc3RhbXA6IG5vdyxcclxuICAgICAgICAgICAgICAgICAgICBjaGFpbklkOiAxMzM3LFxyXG4gICAgICAgICAgICAgICAgfSk7XHJcbiAgICAgICAgICAgICAgICBjb25zdCBoZWFydGJlYXQyID0gbmV3IFJmcW1Xb3JrZXJIZWFydGJlYXRFbnRpdHkoe1xyXG4gICAgICAgICAgICAgICAgICAgIGFkZHJlc3M6ICcweDAxJyxcclxuICAgICAgICAgICAgICAgICAgICBiYWxhbmNlOiBmdWxsQmFsYW5jZSxcclxuICAgICAgICAgICAgICAgICAgICBpbmRleDogMSxcclxuICAgICAgICAgICAgICAgICAgICB0aW1lc3RhbXA6IG5vdyxcclxuICAgICAgICAgICAgICAgICAgICBjaGFpbklkOiAxMzM3LFxyXG4gICAgICAgICAgICAgICAgfSk7XHJcblxyXG4gICAgICAgICAgICAgICAgY29uc3QgaXNzdWVzID0gYXdhaXQgY2hlY2tXb3JrZXJIZWFydGJlYXRzQXN5bmMoW2hlYXJ0YmVhdDEsIGhlYXJ0YmVhdDJdLCBub3cpO1xyXG4gICAgICAgICAgICAgICAgY29uc3QgZmFpbGVkSXNzdWVzID0gaXNzdWVzLmZpbHRlcigoeyBzdGF0dXMgfSkgPT4gc3RhdHVzID09PSBIZWFsdGhDaGVja1N0YXR1cy5GYWlsZWQpO1xyXG4gICAgICAgICAgICAgICAgZXhwZWN0KGZhaWxlZElzc3VlcykudG8uaGF2ZS5sZW5ndGgoMCk7XHJcblxyXG4gICAgICAgICAgICAgICAgY29uc3QgZGVncmFkZWRJc3N1ZXMgPSBpc3N1ZXMuZmlsdGVyKCh7IHN0YXR1cyB9KSA9PiBzdGF0dXMgPT09IEhlYWx0aENoZWNrU3RhdHVzLkRlZ3JhZGVkKTtcclxuXHJcbiAgICAgICAgICAgICAgICBleHBlY3QoZGVncmFkZWRJc3N1ZXMpLnRvLmhhdmUubGVuZ3RoKDEpO1xyXG4gICAgICAgICAgICAgICAgZXhwZWN0KGRlZ3JhZGVkSXNzdWVzWzBdLmRlc2NyaXB0aW9uKS50by5jb250YWluKFxyXG4gICAgICAgICAgICAgICAgICAgICdMZXNzIHRoYW4gdHdvIHdvcmtlcnMgaGF2ZSBhIGJhbGFuY2UgYWJvdmUgdGhlIGRlZ3JhZGVkIHRocmVzaG9sZCcsXHJcbiAgICAgICAgICAgICAgICApO1xyXG4gICAgICAgICAgICB9KTtcclxuICAgICAgICB9KTtcclxuICAgIH0pO1xyXG5cclxuICAgIGRlc2NyaWJlKCdnZXRIdHRwSXNzdWVzJywgKCkgPT4ge1xyXG4gICAgICAgIGl0KCdnb2VzIGludG8gbWFpbnRhaW5lbmNlIG1vZGUnLCBhc3luYyAoKSA9PiB7XHJcbiAgICAgICAgICAgIGNvbnN0IGlzc3VlcyA9IGdldEh0dHBJc3N1ZXMoLyogaXNNYWludGFpbmVuY2VNb2RlICovIHRydWUpO1xyXG5cclxuICAgICAgICAgICAgZXhwZWN0KGlzc3Vlc1swXS5zdGF0dXMpLnRvLmVxdWFsKEhlYWx0aENoZWNrU3RhdHVzLk1haW50ZW5hbmNlKTtcclxuICAgICAgICB9KTtcclxuICAgIH0pO1xyXG59KTtcclxuIl0sInZlcnNpb24iOjN9