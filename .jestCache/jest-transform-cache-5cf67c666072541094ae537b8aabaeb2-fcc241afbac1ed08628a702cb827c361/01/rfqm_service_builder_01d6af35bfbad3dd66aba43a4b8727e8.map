{"file":"/Users/davidwalsh/code-local/0x-rfq-api/src/utils/rfqm_service_builder.ts","mappings":"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","names":[],"sources":["/Users/davidwalsh/code-local/0x-rfq-api/src/utils/rfqm_service_builder.ts"],"sourcesContent":["import {\r\n    artifacts,\r\n    AssetSwapperContractAddresses,\r\n    ERC20BridgeSamplerContract,\r\n    ProtocolFeeUtils,\r\n    SupportedProvider,\r\n} from '@0x/asset-swapper';\r\nimport { ChainId, getContractAddressesForChainOrThrow } from '@0x/contract-addresses';\r\nimport { PrivateKeyWalletSubprovider } from '@0x/subproviders';\r\nimport { getTokenMetadataIfExists } from '@0x/token-metadata';\r\nimport { Web3Wrapper } from '@0x/web3-wrapper';\r\nimport Axios, { AxiosRequestConfig } from 'axios';\r\nimport { providers, Wallet } from 'ethers';\r\nimport { Agent as HttpAgent } from 'http';\r\nimport { Agent as HttpsAgent } from 'https';\r\nimport Redis from 'ioredis';\r\nimport { Kafka, Producer as KafkaProducer } from 'kafkajs';\r\nimport { Producer } from 'sqs-producer';\r\n\r\nimport {\r\n    ChainConfiguration,\r\n    ChainConfigurations,\r\n    KAFKA_BROKERS,\r\n    META_TX_WORKER_MNEMONIC,\r\n    REDIS_URI,\r\n    RFQ_PROXY_ADDRESS,\r\n    RFQ_PROXY_PORT,\r\n    ZERO_EX_API_KEY,\r\n} from '../config';\r\nimport {\r\n    DEFAULT_MIN_EXPIRY_DURATION_MS,\r\n    DEFAULT_WORKER_TRANSACTION_WATCHER_SLEEP_TIME_MS,\r\n    KEEP_ALIVE_TTL,\r\n    PROTOCOL_FEE_UTILS_POLLING_INTERVAL_IN_MS,\r\n} from '../core/constants';\r\nimport { logger } from '../logger';\r\nimport { FeeService } from '../services/fee_service';\r\nimport { RfqmService } from '../services/rfqm_service';\r\nimport { RfqMakerBalanceCacheService } from '../services/rfq_maker_balance_cache_service';\r\nimport { WorkerService } from '../services/WorkerService';\r\n\r\nimport { BalanceChecker } from './balance_checker';\r\nimport { CacheClient } from './cache_client';\r\nimport { ConfigManager } from './config_manager';\r\nimport { getGasStationAttendant } from './GasStationAttendantUtils';\r\nimport { providerUtils } from './provider_utils';\r\nimport { QuoteServerClient } from './quote_server_client';\r\nimport { RfqmDbUtils } from './rfqm_db_utils';\r\nimport { RfqBalanceCheckUtils, RfqBlockchainUtils } from './rfq_blockchain_utils';\r\nimport { RfqMakerDbUtils } from './rfq_maker_db_utils';\r\nimport { RfqMakerManager } from './rfq_maker_manager';\r\nimport { TokenMetadataManager } from './TokenMetadataManager';\r\nimport { TokenPriceOracle } from './TokenPriceOracle';\r\nimport { ZeroExApiClient } from './ZeroExApiClient';\r\n\r\nexport type RfqmServices = Map<number, RfqmService>;\r\n\r\nconst DEFAULT_AXIOS_TIMEOUT = 600; // ms\r\n\r\n/**\r\n * Initialize a kafka producer if KAFKA_BROKERS is set\r\n */\r\nfunction getKafkaProducer(): KafkaProducer | undefined {\r\n    let kafkaProducer: KafkaProducer | undefined;\r\n    if (KAFKA_BROKERS !== undefined) {\r\n        const kafka = new Kafka({\r\n            clientId: '0x-api',\r\n            brokers: KAFKA_BROKERS,\r\n        });\r\n\r\n        kafkaProducer = kafka.producer();\r\n        // tslint:disable-next-line: no-floating-promises\r\n        kafkaProducer.connect();\r\n    }\r\n    return kafkaProducer;\r\n}\r\n\r\n/**\r\n * Creates the default Axios Request Config\r\n */\r\nexport function getAxiosRequestConfig(timeout: number = DEFAULT_AXIOS_TIMEOUT): AxiosRequestConfig {\r\n    return {\r\n        httpAgent: new HttpAgent({ keepAlive: true, timeout: KEEP_ALIVE_TTL }),\r\n        httpsAgent: new HttpsAgent({ keepAlive: true, timeout: KEEP_ALIVE_TTL }),\r\n        timeout,\r\n    };\r\n}\r\n\r\n/**\r\n * Creates the Axios Request Config with egress proxy\r\n */\r\nexport function getAxiosRequestConfigWithProxy(): AxiosRequestConfig {\r\n    const axiosRequestConfig: AxiosRequestConfig = getAxiosRequestConfig();\r\n    if (RFQ_PROXY_ADDRESS !== undefined && RFQ_PROXY_PORT !== undefined) {\r\n        axiosRequestConfig.proxy = {\r\n            host: RFQ_PROXY_ADDRESS,\r\n            port: RFQ_PROXY_PORT,\r\n        };\r\n    }\r\n\r\n    return axiosRequestConfig;\r\n}\r\n\r\nasync function deploySamplerContractAsync(\r\n    provider: SupportedProvider,\r\n    chainId: ChainId,\r\n): Promise<ERC20BridgeSamplerContract> {\r\n    const web3Wrapper = new Web3Wrapper(provider);\r\n    const _chainId = await web3Wrapper.getChainIdAsync();\r\n    if (_chainId !== chainId) {\r\n        throw new Error(`Incorrect Chain Id: ${_chainId}`);\r\n    }\r\n    const [account] = await web3Wrapper.getAvailableAddressesAsync();\r\n    try {\r\n        const sampler = await ERC20BridgeSamplerContract.deployFrom0xArtifactAsync(\r\n            artifacts.ERC20BridgeSampler,\r\n            provider,\r\n            { from: account },\r\n            {},\r\n        );\r\n        logger.info(`Deployed ERC20BridgeSamplerContract on network ${chainId}: ${sampler.address}`);\r\n        return sampler;\r\n    } catch (err) {\r\n        logger.error(`Failed to deploy ERC20BridgeSamplerContract on network ${chainId}: ${err}`);\r\n        throw err;\r\n    }\r\n}\r\n\r\n/**\r\n * Determines the contract addresses needed for the network. For testing (ganache)\r\n * required contracts are deployed\r\n * @param provider provider to the network, used for ganache deployment\r\n * @param chainConfiguration used for getting chainId and exchangeProxyContractAddressOverride\r\n */\r\nexport async function getContractAddressesForNetworkOrThrowAsync(\r\n    provider: SupportedProvider,\r\n    chainConfiguration: Pick<ChainConfiguration, 'chainId' | 'exchangeProxyContractAddressOverride'>,\r\n): Promise<AssetSwapperContractAddresses> {\r\n    const { chainId, exchangeProxyContractAddressOverride } = chainConfiguration;\r\n    // $eslint-fix-me https://github.com/rhinodavid/eslint-fix-me\r\n    // eslint-disable-next-line @typescript-eslint/no-explicit-any\r\n    let contractAddresses = getContractAddressesForChainOrThrow(chainId.toString() as any);\r\n    // In a testnet where the environment does not support overrides\r\n    // so we deploy the latest sampler\r\n    if (chainId === ChainId.Ganache) {\r\n        const sampler = await deploySamplerContractAsync(provider, chainId);\r\n        contractAddresses = { ...contractAddresses, erc20BridgeSampler: sampler.address };\r\n    }\r\n    // If 0x Exchange Proxy contract address override is defined in the chain config\r\n    // we use address instead of the one provided from `@0x/contract-addresses`\r\n    if (exchangeProxyContractAddressOverride) {\r\n        contractAddresses = { ...contractAddresses, exchangeProxy: exchangeProxyContractAddressOverride };\r\n    }\r\n    return contractAddresses;\r\n}\r\n\r\n/**\r\n * Builds a single instance of RfqmService\r\n */\r\nexport async function buildRfqmServiceAsync(\r\n    rfqmDbUtils: RfqmDbUtils,\r\n    rfqMakerManager: RfqMakerManager,\r\n    tokenPriceOracle: TokenPriceOracle,\r\n    configManager: ConfigManager,\r\n    chain: ChainConfiguration,\r\n    redis: Redis,\r\n): Promise<RfqmService> {\r\n    const { rfqm: rfqmConfiguration, chainId } = chain;\r\n    if (!rfqmConfiguration) {\r\n        throw new Error(`RFQm Service for chain ${chainId} does not exist`);\r\n    }\r\n\r\n    // ether.js Provider coexists with web3 provider during migration away from 0x/web3-wrapper.\r\n    const ethersProvider = new providers.JsonRpcProvider(chain.rpcUrl, chainId);\r\n\r\n    const rpcProvider = providerUtils.createWeb3Provider(chain.rpcUrl);\r\n    const provider: SupportedProvider = rpcProvider;\r\n\r\n    const contractAddresses = await getContractAddressesForNetworkOrThrowAsync(provider, chain);\r\n    const axiosInstance = Axios.create(getAxiosRequestConfigWithProxy());\r\n\r\n    const protocolFeeUtils = ProtocolFeeUtils.getInstance(\r\n        PROTOCOL_FEE_UTILS_POLLING_INTERVAL_IN_MS,\r\n        chain.gasStationUrl,\r\n    );\r\n\r\n    const balanceChecker = new BalanceChecker(provider);\r\n    const rfqBlockchainUtils = new RfqBlockchainUtils(\r\n        provider,\r\n        contractAddresses.exchangeProxy,\r\n        balanceChecker,\r\n        ethersProvider,\r\n    );\r\n\r\n    const tokenMetadataManager = new TokenMetadataManager(chainId, rfqBlockchainUtils);\r\n\r\n    const sqsProducer = Producer.create({\r\n        queueUrl: chain.sqsUrl,\r\n    });\r\n\r\n    const quoteServerClient = new QuoteServerClient(axiosInstance);\r\n\r\n    const cacheClient = new CacheClient(redis);\r\n\r\n    const kafkaProducer = getKafkaProducer();\r\n\r\n    const gasStationAttendant = getGasStationAttendant(chain, axiosInstance, protocolFeeUtils);\r\n\r\n    const feeTokenMetadata = getTokenMetadataIfExists(contractAddresses.etherToken, chainId);\r\n    if (feeTokenMetadata === undefined) {\r\n        throw new Error(`Fee token ${contractAddresses.etherToken} on chain ${chainId} could not be found!`);\r\n    }\r\n\r\n    const zeroExApiClient = new ZeroExApiClient(Axios.create(), ZERO_EX_API_KEY, chain);\r\n\r\n    const feeService = new FeeService(\r\n        chainId,\r\n        feeTokenMetadata,\r\n        configManager,\r\n        gasStationAttendant,\r\n        tokenPriceOracle,\r\n        zeroExApiClient,\r\n        rfqmConfiguration.minExpiryDurationMs || DEFAULT_MIN_EXPIRY_DURATION_MS,\r\n    );\r\n\r\n    const rfqMakerBalanceCacheService = new RfqMakerBalanceCacheService(\r\n        cacheClient,\r\n        rfqBlockchainUtils.balanceCheckUtils,\r\n    );\r\n\r\n    return new RfqmService(\r\n        chainId,\r\n        feeService,\r\n        rfqmConfiguration.feeModelVersion || 0,\r\n        contractAddresses,\r\n        chain.registryAddress,\r\n        rfqBlockchainUtils,\r\n        rfqmDbUtils,\r\n        sqsProducer,\r\n        quoteServerClient,\r\n        rfqmConfiguration.minExpiryDurationMs || DEFAULT_MIN_EXPIRY_DURATION_MS,\r\n        cacheClient,\r\n        rfqMakerBalanceCacheService,\r\n        rfqMakerManager,\r\n        tokenMetadataManager,\r\n        kafkaProducer,\r\n        rfqmConfiguration.quoteReportTopic,\r\n    );\r\n}\r\n\r\n/**\r\n * Builds a single instance of the WorkerService\r\n */\r\nexport async function buildWorkerServiceAsync(\r\n    rfqmDbUtils: RfqmDbUtils,\r\n    rfqMakerManager: RfqMakerManager,\r\n    chain: ChainConfiguration,\r\n    redis: Redis,\r\n    workerIndex: number,\r\n): Promise<WorkerService> {\r\n    const { worker: workerConfiguration, chainId } = chain;\r\n    if (!workerConfiguration) {\r\n        throw new Error(`Worker Service for chain ${chainId} does not exist`);\r\n    }\r\n\r\n    let provider: SupportedProvider;\r\n\r\n    // ether.js Provider coexists with web3 provider during migration away from 0x/web3-wrapper.\r\n    const ethersProvider = new providers.JsonRpcProvider(chain.rpcUrl, chainId);\r\n    let ethersWallet: Wallet | undefined;\r\n\r\n    const rpcProvider = providerUtils.createWeb3Provider(chain.rpcUrl);\r\n    if (META_TX_WORKER_MNEMONIC === undefined) {\r\n        throw new Error(`META_TX_WORKER_MNEMONIC must be defined to run RFQM service as a worker`);\r\n    }\r\n    const workerPrivateKey = RfqBlockchainUtils.getPrivateKeyFromIndexAndPhrase(META_TX_WORKER_MNEMONIC, workerIndex);\r\n\r\n    // TODO (rhinodavid): Remove once migration to ethers.js is complete\r\n    const privateWalletSubprovider = new PrivateKeyWalletSubprovider(workerPrivateKey);\r\n    // $eslint-fix-me https://github.com/rhinodavid/eslint-fix-me\r\n    // eslint-disable-next-line prefer-const\r\n    provider = RfqBlockchainUtils.createPrivateKeyProvider(rpcProvider, privateWalletSubprovider);\r\n\r\n    // $eslint-fix-me https://github.com/rhinodavid/eslint-fix-me\r\n    // eslint-disable-next-line @typescript-eslint/no-non-null-assertion\r\n    ethersWallet = Wallet.fromMnemonic(META_TX_WORKER_MNEMONIC, `m/44'/60'/0'/0/${workerIndex!}`);\r\n    ethersWallet = ethersWallet.connect(ethersProvider);\r\n\r\n    const contractAddresses = await getContractAddressesForNetworkOrThrowAsync(provider, chain);\r\n    const axiosInstance = Axios.create(getAxiosRequestConfigWithProxy());\r\n\r\n    const protocolFeeUtils = ProtocolFeeUtils.getInstance(\r\n        PROTOCOL_FEE_UTILS_POLLING_INTERVAL_IN_MS,\r\n        chain.gasStationUrl,\r\n    );\r\n\r\n    const balanceChecker = new BalanceChecker(provider);\r\n    const rfqBlockchainUtils = new RfqBlockchainUtils(\r\n        provider,\r\n        contractAddresses.exchangeProxy,\r\n        balanceChecker,\r\n        ethersProvider,\r\n        ethersWallet,\r\n    );\r\n\r\n    const quoteServerClient = new QuoteServerClient(axiosInstance);\r\n\r\n    const cacheClient = new CacheClient(redis);\r\n\r\n    const gasStationAttendant = getGasStationAttendant(chain, axiosInstance, protocolFeeUtils);\r\n\r\n    const feeTokenMetadata = getTokenMetadataIfExists(contractAddresses.etherToken, chainId);\r\n    if (feeTokenMetadata === undefined) {\r\n        throw new Error(`Fee token ${contractAddresses.etherToken} on chain ${chainId} could not be found!`);\r\n    }\r\n\r\n    const rfqMakerBalanceCacheService = new RfqMakerBalanceCacheService(\r\n        cacheClient,\r\n        rfqBlockchainUtils.balanceCheckUtils,\r\n    );\r\n\r\n    return new WorkerService(\r\n        chainId,\r\n        gasStationAttendant,\r\n        chain.registryAddress,\r\n        rfqBlockchainUtils,\r\n        rfqmDbUtils,\r\n        quoteServerClient,\r\n        workerConfiguration.transactionWatcherSleepTimeMs || DEFAULT_WORKER_TRANSACTION_WATCHER_SLEEP_TIME_MS,\r\n        cacheClient,\r\n        rfqMakerBalanceCacheService,\r\n        rfqMakerManager,\r\n        workerConfiguration.initialMaxPriorityFeePerGasGwei,\r\n        workerConfiguration.maxFeePerGasCapGwei,\r\n        workerConfiguration.enableAccessList,\r\n    );\r\n}\r\n\r\n/**\r\n * Builds an instance of maker balance cache service.\r\n * Intended to be used by maker balance cache background jobs.\r\n */\r\nexport async function buildRfqMakerBalanceCacheServiceAsync(\r\n    chain: ChainConfiguration,\r\n): Promise<RfqMakerBalanceCacheService> {\r\n    const provider = providerUtils.createWeb3Provider(chain.rpcUrl);\r\n    const contractAddresses = await getContractAddressesForNetworkOrThrowAsync(provider, chain);\r\n    const balanceChecker = new BalanceChecker(provider);\r\n    const balanceCheckUtils = new RfqBalanceCheckUtils(balanceChecker, contractAddresses.exchangeProxy);\r\n\r\n    if (!REDIS_URI) {\r\n        throw new Error('No redis URI provided to maker balance cache service');\r\n    }\r\n    const redis = new Redis(REDIS_URI);\r\n    const cacheClient = new CacheClient(redis);\r\n\r\n    return new RfqMakerBalanceCacheService(cacheClient, balanceCheckUtils);\r\n}\r\n\r\n/**\r\n * Creates an RFQM Service for each chain present in `ChainConfigurations`.\r\n *\r\n * Intended for use by the top-level runners.\r\n */\r\nexport async function buildRfqmServicesAsync(\r\n    asWorker: boolean,\r\n    rfqmDbUtils: RfqmDbUtils,\r\n    rfqMakerDbUtils: RfqMakerDbUtils,\r\n    chainConfigurations: ChainConfigurations,\r\n    tokenPriceOracle: TokenPriceOracle,\r\n    configManager: ConfigManager = new ConfigManager(),\r\n    redis: Redis,\r\n    // $eslint-fix-me https://github.com/rhinodavid/eslint-fix-me\r\n    // eslint-disable-next-line @typescript-eslint/no-inferrable-types\r\n    _workerIndex: number = 0,\r\n): Promise<RfqmServices> {\r\n    const services = await Promise.all(\r\n        chainConfigurations.map(async (chain) => {\r\n            const rfqMakerManager = new RfqMakerManager(configManager, rfqMakerDbUtils, chain.chainId);\r\n            await rfqMakerManager.initializeAsync();\r\n            return buildRfqmServiceAsync(rfqmDbUtils, rfqMakerManager, tokenPriceOracle, configManager, chain, redis);\r\n        }),\r\n    );\r\n    return new Map(services.map((s, i) => [chainConfigurations[i].chainId, s]));\r\n}\r\n"],"version":3}