{"file":"/Users/davidwalsh/code-local/0x-rfq-api/src/core/fee_utils.ts","mappings":"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","names":[],"sources":["/Users/davidwalsh/code-local/0x-rfq-api/src/core/fee_utils.ts"],"sourcesContent":["import { BigNumber } from '@0x/utils';\n\nimport { Fee, FeeWithDetails, StoredFee } from './types';\n\nconst tokenPriceUsdToString = (tokenPriceUsd: BigNumber | null): string | undefined => {\n    if (tokenPriceUsd === null) {\n        return undefined;\n    }\n    return tokenPriceUsd.toString();\n};\n\nconst isInstanceOfFeeWithDetails = (fee: Fee): fee is FeeWithDetails => {\n    return 'details' in fee;\n};\n\nconst isInstanceOfFeeWithBreakdown = (fee: Fee): fee is FeeWithDetails => {\n    return 'breakdown' in fee && 'conversionRates' in fee;\n};\n\nexport const feeToStoredFee = (fee: Fee): StoredFee => {\n    let details;\n    if (isInstanceOfFeeWithDetails(fee)) {\n        switch (fee.details.kind) {\n            case 'default':\n                details = {\n                    kind: fee.details.kind,\n                    feeModelVersion: fee.details.feeModelVersion,\n                    gasFeeAmount: fee.details.gasFeeAmount.toString(),\n                    gasPrice: fee.details.gasPrice.toString(),\n                    tradeSizeBps: fee.details.tradeSizeBps,\n                    zeroExFeeAmount: fee.details.zeroExFeeAmount.toString(),\n                    // $eslint-fix-me https://github.com/rhinodavid/eslint-fix-me\n                    // eslint-disable-next-line @typescript-eslint/no-non-null-assertion\n                    feeTokenBaseUnitPriceUsd: tokenPriceUsdToString(fee.details.feeTokenBaseUnitPriceUsd!),\n                    takerTokenBaseUnitPriceUsd: tokenPriceUsdToString(fee.details.takerTokenBaseUnitPriceUsd),\n                    makerTokenBaseUnitPriceUsd: tokenPriceUsdToString(fee.details.makerTokenBaseUnitPriceUsd),\n                };\n                break;\n            case 'margin':\n                details = {\n                    kind: fee.details.kind,\n                    feeModelVersion: fee.details.feeModelVersion,\n                    gasFeeAmount: fee.details.gasFeeAmount.toString(),\n                    gasPrice: fee.details.gasPrice.toString(),\n                    margin: fee.details.margin.toString(),\n                    marginRakeRatio: fee.details.marginRakeRatio,\n                    zeroExFeeAmount: fee.details.zeroExFeeAmount.toString(),\n                    // $eslint-fix-me https://github.com/rhinodavid/eslint-fix-me\n                    // eslint-disable-next-line @typescript-eslint/no-non-null-assertion\n                    feeTokenBaseUnitPriceUsd: tokenPriceUsdToString(fee.details.feeTokenBaseUnitPriceUsd!),\n                    takerTokenBaseUnitPriceUsd: tokenPriceUsdToString(fee.details.takerTokenBaseUnitPriceUsd),\n                    makerTokenBaseUnitPriceUsd: tokenPriceUsdToString(fee.details.makerTokenBaseUnitPriceUsd),\n                };\n                break;\n            case 'gasOnly':\n            default:\n                details = {\n                    kind: fee.details.kind,\n                    feeModelVersion: fee.details.feeModelVersion,\n                    gasFeeAmount: fee.details.gasFeeAmount.toString(),\n                    gasPrice: fee.details.gasPrice.toString(),\n                };\n        }\n    }\n\n    let breakdown, conversionRates;\n    if (isInstanceOfFeeWithBreakdown(fee)) {\n        if (fee.breakdown) {\n            let gas, zeroEx;\n            if (fee.breakdown.gas) {\n                gas = {\n                    amount: fee.breakdown.gas.amount.toString(),\n                    details: {\n                        gasPrice: fee.breakdown.gas.details.gasPrice.toString(),\n                        estimatedGas: fee.breakdown.gas.details.estimatedGas.toString(),\n                    },\n                };\n            }\n            if (fee.breakdown.zeroEx) {\n                let details;\n                switch (fee.breakdown.zeroEx.details.kind) {\n                    case 'volume':\n                        details = {\n                            kind: fee.breakdown.zeroEx.details.kind,\n                            tradeSizeBps: fee.breakdown.zeroEx.details.tradeSizeBps,\n                        };\n                        break;\n                    case 'price_improvement':\n                        details = {\n                            kind: fee.breakdown.zeroEx.details.kind,\n                            priceImprovement: fee.breakdown.zeroEx.details.priceImprovement.toString(),\n                            rakeRatio: fee.breakdown.zeroEx.details.rakeRatio,\n                        };\n                        break;\n                    default:\n                        throw new Error(`Invalide zeroEx fee details: ${JSON.stringify(fee.breakdown.zeroEx.details)}`);\n                }\n                zeroEx = {\n                    amount: fee.breakdown.zeroEx.amount.toString(),\n                    details,\n                };\n            }\n            breakdown = {\n                gas,\n                zeroEx,\n            };\n        }\n        if (fee.conversionRates) {\n            conversionRates = {\n                nativeTokenBaseUnitPriceUsd: tokenPriceUsdToString(fee.conversionRates.nativeTokenBaseUnitPriceUsd),\n                feeTokenBaseUnitPriceUsd: tokenPriceUsdToString(fee.conversionRates.feeTokenBaseUnitPriceUsd),\n                takerTokenBaseUnitPriceUsd: tokenPriceUsdToString(fee.conversionRates.takerTokenBaseUnitPriceUsd),\n                makerTokenBaseUnitPriceUsd: tokenPriceUsdToString(fee.conversionRates.makerTokenBaseUnitPriceUsd),\n            };\n        }\n    }\n\n    return {\n        token: fee.token,\n        amount: fee.amount.toString(),\n        type: fee.type,\n        details,\n        breakdown,\n        conversionRates,\n    };\n};\n\nexport const storedFeeToFee = (fee: StoredFee): Fee => {\n    return {\n        token: fee.token,\n        amount: new BigNumber(fee.amount),\n        type: fee.type,\n    };\n};\n"],"version":3}