c53b2eabaac48421e7f0abf81d1ba4fd
"use strict";
Object.defineProperty(exports, "__esModule", { value: true });
const chai_1 = require("chai");
const constants_1 = require("../../src/core/constants");
const BlockedAddressEntity_1 = require("../../src/entities/BlockedAddressEntity");
const rfq_blocked_address_utils_1 = require("../../src/utils/rfq_blocked_address_utils");
const deployment_1 = require("../test_utils/deployment");
const initDbDataSourceAsync_1 = require("../test_utils/initDbDataSourceAsync");
const ttlMs = 50;
// tslint:disable-next-line: custom-no-magic-numbers
jest.setTimeout(constants_1.ONE_MINUTE_MS * 2);
let teardownDependencies;
describe('rfqBlockedAddressUtils', () => {
    let dataSource;
    let rfqBlacklistUtils;
    beforeAll(async () => {
        teardownDependencies = await (0, deployment_1.setupDependenciesAsync)(['postgres']);
        // tslint:disable-next-line: custom-no-magic-numbers
        dataSource = await (0, initDbDataSourceAsync_1.initDbDataSourceAsync)();
        rfqBlacklistUtils = new rfq_blocked_address_utils_1.RfqBlockedAddressUtils(dataSource, new Set(), ttlMs);
    });
    afterAll(async () => {
        const wasKilled = teardownDependencies();
        if (!wasKilled) {
            throw new Error('Dependencies failed to shut down');
        }
    });
    beforeEach(async () => {
        rfqBlacklistUtils = new rfq_blocked_address_utils_1.RfqBlockedAddressUtils(dataSource, new Set(), ttlMs);
    });
    afterEach(async () => {
        await dataSource.query('TRUNCATE TABLE blocked_addresses CASCADE;');
        await dataSource.query('TRUNCATE TABLE rfqm_jobs CASCADE;');
        await dataSource.query('TRUNCATE TABLE rfqm_quotes CASCADE;');
        await dataSource.query('TRUNCATE TABLE rfqm_transaction_submissions CASCADE;');
        await dataSource.query('TRUNCATE TABLE rfqm_v2_jobs CASCADE;');
        await dataSource.query('TRUNCATE TABLE rfqm_v2_quotes CASCADE;');
        await dataSource.query('TRUNCATE TABLE rfqm_v2_transaction_submissions CASCADE;');
    });
    describe('blocked_addresses table', () => {
        it('should only allow lower case insertions', async () => {
            const sampleBadAddress = '0xA10612Ee5432B6395d1F0d6fB2601299a1c64274';
            try {
                await dataSource.getRepository(BlockedAddressEntity_1.BlockedAddressEntity).save({
                    address: sampleBadAddress,
                });
                chai_1.expect.fail('should throw');
            }
            catch (err) {
                (0, chai_1.expect)(err.message).to.match(/violates check constraint/);
            }
            try {
                await dataSource.getRepository(BlockedAddressEntity_1.BlockedAddressEntity).save({
                    address: sampleBadAddress.toLowerCase(),
                });
            }
            catch (err) {
                chai_1.expect.fail('lower case should not throw');
            }
        });
    });
    it('should use stale values via isBlocked', async () => {
        const sampleBadAddress = '0xA10612Ee5432B6395d1F0d6fB2601299a1c64274';
        (0, chai_1.expect)(rfqBlacklistUtils.isBlocked(sampleBadAddress)).to.equal(false);
        // Add it to the blocked list
        await dataSource.getRepository(BlockedAddressEntity_1.BlockedAddressEntity).save({
            address: sampleBadAddress.toLowerCase(),
        });
        (0, chai_1.expect)(rfqBlacklistUtils.isBlocked(sampleBadAddress)).to.equal(false);
    });
    it('should use fresh values after the update is complete', async () => {
        const sampleBadAddress = '0xB10612Ee5432B6395d1F0d6fB2601299a1c64274';
        // Add it to the blocked list
        await dataSource.getRepository(BlockedAddressEntity_1.BlockedAddressEntity).save({
            address: sampleBadAddress.toLowerCase(),
        });
        // Initally not blocked
        const isBlocked_t0 = rfqBlacklistUtils.isBlocked(sampleBadAddress);
        (0, chai_1.expect)(isBlocked_t0).to.equal(false);
        // Await for the update to complete
        await rfqBlacklistUtils.completeUpdateAsync();
        // Now should be blocked
        const isBlocked_t1 = rfqBlacklistUtils.isBlocked(sampleBadAddress);
        (0, chai_1.expect)(isBlocked_t1).to.equal(true);
    });
    it('should be case insensitive', async () => {
        const sampleBadAddress = '0xC10612Ee5432B6395d1F0d6fB2601299a1c64274';
        await dataSource.getRepository(BlockedAddressEntity_1.BlockedAddressEntity).save({
            address: sampleBadAddress.toLowerCase(),
        });
        // Trigger the update and wait for completion
        rfqBlacklistUtils.isBlocked(sampleBadAddress);
        await rfqBlacklistUtils.completeUpdateAsync();
        const isChecksumBlocked = rfqBlacklistUtils.isBlocked(sampleBadAddress);
        const isLowerCaseBlocked = rfqBlacklistUtils.isBlocked(sampleBadAddress.toLowerCase());
        const isUpperCaseBlocked = rfqBlacklistUtils.isBlocked(sampleBadAddress.toUpperCase());
        (0, chai_1.expect)(isChecksumBlocked).to.equal(true);
        (0, chai_1.expect)(isLowerCaseBlocked).to.equal(true);
        (0, chai_1.expect)(isUpperCaseBlocked).to.equal(true);
    });
});
//# sourceMappingURL=data:application/json;charset=utf-8;base64,eyJmaWxlIjoiL1VzZXJzL2Rhdmlkd2Fsc2gvY29kZS1sb2NhbC8weC1yZnEtYXBpL3Rlc3QvdXRpbHMvcmZxX2Jsb2NrZWRfYWRkcmVzc191dGlsc190ZXN0LnRzIiwibWFwcGluZ3MiOiI7O0FBQUEsK0JBQThCO0FBRzlCLHdEQUF5RDtBQUN6RCxrRkFBK0U7QUFDL0UseUZBQW1GO0FBQ25GLHlEQUFzRztBQUN0RywrRUFBNEU7QUFFNUUsTUFBTSxLQUFLLEdBQUcsRUFBRSxDQUFDO0FBRWpCLG9EQUFvRDtBQUNwRCxJQUFJLENBQUMsVUFBVSxDQUFDLHlCQUFhLEdBQUcsQ0FBQyxDQUFDLENBQUM7QUFDbkMsSUFBSSxvQkFBd0QsQ0FBQztBQUU3RCxRQUFRLENBQUMsd0JBQXdCLEVBQUUsR0FBRyxFQUFFO0lBQ3BDLElBQUksVUFBc0IsQ0FBQztJQUMzQixJQUFJLGlCQUF5QyxDQUFDO0lBRTlDLFNBQVMsQ0FBQyxLQUFLLElBQUksRUFBRTtRQUNqQixvQkFBb0IsR0FBRyxNQUFNLElBQUEsbUNBQXNCLEVBQUMsQ0FBQyxVQUFVLENBQUMsQ0FBQyxDQUFDO1FBQ2xFLG9EQUFvRDtRQUNwRCxVQUFVLEdBQUcsTUFBTSxJQUFBLDZDQUFxQixHQUFFLENBQUM7UUFDM0MsaUJBQWlCLEdBQUcsSUFBSSxrREFBc0IsQ0FBQyxVQUFVLEVBQUUsSUFBSSxHQUFHLEVBQUUsRUFBRSxLQUFLLENBQUMsQ0FBQztJQUNqRixDQUFDLENBQUMsQ0FBQztJQUVILFFBQVEsQ0FBQyxLQUFLLElBQUksRUFBRTtRQUNoQixNQUFNLFNBQVMsR0FBRyxvQkFBb0IsRUFBRSxDQUFDO1FBQ3pDLElBQUksQ0FBQyxTQUFTLEVBQUU7WUFDWixNQUFNLElBQUksS0FBSyxDQUFDLGtDQUFrQyxDQUFDLENBQUM7U0FDdkQ7SUFDTCxDQUFDLENBQUMsQ0FBQztJQUVILFVBQVUsQ0FBQyxLQUFLLElBQUksRUFBRTtRQUNsQixpQkFBaUIsR0FBRyxJQUFJLGtEQUFzQixDQUFDLFVBQVUsRUFBRSxJQUFJLEdBQUcsRUFBRSxFQUFFLEtB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LENBQUMsQ0FBQyxFQUFFLENBQUMsS0FBSyxDQUFDLElBQUksQ0FBQyxDQUFDO0lBQzlDLENBQUMsQ0FBQyxDQUFDO0FBQ1AsQ0FBQyxDQUFDLENBQUMiLCJuYW1lcyI6W10sInNvdXJjZXMiOlsiL1VzZXJzL2Rhdmlkd2Fsc2gvY29kZS1sb2NhbC8weC1yZnEtYXBpL3Rlc3QvdXRpbHMvcmZxX2Jsb2NrZWRfYWRkcmVzc191dGlsc190ZXN0LnRzIl0sInNvdXJjZXNDb250ZW50IjpbImltcG9ydCB7IGV4cGVjdCB9IGZyb20gJ2NoYWknO1xyXG5pbXBvcnQgeyBEYXRhU291cmNlIH0gZnJvbSAndHlwZW9ybSc7XHJcblxyXG5pbXBvcnQgeyBPTkVfTUlOVVRFX01TIH0gZnJvbSAnLi4vLi4vc3JjL2NvcmUvY29uc3RhbnRzJztcclxuaW1wb3J0IHsgQmxvY2tlZEFkZHJlc3NFbnRpdHkgfSBmcm9tICcuLi8uLi9zcmMvZW50aXRpZXMvQmxvY2tlZEFkZHJlc3NFbnRpdHknO1xyXG5pbXBvcnQgeyBSZnFCbG9ja2VkQWRkcmVzc1V0aWxzIH0gZnJvbSAnLi4vLi4vc3JjL3V0aWxzL3JmcV9ibG9ja2VkX2FkZHJlc3NfdXRpbHMnO1xyXG5pbXBvcnQgeyBzZXR1cERlcGVuZGVuY2llc0FzeW5jLCBUZWFyZG93bkRlcGVuZGVuY2llc0Z1bmN0aW9uSGFuZGxlIH0gZnJvbSAnLi4vdGVzdF91dGlscy9kZXBsb3ltZW50JztcclxuaW1wb3J0IHsgaW5pdERiRGF0YVNvdXJjZUFzeW5jIH0gZnJvbSAnLi4vdGVzdF91dGlscy9pbml0RGJEYXRhU291cmNlQXN5bmMnO1xyXG5cclxuY29uc3QgdHRsTXMgPSA1MDtcclxuXHJcbi8vIHRzbGludDpkaXNhYmxlLW5leHQtbGluZTogY3VzdG9tLW5vLW1hZ2ljLW51bWJlcnNcclxuamVzdC5zZXRUaW1lb3V0KE9ORV9NSU5VVEVfTVMgKiAyKTtcclxubGV0IHRlYXJkb3duRGVwZW5kZW5jaWVzOiBUZWFyZG93bkRlcGVuZGVuY2llc0Z1bmN0aW9uSGFuZGxlO1xyXG5cclxuZGVzY3JpYmUoJ3JmcUJsb2NrZWRBZGRyZXNzVXRpbHMnLCAoKSA9PiB7XHJcbiAgICBsZXQgZGF0YVNvdXJjZTogRGF0YVNvdXJjZTtcclxuICAgIGxldCByZnFCbGFja2xpc3RVdGlsczogUmZxQmxvY2tlZEFkZHJlc3NVdGlscztcclxuXHJcbiAgICBiZWZvcmVBbGwoYXN5bmMgKCkgPT4ge1xyXG4gICAgICAgIHRlYXJkb3duRGVwZW5kZW5jaWVzID0gYXdhaXQgc2V0dXBEZXBlbmRlbmNpZXNBc3luYyhbJ3Bvc3RncmVzJ10pO1xyXG4gICAgICAgIC8vIHRzbGludDpkaXNhYmxlLW5leHQtbGluZTogY3VzdG9tLW5vLW1hZ2ljLW51bWJlcnNcclxuICAgICAgICBkYXRhU291cmNlID0gYXdhaXQgaW5pdERiRGF0YVNvdXJjZUFzeW5jKCk7XHJcbiAgICAgICAgcmZxQmxhY2tsaXN0VXRpbHMgPSBuZXcgUmZxQmxvY2tlZEFkZHJlc3NVdGlscyhkYXRhU291cmNlLCBuZXcgU2V0KCksIHR0bE1zKTtcclxuICAgIH0pO1xyXG5cclxuICAgIGFmdGVyQWxsKGFzeW5jICgpID0+IHtcclxuICAgICAgICBjb25zdCB3YXNLaWxsZWQgPSB0ZWFyZG93bkRlcGVuZGVuY2llcygpO1xyXG4gICAgICAgIGlmICghd2FzS2lsbGVkKSB7XHJcbiAgICAgICAgICAgIHRocm93IG5ldyBFcnJvcignRGVwZW5kZW5jaWVzIGZhaWxlZCB0byBzaHV0IGRvd24nKTtcclxuICAgICAgICB9XHJcbiAgICB9KTtcclxuXHJcbiAgICBiZWZvcmVFYWNoKGFzeW5jICgpID0+IHtcclxuICAgICAgICByZnFCbGFja2xpc3RVdGlscyA9IG5ldyBSZnFCbG9ja2VkQWRkcmVzc1V0aWxzKGRhdGFTb3VyY2UsIG5ldyBTZXQoKSwgdHRsTXMpO1xyXG4gICAgfSk7XHJcblxyXG4gICAgYWZ0ZXJFYWNoKGFzeW5jICgpID0+IHtcclxuICAgICAgICBhd2FpdCBkYXRhU291cmNlLnF1ZXJ5KCdUUlVOQ0FURSBUQUJMRSBibG9ja2VkX2FkZHJlc3NlcyBDQVNDQURFOycpO1xyXG4gICAgICAgIGF3YWl0IGRhdGFTb3VyY2UucXVlcnkoJ1RSVU5DQVRFIFRBQkxFIHJmcW1fam9icyBDQVNDQURFOycpO1xyXG4gICAgICAgIGF3YWl0IGRhdGFTb3VyY2UucXVlcnkoJ1RSVU5DQVRFIFRBQkxFIHJmcW1fcXVvdGVzIENBU0NBREU7Jyk7XHJcbiAgICAgICAgYXdhaXQgZGF0YVNvdXJjZS5xdWVyeSgnVFJVTkNBVEUgVEFCTEUgcmZxbV90cmFuc2FjdGlvbl9zdWJtaXNzaW9ucyBDQVNDQURFOycpO1xyXG4gICAgICAgIGF3YWl0IGRhdGFTb3VyY2UucXVlcnkoJ1RSVU5DQVRFIFRBQkxFIHJmcW1fdjJfam9icyBDQVNDQURFOycpO1xyXG4gICAgICAgIGF3YWl0IGRhdGFTb3VyY2UucXVlcnkoJ1RSVU5DQVRFIFRBQkxFIHJmcW1fdjJfcXVvdGVzIENBU0NBREU7Jyk7XHJcbiAgICAgICAgYXdhaXQgZGF0YVNvdXJjZS5xdWVyeSgnVFJVTkNBVEUgVEFCTEUgcmZxbV92Ml90cmFuc2FjdGlvbl9zdWJtaXNzaW9ucyBDQVNDQURFOycpO1xyXG4gICAgfSk7XHJcblxyXG4gICAgZGVzY3JpYmUoJ2Jsb2NrZWRfYWRkcmVzc2VzIHRhYmxlJywgKCkgPT4ge1xyXG4gICAgICAgIGl0KCdzaG91bGQgb25seSBhbGxvdyBsb3dlciBjYXNlIGluc2VydGlvbnMnLCBhc3luYyAoKSA9PiB7XHJcbiAgICAgICAgICAgIGNvbnN0IHNhbXBsZUJhZEFkZHJlc3MgPSAnMHhBMTA2MTJFZTU0MzJCNjM5NWQxRjBkNmZCMjYwMTI5OWExYzY0Mjc0JztcclxuXHJcbiAgICAgICAgICAgIHRyeSB7XHJcbiAgICAgICAgICAgICAgICBhd2FpdCBkYXRhU291cmNlLmdldFJlcG9zaXRvcnkoQmxvY2tlZEFkZHJlc3NFbnRpdHkpLnNhdmUoe1xyXG4gICAgICAgICAgICAgICAgICAgIGFkZHJlc3M6IHNhbXBsZUJhZEFkZHJlc3MsXHJcbiAgICAgICAgICAgICAgICB9KTtcclxuICAgICAgICAgICAgICAgIGV4cGVjdC5mYWlsKCdzaG91bGQgdGhyb3cnKTtcclxuICAgICAgICAgICAgfSBjYXRjaCAoZXJyKSB7XHJcbiAgICAgICAgICAgICAgICBleHBlY3QoZXJyLm1lc3NhZ2UpLnRvLm1hdGNoKC92aW9sYXRlcyBjaGVjayBjb25zdHJhaW50Lyk7XHJcbiAgICAgICAgICAgIH1cclxuXHJcbiAgICAgICAgICAgIHRyeSB7XHJcbiAgICAgICAgICAgICAgICBhd2FpdCBkYXRhU291cmNlLmdldFJlcG9zaXRvcnkoQmxvY2tlZEFkZHJlc3NFbnRpdHkpLnNhdmUoe1xyXG4gICAgICAgICAgICAgICAgICAgIGFkZHJlc3M6IHNhbXBsZUJhZEFkZHJlc3MudG9Mb3dlckNhc2UoKSxcclxuICAgICAgICAgICAgICAgIH0pO1xyXG4gICAgICAgICAgICB9IGNhdGNoIChlcnIpIHtcclxuICAgICAgICAgICAgICAgIGV4cGVjdC5mYWlsKCdsb3dlciBjYXNlIHNob3VsZCBub3QgdGhyb3cnKTtcclxuICAgICAgICAgICAgfVxyXG4gICAgICAgIH0pO1xyXG4gICAgfSk7XHJcblxyXG4gICAgaXQoJ3Nob3VsZCB1c2Ugc3RhbGUgdmFsdWVzIHZpYSBpc0Jsb2NrZWQnLCBhc3luYyAoKSA9PiB7XHJcbiAgICAgICAgY29uc3Qgc2FtcGxlQmFkQWRkcmVzcyA9ICcweEExMDYxMkVlNTQzMkI2Mzk1ZDFGMGQ2ZkIyNjAxMjk5YTFjNjQyNzQnO1xyXG4gICAgICAgIGV4cGVjdChyZnFCbGFja2xpc3RVdGlscy5pc0Jsb2NrZWQoc2FtcGxlQmFkQWRkcmVzcykpLnRvLmVxdWFsKGZhbHNlKTtcclxuXHJcbiAgICAgICAgLy8gQWRkIGl0IHRvIHRoZSBibG9ja2VkIGxpc3RcclxuICAgICAgICBhd2FpdCBkYXRhU291cmNlLmdldFJlcG9zaXRvcnkoQmxvY2tlZEFkZHJlc3NFbnRpdHkpLnNhdmUoe1xyXG4gICAgICAgICAgICBhZGRyZXNzOiBzYW1wbGVCYWRBZGRyZXNzLnRvTG93ZXJDYXNlKCksXHJcbiAgICAgICAgfSk7XHJcblxyXG4gICAgICAgIGV4cGVjdChyZnFCbGFja2xpc3RVdGlscy5pc0Jsb2NrZWQoc2FtcGxlQmFkQWRkcmVzcykpLnRvLmVxdWFsKGZhbHNlKTtcclxuICAgIH0pO1xyXG5cclxuICAgIGl0KCdzaG91bGQgdXNlIGZyZXNoIHZhbHVlcyBhZnRlciB0aGUgdXBkYXRlIGlzIGNvbXBsZXRlJywgYXN5bmMgKCkgPT4ge1xyXG4gICAgICAgIGNvbnN0IHNhbXBsZUJhZEFkZHJlc3MgPSAnMHhCMTA2MTJFZTU0MzJCNjM5NWQxRjBkNmZCMjYwMTI5OWExYzY0Mjc0JztcclxuXHJcbiAgICAgICAgLy8gQWRkIGl0IHRvIHRoZSBibG9ja2VkIGxpc3RcclxuICAgICAgICBhd2FpdCBkYXRhU291cmNlLmdldFJlcG9zaXRvcnkoQmxvY2tlZEFkZHJlc3NFbnRpdHkpLnNhdmUoe1xyXG4gICAgICAgICAgICBhZGRyZXNzOiBzYW1wbGVCYWRBZGRyZXNzLnRvTG93ZXJDYXNlKCksXHJcbiAgICAgICAgfSk7XHJcblxyXG4gICAgICAgIC8vIEluaXRhbGx5IG5vdCBibG9ja2VkXHJcbiAgICAgICAgY29uc3QgaXNCbG9ja2VkX3QwID0gcmZxQmxhY2tsaXN0VXRpbHMuaXNCbG9ja2VkKHNhbXBsZUJhZEFkZHJlc3MpO1xyXG4gICAgICAgIGV4cGVjdChpc0Jsb2NrZWRfdDApLnRvLmVxdWFsKGZhbHNlKTtcclxuXHJcbiAgICAgICAgLy8gQXdhaXQgZm9yIHRoZSB1cGRhdGUgdG8gY29tcGxldGVcclxuICAgICAgICBhd2FpdCByZnFCbGFja2xpc3RVdGlscy5jb21wbGV0ZVVwZGF0ZUFzeW5jKCk7XHJcblxyXG4gICAgICAgIC8vIE5vdyBzaG91bGQgYmUgYmxvY2tlZFxyXG4gICAgICAgIGNvbnN0IGlzQmxvY2tlZF90MSA9IHJmcUJsYWNrbGlzdFV0aWxzLmlzQmxvY2tlZChzYW1wbGVCYWRBZGRyZXNzKTtcclxuICAgICAgICBleHBlY3QoaXNCbG9ja2VkX3QxKS50by5lcXVhbCh0cnVlKTtcclxuICAgIH0pO1xyXG5cclxuICAgIGl0KCdzaG91bGQgYmUgY2FzZSBpbnNlbnNpdGl2ZScsIGFzeW5jICgpID0+IHtcclxuICAgICAgICBjb25zdCBzYW1wbGVCYWRBZGRyZXNzID0gJzB4QzEwNjEyRWU1NDMyQjYzOTVkMUYwZDZmQjI2MDEyOTlhMWM2NDI3NCc7XHJcbiAgICAgICAgYXdhaXQgZGF0YVNvdXJjZS5nZXRSZXBvc2l0b3J5KEJsb2NrZWRBZGRyZXNzRW50aXR5KS5zYXZlKHtcclxuICAgICAgICAgICAgYWRkcmVzczogc2FtcGxlQmFkQWRkcmVzcy50b0xvd2VyQ2FzZSgpLFxyXG4gICAgICAgIH0pO1xyXG5cclxuICAgICAgICAvLyBUcmlnZ2VyIHRoZSB1cGRhdGUgYW5kIHdhaXQgZm9yIGNvbXBsZXRpb25cclxuICAgICAgICByZnFCbGFja2xpc3RVdGlscy5pc0Jsb2NrZWQoc2FtcGxlQmFkQWRkcmVzcyk7XHJcbiAgICAgICAgYXdhaXQgcmZxQmxhY2tsaXN0VXRpbHMuY29tcGxldGVVcGRhdGVBc3luYygpO1xyXG5cclxuICAgICAgICBjb25zdCBpc0NoZWNrc3VtQmxvY2tlZCA9IHJmcUJsYWNrbGlzdFV0aWxzLmlzQmxvY2tlZChzYW1wbGVCYWRBZGRyZXNzKTtcclxuICAgICAgICBjb25zdCBpc0xvd2VyQ2FzZUJsb2NrZWQgPSByZnFCbGFja2xpc3RVdGlscy5pc0Jsb2NrZWQoc2FtcGxlQmFkQWRkcmVzcy50b0xvd2VyQ2FzZSgpKTtcclxuICAgICAgICBjb25zdCBpc1VwcGVyQ2FzZUJsb2NrZWQgPSByZnFCbGFja2xpc3RVdGlscy5pc0Jsb2NrZWQoc2FtcGxlQmFkQWRkcmVzcy50b1VwcGVyQ2FzZSgpKTtcclxuXHJcbiAgICAgICAgZXhwZWN0KGlzQ2hlY2tzdW1CbG9ja2VkKS50by5lcXVhbCh0cnVlKTtcclxuICAgICAgICBleHBlY3QoaXNMb3dlckNhc2VCbG9ja2VkKS50by5lcXVhbCh0cnVlKTtcclxuICAgICAgICBleHBlY3QoaXNVcHBlckNhc2VCbG9ja2VkKS50by5lcXVhbCh0cnVlKTtcclxuICAgIH0pO1xyXG59KTtcclxuLy8gdHNsaW50OmRpc2FibGUtbGluZTptYXgtZmlsZS1saW5lLWNvdW50XHJcbiJdLCJ2ZXJzaW9uIjozfQ==